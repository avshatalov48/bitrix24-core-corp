{"version":3,"file":"command-executor.bundle.js","sources":["../src/command-executor.js"],"sourcesContent":["import { Engine } from 'ai.engine';\nimport { Text as PayloadText } from 'ai.payload.textpayload';\nimport { Extension, Reflection, Runtime } from 'main.core';\nimport type { CopilotAgreement as CopilotAgreementClass, CopilotAgreementOptions } from 'ai.copilot-agreement';\n\nconst CommandCodes = Object.freeze({\n\tcreateChecklist: 'create_checklist',\n});\n\ntype CommandExecutorOptions = {\n\tcategory?: string;\n\tmoduleId: string;\n\tcontextId: string;\n\tcontextParameters?: any;\n}\n\nexport class CommandExecutor\n{\n\t#engine: Engine;\n\t#isAgreementAccepted: boolean;\n\n\tconstructor(options: CommandExecutorOptions)\n\t{\n\t\tthis.#checkOptions(options);\n\t\tthis.#initEngine({\n\t\t\tmoduleId: options.moduleId,\n\t\t\tcontextId: options.contextId,\n\t\t\tcontextParameters: options.contextParameters || {},\n\t\t});\n\n\t\tthis.#isAgreementAccepted = Extension.getSettings('ai.command-executor').isAgreementAccepted === true;\n\t}\n\n\tasync makeChecklistFromText(text: string): Promise<string>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!text)\n\t\t\t{\n\t\t\t\tthrow new Error('AI.CommandExecutor.makeChecklistFromText: text is required parameter');\n\t\t\t}\n\n\t\t\tif (this.#isAgreementAccepted === false)\n\t\t\t{\n\t\t\t\tthis.#checkAgreement(\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis.#isAgreementAccepted = true;\n\n\t\t\t\t\t\tthis.makeChecklistFromText(text)\n\t\t\t\t\t\t\t.then((result) => {\n\t\t\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((err) => {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\t() => {\n\t\t\t\t\t\treject(new Error('Agreement is not accepted'));\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst payload = new PayloadText({\n\t\t\t\t\tprompt: {\n\t\t\t\t\t\tcode: CommandCodes.createChecklist,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tpayload.setMarkers({\n\t\t\t\t\toriginal_message: text,\n\t\t\t\t});\n\n\t\t\t\tthis.#engine.setPayload(payload);\n\t\t\t\tthis.#engine.setAnalyticParameters({\n\t\t\t\t\tc_section: 'tasks',\n\t\t\t\t});\n\n\t\t\t\tthis.#engine.textCompletions(payload)\n\t\t\t\t\t.then((result) => {\n\t\t\t\t\t\tresolve(result.data.result);\n\t\t\t\t\t})\n\t\t\t\t\t.catch((err) => {\n\t\t\t\t\t\tconst errorFromServer = err?.errors?.[0];\n\n\t\t\t\t\t\tif (errorFromServer?.code === 'CLOUD_REGISTRATION_DATA_NOT_FOUND')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#showNotification(errorFromServer.message);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t#checkOptions(options: CommandExecutorOptions): void\n\t{\n\t\tif (!options.moduleId)\n\t\t{\n\t\t\tthrow new Error('BX.AI.CommandExecutor: moduleId is required option');\n\t\t}\n\n\t\tif (!options.contextId)\n\t\t{\n\t\t\tthrow new Error('BX.AI.CommandExecutor: contextId is required option');\n\t\t}\n\t}\n\n\t#initEngine(options: InitEngineOptions)\n\t{\n\t\tthis.#engine = new Engine();\n\n\t\tthis.#engine\n\t\t\t.setContextId(options.contextId)\n\t\t\t.setModuleId(options.moduleId)\n\t\t\t.setContextParameters(options.contextParameters);\n\t}\n\n\tasync #checkAgreement(onAccept: Function, onCancel: Function): Promise<boolean>\n\t{\n\t\tconst { CopilotAgreement } = await Runtime.loadExtension('ai.copilot-agreement');\n\n\t\tconst options: CopilotAgreementOptions = {\n\t\t\tmoduleId: this.#engine.getModuleId(),\n\t\t\tcontextId: this.#engine.getContextId(),\n\t\t\tevents: {\n\t\t\t\tonAccept,\n\t\t\t\tonCancel,\n\t\t\t},\n\t\t};\n\n\t\tconst agreement: CopilotAgreementClass = new CopilotAgreement(options);\n\n\t\treturn agreement.checkAgreement();\n\t}\n\n\tasync #showNotification(message: string): void\n\t{\n\t\tawait Runtime.loadExtension('ui.notification');\n\n\t\tconst notificationCenter = Reflection.getClass('BX.UI.Notification.Center');\n\n\t\tnotificationCenter.notify({\n\t\t\tid: 'command-executor-notification',\n\t\t\tcontent: message,\n\t\t});\n\t}\n}\n\ntype InitEngineOptions = {\n\tmoduleId: string;\n\tcontextId: string;\n\tcontextParameters?: any;\n}\n"],"names":["CommandCodes","Object","freeze","createChecklist","CommandExecutor","constructor","options","moduleId","contextId","contextParameters","Extension","getSettings","isAgreementAccepted","makeChecklistFromText","text","Promise","resolve","reject","Error","then","result","catch","err","payload","PayloadText","prompt","code","setMarkers","original_message","setPayload","setAnalyticParameters","c_section","textCompletions","data","errorFromServer","errors","message","Engine","setContextId","setModuleId","setContextParameters","onAccept","onCancel","CopilotAgreement","Runtime","loadExtension","getModuleId","getContextId","events","agreement","checkAgreement","notificationCenter","Reflection","getClass","notify","id","content"],"mappings":"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"}