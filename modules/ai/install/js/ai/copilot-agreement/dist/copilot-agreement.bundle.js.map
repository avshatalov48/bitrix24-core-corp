{"version":3,"file":"copilot-agreement.bundle.js","sources":["../src/copilot-agreement.js"],"sourcesContent":["import { Tag, Loc, Extension, Type } from 'main.core';\nimport { Popup, CloseIconSize } from 'main.popup';\nimport { Button } from 'ui.buttons';\nimport { UI } from 'ui.notification';\nimport { Engine } from 'ai.engine';\n\nimport './css/copilot-agreement.css';\n\nexport type CopilotAgreementOptions = {\n\tevents?: CopilotAgreementEvents;\n\tmoduleId: string;\n\tcontextId: string;\n}\n\nexport type CopilotAgreementEvents = {\n\tonAccept: Function;\n\tonAcceptError: Function;\n\tonCancel: Function;\n\tonAgreementPopupShow: Function;\n\tonAgreementPopupHide: Function;\n}\n\nexport class CopilotAgreement\n{\n\t#events: CopilotAgreementEvents;\n\t#wasAccepted: boolean = false;\n\t#engine: Engine;\n\t#popup: Popup | null;\n\n\tconstructor(options: CopilotAgreementOptions)\n\t{\n\t\tthis.#validateOptions(options);\n\n\t\tthis.#events = options.events || {};\n\n\t\tthis.#engine = new Engine();\n\n\t\tthis.#engine.setContextId(options.contextId);\n\t\tthis.#engine.setModuleId(options.moduleId);\n\t}\n\n\tstatic #checkAgreementResult: boolean | null = null;\n\n\tstatic getFullAgreementLink(): string\n\t{\n\t\tconst zone = Extension.getSettings('ai.copilot-agreement').zone;\n\n\t\tconst linksByZone = {\n\t\t\tru: 'https://www.bitrix24.ru/about/terms-of-use-ai.php',\n\t\t\tkz: 'https://www.bitrix24.kz/about/terms-of-use-ai.php',\n\t\t\tby: 'https://www.bitrix24.by/about/terms-of-use-ai.php',\n\t\t\ten: 'https://www.bitrix24.com/terms/bitrix24copilot-rules.php',\n\t\t};\n\n\t\treturn linksByZone[zone] || linksByZone.en;\n\t}\n\n\tasync checkAgreement(): Promise<boolean>\n\t{\n\t\tif (CopilotAgreement.#checkAgreementResult !== null && CopilotAgreement.#checkAgreementResult !== undefined)\n\t\t{\n\t\t\tif (CopilotAgreement.#checkAgreementResult === false)\n\t\t\t{\n\t\t\t\tthis.#showAgreementPopup();\n\t\t\t}\n\n\t\t\treturn Promise.resolve(CopilotAgreement.#checkAgreementResult);\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tconst result = await this.#engine.checkAgreement();\n\n\t\t\tif (result.data.isAccepted === false)\n\t\t\t{\n\t\t\t\tthis.#showAgreementPopup();\n\t\t\t}\n\n\t\t\tCopilotAgreement.#checkAgreementResult = result.data.isAccepted;\n\n\t\t\treturn result.data.isAccepted;\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tconsole.error(e);\n\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t#showAgreementPopup(): void\n\t{\n\t\tif (!this.#popup)\n\t\t{\n\t\t\tthis.#initAgreementPopup();\n\t\t}\n\n\t\tthis.#popup.show();\n\t}\n\n\t#hideAgreementPopup(): void\n\t{\n\t\tthis.#popup?.close();\n\t\tthis.#popup = null;\n\t}\n\n\t#initAgreementPopup(): void\n\t{\n\t\tthis.#popup = new Popup({\n\t\t\tcontent: this.#renderPopupContent(),\n\t\t\tcacheable: false,\n\t\t\toverlay: true,\n\t\t\tdisableScroll: true,\n\t\t\twidth: 492,\n\t\t\tminHeight: 448,\n\t\t\tcloseByEsc: true,\n\t\t\tautoHide: true,\n\t\t\tcloseIcon: true,\n\t\t\tcloseIconSize: CloseIconSize.LARGE,\n\t\t\tpadding: 20,\n\t\t\tborderRadius: '10px',\n\t\t\tevents: {\n\t\t\t\tonDestroy: () => {\n\t\t\t\t\tif (this.#events?.onAgreementPopupHide)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#events?.onAgreementPopupHide();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.#wasAccepted === false && this.#events?.onCancel)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#events?.onCancel();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#popup = null;\n\t\t\t\t},\n\t\t\t\tonPopupShow: () => {\n\t\t\t\t\tif (this.#events?.onAgreementPopupShow)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#events?.onAgreementPopupShow();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\t#renderPopupContent(): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<div\n\t\t\t\tclass=\"ai__copilot-agreement-popup-content\"\n\t\t\t>\n\t\t\t\t<header class=\"ai__copilot-agreement-popup-content_header\">\n\t\t\t\t\t<h3 class=\"ai__copilot-agreement-popup-content_title\">\n\t\t\t\t\t\t${Loc.getMessage('COPILOT_AGREEMENT_POPUP_TITLE')}\n\t\t\t\t\t</h3>\n\t\t\t\t</header>\n\t\t\t\t<main class=\"ai__copilot-agreement-popup-content_main\">\n\t\t\t\t\t<div class=\"ai__copilot-agreement-popup-content_img\"></div>\n\t\t\t\t\t<p class=\"ai__copilot-agreement-popup-content_text\">\n\t\t\t\t\t\t${Loc.getMessage('COPILOT_AGREEMENT_POPUP_PARAGRAPH_1')}\n\t\t\t\t\t</p>\n\t\t\t\t\t<p class=\"ai__copilot-agreement-popup-content_text\">\n\t\t\t\t\t\t${Loc.getMessage('COPILOT_AGREEMENT_POPUP_PARAGRAPH_2', {\n\t\t\t\t\t\t\t'#LINK#': `<a target=\"_blank\" href=\"${CopilotAgreement.getFullAgreementLink()}\">`,\n\t\t\t\t\t\t\t'#/LINK#': '</a>',\n\t\t\t\t\t\t})}\n\t\t\t\t\t</p>\n\t\t\t\t</main>\n\t\t\t\t<footer class=\"ai__copilot-agreement-popup-content_footer\">\n\t\t\t\t\t<div class=\"ai__copilot-agreement-popup_footer-content-buttons\">\n\t\t\t\t\t\t${this.#renderApplyButton()}\n\t\t\t\t\t\t${this.#renderCancelButton()}\n\t\t\t\t\t</div>\n\t\t\t\t</footer>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#renderApplyButton(): HTMLElement\n\t{\n\t\tconst applyBtn = new Button({\n\t\t\ttext: Loc.getMessage('COPILOT_AGREEMENT_POPUP_APPLY_BTN'),\n\t\t\tcolor: Button.Color.SUCCESS,\n\t\t\tround: true,\n\t\t\tonclick: this.#handleClickOnAcceptBtn.bind(this),\n\t\t});\n\n\t\treturn applyBtn.render();\n\t}\n\n\t#renderCancelButton(): HTMLElement\n\t{\n\t\tconst cancelBtn = new Button({\n\t\t\ttext: Loc.getMessage('COPILOT_AGREEMENT_POPUP_CANCEL_BTN'),\n\t\t\tround: true,\n\t\t\tcolor: Button.Color.LIGHT,\n\t\t\tonclick: () => {\n\t\t\t\tthis.#popup.destroy();\n\t\t\t},\n\t\t});\n\n\t\treturn cancelBtn.render();\n\t}\n\n\tasync #handleClickOnAcceptBtn(button: Button): void\n\t{\n\t\ttry\n\t\t{\n\t\t\tbutton.setState(Button.State.WAITING);\n\n\t\t\tCopilotAgreement.#checkAgreementResult = await this.#acceptAgreement();\n\n\t\t\tthis.#wasAccepted = CopilotAgreement.#checkAgreementResult;\n\n\t\t\tif (this.#events?.onAccept)\n\t\t\t{\n\t\t\t\tthis.#events.onAccept();\n\t\t\t}\n\n\t\t\tthis.#hideAgreementPopup();\n\t\t}\n\t\tcatch (err)\n\t\t{\n\t\t\tif (this.#events?.onAcceptError)\n\t\t\t{\n\t\t\t\tthis.#events?.onAcceptError();\n\t\t\t}\n\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: Loc.getMessage('COPILOT_AGREEMENT_POPUP_APPLY_ERROR'),\n\t\t\t});\n\n\t\t\tconsole.error(err);\n\t\t}\n\t\tfinally\n\t\t{\n\t\t\tbutton.setState(null);\n\t\t}\n\t}\n\n\t#getFullAgreementLink(): string\n\t{\n\t\tconst zone = Extension.getSettings('ai.copilot-agreement').zone;\n\n\t\tconst linksByZone = {\n\t\t\tru: 'https://www.bitrix24.ru/about/terms-of-use-ai.php',\n\t\t\tkz: 'https://www.bitrix24.kz/about/terms-of-use-ai.php',\n\t\t\tby: 'https://www.bitrix24.by/about/terms-of-use-ai.php',\n\t\t\ten: 'https://www.bitrix24.com/terms/bitrix24copilot-rules.php',\n\t\t};\n\n\t\treturn linksByZone[zone] || linksByZone.en;\n\t}\n\n\tasync #acceptAgreement(): Promise<boolean>\n\t{\n\t\tconst result = await this.#engine.acceptAgreement();\n\n\t\treturn result.data.isAccepted;\n\t}\n\n\t#validateOptions(options: CopilotAgreementOptions): void\n\t{\n\t\tif (!options.moduleId || Type.isStringFilled(options.moduleId) === false)\n\t\t{\n\t\t\tthrow new Error('AI: CopilotAgreement: moduleId option is required and must be the string');\n\t\t}\n\n\t\tif (!options.contextId || Type.isStringFilled(options.contextId) === false)\n\t\t{\n\t\t\tthrow new Error('AI: CopilotAgreement: moduleId option is required and must be the string');\n\t\t}\n\n\t\tif (options.events && Type.isObject(options.events) === false)\n\t\t{\n\t\t\tthrow new Error('AI: CopilotAgreement: events option must be the object');\n\t\t}\n\t}\n}\n"],"names":["CopilotAgreement","constructor","options","events","Engine","setContextId","contextId","setModuleId","moduleId","getFullAgreementLink","zone","Extension","getSettings","linksByZone","ru","kz","by","en","checkAgreement","undefined","Promise","resolve","result","data","isAccepted","e","console","error","show","close","Popup","content","cacheable","overlay","disableScroll","width","minHeight","closeByEsc","autoHide","closeIcon","closeIconSize","CloseIconSize","LARGE","padding","borderRadius","onDestroy","onAgreementPopupHide","onCancel","onPopupShow","onAgreementPopupShow","Tag","render","Loc","getMessage","applyBtn","Button","text","color","Color","SUCCESS","round","onclick","bind","cancelBtn","LIGHT","destroy","button","setState","State","WAITING","onAccept","err","onAcceptError","UI","Notification","Center","notify","acceptAgreement","Type","isStringFilled","Error","isObject"],"mappings":";;;;;;;AAAA,CAMqC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAgBrC,CAAO,MAAMA,gBAAgB,CAC7B;GAMCC,WAAW,CAACC,QAAgC,EAC5C;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA,OALwB;;KAAK;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAM5B,4CAAI,sCAAkBA,QAAO;KAE7B,4CAAI,sBAAWA,QAAO,CAACC,MAAM,IAAI,EAAE;KAEnC,4CAAI,sBAAW,IAAIC,gBAAM,EAAE;KAE3B,4CAAI,oBAASC,YAAY,CAACH,QAAO,CAACI,SAAS,CAAC;KAC5C,4CAAI,oBAASC,WAAW,CAACL,QAAO,CAACM,QAAQ,CAAC;;GAK3C,OAAOC,oBAAoB,GAC3B;KACC,MAAMC,IAAI,GAAGC,mBAAS,CAACC,WAAW,CAAC,sBAAsB,CAAC,CAACF,IAAI;KAE/D,MAAMG,WAAW,GAAG;OACnBC,EAAE,EAAE,mDAAmD;OACvDC,EAAE,EAAE,mDAAmD;OACvDC,EAAE,EAAE,mDAAmD;OACvDC,EAAE,EAAE;MACJ;KAED,OAAOJ,WAAW,CAACH,IAAI,CAAC,IAAIG,WAAW,CAACI,EAAE;;GAG3C,MAAMC,cAAc,GACpB;KACC,IAAI,wCAAAlB,gBAAgB,oDAA2B,IAAI,IAAI,wCAAAA,gBAAgB,oDAA2BmB,SAAS,EAC3G;OACC,IAAI,wCAAAnB,gBAAgB,oDAA2B,KAAK,EACpD;SACC,4CAAI;;OAGL,OAAOoB,OAAO,CAACC,OAAO,yCAACrB,gBAAgB,gDAAuB;;KAG/D,IACA;OACC,MAAMsB,MAAM,GAAG,MAAM,4CAAI,oBAASJ,cAAc,EAAE;OAElD,IAAII,MAAM,CAACC,IAAI,CAACC,UAAU,KAAK,KAAK,EACpC;SACC,4CAAI;;OAGL,wCAAAxB,gBAAgB,kDAAyBsB,MAAM,CAACC,IAAI,CAACC,UAAU;OAE/D,OAAOF,MAAM,CAACC,IAAI,CAACC,UAAU;MAC7B,CACD,OAAOC,CAAC,EACR;OACCC,OAAO,CAACC,KAAK,CAACF,CAAC,CAAC;OAEhB,OAAO,IAAI;;;CAgMd;CAAC,gCA3LA;GACC,IAAI,yCAAC,IAAI,iBAAO,EAChB;KACC,4CAAI;;GAGL,4CAAI,kBAAQG,IAAI,EAAE;CACnB;CAAC,gCAGD;GAAA;GACC,qEAAI,sCAAJ,sBAAaC,KAAK,EAAE;GACpB,4CAAI,oBAAU,IAAI;CACnB;CAAC,gCAGD;GACC,4CAAI,oBAAU,IAAIC,gBAAK,CAAC;KACvBC,OAAO,0CAAE,IAAI,6CAAsB;KACnCC,SAAS,EAAE,KAAK;KAChBC,OAAO,EAAE,IAAI;KACbC,aAAa,EAAE,IAAI;KACnBC,KAAK,EAAE,GAAG;KACVC,SAAS,EAAE,GAAG;KACdC,UAAU,EAAE,IAAI;KAChBC,QAAQ,EAAE,IAAI;KACdC,SAAS,EAAE,IAAI;KACfC,aAAa,EAAEC,wBAAa,CAACC,KAAK;KAClCC,OAAO,EAAE,EAAE;KACXC,YAAY,EAAE,MAAM;KACpBzC,MAAM,EAAE;OACP0C,SAAS,EAAE,MAAM;SAAA;SAChB,sEAAI,IAAI,gCAAJ,uBAAcC,oBAAoB,EACtC;WAAA;WACC,sEAAI,wCAAJ,uBAAcA,oBAAoB,EAAE;;SAGrC,IAAI,4CAAI,kCAAkB,KAAK,sEAAI,IAAI,gCAAJ,uBAAcC,QAAQ,EACzD;WAAA;WACC,sEAAI,wCAAJ,uBAAcA,QAAQ,EAAE;;SAGzB,4CAAI,oBAAU,IAAI;QAClB;OACDC,WAAW,EAAE,MAAM;SAAA;SAClB,sEAAI,IAAI,gCAAJ,uBAAcC,oBAAoB,EACtC;WAAA;WACC,sEAAI,wCAAJ,uBAAcA,oBAAoB,EAAE;;;;IAIvC,CAAC;CACH;CAAC,gCAGD;GACC,OAAOC,aAAG,CAACC,MAAM,cAAC;;;;;;QAMd,CAAkD;;;;;;QAMlD,CAAwD;;;QAGxD,CAGG;;;;;QAKH,CAA4B;QAC5B,CAA6B;;;;GAIjC,GAtBMC,aAAG,CAACC,UAAU,CAAC,+BAA+B,CAAC,EAM/CD,aAAG,CAACC,UAAU,CAAC,qCAAqC,CAAC,EAGrDD,aAAG,CAACC,UAAU,CAAC,qCAAqC,EAAE;KACvD,QAAQ,EAAG,4BAA2BrD,gBAAgB,CAACS,oBAAoB,EAAG,IAAG;KACjF,SAAS,EAAE;IACX,CAAC,0CAKA,IAAI,qFACJ,IAAI;CAKX;CAAC,+BAGD;GACC,MAAM6C,QAAQ,GAAG,IAAIC,iBAAM,CAAC;KAC3BC,IAAI,EAAEJ,aAAG,CAACC,UAAU,CAAC,mCAAmC,CAAC;KACzDI,KAAK,EAAEF,iBAAM,CAACG,KAAK,CAACC,OAAO;KAC3BC,KAAK,EAAE,IAAI;KACXC,OAAO,EAAE,4CAAI,oDAAyBC,IAAI,CAAC,IAAI;IAC/C,CAAC;GAEF,OAAOR,QAAQ,CAACH,MAAM,EAAE;CACzB;CAAC,gCAGD;GACC,MAAMY,SAAS,GAAG,IAAIR,iBAAM,CAAC;KAC5BC,IAAI,EAAEJ,aAAG,CAACC,UAAU,CAAC,oCAAoC,CAAC;KAC1DO,KAAK,EAAE,IAAI;KACXH,KAAK,EAAEF,iBAAM,CAACG,KAAK,CAACM,KAAK;KACzBH,OAAO,EAAE,MAAM;OACd,4CAAI,kBAAQI,OAAO,EAAE;;IAEtB,CAAC;GAEF,OAAOF,SAAS,CAACZ,MAAM,EAAE;CAC1B;CAAC,wCAE6Be,MAAc,EAC5C;GACC,IACA;KAAA;KACCA,MAAM,CAACC,QAAQ,CAACZ,iBAAM,CAACa,KAAK,CAACC,OAAO,CAAC;KAErC,wCAAArE,gBAAgB,kDAAyB,8CAAM,IAAI,uCAAmB;KAEtE,4CAAI,wEAAgBA,gBAAgB,+CAAsB;KAE1D,sEAAI,IAAI,gCAAJ,uBAAcsE,QAAQ,EAC1B;OACC,4CAAI,oBAASA,QAAQ,EAAE;;KAGxB,4CAAI;IACJ,CACD,OAAOC,GAAG,EACV;KAAA;KACC,sEAAI,IAAI,gCAAJ,uBAAcC,aAAa,EAC/B;OAAA;OACC,uEAAI,wCAAJ,wBAAcA,aAAa,EAAE;;KAG9BC,kBAAE,CAACC,YAAY,CAACC,MAAM,CAACC,MAAM,CAAC;OAC7B7C,OAAO,EAAEqB,aAAG,CAACC,UAAU,CAAC,qCAAqC;MAC7D,CAAC;KAEF3B,OAAO,CAACC,KAAK,CAAC4C,GAAG,CAAC;IAClB,SAED;KACCL,MAAM,CAACC,QAAQ,CAAC,IAAI,CAAC;;CAEvB;CAAC,kCAGD;GACC,MAAMzD,IAAI,GAAGC,mBAAS,CAACC,WAAW,CAAC,sBAAsB,CAAC,CAACF,IAAI;GAE/D,MAAMG,WAAW,GAAG;KACnBC,EAAE,EAAE,mDAAmD;KACvDC,EAAE,EAAE,mDAAmD;KACvDC,EAAE,EAAE,mDAAmD;KACvDC,EAAE,EAAE;IACJ;GAED,OAAOJ,WAAW,CAACH,IAAI,CAAC,IAAIG,WAAW,CAACI,EAAE;CAC3C;CAAC,mCAGD;GACC,MAAMK,MAAM,GAAG,MAAM,4CAAI,oBAASuD,eAAe,EAAE;GAEnD,OAAOvD,MAAM,CAACC,IAAI,CAACC,UAAU;CAC9B;CAAC,2BAEgBtB,OAAgC,EACjD;GACC,IAAI,CAACA,OAAO,CAACM,QAAQ,IAAIsE,cAAI,CAACC,cAAc,CAAC7E,OAAO,CAACM,QAAQ,CAAC,KAAK,KAAK,EACxE;KACC,MAAM,IAAIwE,KAAK,CAAC,0EAA0E,CAAC;;GAG5F,IAAI,CAAC9E,OAAO,CAACI,SAAS,IAAIwE,cAAI,CAACC,cAAc,CAAC7E,OAAO,CAACI,SAAS,CAAC,KAAK,KAAK,EAC1E;KACC,MAAM,IAAI0E,KAAK,CAAC,0EAA0E,CAAC;;GAG5F,IAAI9E,OAAO,CAACC,MAAM,IAAI2E,cAAI,CAACG,QAAQ,CAAC/E,OAAO,CAACC,MAAM,CAAC,KAAK,KAAK,EAC7D;KACC,MAAM,IAAI6E,KAAK,CAAC,wDAAwD,CAAC;;CAE3E;CAAC,sBA/PWhF,gBAAgB;GAAA;GAAA,OAmBmB;CAAI;;;;;;;;"}