this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t){"use strict";const i=new WeakMap;const n=Symbol("name");class s{constructor(e={}){this[n]="unknown";this.children=[];i.set(this,{});this.setParent(e.parent);this.setName(e.name);this.setChildren(e.children)}static get ELEMENT_NODE(){return 1}static get TEXT_NODE(){return 2}static get ROOT_NODE(){return 3}static get FRAGMENT_NODE(){return 4}static freezeProperty(e,t,i,n=true){Object.defineProperty(e,t,{value:i,writable:false,configurable:false,enumerable:n})}static makeNonEnumerableProperty(e,t){Object.defineProperty(e,t,{writable:false,enumerable:false,configurable:false})}static flattenChildren(e){if(t.Type.isArrayFilled(e)){return e.flatMap((e=>{if(e.getType()===s.FRAGMENT_NODE){return e.getChildren()}return e}))}return[]}setName(e){if(t.Type.isString(e)){this[n]=e}}getName(){return this[n]}setParent(e=null){i.get(this).parent=e}getParent(){return i.get(this).parent}getType(){return i.get(this).type}hasParent(){return Boolean(i.get(this).parent)}remove(){if(this.hasParent()){this.getParent().removeChild(this)}}setChildren(e){if(t.Type.isArray(e)){this.children=[];this.appendChild(...e)}}getChildren(){return[...this.children]}getLastChild(){return this.getChildren().at(-1)}getLastChildOfType(e){return this.getChildren().reverse().find((t=>t.getType()===e))}getLastChildOfName(e){return this.getChildren().reverse().find((t=>t.getType()===s.ELEMENT_NODE&&t.getName()===e))}getFirstChild(){return this.getChildren().at(0)}getFirstChildOfType(e){return this.getChildren().find((t=>t.getType()===e))}getFirstChildOfName(e){return this.getChildren().find((t=>t.getType()===s.ELEMENT_NODE&&t.getName()===e))}getPreviewsSibling(){if(this.hasParent()){const e=this.getParent().getChildren();const t=e.indexOf(this);if(t>0){return e.at(t-1)}}return null}getNextSibling(){if(this.hasParent()){const e=this.getParent().getChildren();const t=e.indexOf(this);if(t!==-1&&t!==e.length){return e.at(t+1)}}return null}getChildrenCount(){return this.children.length}hasChildren(){return this.getChildrenCount()>0}appendChild(...e){const t=s.flattenChildren(e);t.forEach((e=>{e.remove();e.setParent(this);this.children.push(e)}))}prependChild(...e){const t=s.flattenChildren(e);t.forEach((e=>{e.remove();e.setParent(this);this.children.unshift(e)}))}propagateChild(...e){if(this.hasParent()){this.getParent().prependChild(...e.filter((e=>e.getType()===s.ELEMENT_NODE||e.getName()==="#text")))}}removeChild(...e){this.children=this.children.reduce(((t,i)=>{if(e.includes(i)){i.setParent(null);return t}return[...t,i]}),[])}replaceChild(e,...t){this.children=this.children.flatMap((i=>{if(i===e){i.setParent(null);const e=s.flattenChildren(t);return e.map((e=>{e.remove();e.setParent(this);return e}))}return i}))}toJSON(){return{name:this.getName(),children:this.getChildren().map((e=>e.toJSON()))}}}const r=Symbol("content");class a extends s{constructor(e={}){const a=t.Type.isString(e)?{content:e}:e;super(a);this[n]="#text";this[r]="";i.get(this).type=s.TEXT_NODE;this.setContent(a.content);s.makeNonEnumerableProperty(this,"children")}static isTextNodeContent(e){return t.Type.isString(e)||t.Type.isNumber(e)}static decodeSpecialChars(e){if(a.isTextNodeContent(e)){return e.replaceAll("&#91;","[").replaceAll("&#93;","]")}return e}setName(e){}setContent(e){if(a.isTextNodeContent(e)){this[r]=a.decodeSpecialChars(e)}}getContent(){return a.decodeSpecialChars(this[r])}toString(){return this.getContent()}toJSON(){return{name:this.getName(),content:this.toString()}}}const l="\t";const o="\n";const h=new Set([l,o]);const u="b";const c="i";const d="s";const g="u";const p="size";const f="color";const m="center";const N="left";const C="right";const T="url";const b="img";const y="list";const E="ul";const v="ol";const w="*";const O="li";const P="table";const S="tr";const x="td";const L="th";const A="code";const I=new Set([u,c,d,g,p,f,m,N,C,T,b,w,O]);const B=new Set([y,E,v]);const F=new Set([w,O]);class D{static isAnyText(e){return e.getType()===s.TEXT_NODE}static isText(e){return e&&D.isAnyText(e)&&!h.has(e.getContent())}static isNewLine(e){return e&&D.isAnyText(e)&&e.getContent()===o}static isTab(e){return e&&D.isAnyText(e)&&e.getContent()===l}static isElement(e){return e&&e.getType()===s.ELEMENT_NODE}static isList(e){return e&&D.isElement(e)&&B.has(e.getName())}static isListItem(e){return e&&D.isElement(e)&&F.has(e.getName())}static isInline(e){return e&&D.isElement(e)&&I.has(e.getName())}static isTableCell(e){return e&&D.isElement(e)&&[x,L].includes(e.getName())}static isTable(e){return e&&D.isElement(e)&&e.getName()===P}static isTableRow(e){return e&&D.isElement(e)&&e.getName()===S}}const M=e=>D.isListItem(e);const $=e=>D.isElement(e)&&e.getName()===O;const _=e=>D.isAnyText(e)&&!D.isTab(e)||D.isInline(e)&&!D.isListItem(e)||D.isList(e);const k=e=>D.isTableRow(e);const V=e=>D.isTableCell(e);const X=e=>D.isText(e)||D.isNewLine(e)||D.isInline(e)&&!D.isListItem(e);const j=e=>D.isAnyText(e)&&!D.isTab(e)||D.isInline(e)&&!D.isListItem(e);const R=new Map;R.set(y,M);R.set(w,_);R.set(O,_);R.set(v,$);R.set(E,$);R.set(P,k);R.set(S,V);R.set(x,X);R.set(L,X);R.set("#inline",j);const J=new Map;J.set(A,(e=>{if(e.getType()===s.TEXT_NODE){return e}return new a(e.toString())}));class U extends s{constructor(e={}){super(e);this.attributes={};this.value="";this.void=false;this.inline=false;i.get(this).type=s.ELEMENT_NODE;const t={inline:I.has(e.name),...e};this.setInline(t.inline);this.setValue(t.value);this.setVoid(t.void);this.setAttributes(t.attributes)}static filterChildren(e,t){const i={resolved:[],unresolved:[]};const n=R.get(e.getName());if(n){return t.reduce(((e,t)=>{const i=n(t);if(i){e.resolved.push(t)}else{e.unresolved.push(t)}return e}),i)}if(e.isInline()){const e=R.get("#inline");return t.reduce(((t,i)=>{const n=e(i);if(n){t.resolved.push(i)}else{t.unresolved.push(i)}return t}),{resolved:[],unresolved:[]})}i.resolved=t;return i}static convertChildren(e,t){const i=J.get(e.getName());if(i){return t.map((e=>i(e)))}return t}setValue(e){if(t.Type.isString(e)||t.Type.isNumber(e)||t.Type.isBoolean(e)){this.value=e}}getValue(){return this.value}setVoid(e){if(t.Type.isBoolean(e)){this.void=e}}isVoid(){return this.void}setInline(e){if(t.Type.isBoolean(e)){this.inline=e}}isInline(){return this.inline}setAttributes(e){if(t.Type.isPlainObject(e)){this.attributes={...e}}}setAttribute(e,i){if(t.Type.isStringFilled(e)){if(t.Type.isNil(i)){delete this.attributes[e]}else{this.attributes[e]=i}}}getAttribute(e){return this.attributes[e]}getAttributes(){return{...this.attributes}}appendChild(...e){const i=s.flattenChildren(e);const n=U.filterChildren(this,i);const r=U.convertChildren(this,n.resolved);r.forEach((e=>{e.remove();e.setParent(this);this.children.push(e)}));if(t.Type.isArrayFilled(n.unresolved)){this.propagateChild(...n.unresolved)}}prependChild(...e){const i=s.flattenChildren(e);const n=U.filterChildren(this,i);const r=U.convertChildren(this,n.resolved);r.forEach((e=>{e.remove();e.setParent(this);this.children.unshift(e)}));if(t.Type.isArrayFilled(n.unresolved)){this.propagateChild(...n.unresolved)}}replaceChild(e,...t){this.children=this.children.flatMap((i=>{if(i===e){i.setParent(null);const e=s.flattenChildren(t);const n=U.filterChildren(this,e);const r=U.convertChildren(this,n.resolved);return r.map((e=>{e.remove();e.setParent(this);return e}))}return i}))}toStringValue(){const e=this.getValue();return e?`=${e}`:""}toStringAttributes(){return Object.entries(this.getAttributes()).map((([e,t])=>t?`${e}=${t}`:e)).join(" ")}getNewLineBeforeContent(){if(!this.isInline()){const e=this.getFirstChild();if(e&&!D.isNewLine(e)){return"\n"}}return""}getNewLineAfterContent(){if(!this.isInline()){const e=this.getLastChild();if(e&&!D.isNewLine(e)){return"\n"}}if(D.isListItem(this)){const e=this.getParent().getLastChild();if(e!==this){return"\n"}}return""}getNewLineBeforeOpeningTag(){if(!this.isInline()&&this.hasParent()){const e=this.getPreviewsSibling();if(D.isText(e)||D.isInline(e)){return"\n"}}return""}getNewLineAfterClosingTag(){if(!this.isInline()&&this.hasParent()){const e=this.getNextSibling();if(e&&e.getName()!=="#linebreak"){return"\n"}}return""}getContent(){if(D.isListItem(this)){return this.getChildren().reduceRight(((e,i)=>{if(!t.Type.isArrayFilled(e)&&(D.isNewLine(i)||D.isTab(i))){return e}return[i.toString(),...e]}),[])}return this.getChildren().map((e=>e.toString())).join("")}getOpeningTag(){const e=this.getName();const i=this.toStringValue();const n=this.toStringAttributes();const s=t.Type.isStringFilled(n)?` ${n}`:"";return`[${e}${i}${s}]`}getClosingTag(){return`[/${this.getName()}]`}toString(){const e=this.getOpeningTag();if(this.isVoid()){return e}if(D.isListItem(this)){return`${e}${this.getContent()}${this.getNewLineAfterContent()}`}if(this.isInline()){return`${e}${this.getContent()}${this.getClosingTag()}`}return[this.getNewLineBeforeOpeningTag(),e,this.getNewLineBeforeContent(),this.getContent(),this.getNewLineAfterContent(),this.getClosingTag(),this.getNewLineAfterClosingTag()].join("")}toJSON(){return{...super.toJSON(),value:this.getValue(),attributes:this.getAttributes(),void:this.isVoid(),inline:this.isInline()}}}class z extends U{constructor(e){super(e);i.get(this).type=s.ROOT_NODE;z.freezeProperty(this,"name","#root",false);z.makeNonEnumerableProperty(this,"value");z.makeNonEnumerableProperty(this,"void");z.makeNonEnumerableProperty(this,"inline");z.makeNonEnumerableProperty(this,"attributes")}getParent(){return null}setName(e){}toString(){return this.getChildren().map((e=>e.toString())).join("")}toJSON(){return this.getChildren().map((e=>e.toJSON()))}}class G extends a{constructor(e={}){super(e);this[n]="#linebreak";this[r]=o}setContent(e){}}class W extends U{constructor(e){super(e);this[n]="#fragment";i.get(this).type=s.FRAGMENT_NODE;W.makeNonEnumerableProperty(this,"value");W.makeNonEnumerableProperty(this,"void");W.makeNonEnumerableProperty(this,"inline");W.makeNonEnumerableProperty(this,"attributes")}setName(){}}class q extends a{constructor(e={}){super(e);this[n]="#tab";this[r]=l}setContent(e){}}const H=/\[(\/)?(\w+|\*)([\s\w./:=]+)?]/gs;class K{static toLowerCase(e){if(t.Type.isStringFilled(e)){return e.toLowerCase()}return e}parseText(e){if(t.Type.isStringFilled(e)){return[...e].reduce(((e,i)=>{if(h.has(i)){e.push(i)}else{const n=e.at(-1);if(h.has(n)||t.Type.isNil(n)){e.push(i)}else{e[e.length-1]+=i}}return e}),[]).map((e=>{if(e===o){return new G}if(e===l){return new q}return new a(e)}))}return[]}static findNextTagIndex(e,t=0){const i=e.slice(t);const[n]=i.match(new RegExp(H))||[];if(n){return e.indexOf(n,t)}return-1}parseAttributes(e){const i={value:"",attributes:[]};if(t.Type.isStringFilled(e)){return e.trim().split(" ").filter(Boolean).reduce(((e,t)=>{if(t.startsWith("=")){e.value=t.slice(1);return e}const[i,n=""]=t.split("=");e.attributes.push([K.toLowerCase(i),n]);return e}),i)}return i}parse(e){const t=new z;const i=[];let n=null;let s=-1;const r=K.findNextTagIndex(e);if(r!==0){const i=r===-1?e:e.slice(0,r);t.appendChild(...this.parseText(i))}e.replace(H,((r,a,l,o,h)=>{const u=Boolean(a)===false;const c=r.length+h;const d=e.slice(c);const g=this.parseAttributes(o);const p=K.toLowerCase(l);let f=null;if(u){s++;if(d.includes(`[/${l}]`)||F.has(p)){n=new U({name:p,value:g.value,attributes:Object.fromEntries(g.attributes)});const t=K.findNextTagIndex(e,c);if(t!==0){const i=t===-1?d:e.slice(c,t);n.appendChild(...this.parseText(i))}}else{n=new U({name:p,value:g.value,attributes:Object.fromEntries(g.attributes),void:true})}if(s===0){t.appendChild(n)}f=i[s-1];if(B.has(n.getName())){if(f&&B.has(f.getName())){i[s].appendChild(n)}}else if(f&&B.has(f.getName())&&!F.has(n.getName())){const e=f.getChildren().at(-1);if(e){e.appendChild(n)}}else if(f){f.appendChild(n)}i[s]=n;if(F.has(p)&&s>-1){s--;n=s===-1?t:i[s]}}if(!u||n.isVoid()){if(s>-1&&n.getName()===p){s--;n=s===-1?t:i[s]}const r=K.findNextTagIndex(e,c);if(r!==c){f=s===-1?t:i[s];const n=e.slice(c,r===-1?undefined:r);if(B.has(f.getName())){const e=f.getChildren().at(-1);if(e){e.appendChild(...this.parseText(n))}}else{f.appendChild(...this.parseText(n))}}}}));return t}}e.Parser=K;e.RootNode=z;e.Node=s;e.ElementNode=U;e.TextNode=a;e.NewLineNode=G;e.FragmentNode=W;e.TabNode=q})(this.BX.UI.Bbcode=this.BX.UI.Bbcode||{},BX);
//# sourceMappingURL=parser.bundle.map.js