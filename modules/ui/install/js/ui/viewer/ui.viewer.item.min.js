(function(){"use strict";BX.namespace("BX.UI.Viewer");BX.UI.Viewer.Item=function(e){e=e||{};this.controller=null;this.title=e.title;this.src=e.src;this.nakedActions=e.nakedActions;this.actions=e.actions;this.contentType=e.contentType;this.isLoaded=false;this.isLoading=false;this.sourceNode=null;this.transformationPromise=null;this.transformationTimeoutId=null;this.viewerGroupBy=null;this.transformationTimeout=e.transformationTimeout||15e3;this.layout={container:null};this.options=e;this.init()};BX.UI.Viewer.Item.prototype={setController:function(e){if(!(e instanceof BX.UI.Viewer.Controller)){throw new Error("BX.UI.Viewer.Item: 'controller' has to be instance of BX.UI.Viewer.Controller.")}this.controller=e},setPropertiesByNode:function(e){this.title=e.dataset.title||e.title||e.alt;this.src=e.dataset.src;this.viewerGroupBy=e.dataset.viewerGroupBy;this.nakedActions=e.dataset.actions?JSON.parse(e.dataset.actions):undefined},bindSourceNode:function(e){this.sourceNode=e},applyReloadOptions:function(e){},isPullConnected:function(){if(top.BX.PULL){if(BX.type.isFunction(top.BX.PULL.isConnected)){return top.BX.PULL.isConnected()}else{var e=top.BX.PULL.getDebugInfoArray();return e.connected}}return false},registerTransformationHandler:function(e){if(this.isLoaded){return}if(this.controller.getCurrentItem()===this){this.controller.setTextOnLoading(BX.message("JS_UI_VIEWER_ITEM_TRANSFORMATION_IN_PROGRESS"))}if(this.isPullConnected()){BX.addCustomEvent("onPullEvent-main",function(e,t){if(e==="transformationComplete"&&this.transformationPromise){this.loadData().then(function(){this.transformationPromise.fulfill(this)}.bind(this))}}.bind(this));console.log("BX.PULL.extendWatch");BX.PULL.extendWatch(e)}else{setTimeout(function(){BX.ajax.promise({url:BX.util.add_url_param(this.src,{ts:"bxviewer"}),method:"GET",dataType:"json",headers:[{name:"BX-Viewer-check-transformation",value:null}]}).then(function(e){if(!e.data||!e.data.transformation){this.registerTransformationHandler()}else{this.loadData().then(function(){this.transformationPromise.fulfill(this)}.bind(this))}}.bind(this))}.bind(this),5e3)}this.transformationTimeoutId=setTimeout(function(){if(!this.isLoaded){console.log("Throw transformationTimeout");if(this._loadPromise){this._loadPromise.reject({status:"timeout",message:BX.message("JS_UI_VIEWER_ITEM_TRANSFORMATION_ERROR_1").replace("#DOWNLOAD_LINK#",this.getSrc()),item:this});this.isLoading=false}}else{console.log("We don't have transformationTimeout :) ")}this.resetTransformationTimeout()}.bind(this),this.transformationTimeout)},resetTransformationTimeout:function(){if(this.transformationTimeoutId){clearTimeout(this.transformationTimeoutId)}this.transformationTimeoutId=null},init:function(){},load:function(){var e=new BX.Promise;if(this.isLoaded){e.fulfill(this);console.log("isLoaded");return e}if(this.isLoading){console.log("isLoading");return this._loadPromise}this.isLoading=true;this._loadPromise=this.loadData().then(function(e){this.isLoaded=true;this.isLoading=false;return e}.bind(this)).catch(function(e){console.log("catch");this.isLoaded=false;this.isLoading=false;if(!e.item){e.item=this}var t=new BX.Promise;t.reject(e);return t}.bind(this));console.log("will load");return this._loadPromise},listContainerModifiers:function(){return[]},getSrc:function(){return this.src},hashCode:function(e){var t=0,i=e.length,r=0;if(i>0){while(r<i)t=(t<<5)-t+e.charCodeAt(r++)|0}return t},generateUniqueId:function(){return this.hashCode(this.getSrc()||"")+Math.floor(Math.random()*Math.floor(1e4))},getTitle:function(){return this.title},getGroupBy:function(){return this.viewerGroupBy},getNakedActions:function(){if(typeof this.nakedActions==="undefined"){return[{type:"download"}]}return this.nakedActions},setActions:function(e){this.actions=e},getActions:function(){return this.actions},loadData:function(){var e=new BX.Promise;e.setAutoResolve(true);e.fulfill(this);return e},render:function(){},getContentWidth:function(){},handleKeyPress:function(e){},afterRender:function(){},beforeHide:function(){}};BX.UI.Viewer.Image=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.resizedSrc=e.resizedSrc;this.width=e.width;this.height=e.height;this.imageNode=null;this.layout={container:null}};BX.UI.Viewer.Image.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.src=e.dataset.src||e.src;this.width=e.dataset.width;this.height=e.dataset.height},applyReloadOptions:function(e){this.controller.unsetCachedData(this.src)},tryToExportResizedSrcFromSourceNode:function(){var e=210;if(!(this.sourceNode instanceof Image)){return}if(!this.sourceNode.naturalWidth){return}var t=this.controller.getItemContainer().offsetHeight;var i=this.controller.getItemContainer().offsetWidth;var r=t/i;var n=t-e;var o=n/r;if(this.sourceNode.naturalWidth>=o||this.sourceNode.naturalHeight>=n){this.resizedSrc=this.sourceNode.src}},loadData:function(){var e=new BX.Promise;if(!this.shouldRunLocalResize()){this.resizedSrc=this.src}this.tryToExportResizedSrcFromSourceNode();if(this.controller.getCachedData(this.src)){this.resizedSrc=this.controller.getCachedData(this.src).resizedSrc}if(!this.resizedSrc){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState!==XMLHttpRequest.DONE){return}if((t.status===200||t.status===0)&&t.response){console.log("resize image");this.resizedSrc=URL.createObjectURL(t.response);this.imageNode=new Image;this.imageNode.src=this.resizedSrc;this.imageNode.onload=function(){e.fulfill(this)}.bind(this);this.controller.setCachedData(this.src,{resizedSrc:this.resizedSrc})}else{e.reject({item:this,type:"error"})}}.bind(this);t.open("GET",BX.util.add_url_param(this.src,{ts:"bxviewer"}),true);t.responseType="blob";t.setRequestHeader("BX-Viewer-image","x");t.send()}else{this.imageNode=new Image;this.imageNode.onload=function(){e.fulfill(this)}.bind(this);this.imageNode.onerror=this.imageNode.onabort=function(t){console.log("reject");e.reject({item:this,type:"error"})}.bind(this);this.imageNode.src=this.resizedSrc}return e},shouldRunLocalResize:function(){return!this.controller.isExternalLink(this.src)},render:function(){var e=document.createDocumentFragment();e.appendChild(this.imageNode);if(this.title){e.appendChild(BX.create("div",{props:{className:"viewer-inner-fullsize"},children:[BX.create("a",{props:{href:BX.util.add_url_param(this.src,{ts:"bxviewer",ibxShowImage:1}),target:"_blank"},text:BX.message("JS_UI_VIEWER_IMAGE_VIEW_FULL_SIZE"),events:{click:function(e){e.stopPropagation()}}})]}))}this.imageNode.alt=this.title;return e},getContentWidth:function(){var e=new BX.Promise;e.fulfill(this.imageNode.offsetWidth);return e},afterRender:function(){if(!window.chrome){setTimeout(function(){this.imageNode.removeAttribute("width");this.imageNode.removeAttribute("height")}.bind(this),200)}}};BX.UI.Viewer.PlainText=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.content=e.content};BX.UI.Viewer.PlainText.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.content=e.dataset.content},render:function(){var e=BX.create("span",{text:this.content});e.style.fontSize="18px";e.style.color="white";return e}};BX.UI.Viewer.Audio=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.playerId="audio-playerId_"+this.generateUniqueId();this.svgMask=null};BX.UI.Viewer.Audio.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.playerId="audio-playerId_"+this.generateUniqueId()},loadData:function(){var e=new BX.Promise;if(BX.getClass("BX.Fileman.Player")){e.fulfill(this);return e}var t=[{name:"BX-Viewer-src",value:this.src},{name:"BX-Viewer",value:"audio"}];var i=BX.ajax.promise({url:BX.util.add_url_param(this.src,{ts:"bxviewer"}),method:"GET",dataType:"json",headers:t});i.then(function(t){if(!t||!t.data){e.reject({item:this,type:"error",errors:t.errors||[]});return}if(t.data.html&&!BX.getClass("BX.Fileman.Player")){var i=BX.processHTML(t.data.html);BX.load(i.STYLE,function(){BX.ajax.processScripts(i.SCRIPT,undefined,function(){e.fulfill(this)}.bind(this))}.bind(this))}else{e.fulfill(this)}}.bind(this));return e},render:function(){this.player=new BX.Fileman.Player(this.playerId,{width:320,height:52,isAudio:true,skin:"vjs-viewer-audio-player-skin",sources:[{src:this.src,type:"audio/mp3"}],onInit:function(e){e.vjsPlayer.controlBar.removeChild("timeDivider");e.vjsPlayer.controlBar.removeChild("durationDisplay");e.vjsPlayer.controlBar.removeChild("fullscreenToggle");e.vjsPlayer.hasStarted(true)}});return this.player.createElement()},afterRender:function(){this.player.init()}};BX.UI.Viewer.HightlightCode=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.content=e.content};BX.UI.Viewer.HightlightCode.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.content=e.dataset.content},listContainerModifiers:function(){return["ui-viewer-document","ui-viewer-document-hlcode"]},loadData:function(){var e=new BX.Promise;BX.loadExt("ui.highlightjs").then(function(){if(!this.content){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState!==XMLHttpRequest.DONE){return}if((t.status===200||t.status===0)&&t.response){this.content=t.response;console.log("text content is loaded");this.controller.setCachedData(this.src,{content:this.content});e.fulfill(this)}else{e.reject({item:this,type:"error"})}}.bind(this);t.open("GET",BX.util.add_url_param(this.src,{ts:"bxviewerText"}),true);t.responseType="text";t.send()}else{e.fulfill(this)}}.bind(this));return e},render:function(){var e=this.getTitle().substring(this.getTitle().lastIndexOf(".")+1);this.controller.layout.container.classList.add("ui-viewer-document","ui-viewer-document-hlcode");return BX.create("div",{props:{tabIndex:2208},style:{width:"100%",height:"100%",paddingTop:"67px",background:"rgba(0, 0, 0, 0.1)",overflow:"auto"},children:[BX.create("pre",{children:[this.codeNode=BX.create("code",{props:{className:hljs.getLanguage(e)?e:"plaintext"},style:{fontSize:"18px",textAlign:"left"},text:this.content})]})]})},getContentWidth:function(){var e=new BX.Promise;e.fulfill(this.codeNode.offsetWidth);return e},afterRender:function(){hljs.highlightBlock(this.codeNode)}};BX.UI.Viewer.Unknown=function(e){BX.UI.Viewer.Item.apply(this,arguments)};BX.UI.Viewer.Unknown.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,render:function(){return BX.create("div",{props:{className:"ui-viewer-unsupported"},children:[BX.create("div",{props:{className:"ui-viewer-unsupported-title"},text:BX.message("JS_UI_VIEWER_ITEM_UNKNOWN_TITLE")}),BX.create("div",{props:{className:"ui-viewer-unsupported-text"},text:BX.message("JS_UI_VIEWER_ITEM_UNKNOWN_NOTICE")}),BX.create("a",{props:{className:"ui-btn ui-btn-light-border ui-btn-themes",href:this.getSrc(),target:"_blank"},text:BX.message("JS_UI_VIEWER_ITEM_UNKNOWN_DOWNLOAD_ACTION")})]})}};BX.UI.Viewer.Video=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.player=null;this.sources=[];this.transformationPromise=null;this.contentNode=null;this.forceTransformation=false;this.videoWidth=null;this.playerId="playerId_"+this.generateUniqueId()};BX.UI.Viewer.Video.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.playerId="playerId_"+this.generateUniqueId()},applyReloadOptions:function(e){if(e.forceTransformation){this.forceTransformation=true}},init:function(){BX.addCustomEvent("PlayerManager.Player:onAfterInit",this.handleAfterInit.bind(this));BX.addCustomEvent("PlayerManager.Player:onError",this.handleAfterInit.bind(this))},loadData:function(){var e=new BX.Promise;var t=[{name:"BX-Viewer-src",value:this.src}];t.push({name:this.forceTransformation?"BX-Viewer-force-transformation":"BX-Viewer",value:"video"});var i=BX.ajax.promise({url:BX.util.add_url_param(this.src,{ts:"bxviewer"}),method:"GET",dataType:"json",headers:t});i.then(function(t){if(!t||!t.data){e.reject({item:this,type:"error",errors:t.errors||[]});return}if(t.data.hasOwnProperty("pullTag")){this.transformationPromise=e;this.registerTransformationHandler(t.data.pullTag)}else{if(t.data.data){this.width=t.data.data.width;this.height=t.data.data.height;this.sources=t.data.data.sources}if(t.data.html){var i=BX.processHTML(t.data.html);BX.load(i.STYLE,function(){BX.ajax.processScripts(i.SCRIPT,undefined,function(){e.fulfill(this)}.bind(this))}.bind(this))}}}.bind(this));return e},handleAfterInit:function(e){if(e.id!==this.playerId){return}if(this.handleVideoError(e)){return}if(e.vjsPlayer.videoWidth()>0&&e.vjsPlayer.videoHeight()>0){this.adjustVideo()}else{e.vjsPlayer.one("loadedmetadata",this.adjustVideo.bind(this))}},handleVideoError:function(e){if(e.id!==this.playerId){return false}if(e.vjsPlayer.error()&&!this.forceTransformation){console.log("forceTransformation");this.controller.reload(this,{forceTransformation:true});return true}return false},adjustVideo:function(){var e=this.contentNode;if(!e){return}if(!this.player.vjsPlayer){return}if(this.adjustVideoWidth(e,this.player.width,this.player.height,this.player.vjsPlayer.videoWidth(),this.player.vjsPlayer.videoHeight())){this.player.vjsPlayer.fluid(true)}BX.addClass(e,"player-loaded");BX.style(e,"opacity",1)},adjustVideoWidth:function(e,t,i,r,n){if(!BX.type.isDomNode(e)){return false}if(!t||!i||!r||!n){return false}if(n<i&&r<t){BX.width(e,r);this.videoWidth=r;if(!this.contentWidthPromise.state){this.contentWidthPromise.fulfill(this.videoWidth)}return true}else{var o=t/i;var s=r/n;var a=1;if(o>s){a=i/n}else{a=t/r}BX.width(e,Math.floor(r*a));this.videoWidth=Math.floor(r*a);if(!this.contentWidthPromise.state){this.contentWidthPromise.fulfill(this.videoWidth)}}return true},getContentWidth:function(){this.contentWidthPromise=new BX.Promise;if(this.videoWidth){this.contentWidthPromise.fulfill(this.videoWidth)}return this.contentWidthPromise},render:function(){this.player=new BX.Fileman.Player(this.playerId,{width:this.width,height:this.height,sources:this.sources});this.controller.showLoading();return this.contentNode=BX.create("div",{style:{opacity:0},children:[this.player.createElement()]})},afterRender:function(){this.player.init()}};BX.UI.Viewer.Document=function(e){BX.UI.Viewer.Item.apply(this,arguments);e=e||{};this.scale=e.scale||1.4;this.pdfDocument=null;this.pdfPages={};this.pdfRenderedPages={};this.lastRenderedPdfPage=null;this.contentNode=null;this.previewHtml=null;this.previewScriptToProcess=null;this.transformationPromise=null};BX.UI.Viewer.Document.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments)},applyReloadOptions:function(e){this.controller.unsetCachedData(this.src)},listContainerModifiers:function(){return["ui-viewer-document"]},loadData:function(){var e=new BX.Promise;console.log("loadData pdf");var t=BX.ajax.promise({url:BX.util.add_url_param(this.src,{ts:"bxviewer"}),method:"GET",dataType:"json",headers:[{name:"BX-Viewer-src",value:this.src},{name:"BX-Viewer",value:"document"}]});t.then(function(t){if(!t||!t.data){e.reject({item:this,message:BX.message("JS_UI_VIEWER_ITEM_TRANSFORMATION_ERROR_1").replace("#DOWNLOAD_LINK#",this.getSrc()),type:"error"});return}if(t.data.hasOwnProperty("pullTag")){this.transformationPromise=e;this.registerTransformationHandler(t.data.pullTag)}if(t.data.data&&t.data.data.src){this._pdfSrc=t.data.data.src;BX.loadExt("ui."+this.getPdfJsExtensionName()).then(function(){if(!pdfjsLib.GlobalWorkerOptions.workerSrc){pdfjsLib.GlobalWorkerOptions.workerSrc="/bitrix/js/ui/"+this.getPdfJsExtensionName()+"/pdf.worker.js"}e.fulfill(this)}.bind(this))}}.bind(this));return e},getPdfJsExtensionName:function(){return BX.browser.IsIE11()?"pdfjs-ie11":"pdfjs"},render:function(){this.controller.showLoading();this.contentNode=BX.create("div",{props:{tabIndex:2208},style:{width:"100%",height:"100%",paddingTop:"67px",background:"rgba(0, 0, 0, 0.1)",overflow:"auto"}});BX.bind(this.contentNode,"scroll",BX.throttle(this.handleScrollDocument.bind(this),100));return this.contentNode},getFirstDocumentPageHeight:function(){var e=new BX.Promise;if(this._height){e.fulfill(this._height)}else{this.getDocumentPage(this.pdfDocument,1).then(function(t){var i=t.getViewport(this.scale);this._height=i.height;e.fulfill(this._height)}.bind(this))}return e},handleScrollDocument:function(e){var t=3;this.getFirstDocumentPageHeight().then(function(e){var i=this.contentNode.scrollHeight-this.contentNode.scrollTop-this.contentNode.clientHeight;if(i<e*t&&this.pdfDocument.numPages>this.lastRenderedPdfPage){for(var r=this.lastRenderedPdfPage+1;r<=Math.min(this.pdfDocument.numPages,this.lastRenderedPdfPage+t);r++){this.renderDocumentPage(this.pdfDocument,r)}}}.bind(this))},loadDocument:function(){var e=new BX.Promise;if(this.pdfDocument){e.fulfill(this.pdfDocument)}else{pdfjsLib.getDocument(this._pdfSrc).promise.then(function(t){this.pdfDocument=t;e.fulfill(this.pdfDocument)}.bind(this))}return e},getDocumentPage:function(e,t){var i=new BX.Promise;if(this.pdfPages[t]){i.fulfill(this.pdfPages[t])}else{e.getPage(t).then(function(e){this.pdfPages[t]=e;i.fulfill(this.pdfPages[t])}.bind(this))}return i},renderDocumentPage:function(e,t){if(this.pdfRenderedPages[t]){return}this.pdfRenderedPages[t]=true;this.getDocumentPage(e,t).then(function(e){var i=this.createCanvasPage();var r=e.getViewport(this.scale);i.height=r.height;i.width=r.width;e.render({canvasContext:i.getContext("2d"),viewport:r});this.lastRenderedPdfPage=Math.max(t,this.lastRenderedPdfPage);if(t===1){this.firstWidthDocumentPage=i.width;this.contentWidthPromise.fulfill(this.firstWidthDocumentPage)}this.controller.hideLoading()}.bind(this))},createCanvasPage:function(){var e=document.createElement("canvas");e.className="ui-viewer-document-page-canvas";this.contentNode.appendChild(e);return e},getContentWidth:function(){this.contentWidthPromise=new BX.Promise;if(this.firstWidthDocumentPage){this.contentWidthPromise.fulfill(this.firstWidthDocumentPage)}return this.contentWidthPromise},afterRender:function(){this.loadDocument().then(function(e){for(var t=1;t<=Math.min(e.numPages,3);t++){if(t===1){this._handleControls=this.controller.handleVisibleControls.bind(this.controller);this.controller.enableReadingMode(true);BX.throttle(BX.bind(window,"mousemove",this._handleControls),20)}this.renderDocumentPage(e,t)}}.bind(this))},beforeHide:function(){this.pdfRenderedPages=[];BX.unbind(window,"mousemove",this._handleControls)},handleKeyPress:function(e){switch(e.code){case"PageDown":case"PageUp":case"ArrowDown":case"ArrowUp":BX.focus(this.contentNode);break}}}})();
//# sourceMappingURL=ui.viewer.item.map.js