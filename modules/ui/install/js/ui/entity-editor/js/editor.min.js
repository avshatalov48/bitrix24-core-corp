BX.namespace("BX.UI");if(typeof BX.UI.EntityEditor==="undefined"){BX.UI.EntityEditor=function(){this._id="";this._settings={};this._entityTypeName="";this._entityId=0;this._userFieldManager=null;this._container=null;this._layoutContainer=null;this._buttonContainer=null;this._createSectionButton=null;this._configMenuButton=null;this._configIcon=null;this._pageTitle=null;this._pageTitleInput=null;this._buttonWrapper=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._formElement=null;this._ajaxForm=null;this._formSubmitHandler=BX.delegate(this.onFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.UI.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._enableRequiredUserFieldCheck=true;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._enableVisibilityPolicy=true;this._enablePageTitleContols=true;this._enableToolPanel=true;this._enableBottomPanel=true;this._enableConfigControl=true;this._enableFieldsContextMenu=true;this._serviceUrl="";this._htmlEditorConfigs=null;this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._validators=null;this._modeSwitch=null;this._delayedSaveHandle=0;this._isEmbedded=false;this._isRequestRunning=false;this._isConfigMenuShown=false;this._isReleased=false;this._enableCloseConfirmation=true;this._closeConfirmationHandler=BX.delegate(this.onCloseConfirmButtonClick,this);this._cancelConfirmationHandler=BX.delegate(this.onCancelConfirmButtonClick,this);this._sliderOpenHandler=BX.delegate(this.onSliderOpen,this);this._sliderCloseHandler=BX.delegate(this.onSliderClose,this);this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._dragConfig={};this._configurationFieldManager=null};BX.UI.EntityEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isNew=this._entityId<=0&&this._model.isIdentifiable();this._isEmbedded=BX.prop.getBoolean(this._settings,"isEmbedded",false);this._creationFieldPageUrl=BX.prop.getBoolean(this._settings,"creationFieldPageUrl",false);this._container=BX(BX.prop.get(this._settings,"containerId"));this._parentContainer=BX.findParent(this._container,{className:"ui-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._configIcon=BX(BX.prop.get(this._settings,"configIconId"));this.adjustSize();this.adjustTitle();this._enableVisibilityPolicy=BX.prop.getBoolean(this._settings,"enableVisibilityPolicy",true);var i=BX.prop.getString(this._settings,"formTagName","form");this._formElement=BX.create(i,{props:{name:this._id+"_form"}});this._container.appendChild(this._formElement);this._layoutContainer=BX.create("div",{props:{className:"ui-entity-editor-column-wrapper"}});this._formElement.appendChild(this._layoutContainer);this._enableRequiredUserFieldCheck=BX.prop.getBoolean(this._settings,"enableRequiredUserFieldCheck",true);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}this.initializeManagers();this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._controllers=[];this._controls=[];this._activeControls=[];this._modeSwitch=BX.UI.EntityEditorModeSwitch.create(this._id,{editor:this});this._htmlEditorConfigs=BX.prop.getObject(this._settings,"htmlEditorConfigs",{});var n=BX.UI.EntityEditorMode.view;if(!this._readOnly){n=BX.UI.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=n!==BX.UI.EntityEditorMode.intermediate?n:BX.UI.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.UI.EntityEditorMode.edit}var o,s;var r=BX.prop.getArray(this._settings,"controllers",[]);for(o=0,s=r.length;o<s;o++){var a=this.createController(r[o]);if(a){this._controllers.push(a)}}var l=this._scheme.getElements();var h,d;for(o=0,s=l.length;o<s;o++){h=l[o];d=this.createControl(h.getType(),h.getName(),{schemeElement:h,mode:BX.UI.EntityEditorMode.view});if(!d){continue}this._controls.push(d)}if(this._mode===BX.UI.EntityEditorMode.edit&&this._controls.length>0){for(o=0,s=this._controls.length;o<s;o++){this._controls[o].setMode(BX.UI.EntityEditorMode.edit,{notify:false})}}this._availableSchemeElements=this._scheme.getAvailableElements();this._validators=[];var c=BX.prop.getArray(this._settings,"validators",[]);for(o=0,s=c.length;o<s;o++){var u=this.createValidator(c[o]);if(u){this._validators.push(u)}}this._enableToolPanel=BX.prop.getBoolean(this._settings,"enableToolPanel",true);if(this._enableToolPanel){this._toolPanel=BX.UI.EntityEditorToolPanel.create(this._id,{container:this._isEmbedded?this._formElement:document.body,editor:this,visible:false})}this._enableBottomPanel=BX.prop.getBoolean(this._settings,"enableBottomPanel",true);this._enableConfigControl=BX.prop.getBoolean(this._settings,"enableConfigControl",true);this._enableFieldsContextMenu=BX.prop.getBoolean(this._settings,"enableFieldsContextMenu",true);this._dragConfig={};var _={};_[BX.UI.EntityEditorMode.names.view]=_[BX.UI.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableSectionDragDrop",true);this._dragConfig[BX.UI.EditorDragObjectType.section]={scope:BX.UI.EditorDragScope.form,modes:_};var f={};f[BX.UI.EntityEditorMode.names.view]=f[BX.UI.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableFieldDragDrop",true);this._dragConfig[BX.UI.EditorDragObjectType.field]={scope:BX.UI.EditorDragScope.form,modes:f};this.layout();this.attachToEvents();var g={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.UI.EntityEditor:onInit",[this,g])},initializeManagers:function(){this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._configurationFieldManager=BX.UI.EntityConfigurationManager.create(this._id,{editor:this});var t={id:this._id,editor:this,type:"editor",configurationFieldManager:this._configurationFieldManager};BX.onCustomEvent(window,"BX.UI.EntityConfigurationManager:onInitialize",[this,t]);this._configurationFieldManager=t.configurationFieldManager},initializeCustomEditors:function(){},attachToEvents:function(){BX.bind(window,"resize",BX.debounce(BX.delegate(this.onResize,this),50));BX.addCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.addCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler)},deattachFromEvents:function(){BX.removeCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.removeCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler)},release:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout()}this.deattachFromEvents();this.releaseAjaxForm();this._container=BX.remove(this._container);this._isReleased=true},onSliderOpen:function(t){this._enableCloseConfirmation=true;var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.UI.EntityEditor:onOpen",[this,e])},onSliderClose:function(t){if(!this._enableCloseConfirmation){return}var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e!==t.getSlider()){return}if(!e.isOpen()){return}if(!this.hasChangedControls()&&!this.hasChangedControllers()){return}t.denyAction();if(BX.UI.EditorAuxiliaryDialog.isItemOpened("close_confirmation")){return}BX.UI.EditorAuxiliaryDialog.create("close_confirmation",{title:BX.message("UI_ENTITY_EDITOR_CONFIRMATION"),content:BX.message("UI_ENTITY_EDITOR_CLOSE_CONFIRMATION"),zIndex:100,buttons:[{id:"close",type:BX.UI.DialogButtonType.accept,text:BX.message("JS_CORE_WINDOW_CLOSE"),callback:this._closeConfirmationHandler},{id:"cancel",type:BX.UI.DialogButtonType.cancel,text:BX.message("JS_CORE_WINDOW_CANCEL"),callback:this._closeConfirmationHandler}]}).open()},onCloseConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="close"){this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}},initializeAjaxForm:function(){if(this._ajaxForm){return}var t=BX.prop.getObject(this._settings,"ajaxData",{});var e=BX.prop.getString(t,"ACTION_NAME","");var i=BX.prop.getString(t,"COMPONENT_NAME","");if(i!==""){if(e===""){e="save"}this._ajaxForm=BX.UI.ComponentAjax.create(this._id,{elementNode:this._formElement,className:i,signedParameters:BX.prop.getString(t,"SIGNED_PARAMETERS",null),actionName:e,callbacks:{onSuccess:BX.delegate(this.onSaveSuccess,this),onFailure:BX.delegate(this.onSaveFailure,this)}})}else{if(e===""){e="SAVE"}this._ajaxForm=BX.UI.AjaxForm.create(this._id,{elementNode:this._formElement,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:BX.delegate(this.onSaveSuccess,this),data:{ACTION:e,ACTION_ENTITY_TYPE:this._entityTypeName,ENABLE_REQUIRED_USER_FIELD_CHECK:this._enableRequiredUserFieldCheck?"Y":"N"}}})}this._formElement.setAttribute("onsubmit","return false;");BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler)},releaseAjaxForm:function(){if(!this._ajaxForm){return}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler);this._ajaxForm=null},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getContextId:function(){return this._contextId},getContext:function(){return this._context},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},isVisible:function(){return this._container.offsetParent!==null},isVisibilityPolicyEnabled:function(){return this._enableVisibilityPolicy},isBottomPanelEnabled:function(){return this._enableBottomPanel},isConfigControlEnabled:function(){return this._enableConfigControl},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation&&this.canChangeScheme()},isFieldsContextMenuEnabled:function(){return this._enableFieldsContextMenu},isModeToggleEnabled:function(){return this._enableModeToggle},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEmbedded:function(){return this._isEmbedded},isEditInViewEnabled:function(){return this._entityId>0},getDetailManager:function(){if(typeof BX.UI.EntityDetailManager==="undefined"){return null}return BX.UI.EntityDetailManager.get(BX.prop.getString(this._settings,"detailManagerId",""))},getConfigurationFieldManager:function(){return this._configurationFieldManager},getUserFieldManager:function(){return this._userFieldManager},getAttributeManager:function(){return null},getHtmlEditorConfig:function(t){return BX.prop.getObject(this._htmlEditorConfigs,t,null)},createValidator:function(t){t["editor"]=this;return BX.UI.EntityEditorValidatorFactory.create(BX.prop.getString(t,"type",""),t)},getControlByIndex:function(t){return t>=0&&t<this._controls.length?this._controls[t]:null},getControlIndex:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e]===t){return e}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._layoutContainer;i["model"]=this._model;i["editor"]=this;return BX.UI.EntityEditorControlFactory.create(t,e,i)},addControlAt:function(t,e){var i={};if(e<this._controls.length){i["anchor"]=this._controls[e].getWrapper();this._controls.splice(e,0,t)}else{this._controls.push(t)}t.layout(i)},moveControl:function(t,e){var i=this._controls.length;var n=i-1;if(e<0||e>i){e=n}var o=this.getControlIndex(t);if(o<0||o===e){return false}t.clearLayout();this._controls.splice(o,1);i--;var s=e<i?this._controls[e].getWrapper():null;if(e<i){this._controls.splice(e,0,t)}else{this._controls.push(t)}if(s){t.layout({anchor:s})}else{t.layout()}this._config.moveSchemeElement(t.getSchemeElement(),e)},removeControl:function(t){var e=this.getControlIndex(t);if(e<0){return false}this.processControlRemove(t);t.clearLayout();this._controls.splice(e,1)},getControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){var n=this._controls[e];if(n.getId()===t){return n}var o=n.getChildById(t);if(o){return o}}return null},getControlByIdRecursive:function(t,e){var i;if(!e){e=this.getControls()}for(var n=0;n<e.length;n++){if(!e[n]instanceof BX.UI.EntityEditorControl){continue}if(e[n].getId()===t){return e[n]}else if(e[n]instanceof BX.UI.EntityEditorColumn||e[n]instanceof BX.UI.EntityEditorSection){if(i=this.getControlByIdRecursive(t,e[n].getChildren())){return i}}}return null},getAllControls:function(t){var e=[],i;if(!t){t=this.getControls()}for(var n=0;n<t.length;n++){if(t[n]instanceof BX.UI.EntityEditorControl){if(t[n]instanceof BX.UI.EntityEditorColumn||t[n]instanceof BX.UI.EntityEditorSection){if(i=this.getAllControls(t[n].getChildren())){e=e.concat(i)}}else{e.push(t[n])}}}return e},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(t){var e=this._activeControls.length;if(e===0){return-1}for(var i=0;i<e;i++){if(this._activeControls[i]===t){return i}}return-1},getActiveControlById:function(t,e){e=!!e;var i=this._activeControls.length;if(i===0){return null}for(var n=0;n<i;n++){var o=this._activeControls[n];if(o.getId()===t){return o}if(e){var s=o.getChildById(t);if(s){return s}}}return null},getActiveControlByIndex:function(t){return t>=0&&t<this._activeControls.length?this._activeControls[t]:null},registerActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}this._activeControls.push(t);t.setActive(true);if(this._mode!==BX.UI.EntityEditorMode.edit){this._mode=BX.UI.EntityEditorMode.edit}},unregisterActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e<0){return}this._activeControls.splice(e,1);t.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.UI.EntityEditorMode.view){this._mode=BX.UI.EntityEditorMode.view}},releaseActiveControls:function(t){var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.UI.EntityEditor:onRelease",[this,e]);for(var i=0,n=this._activeControls.length;i<n;i++){var o=this._activeControls[i];o.setActive(false);o.toggleMode(false,t)}this._activeControls=[]},hasChangedControls:function(){for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isChanged()){return true}}return false},hasChangedControllers:function(){for(var t=0,e=this._controllers.length;t<e;t++){if(this._controllers[t].isChanged()){return true}}return false},isWaitingForInput:function(){if(this._mode!==BX.UI.EntityEditorMode.edit){return false}for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isWaitingForInput()){return true}}return false},processControlModeChange:function(t){if(t.getMode()===BX.UI.EntityEditorMode.edit){this.registerActiveControl(t)}else{this.unregisterActiveControl(t)}if(this.getActiveControlCount()>0){this.showToolPanel()}else{this.hideToolPanel()}},processControlChange:function(t,e){this.showToolPanel()},processControlAdd:function(t){this.removeAvailableSchemeElement(t.getSchemeElement())},processControlMove:function(t){},processControlRemove:function(t){if(t instanceof BX.UI.EntityEditorField){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.UI.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}},processSchemeChange:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].processSchemeChange()}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(t){this._availableSchemeElements.push(t);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(t){var e=this.getAvailableSchemeElementIndex(t);if(e<0){return}this._availableSchemeElements.splice(e,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){if(e[i]===t){return i}}return-1},getAvailableSchemeElementByName:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){var o=e[i];if(o.getName()===t){return o}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},getSchemeElementByName:function(t){return this._scheme.findElementByName(t,{isRecursive:true})},notifyAvailableSchemeElementsChanged:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].processAvailableSchemeElementsChange()}},hasTransferableElements:function(t){var e=0;if(BX.type.isArray(t)){e=t.length}var i=this._scheme.getElements();for(var n=0,o=i.length;n<o;n++){var s=i[n].getElements();for(var r=0,a=s.length;r<a;r++){var l=s[r];var h=false;if(e>0){var d=l.getName();for(var c=0;c<e;c++){if(t[c]===d){h=true;break}}}if(h){continue}var u=l.getElements();for(var _=0,f=u.length;_<f;_++){if(u[_].isTransferable()&&u[_].getName()!==""){return true}}}}return false},createController:function(t){return BX.UI.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})},processControllerChange:function(t){this.showToolPanel()},getContainer:function(){return this._container},prepareContextDataLayout:function(t,e){for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var o=i;if(BX.type.isNotEmptyString(e)){o=e+"["+o+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,o)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:o,value:n}}))}}},layout:function(){this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}var t={edit:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this})};var e,i,n;for(e=0,i=this._controls.length;e<i;e++){n=this._controls[e];var o=n.getMode();var s={userFieldLoader:t[BX.UI.EntityEditorMode.getName(o)],enableFocusGain:!this._isEmbedded};n.layout(s);if(o===BX.UI.EntityEditorMode.edit){this.registerActiveControl(n)}}for(var r in t){if(t.hasOwnProperty(r)){t[r].runBatch()}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._buttonContainer&&this.isBottomPanelEnabled()){if(this.isSectionCreationEnabled()){this._createSectionButton=BX.create("span",{props:{className:"ui-entity-add-widget-link"},text:BX.message("UI_ENTITY_EDITOR_CREATE_SECTION"),events:{click:BX.delegate(this.onCreateSectionButtonClick,this)}});this._buttonContainer.appendChild(this._createSectionButton)}if(this.isConfigControlEnabled()){var a=this._config.getScope();var l=BX.UI.EntityConfigScope.getCaption(a);this._buttonContainer.appendChild(BX.create("span",{props:{className:a===BX.UI.EntityConfigScope.common?"ui-entity-card-common":"ui-entity-card-private",title:l}}));this._configMenuButton=BX.create("span",{props:{className:"ui-entity-settings-link"},text:l,events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}});this._buttonContainer.appendChild(this._configMenuButton)}}this.adjustButtons()},refreshLayout:function(t){var e={edit:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this})};if(!BX.type.isPlainObject(t)){t={}}for(var i=0,n=this._controls.length;i<n;i++){var o=this._controls[i];var s=o.getMode();var r=BX.mergeEx(t,{userFieldLoader:e[BX.UI.EntityEditorMode.getName(s)],enableFocusGain:!this._isEmbedded});o.refreshLayout(r)}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}this.adjustButtons()},switchControlMode:function(t,e,i){if(!this.isModeToggleEnabled()){return}if(e===BX.UI.EntityEditorMode.view){if(t.checkModeOption(BX.UI.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(t,BX.UI.EntityEditorMode.view);this._modeSwitch.run()}else{t.setMode(e,{options:i,notify:true});t.refreshLayout()}}else{if(!BX.UI.EntityEditorModeOptions.check(i,BX.UI.EntityEditorModeOptions.exclusive)){t.setMode(BX.UI.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}else{var n=0;for(var o=0,s=this._activeControls.length;o<s;o++){var r=this._activeControls[o];if(r.checkModeOption(BX.UI.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(r,BX.UI.EntityEditorMode.view,i);n++}}if(n>0){this._modeSwitch.getQueue().add(t,BX.UI.EntityEditorMode.edit,i);this._modeSwitch.run()}else{t.setMode(BX.UI.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}}}},switchToViewMode:function(t){this.releaseActiveControls(t);this.hideToolPanel()},switchTitleMode:function(t){if(t===BX.UI.EntityEditorMode.edit){this._pageTitle.style.display="none";if(this._buttonWrapper){this._buttonWrapper.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:"pagetitle-item",value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._pageTitle);this._pageTitleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(document,"click",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)},this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this._pageTitle.style.display="";if(this._buttonWrapper){this._buttonWrapper.style.display=""}BX.unbind(document,"click",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler);this.adjustTitle()}},adjustTitle:function(){if(!this._enablePageTitleContols){return}if(!this._buttonWrapper){return}var t=this._model.getCaption().trim();var e="";var i=t.match(/\s+\S+\s*$/);if(i){e=t.substr(i["index"]);t=t.substr(0,i["index"])}else{e=t;t=""}BX.cleanNode(this._buttonWrapper);if(e!==""){this._buttonWrapper.appendChild(document.createTextNode(e))}if(this._editPageTitleButton){this._buttonWrapper.appendChild(this._editPageTitleButton)}if(this._copyPageUrlButton){this._buttonWrapper.appendChild(this._copyPageUrlButton)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(t)},adjustSize:function(){if(!this._enablePageTitleContols){return}if(!this._pageTitle){return}var t=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;var e=t.offsetWidth<=480&&this._model.getCaption().length>=40;if(e&&!BX.hasClass(t,"pagetitle-narrow")){BX.addClass(t,"pagetitle-narrow")}else if(!e&&BX.hasClass(t,"pagetitle-narrow")){BX.removeClass(t,"pagetitle-narrow")}},adjustButtons:function(){if(this._config.isScopeToggleEnabled()&&!this._enableBottomPanel&&this._controls.length>0){var t=this._controls[this._controls.length-1];if(t instanceof BX.UI.EntityEditorColumn){if(t._sections.length>0){t=t._sections[t._sections.length-1]}else{return}}t.addButtonElement(BX.create("span",{props:{className:this._config.getScope()===BX.UI.EntityConfigScope.common?"ui-entity-card-common":"ui-entity-card-private"},events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}}),{position:"right"})}},showToolPanel:function(){if(!this._toolPanel||this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px";document.body.style.paddingBottom="60px";document.body.style.height="auto"}},hideToolPanel:function(){if(!this._toolPanel||!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom="";document.body.style.paddingBottom="";document.body.style.height=""}},showMessageDialog:function(t,e,i){var n=BX.UI.EditorAuxiliaryDialog.create(t,{title:e,content:i,buttons:[{id:"continue",type:BX.UI.DialogButtonType.accept,text:BX.message("UI_ENTITY_EDITOR_CONTINUE"),callback:function(t){t.getDialog().close()}}]});n.open()},getMessage:function(t){var e=BX.UI.EntityEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getFormElement:function(){return this._formElement},isChanged:function(){return this._isNew||this.hasChangedControls()||this.hasChangedControllers()},savePageTitle:function(){if(!this._pageTitleInput){return}var t=BX.util.trim(this._pageTitleInput.value);if(t===""){return}this._model.setCaption(t);var e={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this._entityTypeName,PARAMS:BX.prop.getObject(this._context,"PARAMS",{})};this._model.prepareCaptionData(e);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveChanged:function(){if(!this._isNew&&!this.hasChangedControls()&&!this.hasChangedControllers()&&!this.isWaitingForInput()){this._modeSwitch.reset();this.releaseActiveControls();this.refreshLayout({reset:true});this.hideToolPanel();BX.onCustomEvent(window,"BX.UI.EntityEditor:onNothingChanged",[this])}else{this._modeSwitch.reset();this._modeSwitch.getQueue().addBatch(this._activeControls,BX.UI.EntityEditorMode.view);this._modeSwitch.run()}},saveDelayed:function(t){if(typeof t==="undefined"){t=0}if(this._delayedSaveHandle>0){window.clearTimeout(this._delayedSaveHandle)}this._delayedSaveHandle=window.setTimeout(BX.delegate(this.save,this),t)},save:function(){if(this._toolPanel){this._toolPanel.setLocked(true)}var t=BX.UI.EntityValidationResult.create();this.validate(t).then(BX.delegate(function(){if(this._bizprocManager){return this._bizprocManager.onBeforeSave(t)}var e=new BX.Promise;window.setTimeout(function(){e.fulfill()},0);return e},this)).then(BX.delegate(function(){if(t.getStatus()){this.innerSave();if(this._bizprocManager){this._bizprocManager.onAfterSave()}}else{if(this.isVisible()){var e=t.getTopmostField();if(e){e.focus()}}if(this._toolPanel){this._toolPanel.setLocked(false)}BX.onCustomEvent(window,"BX.UI.EntityEditor:onFailedValidation",[this,t])}},this));if(this._delayedSaveHandle>0){this._delayedSaveHandle=0}},saveControl:function(t){if(this._entityId<=0&&this._model.isIdentifiable()){return}var e=BX.UI.EntityValidationResult.create();t.validate(e);if(!e.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this._entityTypeName};i=BX.mergeEx(i,this._context);t.save();t.prepareSaveData(i);for(var n=0,o=this._controllers.length;n<o;n++){i=this._controllers[n].onBeforeSaveControl(i)}BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveData:function(t){if(this._entityId<=0&&this._model.isIdentifiable()){return}t=BX.mergeEx(t,this._context);t=BX.mergeEx(t,{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this._entityTypeName});BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:t,onsuccess:BX.delegate(this.onSaveSuccess,this)})},validate:function(t){for(var e=0,i=this._activeControls.length;e<i;e++){this._activeControls[e].validate(t)}var n=new BX.Promise;this._userFieldManager.validate(t).then(BX.delegate(function(){n.fulfill()},this));return n},isRequestRunning:function(){return this._isRequestRunning},innerSave:function(){if(this._isRequestRunning){return}var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].onBeforeSubmit()}for(t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.save();i.onBeforeSubmit();if(i.isSchemeChanged()){this._config.updateSchemeElement(i.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config&&this._config.isChanged()){this._config.save(false)}var n={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.UI.EntityEditor:onSave",[this,n]);if(n["cancel"]){return}if(this._ajaxForm){var o=this.getDetailManager();if(o){var s=o.prepareAnalyticParams(this._entityId<=0&&this._model.isIdentifiable()?"create":"update",{});if(s){this._ajaxForm.addUrlParams(s)}}this._ajaxForm.submit()}},cancel:function(){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.UI.EntityEditor:onCancel",[this,t]);if(t["cancel"]){return}if(this.hasChangedControls()||this.hasChangedControllers()){window.setTimeout(BX.delegate(this.openCancellationConfirmationDialog,this),250);return}this.innerCancel()},innerCancel:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].innerCancel()}this.rollback();if(this._isNew){this.refreshLayout();if(typeof top.BX.SidePanel!=="undefined"){window.setTimeout(function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){t.close(false)}},250)}}else{this.switchToViewMode({refreshLayout:false});this.refreshLayout()}},openCancellationConfirmationDialog:function(){if(this._confirmationCancelDialog){return}this._confirmationCancelDialog=BX.UI.EditorAuxiliaryDialog.create("cancel_confirmation",{title:BX.message("UI_ENTITY_EDITOR_CONFIRMATION"),content:BX.message("UI_ENTITY_EDITOR_CANCEL_CONFIRMATION"),buttons:[{id:"yes",type:BX.UI.DialogButtonType.accept,text:BX.message("UI_ENTITY_EDITOR_YES"),callback:this._cancelConfirmationHandler},{id:"no",type:BX.UI.DialogButtonType.cancel,text:BX.message("UI_ENTITY_EDITOR_NO"),callback:this._cancelConfirmationHandler}]});this._confirmationCancelDialog.open()},onCancelConfirmButtonClick:function(t){t.getDialog().close();this._confirmationCancelDialog=null;if(t.getId()==="yes"){this.innerCancel()}},rollback:function(){this._model.rollback();var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].rollback()}for(t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}},addSchemeElementAt:function(t,e){if(this._config){this._config.addSchemeElementAt(t,e)}},updateSchemeElement:function(t){if(this._config){this._config.updateSchemeElement(t)}},removeSchemeElement:function(t){if(this._config){this._config.removeSchemeElement(t)}},canChangeScheme:function(){return this._config&&this._config.isChangeable()},isSchemeChanged:function(){return this._config&&this._config.isChanged()},saveScheme:function(){if(!this._config){return false}var t=this._config.save(false);if(t){this.processSchemeChange()}return t},saveSchemeChanges:function(){this.commitSchemeChanges();return this.saveScheme()},commitSchemeChanges:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].commitSchemeChanges()}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}},onSaveSuccess:function(t){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}var e=BX.prop.getObject(t,"EVENT_PARAMS",{});e["entityTypeName"]=this._entityTypeName;if(typeof window.top.BX.Bitrix24!=="undefined"){var i=window.top.BX.Bitrix24.Slider.getTopSlider();if(i){e["sliderUrl"]=i.getUrl()}}var n=BX.prop.getObject(t,"CHECK_ERRORS",null);var o=BX.prop.getString(t,"ERROR","");if(n||o!==""){if(n){var s=null;var r=[];for(var a in n){if(!n.hasOwnProperty(a)){return}var l=this.getActiveControlById(a,true);if(l){l.showError(n[a]);if(!s){s=l}}else{r.push(n[a])}}if(s){s.scrollAnimate()}o=r.join("<br/>")}if(o!==""&&this._toolPanel){this._toolPanel.addError(o)}e["checkErrors"]=n;e["error"]=o;if(this._isNew){BX.onCustomEvent(window,"onEntityCreateError",[e])}else{e["entityId"]=this._entityId;BX.onCustomEvent(window,"onEntityUpdateError",[e])}this.releaseAjaxForm();this.initializeAjaxForm();return}var h=BX.prop.getObject(t,"ENTITY_DATA",null);e["entityData"]=h;if(!this._model.isIdentifiable()){e["sender"]=this;BX.onCustomEvent(window,"onEntityUpdate",[e])}else{if(this._isNew){this._entityId=BX.prop.getInteger(t,"ENTITY_ID",0);if(this._entityId<=0){if(this._toolPanel){this._toolPanel.addError(BX.message("UI_ENTITY_EDITOR_COULD_NOT_FIND_ENTITY_ID"))}return}e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onEntityCreate",[e]);this._isNew=false}else{e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onEntityUpdate",[e])}}var d=BX.prop.getString(t,"REDIRECT_URL","");var c=BX.prop.getObject(t,"EVENT_PARAMS",null);if(c){var u=BX.prop.getString(c,"name","");var _=BX.prop.getObject(c,"args",null);if(u!==""&&_!==null){if(d!==""){_["redirectUrl"]=d}BX.localStorage.set(u,_,10)}}if(this._isReleased){return}if(d!==""){window.location.replace(BX.util.add_url_param(d,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"}))}else{if(BX.type.isPlainObject(h)){this._model.setData(h,{enableNotification:false})}this.adjustTitle();this.adjustSize();this.releaseAjaxForm();this.initializeAjaxForm();for(var f=0,g=this._controllers.length;f<g;f++){this._controllers[f].onAfterSave()}if(this._modeSwitch.isRunning()){this._modeSwitch.complete()}else{this.switchToViewMode({refreshLayout:false})}this.refreshLayout({reset:true});this.hideToolPanel()}},onSaveFailure:function(t){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}var e=BX.prop.getArray(t,"ERRORS",[]);if(this._toolPanel){for(var i=0,n=e.length;i<n;i++){this._toolPanel.addError(e[i])}}},formatMoney:function(t,e,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:e,SUM:t},onsuccess:i})},findOption:function(t,e){for(var i=0,n=e.length;i<n;i++){if(t===e[i].VALUE){return e[i].NAME}}return t},prepareConfigMenuItems:function(){var t=[];var e=BX.delegate(this.onMenuItemClick,this);if(this._config.isScopeToggleEnabled()){var i=this._config.getScope();t.push({id:"switchToPersonalConfig",text:BX.message("UI_ENTITY_EDITOR_SWITCH_TO_PERSONAL_CONFIG"),onclick:e,className:i===BX.UI.EntityConfigScope.personal?"menu-popup-item-accept":"menu-popup-item-none"});t.push({id:"switchToCommonConfig",text:BX.message("UI_ENTITY_EDITOR_SWITCH_TO_COMMON_CONFIG"),onclick:e,className:i===BX.UI.EntityConfigScope.common?"menu-popup-item-accept":"menu-popup-item-none"})}if(this.canChangeScheme()){if(this._config.isScopeToggleEnabled()){t.push({delimiter:true})}t.push({id:"resetConfig",text:BX.message("UI_ENTITY_EDITOR_RESET_CONFIG"),onclick:e,className:"menu-popup-item-none"});if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){t.push({id:"forceCommonConfigForAllUsers",text:BX.message("UI_ENTITY_EDITOR_FORCE_COMMON_CONFIG_FOR_ALL"),onclick:e,className:"menu-popup-item-none"})}}BX.onCustomEvent(window,"BX.UI.EntityEditor:onPrepareConfigMenuItems",[this,t]);return t},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(t,e,i){e["ACTION"]=t;e["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:e,onsuccess:i})},onFormSubmit:function(t,e){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.setLocked(true)}},onResize:function(t){this.adjustSize()},onPageTileClick:function(t){if(this._readOnly){return}if(this.isChanged()){this.showMessageDialog("titleEditDenied",BX.message("UI_ENTITY_EDITOR_TITLE_EDIT"),BX.message("UI_ENTITY_EDITOR_TITLE_EDIT_UNSAVED_CHANGES"));return}this.switchTitleMode(BX.UI.EntityEditorMode.edit)},onCreateSectionButtonClick:function(t){if(!this.isSectionCreationEnabled()){return}var e=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.UI.EntitySchemeElement.create({type:"section",name:i,title:BX.message("UI_ENTITY_EDITOR_NEW_SECTION_TITLE")});var o={schemeElement:n,model:this._model};var s=this.getControlByIndex(0);if(!s){this.addSchemeElementAt(n,e);o.container=this._formElement}var r=this.createControl("section",i,o);if(s){s.addChild(r,{enableSaving:false})}else{this.addControlAt(r,0);this.saveScheme()}r.setMode(BX.UI.EntityEditorMode.edit,{notify:false});r.refreshLayout();r.setTitleMode(BX.UI.EntityEditorMode.edit);this.registerActiveControl(r)},onConfigMenuButtonClick:function(t){if(this._isConfigMenuShown){return}var e=this.prepareConfigMenuItems();if(e.length>0){BX.PopupMenu.show(this._id+"_config_menu",BX.getEventTarget(t),e,{angle:false,autoHide:true,closeByEsc:true,events:{onPopupShow:function(){this._isConfigMenuShown=true}.bind(this),onPopupClose:function(){BX.PopupMenu.destroy(this._id+"_config_menu")}.bind(this),onPopupDestroy:function(){this._isConfigMenuShown=false}.bind(this)}})}},onPageTitleExternalClick:function(t){var e=BX.getEventTarget(t);if(e!==this._pageTitleInput){this.savePageTitle();this.switchTitleMode(BX.UI.EntityEditorMode.view)}},onPageTitleKeyPress:function(t){var e=t.keyCode;if(e===13){this.savePageTitle();this.switchTitleMode(BX.UI.EntityEditorMode.view)}else if(e===27){this.switchTitleMode(BX.UI.EntityEditorMode.view)}},onInterfaceToolbarMenuBuild:function(t,e){var i=BX.prop.getArray(e,"items",null);if(!i){return}var n=this.prepareConfigMenuItems();if(n.length>0){if(i.length>0){i.push({delimiter:true})}for(var o=0,s=n.length;o<s;o++){i.push(n[o])}}},onMenuItemClick:function(t,e){var i=BX.prop.getString(e,"id","");if(i==="resetConfig"){this.resetConfig()}else if(i==="switchToPersonalConfig"){this.setConfigScope(BX.UI.EntityConfigScope.personal)}else if(i==="switchToCommonConfig"){this.setConfigScope(BX.UI.EntityConfigScope.common)}else if(i==="forceCommonConfigForAllUsers"){this.forceCommonConfigScopeForAll()}if(e.menuWindow){e.menuWindow.close()}},setConfigScope:function(t){if(this._config.getScope()===t){return}this._config.setScope(t).then(function(){var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.UI.EntityEditor:onConfigScopeChange",[this,e]);if(e["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},forceCommonConfigScopeForAll:function(){this._config.forceCommonScopeForAll().then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.UI.EntityEditor:onForceCommonConfigScopeForAll",[this,e]);if(e["enableReload"]&&!this._isEmbedded&&t!==BX.UI.EntityConfigScope.common){window.location.reload(true)}}.bind(this))},resetConfig:function(){this._config.reset(false).then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.UI.EntityEditor:onConfigReset",[this,e]);if(e["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},getConfigOption:function(t,e){return this._config.getOption(t,e)},setConfigOption:function(t,e){return this._config.setOption(t,e)},getOption:function(t,e){return BX.prop.getString(this._settings["options"],t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._settings["options"],t,null)===e){return}this._settings["options"][t]=e},getDragConfig:function(t){return BX.prop.getObject(this._dragConfig,t,{})},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(t){var e=this.getControlCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.UI.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:t<e?this._controls[t].getWrapper():null,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(t,e){var i=t.getCharge();if(!(i instanceof BX.UI.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=e.getContextData();var o=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(o!==BX.UI.EditorSectionDragItem.contextId){return}var s=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(s instanceof BX.UI.EditorSectionDragItem)){return}var r=s.getControl();if(!r){return}var a=this.getControlIndex(r);if(a<0){return}var l=this.getPlaceHolder();var h=l?l.getIndex():-1;if(h<0){return}var d=h<=a?h:h-1;if(d!==a){this.moveControl(r,d);this.saveScheme()}},onDrop:function(t){this.processDraggedItemDrop(t.data["dropContainer"],t.data["draggedItem"])},getConfigScope:function(){return this._config.getScope()}};BX.UI.EntityEditor.defaultInstance=null;BX.UI.EntityEditor.items={};BX.UI.EntityEditor.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.UI.EntityEditor.messages==="undefined"){BX.UI.EntityEditor.messages={}}BX.UI.EntityEditor.setDefault=function(t){BX.UI.EntityEditor.defaultInstance=t};BX.UI.EntityEditor.getDefault=function(){return BX.UI.EntityEditor.defaultInstance};BX.UI.EntityEditor.create=function(t,e){var i=new BX.UI.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.UI.EntityEditorModeQueue==="undefined"){BX.UI.EntityEditorModeQueue=function(){this._id="";this._settings={};this._items=[]};BX.UI.EntityEditorModeQueue.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},findIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]["control"]===t){return e}}return-1},getLength:function(){return this._items.length},add:function(t,e,i){if(typeof i==="undefined"){i=BX.UI.EntityEditorModeOptions.none}var n=this.findIndex(t);if(n>=0){this._items[n]={control:t,mode:e,options:i}}else{this._items.push({control:t,mode:e,options:i})}},addBatch:function(t,e,i){for(var n=0,o=t.length;n<o;n++){this.add(t[n],e,i)}},remove:function(t){var e=this.findIndex(t);if(e>=0){this._items.splice(e,1)}},clear:function(){this._items=[]},process:function(){var t=this._items.length;if(t===0){return 0}for(var e=0;e<t;e++){var i=this._items[e];i["control"].setMode(i["mode"],{options:i["options"],notify:true})}return t}};BX.UI.EntityEditorModeQueue.create=function(t,e){var i=new BX.UI.EntityEditorModeQueue;i.initialize(t,e);return i}}if(typeof BX.UI.EntityEditorModeSwitch==="undefined"){BX.UI.EntityEditorModeSwitch=function(){this._id="";this._settings={};this._queue=null;this._isRunning=false;this._runHandle=0};BX.UI.EntityEditorModeSwitch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._queue=BX.UI.EntityEditorModeQueue.create(this._id,{})},getQueue:function(){return this._queue},reset:function(){this._queue.clear();this._isRunning=false},isRunning:function(){return this._isRunning},run:function(){if(this._isRunning){return}if(this._runHandle>0){window.clearTimeout(this._runHandle)}this._runHandle=window.setTimeout(BX.delegate(this.doRun,this),50)},doRun:function(){this._editor.saveDelayed();this._isRunning=true;this._runHandle=0},complete:function(){this._queue.process();this.reset()}};BX.UI.EntityEditorModeSwitch.create=function(t,e){var i=new BX.UI.EntityEditorModeSwitch;i.initialize(t,e);return i}}
//# sourceMappingURL=editor.map.js