{"version":3,"file":"crm.form.bundle.js","sources":["../src/crm.form.js"],"sourcesContent":["import {Vue} from 'ui.vue';\nimport 'main.polyfill.promise';\nimport './crm.form.css';\n\nlet loadAppPromise = null;\n\nVue.component('bx-crm-form', {\n\tprops: {\n\t\tid: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tsec: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tlang: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t\tdefault: 'en',\n\t\t},\n\t\taddress: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t\tdefault: function () {\n\t\t\t\treturn window.location.origin;\n\t\t\t},\n\t\t},\n\t\tdesign: {\n\t\t\ttype: Object,\n\t\t\trequired: false,\n\t\t\tdefault: function () {\n\t\t\t\treturn {\n\t\t\t\t\tcompact: true,\n\t\t\t\t};\n\t\t\t},\n\t\t},\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tmessage: '',\n\t\t\tisLoading: false,\n\t\t\tobj: {\n\n\t\t\t},\n\t\t}\n\t},\n\tbeforeDestroy()\n\t{\n\t\tif (this.obj.instance)\n\t\t{\n\t\t\tthis.obj.instance.destroy();\n\t\t}\n\t},\n\tmounted()\n\t{\n\t\tconst loadForm = () => {\n\t\t\tthis.isLoading = false;\n\t\t\tthis.message = '';\n\t\t\tthis.obj.config.data.node = this.$el;\n\t\t\tthis.obj.config.data.design = {\n\t\t\t\t...this.obj.config.data.design,\n\t\t\t\t...this.design\n\t\t\t};\n\t\t\tthis.obj.instance = window.b24form.App.createForm24(\n\t\t\t\tthis.obj.config,\n\t\t\t\tthis.obj.config.data\n\t\t\t);\n\t\t\tthis.obj.instance.subscribeAll((data, instance, type) => {\n\t\t\t\tdata = data || {};\n\t\t\t\tdata.form = instance;\n\t\t\t\tthis.$emit('form:' + type, data);\n\t\t\t})\n\t\t};\n\n\t\tthis.isLoading = true;\n\t\tlet promise = null;\n\t\tif (window.fetch)\n\t\t{\n\t\t\tconst formData = new FormData();\n\t\t\tformData.append('id', this.id);\n\t\t\tformData.append('sec', this.sec);\n\t\t\tpromise = fetch(\n\t\t\t\tthis.address + `/bitrix/services/main/ajax.php?action=crm.site.form.get`,\n\t\t\t\t{\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tbody: formData,\n\t\t\t\t\tmode: \"cors\",\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.message = 'error';\n\t\t\treturn;\n\t\t}\n\n\t\tpromise.then(response => response.json())\n\t\t\t.then(data => {\n\t\t\t\tif (data.error)\n\t\t\t\t{\n\t\t\t\t\tthrow new Error(data.error_description)\n\t\t\t\t}\n\t\t\t\tthis.obj.config = data.result.config;\n\n\t\t\t\tif (window.b24form && window.b24form.App)\n\t\t\t\t{\n\t\t\t\t\tloadForm();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!loadAppPromise)\n\t\t\t\t{\n\t\t\t\t\tloadAppPromise = new Promise((resolve, reject) => {\n\t\t\t\t\t\tlet checker = () => {\n\t\t\t\t\t\t\tif (!window.b24form || !window.b24form || !window.b24form.App)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tsetTimeout(checker, 200);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst node = document.createElement('script');\n\t\t\t\t\t\tnode.src = data.result.loader.app.link;\n\t\t\t\t\t\tnode.onload = checker;\n\t\t\t\t\t\tnode.onerror = reject;\n\t\t\t\t\t\tdocument.head.appendChild(node);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tloadAppPromise.then(loadForm).catch((e) => {\n\t\t\t\t\tthis.message = 'App load failed:' + e;\n\t\t\t\t});\n\n\t\t\t}).catch(error => {\n\t\t\tthis.isLoading = false;\n\t\t\tthis.message = error;\n\t\t});\n\t},\n\ttemplate: `\n\t\t<div>\n\t\t\t<div v-if=\"isLoading\" class=\"ui-vue-crm-form-loading-container\"></div>\n\t\t\t<div v-else-if=\"message\">{{ message }}</div>\n\t\t</div>\n\t`\n});"],"names":["loadAppPromise","Vue","component","props","id","type","String","required","sec","lang","address","window","location","origin","design","Object","compact","data","message","isLoading","obj","beforeDestroy","instance","destroy","mounted","loadForm","config","node","$el","b24form","App","createForm24","subscribeAll","form","$emit","promise","fetch","formData","FormData","append","method","body","mode","then","response","json","error","Error","error_description","result","Promise","resolve","reject","checker","setTimeout","document","createElement","src","loader","app","link","onload","onerror","head","appendChild","e","template"],"mappings":"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"}