{"version":3,"file":"smiles.bundle.js","sources":["../src/manager.js","../src/smiles.js"],"sourcesContent":["import {Dexie} from \"ui.dexie\";\n\nexport class SmileManager\n{\n\tconstructor(restClient)\n\t{\n\t\tif (typeof restClient !== 'undefined')\n\t\t{\n\t\t\tthis.restClient = restClient;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.restClient = new BX.RestClient();\n\t\t}\n\n\t\tthis.db = new Dexie('bx-ui-smiles');\n\t\tthis.db.version(1).stores({\n\t\t\tsets: \"id, parentId, name, type, image\",\n\t\t\tsmiles: \"id, setId, name, image, typing, width, height, originalWidth, originalHeight, definition\",\n\t\t});\n\t}\n\n\tloadFromCache()\n\t{\n\t\tlet promise = new BX.Promise();\n\n\t\tlet sets = [];\n\t\tlet smiles = [];\n\n\t\tlet timer = new Date();\n\n\t\tthis.db.transaction('r', this.db.sets, this.db.smiles, () =>\n\t\t{\n\t\t\tthis.db.sets.each(set => {\n\t\t\t\treturn this.db.smiles.where('setId').equals(set.id).first().then(smile => {\n\t\t\t\t\tsets.push({...set, image: smile.image});\n\t\t\t\t}).catch(error => promise.reject(error));\n\t\t\t}).then(() => {\n\t\t\t\treturn this.db.smiles.where('setId').equals(sets[0].id).each(smile => {\n\t\t\t\t\tsmiles.push(smile);\n\t\t\t\t});\n\t\t\t}).then(() => {\n\t\t\t\tlet promiseResult = {sets, smiles};\n\t\t\t\tpromise.resolve(promiseResult);\n\t\t\t}).catch(error => promise.reject(error));\n\t\t});\n\n\t\treturn promise;\n\t}\n\n\tloadFromServer()\n\t{\n\t\tlet promise = new BX.Promise();\n\t\tlet timer = new Date();\n\n\t\tthis.restClient.callMethod('smile.get').then(result =>\n\t\t{\n\t\t\tlet sets = [];\n\t\t\tlet smiles = [];\n\n\t\t\tlet answer = result.data();\n\n\t\t\tlet setImage = {};\n\n\t\t\tanswer.smiles = answer.smiles.map(function(smile){\n\t\t\t\tif (!setImage[smile.setId])\n\t\t\t\t{\n\t\t\t\t\tsetImage[smile.setId] = smile.image;\n\t\t\t\t}\n\n\t\t\t\tlet originalWidth = smile.width;\n\t\t\t\tif (smile.definition == 'HD')\n\t\t\t\t{\n\t\t\t\t\toriginalWidth = originalWidth*2;\n\t\t\t\t}\n\t\t\t\telse if (smile.definition == 'UHD')\n\t\t\t\t{\n\t\t\t\t\toriginalWidth = originalWidth*4;\n\t\t\t\t}\n\n\t\t\t\tlet originalHeight = smile.height;\n\t\t\t\tif (smile.definition == 'HD')\n\t\t\t\t{\n\t\t\t\t\toriginalHeight = originalHeight*2;\n\t\t\t\t}\n\t\t\t\telse if (smile.definition == 'UHD')\n\t\t\t\t{\n\t\t\t\t\toriginalHeight = originalHeight*4;\n\t\t\t\t}\n\n\t\t\t\treturn {...smile, originalWidth, originalHeight}\n\t\t\t});\n\n\t\t\tanswer.sets.forEach(set => {\n\t\t\t\tsets.push({...set, image: setImage[set.id]});\n\t\t\t});\n\n\t\t\tanswer.smiles.forEach(smile => {\n\t\t\t\tif (smile.setId == sets[0].id)\n\t\t\t\t{\n\t\t\t\t\tsmiles.push(smile);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tlet promiseResult = {sets, smiles};\n\n\t\t\tpromise.resolve(promiseResult);\n\n\t\t\tthis.db.smiles.clear().then(() => {\n\t\t\t\treturn this.db.sets.clear().then(() => {\n\t\t\t\t\tthis.db.sets.bulkAdd(sets);\n\t\t\t\t\tthis.db.smiles.bulkAdd(answer.smiles);\n\t\t\t\t}).catch(error => promise.reject(error));\n\t\t\t}).catch(error => promise.reject(error));\n\n\t\t}).catch(error => promise.reject(error));\n\n\t\treturn promise;\n\t}\n\n\tchangeSet(setId)\n\t{\n\t\tlet promise = new BX.Promise();\n\n\t\tthis.db.smiles.where('setId').equals(setId).toArray(smiles => {\n\t\t\tpromise.resolve(smiles);\n\t\t}).catch(error => promise.reject(error));\n\n\t\treturn promise;\n\t}\n}\n\n","/**\n * Bitrix UI\n * Smiles Vue component\n *\n * @package bitrix\n * @subpackage ui\n * @copyright 2001-2019 Bitrix\n */\n\nimport \"./smiles.css\";\nimport 'ui.vue.directives.lazyload';\n\nimport {SmileManager} from \"./manager.js\";\nimport {Vue} from 'ui.vue';\nimport {rest} from 'rest.client';\n\nVue.component('bx-smiles', {\n\t/**\n\t * @emits 'selectSmile' {text: string}\n\t * @emits 'selectSet' {setId: number}\n\t */\n\tdata()\n\t{\n\t\treturn {\n\t\t\tsmiles: [],\n\t\t\tsets: []\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tthis.setSelected = 0;\n\t\tthis.serverLoad = false;\n\n\t\tlet restClient = this.$root.$bitrixRestClient || rest;\n\n\t\tthis.smilesController = new SmileManager(restClient);\n\t\tthis.smilesController.loadFromCache().then((result) => {\n\t\t\tif (this.serverLoad)\n\t\t\t\treturn true;\n\n\t\t\tthis.smiles = result.smiles;\n\t\t\tthis.sets = result.sets.map((element, index) => {\n\t\t\t\telement.selected = this.setSelected === index;\n\t\t\t\treturn element;\n\t\t\t});\n\t\t});\n\n\t\tthis.smilesController.loadFromServer().then((result) => {\n\t\t\tthis.smiles = result.smiles;\n\t\t\tthis.sets = result.sets.map((element, index) => {\n\t\t\t\telement.selected = this.setSelected === index;\n\t\t\t\treturn element;\n\t\t\t});\n\t\t})\n\t},\n\tmethods:\n\t{\n\t\tselectSet(setId)\n\t\t{\n\t\t\tthis.$emit('selectSet', {setId});\n\n\t\t\tthis.smilesController.changeSet(setId).then((result) => {\n\t\t\t\tthis.smiles = result;\n\t\t\t\tthis.sets.map(set => {\n\t\t\t\t\tset.selected = set.id === setId;\n\t\t\t\t\tif (set.selected)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.setSelected = setId;\n\t\t\t\t\t}\n\t\t\t\t\treturn set;\n\t\t\t\t});\n\t\t\t\tthis.$refs.elements.scrollTop = 0;\n\t\t\t});\n\t\t},\n\t\tselectSmile(text)\n\t\t{\n\t\t\tthis.$emit('selectSmile', {text: ' '+text+' '});\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-ui-smiles-box\">\n\t\t\t<div class=\"bx-ui-smiles-elements-wrap\" ref=\"elements\">\n\t\t\t\t<template v-if=\"!smiles.length\">\n\t\t\t\t\t<svg class=\"bx-ui-smiles-loading-circular\" viewBox=\"25 25 50 50\">\n\t\t\t\t\t\t<circle class=\"bx-ui-smiles-loading-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\n\t\t\t\t\t\t<circle class=\"bx-ui-smiles-loading-inner-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</template>\n\t\t\t\t<template v-else v-for=\"smile in smiles\">\n\t\t\t\t\t<div class=\"bx-ui-smiles-smile\">\n\t\t\t\t\t\t<img v-bx-lazyload :key=\"smile.id\"\n\t\t\t\t\t\t\tclass=\"bx-ui-smiles-smile-icon\"\n\t\t\t\t\t\t\t:data-lazyload-src=\"smile.image\"\n\t\t\t\t\t\t\tdata-lazyload-error-class=\"bx-ui-smiles-smile-icon-error\"\n\t\t\t\t\t\t\t:title=\"smile.name\"\n\t\t\t\t\t\t\t:style=\"{height: (smile.originalHeight*0.5)+'px', width: (smile.originalWidth*0.5)+'px'}\"\n\t\t\t\t\t\t\t@click=\"selectSmile(smile.typing)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t\t<template v-if=\"sets.length > 1\">\n\t\t\t\t<div class=\"bx-ui-smiles-sets\">\n\t\t\t\t\t<template v-for=\"set in sets\">\n\t\t\t\t\t\t<div :class=\"['bx-ui-smiles-set', {'bx-ui-smiles-set-selected': set.selected}]\">\n\t\t\t\t\t\t\t<img v-bx-lazyload :key=\"set.id\"\n\t\t\t\t\t\t\t\tclass=\"bx-ui-smiles-set-icon\"\n\t\t\t\t\t\t\t\t:data-lazyload-src=\"set.image\"\n\t\t\t\t\t\t\t\tdata-lazyload-error-class=\"bx-ui-smiles-set-icon-error\"\n\t\t\t\t\t\t\t\t:title=\"set.name\"\n\t\t\t\t\t\t\t\t@click=\"selectSet(set.id)\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`\n});"],"names":["SmileManager","restClient","BX","RestClient","db","Dexie","version","stores","sets","smiles","promise","Promise","transaction","each","set","where","equals","id","first","then","smile","push","image","catch","error","reject","promiseResult","resolve","callMethod","result","answer","data","setImage","map","setId","originalWidth","width","definition","originalHeight","height","forEach","clear","bulkAdd","toArray","Vue","component","created","setSelected","serverLoad","$root","$bitrixRestClient","rest","smilesController","loadFromCache","element","index","selected","loadFromServer","methods","selectSet","$emit","changeSet","$refs","elements","scrollTop","selectSmile","text","template"],"mappings":"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"}