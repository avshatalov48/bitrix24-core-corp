this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(t,e,i,s,r,o,n,a,l){"use strict";const u={LARGE:"large",MEDIUM:"medium",SMALL:"small",TINY:"tiny"};const d={[u.LARGE]:{width:46,lineSize:5},[u.MEDIUM]:{width:34,lineSize:4},[u.SMALL]:{width:20,lineSize:3},[u.TINY]:{width:14,lineSize:2}};const p=a.BitrixVue.localComponent("ui.uploader.stack-widget.stack-upload",{components:{UploadLoader:o.UploadLoader},props:{items:{type:Array,required:true},queueItems:{type:Array,required:true}},computed:{StackWidgetSize:()=>u,uploadFileTitle(){if(this.queueItems.length>1){return n.Loc.getMessage("STACK_WIDGET_FILES_UPLOADING")}else{return n.Loc.getMessage("STACK_WIDGET_FILE_UPLOADING")}},progress(){if(this.queueItems.length===0){return 0}const t=this.queueItems.reduce(((t,e)=>t+e.progress),0);return Math.floor(t/this.queueItems.length)},progressOptions(){const{width:t,lineSize:e}=d[this.$root.widget.size];return{width:t,lineSize:e,progress:Math.max(this.progress,10)}}},template:`\n\t\t<div class="ui-uploader-stack-upload" @click="$emit('showPopup')">\n\t\t\t<div class="ui-uploader-stack-upload-box">\n\t\t\t\t<div \n\t\t\t\t\tclass="ui-uploader-stack-upload-abort" \n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('STACK_WIDGET_ABORT_UPLOAD')"\n\t\t\t\t\t@click.stop="$emit('abortUpload')"\n\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-uploader-stack-upload-content">\n\t\t\t\t\t<div class="ui-uploader-stack-upload-loader">\n\t\t\t\t\t\t<UploadLoader v-bind="progressOptions" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-uploader-stack-upload-progress">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="$root.widget.size === StackWidgetSize.LARGE"\n\t\t\t\t\t\t\tclass="ui-uploader-stack-upload-title"\n\t\t\t\t\t\t>{{ uploadFileTitle }}</div>\n\t\t\t\t\t\t<div class="ui-uploader-stack-upload-percent">{{ progress }}%</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="queueItems.length === 1 && $root.widget.size === StackWidgetSize.LARGE"\n\t\t\t\t\t\t\tclass="ui-uploader-stack-upload-stats"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class="ui-uploader-stack-upload-total">{{\n\t\t\t\t\t\t\t\tqueueItems.length ? queueItems[0].sizeFormatted : ''\n\t\t\t\t\t\t\t}}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="ui-uploader-stack-upload-menu"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('STACK_WIDGET_OPEN_FILE_GALLERY')"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`});const c=a.BitrixVue.localComponent("ui.uploader.stack-widget.stack-load",{template:`\n\t\t<div class="ui-uploader-stack-load" @click="$emit('showPopup')">\n\t\t\t<div class="ui-uploader-stack-load-icon"></div>\n\t\t</div>\n\t`});const m={[u.LARGE]:36,[u.MEDIUM]:27,[u.SMALL]:19,[u.TINY]:15};const g=a.BitrixVue.localComponent("ui.uploader.stack-widget.stack-preview",{components:{FileIcon:o.FileIcon},props:{items:{type:Array,required:true}},data(){return{menu:null}},computed:{FileStatus:()=>r.FileStatus,Sizes:()=>u,item(){const t=this.items.find((t=>t.status!==r.FileStatus.LOAD_FAILED||t.status!==r.FileStatus.UPLOAD_FAILED));return t||{}},fileIconSize(){return m[this.$root.widget.size]},errorsCount(){return this.items.reduce(((t,e)=>{if(e.status===r.FileStatus.LOAD_FAILED||e.status===r.FileStatus.UPLOAD_FAILED){return t+1}else{return t}}),0)}},template:`\n\t\t<div class="ui-uploader-stack-preview" :class="{'--image': item.isImage}" @click="$emit('showPopup')">\n\t\t\t<div class="ui-uploader-stack-preview-box">\n\t\t\t\t<template v-if="item.failed">\n\t\t\t\t\t<div class="ui-uploader-stack-preview-error"></div>\n\t\t\t\t</template>\n\t\t\t\t<template v-else-if="item.isImage">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="ui-uploader-stack-preview-image"\n\t\t\t\t\t\t:class="{ '--default': item.previewUrl === null }"\n\t\t\t\t\t\t:style="{ backgroundImage: item.previewUrl !== null ? 'url(' + item.previewUrl + ')' : '' }">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-if="items.length > 1" class="ui-uploader-stack-preview-stats">\n\t\t\t\t\t\t<span class="ui-uploader-stack-preview-total">{{ items.length }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<template v-if="item.name && item.status !== FileStatus.LOADING">\n\t\t\t\t\t\t<div class="ui-uploader-stack-preview-file-icon">\n\t\t\t\t\t\t\t<FileIcon :name="item.extension" :size="fileIconSize"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="[Sizes.LARGE, Sizes.MEDIUM].includes($root.widget.size)"\n\t\t\t\t\t\t\t:title="item.originalName"\n\t\t\t\t\t\t\tclass="ui-uploader-stack-preview-file-name"\n\t\t\t\t\t\t>{{\n\t\t\t\t\t\t\titems.length > 1\n\t\t\t\t\t\t\t? this.$Bitrix.Loc.getMessage('STACK_WIDGET_FILE_COUNT', { '#count#': items.length })\n\t\t\t\t\t\t\t: item.originalName\n\t\t\t\t\t\t}}</div>\n\t\t\t\t\t\t<div \n\t\t\t\t\t\t\tv-if="items.length > 1 && [Sizes.SMALL, Sizes.TINY].includes($root.widget.size)"\n\t\t\t\t\t\t\tclass="ui-uploader-stack-preview-stats">\n\t\t\t\t\t\t\t<span class="ui-uploader-stack-preview-total">{{ items.length }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<div class="ui-uploader-stack-preview-file-default"></div>\n\t\t\t\t\t</template>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="ui-uploader-stack-upload-menu"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('STACK_WIDGET_OPEN_FILE_GALLERY')"\n\t\t\t></div>\n\t\t</div>\n\t`});const h=a.BitrixVue.localComponent("ui.uploader.stack-widget.stack-drop-area",{data(){return{isHovering:false}},computed:{StackWidgetSize:()=>l.StackWidgetSize,uploadFileTitle(){if(this.$root.acceptOnlyImages){if(this.$root.multiple){return n.Loc.getMessage("STACK_WIDGET_UPLOAD_IMAGES")}else{return n.Loc.getMessage("STACK_WIDGET_UPLOAD_IMAGE")}}else{if(this.$root.multiple){return n.Loc.getMessage("STACK_WIDGET_UPLOAD_FILES")}else{return n.Loc.getMessage("STACK_WIDGET_UPLOAD_FILE")}}},dragFileHint(){if(this.$root.multiple){return n.Loc.getMessage("STACK_WIDGET_DRAG_FILES_HINT")}else{return n.Loc.getMessage("STACK_WIDGET_DRAG_FILE_HINT")}}},mounted(){this.$root.getUploader().assignDropzone(this.$refs.container);this.$root.getUploader().assignBrowse(this.$refs.container)},template:`\n\t\t<div\n\t\t\tclass="ui-uploader-stack-drop-area"\n\t\t\tref="container"\n\t\t\t:class="{ '--hover': isHovering }"\n\t\t\t@mouseenter="isHovering = true"\n\t\t\t@mouseleave="isHovering = false"\n\t\t\t@dragleave="isHovering = false"\n\t\t>\n\t\t\t<div class="ui-uploader-stack-drop-area-content">\n\t\t\t\t<div class="ui-uploader-stack-drop-area-icon"></div>\n\t\t\t\t<div\n\t\t\t\t\tv-if="[StackWidgetSize.LARGE, StackWidgetSize.MEDIUM].includes($root.widget.size)"\n\t\t\t\t\tclass="ui-uploader-stack-drop-area-title"\n\t\t\t\t>{{ uploadFileTitle }}</div>\n\t\t\t\t<div\n\t\t\t\t\tv-if="$root.widget.size === StackWidgetSize.LARGE"\n\t\t\t\t\tclass="ui-uploader-stack-drop-area-hint"\n\t\t\t\t>{{ dragFileHint }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`});const v=t=>t.status===r.FileStatus.LOADING;const I=a.BitrixVue.localComponent("ui.uploader.stack-widget",{components:{TileList:o.TileList,ErrorPopup:o.ErrorPopup,StackUpload:p,StackLoad:c,StackPreview:g,StackDropArea:h,MountingPortal:s.MountingPortal},mixins:[o.DragOverMixin],props:{items:{type:Array,default:[]}},data(){return{popup:null,popupContentId:"",queueItems:[],enableAnimation:true,dragMode:false,uploaderError:null}},computed:{containerClasses(){return[{"--multiple":this.$root.multiple,"--only-images":this.$root.acceptOnlyImages,"--many-items":this.items.length>1},`--${this.$root.widget.size}`]},currentComponent(){if(this.items.length===0||this.dragOver){if(this.dragOver){this.dragMode=true}return h}if(this.queueItems.length>0){return p}if(this.items.some(v)){return c}return g},currentComponentProps(){if(this.currentComponent===h||this.currentComponent===c){return{}}else if(this.currentComponent===p){return{items:this.items,queueItems:this.queueItems}}else if(this.currentComponent===g){return{items:this.items}}},error(){if(this.uploaderError){return this.uploaderError}else if(this.errorsCount>0){return n.Loc.getMessage("STACK_WIDGET_FILE_UPLOAD_ERROR")}return null},errorsCount(){return this.items.reduce(((t,e)=>{if(e.status===r.FileStatus.LOAD_FAILED||e.status===r.FileStatus.UPLOAD_FAILED){return t+1}else{return t}}),0)},errorPopupOptions(){return{bindElement:this.$refs.item,bindOptions:{position:"top"},darkMode:true,offsetTop:3,background:"#d2000d",contentBackground:"transparent",contentColor:"white",padding:this.uploaderError===null?10:20,closeIcon:this.uploaderError!==null}}},watch:{currentComponent(t,e){if(this.dragOver){this.enableAnimation=false}else if(e===h&&this.dragMode){this.enableAnimation=false}else if(e===g){this.enableAnimation=false}else{this.dragMode=false;this.enableAnimation=true}},items(){if(this.items.length===0&&this.popup){this.popup.close()}}},created(){this.$Bitrix.eventEmitter.subscribe("Uploader:onUploadStart",(()=>{this.items.forEach((t=>{if(t.origin===r.FileOrigin.CLIENT&&t.queued!==true){t.queued=true;this.queueItems.push(t)}}))}));this.$Bitrix.eventEmitter.subscribe("Uploader:onUploadComplete",(()=>{this.queueItems=[]}));this.$Bitrix.eventEmitter.subscribe("Item:onAdd",(t=>{this.uploaderError=null;if(this.$root.getUploader().getStatus()===r.UploaderStatus.STARTED){const e=t.getData().item;e.queued=true;this.queueItems.push(t.getData().item)}}));this.$Bitrix.eventEmitter.subscribe("Item:onRemove",(t=>{this.uploaderError=null;const e=t.getData().item;const i=this.queueItems.indexOf(e);if(i>=0){this.queueItems.splice(i,1)}}));this.$Bitrix.eventEmitter.subscribe("Uploader:onError",(t=>{this.uploaderError=t.getData().error}))},mounted(){this.$root.getUploader().assignBrowse(this.$refs["add-button"])},methods:{showPopup(){if(!this.popup){const t="stack-uploader-"+n.Text.getRandom().toLowerCase();const s=new e.Popup({width:750,height:400,draggable:true,titleBar:n.Loc.getMessage("STACK_WIDGET_POPUP_TITLE"),content:`<div id="${t}"></div>`,cacheable:false,closeIcon:true,closeByEsc:true,resizable:true,minWidth:450,minHeight:300,events:{onDestroy:()=>this.popup=null},buttons:[new i.CloseButton({onclick:()=>this.popup.close()})]});this.popupContentId=`#${t}`;this.popup=s}this.popup.show()},abortUpload(){const t=Array.from(this.queueItems);this.queueItems=[];t.forEach((t=>{this.$root.getWidget().remove(t.id)}))},handlePopupDestroy(t){if(this.uploaderError===t){this.uploaderError=null}}},template:`\n\t\t<div class="ui-uploader-stack-widget" :class="containerClasses" v-drop>\n\t\t\t<mounting-portal v-if="popup" :mount-to="popupContentId" append>\n\t\t\t\t<TileList :items="items" />\n\t\t\t</mounting-portal>\n\t\t\t<div class="ui-uploader-stack-item" ref="item">\n\t\t\t\t<transition name="ui-uploader-stack-item" mode="out-in" :css="enableAnimation">\n\t\t\t\t\t<keep-alive>\n\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t:is="currentComponent"\n\t\t\t\t\t\t\tv-bind="currentComponentProps"\n\t\t\t\t\t\t\t@showPopup="showPopup"\n\t\t\t\t\t\t\t@abortUpload="abortUpload"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</keep-alive>\n\t\t\t\t</transition>\n\t\t\t</div>\n\t\t\t<div v-if="$root.multiple" ref="add-button" class="ui-uploader-stack-add-btn"></div>\n\t\t\t<ErrorPopup\n\t\t\t\tv-if="error !== null"\n\t\t\t\t:error="error"\n\t\t\t\t:popup-options="errorPopupOptions"\n\t\t\t\t@onDestroy="handlePopupDestroy"\n\t\t\t/>\n\t\t</div>\n\t`});class E extends r.VueUploader{constructor(t,e){const i=n.Type.isPlainObject(e)?Object.assign({},e):{};const s=Object.values(u).includes(i.size)?i.size:u.MEDIUM;const r={data(){return{widget:{size:s}}}};super(t,r)}getRootComponentId(){return I}}t.StackWidget=E;t.StackWidgetSize=u})(this.BX.UI.Uploader=this.BX.UI.Uploader||{},BX.Main,BX.UI,BX.Vue,BX.UI.Uploader,BX.UI.Uploader,BX,BX,BX.UI.Uploader);
//# sourceMappingURL=ui.uploader.stack-widget.bundle.map.js