this.BX=this.BX||{};(function(e,t,i){"use strict";let s=e=>e,a,l;class o{constructor({id:e,name:t,color:i,backgroundColor:s,isFilled:a,events:l,isSuccess:o,isFail:n,fillingColor:r}){this.backgroundImage="url('data:image/svg+xml;charset=UTF-8,%3csvg width=%27295%27 height=%2732%27 viewBox=%270 0 295 32%27 fill=%27none%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cmask id=%27mask0_2_11%27 style=%27mask-type:alpha%27 maskUnits=%27userSpaceOnUse%27 x=%270%27 y=%270%27 width=%27295%27 height=%2732%27%3e%3cpath fill=%27#COLOR2#%27 d=%27M0 2.9961C0 1.3414 1.33554 0 2.99805 0L285.905 7.15256e-07C287.561 7.15256e-07 289.366 1.25757 289.937 2.80757L295 16.5505L290.007 29.2022C289.397 30.7474 287.567 32 285.905 32H2.99805C1.34227 32 0 30.6657 0 29.0039V2.9961Z%27/%3e%3c/mask%3e%3cg mask=%27url(%23mask0_2_11)%27%3e%3cpath fill=%27#COLOR2#%27 d=%27M0 2.9961C0 1.3414 1.33554 0 2.99805 0L285.905 7.15256e-07C287.561 7.15256e-07 289.366 1.25757 289.937 2.80757L295 16.5505L290.007 29.2022C289.397 30.7474 287.567 32 285.905 32H2.99805C1.34227 32 0 30.6657 0 29.0039V2.9961Z%27/%3e%3cpath d=%27M0 30H295V32H0V30Z%27 fill=%27#COLOR1#%27/%3e%3c/g%3e%3c/svg%3e') 3 10 3 3 fill repeat";this.id=e;this.name=t;this.color=i;this.backgroundColor=s;this.isFilled=a;this.events=l;this.success=o;this.fail=n;this.fillingColor=r}static create(e){if(t.Type.isPlainObject(e)&&e.id&&e.name&&e.color&&e.backgroundColor){e.id=t.Text.toInteger(e.id);e.name=e.name.toString();e.color=e.color.toString();e.backgroundColor=e.backgroundColor.toString();if(!t.Type.isPlainObject(e.events)){e.events={}}if(!t.Type.isBoolean(e.isFilled)){e.isFilled=false}if(e.id>0){return new o(e)}}return null}getId(){return this.id}getName(){return this.name}setName(e){this.name=e;if(this.textNode){this.textNode.innerText=this.name}return this}isSuccess(){return this.success===true}isFail(){return this.fail===true}isFinal(){return this.isFail()||this.isSuccess()}getColor(){return this.color}setColor(e){this.color=e;return this}render(){if(this.node){this.textNode.style.backgroundImage=this.getBackgroundImage()}else{this.textNode=t.Tag.render(a||(a=s`<div style="border-image: ${0};" class="ui-stageflow-stage-item-text">${0}</div>`),this.getBackgroundImage(),t.Text.encode(this.getName()));this.node=t.Tag.render(l||(l=s`<div 
					class="ui-stageflow-stage" 
					data-stage-id="${0}" 
					onmouseenter="${0}" 
					onmouseleave="${0}"
					onclick="${0}"
				>
				<div class="ui-stageflow-stage-item">
					${0}
				</div>
			</div>`),this.getId(),this.onMouseEnter.bind(this),this.onMouseLeave.bind(this),this.onClick.bind(this),this.textNode)}this.textNode.style.color=o.calculateTextColor("#"+(this.isFilled?this.color:this.backgroundColor));return this.node}getBackgroundImage(e=null,i=null){if(!e){if(this.isFilled&&this.fillingColor){e=this.fillingColor}else{e=this.getColor()}}if(t.Type.isNull(i)){i=this.isFilled}let s=this.backgroundImage.replaceAll("#COLOR1#",encodeURIComponent("#"+e));if(i){s=s.replaceAll("#COLOR2#",encodeURIComponent("#"+e))}else{s=s.replaceAll("#COLOR2#",encodeURIComponent("#"+this.backgroundColor))}return s}onMouseEnter(){if(t.Type.isFunction(this.events.onMouseEnter)){this.events.onMouseEnter(this)}}onMouseLeave(){if(t.Type.isFunction(this.events.onMouseLeave)){this.events.onMouseLeave(this)}}onClick(){if(t.Type.isFunction(this.events.onClick)){this.events.onClick(this)}}addBackLight(e){if(this.textNode){this.textNode.style.borderImage=this.getBackgroundImage(e,true);this.textNode.style.color=o.calculateTextColor("#"+e)}}removeBackLight(){if(this.textNode){this.textNode.style.borderImage=this.getBackgroundImage();this.textNode.style.color=o.calculateTextColor("#"+(this.isFilled?this.fillingColor:this.backgroundColor))}}getMinWidthForFullNameVisibility(){if(!this.textNode){return 0}const{clientWidth:e,offsetWidth:t,scrollWidth:i}=this.textNode;return i+(t-e)+2}isNameCropped(){if(!this.textNode){return false}return this.textNode.offsetWidth<this.textNode.scrollWidth}static calculateTextColor(e){var t,i,s;if(e.length>7&&e.indexOf("(")>=0&&e.indexOf(")")>=0){var a=e.split("(")[1].split(")")[0];a=a.split(",");t=parseInt(a[0]);i=parseInt(a[1]);s=parseInt(a[2])}else{if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(e)){var l=e.substring(1).split("");if(l.length===3){l=[l[0],l[0],l[1],l[1],l[2],l[2]]}l="0x"+l.join("");t=l>>16&255;i=l>>8&255;s=l&255}}var o=.21*t+.72*i+.07*s;return o<145?"#fff":"#333"}}let n=e=>e,r,g,c,h,u,d;const S="ui-stageflow-select-semantic-popup";const f="ui-stageflow-select-final-stage-popup";const p={id:"final",color:"7BD500",isFilled:false};const m={finalStageName:t.Loc.getMessage("UI_STAGEFLOW_FINAL_STAGE_NAME"),finalStagePopupTitle:t.Loc.getMessage("UI_STAGEFLOW_FINAL_STAGE_POPUP_TITLE"),finalStagePopupFail:t.Loc.getMessage("UI_STAGEFLOW_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:t.Loc.getMessage("UI_STAGEFLOW_FINAL_STAGE_SELECTOR_TITLE")};class C{constructor(e,i=[]){this.currentStage=0;this.isActive=false;this.labels=m;if(t.Type.isPlainObject(e)){if(t.Type.isString(e.backgroundColor)&&e.backgroundColor.length===6){this.backgroundColor=e.backgroundColor}if(e.currentStage){this.currentStage=t.Text.toInteger(e.currentStage)}if(t.Type.isBoolean(e.isActive)){this.isActive=e.isActive}if(t.Type.isFunction(e.onStageChange)){this.onStageChange=e.onStageChange}if(t.Type.isPlainObject(e.labels)){this.labels={...this.labels,...e.labels}}}p.name=this.labels.finalStageName;if(t.Type.isArray(i)){let e=null;if(this.currentStage>0){i.forEach((i=>{if(t.Text.toInteger(i.id)===t.Text.toInteger(this.currentStage)){e=i.color}}))}this.fillStages(i,e)}if(!this.currentStage&&this.stages.length>0){this.currentStage=this.stages.keys().next().value}}setCurrentStageId(e){e=t.Text.toInteger(e);const i=this.getStageById(e);if(!i){return}this.currentStage=e;const s=this.getFinalStage();if(s){if(i.isFinal()){s.setColor(i.getColor()).setName(i.getName())}else{s.setColor(p.color).setName(p.name)}}this.stages.forEach((e=>{if(!e.isFinal()){e.fillingColor=i.getColor()}}));this.addBackLightUpToStage();return this}fillStages(e,t){let i=this.currentStage>0;const s={};this.stages=new Map;e.forEach((e=>{e.isFilled=i;e.backgroundColor=this.backgroundColor;e.fillingColor=t;e.events={onMouseEnter:this.onStageMouseHover.bind(this),onMouseLeave:this.onStageMouseLeave.bind(this),onClick:this.onStageClick.bind(this)};const a=o.create(e);if(a){this.stages.set(a.getId(),a)}if(a.isSuccess()){p.color=a.getColor()}if(a.isFinal()){s.isFilled=i;if(a.getId()===this.currentStage){s.name=a.getName();s.color=a.getColor()}}else if(i&&a.getId()===this.currentStage){i=false}}));if(this.getFailStages().length<=0){p.name=s.name=this.getSuccessStage().getName()}this.addFinalStage(s)}addFinalStage(e){this.stages.set(p.id,new o({...{backgroundColor:this.backgroundColor,events:{onMouseEnter:this.onStageMouseHover.bind(this),onMouseLeave:this.onStageMouseLeave.bind(this),onClick:this.onFinalStageClick.bind(this)}},...p,...e}))}getFinalStage(){return this.getStageById(p.id)}getStages(){return this.stages}getFirstFailStage(){let e=null;this.stages.forEach((t=>{if(t.isFail()&&!e){e=t}}));return e}getFailStages(){const e=[];this.stages.forEach((t=>{if(t.isFail()){e.push(t)}}));return e}getSuccessStage(){let e=null;this.stages.forEach((t=>{if(t.isSuccess()){e=t}}));return e}getStageById(e){return this.stages.get(e)}render(){const e=this.renderContainer();this.getStages().forEach((t=>{if(t.isFinal()){return}e.appendChild(t.render())}));this.addBackLightUpToStage();return e}renderContainer(){if(this.container){t.Dom.clean(this.container);return this.container}this.container=t.Tag.render(r||(r=n`<div class="ui-stageflow-container"></div>`));return this.container}onStageMouseHover(e){if(!this.isActive){return}this.hoverStageId=e.getId();for(let[t,i]of this.stages){i.addBackLight(e.getColor());if(t===e.getId()){break}}this.increaseStageWidthForNameVisibility(e)}onStageMouseLeave(e){if(!this.isActive){return}t.Dom.style(e.node,{flexBasis:null,flexGrow:null});for(let[t,i]of this.stages){i.removeBackLight();if(t===e.getId()){break}}}onStageClick(e){if(!this.isActive){return}if(e.getId()!==this.currentStage&&t.Type.isFunction(this.onStageChange)){this.onStageChange(e)}const i=this.getSemanticSelectorPopup();if(i.isShown()){i.close()}}onFinalStageClick(e){if(!this.isActive){return}if(this.getFailStages().length<=0){this.onStageClick(this.getSuccessStage())}else{const e=this.getSemanticSelectorPopup();e.show();const t=this.getStageById(this.currentStage);this.isActive=false;if(!t.isFinal()){const e=this.getStageById(p.id);if(e){this.addBackLightUpToStage(e.getId(),e.getColor())}}}}addBackLightUpToStage(e=null,t=null){if(!e){e=this.currentStage}const i=this.getStageById(e);if(i&&!t){t=i.getColor()}let s=!!e;this.stages.forEach((i=>{i.isFilled=s;if(i.isFilled){i.addBackLight(t?t:i.getColor())}else{i.removeBackLight()}if(!i.isFinal()&&s&&i.getId()===e){s=false}}))}getSemanticSelectorPopup(){let e=i.PopupManager.getPopupById(S);if(!e){let s=this.getFailStageName();e=i.PopupManager.create({id:S,autoHide:true,closeByEsc:true,closeIcon:true,maxWidth:420,content:t.Tag.render(g||(g=n`<div class="ui-stageflow-popup-title">${0}</div>`),this.labels.finalStagePopupTitle),buttons:[new BX.UI.Button({color:BX.UI.Button.Color.SUCCESS,text:this.getSuccessStage().getName(),onclick:()=>{this.isActive=true;this.onStageClick(this.getSuccessStage())}}),s?new BX.UI.Button({color:BX.UI.Button.Color.DANGER,text:s,onclick:()=>{e.close();const t=this.getFinalStageSelectorPopup();t.show();this.isActive=false}}):null],events:{onClose:()=>{this.setCurrentStageId(this.currentStage);this.isActive=true}}})}return e}getFinalStageSemanticSelector(e=null){if(!this.finalStageSemanticSelector){this.finalStageSemanticSelector=t.Tag.render(c||(c=n`<div class="ui-stageflow-stage-selector-option ui-stageflow-stage-selector-option-fail" onclick="${0}"></div>`),this.onSemanticSelectorClick.bind(this))}if(t.Type.isBoolean(e)){let t=null;let i=this.getFailStageName();if(e||!i){this.finalStageSemanticSelector.classList.add("ui-stageflow-stage-selector-option-success");this.finalStageSemanticSelector.classList.remove("ui-stageflow-stage-selector-option-fail");this.finalStageSemanticSelector.innerText=this.getSuccessStage().getName();t=this.getSuccessStage()}else{this.finalStageSemanticSelector.classList.add("ui-stageflow-stage-selector-option-fail");this.finalStageSemanticSelector.classList.remove("ui-stageflow-stage-selector-option-success");this.finalStageSemanticSelector.innerText=i;t=this.getFirstFailStage()}const s=this.getFinalStage();if(s&&t){s.setColor(t.getColor()).setName(t.getName())}this.addBackLightUpToStage(s.getId(),s.getColor())}return this.finalStageSemanticSelector}getFinalStageSelectorPopup(e=false){let s={};let a=t.Tag.render(h||(h=n`<div class="ui-stageflow-final-fail-stage-list-wrapper"></div>`));if(!e){const e=this.getFailStages();if(e.length>1){let i=true;e.forEach((e=>{a.appendChild(t.Tag.render(u||(u=n`<div class="ui-stageflow-final-fail-stage-list-section">
						<input data-stage-id="${0}" id="ui-stageflow-final-fail-stage-${0}" name="ui-stageflow-final-fail-stage-input" class="crm-list-fail-deal-button" type="radio" ${0}>
						<label for="ui-stageflow-final-fail-stage-${0}">${0}</label>
					</div>`),e.getId(),e.getId(),i?'checked="checked"':"",e.getId(),e.getName()));i=false}))}}s.content=t.Tag.render(d||(d=n`<div class="ui-stageflow-stage-selector-block">
			<span>${0} </span>
			${0}
		</div>`),this.labels.finalStageSelectorTitle,this.getFinalStageSemanticSelector(e));let l=i.PopupManager.getPopupById(f);if(!l){l=i.PopupManager.create({id:f,autoHide:false,closeByEsc:true,closeIcon:true,width:420,titleBar:true,buttons:[new BX.UI.SaveButton({onclick:()=>{l.close();const e=this.getSelectedFinalStage();if(e){this.onStageClick(e)}}}),new BX.UI.CancelButton({onclick:()=>{l.close()}})],events:{onClose:()=>{this.setCurrentStageId(this.currentStage);this.isActive=true}}})}l.setContent(a);l.setTitleBar(s);return l}onSemanticSelectorClick(){const e=this.getFailStageName();const t=i.MenuManager.create({id:"ui-stageflow-final-stage-semantic-selector",bindElement:this.getFinalStageSemanticSelector(),items:[{text:this.getSuccessStage().getName(),onclick:()=>{this.getFinalStageSelectorPopup(true);t.close()}},e?{text:e,onclick:()=>{this.getFinalStageSelectorPopup(false);t.close()}}:null]});t.show()}getSelectedFinalStage(){const e=this.getFinalStageSemanticSelector();if(e.classList.contains("ui-stageflow-stage-selector-option-success")){return this.getSuccessStage()}else{const e=this.getFailStages();if(e.length>1){const e=document.getElementById(f);if(e){const i=e.querySelector("input:checked");if(i){const e=this.getStageById(t.Text.toInteger(i.dataset.stageId));if(e){return e}}}}return this.getFirstFailStage()}}getFailStageName(){const e=this.getFailStages().length;if(e<=0){return null}else if(e===1){return this.getFirstFailStage().getName()}else{return this.labels.finalStagePopupFail}}increaseStageWidthForNameVisibility(e){if(!e.isNameCropped()){return}t.Dom.style(e.node,{flexGrow:0,flexBasis:`${e.getMinWidthForFullNameVisibility()}px`})}}const F={Chart:C,Stage:o};e.StageFlow=F})(this.BX.UI=this.BX.UI||{},BX,BX.Main);
//# sourceMappingURL=stageflow.bundle.map.js