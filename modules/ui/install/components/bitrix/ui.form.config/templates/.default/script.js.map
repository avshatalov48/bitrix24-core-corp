{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Loc, Reflection, Tag, Dom, Text} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\nconst namespace = Reflection.namespace('BX.Ui.Form');\n\nclass Config\n{\n\tisOpen = false;\n\t#items = [];\n\tpopupContainer = null;\n\n\tconstructor(options: Object)\n\t{\n\t\toptions.scopes.forEach(item => {\n\t\t\titem.config = this;\n\t\t\tthis.#items.push(new BX.Ui.Form.ConfigItem(item));\n\t\t}, this);\n\t\tthis.popupContainer = options.componentId;\n\t}\n}\n\nclass ConfigItem extends EventEmitter\n{\n\t#scopeId;\n\t#members;\n\t#node;\n\t#selectedItems;\n\t#moduleId;\n\tdrawingIconsLimit;\n\taddToAccessCodesHandler;\n\tremoveFromAccessCodesHandler;\n\tclosePopupHandler;\n\tconfig;\n\t#openPopupEvent = 'BX.Ui.Form.ConfigItem:onComponentOpen';\n\t#reinitDialogEvent = 'BX.Main.SelectorV2:reInitDialog';\n\n\tconstructor(options: Array)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Ui.Form');\n\n\t\tthis.#scopeId = (options['scopeId'] || null);\n\t\tthis.#members = (options['members'] || null);\n\t\tthis.#node = BX(`ui-editor-config-${this.#scopeId}`);\n\t\tthis.#selectedItems = null;\n\t\tthis.drawingIconsLimit = (options['drawingIconsLimit'] || 10);\n\t\tthis.#moduleId = (options['moduleId'] || null);\n\t\tthis.config = (options['config'] || null);\n\n\t\tthis.#drawMembers();\n\n\t\tthis.addToAccessCodesHandler = BX.delegate(this.onAddToAccessCodes, this);\n\t\tthis.removeFromAccessCodesHandler = BX.delegate(this.onRemoveFromAccessCodes, this);\n\t\tthis.closePopupHandler = BX.delegate(this.onClosePopup, this);\n\n\t\tBX.addCustomEvent('Grid::updated', this.onGridUpdate.bind(this));\n\n\t\tsetTimeout(() => {\n\t\t\tBX.onCustomEvent('BX.Ui.Form.ConfigItem:onComponentLoad', [{openDialogWhenInit: false}])\n\t\t}, 100);\n\t}\n\n\tonGridUpdate(params: Array): void\n\t{\n\t\tthis.#adjust();\n\t}\n\n\t#drawMembers(): void\n\t{\n\t\tif (this.#members)\n\t\t{\n\t\t\tlet i = 0;\n\t\t\tfor (let member in this.#members)\n\t\t\t{\n\t\t\t\tconst item = this.#members[member];\n\t\t\t\tthis.#node.appendChild(this.#createMember(item));\n\t\t\t\tif (i++ > this.drawingIconsLimit)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.#node.appendChild(this.#createPlusButton());\n\t}\n\n\t#createMember(member: Object): HTMLElement\n\t{\n\t\tconst children = (member.avatar\n\t\t\t? Tag.render`<a href=\"${member.url}\" class=\"ui-editor-config-item-avatar\"  title=\"${Text.encode(member.name)}\" style=\"background-image: url('${member.avatar}')\"></a>`\n\t\t\t: Tag.render`<a href=\"${member.url}\" class=\"ui-icon ui-icon-xs ui-icon-common-user\" title=\"${Text.encode(member.name)}\"><i></i></a>`\n\t\t);\n\n\t\treturn Dom.create('div', {\n\t\t\tattrs: {\n\t\t\t\tclass: 'ui-editor-config-item'\n\t\t\t},\n\t\t\tchildren: [\n\t\t\t\tchildren\n\t\t\t],\n\t\t});\n\t}\n\n\t#createPlusButton(): HTMLElement\n\t{\n\t\treturn Dom.create('div', {\n\t\t\tevents: {\n\t\t\t\tclick: event => {\n\t\t\t\t\tif (!this.config.isOpen)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#showPopup();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tattrs: {\n\t\t\t\tclass: 'ui-editor-config-item ui-editor-config-item--add'\n\t\t\t},\n\t\t});\n\t}\n\n\t#showPopup(): void\n\t{\n\t\tthis.config.isOpen = true;\n\n\t\tthis.#addEvents();\n\n\t\tconst selectorInstance = BX.Main.selectorManagerV2.controls[this.config.popupContainer].selectorInstance;\n\t\tselectorInstance.itemsSelected = {};\n\n\t\tBX.onCustomEvent(this.#openPopupEvent, [{\n\t\t\tid: this.config.popupContainer,\n\t\t\tbindNode: this.#node\n\t\t}]);\n\n\t\tBX.onCustomEvent(this.#reinitDialogEvent, [{\n\t\t\tselectorId: this.config.popupContainer,\n\t\t\tselectedItems: this.#getSelectedItems()\n\t\t}]);\n\t}\n\n\t#addEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:addToAccessCodes', this.addToAccessCodesHandler);\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:removeFromAccessCodes', this.removeFromAccessCodesHandler);\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:closePopup', this.closePopupHandler);\n\t}\n\n\t#getSelectedItems(): Array\n\t{\n\t\tif (this.#members && !this.#selectedItems)\n\t\t{\n\t\t\tlet items = {};\n\t\t\tfor (let member in this.#members)\n\t\t\t{\n\t\t\t\titems[member] = this.#members[member].type.toUpperCase();\n\t\t\t}\n\t\t\tthis.#selectedItems = items;\n\t\t}\n\n\t\treturn (this.#selectedItems || {});\n\t}\n\n\tstatic onMemberSelect(params: Array): void\n\t{\n\t\tif (params.state === 'select')\n\t\t{\n\t\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:addToAccessCodes', params);\n\t\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:addToAccessCodes', params);\n\t\t}\n\t}\n\n\tstatic onDialogClose(params: Array): void\n\t{\n\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:closePopup', params);\n\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:closePopup', params);\n\t}\n\n\tonClosePopup(event: Object): void\n\t{\n\t\tthis.config.isOpen = false;\n\t\tthis.#removeEvents();\n\t}\n\n\t#removeEvents(): void\n\t{\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:addToAccessCodes', this.addToAccessCodesHandler);\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:removeFromAccessCodes', this.removeFromAccessCodesHandler);\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:closePopup', this.closePopupHandler);\n\t}\n\n\tonAddToAccessCodes(event: Object): void\n\t{\n\t\tBX.ajax.runComponentAction('bitrix:ui.form.config', 'updateScopeAccessCodes', {\n\t\t\t'data': {\n\t\t\t\tmoduleId: this.#moduleId,\n\t\t\t\tscopeId: this.#scopeId,\n\t\t\t\taccessCodes: this.#getSelectedItems()\n\t\t\t}\n\t\t}).then(result => {\n\t\t\tthis.#adjust(result.data);\n\t\t});\n\t}\n\n\t#adjust(members: Array): void\n\t{\n\t\tthis.#node = BX(`ui-editor-config-${this.#scopeId}`);\n\n\t\tif (members)\n\t\t{\n\t\t\tthis.#members = members;\n\t\t}\n\n\t\tif (this.#node)\n\t\t{\n\t\t\twhile (this.#node.firstChild)\n\t\t\t{\n\t\t\t\tthis.#node.removeChild(this.#node.firstChild);\n\t\t\t}\n\t\t\tthis.#drawMembers();\n\t\t}\n\t}\n\n\tstatic onMemberUnselect(params: Array): void\n\t{\n\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:removeFromAccessCodes', params);\n\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:removeFromAccessCodes', params);\n\t}\n\n\tonRemoveFromAccessCodes(event: Object): void\n\t{\n\t\tthis.onAddToAccessCodes(event);\n\t}\n\n}\n\nnamespace.Config = Config;\nnamespace.ConfigItem = ConfigItem;"],"names":["namespace","Reflection","Config","options","scopes","forEach","item","config","push","BX","Ui","Form","ConfigItem","popupContainer","componentId","setEventNamespace","drawingIconsLimit","addToAccessCodesHandler","delegate","onAddToAccessCodes","removeFromAccessCodesHandler","onRemoveFromAccessCodes","closePopupHandler","onClosePopup","addCustomEvent","onGridUpdate","bind","setTimeout","onCustomEvent","openDialogWhenInit","params","event","isOpen","ajax","runComponentAction","moduleId","scopeId","accessCodes","then","result","data","state","EventEmitter","emit","i","member","appendChild","children","avatar","Tag","render","url","Text","encode","name","Dom","create","attrs","events","click","selectorInstance","Main","selectorManagerV2","controls","itemsSelected","id","bindNode","selectorId","selectedItems","subscribe","items","type","toUpperCase","unsubscribe","members","firstChild","removeChild"],"mappings":"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"}