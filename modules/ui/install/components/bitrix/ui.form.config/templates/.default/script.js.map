{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Loc, Reflection, Tag, Dom, Text} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\nconst namespace = Reflection.namespace('BX.Ui.Form');\n\nclass Config\n{\n\tisOpen = false;\n\t#items = [];\n\tpopupContainer = null;\n\n\tconstructor(options: Object)\n\t{\n\t\toptions.scopes.forEach(item => {\n\t\t\titem.config = this;\n\t\t\tthis.#items.push(new BX.Ui.Form.ConfigItem(item));\n\t\t}, this);\n\t\tthis.popupContainer = options.componentId;\n\t}\n}\n\nclass ConfigItem extends EventEmitter\n{\n\t#scopeId;\n\t#members;\n\t#node;\n\t#selectedItems;\n\t#moduleId;\n\tdrawingIconsLimit;\n\taddToAccessCodesHandler;\n\tremoveFromAccessCodesHandler;\n\tclosePopupHandler;\n\tconfig;\n\t#openPopupEvent = 'BX.Ui.Form.ConfigItem:onComponentOpen';\n\t#reinitDialogEvent = 'BX.Main.SelectorV2:reInitDialog';\n\n\tconstructor(options: Array)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Ui.Form');\n\n\t\tthis.#scopeId = (options['scopeId'] || null);\n\t\tthis.#members = (options['members'] || null);\n\t\tthis.#node = BX(`ui-editor-config-${this.#scopeId}`);\n\t\tthis.#selectedItems = null;\n\t\tthis.drawingIconsLimit = (options['drawingIconsLimit'] || 10);\n\t\tthis.#moduleId = (options['moduleId'] || null);\n\t\tthis.config = (options['config'] || null);\n\n\t\tthis.#drawMembers();\n\n\t\tthis.addToAccessCodesHandler = BX.delegate(this.onAddToAccessCodes, this);\n\t\tthis.removeFromAccessCodesHandler = BX.delegate(this.onRemoveFromAccessCodes, this);\n\t\tthis.closePopupHandler = BX.delegate(this.onClosePopup, this);\n\n\t\tBX.addCustomEvent('Grid::updated', this.onGridUpdate.bind(this));\n\n\t\tsetTimeout(() => {\n\t\t\tBX.onCustomEvent('BX.Ui.Form.ConfigItem:onComponentLoad', [{openDialogWhenInit: false}])\n\t\t}, 100);\n\t}\n\n\tonGridUpdate(params: Array): void\n\t{\n\t\tthis.#adjust();\n\t}\n\n\t#drawMembers(): void\n\t{\n\t\tif (this.#members)\n\t\t{\n\t\t\tlet i = 0;\n\t\t\tfor (let member in this.#members)\n\t\t\t{\n\t\t\t\tconst item = this.#members[member];\n\t\t\t\tthis.#node.appendChild(this.#createMember(item));\n\t\t\t\tif (i++ > this.drawingIconsLimit)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.#node.appendChild(this.#createPlusButton());\n\t}\n\n\t#createMember(member: Object): HTMLElement\n\t{\n\t\tconst children = (member.avatar\n\t\t\t? Tag.render`<a href=\"${member.url}\" class=\"ui-editor-config-item-avatar\"  title=\"${Text.encode(member.name)}\" style=\"background-image: url('${member.avatar}')\"></a>`\n\t\t\t: Tag.render`<a href=\"${member.url}\" class=\"ui-icon ui-icon-xs ui-icon-common-user\" title=\"${Text.encode(member.name)}\"><i></i></a>`\n\t\t);\n\n\t\treturn Dom.create('div', {\n\t\t\tattrs: {\n\t\t\t\tclass: 'ui-editor-config-item'\n\t\t\t},\n\t\t\tchildren: [\n\t\t\t\tchildren\n\t\t\t],\n\t\t});\n\t}\n\n\t#createPlusButton(): HTMLElement\n\t{\n\t\treturn Dom.create('div', {\n\t\t\tevents: {\n\t\t\t\tclick: event => {\n\t\t\t\t\tif (!this.config.isOpen)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#showPopup();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tattrs: {\n\t\t\t\tclass: 'ui-editor-config-item ui-editor-config-item--add'\n\t\t\t},\n\t\t});\n\t}\n\n\t#showPopup(): void\n\t{\n\t\tthis.config.isOpen = true;\n\n\t\tthis.#addEvents();\n\n\t\tconst selectorInstance = BX.Main.selectorManagerV2.controls[this.config.popupContainer].selectorInstance;\n\t\tselectorInstance.itemsSelected = {};\n\n\t\tBX.onCustomEvent(this.#openPopupEvent, [{\n\t\t\tid: this.config.popupContainer,\n\t\t\tbindNode: this.#node\n\t\t}]);\n\n\t\tBX.onCustomEvent(this.#reinitDialogEvent, [{\n\t\t\tselectorId: this.config.popupContainer,\n\t\t\tselectedItems: this.#getSelectedItems()\n\t\t}]);\n\t}\n\n\t#addEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:addToAccessCodes', this.addToAccessCodesHandler);\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:removeFromAccessCodes', this.removeFromAccessCodesHandler);\n\t\tEventEmitter.subscribe('BX.Ui.Form.ConfigItem:closePopup', this.closePopupHandler);\n\t}\n\n\t#getSelectedItems(): Array\n\t{\n\t\tif (this.#members && !this.#selectedItems)\n\t\t{\n\t\t\tlet items = {};\n\t\t\tfor (let member in this.#members)\n\t\t\t{\n\t\t\t\titems[member] = this.#members[member].type.toUpperCase();\n\t\t\t}\n\t\t\tthis.#selectedItems = items;\n\t\t}\n\n\t\treturn (this.#selectedItems || {});\n\t}\n\n\tstatic onMemberSelect(params: Array): void\n\t{\n\t\tif (params.state === 'select')\n\t\t{\n\t\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:addToAccessCodes', params);\n\t\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:addToAccessCodes', params);\n\t\t}\n\t}\n\n\tstatic onDialogClose(params: Array): void\n\t{\n\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:closePopup', params);\n\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:closePopup', params);\n\t}\n\n\tonClosePopup(event: Object): void\n\t{\n\t\tthis.config.isOpen = false;\n\t\tthis.#removeEvents();\n\t}\n\n\t#removeEvents(): void\n\t{\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:addToAccessCodes', this.addToAccessCodesHandler);\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:removeFromAccessCodes', this.removeFromAccessCodesHandler);\n\t\tEventEmitter.unsubscribe('BX.Ui.Form.ConfigItem:closePopup', this.closePopupHandler);\n\t}\n\n\tonAddToAccessCodes(event: Object): void\n\t{\n\t\tBX.ajax.runComponentAction('bitrix:ui.form.config', 'updateScopeAccessCodes', {\n\t\t\t'data': {\n\t\t\t\tmoduleId: this.#moduleId,\n\t\t\t\tscopeId: this.#scopeId,\n\t\t\t\taccessCodes: this.#getSelectedItems()\n\t\t\t}\n\t\t}).then(result => {\n\t\t\tthis.#adjust(result.data);\n\t\t});\n\t}\n\n\t#adjust(members: Array): void\n\t{\n\t\tthis.#node = BX(`ui-editor-config-${this.#scopeId}`);\n\n\t\tif (members)\n\t\t{\n\t\t\tthis.#members = members;\n\t\t}\n\n\t\tif (this.#node)\n\t\t{\n\t\t\twhile (this.#node.firstChild)\n\t\t\t{\n\t\t\t\tthis.#node.removeChild(this.#node.firstChild);\n\t\t\t}\n\t\t\tthis.#drawMembers();\n\t\t}\n\t}\n\n\tstatic onMemberUnselect(params: Array): void\n\t{\n\t\tEventEmitter.emit('BX.Ui.Form.ConfigItem:removeFromAccessCodes', params);\n\t\t//BX.onCustomEvent('BX.Ui.Form.ConfigItem:removeFromAccessCodes', params);\n\t}\n\n\tonRemoveFromAccessCodes(event: Object): void\n\t{\n\t\tthis.onAddToAccessCodes(event);\n\t}\n\n}\n\nnamespace.Config = Config;\nnamespace.ConfigItem = ConfigItem;"],"names":["namespace","Reflection","Config","options","scopes","forEach","item","config","push","BX","Ui","Form","ConfigItem","popupContainer","componentId","setEventNamespace","drawingIconsLimit","addToAccessCodesHandler","delegate","onAddToAccessCodes","removeFromAccessCodesHandler","onRemoveFromAccessCodes","closePopupHandler","onClosePopup","addCustomEvent","onGridUpdate","bind","setTimeout","onCustomEvent","openDialogWhenInit","params","event","isOpen","ajax","runComponentAction","moduleId","scopeId","accessCodes","then","result","data","state","EventEmitter","emit","i","member","appendChild","children","avatar","Tag","render","url","Text","encode","name","Dom","create","attrs","events","click","selectorInstance","Main","selectorManagerV2","controls","itemsSelected","id","bindNode","selectorId","selectedItems","subscribe","items","type","toUpperCase","unsubscribe","members","firstChild","removeChild"],"mappings":"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"}