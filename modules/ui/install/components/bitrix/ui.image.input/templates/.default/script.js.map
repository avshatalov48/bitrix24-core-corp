{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Dom, Event, Reflection, Tag, Type} from 'main.core';\nimport {type BaseEvent, EventEmitter} from 'main.core.events';\n\nclass ImageInput\n{\n\tconstructor(params = {})\n\t{\n\t\tthis.instanceId = params.instanceId;\n\t\tthis.containerId = params.containerId;\n\t\tthis.loaderContainerId = params.loaderContainerId;\n\t\tthis.settings = params.settings || {};\n\n\t\tthis.addImageHandler = this.addImage.bind(this);\n\t\tthis.editImageHandler = this.editImage.bind(this);\n\n\t\tEventEmitter.subscribe('onUploaderIsInited', this.onUploaderIsInitedHandler.bind(this));\n\t}\n\n\tonUploaderIsInitedHandler(event: BaseEvent)\n\t{\n\t\tconst [id, uploader] = event.getCompatData();\n\n\t\tif (this.instanceId === id)\n\t\t{\n\t\t\tif (uploader && Type.isDomNode(uploader.fileInput))\n\t\t\t{\n\t\t\t\tconst wrapper = uploader.fileInput.closest('.adm-fileinput-wrapper');\n\n\t\t\t\tif (Type.isDomNode(wrapper))\n\t\t\t\t{\n\t\t\t\t\tconst previews = wrapper.querySelectorAll('.adm-fileinput-item');\n\n\t\t\t\t\tif (previews.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.addClass(wrapper, 'ui-image-input-wrapper');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tthis.getLoaderContainer() && (this.getLoaderContainer().style.display = 'none');\n\t\t\t\tthis.getContainer().style.display = '';\n\t\t\t});\n\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsCreated', this.onFileIsCreatedHandler.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsDeleted', this.onFileIsCreatedHandler.bind(this));\n\t\t}\n\t}\n\n\tgetInputInstance()\n\t{\n\t\treturn BX.UI.FileInput.getInstance(this.instanceId);\n\t}\n\n\tgetFileInput()\n\t{\n\t\treturn this.getInputInstance().agent.fileInput;\n\t}\n\n\tgetContainer()\n\t{\n\t\tif (!this.container)\n\t\t{\n\t\t\tthis.container = document.getElementById(this.containerId);\n\n\t\t\tif (!Type.isDomNode(this.container))\n\t\t\t{\n\t\t\t\tthrow Error(`Can't find container with id ${this.containerId}`);\n\t\t\t}\n\t\t}\n\n\t\treturn this.container;\n\t}\n\n\tgetLoaderContainer()\n\t{\n\t\tif (!this.loaderContainer)\n\t\t{\n\t\t\tthis.loaderContainer = document.getElementById(this.loaderContainerId);\n\t\t}\n\n\t\treturn this.loaderContainer;\n\t}\n\n\tgetAddButton()\n\t{\n\t\tif (!this.addButton)\n\t\t{\n\t\t\tthis.addButton = this.getContainer().querySelector('[data-role=\"image-add-button\"]');\n\t\t}\n\n\t\treturn this.addButton;\n\t}\n\n\teditImage(event)\n\t{\n\t\tif (event.target === this.getFileInput())\n\t\t{\n\t\t\t// api call .click() to fire file upload dialog\n\t\t\tif (event.detail === 0)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// disable default file dialog open\n\t\t\telse\n\t\t\t{\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\t\t}\n\n\t\tconst inputInstance = this.getInputInstance();\n\t\tconst items = inputInstance.agent.getItems().items;\n\n\t\tfor (let id in items)\n\t\t{\n\t\t\tif (items.hasOwnProperty(id))\n\t\t\t{\n\t\t\t\t// hack to open editor (for unknown reasons the flag disappears)\n\t\t\t\tinputInstance.frameFlags.active = true;\n\t\t\t\tinputInstance.frameFiles(id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\taddImage(event)\n\t{\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t\tthis.getFileInput().click();\n\t}\n\n\tonFileIsCreatedHandler(event: BaseEvent)\n\t{\n\t\tconst [, , uploader] = event.getCompatData();\n\n\t\tif (uploader && Type.isDomNode(uploader.fileInput))\n\t\t{\n\t\t\tconst wrapper = uploader.fileInput.closest('.adm-fileinput-wrapper');\n\n\t\t\tif (Type.isDomNode(wrapper))\n\t\t\t{\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tthis.recalculateWrapper(wrapper);\n\t\t\t\t\t}, 100\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tisMultipleInput()\n\t{\n\t\treturn this.getInputInstance().uploadParams.maxCount !== 1;\n\t}\n\n\tbuildShadowElement(wrapper)\n\t{\n\t\tif (!wrapper.querySelector('div.ui-image-item-shadow'))\n\t\t{\n\t\t\tconst shadowElement = Tag.render`<div class=\"ui-image-item-shadow\"></div>`;\n\t\t\tconst bottomMargin = 4;\n\t\t\tconst preview = wrapper.querySelector('.adm-fileinput-item-preview');\n\t\t\tconst previewWrapper = wrapper.closest('.adm-fileinput-item-wrapper');\n\n\t\t\tconst canvas = wrapper.querySelector('canvas');\n\t\t\tif (canvas)\n\t\t\t{\n\t\t\t\tshadowElement.style.height = canvas.offsetHeight + 'px';\n\t\t\t\tshadowElement.style.width = canvas.offsetWidth - bottomMargin + 'px';\n\n\t\t\t\tpreview.style.height = canvas.offsetHeight + 'px';\n\t\t\t\tpreviewWrapper.style.height = canvas.offsetHeight + 'px';\n\t\t\t}\n\n\t\t\tDom.prepend(shadowElement, wrapper);\n\t\t}\n\t}\n\n\trecalculateWrapper(wrapper)\n\t{\n\t\tconst previews = wrapper.querySelectorAll('.adm-fileinput-item');\n\t\tconst length = Math.min(previews.length, 3);\n\n\t\tif (length)\n\t\t{\n\t\t\tthis.buildShadowElement(previews[0]);\n\n\t\t\tDom.addClass(wrapper, 'ui-image-input-wrapper');\n\t\t\tthis.getFileInput().style.display = 'none';\n\n\t\t\tEvent.unbind(wrapper, 'click', this.editImageHandler);\n\t\t\tEvent.bind(wrapper, 'click', this.editImageHandler);\n\n\t\t\tif (this.isMultipleInput())\n\t\t\t{\n\t\t\t\tthis.getAddButton().style.display = '';\n\n\t\t\t\tEvent.unbind(this.getAddButton(), 'click', this.addImageHandler);\n\t\t\t\tEvent.bind(this.getAddButton(), 'click', this.addImageHandler);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(wrapper, 'ui-image-input-wrapper');\n\t\t\tthis.getFileInput().style.display = '';\n\n\t\t\tEvent.unbind(wrapper, 'click', this.editImageHandler);\n\n\t\t\tif (this.isMultipleInput())\n\t\t\t{\n\t\t\t\tthis.getAddButton().style.display = 'none';\n\n\t\t\t\tEvent.unbind(this.getAddButton(), 'click', this.addImageHandler);\n\t\t\t}\n\t\t}\n\n\t\tswitch (length)\n\t\t{\n\t\t\tcase 3:\n\t\t\t\tDom.addClass(wrapper, 'ui-image-input-wrapper-multiple');\n\t\t\t\tDom.removeClass(wrapper, 'ui-image-input-wrapper-double');\n\t\t\t\tbreak;\n\n\t\t\tcase 2:\n\t\t\t\tDom.addClass(wrapper, 'ui-image-input-wrapper-double');\n\t\t\t\tDom.removeClass(wrapper, 'ui-image-input-wrapper-multiple');\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tDom.removeClass(wrapper, 'ui-image-input-wrapper-double');\n\t\t\t\tDom.removeClass(wrapper, 'ui-image-input-wrapper-multiple');\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.UI').ImageInput = ImageInput;"],"names":["ImageInput","params","instanceId","containerId","loaderContainerId","settings","addImageHandler","addImage","bind","editImageHandler","editImage","EventEmitter","subscribe","onUploaderIsInitedHandler","event","getCompatData","id","uploader","Type","isDomNode","fileInput","wrapper","closest","previews","querySelectorAll","length","Dom","addClass","requestAnimationFrame","getLoaderContainer","style","display","getContainer","onFileIsCreatedHandler","BX","UI","FileInput","getInstance","getInputInstance","agent","container","document","getElementById","Error","loaderContainer","addButton","querySelector","target","getFileInput","detail","preventDefault","inputInstance","items","getItems","hasOwnProperty","frameFlags","active","frameFiles","stopPropagation","click","setTimeout","recalculateWrapper","uploadParams","maxCount","shadowElement","Tag","render","bottomMargin","preview","previewWrapper","canvas","height","offsetHeight","width","offsetWidth","prepend","Math","min","buildShadowElement","Event","unbind","isMultipleInput","getAddButton","removeClass","Reflection","namespace"],"mappings":"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"}