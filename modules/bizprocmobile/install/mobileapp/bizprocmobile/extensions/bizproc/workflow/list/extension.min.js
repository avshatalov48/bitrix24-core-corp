jn.define("bizproc/workflow/list",((t,e,s)=>{const i=t("apptheme");const{magnifierWithMenuAndDot:o}=t("assets/common");const{Loc:n}=t("loc");const{showToast:r,Position:a}=t("toast");const{usersUpserted:l,usersAdded:h}=t("statemanager/redux/slices/users");const{dispatch:c}=t("statemanager/redux/store");const{EmptyScreen:d}=t("layout/ui/empty-screen");const{SearchLayout:u}=t("layout/ui/search-bar");const{StatefulList:m}=t("layout/ui/stateful-list");const{ListItemsFactory:f}=t("layout/ui/simple-list/items");const{SkeletonFactory:I}=t("layout/ui/simple-list/skeleton");const{WorkflowSimpleList:p}=t("bizproc/workflow/list/simple-list");const{ViewMode:w}=t("bizproc/workflow/list/view-mode");const{WorkflowItem:L}=t("bizproc/workflow/list/item");const{Skeleton:k}=t("bizproc/workflow/list/skeleton");const{BottomPanel:S}=t("bizproc/workflow/list/bottom-panel");I.register("workflow",k);class g extends p{constructor(t){super(t);this.showSearch=this.showSearch.bind(this);this.onSearch=this.onSearch.bind(this);this.onPanList=this.onPanList.bind(this);this.search=new u({layout:this.layout,id:"bp_list",cacheId:`bp_list_${env.userId}`,presetId:"in_work",searchDataAction:"bizprocmobile.Workflow.getFilterPresets",searchDataActionParams:{},onSearch:this.onSearch,onCancel:this.onSearch});this.filterPresetId="in_work";this.filterSearchQuery="";this.onMultiSelectTasksCompleted=this.onMultiSelectTasksCompleted.bind(this);this.handleBeforeItemsRender=this.handleBeforeItemsRender.bind(this);this.handleFloatingButtonClick=this.handleFloatingButtonClick.bind(this);this.renderEmptyListComponent=this.renderEmptyListComponent.bind(this);this.handleRefreshEmptyScreen=this.handleRefreshEmptyScreen.bind(this);this.pullCallback=t=>new Promise((e=>{if(t.command==="workflow"){e(t)}}))}onTaskTouch({task:t,isInline:e}){const s=this.listRef.getItem(t.workflowId);if(s&&s.data.authorId!==Number(env.userId)){this.hideItem(t.workflowId)}if(this.state.selectedTasks){this.onTaskDeselected({task:t})}if(e){this.notifyAboutCompletedTask(t)}}onSearch({text:t,presetId:e}){if(this.filterPresetId===e&&this.filterSearchQuery===t){return}this.filterPresetId=e;this.filterSearchQuery=t;this.setState({},(()=>{this.listRef.reload({menuButtons:this.getMenuButtons()},{extra:this.getSearchParams(),useCache:false})}))}onPanList(){this.search.close()}getSearchParams(){return{filterPresetId:this.filterPresetId,filterSearchQuery:this.filterSearchQuery}}showSearch(){this.search.show()}getMenuActions(){return this.state.viewMode===w.REGULAR&&[this.getSelectAllAction()]||[]}getSelectAllAction(){return{id:"bizproc-select-all",title:n.getMessage("BPMOBILE_WORKFLOW_TASK_LAYOUT_ACTION_SELECT_ALL"),iconUrl:`${currentDomain}/bitrix/mobileapp/bizprocmobile/extensions/bizproc/assets/workflow/list/select-all.png`,onItemSelected:this.onSelectAllActionClick.bind(this)}}onSelectAllActionClick(){if(!this.listRef){return}const t=this.listRef.getItems();const e=new Map;t.forEach((t=>{if(t.data.tasks&&t.data.tasks[0]){const s=t.data.tasks[0];e.set(parseInt(s.id,10),{...s,workflowId:t.id,typeName:t.data.typeName,item:t})}}));if(e.size>0){this.setMultipleViewMode(e);return}r({message:n.getMessage("BPMOBILE_WORKFLOW_TASK_LAYOUT_ACTION_SELECT_ALL_EMPTY_ERROR"),position:a.TOP},this.layout)}getMenuButtons(){if(this.state.viewMode===w.MULTISELECT){return[this.getCancelButton()]}return[this.getSearchButton()]}getSearchButton(){return{testId:"BP_WORKFLOW_LIST_SEARCH_BUTTON",type:"search",badgeCode:"search",callback:this.showSearch,svg:{content:o(i.colors.base4,this.search.getSearchButtonBackgroundColor())}}}getCancelButton(){return{id:"cancel",name:n.getMessage("BPMOBILE_WORKFLOW_LIST_CANCEL"),type:"text",color:i.colors.accentMainLinks,callback:this.setRegularViewMode.bind(this)}}createList(){return new m({testId:"BP_WORKFLOW_LIST",actions:{loadItems:"bizprocmobile.Workflow.loadList"},actionParams:{loadItems:{extra:this.getSearchParams()}},actionCallbacks:{loadItems:this.onItemsLoaded},itemLayoutOptions:{useItemMenu:true},isShowFloatingButton:this.state.viewMode!==w.MULTISELECT,itemDetailOpenHandler:this.handleWorkflowDetailOpen,itemActions:this.getItemActions(),getEmptyListComponent:this.renderEmptyListComponent,layout:this.layout,layoutMenuActions:this.getMenuActions(),layoutOptions:{useSearch:false,useOnViewLoaded:true},onPanListHandler:this.onPanList,menuButtons:this.getMenuButtons(),onFloatingButtonClick:this.handleFloatingButtonClick,cacheName:`bizproc.workflow.list.${env.userId}`,itemType:"workflow",itemFactory:T,onBeforeItemsRender:this.handleBeforeItemsRender,pull:{moduleId:"bizproc",callback:this.pullCallback,notificationAddText:n.getMessage("BPMOBILE_WORKFLOW_LIST_NEW_TASKS_NOTIFICATION"),shouldReloadDynamically:true},ref:this.listCallbackRef})}renderEmptyListComponent(){const t=this.filterPresetId!=="in_work"||this.filterSearchQuery!=="";return new d({styles:{container:{paddingHorizontal:20},icon:{marginBottom:50}},image:{uri:d.makeLibraryImagePath("workflows.png","bizproc"),style:{width:148,height:149}},title:n.getMessage(t?"BPMOBILE_WORKFLOW_LIST_EMPTY_TITLE":"BPMOBILE_WORKFLOW_LIST_EMPTY_FILTERED_TITLE_MSGVER_1"),description:t?null:n.getMessage("BPMOBILE_WORKFLOW_LIST_EMPTY_DESCRIPTION"),onRefresh:this.handleRefreshEmptyScreen})}handleRefreshEmptyScreen(){this.reload()}reload(){if(this.listRef&&this.listRef.reloadList){this.listRef.reloadList()}}renderBottomToolbar(){const t=this.selectedTasks;if(this.state.viewMode===w.MULTISELECT&&t.size>0){return new S({tasks:[...t.values()],layout:this.layout,onTasksCompleted:this.onMultiSelectTasksCompleted})}return null}onMultiSelectTasksCompleted(t,e){const s=[...Array.isArray(t)?t:[],...Array.isArray(e)?e:[]];s.forEach((t=>{setTimeout((()=>{if(this.isWorkflowFirstTask(t.workflowId,t.id)){const e=this.listRef.getItem(t.workflowId);if(e){if(e.data.authorId===Number(env.userId)){const e=this.listRef.getItemComponent(t.workflowId);if(e){e.setIsDoing(true)}}else{this.hideItem(t.workflowId)}}}}),200)}));this.setRegularViewMode()}getItemActions(){return[]}handleFloatingButtonClick(){void requireLazy("lists:element-creation-guide").then((({ElementCreationGuide:t})=>{t.open({layout:this.layout})}))}handleBeforeItemsRender(t){return this.prepareItems(t)}onItemsLoaded(t,e){const{users:s=[]}=t||{};const i=e==="cache";if(s.length>0){c(i?h(s):l(s))}}hideItem(t){this.listRef.deleteItem(t)}setRegularViewMode(){this.setState({selectedTasks:null,viewMode:w.REGULAR},(()=>{if(this.listRef&&this.listRef.initMenu){this.listRef.initMenu()}}))}setMultipleViewMode(t){this.setState({selectedTasks:t,viewMode:w.MULTISELECT},(()=>{if(this.listRef&&this.listRef.initMenu){this.listRef.initMenu()}}))}}class T extends f{static create(t,e){if(t==="workflow"){return new L(e)}return super.create(t,e)}}s.exports={WorkflowList:g}}));
//# sourceMappingURL=extension.map.js