jn.define("bizproc/workflow/timeline",((t,e,s)=>{const i=t("apptheme");const{cross:o,documents:n,union:r,clock:a,flag:l}=t("bizproc/workflow/timeline/icons");const{Skeleton:c}=t("bizproc/workflow/timeline/skeleton");const{ContentStub:u,UserStub:d,Counter:m,StepWrapper:p,StepContent:h,StepsListCollapsed:I,StepTitle:T,StepSubtitle:O,StepUserList:_}=t("bizproc/workflow/timeline/components");const{PureComponent:g}=t("layout/pure-component");const{SafeImage:f}=t("layout/ui/safe-image");const{Loc:E}=t("loc");const{dispatch:L}=t("statemanager/redux/store");const{usersAdded:k}=t("statemanager/redux/slices/users");const{Duration:D}=t("utils/date/duration");const{shortTime:S,dayMonth:M}=t("utils/date/formats");const{mergeImmutable:w}=t("utils/object");const{Type:y}=t("type");const{inAppUrl:W}=t("in-app-url");const{openNativeViewer:B}=t("utils/file");const{throttle:N}=t("utils/function");const{NotifyManager:C}=t("notify-manager");const{roundSeconds:b}=t("bizproc/helper/duration");const R={all:"BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_ALL",any:"BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_ANY",vote:"BPMOBILE_WORKFLOW_TIMELINE_TASK_VOTING"};const U={1:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK",2:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO",3:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK",4:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO",5:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO"};class F extends g{static open(t=PageManager,e={}){t.openWidget("layout",{modal:true,titleParams:{text:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TITLE_MSGVER_1"),type:"dialog"},backgroundColor:i.colors.bgContentPrimary,backdrop:{onlyMediumPosition:false,mediumPositionPercent:90,navigationBarColor:i.colors.bgSecondary,swipeAllowed:true,swipeContentAllowed:true,horizontalSwipeAllowed:false},onReady:s=>{s.showComponent(new F({parentLayout:t,layout:s,workflowId:e.workflowId,taskId:e.taskId,readOnly:e.readOnly||false}))}})}constructor(t){super(t);this.testId="BpTimeline";this.stepsUserList=[];this.state.timelineData=null;this.loadTimelineData().then((t=>{this.setState({timelineData:t})})).catch((t=>console.warn(t)))}get workflowId(){return this.props.workflowId}get layout(){return this.props.layout}get parentLayout(){return this.props.parentLayout}get taskId(){const t=parseInt(this.props.taskId,10);return y.isNumber(t)?t:0}get taskExecutionTimeLimit(){return D.getLengthFormat().DAY/1e3*3}get timelineData(){return this.state.timelineData}isLoaded(){return!y.isNil(this.timelineData)}getUserDataById(t){return this.timelineData.users.find((e=>e.id===t))}async loadTimelineData(){const t=await BX.ajax.runAction("bizprocmobile.Workflow.getTimeline",{data:{workflowId:this.workflowId}});for(const e of t.errors){console.error(e)}if(t.errors.length===0){const e=t.data;L(k(e.users));if(y.isArray(e.tasks)){e.tasks.sort(((t,e)=>{const s=this.isTaskCompleted(t);const i=this.isTaskCompleted(e);if(s&&!i){return-1}if(!s&&i){return 1}return t.id-e.id}))}return e}return{}}render(){return ScrollView({style:{}},View({style:{flexDirection:"column",paddingHorizontal:16,paddingVertical:12}},...this.renderContent(),View({style:{height:12}})))}renderContent(){if(this.isLoaded()){return[this.renderFirstStep(),...this.renderTasks(),this.renderLastStep()]}return[new c]}renderFirstStep(){return this.renderStep({wrapperOptions:{showBorders:true,backgroundColor:i.colors.bgContentSecondary},counterOptions:{value:1,tailColor:this.timelineData.tasks.length>0||!this.timelineData.isWorkflowRunning?i.colors.base4:i.colors.base7},titleOptions:{text:this.timelineData.entityName,testId:`${this.testId}WorkflowText`},header:{title:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_STARTED_BY"),timestamp:this.timelineData.started},users:[{id:this.timelineData.startedBy}],additionalContent:[this.renderDocument()],footer:y.isNumber(this.timelineData.timeToStart)?E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":this.formatDuration(this.timelineData.timeToStart)}):""})}formatDate(t){return DateFormatter.getDateString(t,`${M()} ${S()}`)}formatDuration(t){if(!y.isInteger(t)){return null}return D.createFromSeconds(t>=60?b(t):t).format()}renderDocument(){return View({style:{flexDirection:"column",paddingBottom:8}},View({style:{flexDirection:"row"}},f({style:{width:24,height:24,marginRight:2},resizeMode:"contain",placeholder:{content:this.getDocumentIconContent()}}),Text({testId:`${this.testId}DocumentModuleName`,text:y.isString(this.timelineData.moduleName)?`${this.timelineData.moduleName}:`:"",style:{color:i.colors.base1,fontSize:15,fontWeight:"400"}})),y.isStringFilled(this.timelineData.documentName)&&View({onClick:this.openDocument.bind(this)},Text({testId:`${this.testId}DocumentName`,text:this.timelineData.documentName,style:{color:i.colors.accentMainLinks,fontSize:15,fontWeight:"400"}})))}openDocument(){const t=y.isString(this.timelineData.documentType[0])?this.timelineData.documentType[0].toLowerCase():"";if(!y.isStringFilled(this.timelineData.documentUrl)||t==="disk"&&y.isNil(this.timelineData.documentDiskFile)){C.showError(E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_DOCUMENT_NOT_FOUND"));return}if(t==="disk"){const t=this.timelineData.documentDiskFile;if(y.isNil(t.error)){B({fileType:UI.File.getType(UI.File.getFileMimeType(t.type,t.name)),url:t.url,name:t.name})}else{C.showError(t.error)}return}W.open(this.timelineData.documentUrl,{parentWidget:this.layout})}getDocumentIconContent(){if(y.isArray(this.timelineData.documentType)){const t=y.isString(this.timelineData.documentType[0])?this.timelineData.documentType[0].toLowerCase():"";let e=y.isString(this.timelineData.documentType[2])?this.timelineData.documentType[2].toLowerCase():"";if(e.startsWith("dynamic")){e="dynamic"}if(t==="crm"&&e.startsWith("smart_")){e=e.slice("smart_".length)}return y.isObjectLike(n[t])&&y.isFunction(n[t][e])?n[t][e]():n.lists()}return n.lists()}renderTasks(){if(!this.timelineData.tasks||this.timelineData.tasks.length===0){return[]}const t=[];const e=[];const s=this.timelineData.tasks.length;const o=s-1;let n=i.colors.base4;for(const[s,r]of this.timelineData.tasks.entries()){const l=s===o;const c=this.isTaskCompleted(r);let u=i.colors.accentMainSuccess;if(!c){u=i.colors.accentMainPrimary}if(this.isTaskDeclined(r)){u=i.colors.base5}const d=l&&this.timelineData.isWorkflowRunning?i.colors.base7:i.colors.base4;let m=null;if(r.canView){const t={trunkColor:n,hasTail:true,tailColor:d,backgroundColor:u,value:s+2};let e=null;if(this.taskId!==r.id&&this.canCurrentUserDoTask(r)){e={id:r.id,testId:`${this.testId}TaskButton_${r.id}`,text:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_START"),onclick:()=>{if(!this.props.readOnly){this.openTaskDetails(r.id).catch((t=>console.error(t)))}},readOnly:this.props.readOnly}}let o=E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK");if(!c){if(Object.hasOwn(R,r.approveType)&&r.users.length>0){const t=r.users.filter((t=>t.status!==0)).length;o=E.getMessage(R[r.approveType],{"#FINISHED_COUNT#":t,"#ALL_COUNT#":r.users.length})}else{o=E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_SINGLE")}}else if(Object.hasOwn(U,r.status)){o=E.getMessage(U[r.status])}const l=r.users.map((t=>{let e=`${this.testId}User_${t.id}`;if(t.status===1||t.status===3){e+="_Accepted"}else if(t.status===2||t.status===4){e+="_Declined"}return{id:t.id,status:t.status,testId:e}}));let p=null;if(r.executionTime){p={};if(r.executionTime>this.taskExecutionTimeLimit){const t=i.colors.accentMainLinks;p.footer={text:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":`[color=${t}][url]${this.formatDuration(r.executionTime)}[/url][/color]`}),onLinkClick:()=>InAppNotifier.showNotification({message:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TIME_LIMIT_EXCEEDED"),code:"bp-workflow-timeline-execution-time-exceeded",time:3})}}else{p.footer=E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":this.formatDuration(r.executionTime)})}}m=this.renderStep({wrapperOptions:{showBorders:false},counterOptions:t,titleOptions:{text:r.name,testId:`${this.testId}TaskTitle_${r.id}`,button:e},header:{title:o,testId:`${this.testId}Task_${r.id}_Status`,timestamp:this.isTaskCompleted(r)?r.modified:null,icon:this.isTaskCompleted(r)?null:a()},users:l,usersTestId:`${this.testId}Task_${r.id}_Users`,...p})}else{m=this.renderStub({title:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_RIGHTS_ERROR"),wrapperOptions:{showBorders:false},counterOptions:{value:s+2,hasTail:true,tailColor:d,trunkColor:n}})}if(m){if(c){e.push(m)}else{t.push(m)}}n=d}if(e.length>0){t.unshift(this.renderCollapsedTasks(e,{tailColor:t.length>0||!this.timelineData.isWorkflowRunning?i.colors.base4:i.colors.base7}))}return t}renderCollapsedTasks(t,e=null){return I({text:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_MORE_TASKS"),onStepsExpanding:()=>{this.stepsUserList.forEach((t=>t.showUsers()))},steps:t,collapsedButtonTestId:`${this.testId}CollapsedButton`,counterOptions:e})}renderLastStep(){if(this.timelineData.isWorkflowRunning){return this.renderStub({title:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_CONTINUE_EXECUTION"),wrapperOptions:{},counterOptions:{hasTail:false,backgroundColor:i.colors.base7,size:11,trunkColor:i.colors.base7}})}const t=this.timelineData.tasks.at(-1);const e=!y.isObjectLike(t)||this.isTaskAccepted(t);let s=y.isNumber(this.timelineData.executionTime)?this.timelineData.executionTime:null;if(y.isNumber(this.timelineData.timeToStart)){s=s===null?this.timelineData.timeToStart:s+this.timelineData.timeToStart}const o=[];const n=[];if(this.timelineData.workflowResult){o.push(this.renderWorkflowResult(this.timelineData.workflowResult))}else if(y.isObjectLike(t)){o.push(this.renderExtendedTaskStatus(t));n.push({id:this.timelineData.startedBy})}return this.renderStep({wrapperOptions:{showBorders:true,borderOptions:{color:e?i.colors.accentMainSuccess:null},backgroundColor:e?i.colors.accentSoftGreen3:null},counterOptions:{hasTail:false,trunkColor:i.colors.base4,iconContent:r()},titleOptions:{text:this.timelineData.entityName,testId:`${this.testId}LastStepTitle`},header:{title:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_COMPLETED"),testId:`${this.testId}LastStepStatus`,timestamp:this.timelineData.workflowModifiedDate},content:o,users:n,footer:y.isNumber(s)?E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_EXECUTION_TIME",{"#DURATION#":this.formatDuration(s)}):""})}renderExtendedTaskStatus(t){if(!t.canView){return View()}const e=this.isTaskAccepted(t);return View({style:{flexDirection:"row",alignItems:"center"}},f({style:{width:24,height:24,paddingRight:2},resizeMode:"contain",placeholder:{content:e?l():o({color:i.colors.base3})}}),Text({text:e?E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXTENDED_TASK_STATUS_ACCEPTED"):E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXTENDED_TASK_STATUS_DECLINED"),numberOfLines:1,ellipsize:"end",style:{color:i.colors.base1,fontSize:15,fontWeight:"400"}}))}renderWorkflowResult({text:t,files:e}){return View({style:{marginBottom:8}},View({style:{flexDirection:"row",alignItems:"center",marginBottom:4}},f({style:{width:24,height:24,paddingRight:2},resizeMode:"contain",placeholder:{content:l()}}),Text({text:E.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_RESULT"),numberOfLines:1,ellipsize:"end",style:{color:i.colors.base1,fontSize:15,fontWeight:"400"}})),BBCodeText({testId:`${this.testId}WorkflowResultText`,linksUnderline:false,value:t,style:{color:i.colors.base4,fontSize:13,fontWeight:"400"},onLinkClick:({url:t})=>{if(e[t]){const s=e[t];const i=N(B,500);i({fileType:UI.File.getType(UI.File.getFileMimeType(s.type,s.name)),url:s.url,name:s.name});return}W.open(t,{parentWidget:this.layout})}}))}canCurrentUserDoTask(t){if(!t.canView||this.isTaskCompleted(t)){return false}const e=parseInt(env.userId,10);if(!y.isInteger(e)){return false}const s=t.users.find((t=>t.id===e));return y.isObjectLike(s)&&s.status===0}async openTaskDetails(t){const{TaskDetails:e}=await requireLazy("bizproc:task/details");this.props.layout.close((()=>e.open(this.parentLayout,{taskId:t})))}renderStep({wrapperOptions:t={showBorders:false},counterOptions:e={},titleOptions:{text:s,button:o,testId:n}={},header:r={},content:a=[],users:l=[],shouldHideUsers:c=false,usersTestId:u,additionalContent:d,footer:I}={}){if(!y.isArray(d)){d=[]}if(!y.isArray(a)){a=[]}const g={title:y.isString(r.title)?r.title:null,testId:y.isString(r.testId)?r.testId:null,timestamp:y.isNumber(r.timestamp)?r.timestamp:null,icon:y.isStringFilled(r.icon)?r.icon:null};if(y.isString(I)){I={text:I}}const f=y.isObjectLike(o);return p(t,m(e),h({style:{marginTop:f?5:12}},T({testId:n,text:s,button:o}),O(g),...a,_({ref:t=>{this.stepsUserList.push(t)},layout:this.props.layout,shouldHideUsers:c===true,testId:u,users:l.filter((t=>y.isObjectLike(t)&&t.id&&this.getUserDataById(t.id))).map((t=>w(t,this.getUserDataById(t.id))))}),...d,I&&View({style:{flexDirection:"row",marginTop:4,marginBottom:2}},BBCodeText({linksUnderline:false,value:I.text,onLinkClick:I.onLinkClick,style:{color:i.colors.base4,fontSize:12,fontWeight:"500"}}))))}renderStub(t){const e=y.isObjectLike(t.wrapperOptions)?t.wrapperOptions:{};return p(e,m(t.counterOptions),u(t,d()))}isTaskCompleted(t){return this.isTaskAccepted(t)||this.isTaskDeclined(t)}isTaskAccepted(t){return t.status===1||t.status===3}isTaskDeclined(t){return t.status===2||t.status===4||t.status===5}}s.exports={WorkflowTimeline:F}}));
//# sourceMappingURL=extension.map.js