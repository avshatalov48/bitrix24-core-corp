jn.define("bizproc/workflow/timeline",((t,e,s)=>{const i=t("apptheme");const{check:o,cross:n,documents:r,union:a,clock:l,flag:c}=t("bizproc/workflow/timeline/icons");const{ContentStub:d,UserStub:u,Counter:h,StepWrapper:m,StepContent:p,StepsListCollapsed:I}=t("bizproc/workflow/timeline/components");const{PureComponent:f}=t("layout/pure-component");const{SafeImage:g}=t("layout/ui/safe-image");const{Avatar:T}=t("layout/ui/user/avatar");const{Loc:O}=t("loc");const{dispatch:_}=t("statemanager/redux/store");const{usersAdded:L}=t("statemanager/redux/slices/users");const{ProfileView:E}=t("user/profile");const{Duration:k}=t("utils/date/duration");const{Type:w}=t("type");const S={all:"BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_ALL",any:"BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_ANY",vote:"BPMOBILE_WORKFLOW_TIMELINE_TASK_VOTING"};const M={1:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK",2:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO",3:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK",4:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO",5:"BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_NO"};class D extends f{static open(t=PageManager,e={}){t.openWidget("layout",{modal:true,titleParams:{text:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TITLE")},backgroundColor:i.colors.bgContentPrimary,backdrop:{onlyMediumPosition:false,mediumPositionPercent:90,navigationBarColor:i.colors.bgSecondary,swipeAllowed:true,swipeContentAllowed:false,horizontalSwipeAllowed:false},onReady:s=>{s.showComponent(new D({parentLayout:t,layout:s,workflowId:e.workflowId,taskId:e.taskId}))}})}constructor(t){super(t);this.testId="BpTimeline";this.state.timelineData=null;this.loadTimelineData().then((t=>{this.setState({timelineData:t});console.log("Timeline data:");console.log(t)})).catch((t=>console.warn(t)))}get workflowId(){return this.props.workflowId}get layout(){return this.props.layout}get parentLayout(){return this.props.parentLayout}get taskId(){const t=parseInt(this.props.taskId,10);return w.isNumber(t)?t:0}get taskExecutionTimeLimit(){return k.getLengthFormat().DAY/1e3*3}get timelineData(){return this.state.timelineData}getUserDataById(t){return this.timelineData.users.find((e=>e.id===t))}async loadTimelineData(){const t=await BX.ajax.runAction("bizprocmobile.Workflow.getTimeline",{data:{workflowId:this.workflowId}});for(const e of t.errors){console.log(e)}if(t.errors.length===0){const e=t.data;_(L(e.users));if(w.isArray(e.tasks)){e.tasks.sort(((t,e)=>{const s=this.isTaskCompleted(t);const i=this.isTaskCompleted(e);if(s&&!i){return-1}if(!s&&i){return 1}return t.id-e.id}))}return e}return{}}render(){return ScrollView({style:{}},this.renderContent())}renderContent(){if(this.timelineData){return View({style:{flexDirection:"column",paddingHorizontal:16,paddingVertical:12}},this.renderFirstStep(),...this.renderTasks(),this.renderLastStep())}return Loader({style:{width:75,height:75},animating:true})}renderFirstStep(){return this.renderStep({wrapperOptions:{showBorders:true,backgroundColor:i.colors.bgContentSecondary},counterOptions:{value:1,tailColor:this.timelineData.tasks.length>0||!this.timelineData.isWorkflowRunning?i.colors.base4:i.colors.base7},titleOptions:{text:this.timelineData.entityName,testId:`${this.testId}WorkflowText`},header:{title:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_STARTED_BY"),value:this.formatDate(this.timelineData.started)},users:[{id:this.timelineData.startedBy}],additionalContent:[this.renderDocument()],footer:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":w.isNumber(this.timelineData.timeToStart)?this.formatDuration(this.timelineData.timeToStart):""})})}formatDate(t){return DateFormatter.getDateString(t,"d MMMM kk:mm")}formatDuration(t){if(!w.isInteger(t)){return null}const e=k.createFromSeconds(t);const s=e.years;const i=e.months;if(s!==0){return new k((i>=6?s+1:s)*k.getLengthFormat().YEAR).format("Y")}const o=e.days;if(i!==0){return new k((o>=15?i+1:i)*k.getLengthFormat().MONTH).format("m")}const n=e.getUnitPropertyModByFormat("H");if(o!==0){return new k((n>=12?o+1:o)*k.getLengthFormat().DAY).format("d")}const r=e.minutes;if(n!==0){return new k((r>=30?n+1:n)*k.getLengthFormat().HOUR).format("H")}if(r!==0){return e.format("i")}return e.format("s")}renderDocument(){return View({style:{flexDirection:"column",paddingBottom:8}},View({style:{flexDirection:"row"}},g({style:{width:24,height:24,marginRight:2},resizeMode:"contain",placeholder:{content:this.getDocumentIconContent()}}),Text({testId:`${this.testId}DocumentModuleName`,text:w.isString(this.timelineData.moduleName)?`${this.timelineData.moduleName}:`:"",style:{color:i.colors.base1,fontSize:15,fontWeight:"400"}})),Text({testId:`${this.testId}DocumentName`,text:this.timelineData.documentName,style:{color:i.colors.accentMainLinks,fontSize:15,fontWeight:"400"}}))}getDocumentIconContent(){if(w.isArray(this.timelineData.documentType)){const t=w.isString(this.timelineData.documentType[0])?this.timelineData.documentType[0].toLowerCase():"";let e=w.isString(this.timelineData.documentType[2])?this.timelineData.documentType[2].toLowerCase():"";if(e.startsWith("dynamic")){e="dynamic"}if(t==="crm"&&e.startsWith("smart_")){e=e.slice("smart_".length)}return w.isObjectLike(r[t])&&w.isFunction(r[t][e])?r[t][e]():r.lists()}return r.lists()}renderTasks(){if(!this.timelineData.tasks||this.timelineData.tasks.length===0){return[]}const t=[];const e=[];const s=this.timelineData.tasks.length;const o=s-1;let n=i.colors.base4;for(const[r,a]of this.timelineData.tasks.entries()){const c=r===o;const d=this.isTaskCompleted(a);let u=i.colors.accentMainSuccess;if(!d){u=i.colors.accentMainPrimary}if(this.isTaskDeclined(a)){u=i.colors.base5}const h=c&&this.timelineData.isWorkflowRunning?i.colors.base7:i.colors.base4;let m=null;if(a.canView){const t={trunkColor:n,hasTail:true,tailColor:h,backgroundColor:u,value:r+2};let e=null;if(this.taskId!==a.id&&this.canCurrentUserDoTask(a)&&s>1){e={id:a.id,testId:`${this.testId}TaskButton_${a.id}`,text:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_START"),onclick:()=>{this.openTaskDetails(a.id).catch((t=>console.log(t)))}}}let o=O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_USER_STATUS_OK");if(!d){if(Object.hasOwn(S,a.approveType)&&a.users.length>0){const t=a.users.filter((t=>t.status!==0)).length;o=O.getMessage(S[a.approveType],{"#FINISHED_COUNT#":t,"#ALL_COUNT#":a.users.length})}else{o=O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_WAITING_FOR_SINGLE")}}else if(Object.hasOwn(M,a.status)){o=O.getMessage(M[a.status])}const c=a.users.map((t=>{let e=`${this.testId}User_${t.id}`;if(t.status===1||t.status===3){e+="_Accepted"}else if(t.status===2||t.status===4){e+="_Declined"}return{id:t.id,status:t.status,testId:e}}));let p=null;if(a.executionTime){p={};if(a.executionTime>this.taskExecutionTimeLimit){const t=i.colors.accentMainLinks;p.footer={text:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":`[color=${t}][url]${this.formatDuration(a.executionTime)}[/url][/color]`}),onLinkClick:()=>InAppNotifier.showNotification({message:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TIME_LIMIT_EXCEEDED"),code:"bp-workflow-timeline-execution-time-exceeded",time:3})}}else{p.footer=O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXECUTION_TIME",{"#DURATION#":this.formatDuration(a.executionTime)})}}m=this.renderStep({wrapperOptions:{showBorders:false},counterOptions:t,titleOptions:{text:a.name,testId:`${this.testId}TaskTitle_${a.id}`,button:e},header:{title:{text:o,testId:`${this.testId}Task_${a.id}_Status`},value:this.isTaskCompleted(a)?this.formatDate(a.modified):{iconContent:l()}},users:c,usersTestId:`${this.testId}Task_${a.id}_Users`,...p})}else{m=this.renderStub({title:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_TASK_RIGHTS_ERROR"),wrapperOptions:{showBorders:false},counterOptions:{value:r+2,hasTail:true,tailColor:h,trunkColor:n}})}if(m){if(d){e.push(m)}else{t.push(m)}}n=h}if(e.length>0){t.unshift(this.renderCollapsedTasks(e,{tailColor:t.length>0||!this.timelineData.isWorkflowRunning?i.colors.base4:i.colors.base7}))}return t}renderCollapsedTasks(t,e=null){return I({text:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_MORE_TASKS"),steps:t,collapsedButtonTestId:`${this.testId}CollapsedButton`,counterOptions:e})}renderLastStep(){if(this.timelineData.isWorkflowRunning){return this.renderStub({title:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_CONTINUE_EXECUTION"),wrapperOptions:{},counterOptions:{hasTail:false,backgroundColor:i.colors.base7,size:11,trunkColor:i.colors.base7}})}const t=this.timelineData.tasks.at(-1);const e=w.isObjectLike(t)?this.formatDate(t.modified):null;const s=!w.isObjectLike(t)||this.isTaskAccepted(t);return this.renderStep({wrapperOptions:{showBorders:true,borderOptions:{color:s?i.colors.accentMainSuccess:null},backgroundColor:s?i.colors.accentSoftGreen3:null},counterOptions:{hasTail:false,trunkColor:i.colors.base4,iconContent:a()},titleOptions:{text:this.timelineData.entityName,testId:`${this.testId}LastStepTitle`},header:{title:{text:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_COMPLETED"),testId:`${this.testId}LastStepStatus`},value:e},content:w.isObjectLike(t)?[this.renderExtendedTaskStatus(t)]:[],users:[{id:this.timelineData.startedBy}],footer:O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_WORKFLOW_EXECUTION_TIME",{"#DURATION#":this.formatDuration(this.timelineData.executionTime)})})}renderExtendedTaskStatus(t){if(!t.canView){return View()}const e=this.isTaskAccepted(t);return View({style:{flexDirection:"row",alignItems:"center"}},g({style:{width:24,height:24,paddingRight:2},resizeMode:"contain",placeholder:{content:e?c():n({color:i.colors.base3})}}),Text({text:e?O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXTENDED_TASK_STATUS_ACCEPTED"):O.getMessage("BPMOBILE_WORKFLOW_TIMELINE_EXTENDED_TASK_STATUS_DECLINED"),numberOfLines:1,ellipsize:"end",style:{color:i.colors.base1,fontSize:15,fontWeight:"400"}}))}canCurrentUserDoTask(t){if(!t.canView||this.isTaskCompleted(t)){return false}const e=parseInt(env.userId,10);if(!w.isInteger(e)){return false}const s=t.users.find((t=>t.id===e));return w.isObjectLike(s)&&s.status===0}async openTaskDetails(t){const{TaskDetails:e}=await requireLazy("bizproc:task/details");this.props.layout.close((()=>e.open(this.parentLayout,{taskId:t})))}renderStep({wrapperOptions:t={showBorders:false},counterOptions:e={},titleOptions:{text:s,button:o,testId:n}={},header:r={},content:a=[],users:l=[],usersTestId:c,additionalContent:d,footer:u}={}){if(!w.isArray(d)){d=[]}if(!w.isArray(a)){a=[]}if(w.isString(r.title)){r.title={text:r.title,testId:undefined}}if(w.isString(r.value)){r.value={text:r.value}}else if(!w.isObjectLike(r.value)){r.value={}}if(w.isString(u)){u={text:u}}const I=l.length>1;const f=w.isObjectLike(o);return m(t,h(e),p({style:{marginTop:f?5:12}},View({style:{flexDirection:"row",alignItems:"center",marginBottom:4,justifyContent:"space-between"}},s&&Text({testId:n,text:s,numberOfLines:2,ellipsize:"end",style:{paddingTop:f?5:null,alignSelf:"flex-start",flexShrink:2,fontSize:15,fontWeight:"600",color:i.colors.base1}}),f&&View({style:{height:36,justifyContent:"center",marginLeft:15}},View({testId:o.testId,style:{width:110,height:22,justifyContent:"center",alignItems:"center",borderStyle:"solid",borderWidth:1.2,borderColor:i.colors.accentMainPrimary,borderRadius:24},onClick(){o.onclick(o.id)}},Text({text:o.text,style:{fontSize:12,fontWeight:"500",color:i.colors.accentMainPrimary}})),Text({style:{position:"absolute",top:0,right:0,width:18,height:18,borderRadius:9,backgroundColor:i.colors.accentMainAlert,textAlign:"center",color:i.colors.baseWhiteFixed,fontSize:12,fontWeight:"500"},text:"1"}))),r&&View({style:{flexDirection:"row",justifyContent:"space-between",alignContent:"center",marginTop:4,marginBottom:2,paddingBottom:8}},Text({text:r.title.text,testId:r.title.testId,style:{color:i.colors.base4,fontSize:11,fontWeight:"500"}}),r.value.text&&Text({text:r.value.text,style:{color:i.colors.base4,fontSize:12,fontWeight:"500"}}),!r.value.text&&r.value.iconContent&&g({style:{width:18,height:18},resizeMode:"contain",placeholder:{content:r.value.iconContent}})),...a,View({testId:c,style:{paddingBottom:2}},...l.map((t=>this.renderUser(t,I)))),...d,u&&View({style:{flexDirection:"row",marginTop:4,marginBottom:2}},BBCodeText({linksUnderline:false,value:u.text,onLinkClick:u.onLinkClick,style:{color:i.colors.base4,fontSize:12,fontWeight:"500"}}))))}renderStub(t){const e=w.isObjectLike(t.wrapperOptions)?t.wrapperOptions:{};return m(e,h(t.counterOptions),d(t,u()))}renderUser(t,e=true){if(w.isObjectLike(t)&&t.id&&this.getUserDataById(t.id)){const s=this.getUserDataById(t.id);return View({style:{flexDirection:"row",alignItems:"center",paddingBottom:6},onClick:()=>this.openUserProfile(t.id)},T({id:t.id}),View({style:{flex:1,flexDirection:"column",marginHorizontal:6}},View({style:{flexDirection:"row",alignItems:"center"}},Text({testId:t.testId,style:{textAlign:"center",fontSize:15,fontWeight:"400",color:i.colors.accentMainLinks},numberOfLines:1,text:s.fullName}),e&&t.status&&this.renderUserStatus(t)),s.workPosition&&Text({style:{fontSize:13,fontWeight:"400",color:i.colors.base4},numberOfLines:1,ellipsize:"end",text:s.workPosition})))}return View()}renderUserStatus(t){if(w.isObjectLike(t)){const e=t.status===1||t.status===3;const s=t.status===2||t.status===4;if(!e&&!s){return null}const r=e?o({color:i.colors.accentMainSuccess}):n({color:i.colors.base4});return View({style:{marginLeft:8,borderRadius:4,borderStyle:"solid",borderWidth:1,borderColor:e?i.colors.accentMainSuccess:i.colors.base4}},g({style:{width:16,height:16},resizeMode:"contain",placeholder:{content:r}}))}return null}isTaskCompleted(t){return this.isTaskAccepted(t)||this.isTaskDeclined(t)}isTaskAccepted(t){return t.status===1||t.status===3}isTaskDeclined(t){return t.status===2||t.status===4||t.status===5}openUserProfile(t){this.props.layout.openWidget("list",{groupStyle:true,backdrop:{bounceEnable:false,swipeAllowed:true,showOnTop:true,hideNavigationBar:false,horizontalSwipeAllowed:false}}).then((e=>E.open({userId:t,isBackdrop:true},e))).catch((t=>console.log(t)))}}s.exports={WorkflowTimeline:D}}));
//# sourceMappingURL=extension.map.js