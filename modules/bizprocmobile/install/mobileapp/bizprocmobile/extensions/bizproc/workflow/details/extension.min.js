jn.define("bizproc/workflow/details",((t,e,o)=>{const i=t("apptheme");const{Alert:s}=t("alert");const{Loc:n}=t("loc");const{NotifyManager:l}=t("notify-manager");const{EventEmitter:r}=t("event-emitter");const{Feature:a}=t("feature");const{Haptics:d}=t("haptics");const{PureComponent:h}=t("layout/pure-component");const{FocusManager:c}=t("layout/ui/fields/focus-manager");const{WorkflowComments:u}=t("bizproc/workflow/comments");const{WorkflowDetailsSkeleton:w}=t("bizproc/workflow/details/skeleton");const{WorkflowDetailsContent:f}=t("bizproc/workflow/details/content");class m extends h{static open(t,e=PageManager){e.openWidget("layout",{modal:true,titleParams:{text:t.title||n.getMessage("M_BP_WORKFLOW_DETAILS_WIDGET_TITLE"),textColor:i.colors.base1,type:"dialog"},backgroundColor:i.colors.bgSecondary,backdrop:{mediumPositionPercent:90,onlyMediumPosition:true,swipeAllowed:true,swipeContentAllowed:true,horizontalSwipeAllowed:false,hideNavigationBar:false,navigationBarColor:i.colors.bgSecondary},onReady:o=>{o.showComponent(new m({parentLayout:e,layout:o,workflowId:t.workflowId||null}))}})}constructor(t){super(t);this.state={workflow:null,editorConfig:null,taskCount:0,commentCounter:null,canView:false,showTimeline:false,additionalContent:null,additionalContentIsLoaded:false,showRightError:true};this.workflowId=t.workflowId;this.isClosing=false;this.isChanged=false;this.scrollViewRef=null;this.scrollY=0;this.uid=t.uid||Random.getString();this.customEventEmitter=r.createWithUid(this.uid);this.handleExit=this.handleExit.bind(this);this.handleScrollToInvalidField=this.handleScrollToInvalidField.bind(this);this.handleScrollToFocusedField=this.handleScrollToFocusedField.bind(this)}get layout(){return this.props.layout}get parentLayout(){return this.props.parentLayout}get workflow(){return this.state.workflow}get isLoaded(){return this.workflow!==null&&this.state.additionalContentIsLoaded===true}componentDidMount(){super.componentDidMount();this.customEventEmitter.on("UI.EntityEditor::onScrollToInvalidField",this.handleScrollToInvalidField).on("UI.EntityEditor::onScrollToFocusedField",this.handleScrollToFocusedField);if(a.isPreventBottomSheetDismissSupported()){this.layout.preventBottomSheetDismiss(true);this.layout.on("preventDismiss",this.handleExit)}this.loadWorkflow()}componentWillUnmount(){super.componentWillUnmount();this.customEventEmitter.off("UI.EntityEditor::onScrollToInvalidField",this.handleScrollToInvalidField).off("UI.EntityEditor::onScrollToFocusedField",this.handleScrollToFocusedField);if(a.isPreventBottomSheetDismissSupported()){this.layout.preventBottomSheetDismiss(false);this.layout.off("preventDismiss",this.handleExit)}}handleExit(){if(this.isClosing){return Promise.resolve()}let t=Promise.resolve();if(this.isChanged){const e=t=>()=>t();const o=t=>()=>t();t=t.then((()=>new Promise(((t,i)=>{this.showConfirmExit(e(t),o(i))}))))}return t.then((()=>{this.isClosing=true;this.layout.close()}))}showConfirmExit(t,e){d.impactLight();s.confirm(n.getMessage("M_BP_WORKFLOW_DETAILS_CONFIRM_EXIT_TITLE"),n.getMessage("M_BP_WORKFLOW_DETAILS_CONFIRM_EXIT_DESCRIPTION"),[{text:n.getMessage("M_BP_WORKFLOW_DETAILS_CONFIRM_EXIT_EXIT"),type:"destructive",onPress:t},{text:n.getMessage("M_BP_WORKFLOW_DETAILS_CONFIRM_EXIT_CONTINUE"),type:"cancel",onPress:e}])}handleScrollToInvalidField(t){if(this.scrollViewRef&&t){const e=this.scrollViewRef.getPosition(t);e.y-=50;this.scrollViewRef.scrollTo({...e,animated:true})}}handleScrollToFocusedField(t){if(this.scrollViewRef&&t){const{y:e}=this.scrollViewRef.getPosition(t);if(e>this.scrollY+device.screen.height*.4){const t=e-150;this.scrollViewRef.scrollTo({y:t,animated:true})}}}loadWorkflow(){BX.ajax.runAction("bizprocmobile.Workflow.loadDetails",{data:{workflowId:this.workflowId}}).then((t=>{const e=t.data.isLiveFeedProcess||false;const o=t.data.editor||null;const i=t.data.taskCount||0;const s=t.data.commentCounter;const l=t.data.canViewWorkflow||false;if(e){this.state.workflow={};this.state.editorConfig=o;this.state.taskCount=i;this.state.commentCounter=s;this.state.canView=l;this.state.showTimeline=true;this.state.showRightError=false;this.loadListsDetails(t.data.documentId)}else{const e=t.data.workflow||{};this.layout.setTitle({text:e.title||n.getMessage("M_BP_WORKFLOW_DETAILS_WIDGET_TITLE"),type:"dialog"});this.setState({workflow:e,editorConfig:o,taskCount:i,commentCounter:s,canView:l,additionalContentIsLoaded:true,showTimeline:true})}})).catch((t=>{console.error(t.errors);if(Array.isArray(t.errors)){l.showErrors(t.errors)}this.setState({workflow:{},additionalContentIsLoaded:true,canView:true})}))}loadListsDetails(t){void requireLazy("lists:element-details",false).then((({ElementDetails:e})=>{if(!e){this.setState({additionalContentIsLoaded:true});return}const o=new e({uid:this.uid,layout:this.layout,isEmbedded:true,isNeedShowSkeleton:false,elementId:t,interceptExit:false});this.setState({additionalContent:o});this.customEventEmitter.once("Lists.ElementDetails:OnAfterLoadContent",(()=>{this.setState({additionalContentIsLoaded:true})})).on("Lists.ElementDetails:onChange",(t=>{this.isChanged=t}));o.loadDetails()}))}render(){return View({style:{flex:1,backgroundColor:i.colors.bgSecondary},resizableByKeyboard:true,safeArea:{bottom:true}},ScrollView({style:{flex:1},ref:t=>{this.scrollViewRef=t},onScroll:t=>{this.scrollY=t.contentOffset.y}},View({onClick:()=>c.blurFocusedFieldIfHas()},!this.isLoaded&&new w({}),this.isLoaded&&View({style:{flexDirection:"column",backgroundColor:i.colors.bgContentPrimary,minHeight:device.screen.height*.85-250,paddingHorizontal:6,paddingVertical:12}},View({style:{flexGrow:1,flexDirection:"column"}},this.state.additionalContent,new f({uid:this.uid,layout:this.layout,workflow:this.state.workflow,editorConfig:this.state.editorConfig,canView:this.state.canView,showRightError:this.state.showRightError})),this.state.showTimeline&&this.renderTimelineButton()),View({style:{height:100}}))),this.isLoaded&&new u({workflowId:this.workflowId,commentCounter:this.state.commentCounter}))}renderTimelineButton(){return View({style:{marginHorizontal:10,height:48,flexDirection:"row",alignItems:"flex-end"}},View({style:{paddingHorizontal:10,height:36,borderRadius:8,borderWidth:1,borderColor:i.colors.base5,justifyContent:"center"},onClick:()=>{if(this.isChanged){this.showConfirmExit((()=>{this.openTimeline()}));return}this.openTimeline()}},Text({testId:"WORKFLOW_DETAILS_TIMELINE",style:{fontWeight:"500",fontSize:14,color:i.colors.base2},text:n.getMessage("M_BP_WORKFLOW_DETAILS_TIMELINE_BTN_MSGVER_1")})),this.renderCounter())}renderCounter(){const t=this.state.taskCount;return t>0&&Text({style:{position:"absolute",top:5,borderRadius:9,backgroundColor:i.colors.accentMainAlert,textAlign:"center",color:i.colors.baseWhiteFixed,fontSize:12,fontWeight:"400",minWidth:18,height:18,paddingHorizontal:2},text:String(t)})}openTimeline(){void requireLazy("bizproc:workflow/timeline").then((({WorkflowTimeline:t})=>{void this.props.layout.close((()=>{void t.open(this.props.parentLayout,{workflowId:this.workflowId})}))}))}}o.exports={WorkflowDetails:m}}));
//# sourceMappingURL=extension.map.js