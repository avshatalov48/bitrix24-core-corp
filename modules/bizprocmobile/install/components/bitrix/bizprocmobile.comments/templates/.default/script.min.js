(function(e,t,s){"use strict";var n=t.Reflection.namespace("BX.BizprocMobile");var i=function(){babelHelpers.createClass(e,null,[{key:"block",get:function e(){return{comments:"comments",stub:"stub"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.workflowId=t.workflowId;this.workflowIdInt=t.workflowIdInt;this.guid=t.guid;this.canReadCommentsOnInit=true;this.timeout=0;this.timeoutSec=2e3;this.commentsList=null;this.unreadComments=new Map;this.commentsToRead=new Map;this.initTextField();this.initCommentsBlock();this.sendEvents(t);this.bindEvents()}babelHelpers.createClass(e,[{key:"initTextField",value:function e(){if(BX.MobileUI.TextField.defaultParams){window.BX.MobileUI.TextField.show()}else{s.EventEmitter.subscribe(BX.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,(function(){return window.BX.MobileUI.TextField.show()}))}}},{key:"initCommentsBlock",value:function t(){this.stub=BX("commentsStub");this.commentsBlock=BX("workflow-comments-block");var s=BX("post-comments-wrap").querySelector(".post-comment-block");this.resolveVisibility(s?e.block.comments:e.block.stub)}},{key:"resolveVisibility",value:function s(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:e.block.stub;var i="--hidden";if(n===e.block.stub){if(t.Dom.hasClass(this.stub,i)){t.Dom.removeClass(this.stub,i)}if(!t.Dom.hasClass(this.commentsBlock,i)){t.Dom.addClass(this.commentsBlock,i)}}else if(n===e.block.comments){if(t.Dom.hasClass(this.commentsBlock,i)){t.Dom.removeClass(this.commentsBlock,i)}if(!t.Dom.hasClass(this.stub,i)){t.Dom.addClass(this.stub,i)}}}},{key:"sendEvents",value:function e(t){if(t.logId){var s={log_id:t.logId,ts:t.currentTs,bPull:false};BXMobileApp.onCustomEvent("onLogEntryRead",s,true)}}},{key:"bindEvents",value:function n(){var i=this;s.EventEmitter.subscribe("OnUCHasBeenInitialized",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],o=s[1];if(n==="WF_".concat(i.workflowId)){i.commentsList=o;i.commentsList.canCheckVisibleComments=true;i.unreadComments=new Map(i.commentsList.unreadComments)}}));s.EventEmitter.subscribe("onUCFormSubmit",(function(){return i.resolveVisibility(e.block.comments)}));s.EventEmitter.subscribe("OnUCCommentWasPulled",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),o=n[0],m=n[1];if(o[0]==="WF_".concat(i.workflowId)){var a=m.messageFields.AUTHOR;if(Number(a.ID)!==Number(i.userId)){i.unreadComments.set(o[1],new Date)}i.resolveVisibility(e.block.comments)}}));s.EventEmitter.subscribe("OnUCommentWasDeleted",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),o=n[0],m=n[1];var a=m[1];if(o==="WF_".concat(i.workflowId)){if(i.commentsList.getCommentsCount()<=0){i.resolveVisibility(e.block.stub)}i.unreadComments["delete"](a)}}));s.EventEmitter.subscribe("OnUCCommentWasRead",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],o=s[1];var m=o[1];if(n==="WF_".concat(i.workflowId)&&i.unreadComments.has(m)){i.commentsToRead.set(m,i.unreadComments.get(m));i.unreadComments["delete"](m);i.sendOnCommentsReadEvent(i.unreadComments.size);if(i.timeout<=0){i.timeout=setTimeout((function(){return i.readComments()}),i.timeoutSec)}}}));t.Event.bind(document,"visibilitychange",(function(){return i.setCanCheckVisibleComments(!document.hidden)}));t.Event.bind(window,"pagehide",(function(){return i.setCanCheckVisibleComments(false)}));t.Event.bind(window,"pageshow",(function(){return i.setCanCheckVisibleComments(true)}));BX.MobileUI.addLivefeedLongTapHandler(this.commentsBlock,{likeNodeClass:"post-comment-control-item-like"})}},{key:"setCanCheckVisibleComments",value:function e(s){if(s&&this.canReadCommentsOnInit){this.canReadCommentsOnInit=false;this.readComments()}if(!this.commentsList){return}this.commentsList.canCheckVisibleComments=s;if(s){var n=t.GetWindowScrollPos();var i={top:n.scrollTop,bottom:n.scrollTop+t.GetWindowInnerSize().innerHeight};this.commentsList.checkVisibleComments(i);if(this.canReadCommentsOnInit){this.canReadCommentsOnInit=false;this.readComments()}}}},{key:"sendOnCommentsReadEvent",value:function e(){}},{key:"readComments",value:function e(){this.timeout=0;this.commentsToRead.clear();void BX.ajax.runAction("bizproc.workflow.comment.markAsRead",{data:{workflowId:this.workflowId,userId:this.userId}})}}]);return e}();n.Comments=i;e.default=i})(this.window=this.window||{},BX,BX.Event);
//# sourceMappingURL=script.map.js