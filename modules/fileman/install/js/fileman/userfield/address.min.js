(function(){"use strict";BX.namespace("BX.Fileman.UserField");if(typeof BX.Fileman.UserField.TypeAddress!=="undefined"){return}BX.Fileman.UserField.TypeAddress=function(){};BX.extend(BX.Fileman.UserField.TypeAddress,BX.Main.UF.BaseType);BX.Fileman.UserField.TypeAddress.USER_TYPE_ID="address";BX.Fileman.UserField.TypeAddress.prototype.focus=function(e){var t=this.getNode(e);if(!BX.isNodeInDom(t)){console.error("Node for field "+e+" is already removed from DOM")}var s=BX.findChild(t,{tagName:"INPUT",attribute:{type:"text"}},true);if(s){BX.focus(s)}};BX.Fileman.UserField.Address=function(e,t){this.node=e;this.inputListNode=null;this.value=t.value;this.autocomplete=t.autocomplete||null;this.geocoder=t.geocoder||null;this.map=t.map||null;this.resultDisplay=t.resultDisplay||null;this.multiple=!!t.multiple;this.inputObjects=[];BX.ready(BX.delegate(this.init,this))};BX.Fileman.UserField.Address.prototype.init=function(){this.inputListNode=this.node.appendChild(BX.create("DIV"));for(var e=0;e<this.value.length;e++){this.addSearchInput(this.value[e]);if(!this.multiple){break}}if(this.multiple){BX.addClass(this.inputListNode,"multiple");this.inputListNode.appendChild(BX.create("INPUT",{attrs:{type:"button",value:BX.message("UF_ADDRESS_ADD")},events:{click:BX.delegate(function(){this.addSearchInput(false)},this)}}))}BX.defer(this.callChangeEvent,this)()};BX.Fileman.UserField.Address.prototype.isMapEnabled=function(){return true};BX.Fileman.UserField.Address.prototype.callChangeEvent=function(e,t){BX.onCustomEvent(this,"UserFieldAddress::Change",[this.getValue()])};BX.Fileman.UserField.Address.prototype.getValue=function(){var e=[];for(var t=0;t<this.inputObjects.length;t++){if(!!this.inputObjects[t]){e.push(this.inputObjects[t].getResult())}}return e};BX.Fileman.UserField.Address.prototype.addSearchInput=function(e){var t=BX.create("DIV",{props:{className:"field-item"}});this.inputListNode.insertBefore(t,this.inputListNode.lastChild);var s=BX.create("input",{attrs:{type:"text",tabindex:"0"},props:{className:"uf-address-search-input"}});t.appendChild(s);var i=new BX.Fileman.UserField.AddressSearchField(this,s,e);var o=this.inputObjects.length;this.inputObjects.push(i);if(this.multiple){t.appendChild(BX.create("SPAN",{props:{className:"uf-address-search-input-remove"},events:{click:BX.delegate(function(){this.inputObjects[o]=null;BX.cleanNode(t,true);this.callChangeEvent()},this)}}))}};BX.Fileman.UserField.Address.prototype.getAutoComplete=function(){if(this.autocomplete===null){this.setDefaultAutoComplete()}return this.autocomplete};BX.Fileman.UserField.Address.prototype.setAutoComplete=function(e){this.autocomplete=e};BX.Fileman.UserField.Address.prototype.setDefaultAutoComplete=function(){this.setAutoComplete(new BX.Fileman.Google.AutoComplete)};BX.Fileman.UserField.Address.prototype.getGeoCoder=function(){if(this.geocoder===null){this.setDefaultGeoCoder()}return this.geocoder};BX.Fileman.UserField.Address.prototype.setGeoCoder=function(e){this.geocoder=e};BX.Fileman.UserField.Address.prototype.setDefaultGeoCoder=function(){this.setGeoCoder(new BX.Fileman.Google.GeoCoder)};BX.Fileman.UserField.Address.prototype.getMap=function(){return this.map};BX.Fileman.UserField.Address.prototype.setMap=function(e){this.map=e};BX.Fileman.UserField.Address.prototype.getResultDisplay=function(){if(!this.resultDisplay){this.setDefaultResultDisplay()}return this.resultDisplay};BX.Fileman.UserField.Address.prototype.setResultDisplay=function(e){this.resultDisplay=e};BX.Fileman.UserField.Address.prototype.setDefaultResultDisplay=function(){this.setResultDisplay(new BX.Fileman.UserField.AddressSearchResultDisplay(this))};BX.Fileman.UserField.AddressSearchField=function(e,t,s){this.dispatcher=e;this.input=t;this.text="";this.coords=null;this.tmpCoords=null;if(!!s){this.text=s;if(s.indexOf("|")>=0){s=s.split("|");this.text=s[0];if(!!s[1]&&s[1].indexOf(";")>0){this.coords=s[1].split(";")}}}this.input.value=this.text;var i=BX.debounce(this.onChangeValue,150,this);BX.bind(this.input,"click",BX.proxy(this.captureMap,this));BX.bind(this.input,"bxchange",i);BX.unbind(this.input,"blur",i);BX.unbind(this.input,"change",i)};BX.Fileman.UserField.AddressSearchField.prototype.hasCoordinates=function(){return this.coords!==null};BX.Fileman.UserField.AddressSearchField.prototype.getResult=function(){return{coords:this.coords,text:this.text}};BX.Fileman.UserField.AddressSearchField.prototype.getNode=function(){return this.input};BX.Fileman.UserField.AddressSearchField.prototype.display=function(){if(this.hasCoordinates()){this.dispatcher.getResultDisplay().display(this,[{text:this.text,coords:this.coords,local:true}],BX.proxy(this.saveValue,this),BX.proxy(this.displayChanged,this))}else{this.dispatcher.getResultDisplay().close()}};BX.Fileman.UserField.AddressSearchField.prototype.captureMap=function(){this.display()};BX.Fileman.UserField.AddressSearchField.prototype.onChangeValue=function(e){if(this.input.value!==this.text||!this.coords){this.text=this.input.value;if(this.text.length>0){this.dispatcher.getAutoComplete().search(this.text,BX.proxy(this.searchCallback,this))}else{this.coords=null}this.dispatcher.callChangeEvent()}};BX.Fileman.UserField.AddressSearchField.prototype.displayChanged=function(e){this.tmpCoords=e;this.dispatcher.getGeoCoder().search(e,BX.proxy(this.coordsSearchCallback,this))};BX.Fileman.UserField.AddressSearchField.prototype.searchCallback=function(e){if(e.length<=0){this.coords=null;this.dispatcher.callChangeEvent();this.dispatcher.getResultDisplay().display(this,e,BX.proxy(this.saveValue,this),BX.proxy(this.displayChanged,this))}else{this.lastResult=e;this.dispatcher.getGeoCoder().search(e[0].place_id,BX.proxy(this.searchCoordsCallback,this))}};BX.Fileman.UserField.AddressSearchField.prototype.searchCoordsCallback=function(e){if(e.length<=0){this.coords=null}else{this.coords=e[0].coords;this.lastResult[0].coords=this.coords}this.dispatcher.getResultDisplay().display(this,this.lastResult,BX.proxy(this.saveValue,this),BX.proxy(this.displayChanged,this));this.dispatcher.callChangeEvent()};BX.Fileman.UserField.AddressSearchField.prototype.coordsSearchCallback=function(e){this.dispatcher.getResultDisplay().setContent(this,[{text:e[0].text,coords:this.tmpCoords}],BX.proxy(this.saveValue,this));this.tmpCoords=null};BX.Fileman.UserField.AddressSearchField.prototype.saveValue=function(e){this.text=e.text;this.coords=e.coords;this.input.value=this.text;this.dispatcher.getResultDisplay().close();this.dispatcher.callChangeEvent(this,[this.text,this.coords])};BX.Fileman.UserField.AddressSearchResultDisplay=function(e){this.dispatcher=e;this.resultNode=null};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.display=function(e,t,s,i){if(t.length>0){if(!t[0].local){var o=[];for(var n=0;n<t.length;n++){o.push(this.createResultRow(t[n],e.getNode(),s,i))}BX.Fileman.UserField.addressSearchResultDisplayList.show(e.getNode(),o)}if(this.dispatcher.isMapEnabled()&&t[0].coords){BX.Fileman.UserField.addressSearchResultDisplayMap.show(e.getNode(),t[0],s,i)}else{BX.Fileman.UserField.addressSearchResultDisplayMap.close()}}else{BX.Fileman.UserField.addressSearchResultDisplayList.show(e.getNode(),[{text:BX.message("UF_ADDRESS_NO_RESULT")}]);BX.Fileman.UserField.addressSearchResultDisplayMap.close()}};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.setContent=function(e,t,s){if(t.length>0){BX.Fileman.UserField.addressSearchResultDisplayMap.setContent(t[0].text)}};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.createResultRow=function(e,t,s,i){return{text:e.text,className:"uf-search-result-list-item",events:{onMouseEnter:BX.delegate(this.resultHoverHandler(e,t,s,i),this)},onclick:BX.delegate(this.resultClickHandler(e,s),this)}};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.resultClickHandler=function(e,t){return function(s){t(e);return(s||window.event).preventDefault()}};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.resultHoverHandler=function(e,t,s,i){var o=this.dispatcher.getGeoCoder();return function(n){if(!!e.coords){BX.Fileman.UserField.addressSearchResultDisplayMap.show(t,e,s,i)}else if(!!e.place_id){o.search(e.place_id,function(o){e.coords=o[0].coords;BX.Fileman.UserField.addressSearchResultDisplayMap.show(t,e,s,i)})}}};BX.Fileman.UserField.AddressSearchResultDisplay.prototype.close=function(){BX.Fileman.UserField.addressSearchResultDisplayList.close();BX.Fileman.UserField.addressSearchResultDisplayMap.close()};BX.Fileman.UserField.AddressSearchResultDisplayList=function(){this.node=null;this.bindNode=null};BX.Fileman.UserField.AddressSearchResultDisplayList.prototype.show=function(e,t){this.bindNode=e;BX.PopupMenu.destroy("uf_address_result_list");BX.PopupMenu.show("uf_address_result_list",this.bindNode,t);BX.PopupMenu.getCurrentMenu().getPopupWindow().popupContainer.style.width=this.bindNode.offsetWidth+"px"};BX.Fileman.UserField.AddressSearchResultDisplayList.prototype.close=function(){BX.PopupMenu.destroy("uf_address_result_list")};BX.Fileman.UserField.AddressSearchResultDisplayMap=function(){this.node=null;this.map=null;this.point=null;this.currentItem=null;this.bindNode=null;this.infoWindowContent=null;this.opened=false;this.animation=null;this.hoverMode=false;this.mapHoverHandler=null;this.mapHoutHandler=null};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.showDelayed=function(e,t,s,i){this.opened=true;this.bindNode=e;setTimeout(BX.delegate(function(){if(this.opened&&this.bindNode===e){this.show(e,t,s,i)}},this),150)};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.showHover=function(e,t,s,i){this.hoverMode=true;if(e!==this.bindNode){this.show(e,t,s,i)}else{this.showDelayed(e,t,s,i)}};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.closeHover=function(e){this.closeDelayed()};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.show=function(e,t,s,i){if(this.hoverMode&&e===this.bindNode&&!BX.isNodeHidden(this.getNode())){this.opened=true;return}this.bindNode=e;this.currentItem=t;this.adjustNode(this.bindNode);if(this.animation!==null){this.animation.stop(true)}if(BX.isNodeHidden(this.getNode())||this.hoverMode){if(this.hoverMode){if(this.mapHoverHandler){BX.unbind(this.getNode(),"mouseover",this.mapHoverHandler);BX.unbind(this.getNode(),"mouseout",this.mapHoutHandler)}this.mapHoverHandler=BX.delegate(function(){this.showHover(e,t,s,i)},this);this.mapHoutHandler=BX.delegate(function(){this.closeHover(e)},this);BX.bind(this.getNode(),"mouseover",this.mapHoverHandler);BX.bind(this.getNode(),"mouseout",this.mapHoutHandler)}else{BX.unbind(this.getNode(),"mouseover",this.mapHoverHandler);BX.unbind(this.getNode(),"mouseout",this.mapHoutHandler);this.mapHoverHandler=null;this.mapHoutHandler=null}if(BX.isNodeHidden(this.getNode())){this.getNode().style.display="block";this.getNode().style.opacity=0;BX.Fileman.Google.Loader.init(BX.delegate(function(){this.animation=new BX.easing({duration:300,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.linear,step:BX.delegate(function(e){this.getNode().style.opacity=e.opacity/100},this),complete:BX.delegate(function(){this.getNode().style.opacity=1;this.animation=null},this)});this.animation.animate()},this))}}if(this.map===null){this.map=new BX.Fileman.Google.Map(this.getNode(),{zoom:18,center:t.coords})}else if(!!t.coords){this.map.panTo(t.coords)}if(this.point===null){this.point=this.map.addPoint(t.coords)}else{this.point.moveTo(t.coords)}if(!!i){this.point.setEvent("change",function(e){i(e)})}else{this.point.setEvent("change",null)}this.point.setDraggable(!this.hoverMode);this.infoWindowContent=BX.create("SPAN",{text:t.text,props:{className:"uf-address-search-onmap-result"},events:{click:function(){if(!!s&&BX.type.isFunction(s)){s(t)}}}});this.point.setContent(this.infoWindowContent);if(!this.hoverMode){BX.bind(this.bindNode,"mouseup",BX.PreventDefault);BX.bind(document.body,"mouseup",BX.proxy(this.closeDelayed,this))}};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.setContent=function(e){BX.adjust(this.infoWindowContent,{text:e});this.currentItem.text=e;this.currentItem.coords=this.point.getPosition()};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.closeDelayed=function(){var e=this.bindNode;this.opened=false;setTimeout(BX.delegate(function(){if(!this.opened&&e===this.bindNode){this.close()}},this),200)};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.close=function(){this.opened=false;this.hoverMode=false;if(this.animation!==null){this.animation.stop(true)}if(!!this.node&&!BX.isNodeHidden(this.node)){this.getNode().style.display="block";this.getNode().style.opacity=1;this.animation=new BX.easing({duration:300,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.linear,step:BX.delegate(function(e){this.getNode().style.opacity=e.opacity/100},this),complete:BX.delegate(function(){BX.hide(this.node);this.animation=null},this)});this.animation.animate()}BX.unbind(this.bindNode,"mouseup",BX.PreventDefault);BX.unbind(document.body,"mouseup",BX.proxy(this.closeDelayed,this))};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.getNode=function(){if(this.node===null){this.node=BX.create("DIV",{props:{className:"uf-address-search-map"},style:{display:"none"},events:{mouseup:BX.PreventDefault}})}return this.node};BX.Fileman.UserField.AddressSearchResultDisplayMap.prototype.adjustNode=function(e){var t=BX.pos(e);var s=BX.GetWindowSize();var i=s.scrollHeight;var o=s.scrollTop+s.innerHeight;if(!!BX.Crm&&!!BX.Crm.EntityEditor&&!!BX.Crm.EntityEditor.defaultInstance&&!!BX.Crm.EntityEditor.defaultInstance._toolPanel&&!!BX.Crm.EntityEditor.defaultInstance._toolPanel.isVisible()){var n=BX.Crm.EntityEditor.defaultInstance._toolPanel._wrapper;i-=n.firstChild.offsetHeight}this.getNode().style.position="absolute";this.getNode().style.top=Math.min(t.top,i-500,o-500)+"px";this.getNode().style.left=t.left+t.width+2+"px";document.body.appendChild(this.getNode())};BX.Fileman.UserField.AddressRestriction=function(){this.bindNode=null;this.popup=null};BX.Fileman.UserField.AddressRestriction.prototype.show=function(e){this.bindNode=e;setTimeout(BX.proxy(this._show,this),100)};BX.Fileman.UserField.AddressRestriction.prototype._show=function(){this.getPopup(this.bindNode).show();this.getPopup(this.bindNode).popupContainer.style.width=this.bindNode.offsetWidth-20+"px"};BX.Fileman.UserField.AddressRestriction.prototype.getPopup=function(e){if(this.popup===null){this.popup=new BX.PopupWindow("uf_address_resriction",e,{content:this.getContent(),autoHide:true})}else if(!!e){this.getPopup().setBindElement(e)}return this.popup};BX.Fileman.UserField.AddressRestriction.prototype.getContent=function(){return""};BX.Fileman.UserField.AddressSearchRestriction=function(){BX.Fileman.UserField.AddressSearchRestriction.superclass.constructor.apply(this,arguments)};BX.extend(BX.Fileman.UserField.AddressSearchRestriction,BX.Fileman.UserField.AddressRestriction);BX.Fileman.UserField.AddressSearchRestriction.prototype.getContent=function(){return'<span class="tariff-lock"></span>&nbsp;<span>'+BX.message("GOOGLE_MAP_TRIAL_HINT")+'</span> <a href="javascript:void(0)" onclick="BX.Fileman.UserField.addressSearchRestriction.showPopup()" class="uf-address-trial-more">'+BX.message("GOOGLE_MAP_TRIAL_HINT_MORE")+"</a>"};BX.Fileman.UserField.AddressSearchRestriction.prototype.showPopup=function(){this.getPopup().close();B24.licenseInfoPopup.show("uf_address",BX.message("GOOGLE_MAP_TRIAL_TITLE"),BX.message("GOOGLE_MAP_TRIAL"))};BX.Fileman.UserField.AddressKeyRestriction=function(){BX.Fileman.UserField.AddressKeyRestriction.superclass.constructor.apply(this,arguments)};BX.extend(BX.Fileman.UserField.AddressKeyRestriction,BX.Fileman.UserField.AddressRestriction);BX.Fileman.UserField.AddressKeyRestriction.prototype.getContent=function(){return BX.message("GOOGLE_MAP_API_KEY_HINT")};BX.Fileman.UserField.addressSearchResultDisplayList=new BX.Fileman.UserField.AddressSearchResultDisplayList;BX.Fileman.UserField.addressSearchResultDisplayMap=new BX.Fileman.UserField.AddressSearchResultDisplayMap;BX.Fileman.UserField.addressSearchRestriction=new BX.Fileman.UserField.AddressSearchRestriction;BX.Fileman.UserField.addressKeyRestriction=new BX.Fileman.UserField.AddressKeyRestriction;BX.Main.UF.Factory.setTypeHandler(BX.Fileman.UserField.TypeAddress.USER_TYPE_ID,BX.Fileman.UserField.TypeAddress)})();