this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,a,o,s,n,r,l,c,d,u,p,g,h,f,m,v,I,E){"use strict";
/**
	 * Bitrix Mobile Dialog
	 * Dialog Pull commands (Pull Command Handler)
	 *
	 * @package bitrix
	 * @subpackage mobile
	 * @copyright 2001-2020 Bitrix
	 */var M=function(){babelHelpers.createClass(e,null,[{key:"create",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new this(t)}}]);function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.controller=t.controller;this.store=t.store;this.dialog=t.dialog}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"im"}},{key:"handleUserInvite",value:function e(t,i,a){var o=this;if(!t.invited){setTimeout((function(){o.dialog.redrawHeader()}),100)}}},{key:"handleMessage",value:function e(t,i,a){var o=BXMobileApp.UI.Page.TopBar.title.params.text;var s=t.message.senderId;if(t.users[s].name!==o){this.dialog.redrawHeader()}}},{key:"handleGeneralChatAccess",value:function e(){app.closeController()}},{key:"handleChatUserLeave",value:function e(t){if(t.userId===this.controller.application.getUserId()&&t.dialogId===this.controller.application.getDialogId()){app.closeController()}}}]);return e}();
/**
	 * Bitrix Mobile Dialog
	 * Dialog Rest answers (Rest Answer Handler)
	 *
	 * @package bitrix
	 * @subpackage mobile
	 * @copyright 2001-2019 Bitrix
	 */var b=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));if(babelHelpers["typeof"](e.context)==="object"&&e.context){i.context=e.context}return i}babelHelpers.createClass(t,[{key:"handleImCallGetCallLimitsSuccess",value:function e(t){this.store.commit("application/set",{call:{serverEnabled:t.callServerEnabled,maxParticipants:t.maxParticipants}})}},{key:"handleImChatGetSuccess",value:function e(t){this.store.commit("application/set",{dialog:{chatId:t.id,dialogId:t.dialog_id,diskFolderId:t.disk_folder_id}});if(t.restrictions){this.store.dispatch("dialogues/update",{dialogId:t.dialog_id,fields:t.restrictions})}}},{key:"handleImChatGetError",value:function e(t){if(t.ex.error==="ACCESS_ERROR"){BXMobileApp.Events.postToComponent("chatdialog::access::error",[],"im.messenger");app.closeController()}}},{key:"handleMobileBrowserConstGetSuccess",value:function e(t){this.store.commit("application/set",{disk:{enabled:true,maxFileSize:t.phpUploadMaxFilesize}});this.context.addLocalize(t);BX.message(t);n.LocalStorage.set(this.controller.getSiteId(),0,"serverVariables",t||{})}},{key:"handleImDialogMessagesGetInitSuccess",value:function e(){}},{key:"handleImMessageAddSuccess",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter((function(e){return e.id!==i.id}))}},{key:"handleImMessageAddError",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter((function(e){return e.id!==i.id}))}},{key:"handleImDiskFileCommitSuccess",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter((function(e){return e.id!==i.id}))}}]);return t}(s.BaseRestHandler);var C={template:'\n\t\t<div class="bx-mobilechat-loading-window">\n\t\t\t<svg class="bx-mobilechat-loading-circular" viewBox="25 25 50 50">\n\t\t\t\t<circle class="bx-mobilechat-loading-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t<circle class="bx-mobilechat-loading-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t</svg>\n\t\t\t<h3 class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-loading-msg">{{$Bitrix.Loc.getMessage(\'MOBILE_CHAT_LOADING\')}}</h3>\n\t\t</div>\n\t'};function S(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function y(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?S(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):S(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var T={computed:y({},p.Vuex.mapState({application:function e(t){return t.application}})),template:'\n\t\t<div class="bx-mobilechat-body" key="error-body">\n\t\t\t<div class="bx-mobilechat-warning-window">\n\t\t\t\t<div class="bx-mobilechat-warning-icon"></div>\n\t\t\t\t<template v-if="application.error.description"> \n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-sm bx-mobilechat-warning-msg" v-html="application.error.description"></div>\n\t\t\t\t</template> \n\t\t\t\t<template v-else>\n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-warning-msg">{{$Bitrix.Loc.getMessage(\'MOBILE_CHAT_ERROR_TITLE\')}}</div>\n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-sm bx-mobilechat-warning-msg">{{$Bitrix.Loc.getMessage(\'MOBILE_CHAT_ERROR_DESC\')}}</div>\n\t\t\t\t</template> \n\t\t\t</div>\n\t\t</div>\n\t'};var D={template:'\n\t\t<div class="bx-mobilechat-loading-window">\n\t\t\t<h3 class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-loading-msg">{{$Bitrix.Loc.getMessage(\'MOBILE_CHAT_EMPTY\')}}</h3>\n\t\t</div>\n\t'};var k={methods:{onSelectSmile:function e(t){this.$emit("selectSmile",t)},onSelectSet:function e(t){this.$emit("selectSet",t)},hideSmiles:function e(){this.$emit("hideSmiles")}},template:'\n\t\t<transition enter-active-class="bx-livechat-consent-window-show" leave-active-class="bx-livechat-form-close">\n\t\t\t<div class="bx-messenger-alert-box bx-livechat-alert-box-zero-padding bx-livechat-form-show" key="vote">\n\t\t\t\t<div class="bx-livechat-alert-close" @click="hideSmiles"></div>\n\t\t\t\t<div class="bx-messenger-smiles-box">\n\t\t\t\t\t<bx-smiles\n\t\t\t\t\t\t@selectSmile="onSelectSmile"\n\t\t\t\t\t\t@selectSet="onSelectSet"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</transition>\n\t'};var _=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"quoteMessage",value:function e(t){var i=this;this.store.dispatch("dialogues/update",{dialogId:this.getDialogId(),fields:{quoteId:t}}).then((function(){if(i.store.state.application.mobile.keyboardShow){return}f.EventEmitter.emit(m.EventType.mobile.textarea.setFocus);setTimeout((function(){f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:i.getChatId(),duration:300,cancelIfScrollChange:false,force:true})}),300)}))}},{key:"clearQuote",value:function e(){f.EventEmitter.emit(m.EventType.mobile.textarea.setText,{text:""});this.store.dispatch("dialogues/update",{dialogId:this.getDialogId(),fields:{quoteId:0,editId:0}})}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}}]);return t}(v.QuoteHandler);var L=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));i.loc=e.Loc.messages;return i}babelHelpers.createClass(t,[{key:"reactToMessage",value:function e(t,i){var a=i.action||v.ReactionHandler.actions.auto;if(a!==v.ReactionHandler.actions.auto){a=a===v.ReactionHandler.actions.set?v.ReactionHandler.actions.plus:v.ReactionHandler.actions.minus}var o=["reactMessage","reactMessage|".concat(t),{messageId:t,action:a},false,1e3];BXMobileApp.Events.postToComponent("chatbackground::task::action",o,"background");if(i.action===v.ReactionHandler.actions.set){setTimeout((function(){return app.exec("callVibration")}),200)}}},{key:"openMessageReactionList",value:function e(t,i){if(!h.Utils.dialog.isChatId(this.getDialogId())){return}var a=[];Object.keys(i).forEach((function(e){a=[].concat(babelHelpers.toConsumableArray(a),babelHelpers.toConsumableArray(i[e]))}));f.EventEmitter.emit(m.EventType.mobile.openUserList,{users:a,title:this.loc["MOBILE_MESSAGE_LIST_LIKE"]})}},{key:"onSetMessageReaction",value:function e(t){var i=t.data;this.reactToMessage(i.message.id,i.reaction)}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}}]);return t}(v.ReactionHandler);var A=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"onReadMessage",value:function e(t){var i=this;var a=t.data,o=a.id,s=o===void 0?null:o,n=a.skipAjax,r=n===void 0?false:n;return this.readMessage(s,true,true).then((function(e){if(e.lastId<=0||r){return}i.addTaskToReadMessage(e)}))}},{key:"processMessagesToRead",value:function e(t){var i=this;var a=this.getMaxMessageIdFromQueue(t);var o=this.getDialogId();delete this.messagesToRead[t];if(a<=0){return Promise.resolve({dialogId:o,lastId:a})}return new Promise((function(e,s){i.readMessageOnClient(t,a).then((function(e){return i.decreaseChatCounter(t,e.count)})).then((function(){e({dialogId:o,lastId:a})}))["catch"]((function(e){I.Logger.error("Reading messages error",e);s()}))}))}},{key:"addTaskToReadMessage",value:function e(t){BXMobileApp.Events.postToComponent("chatbackground::task::action",["readMessage","readMessage|".concat(t.dialogId),t,false,200],"background")}}]);return t}(v.ReadingHandler);function B(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function O(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?B(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):B(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}c.BitrixVue.component("bx-mobile-im-component-dialog",{components:{LoadingStatus:C,ErrorStatus:T,EmptyStatus:D,MobileSmiles:k},data:function e(){return{dialogState:"none"}},computed:O({EventType:function e(){return m.EventType},localize:function e(){return c.BitrixVue.getFilteredPhrases(["MOBILE_CHAT_","IM_UTILS_"],this.$root.$bitrixMessages)},widgetClassName:function e(){var t=[];t.push("bx-mobile");if(h.Utils.platform.isIos()){t.push("bx-mobile-ios")}else{t.push("bx-mobile-android")}return t.join(" ")},quotePanelData:function e(){var t={id:0,title:"",description:"",color:""};if(!this.isMessageLoaded||!this.dialog.quoteId){return t}var i=this.$store.getters["messages/getMessage"](this.dialog.chatId,this.dialog.quoteId);if(!i){return t}var a=this.$store.getters["users/get"](i.authorId);var o=this.$store.getters["files/getList"](this.dialog.chatId);var s=this.$store.getters["dialogues/getEditId"](this.dialog.dialogId);return{id:this.dialog.quoteId,title:s?this.$Bitrix.Loc.getMessage("MOBILE_CHAT_EDIT_TITLE"):i.params.NAME?i.params.NAME:a?a.name:"",color:a?a.color:"",description:h.Utils.text.purify(i.text,i.params,o,this.$Bitrix.Loc.getMessages())}},isDialog:function e(){return h.Utils.dialog.isChatId(this.dialog.dialogId)},isGestureQuoteSupported:function e(){if(this.dialog&&this.dialog.type==="announcement"&&!this.dialog.managerList.includes(this.application.common.userId)){return false}return ChatPerformance.isGestureQuoteSupported()},isDarkBackground:function e(){return this.application.options.darkBackground},isMessageLoaded:function e(){var t=this;var i=ChatPerformance.getDialogShowTimeout();var a=this.messageCollection&&this.messageCollection.length>0;if(a){if(i>0){clearTimeout(this.dialogStateTimeout);this.dialogStateTimeout=setTimeout((function(){t.dialogState="show"}),i)}else{this.dialogState="show"}}else if(this.dialog&&this.dialog.init){if(i>0){clearTimeout(this.dialogStateTimeout);this.dialogStateTimeout=setTimeout((function(){t.dialogState="empty"}),i)}else{this.dialogState="empty"}}else{this.dialogState="loading"}return a},dialog:function e(){var e=this.$store.getters["dialogues/get"](this.application.dialog.dialogId);return e||this.$store.getters["dialogues/getBlank"]()},chatId:function e(){if(this.application){return this.application.dialog.chatId}},diskFolderId:function e(){return this.application.dialog.diskFolderId},isDialogShowingMessages:function e(){var t=this.messageCollection&&this.messageCollection.length>0;if(t){this.dialogState=m.DialogState.show}else if(this.dialog&&this.dialog.init){this.dialogState=m.DialogState.empty}else{this.dialogState=m.DialogState.loading}return t}},p.Vuex.mapState({application:function e(t){return t.application},messageCollection:function e(t){return t.messages.collection[t.application.dialog.chatId]}})),created:function e(){this.timer=new E.Timer;this.initEventHandlers();this.subscribeToEvents()},beforeDestroy:function e(){this.unsubscribeEvents();this.destroyHandlers()},methods:{initEventHandlers:function e(){this.quoteHandler=new _(this.$Bitrix);this.reactionHandler=new L(this.$Bitrix);this.readingHandler=new A(this.$Bitrix)},destroyHandlers:function e(){this.quoteHandler.destroy();this.reactionHandler.destroy();this.readingHandler.destroy()},subscribeToEvents:function e(){f.EventEmitter.subscribe(m.EventType.mobile.textarea.setText,this.onSetText);f.EventEmitter.subscribe(m.EventType.mobile.textarea.setFocus,this.onSetFocus);f.EventEmitter.subscribe(m.EventType.mobile.openUserList,this.onOpenUserList);f.EventEmitter.subscribe(m.EventType.dialog.clickOnUploadCancel,this.onClickOnUploadCancel);f.EventEmitter.subscribe(m.EventType.dialog.clickOnMessageRetry,this.onClickOnMessageRetry);f.EventEmitter.subscribe(m.EventType.dialog.clickOnDialog,this.onClickOnDialog);f.EventEmitter.subscribe(m.EventType.dialog.clickOnChatTeaser,this.onClickOnChatTeaser);f.EventEmitter.subscribe(m.EventType.dialog.clickOnKeyboardButton,this.onClickOnKeyboardButton);f.EventEmitter.subscribe(m.EventType.dialog.clickOnReadList,this.onClickOnReadList);f.EventEmitter.subscribe(m.EventType.dialog.clickOnMessageMenu,this.onClickOnMessageMenu);f.EventEmitter.subscribe(m.EventType.dialog.doubleClickOnMessage,this.onDoubleClickOnMessage);f.EventEmitter.subscribe(m.EventType.dialog.clickOnUserName,this.onClickOnUserName);f.EventEmitter.subscribe(m.EventType.dialog.clickOnMention,this.onClickOnMention);f.EventEmitter.subscribe(m.EventType.dialog.clickOnCommand,this.onClickOnCommand)},unsubscribeEvents:function e(){f.EventEmitter.unsubscribe(m.EventType.mobile.textarea.setText,this.onSetText);f.EventEmitter.unsubscribe(m.EventType.mobile.textarea.setFocus,this.onSetFocus);f.EventEmitter.unsubscribe(m.EventType.mobile.openUserList,this.onOpenUserList);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnUploadCancel,this.onClickOnUploadCancel);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnMessageRetry,this.onClickOnMessageRetry);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnDialog,this.onClickOnDialog);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnChatTeaser,this.onClickOnChatTeaser);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnKeyboardButton,this.onClickOnKeyboardButton);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnReadList,this.onClickOnReadList);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnMessageMenu,this.onClickOnMessageMenu);f.EventEmitter.unsubscribe(m.EventType.dialog.doubleClickOnMessage,this.onDoubleClickOnMessage);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnUserName,this.onClickOnUserName);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnMention,this.onClickOnMention);f.EventEmitter.unsubscribe(m.EventType.dialog.clickOnCommand,this.onClickOnCommand)},getApplication:function e(){return this.$Bitrix.Application.get()},logEvent:function e(t){for(var i=arguments.length,a=new Array(i>1?i-1:0),o=1;o<i;o++){a[o-1]=arguments[o]}I.Logger.info.apply(I.Logger,[t].concat(a))},onDialogRequestHistory:function e(t){this.getApplication().getDialogHistory(t.lastId)},onDialogRequestUnread:function e(t){this.getApplication().getDialogUnread(t.lastId)},onClickOnUserName:function e(t){var i=t.data;this.getApplication().replyToUser(i.user.id,i.user)},onClickOnUploadCancel:function e(t){var i=t.data;this.getApplication().cancelUploadFile(i.file.id)},onClickOnCommand:function e(t){var i=t.data;if(i.type==="put"){this.getApplication().insertText({text:i.value+" "})}else if(i.type==="send"){this.getApplication().addMessage(i.value)}else{I.Logger.warn("Unprocessed command",i)}},onClickOnMention:function e(t){var i=t.data;if(i.type==="USER"){this.getApplication().openDialog(i.value)}else if(i.type==="CHAT"){this.getApplication().openDialog(i.value)}else if(i.type==="CALL"){this.getApplication().openPhoneMenu(i.value)}},onClickOnMessageMenu:function e(t){var i=t.data;I.Logger.warn("Message menu:",i);this.getApplication().openMessageMenu(i.message)},onClickOnMessageRetry:function e(t){var i=t.data;I.Logger.warn("Message retry:",i);this.getApplication().retrySendMessage(i.message)},onDoubleClickOnMessage:function e(t){var i=t.data;I.Logger.warn("Message double click:",i);f.EventEmitter.emit("ui:reaction:press",{id:"message"+i.message.id})},onClickOnReadList:function e(t){var i=t.data;this.getApplication().openReadedList(i.list)},onSetFocus:function e(){this.getApplication().setTextFocus()},onSetText:function e(t){var i=t.data;this.getApplication().setText(i.text)},onClickOnKeyboardButton:function e(t){var i=this;var a=t.data;if(a.action==="ACTION"){var o=a.params,s=o.dialogId,n=o.messageId,r=o.botId,l=o.action,c=o.value;if(l==="SEND"){this.getApplication().addMessage(c);setTimeout((function(){return f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:i.chatId,duration:300,cancelIfScrollChange:false})}),300)}else if(l==="PUT"){this.getApplication().insertText({text:c+" "})}else if(l==="CALL"){this.getApplication().openPhoneMenu(c)}else if(l==="COPY"){app.exec("copyToClipboard",{text:c});new BXMobileApp.UI.NotificationBar({message:BX.message("MOBILE_MESSAGE_MENU_COPY_SUCCESS"),color:"#af000000",textColor:"#ffffff",groupId:"clipboard",maxLines:1,align:"center",isGlobal:true,useCloseButton:true,autoHideTimeout:1500,hideOnTap:true},"copy").show()}else if(l==="DIALOG"){this.getApplication().openDialog(c)}return true}if(a.action==="COMMAND"){var d=a.params,u=d.dialogId,p=d.messageId,g=d.botId,h=d.command,v=d.params;this.$Bitrix.RestClient.get().callMethod(m.RestMethod.imMessageCommand,{MESSAGE_ID:p,DIALOG_ID:u,BOT_ID:g,COMMAND:h,COMMAND_PARAMS:v});return true}return false},onClickOnChatTeaser:function e(t){var i=this;var a=t.data;this.$Bitrix.Data.get("controller").application.joinParentChat(a.message.id,"chat"+a.message.params.CHAT_ID).then((function(e){i.getApplication().openDialog(e)}))["catch"]((function(){}))},onClickOnDialog:function e(t){var i=t.data},onSmilesSelectSmile:function e(t){console.warn("Smile selected:",t);this.getApplication().insertText({text:t.text})},onSmilesSelectSet:function e(){console.warn("Set selected");this.getApplication().setTextFocus()},onHideSmiles:function e(){this.getApplication().setTextFocus()},onOpenUserList:function e(t){var i=t.data;this.getApplication().openUserList(i)},getController:function e(){return this.$Bitrix.Data.get("controller")},getApplicationController:function e(){return this.getController().application},getRestClient:function e(){return this.$Bitrix.RestClient.get()},getCurrentUser:function e(){return this.$store.getters["users/get"](this.application.common.userId,true)},executeRestAnswer:function e(t,i,a){this.getController().executeRestAnswer(t,i,a)},isUnreadMessagesLoaded:function e(){if(!this.dialog){return true}if(this.dialog.lastMessageId<=0){return true}if(!this.messageCollection||this.messageCollection.length<=0){return true}var t=0;for(var i=this.messageCollection.length-1;i>=0;i--){var a=this.messageCollection[i];if(typeof a.id==="number"){t=a.id;break}}return t>=this.dialog.lastMessageId}},watch:{dialogState:function e(t){this.getApplication().changeDialogState(t)}},template:'\n\t\t<div :class="widgetClassName" :data-message-loaded="isMessageLoaded">\n\t\t\t<bx-im-component-dialog\n\t\t\t\t:userId="application.common.userId"\n\t\t\t\t:dialogId="application.dialog.dialogId"\n\t\t\t\t:enableReadMessages="application.dialog.enableReadMessages"\n\t\t\t\t:enableReactions="true"\n\t\t\t\t:enableDateActions="false"\n\t\t\t\t:enableCreateContent="false"\n\t\t\t\t:enableGestureQuote="application.options.quoteEnable"\n\t\t\t\t:enableGestureQuoteFromRight="application.options.quoteFromRight"\n\t\t\t\t:enableGestureMenu="true"\n\t\t\t\t:showMessageUserName="isDialog"\n\t\t\t\t:showMessageAvatar="isDialog"\n\t\t\t\t:showMessageMenu="false"\n\t\t\t\t:skipDataRequest="true"\n\t\t\t />\n\t\t\t<template v-if="application.options.showSmiles">\n\t\t\t\t<MobileSmiles @selectSmile="onSmilesSelectSmile" @selectSet="onSmilesSelectSet" @hideSmiles="onHideSmiles" />\n\t\t\t</template>\n\t\t</div>\n\t'},{immutable:true});function U(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function w(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?U(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):U(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var x="chatBackgroundQueue";var R="uploadTasks";var P="tasks";var H=-2;var F=200;var N=function(){function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.inited=false;this.initPromise=new BX.Promise;this.params=i;this.template=null;this.rootNode=this.params.node||document.createElement("div");this.eventBus=new c.VueVendorV2;this.timer=new E.Timer;this.messagesQueue=[];this.windowFocused=true;window.imDialogUploadTasks=[];window.imDialogMessagesTasks=[];this.messagesSet=false;this.initCore().then((function(){return t.subscribeToEvents()})).then((function(){return t.initComponentParams()})).then((function(e){return t.initLangAdditional(e)})).then((function(e){return t.initMobileEntity(e)})).then((function(e){return t.initMobileSettings(e)})).then((function(){return t.initComponent()})).then((function(){return t.initEnvironment()})).then((function(){return t.initMobileEnvironment()})).then((function(){return t.initUnsentStorage()})).then((function(){return t.initPullClient()})).then((function(){return t.initComplete()}))}babelHelpers.createClass(e,[{key:"initCore",value:function e(){var i=this;return new Promise((function(e,a){t.Core.ready().then((function(t){i.controller=t;e()}))}))}},{key:"subscribeToEvents",value:function e(){f.EventEmitter.subscribe(m.EventType.dialog.messagesSet,this.onMessagesSet.bind(this))}},{key:"initComponentParams",value:function e(){return BX.componentParameters.init()}},{key:"initLangAdditional",value:function e(t){var i=t.LANG_ADDITIONAL||{};console.log("0. initLangAdditional",i);return new Promise((function(e,a){if(t.LANG_ADDITIONAL){Object.keys(i).forEach((function(e){if(typeof i[e]!=="string"){return}BX.message[e]=i[e]}))}e(t)}))}},{key:"initMobileEntity",value:function e(t){var i=this;console.log("1. initMobileEntity");return new Promise((function(e,a){if(t.DIALOG_ENTITY){t.DIALOG_ENTITY=JSON.parse(t.DIALOG_ENTITY);if(t.DIALOG_TYPE==="user"){i.controller.getStore().dispatch("users/set",t.DIALOG_ENTITY).then((function(){e(t)}))}else if(t.DIALOG_TYPE==="chat"){i.controller.getStore().dispatch("dialogues/set",t.DIALOG_ENTITY).then((function(){e(t)}))}}else{e(t)}}))}},{key:"initMobileSettings",value:function e(t){var i=this;console.log("2. initMobileSettings");var a=n.LocalStorage.get(this.controller.getSiteId(),0,"serverVariables",false);if(a){this.addLocalize(a)}this.storedEvents=t.STORED_EVENTS||[];return new Promise((function(e,a){ApplicationStorage.getObject("settings.chat",{quoteEnable:ChatPerformance.isGestureQuoteSupported(),quoteFromRight:false,autoplayVideo:ChatPerformance.isAutoPlayVideoSupported(),backgroundType:"LIGHT_GRAY"}).then((function(a){i.controller.getStore().dispatch("application/set",{dialog:{dialogId:t.DIALOG_ID},options:{quoteEnable:a.quoteEnable,quoteFromRight:a.quoteFromRight,autoplayVideo:a.autoplayVideo,darkBackground:ChatDialogBackground&&ChatDialogBackground[a.backgroundType]&&ChatDialogBackground[a.backgroundType].dark}}).then((function(){return e()}))}))}))}},{key:"initComponent",value:function e(){var t=this;console.log("3. initComponent");this.controller.application.setPrepareFilesBeforeSaveFunction(this.prepareFileData.bind(this));this.controller.addRestAnswerHandler(b.create({store:this.controller.getStore(),controller:this.controller,context:this}));var i=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(i){this.controller.getStore().commit("application/set",{dialog:{chatId:i.chatId,diskFolderId:i.diskFolderId||0}})}return this.controller.createVue(this,{el:this.rootNode,template:"<bx-mobile-im-component-dialog/>"}).then((function(e){t.template=e;return new Promise((function(e,t){return e()}))}))}},{key:"initEnvironment",value:function e(){console.log("4. initEnvironment");this.setTextareaMessage=h.Utils.debounce(this.controller.application.setTextareaMessage,300,this.controller.application);return new Promise((function(e,t){return e()}))}},{key:"initMobileEnvironment",value:function e(){var t=this;console.log("5. initMobileEnvironment");BXMobileApp.UI.Page.Scroll.setEnabled(false);BXMobileApp.UI.Page.captureKeyboardEvents(true);BX.addCustomEvent("onKeyboardWillShow",(function(){t.controller.getStore().dispatch("application/set",{mobile:{keyboardShow:true}})}));BX.addCustomEvent("onKeyboardDidShow",(function(){console.log("Keyboard was showed");f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:t.controller.application.getChatId(),duration:300,cancelIfScrollChange:true})}));BX.addCustomEvent("onKeyboardWillHide",(function(){clearInterval(t.keyboardOpeningInterval);t.controller.getStore().dispatch("application/set",{mobile:{keyboardShow:false}})}));var i=function e(){BXMobileApp.UI.Page.isVisible({callback:function e(i){t.windowFocused=i.status==="visible";if(t.windowFocused){c.Vue.event.$emit("bitrixmobile:controller:focus")}else{c.Vue.event.$emit("bitrixmobile:controller:blur")}}})};BXMobileApp.addCustomEvent("CallEvents::viewOpened",(function(){console.warn("CallView show - disable read message");c.Vue.event.$emit("bitrixmobile:controller:blur")}));BXMobileApp.addCustomEvent("CallEvents::viewClosed",(function(){console.warn("CallView hide - enable read message");i()}));BX.addCustomEvent("onAppActive",(function(){i();BXMobileApp.UI.Page.isVisible({callback:function e(i){if(i.status!=="visible"){return false}t.getDialogUnread().then((function(){t.processSendMessages();f.EventEmitter.emit(m.EventType.dialog.readVisibleMessages,{chatId:t.controller.application.getChatId()});f.EventEmitter.emit(m.EventType.dialog.scrollOnStart,{chatId:t.controller.application.getChatId()})}))["catch"]((function(){t.processSendMessages()}))}})}));BX.addCustomEvent("onAppPaused",(function(){t.windowFocused=false;c.Vue.event.$emit("bitrixmobile:controller:blur")}));BX.addCustomEvent("onOpenPageAfter",i);BX.addCustomEvent("onHidePageBefore",(function(){t.windowFocused=false;c.Vue.event.$emit("bitrixmobile:controller:blur")}));BXMobileApp.addCustomEvent("chatbackground::task::status::success",(function(e){var i=e.taskId.toString().split("|")[0];t.executeBackgroundTaskSuccess(i,e)}));BXMobileApp.addCustomEvent("chatbackground::task::status::failure",(function(e){var i=e.taskId.toString().split("|")[0];t.executeBackgroundTaskFailure(i,e)}));BXMobileApp.addCustomEvent("chatrecent::push::get",(function(e){a.PULL.emit({type:a.PullClient.SubscriptionType.Server,moduleId:t.pullMobileHandler.getModuleId(),data:{command:"messageAdd",params:w(w({},e),{},{optionImportant:true})}})}));BXMobileApp.UI.Page.TextPanel.getText((function(e){BXMobileApp.UI.Page.TextPanel.setParams(t.getKeyboardParams({text:e}))}));this.changeChatKeyboardStatus();BX.MobileUploadProvider.setListener(this.executeUploaderEvent.bind(this));this.fileUpdateProgress=h.Utils.throttle((function(e,i,a,o){t.controller.getStore().dispatch("files/update",{chatId:e,id:i,fields:{status:m.FileStatus.upload,size:o,progress:a}})}),500);if(!h.Utils.dialog.isChatId(this.controller.application.getDialogId())){this.userShowWorkPosition=true;setTimeout((function(){t.userShowWorkPosition=false;t.redrawHeader()}),1500);setInterval((function(){t.redrawHeader()}),6e4)}else{this.chatShowUserCounter=false;setTimeout((function(){t.chatShowUserCounter=true;t.redrawHeader()}),1500)}this.redrawHeader();this.widgetCache=new ChatWidgetCache(this.controller.getUserId(),this.controller.getLanguageId());return new Promise((function(e,t){return e()}))}},{key:"initPullClient",value:function e(){var t=this;console.log("7. initPullClient");if(this.storedEvents&&this.storedEvents.length>0&&this.controller.application.isUnreadMessagesLoaded()){this.storedEvents=this.storedEvents.sort((function(e,t){return e.message.id-t.message.id}));this.storedEvents=this.storedEvents.slice(0,50);setTimeout((function(){t.storedEvents=t.storedEvents.filter((function(e){BX.onCustomEvent("chatrecent::push::get",[e]);return false}));f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:t.controller.application.getChatId(),duration:300,cancelIfScrollChange:true})}),50)}a.PULL.subscribe(this.pullMobileHandler=new M({store:this.controller.getStore(),controller:this.controller,dialog:this}));a.PULL.subscribe({type:a.PullClient.SubscriptionType.Status,callback:this.eventStatusInteraction.bind(this)});if(!h.Utils.dialog.isChatId(this.controller.application.getDialogId())){a.PULL.subscribe({type:a.PullClient.SubscriptionType.Online,callback:this.eventOnlineInteraction.bind(this)})}return new Promise((function(e,t){return e()}))}},{key:"initComplete",value:function e(){var t=this;console.log("8. initComplete");this.controller.getStore().subscribe((function(e){return t.eventStoreInteraction(e)}));this.inited=true;this.initPromise.resolve(this);BXMobileApp.Events.postToComponent("chatdialog::init::complete",[{dialogId:this.controller.application.getDialogId()},true],"im.recent");BXMobileApp.Events.postToComponent("chatdialog::init::complete",[{dialogId:this.controller.application.getDialogId()},true],"im.messenger");return this.requestData()}},{key:"cancelUnsentFile",value:function e(t){var i="imDialogFileUpload|".concat(t);BX.MobileUploadProvider.cancelTasks([i]);window.imDialogUploadTasks=window.imDialogUploadTasks.filter((function(e){return i!==e.taskId}))}},{key:"initUnsentStorage",value:function e(){var t=this;console.log("6. initUnsentStorage");return new Promise((function(e){var i=t.loadUnsentFiles();var a=t.loadUnsentMessages();Promise.all([i,a]).then(e)}))}},{key:"loadUnsentMessages",value:function e(){var t=this.controller.application.getUserId();var i=this.controller.application.getDialogId();var a="".concat(x,"_").concat(t);return ApplicationStorage.getObject(P,{},a).then((function(e){for(var t in e){if(t===i){e[t].forEach((function(e){if(i===e.extra.dialogId){window.imDialogMessagesTasks.push(e)}}))}}}))}},{key:"loadUnsentFiles",value:function e(){var t=this.controller.application.getUserId();var i=this.controller.application.getDialogId();var a="".concat(x,"_").concat(t);return ApplicationStorage.getObject(R,{},a).then((function(e){Object.values(e).forEach((function(e){if(typeof e.eventData.file!=="undefined"&&i===e.eventData.file.params.dialogId){window.imDialogUploadTasks.push(e)}}));if(window.imDialogUploadTasks.length>0){BX.MobileUploadProvider.registerTaskLoaders(window.imDialogUploadTasks)}}))}},{key:"ready",value:function e(){if(this.inited){var t=new BX.Promise;t.resolve(this);return t}return this.initPromise}},{key:"requestData",value:function e(){var t=this;console.log("-> requestData");if(this.requestDataSend){return this.requestDataSend}this.timer.start("data","load",.5,(function(){console.warn("ChatDialog.requestData: slow connection show progress icon");app.titleAction("setParams",{useProgress:true,useLetterImage:false})}));this.requestDataSend=new Promise((function(e,i){var a;var o=(a={},babelHelpers.defineProperty(a,m.RestMethodHandler.mobileBrowserConstGet,[m.RestMethod.mobileBrowserConstGet,{}]),babelHelpers.defineProperty(a,m.RestMethodHandler.imChatGet,[m.RestMethod.imChatGet,{dialog_id:t.controller.application.getDialogId()}]),babelHelpers.defineProperty(a,m.RestMethodHandler.imDialogMessagesGetInit,[m.RestMethod.imDialogMessagesGet,{dialog_id:t.controller.application.getDialogId(),limit:t.controller.application.getRequestMessageLimit(),convert_text:"Y"}]),babelHelpers.defineProperty(a,m.RestMethodHandler.imRecentUnread,[m.RestMethod.imRecentUnread,{dialog_id:t.controller.application.getDialogId(),action:"N"}]),babelHelpers.defineProperty(a,m.RestMethodHandler.imCallGetCallLimits,[m.RestMethod.imCallGetCallLimits,{}]),a);if(h.Utils.dialog.isChatId(t.controller.application.getDialogId())){o[m.RestMethodHandler.imUserGet]=[m.RestMethod.imUserGet,{}]}else{o[m.RestMethodHandler.imUserListGet]=[m.RestMethod.imUserListGet,{id:[t.controller.application.getUserId(),t.controller.application.getDialogId()]}]}t.controller.restClient.callBatch(o,(function(i){if(!i){t.requestDataSend=null;t.setError("EMPTY_RESPONSE","Server returned an empty response.");e();return false}console.log("<-- requestData",i);var a=i[m.RestMethodHandler.mobileBrowserConstGet];if(a.error()){console.warn("Error load dialog",a.error().ex.error,a.error().ex.error_description);console.warn("Try connect...");setTimeout((function(){return t.requestData()}),5e3)}else{t.controller.executeRestAnswer(m.RestMethodHandler.mobileBrowserConstGet,a)}var o=i[m.RestMethodHandler.imCallGetCallLimits];if(o&&!o.error()){t.controller.executeRestAnswer(m.RestMethodHandler.imCallGetCallLimits,o)}var s=i[m.RestMethodHandler.imUserGet];if(s&&!s.error()){t.controller.executeRestAnswer(m.RestMethodHandler.imUserGet,s)}var n=i[m.RestMethodHandler.imUserListGet];if(n&&!n.error()){t.controller.executeRestAnswer(m.RestMethodHandler.imUserListGet,n)}var r=i[m.RestMethodHandler.imChatGet];t.controller.executeRestAnswer(m.RestMethodHandler.imChatGet,r);t.redrawHeader();var l=i[m.RestMethodHandler.imDialogMessagesGetInit];if(l.error());else{app.titleAction("setParams",{useProgress:false,useLetterImage:true});t.timer.stop("data","load",true);t.controller.getStore().dispatch("dialogues/saveDialog",{dialogId:t.controller.application.getDialogId(),chatId:t.controller.application.getChatId()});if(t.controller.pullBaseHandler){t.controller.pullBaseHandler.option.skip=false}t.controller.getStore().dispatch("application/set",{dialog:{enableReadMessages:true}}).then((function(){t.controller.executeRestAnswer(m.RestMethodHandler.imDialogMessagesGetInit,l)}));t.processSendMessages()}t.requestDataSend=null;e()}),false,false,h.Utils.getLogTrackingParams({name:"mobile.im.dialog",dialog:t.controller.application.getDialogData()}))}));return this.requestDataSend}},{key:"executeUploaderEvent",value:function e(t,i,a){if(t!==BX.MobileUploaderConst.FILE_UPLOAD_PROGRESS){console.log("ChatDialog.disk.eventRouter: ",t,a,i)}if(t===BX.MobileUploaderConst.FILE_UPLOAD_PROGRESS){if(i.percent>95){i.percent=95}this.fileUpdateProgress(i.file.params.chatId,i.file.params.file.id,i.percent,i.byteTotal)}else if(t===BX.MobileUploaderConst.FILE_CREATED){if(i.result.status==="error"){this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id);console.error("File upload error",i.result.errors[0].message)}else{this.controller.getStore().dispatch("files/update",{chatId:i.file.params.chatId,id:i.file.params.file.id,fields:{status:m.FileStatus.wait,progress:95}})}}else if(t==="onimdiskmessageaddsuccess"){console.info("ChatDialog.disk.eventRouter: DISK_MESSAGE_ADD_SUCCESS: ",i,a);var o=i.result.FILES["upload"+i.result.DISK_ID[0]];this.controller.getStore().dispatch("files/update",{chatId:i.file.params.chatId,id:i.file.params.file.id,fields:{status:m.FileStatus.upload,progress:100,id:o.id,size:o.size,urlDownload:o.urlDownload,urlPreview:o.urlPreview,urlShow:o.urlShow}})}else if(t==="onimdiskmessageaddfail"){console.error("ChatDialog.disk.eventRouter: DISK_MESSAGE_ADD_FAIL: ",i,a);this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id)}else if(t===BX.MobileUploaderConst.TASK_CANCELLED||t===BX.MobileUploaderConst.TASK_NOT_FOUND){this.cancelUploadFile(i.file.params.file.id)}else if(t===BX.MobileUploaderConst.FILE_CREATED_FAILED||t===BX.MobileUploaderConst.FILE_UPLOAD_FAILED||t===BX.MobileUploaderConst.FILE_READ_ERROR||t===BX.MobileUploaderConst.TASK_STARTED_FAILED){var s,n;console.error("ChatDialog.disk.eventRouter: ",t,i,a);if((i===null||i===void 0?void 0:(s=i.error)===null||s===void 0?void 0:(n=s.error)===null||n===void 0?void 0:n.code)!==H){this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id)}}return true}},{key:"prepareFileData",value:function e(t){var i=function e(t){if(t.urlPreview&&t.urlPreview.startsWith("file://")){t.urlPreview="bx"+t.urlPreview}if(t.urlShow&&t.urlShow.startsWith("file://")){t.urlShow="bx"+t.urlShow}if(t.type!==m.FileType.image){return t}if(t.urlPreview){if(t.urlPreview.startsWith("/")){t.urlPreview=currentDomain+t.urlPreview}t.urlPreview=t.urlPreview.replace("http://","bxhttp://").replace("https://","bxhttps://")}if(t.urlShow){if(t.urlShow.startsWith("/")){t.urlShow=currentDomain+t.urlShow}t.urlShow=t.urlShow.replace("http://","bxhttp://").replace("https://","bxhttps://")}return t};if(t instanceof Array){return t.map((function(e){return i(e)}))}else{return i(t)}}},{key:"redrawHeader",value:function e(){var t=this;var i;if(h.Utils.dialog.isChatId(this.controller.application.getDialogId())){i=this.getChatHeaderParams();this.changeChatKeyboardStatus()}else{i=this.getUserHeaderParams()}if(!i){return false}this.setHeaderButtons();if(!this.headerMenuInited){BXMobileApp.UI.Page.TopBar.title.params.useLetterImage=true;BXMobileApp.UI.Page.TopBar.title.setCallback((function(){return t.openHeaderMenu()}));this.headerMenuInited=true}if(i.name){BXMobileApp.UI.Page.TopBar.title.setText(i.name)}if(i.desc){BXMobileApp.UI.Page.TopBar.title.setDetailText(i.desc)}if(i.avatar){BXMobileApp.UI.Page.TopBar.title.setImage(i.avatar)}else if(i.color){BXMobileApp.UI.Page.TopBar.title.params.imageColor=i.color}return true}},{key:"setIosInset",value:function e(){if(!h.Utils.platform.isIos()||Application.getApiVersion()<=39){return false}var t=function e(){return document.getElementsByClassName("bx-im-dialog-list")[0]};var i=function e(t){t.style.paddingTop=window.safeAreaInsets.top+"px"};var a=function e(){var a=t();if(!a){return false}if(a.scrollTop<=window.safeAreaInsets.top){i(a);a.removeEventListener("scroll",e)}};if(this.iosInsetEventSetted){return true}this.iosInsetEventSetted=true;var o=h.Utils.debounce((function(){var e=t();if(!e){return false}if(window.safeAreaInsets&&e.scrollTop<=window.safeAreaInsets.top){i(e)}else{e.removeEventListener("scroll",a);e.addEventListener("scroll",a)}}),100);BXMobileApp.addCustomEvent("onInsetsChanged",o);setTimeout(o,1e3);return true}},{key:"getUserHeaderParams",value:function e(){var t=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId());if(!t||!t.init){return false}var i={name:null,desc:null,avatar:null,color:null};if(t.avatar){i.avatar=t.avatar}else{i.color=t.color}i.name=t.name;var a=false;if(!this.userShowWorkPosition&&t.lastActivityDate){a=h.Utils.user.getLastDateText(t,this.getLocalize())}if(a){i.desc=a}else{if(t.extranet){i.desc=this.getLocalize("IM_LIST_EXTRANET")}else if(t.workPosition){i.desc=t.workPosition}else{i.desc=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_USER")}}return i}},{key:"getChatHeaderParams",value:function e(){var t=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(!t||!t.init){return false}var i={name:null,desc:null,avatar:null,color:null};if(t.avatar){i.avatar=t.avatar}else{i.color=t.color}if(t.entityType==="GENERAL"){i.avatar=encodeURI(this.controller.getHost()+"/bitrix/mobileapp/immobile/components/im/messenger/images/avatar_general_x3.png")}i.name=t.name;var a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_CHAT_NEW");if(this.chatShowUserCounter&&this.getLocalize()["MOBILE_HEADER_MENU_CHAT_USER_COUNT"]){a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_USER_COUNT").replace("#COUNT#",t.userCounter)}else if(this.getLocalize()["MOBILE_HEADER_MENU_CHAT_TYPE_"+t.type.toUpperCase()+"_NEW"]){a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_"+t.type.toUpperCase()+"_NEW")}i.desc=a;if(t.entityType==="SUPPORT24_QUESTION"){i.avatar=encodeURI(this.controller.getHost()+"/bitrix/mobileapp/immobile/components/im/messenger/images/avatar_24_question_x3.png");i.desc=""}console.warn(i);return i}},{key:"changeChatKeyboardStatus",value:function e(){var t=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(!t||!t.init){BXMobileApp.UI.Page.TextPanel.show();return true}var i=true;if(t.type==="announcement"&&!t.managerList.includes(this.controller.application.getUserId())){i=false}else if(t.restrictions.send===false){i=false}if(typeof this.keyboardShowFlag!=="undefined"&&(this.keyboardShowFlag&&i||!this.keyboardShowFlag&&!i)){return this.keyboardShowFlag}if(i){BXMobileApp.UI.Page.TextPanel.show();this.keyboardShowFlag=true}else{BXMobileApp.UI.Page.TextPanel.hide();this.keyboardShowFlag=false}return this.keyboardShowFlag}},{key:"setHeaderButtons",value:function e(){var t=this;if(this.callMenuSetted){return true}if(h.Utils.dialog.isChatId(this.controller.application.getDialogId())){var i=this.controller.application.getDialogData();if(!i.init){return false}var a=Application.getApiVersion()>=36;var o=this.controller.application.getData().call.maxParticipants;if(i.userCounter>o||!a||i.entityType==="VIDEOCONF"&&i.entityData1==="BROADCAST"){if(i.type!==m.DialogType.call&&i.restrictions.extend){app.exec("setRightButtons",{items:[{type:"user_plus",callback:function e(){fabric.Answers.sendCustomEvent("vueChatAddUserButton",{});t.openAddUserDialog()}}]})}else{app.exec("setRightButtons",{items:[]})}this.callMenuSetted=true;return true}if(!i.restrictions.call){app.exec("setRightButtons",{items:[]});this.callMenuSetted=true;return true}}else{var s=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId(),true);if(!s.init){return false}if(!s||s.bot||s.network||this.controller.application.getUserId()===parseInt(this.controller.application.getDialogId())){app.exec("setRightButtons",{items:[]});this.callMenuSetted=true;return true}}app.exec("setRightButtons",{items:[{type:"call_audio",callback:function e(){if(h.Utils.dialog.isChatId(t.controller.application.getDialogId())){BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:false,chatData:t.controller.application.getDialogData()},"calls")}else{var i=t.controller.getStore().getters["users/get"](t.controller.application.getDialogId(),true);BXMobileApp.Events.postToComponent("onCallInvite",{userId:t.controller.application.getDialogId(),video:false,userData:babelHelpers.defineProperty({},i.id,i)},"calls")}}},{type:"call_video",badgeCode:"call_video",callback:function e(){fabric.Answers.sendCustomEvent("vueChatCallVideoButton",{});if(h.Utils.dialog.isChatId(t.controller.application.getDialogId())){BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:true,chatData:t.controller.application.getDialogData()},"calls")}else{BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:true,userData:babelHelpers.defineProperty({},t.controller.application.getDialogId(),t.controller.getStore().getters["users/get"](t.controller.application.getDialogId(),true))},"calls")}}}]});this.callMenuSetted=true;return true}},{key:"openUserList",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.users,a=i===void 0?false:i,o=t.title,s=o===void 0?"":o,n=t.listType,r=n===void 0?"LIST":n,l=t.backdrop,c=l===void 0?true:l;var d={title:s,objectName:"ChatUserListInterface"};if(c){d.backdrop={}}app.exec("openComponent",{name:"JSStackComponent",componentCode:"im.dialog.list",scriptPath:"/mobileapp/jn/im:im.chat.user.list/?version="+BX.componentParameters.get("WIDGET_CHAT_USERS_VERSION","1.0.0"),params:{DIALOG_ID:this.controller.application.getDialogId(),DIALOG_OWNER_ID:this.controller.application.getDialogData().ownerId,USER_ID:this.controller.application.getUserId(),LIST_TYPE:r,USERS:a,IS_BACKDROP:true},rootWidget:{name:"list",settings:d}},false)}},{key:"openCallMenu",value:function e(){var t=this;fabric.Answers.sendCustomEvent("vueChatCallAudioButton",{});var i=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId(),true);if(i.phones.personalMobile||i.phones.workPhone||i.phones.personalPhone||i.phones.innerPhone){BackdropMenu.create("im.dialog.menu.call|"+this.controller.application.getDialogId()).setItems([BackdropMenuItem.create("audio").setTitle(this.getLocalize("MOBILE_HEADER_MENU_AUDIO_CALL")),BackdropMenuItem.create("personalMobile").setTitle(i.phones.personalMobile).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_MOBILE")).skip(!i.phones.personalMobile),BackdropMenuItem.create("workPhone").setTitle(i.phones.workPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_WORK")).skip(!i.phones.workPhone),BackdropMenuItem.create("personalPhone").setTitle(i.phones.personalPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_PHONE")).skip(!i.phones.personalPhone),BackdropMenuItem.create("innerPhone").setTitle(i.phones.innerPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_PHONE")).skip(!i.phones.innerPhone)]).setVersion(BX.componentParameters.get("WIDGET_BACKDROP_MENU_VERSION","1.0.0")).setEventListener((function(e,i,a,o){if(e!=="selected"){return false}if(i.id==="audio"){BXMobileApp.Events.postToComponent("onCallInvite",{userId:t.controller.application.getDialogId(),video:false,userData:babelHelpers.defineProperty({},a.id,a)},"calls")}else if(i.id==="innerPhone"){BX.MobileTools.phoneTo(a.phones[i.id],{callMethod:"telephony"})}else{BX.MobileTools.phoneTo(a.phones[i.id],{callMethod:"device"})}})).setCustomParams(i).show()}else{BXMobileApp.Events.postToComponent("onCallInvite",{userId:this.controller.application.getDialogId(),video:false,userData:babelHelpers.defineProperty({},this.controller.application.getDialogId(),i)},"calls")}}},{key:"leaveChat",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!i){app.confirm({title:this.getLocalize("MOBILE_HEADER_MENU_LEAVE_CONFIRM"),text:"",buttons:[this.getLocalize("MOBILE_HEADER_MENU_LEAVE_YES"),this.getLocalize("MOBILE_HEADER_MENU_LEAVE_NO")],callback:function e(i){if(i===1){t.leaveChat(true)}}});return true}var a=this.controller.application.getDialogId();this.controller.restClient.callMethod(m.RestMethod.imChatLeave,{DIALOG_ID:a},null,null,h.Utils.getLogTrackingParams({name:m.RestMethod.imChatLeave,dialog:this.controller.application.getDialogData(a)})).then((function(e){app.closeController()}))}},{key:"openAddUserDialog",value:function e(){var t=this.getItemsForAddUserDialog();app.exec("openComponent",{name:"JSStackComponent",componentCode:"im.chat.user.selector",scriptPath:"/mobileapp/jn/im:im.chat.user.selector/?version="+BX.componentParameters.get("WIDGET_CHAT_RECIPIENTS_VERSION","1.0.0"),params:{DIALOG_ID:this.controller.application.getDialogId(),USER_ID:this.controller.application.getUserId(),LIST_USERS:t,LIST_DEPARTMENTS:[],SKIP_LIST:[],SEARCH_MIN_SIZE:BX.componentParameters.get("SEARCH_MIN_TOKEN_SIZE",3)},rootWidget:{name:"chat.recipients",settings:{objectName:"ChatUserSelectorInterface",title:BX.message("MOBILE_HEADER_MENU_USER_ADD"),limit:100,items:t.map((function(e){return ChatDataConverter.getListElementByUser(e)})),scopes:[{title:BX.message("MOBILE_SCOPE_USERS"),id:"user"},{title:BX.message("MOBILE_SCOPE_DEPARTMENTS"),id:"department"}],backdrop:{showOnTop:true}}}},false)}},{key:"getItemsForAddUserDialog",value:function e(){var t=[];var i={};if(this.widgetCache.recentList.length>0){this.widgetCache.recentList.map((function(e){if(!e||i[e.id]){return false}if(e.type!=="user"){return false}if(e.user.network||e.user.connector){return false}t.push(e.user);i[e.id]=true;return true}))}this.widgetCache.colleaguesList.map((function(e){if(!e||i[e.id]){return false}if(e.network||e.connector){return false}t.push(e);i[e.id]=true}));this.widgetCache.lastSearchList.map((function(e){if(!e||i[e.id]){return false}if(!e){return false}if(e.type!=="user"){return false}if(e.user.network||e.user.connector){return false}t.push(e.user);i[e.id]=true;return true}));return t}},{key:"eventStoreInteraction",value:function e(t){var i=this;if(t.type==="dialogues/update"&&t.payload&&t.payload.fields){if(t.payload.dialogId!==this.controller.application.getDialogId()){return}if(typeof t.payload.fields.name!=="undefined"||typeof t.payload.fields.userCounter!=="undefined"){if(typeof t.payload.fields.userCounter!=="undefined"){this.callMenuSetted=false}this.redrawHeader()}if(typeof t.payload.fields.counter!=="undefined"&&typeof t.payload.dialogId!=="undefined"){BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:t.payload.dialogId,counter:t.payload.fields.counter},true],"im.recent");BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:t.payload.dialogId,counter:t.payload.fields.counter},true],"im.messenger")}}else if(t.type==="dialogues/set"){t.payload.forEach((function(e){if(e.dialogId!==i.controller.application.getDialogId()){return}BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:e.dialogId,counter:e.counter},true],"im.recent");BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:e.dialogId,counter:e.counter},true],"im.messenger")}))}}},{key:"eventStatusInteraction",value:function e(t){var i=this;if(t.status===a.PullClient.PullStatus.Online){if(this.messagesSet){BXMobileApp.Events.postToComponent("chatbackground::task::restart",[],"background");BXMobileApp.Events.postToComponent("chatuploader::task::restart",[],"background")}if(this.pullRequestMessage){this.controller.pullBaseHandler.option.skip=true;this.getDialogUnread().then((function(){i.controller.pullBaseHandler.option.skip=false;i.processSendMessages();f.EventEmitter.emit(m.EventType.dialog.readVisibleMessages,{chatId:i.controller.application.getChatId()});f.EventEmitter.emit(m.EventType.dialog.scrollOnStart,{chatId:i.controller.application.getChatId()})}))["catch"]((function(){i.controller.pullBaseHandler.option.skip=false;i.processSendMessages()}));this.pullRequestMessage=false}else{f.EventEmitter.emit(m.EventType.dialog.readMessage);this.processSendMessages()}}else if(t.status===a.PullClient.PullStatus.Offline){this.pullRequestMessage=true}}},{key:"eventOnlineInteraction",value:function e(t){if(t.command==="list"||t.command==="userStatus"){for(var i in t.params.users){if(!t.params.users.hasOwnProperty(i)){continue}this.controller.getStore().dispatch("users/update",{id:t.params.users[i].id,fields:t.params.users[i]});if(i.toString()===this.controller.application.getDialogId()){this.redrawHeader()}}}}},{key:"getKeyboardParams",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var a=this.controller.application.getDialogData();var s=a?a.textareaMessage:"";s=s||i.text;var n=this.getLocalize("SITE_DIR");return{text:s,placeholder:this.getLocalize("MOBILE_CHAT_PANEL_PLACEHOLDER"),smileButton:{},useImageButton:true,useAudioMessages:true,mentionDataSource:{outsection:"NO",url:n+"mobile/index.php?mobile_action=get_user_list&use_name_format=Y&with_bots"},attachFileSettings:{previewMaxWidth:640,previewMaxHeight:640,resize:{targetWidth:-1,targetHeight:-1,sourceType:1,encodingType:0,mediaType:2,allowsEdit:false,saveToPhotoAlbum:true,popoverOptions:false,cameraDirection:0},sendFileSeparately:true,showAttachedFiles:true,editingMediaFiles:false,maxAttachedFilesCount:100},attachButton:{items:[{id:"disk",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_DISK"),dataSource:{multiple:false,url:n+"mobile/?mobile_action=disk_folder_list&type=user&path=%2F&entityId="+this.controller.application.getUserId(),TABLE_SETTINGS:{searchField:true,showtitle:true,modal:true,name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_DISK_FILES")}}},{id:"mediateka",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_GALLERY")},{id:"camera",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_CAMERA")}]},action:function e(i){if(typeof i==="string"){i={text:i,attachedFiles:[]}}var a=i.text.toString().trim();var s=i.attachedFiles instanceof Array?i.attachedFiles:[];if(s.length<=0){t.clearText();t.hideSmiles();var n=t.controller.getStore().getters["dialogues/getEditId"](t.controller.application.getDialogId());if(n){t.updateMessage(n,a)}else{t.addMessage(a)}}else{s.forEach((function(e){if(typeof e.dataAttributes!=="undefined"){fabric.Answers.sendCustomEvent("vueChatFileDisk",{});return t.uploadFile({source:"disk",name:e.name,type:e.type.toString().toLowerCase(),preview:!e.dataAttributes.URL||!e.dataAttributes.URL.PREVIEW?null:{url:e.dataAttributes.URL.PREVIEW,width:e.dataAttributes.URL.PREVIEW.match(/(width=(\d+))/i)[2],height:e.dataAttributes.URL.PREVIEW.match(/(height=(\d+))/i)[2]},uploadLink:parseInt(e.dataAttributes.ID)})}if(e.type==="audio/mp4"){fabric.Answers.sendCustomEvent("vueChatFileAudio",{});return t.uploadFile({source:"audio",name:"mobile_audio_"+(new Date).toJSON().slice(0,19).replace("T","_").split(":").join("-")+".mp3",type:"mp3",preview:null,uploadLink:e.url})}var i=e.name;var a=o.FilesModel.getType(e.name);if(a===m.FileType.video){fabric.Answers.sendCustomEvent("vueChatFileVideo",{})}else if(a===m.FileType.image){fabric.Answers.sendCustomEvent("vueChatFileImage",{})}else{fabric.Answers.sendCustomEvent("vueChatFileOther",{})}if(a===m.FileType.image||a===m.FileType.video){var s=e.name.split(".").slice(-1)[0].toLowerCase();if(e.type==="image/heic"){s="jpg"}i="mobile_file_"+(new Date).toJSON().slice(0,19).replace("T","_").split(":").join("-")+"."+s}return t.uploadFile({source:"gallery",name:i,type:e.type.toString().toLowerCase(),preview:!e.previewUrl?null:{url:e.previewUrl,width:e.previewWidth,height:e.previewHeight},uploadLink:e.url})}))}},callback:function e(i){console.log("Textpanel callback",i);if(!i.event){return false}if(i.event==="onKeyPress"){var a=i.text.toString();if(a.trim().length>2){t.controller.application.startWriting()}if(a.length===0){t.setTextareaMessage({message:""});t.controller.application.stopWriting()}else{t.setTextareaMessage({message:a})}}else if(i.event==="onSmileSelect"){t.controller.showSmiles()}else if(Application.getPlatform()!=="android"){if(i.event==="getFocus"){if(h.Utils.platform.isIos()&&h.Utils.platform.getIosVersion()>12){f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:t.controller.application.getChatId(),duration:300,cancelIfScrollChange:true})}}else if(i.event==="removeFocus");}}}}},{key:"addMessage",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!t&&!a){return false}var s=o||ChatUtils.getUuidv4();var n=this.controller.getStore().getters["dialogues/getQuoteId"](this.controller.application.getDialogId());if(n){var r=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),n);if(r){var l=null;if(r.authorId){l=this.controller.getStore().getters["users/get"](r.authorId)}var c=this.controller.getStore().getters["files/getList"](this.controller.application.getChatId());var d=[];d.push("-".repeat(54));d.push((l&&l.name?l.name:this.getLocalize("MOBILE_CHAT_SYSTEM_MESSAGE"))+" ["+h.Utils.date.format(r.date,null,this.getLocalize())+"]");d.push(h.Utils.text.quote(r.text,r.params,c,this.getLocalize()));d.push("-".repeat(54));d.push(t);t=d.join("\n");this.quoteMessageClear()}}console.warn("addMessage",t,a,s);if(!this.controller.application.isUnreadMessagesLoaded()){this.sendMessage({id:s,chatId:this.controller.application.getChatId(),dialogId:this.controller.application.getDialogId(),text:t,file:a});this.processSendMessages();return true}this.controller.getStore().commit("application/increaseDialogExtraCount");var u={};if(a){u.FILE_ID=[a.id]}this.controller.getStore().dispatch("messages/add",{id:s,chatId:this.controller.application.getChatId(),authorId:this.controller.application.getUserId(),text:t,params:u,sending:!a}).then((function(e){f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:i.controller.application.getChatId(),cancelIfScrollChange:true});i.messagesQueue.push({id:e,chatId:i.controller.application.getChatId(),dialogId:i.controller.application.getDialogId(),text:t,file:a,sending:false});if(i.controller.application.getChatId()){i.processSendMessages()}else{i.requestData()}}));return true}},{key:"uploadFile",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(!t){return false}var s=ChatUtils.getUuidv4();console.warn("addFile",t,a,s);if(!this.controller.application.isUnreadMessagesLoaded()){this.addMessage(a,{id:0,source:t},s);return true}this.controller.getStore().dispatch("files/add",this.controller.application.prepareFilesBeforeSave({chatId:this.controller.application.getChatId(),authorId:this.controller.application.getUserId(),name:t.name,type:o.FilesModel.getType(t.name),extension:t.name.split(".").splice(-1)[0],size:0,image:!t.preview?false:{width:t.preview.width,height:t.preview.height},status:t.source==="disk"?m.FileStatus.wait:m.FileStatus.upload,progress:0,authorName:this.controller.application.getCurrentUser().name,urlPreview:!t.preview?"":t.preview.url})).then((function(e){return i.addMessage(a,w({id:e},t),s)}));return true}},{key:"cancelUploadFile",value:function e(t){var i=this;this.cancelUnsentFile(t);var a=this.messagesQueue.find((function(e){return e.file&&e.file.id===t}));if(!a){var o=this.controller.getStore().getters["messages/get"](this.controller.application.getChatId());var s=o.find((function(e){return e.params.FILE_ID&&e.params.FILE_ID.includes(t)}));if(s){a={id:s.id,chatId:s.chatId,file:{id:s.params.FILE_ID[0]}}}}if(a){BX.MobileUploadProvider.cancelTasks(["imDialogFileUpload|"+t]);this.controller.getStore().dispatch("messages/delete",{chatId:a.chatId,id:a.id}).then((function(){i.controller.getStore().dispatch("files/delete",{chatId:a.chatId,id:a.file.id});i.messagesQueue=i.messagesQueue.filter((function(e){return e.id!==a.id}))}))}}},{key:"retryUploadFile",value:function e(t){var i=this;var a=this.messagesQueue.find((function(e){return e.file&&e.file.id===t}));if(!a){return false}this.controller.getStore().dispatch("messages/actionStart",{chatId:a.chatId,id:a.id}).then((function(){i.controller.getStore().dispatch("files/update",{chatId:a.chatId,id:a.file.id,fields:{status:m.FileStatus.upload,progress:0}})}));a.sending=false;this.processSendMessages();return true}},{key:"processSendMessages",value:function e(){var t=this;this.messagesQueue.filter((function(e){return!e.sending})).forEach((function(e){e.sending=true;if(e.file){if(e.file.source==="disk"){t.fileCommit({chatId:e.chatId,dialogId:e.dialogId,diskId:e.file.uploadLink,messageText:e.text,messageId:e.id,fileId:e.file.id,fileType:o.FilesModel.getType(e.file.name)},e)}else{if(t.controller.application.getDiskFolderId()){t.sendMessageWithFile(e)}else{e.sending=false;t.requestDiskFolderId()}}}else{e.sending=true;t.sendMessage(e)}}));return true}},{key:"processMarkReadMessages",value:function e(){this.controller.application.readMessageExecute(this.controller.application.getChatId(),true);return true}},{key:"sendMessage",value:function e(t){t.text=t.text.replace(/^([-]{21}\n)/gm,"-".repeat(54)+"\n");this.controller.application.stopWriting(t.dialogId);window.imDialogMessagesTasks.push({taskId:"sendMessage|"+t.id});BXMobileApp.Events.postToComponent("chatbackground::task::add",["sendMessage|"+t.id,[m.RestMethod.imMessageAdd,{TEMPLATE_ID:t.id,DIALOG_ID:t.dialogId,MESSAGE:t.text}],t],"background")}},{key:"sendMessageWithFile",value:function e(t){var i=o.FilesModel.getType(t.file.name);var a=t.file.name.toString().toLowerCase().split(".").splice(-1)[0];var s=i!==m.FileType.image&&t.file.preview;var n=i===m.FileType.image&&t.file.type!=="image/gif"||i===m.FileType.video;window.imDialogUploadTasks.push({taskId:"imDialogFileUpload|"+t.file.id});BX.MobileUploadProvider.addTasks([{url:t.file.uploadLink,params:t,name:t.file.name,type:a,mimeType:i===m.FileType.audio?"audio/mp4":null,resize:!n?null:{quality:80,width:1920,height:1080},previewUrl:s?t.file.preview.url:"",folderId:this.controller.application.getDiskFolderId(),taskId:"imDialogFileUpload|"+t.file.id,onDestroyEventName:"onimdiskmessageaddsuccess"}])}},{key:"fileError",value:function e(t,i){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.controller.getStore().dispatch("files/update",{chatId:t,id:i,fields:{status:m.FileStatus.error,progress:0}});if(a){this.controller.getStore().dispatch("messages/actionError",{chatId:t,id:a,retry:true})}}},{key:"fileCommit",value:function e(t,i){var a={chat_id:t.chatId,message:t.messageText,template_id:t.messageId?t.messageId:0,file_template_id:t.fileId?t.fileId:0};if(t.uploadId){a.upload_id=t.uploadId}else if(t.diskId){a.disk_id=t.diskId}BXMobileApp.Events.postToComponent("chatbackground::task::add",["uploadFileFromDisk|"+i.id,[m.RestMethod.imDiskFileCommit,a],i],"background")}},{key:"requestDiskFolderId",value:function e(){var t=this;if(this.flagRequestDiskFolderIdSended||this.controller.application.getDiskFolderId()){return true}this.flagRequestDiskFolderIdSended=true;this.controller.restClient.callMethod(m.RestMethod.imDiskFolderGet,{chat_id:this.controller.application.getChatId()}).then((function(e){t.controller.executeRestAnswer(m.RestMethodHandler.imDiskFolderGet,e);t.flagRequestDiskFolderIdSended=false;t.processSendMessages()}))["catch"]((function(e){t.flagRequestDiskFolderIdSended=false;t.controller.executeRestAnswer(m.RestMethodHandler.imDiskFolderGet,e)}));return true}},{key:"getDialogHistory",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();this.controller.restClient.callMethod(m.RestMethod.imDialogMessagesGet,{CHAT_ID:this.controller.application.getChatId(),LAST_ID:t,LIMIT:a,CONVERT_TEXT:"Y"}).then((function(e){i.controller.executeRestAnswer(m.RestMethodHandler.imDialogMessagesGet,e)}))["catch"]((function(e){}))}},{key:"getDialogUnread",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();if(this.promiseGetDialogUnreadWait){return this.promiseGetDialogUnread}this.promiseGetDialogUnread=new BX.Promise;this.promiseGetDialogUnreadWait=true;if(!t){t=this.controller.getStore().getters["messages/getLastId"](this.controller.application.getChatId())}if(!t){this.promiseGetDialogUnread.reject();this.promiseGetDialogUnreadWait=false;return this.promiseGetDialogUnread}f.EventEmitter.emitAsync(m.EventType.dialog.readMessage,{id:t,skipAjax:true}).then((function(){var e;i.timer.start("data","load",.5,(function(){console.warn("ChatDialog.requestData: slow connection show progress icon");app.titleAction("setParams",{useProgress:true,useLetterImage:false})}));var o=(e={},babelHelpers.defineProperty(e,m.RestMethodHandler.imDialogRead,[m.RestMethod.imDialogRead,{dialog_id:i.controller.application.getDialogId(),message_id:t}]),babelHelpers.defineProperty(e,m.RestMethodHandler.imChatGet,[m.RestMethod.imChatGet,{dialog_id:i.controller.application.getDialogId()}]),babelHelpers.defineProperty(e,m.RestMethodHandler.imDialogMessagesGetUnread,[m.RestMethod.imDialogMessagesGet,{chat_id:i.controller.application.getChatId(),first_id:t,limit:a,convert_text:"Y"}]),e);i.controller.restClient.callBatch(o,(function(e){if(!e){i.promiseGetDialogUnread.reject();i.promiseGetDialogUnreadWait=false;return false}var t=e[m.RestMethodHandler.imChatGet];if(!t.error()){i.controller.executeRestAnswer(m.RestMethodHandler.imChatGet,t)}var a=e[m.RestMethodHandler.imDialogMessagesGetUnread];if(!a.error()){a=a.data();i.controller.getStore().dispatch("users/set",a.users);i.controller.getStore().dispatch("files/set",i.controller.application.prepareFilesBeforeSave(a.files));i.controller.getStore().dispatch("messages/setAfter",a.messages).then((function(){app.titleAction("setParams",{useProgress:false,useLetterImage:true});i.timer.stop("data","load",true);i.promiseGetDialogUnread.fulfill(e);i.promiseGetDialogUnreadWait=false;return true}))}else{i.promiseGetDialogUnread.reject();i.promiseGetDialogUnreadWait=false;return false}}),false,false,h.Utils.getLogTrackingParams({name:m.RestMethodHandler.imDialogMessagesGetUnread,dialog:i.controller.application.getDialogData()}))}));return this.promiseGetDialogUnread}},{key:"retrySendMessage",value:function e(t){var i=this.messagesQueue.find((function(e){return e.id===t.id}));if(i){if(i.file&&i.file.id){this.retryUploadFile(i.file.id)}return false}this.messagesQueue.push({id:t.id,chatId:this.controller.application.getChatId(),dialogId:this.controller.application.getDialogId(),text:t.text,sending:false});this.controller.application.setSendingMessageFlag(t.id);this.processSendMessages()}},{key:"openProfile",value:function e(t){BXMobileApp.Events.postToComponent("onUserProfileOpen",[t,{backdrop:true}],"communication")}},{key:"openDialog",value:function e(t){BXMobileApp.Events.postToComponent("onOpenDialog",[{dialogId:t},true],"im.recent");BXMobileApp.Events.postToComponent("ImMobile.Messenger.Dialog:open",[{dialogId:t}],"im.messenger")}},{key:"openPhoneMenu",value:function e(t){BX.MobileTools.phoneTo(t)}},{key:"openMessageMenu",value:function e(t){var i=this;if(this.messagesQueue.find((function(e){return e.id===t.id}))){return false}this.controller.getStore().dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{blink:true}});var a=this.controller.application.getCurrentUser();var o=this.controller.application.getDialogData();var s=t.authorId>0?this.controller.getStore().getters["users/get"](t.authorId,true):null;this.messageMenuInstance=BackdropMenu.create("im.dialog.menu.mess|"+this.controller.application.getDialogId()).setTestId("im-dialog-menu-mess").setItems([BackdropMenuItem.create("reply").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_REPLY")).setIcon(BackdropMenuIcon.reply).skip((function(e){var t=i.controller.application.getDialogData();if(t.type==="announcement"&&!t.managerList.includes(i.controller.application.getUserId())){return true}return!e.authorId||e.authorId===i.controller.application.getUserId()})),BackdropMenuItem.create("copy").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_COPY")).setIcon(BackdropMenuIcon.copy).skip((function(e){return e.params.IS_DELETED==="Y"})),BackdropMenuItem.create("quote").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_QUOTE")).setIcon(BackdropMenuIcon.quote).skip((function(e){var t=i.controller.application.getDialogData();if(t.type==="announcement"&&!t.managerList.includes(i.controller.application.getUserId())){return true}return e.params.IS_DELETED==="Y"})),BackdropMenuItem.create("unread").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_UNREAD")).setIcon(BackdropMenuIcon.unread).skip((function(e){return e.authorId===i.controller.application.getUserId()||e.unread})),BackdropMenuItem.create("read").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_READ")).setIcon(BackdropMenuIcon.checked).skip((function(e){return!e.unread})),BackdropMenuItem.create("edit").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_EDIT")).setIcon(BackdropMenuIcon.edit).skip((function(e){return e.authorId!==i.controller.application.getUserId()||e.params.IS_DELETED==="Y"})),BackdropMenuItem.create("share").setType(BackdropMenuItemType.menu).setIcon(BackdropMenuIcon.circle_plus).setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_SHARE_MENU")).disableClose().skip(a.extranet||o.type==="announcement"),BackdropMenuItem.create("profile").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_PROFILE")).setIcon(BackdropMenuIcon.user).skip((function(e){if(e.authorId<=0||!s)return true;if(!h.Utils.dialog.isChatId(i.controller.application.getDialogId()))return true;if(e.authorId===i.controller.application.getUserId())return true;if(s.externalAuthId==="imconnector"||s.externalAuthId==="call"){return true}return false})),BackdropMenuItem.create("delete").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_DELETE")).setStyles(BackdropMenuStyle.create().setFont(WidgetListItemFont.create().setColor("#c50000"))).setIcon(BackdropMenuIcon.trash).skip((function(e){return e.authorId!==i.controller.application.getUserId()||e.params.IS_DELETED==="Y"}))]).setVersion(BX.componentParameters.get("WIDGET_BACKDROP_MENU_VERSION","1.0.0")).setEventListener((function(e,t,a,o){if(e==="destroyed"){c.Vue.event.$emit("bitrixmobile:controller:focus")}if(e!=="selected"){return false}if(t.id==="reply"){i.replyToUser(a.authorId)}else if(t.id==="copy"){i.copyMessage(a.id)}else if(t.id==="quote"){i.quoteMessageClear();i.quoteMessage(a.id)}else if(t.id==="edit"){i.quoteMessageClear();i.editMessage(a.id)}else if(t.id==="delete"){i.deleteMessage(a.id)}else if(t.id==="unread"){i.unreadMessage(a.id)}else if(t.id==="read"){f.EventEmitter.emit(m.EventType.dialog.readMessage,{id:a.id})}else if(t.id==="share"){var s=i.controller.application.getDialogData();var n=BackdropMenu.create("im.dialog.menu.mess.submenu|"+i.controller.application.getDialogId()).setTestId("im-dialog-menu-mess-submenu-share").setItems([BackdropMenuItem.create("share_task").setIcon(BackdropMenuIcon.task).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_TASK")),BackdropMenuItem.create("share_post").setIcon(BackdropMenuIcon.lifefeed).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_POST_NEWS")),BackdropMenuItem.create("share_chat").setIcon(BackdropMenuIcon.chat).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_CHAT"))]).setEventListener((function(e,t,o,s){if(e!=="selected"){return false}if(t.id==="share_task"){i.shareMessage(a.id,"TASK")}else if(t.id==="share_post"){i.shareMessage(a.id,"POST")}else if(t.id==="share_chat"){i.shareMessage(a.id,"CHAT")}}));o.showSubMenu(n)}else if(t.id==="profile"){i.openProfile(a.authorId)}else{console.warn("BackdropMenuItem is not implemented",t)}}));this.messageMenuInstance.setCustomParams(t).show();fabric.Answers.sendCustomEvent("vueChatOpenDropdown",{})}},{key:"openHeaderMenu",value:function e(){var t=this;fabric.Answers.sendCustomEvent("vueChatOpenHeaderMenu",{});if(!this.headerMenu){this.headerMenu=HeaderMenu.create().setUseNavigationBarColor().setEventListener((function(e,i,a){if(e!=="selected"){return false}if(i.id==="profile"){t.openProfile(t.controller.application.getDialogId())}else if(i.id==="user_list"){t.openUserList({listType:"USERS",title:t.getLocalize("MOBILE_HEADER_MENU_USER_LIST"),backdrop:true})}else if(i.id==="user_add"){t.openAddUserDialog()}else if(i.id==="leave"){t.leaveChat()}else if(i.id==="notify"){t.controller.application.muteDialog()}else if(i.id==="call_chat_call"){BX.MobileTools.phoneTo(t.controller.application.getDialogData().entityId)}else if(i.id==="goto_crm"){var o=t.controller.application.getDialogCrmData();var s=BX.MobileTools.resolveOpenFunction("/crm/"+o.entityType+"/details/"+o.entityId+"/");if(s){s()}}else if(i.id==="reload"){new BXMobileApp.UI.NotificationBar({message:t.getLocalize("MOBILE_HEADER_MENU_RELOAD_WAIT"),color:"#d920b0ff",textColor:"#ffffff",groupId:"refresh",useLoader:true,maxLines:1,align:"center",hideOnTap:true},"copy").show();t.controller.getStoreBuilder().clearDatabase();reload()}}))}if(h.Utils.dialog.isChatId(this.controller.application.getDialogId())){var i=this.controller.application.getDialogData();var a=!this.controller.application.isDialogMuted()?this.getLocalize("MOBILE_HEADER_MENU_NOTIFY_DISABLE"):this.getLocalize("MOBILE_HEADER_MENU_NOTIFY_ENABLE");var o=!this.controller.application.isDialogMuted()?HeaderMenuIcon.notify:HeaderMenuIcon.notify_off;var s="";if(i.type===m.DialogType.call||i.type===m.DialogType.crm){var n=this.controller.application.getDialogCrmData();if(n.enabled){if(n.entityType===m.DialogCrmType.lead){s=this.getLocalize("MOBILE_GOTO_CRM_LEAD")}else if(n.entityType===m.DialogCrmType.company){s=this.getLocalize("MOBILE_GOTO_CRM_COMPANY")}else if(n.entityType===m.DialogCrmType.contact){s=this.getLocalize("MOBILE_GOTO_CRM_CONTACT")}else if(n.entityType===m.DialogCrmType.deal){s=this.getLocalize("MOBILE_GOTO_CRM_DEAL")}else{s=this.getLocalize("MOBILE_GOTO_CRM")}}}if(i.type===m.DialogType.call){this.headerMenu.setItems([HeaderMenuItem.create("call_chat_call").setTitle(this.getLocalize("MOBILE_HEADER_MENU_AUDIO_CALL")).setIcon(HeaderMenuIcon.phone).skip(i.entityId==="UNIFY_CALL_CHAT"),HeaderMenuItem.create("goto_crm").setTitle(s).setIcon(HeaderMenuIcon.lifefeed).skip(i.entityId==="UNIFY_CALL_CHAT"||!s),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)])}else{var r=[HeaderMenuItem.create("notify").setTitle(a).setIcon(o).skip(!i.restrictions.mute),HeaderMenuItem.create("user_list").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_LIST")).setIcon(HeaderMenuIcon.user).skip(!i.restrictions.userList),HeaderMenuItem.create("user_add").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_ADD")).setIcon(HeaderMenuIcon.user_plus).skip(!i.restrictions.extend),HeaderMenuItem.create("leave").setTitle(this.getLocalize("MOBILE_HEADER_MENU_LEAVE")).setIcon(HeaderMenuIcon.cross).skip(!i.restrictions.leave),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)];r.push(HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload));if(i.type===m.DialogType.crm&&s){r.unshift(HeaderMenuItem.create("goto_crm").setTitle(s).setIcon(HeaderMenuIcon.lifefeed))}this.headerMenu.setItems(r)}}else{var l=false;var c=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId(),true);if(c.bot&&c.externalAuthId==="support24"){l=true}this.headerMenu.setItems([HeaderMenuItem.create("profile").setTitle(this.getLocalize("MOBILE_HEADER_MENU_PROFILE")).setIcon("user").skip((function(){if(h.Utils.dialog.isChatId(t.controller.application.getDialogId())){return true}var e=t.controller.getStore().getters["users/get"](t.controller.application.getDialogId(),true);if(e.bot){return true}return false})),HeaderMenuItem.create("user_add").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_ADD")).setIcon(HeaderMenuIcon.user_plus).skip(l),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)])}this.headerMenu.show(true)}},{key:"shareMessage",value:function e(t,i){if(!this.controller.isOnline()){return false}return this.controller.application.shareMessage(t,i)}},{key:"unreadMessage",value:function e(t){if(!this.controller.isOnline()){return false}return this.controller.application.unreadMessage(t)}},{key:"openReadedList",value:function e(t){if(!h.Utils.dialog.isChatId(this.controller.application.getDialogId())){return false}if(!t||t.length<=1){return false}this.openUserList({users:t.map((function(e){return e.userId})),title:this.getLocalize("MOBILE_MESSAGE_LIST_VIEW")})}},{key:"replyToUser",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this.controller.isOnline()){return false}if(!i){i=this.controller.getStore().getters["users/get"](t)}return this.insertText({text:"[USER=".concat(t,"]").concat(i.firstName,"[/USER] ")})}},{key:"copyMessage",value:function e(t){var i=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);var a="";if(i.params.FILE_ID&&i.params.FILE_ID.length){a=i.params.FILE_ID.map((function(e){return"[DISK="+e+"]"})).join(" ")}if(i.text){if(a){a+="\n"}a+=i.text.replace(/^([-]{54}\n)/gm,"-".repeat(21)+"\n")}a=a.replace(/\[url](.*?)\[\/url]/gi,(function(e,t){return t}));app.exec("copyToClipboard",{text:a});new BXMobileApp.UI.NotificationBar({message:BX.message("MOBILE_MESSAGE_MENU_COPY_SUCCESS"),color:"#af000000",textColor:"#ffffff",groupId:"clipboard",maxLines:1,align:"center",isGlobal:true,useCloseButton:true,autoHideTimeout:1500,hideOnTap:true},"copy").show()}},{key:"quoteMessage",value:function e(t){var i=this;this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:t}}).then((function(){if(!i.controller.getStore().state.application.mobile.keyboardShow){i.setTextFocus();setTimeout((function(){f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:i.controller.application.getChatId(),duration:300,cancelIfScrollChange:false,force:true})}),300)}}))}},{key:"quoteMessageClear",value:function e(){this.setText("");this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:0,editId:0}})}},{key:"editMessage",value:function e(t){var i=this;var a=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:t,editId:t}}).then((function(){setTimeout((function(){return f.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:i.controller.application.getChatId(),duration:300,cancelIfScrollChange:false,force:true})}),300);i.setTextFocus()}));this.setText(a.text)}},{key:"updateMessage",value:function e(t,i){this.quoteMessageClear();this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{editId:0}});this.editMessageSend(t,i)}},{key:"editMessageSend",value:function e(t,i){this.controller.restClient.callMethod(m.RestMethod.imMessageUpdate,{MESSAGE_ID:t,MESSAGE:i},null,null,h.Utils.getLogTrackingParams({name:m.RestMethod.imMessageUpdate,data:{timMessageType:"text"},dialog:this.controller.application.getDialogData()}))}},{key:"deleteMessage",value:function e(t){var i=this;var a=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);var o=this.controller.getStore().getters["files/getList"](this.controller.application.getChatId());var s=h.Utils.text.purify(a.text,a.params,o,this.getLocalize());s=s.length>50?s.substr(0,47)+"...":s;app.confirm({title:this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_CONFIRM"),text:s?'"'+s+'"':"",buttons:[this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_YES"),this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_NO")],callback:function e(a){if(a===1){i.quoteMessageClear();i.deleteMessageSend(t)}}})}},{key:"deleteMessageSend",value:function e(t){this.controller.restClient.callMethod(m.RestMethod.imMessageDelete,{MESSAGE_ID:t},null,null,h.Utils.getLogTrackingParams({name:m.RestMethod.imMessageDelete,data:{},dialog:this.controller.application.getDialogData(this.controller.application.getDialogId())}))}},{key:"insertText",value:function e(t){var i=this;BXMobileApp.UI.Page.TextPanel.getText((function(e){e=e.toString().trim();e=e?e+" "+t.text:t.text;i.setText(e);i.setTextFocus()}))}},{key:"setText",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";t=t.toString();if(t){BXMobileApp.UI.Page.TextPanel.setText(t)}else{BXMobileApp.UI.Page.TextPanel.clear()}this.setTextareaMessage({message:t});console.log("Set new text in textarea",t?t:"-- empty --")}},{key:"clearText",value:function e(){this.setText()}},{key:"setTextFocus",value:function e(){if(!this.controller.getStore().state.application.mobile.keyboardShow){BXMobileApp.UI.Page.TextPanel.focus()}}},{key:"isBackground",value:function e(){if((typeof BXMobileAppContext==="undefined"?"undefined":babelHelpers["typeof"](BXMobileAppContext))!=="object"){return false}if(typeof BXMobileAppContext.isAppActive==="function"&&!BXMobileAppContext.isAppActive()){return true}if(typeof BXMobileAppContext.isBackground==="function"){return BXMobileAppContext.isBackground()}return false}},{key:"hideSmiles",value:function e(){}},{key:"changeDialogState",value:function e(t){console.log("changeDialogState -> ".concat(t));if(t==="show"){this.setIosInset()}}},{key:"executeBackgroundTaskSuccess",value:function e(t,i){var a={error:function e(){return false},data:function e(){return i.result}};console.log("Dialog.executeBackgroundTaskSuccess",t,i);if(t==="sendMessage"){this.controller.executeRestAnswer(m.RestMethodHandler.imMessageAdd,a,i.extra)}else if(t==="readMessage"){this.processMarkReadMessages()}else if(t==="uploadFileFromDisk"){this.controller.executeRestAnswer(m.RestMethodHandler.imMessageAdd,a,i.extra)}}},{key:"executeBackgroundTaskFailure",value:function e(t,i){var a={error:function e(){return{error:i.code,error_description:i.text,ex:{status:i.status}}},data:function e(){return false}};console.log("Dialog.executeBackgroundTaskFailure",t,i);if(i.status===F){if(t==="sendMessage"||t==="uploadFileFromDisk"){this.controller.executeRestAnswer(m.RestMethodHandler.imMessageAdd,a,i.extra)}}}},{key:"setError",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";console.error("MobileChat.error: ".concat(t," (").concat(i,")"));var a="";if(t.endsWith("LOCALIZED")){a=i}this.controller.getStore().commit("application/set",{error:{active:true,code:t,description:a}})}},{key:"clearError",value:function e(){this.controller.getStore().commit("application/set",{error:{active:false,code:"",description:""}})}},{key:"addLocalize",value:function e(t){return this.controller.addLocalize(t)}},{key:"getLocalize",value:function e(t){return this.controller.getLocalize(t)}},{key:"onMessagesSet",value:function e(){this.messagesSet=true;BXMobileApp.Events.postToComponent("chatbackground::task::restart",[],"background");BXMobileApp.Events.postToComponent("chatuploader::task::restart",[],"background")}}]);return e}();e.MobileDialogApplication=N})(this.BX.Messenger.Application=this.BX.Messenger.Application||{},BX.Messenger.Application,BX.Main,BX,BX.Messenger.Model,BX.Messenger.Provider.Rest,BX.Messenger.Lib,window,BX,BX,BX.Messenger,BX,BX,window,BX.Messenger.Lib,BX.Event,BX.Messenger.Const,BX.Messenger.EventHandler,BX.Messenger.Lib,BX.Messenger.Lib);
//# sourceMappingURL=dialog.bundle.map.js