"use strict";(function(){const e="/bitrix/js/im/images/blank.gif";const t={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};const l=10;const n=45;BX.Call={};BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Busy:"Busy",Calling:"Calling",Unavailable:"Unavailable",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.JoinStatus={None:"none",Local:"local",Remote:"remote"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Quality={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};BX.Call.UserMnemonic={all:"all",none:"none"};BX.Call.Event={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserMicrophoneState:"onUserMicrophoneState",onUserCameraState:"onUserCameraState",onUserScreenState:"onUserScreenState",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onUserFloorRequest:"onUserFloorRequest",onUserEmotion:"onUserEmotion",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onJoin:"onJoin",onLeave:"onLeave",onActive:"onActive",onInactive:"onInactive",onDestroy:"onDestroy"};class a{constructor(){this.calls={};this.unknownCalls={};this.debugFlag=false;this.pullStatus="";this._onPullEventHandler=this._onPullEvent.bind(this);this._onPullClientEventHandler=this._onPullClientEvent.bind(this);BX.addCustomEvent("onPullEvent-im",this._onPullEventHandler);BX.addCustomEvent("onPullClientEvent-im",this._onPullClientEventHandler);BX.addCustomEvent("onAppActive",this.onAppActive.bind(this));BX.addCustomEvent("onPullStatus",(e=>{this.pullStatus=e.status;console.log("["+CallUtil.getTimeForLog()+"]: pull status: "+this.pullStatus)}));this._onCallJoinHandler=this._onCallJoin.bind(this);this._onCallLeaveHandler=this._onCallLeave.bind(this);this._onCallDestroyHandler=this._onCallDestroy.bind(this);this._onCallInactiveHandler=this._onCallInactive.bind(this);this._onCallActiveHandler=this._onCallActive.bind(this);this._onNativeIncomingCallHandler=this._onNativeIncomingCall.bind(this);if("callservice"in window){callservice.on("incoming",this._onNativeIncomingCallHandler);if(callservice.currentCall()){setTimeout((()=>this._onNativeIncomingCall(callservice.currentCall())),0)}}this.startWithPush();setTimeout((()=>BX.postComponentEvent("onPullGetStatus",[],"communication")),100)}onAppActive(){for(var e in this.calls){if(this.calls.hasOwnProperty(e)&&this.calls[e]instanceof PlainCall&&!this.calls[e].ready&&!this.isNativeCall(e)&&new Date-this.calls[e].created>3e4){console.warn("Destroying stale call "+e);this.calls[e].destroy()}}this.startWithPush()}startWithPush(){const e=Application.getLastNotification();if(!e.id||!e.id.startsWith("IM_CALL_")){return}let t;try{t=JSON.parse(e.params)}catch(e){navigator.notification.alert(BX.message("MOBILE_CALL_INTERNAL_ERROR").replace("#ERROR_CODE#","E005"))}if(!t.ACTION||!t.ACTION.startsWith("IMINV_")||!t.PARAMS||!t.PARAMS.call){return}console.log("Starting with PUSH: ",e);let l=t.PARAMS.call;let a=t.PARAMS.video;let i=l.ID;let s=t.PARAMS.ts;let o=(new Date).getTime()/1e3-s;console.log("timeAgo: ",o);this._onUnknownCallPing(i,o,n).then((e=>{if(e&&this.calls[i]){BX.postComponentEvent("CallEvents::incomingCall",[{callId:i,video:a,autoAnswer:true}],"calls")}})).catch((e=>console.error(e)))}shouldCallBeAutoAnswered(e){if(Application.getPlatform()!=="android"){return false}const t=Application.getLastNotification();if(!t.id||!t.id.startsWith("IM_CALL_")){return false}try{let l=JSON.parse(t.params);if(!l.ACTION||!l.ACTION.startsWith("IMINV_")||!l.PARAMS||!l.PARAMS.call){return false}let n=l.PARAMS.call;let a=n.ID;return e==a}catch(e){return false}}_onNativeIncomingCall(e){console.log("_onNativeIncomingCall",e);if(e.params.type!=="internal"){return}let t=e.params.video;let l=e.params.call.ID;let n=e.params.ts;let a=(new Date).getTime()/1e3-n;if(a>15){console.error("Call originated too long time ago")}if(this.calls[l]){console.error("Call "+l+" is already known");return}this._instantiateCall(e.params.call,e.params.users,e.params.logToken);BX.postComponentEvent("CallEvents::incomingCall",[{callId:l,video:t,isNative:true}],"calls")}createCall(e){return new Promise(((l,n)=>{let a=e.type||BX.Call.Type.Instant;let i=e.provider||"Plain";if(e.joinExisting){for(var s in this.calls){if(this.calls.hasOwnProperty(s)){var r=this.calls[s];if(r.provider==e.provider&&r.associatedEntity.type==e.entityType&&r.associatedEntity.id==e.entityId){this.log(s,"Found existing call, attaching to it");return l({call:r,isNew:false})}}}}let c={type:a,provider:i,entityType:e.entityType,entityId:e.entityId,joinExisting:!!e.joinExisting,userIds:BX.type.isArray(e.userIds)?e.userIds:[]};this.getRestClient().callMethod(t.createCall,c).then((t=>{if(t.error()){let e=t.error().getError();return n({code:e.error,message:e.error_description})}let a=t.data();if(a.userData){}if(a.publicChannels){BX.PULL.setPublicIds(Object.values(a.publicChannels))}let i=a.call;if(this.calls[i["ID"]]){if(this.calls[i["ID"]]instanceof o){this.calls[i["ID"]].destroy()}else{console.warn("Call "+i["ID"]+" already exists");return l({call:this.calls[i["ID"]],isNew:false})}}let s=this._getCallFactory(i["PROVIDER"]);let r=s.createCall({id:parseInt(i["ID"],10),instanceId:this.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:a.users,videoEnabled:e.videoEnabled===true,enableMicAutoParameters:e.enableMicAutoParameters!==false,associatedEntity:i.ASSOCIATED_ENTITY,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},debug:e.debug===true,logToken:a.logToken});this.calls[i["ID"]]=r;if(a.isNew){this.log(r.id,"Creating new call")}else{this.log(r.id,"Server returned existing call, attaching to it")}BX.postComponentEvent("CallEvents::active",[this._getCallFields(r),r.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(r),r.joinStatus],"im.messenger");l({call:r,isNew:a.isNew})})).catch((function(e){let t=e.answer||e;n({code:t.error||0,message:t.error_description||t})}))}))}getCallWithId(e){return new Promise(((l,n)=>{if(this.calls[e]){return l({call:this.calls[e],isNew:false})}this.getRestClient().callMethod(t.getCall,{callId:e}).then((t=>{let a=t.data();if(a.call.END_DATE){BX.postComponentEvent("CallEvents::inactive",[e],"im.recent");BX.postComponentEvent("CallEvents::inactive",[e],"im.messenger");return n({code:"ALREADY_FINISHED"})}l({call:this._instantiateCall(a.call,a.users,a.logToken),isNew:false})})).catch((function(e){if(typeof e.error==="function"){e=e.error().getError()}n({code:e.error,message:e.error_description})}))}))}getUuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=Math.random()*16|0,l=e=="x"?t:t&3|8;return l.toString(16)}))}debug(e){if(typeof e!="boolean"){e=!this.debugFlag}this.debugFlag=e;console.warn("Debug "+(this.debugFlag?"enabled":"disabled"))}log(e,...t){if(this.calls[e]){this.calls[e].log(...t)}else{console.log.apply(console,arguments)}}getRestClient(){return BX.rest}getLogService(){return BX.componentParameters.get("callLogService","")}isCallServerAllowed(){return BX.componentParameters.get("sfuServerEnabled",true)}isNativeCall(e){if(!("callservice"in window)){return false}const t=callservice.currentCall();return t&&t.params.call.ID==e}_onPullEvent(e,t,n){let a={"Call::incoming":this._onPullIncomingCall.bind(this)};if(e.startsWith("Call::")&&t.publicIds){BX.PULL.setPublicIds(Object.values(t.publicIds))}if(a[e]){a[e].call(this,t,n)}else if(e.startsWith("Call::")&&(t["call"]||t["callId"])){let a=t["call"]?t["call"]["ID"]:t["callId"];if(this.calls[a]){this.calls[a]._onPullEvent(e,t,n)}else if(e==="Call::ping"){this._onUnknownCallPing(t.callId,n.server_time_ago,l).then((l=>{if(l&&this.calls[a]){this.calls[a]._onPullEvent(e,t,n)}}))}}}_onPullClientEvent(e,t,n){if(e.startsWith("Call::")&&t["callId"]){let a=t["callId"];if(this.calls[a]){this.calls[a]._onPullEvent(e,t,n)}else if(e==="Call::ping"){this._onUnknownCallPing(t.callId,n.server_time_ago,l).then((l=>{if(l&&this.calls[a]){this.calls[a]._onPullEvent(e,t,n)}}))}}}_onPullIncomingCall(e,t){if(t.server_time_ago>30){console.error("Call was started too long time ago");return}let l=e.call;let n=parseInt(l.ID,10);let a;if(e.userData){}if(this.calls[n]){a=this.calls[n]}else{let t=this._getCallFactory(l.PROVIDER);a=t.createCall({id:n,instanceId:this.getUuidv4(),parentId:l.PARENT_ID||null,callFromMobile:e.isLegacyMobile===true,direction:BX.Call.Direction.Incoming,users:e.users,initiatorId:e.senderId,associatedEntity:l.ASSOCIATED_ENTITY,type:l.TYPE,startDate:l.START_DATE,logToken:e.logToken,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler}});this.calls[n]=a;BX.postComponentEvent("CallEvents::active",[this._getCallFields(a),a.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(a),a.joinStatus],"im.messenger")}console.log(a);if(a&&!(a instanceof o)){a.addInvitedUsers(e.invitedUsers);BX.postComponentEvent("CallEvents::incomingCall",[{callId:n,video:e.video===true,isLegacyMobile:e.isLegacyMobile===true,userData:e.userData||null,autoAnswer:this.shouldCallBeAutoAnswered(n)}],"calls");a.log("Incoming call "+a.id)}}_onUnknownCallPing(e,t,l){return new Promise(((n,a)=>{e=parseInt(e,10);if(t>l){this.log(e,"Error: Ping was sent too long time ago");return n(false)}if(this.unknownCalls[e]){return n(false)}this.unknownCalls[e]=true;this.getCallWithId(e).then((t=>{this.unknownCalls[e]=false;n(true)})).catch((t=>{this.unknownCalls[e]=false;this.log(e,"Error: Could not instantiate call",t);n(false)}))}))}_instantiateCall(e,t,l){if(this.calls[e["ID"]]){console.error("Call "+e["ID"]+" already exists");return this.calls[e["ID"]]}let n=this._getCallFactory(e["PROVIDER"]);let a=n.createCall({id:parseInt(e["ID"],10),instanceId:this.getUuidv4(),initiatorId:parseInt(e["INITIATOR_ID"],10),parentId:e["PARENT_ID"],direction:e["INITIATOR_ID"]==env.userId?BX.Call.Direction.Outgoing:BX.Call.Direction.Incoming,users:t,associatedEntity:e["ASSOCIATED_ENTITY"],type:e["TYPE"],startDate:e["START_DATE"],logToken:l,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler}});this.calls[e["ID"]]=a;BX.postComponentEvent("CallEvents::active",[this._getCallFields(a),a.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(a),a.joinStatus],"im.messenger");return a}_getCallFields(e){return{id:e.id,provider:e.provider,associatedEntity:e.associatedEntity}}_getCallFactory(e){if(e==BX.Call.Provider.Plain){return i}else if(e==BX.Call.Provider.Voximplant){return s}throw Error("Unknown call provider type "+e)}_onCallJoin(e){let t=this.calls[e.callId];if(t&&!(t instanceof o)){console.warn("CallEvents::active",e.callId,t.joinStatus);BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.messenger")}}_onCallLeave(e){let t=this.calls[e.callId];if(t&&!(t instanceof o)){console.warn("CallEvents::active",e.callId,t.joinStatus);BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.messenger")}}_onCallInactive(e){console.warn("CallEvents::inactive",e);BX.postComponentEvent("CallEvents::inactive",[e],"im.recent");BX.postComponentEvent("CallEvents::inactive",[e],"im.messenger")}_onCallActive(e){let t=this.calls[e];if(t&&!(t instanceof o)){console.warn("CallEvents::active",e,t.joinStatus);BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.messenger")}}_onCallDestroy(e){let t=e.call.id;let l=this.calls[e.call];if(l){l.off(BX.Call.Event.onJoin,this._onCallJoinHandler).off(BX.Call.Event.onLeave,this._onCallLeaveHandler).off(BX.Call.Event.onDestroy,this._onCallDestroyHandler).off(BX.Call.Event.onInactive,this._onCallInactiveHandler).off(BX.Call.Event.onActive,this._onCallActiveHandler)}this.calls[t]=new o({callId:t,onDelete:()=>{if(this.calls[t]){delete this.calls[t]}}});console.warn("CallEvents::inactive",[e.call.id]);BX.postComponentEvent("CallEvents::inactive",[e.call.id],"im.recent");BX.postComponentEvent("CallEvents::inactive",[e.call.id],"im.messenger")}destroy(){BX.removeCustomEvent("onPullEvent-im",this._onPullEventHandler);BX.removeCustomEvent("onPullClientEvent-im",this._onPullClientEventHandler)}}let i={createCall(e){return new PlainCall(e)}};let s={createCall(e){return new VoximplantCall(e)}};class o{constructor(e){this.callId=e.callId;this.lifetime=e.lifetime||120;this.callbacks={onDelete:BX.type.isFunction(e.onDelete)?e.onDelete:function(){}};this.deleteTimeout=setTimeout((()=>{this.callbacks.onDelete({callId:this.callId})}),this.lifetime*1e3)}_onPullEvent(e,t,l){}isAnyoneParticipating(){return false}addEventListener(){return false}removeEventListener(){return false}destroy(){clearTimeout(this.deleteTimeout);this.callbacks.onDelete=function(){}}}class r{constructor(){this.userData={};this.usersInProcess={}}updateUserData(e,t){var l=[];for(var n=0;n<t.length;n++){if(this.userData.hasOwnProperty(t[n])){continue}l.push(t[n])}let a=new Promise(((n,a)=>{if(l.length===0){return n()}BX.rest.callMethod("im.call.getUsers",{callId:e,userIds:l}).then((e=>{let l=BX.type.isPlainObject(e.answer.result)?e.answer.result:{};t.forEach((e=>{if(l[e]){this.userData[e]=l[e]}delete this.usersInProcess[e]}));n()})).catch((function(e){a(e.answer)}))}));for(let e=0;e<l.length;e++){this.usersInProcess[l[e]]=a}return a}getUsers(e,t){return new Promise(((l,n)=>{this.updateUserData(e,t).then((()=>{let e={};t.forEach((t=>e[t]=this.userData[t]||{}));return l(e)})).catch((e=>n(e)))}))}setUserData(e){for(let t in e){this.userData[t]=e[t]}}getDateForLog(){var e=new Date;return e.getFullYear()+"-"+this.lpad(e.getMonth()+1,2,"0")+"-"+this.lpad(e.getDate(),2,"0")+" "+this.lpad(e.getHours(),2,"0")+":"+this.lpad(e.getMinutes(),2,"0")+":"+this.lpad(e.getSeconds(),2,"0")+"."+e.getMilliseconds()}getTimeForLog(){var e=new Date;return this.lpad(e.getHours(),2,"0")+":"+this.lpad(e.getMinutes(),2,"0")+":"+this.lpad(e.getSeconds(),2,"0")+"."+e.getMilliseconds()}log(){console.log(this.getLogMessage.apply(this,arguments))}warn(){console.warn(this.getLogMessage.apply(this,arguments))}error(){console.error(this.getLogMessage.apply(this,arguments))}formatSeconds(e){e=Math.floor(e);let t=e%60;let l=(e-t)/60;return this.lpad(l,2,"0")+":"+this.lpad(t,2,"0")}lpad(e,t,l){e=e.toString();l=l||" ";if(e.length>t){return e}var n="";for(var a=0;a<t-e.length;a++){n+=l}return n+e}isAvatarBlank(t){return typeof t!=="string"||t==""||t.endsWith(e)}makeAbsolute(e){var t;if(typeof e!=="string"){return e}if(e.startsWith("http")){t=e}else{t=e.startsWith("/")?currentDomain+e:currentDomain+"/"+e}return t}getCustomMessage(e,t){var l;if(!BX.type.isPlainObject(t)){t={}}if(t.gender&&BX.message.hasOwnProperty(e+"_"+t.gender)){l=BX.message(e+"_"+t.gender)}else{l=BX.message(e)}t=this.convertKeysToUpper(t);return l.replace(/#.+?#/gm,(function(e){var l=e.substr(1,e.length-2);return t.hasOwnProperty(l)?t[l]:e}))}isCallServerAllowed(){return BX.message("call_server_enabled")==="Y"}getUserLimit(){if(this.isCallServerAllowed()){return parseInt(BX.message("call_server_max_users"))}return parseInt(BX.message("turn_server_max_users"))}getLogMessage(){var e=this.getDateForLog();for(var t=0;t<arguments.length;t++){if(arguments[t]instanceof Error){e=arguments[t].message+"\n"+arguments[t].stack}else{try{e=e+" | "+(typeof arguments[t]=="object"?this.printObject(arguments[t]):arguments[t])}catch(t){e=e+" | (circular structure)"}}}return e}printObject(e){let t="[";for(let l in e){if(e.hasOwnProperty(l)){let n=e[l];switch(typeof n){case"object":t+=l+(n===null?": null; ":": (object); ");break;case"string":case"number":case"boolean":t+=l+": "+n.toString()+"; ";break;default:t+=l+": ("+typeof n+"); "}}}return t+"]"}getUuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=Math.random()*16|0,l=e=="x"?t:t&3|8;return l.toString(16)}))}debounce(e,t,l){let n=0;return function(){clearTimeout(n);n=setTimeout((()=>e.apply(l,arguments)),t)}}array_flip(e){let t={};for(let l in e){t[e[l]]=l}return t}isDeviceSupported(){return Application.getApiVersion()>=36}forceBackgroundConnectPull(e=10){return new Promise(((t,l)=>{if(callEngine&&callEngine.pullStatus==="online"){t();return}var n=function(){console.error("Timeout while waiting for p&p to connect");BX.removeCustomEvent("onPullStatus",i);l("connect timeout")};var a=setTimeout(n,e*1e3);var i=({status:e,additional:n})=>{if(!n){n={}}if(e==="online"){BX.removeCustomEvent("onPullStatus",i);clearTimeout(a);t()}if(e==="offline"&&n.isError){BX.removeCustomEvent("onPullStatus",i);clearTimeout(a);l("connect error")}};BX.addCustomEvent("onPullStatus",i);BX.postComponentEvent("onPullForceBackgroundConnect",[],"communication")}))}showDeviceAccessConfirm(e,t=(()=>{}),l=(()=>{})){return new Promise((n=>{navigator.notification.confirm(e?BX.message("MOBILE_CALL_MICROPHONE_CAMERA_REQUIRED"):BX.message("MOBILE_CALL_MICROPHONE_REQUIRED"),(e=>e==1?t():l()),e?BX.message("MOBILE_CALL_NO_MICROPHONE_CAMERA_ACCESS"):BX.message("MOBILE_CALL_NO_MICROPHONE_ACCESS"),[BX.message("MOBILE_CALL_MICROPHONE_SETTINGS"),BX.message("MOBILE_CALL_MICROPHONE_CANCEL")])}))}}class c extends Error{constructor(e){super("Media access denied");this.name="DeviceAccessError";this.justDenied=e}}class d extends Error{constructor(){super("Call joined elsewhere");this.name="CallJoinedElseWhereError"}}window.DeviceAccessError=c;window.CallJoinedElseWhereError=d;window.CallEngine=a;window.CCallUtil=r;window.CallStub=o})();
//# sourceMappingURL=extension.map.js