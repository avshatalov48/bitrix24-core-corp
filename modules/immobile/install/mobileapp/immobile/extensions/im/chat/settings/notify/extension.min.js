(function(){this.SettingsNotifyTypes={PUSH:"push",SMART_FILTER:"smart",COUNTERS:"counters",PUSH_CATEGORY:"push_category"};class e{constructor(){this.pushTypesRename={im:BX.message("SE_NOTIFY_CATEGORY_IM_TITLE")};this.userId=BX.componentParameters.get("USER_ID",0);this.languageId=BX.componentParameters.get("LANGUAGE_ID","en");this.siteId=BX.componentParameters.get("SITE_ID","s1");this.configDataLoaded=false;this.values={push:true,smart:true};this.counterTypes=[];this.pushTypes=[];this.sessionValues={values:{},counterTypes:{},pushTypes:{}};this.database=new ReactDatabase(ChatDatabaseName,this.userId,this.languageId,this.siteId);this.requestConfigDataSend=false;this.requestConfigDataLoaded=false;this.providerId="notify";this.providerTitle=BX.message("SE_NOTIFY_TITLE");this.providerSubtitle=BX.message("SE_NOTIFY_DESC");this.forms={};this.formIdDefault=this.providerId;this.formIsVisible=BX.componentParameters.get("SETTINGS_NOTIFY_VISIBLE",false);this.formCurrent=BX.componentParameters.get("SETTINGS_NOTIFY_CURRENT",this.formIdDefault);this.provider=BX.componentParameters.get("SETTINGS_NOTIFY_PROVIDER",false);this.restQueue={};this.loadCache().then((()=>{if(!this.requestConfigDataLoaded){this.requestConfigData()}}))}loadCache(){let e=new BX.Promise;let t=new Date;this.database.table(ChatTables.notifyConfig).then((s=>{s.get().then((s=>{if(s.length<=0){e.fulfill(false);return false}let i=JSON.parse(s[0].VALUE);if(this.requestConfigDataLoaded){console.info('SettingsNotify.loadCache: cache file "notifyConfig" has been ignored because it was loaded a very late');return false}this.values=i.values;this.pushTypes=i.pushTypes;this.counterTypes=i.counterTypes;this.configDataLoaded=true;console.info(`SettingsNotify.loadCache: config load from cache (${new Date-t}ms)`);this.redrawForm(this.prepareForm(this.formCurrent));e.fulfill(true)}))}));return e}saveCache(){let e=new Date;this.database.table(ChatTables.notifyConfig).then((t=>{t.delete().then((()=>{t.add({value:{values:this.values,pushTypes:this.pushTypes,counterTypes:this.counterTypes}}).then((()=>{console.info(`SettingsNotify.saveCache: cache config updated (${new Date-e}ms)`)}))}))}))}requestConfigData(){if(this.requestConfigDataSend)return false;this.requestConfigDataSend=true;let e=new Date;BX.rest.callBatch({pushStatus:["mobile.push.status.get",{}],smartFilter:["mobile.push.smartfilter.status.get",{}],counterTypes:["mobile.counter.types.get",{USER_VALUES:"Y"}],pushTypes:["mobile.push.types.get",{USER_VALUES:"Y"}]},(t=>{this.requestConfigDataSend=false;if(t.pushStatus.error()||t.smartFilter.error()||t.counterTypes.error()||t.pushTypes.error()){console.error("SettingsNotify.requestConfigData: failed",[t.pushStatus.error(),t.smartFilter.error(),t.counterTypes.error(),t.pushTypes.error()]);return false}this.requestConfigDataLoaded=true;this.values.push=t.pushStatus.data();this.values.smart=t.smartFilter.data();this.pushTypes=t.pushTypes.data();this.counterTypes=t.counterTypes.data();console.info(`SettingsNotify.requestConfigData: config loaded and updated (${new Date-e}ms)`,[this.values,this.pushTypes,this.counterTypes]);this.configDataLoaded=true;this.saveCache();this.redrawForm(this.prepareForm(this.formCurrent))}));return true}getProviderId(){return this.providerId}getProviderTitle(){return this.providerTitle}getProviderSubtitle(){return this.providerSubtitle}prepareForm(e,t){console.info(`SettingsNotify.prepareForm: create form %c${e}`,"color: green; font-weight: bold");if(e=="notify"){let e=[];if(this.pushTypes.length>0){this.pushTypes.forEach((t=>{let s=this.pushTypesRename[t.module_id]?this.pushTypesRename[t.module_id]:t.name;e.push(new FormItem("push_category_"+t.module_id,FormItemType.BUTTON,s).setButtonTransition().setCustomParam("module_id",t.module_id))}))}else{e.push(new FormItem("loading",FormItemType.BUTTON,BX.message("SE_NOTIFY_LOADING")).setEnabled(false))}this.forms[this.formIdDefault]=new Form(this.formIdDefault,this.providerTitle).addSections([new FormSection("push").addItems([new FormItem("push",FormItemType.SWITCH,BX.message("SE_NOTIFY_PUSH_TITLE")).setEnabled(this.configDataLoaded).setValue(this.getFormItemValue({type:SettingsNotifyTypes.PUSH}))]),new FormSection("smart","",BX.message("SE_NOTIFY_SMART_FILTER_DESC")).addItems([new FormItem("smart",FormItemType.SWITCH,BX.message("SE_NOTIFY_SMART_FILTER_TITLE")).setEnabled(this.configDataLoaded).setValue(this.getFormItemValue({type:SettingsNotifyTypes.SMART_FILTER}))]),new FormSection("counters","",BX.message("SE_NOTIFY_MAIN_COUNTER_DETAIL_DESC")).addItems([new FormItem("counters",FormItemType.BUTTON,BX.message("SE_NOTIFY_MAIN_COUNTER_TITLE")).setButtonTransition(true)]),new FormSection("push_category",BX.message("SE_NOTIFY_NOTIFY_TYPES_TITLE")).addItems(e)])}else if(e=="counters"&&this.configDataLoaded){let t=[];if(this.counterTypes.length>0){this.counterTypes.forEach((e=>{t.push(new FormItem(e.type,FormItemType.SWITCH,e.name).setValue(this.getFormItemValue({type:SettingsNotifyTypes.COUNTERS,name:e.type})))}))}if(t.length<=0){t.push(new FormItem("empty",FormItemType.BUTTON,BX.message("SE_NOTIFY_EMPTY")).setEnabled(false))}this.forms[e]=new Form(e,BX.message("SE_NOTIFY_MAIN_COUNTER_TITLE")).addSection(new FormSection("counters","",BX.message("SE_NOTIFY_MAIN_COUNTER_DETAIL_DESC")).addItems(t))}else if(e.indexOf("push_category_")>-1&&this.configDataLoaded){let t=e.substr(14);let s=BX.message("SE_NOTIFY_DEFAULT_TITLE");let i=[];for(let e=0;e<this.pushTypes.length;e++){if(this.pushTypes[e].module_id!=t){continue}s=this.pushTypesRename[t]?this.pushTypesRename[t]:this.pushTypes[e].name;this.pushTypes[e].types.forEach((e=>{let s=this.pushTypesRename[t+"_"+e.type]?this.pushTypesRename[t+"_"+e.type]:e.name;i.push(new FormItem("push_category_"+t+"_"+e.type,FormItemType.SWITCH,s).setEnabled(!e.disabled).setValue(this.getFormItemValue({type:SettingsNotifyTypes.PUSH_CATEGORY,category:t,name:e.type})).setCustomParam("module_id",t).setCustomParam("type",e.type))}));break}if(i.length<=0){i.push(new FormItem("empty",FormItemType.BUTTON,BX.message("SE_NOTIFY_EMPTY")).setEnabled(false))}this.forms[e]=new Form(e,s).addSection(new FormSection("push_category").addItems(i))}else{let s=t?t.title:BX.message("SE_NOTIFY_DEFAULT_TITLE");this.forms[e]=new Form(e,s).addItems([new FormItem("loading",FormItemType.BUTTON,BX.message("SE_NOTIFY_LOADING")).setEnabled(false)])}return this.forms[e]}drawForm(e){console.info(`SettingsNotify.drawForm: %c${e.getId()}`,"color: green; font-weight: bold");this.provider.openForm(e.compile(),e.getId())}redrawForm(e){if(!this.provider||!this.formIsVisible){return false}if(!this.provider.forms[this.formCurrent]){console.error(`SettingsNotify.redrawForm: form not found - %c${e.getId()}`,"color: red; font-weight: bold");return false}console.info(`SettingsNotify.redrawForm: %c${e.getId()}`,"color: green; font-weight: bold");let{items:t,sections:s}=e.compile();this.provider.forms[this.formCurrent].setItems(t);this.provider.forms[this.formCurrent].setSections(s)}getFormItemValue(e){let{type:t,category:s,name:i}=e;if(t==SettingsNotifyTypes.PUSH){if(typeof this.sessionValues.values.push!="undefined"){return this.sessionValues.values.push}return this.values.push}else if(t==SettingsNotifyTypes.SMART_FILTER){if(typeof this.sessionValues.values.smart!="undefined"){return this.sessionValues.values.smart}return this.values.smart}else if(t==SettingsNotifyTypes.COUNTERS){if(typeof this.sessionValues.counterTypes[i]!="undefined"){return this.sessionValues.counterTypes[i]}let e=this.counterTypes.find((e=>e.type==i));return e?e.value:false}else if(t==SettingsNotifyTypes.PUSH_CATEGORY){if(typeof this.sessionValues.pushTypes[s]!="undefined"&&typeof this.sessionValues.pushTypes[s][i]!="undefined"){return this.sessionValues.pushTypes[s][i]}let e=this.pushTypes.find((e=>e.module_id===s));if(e){let t=e.types.find((e=>e.type===i));if(t){return t.value}}return false}return false}setFormItemValue(e){let{type:t,category:s,name:i,value:o}=e;if(t==SettingsNotifyTypes.PUSH){this.sessionValues.values.push=o===true;return true}else if(t==SettingsNotifyTypes.SMART_FILTER){this.sessionValues.values.smart=o===true;return true}else if(t==SettingsNotifyTypes.COUNTERS){this.sessionValues.counterTypes[i]=o===true;return true}else if(t==SettingsNotifyTypes.PUSH_CATEGORY){if(typeof this.sessionValues.pushTypes[s]=="undefined"){this.sessionValues.pushTypes[s]={}}this.sessionValues.pushTypes[s][i]=o===true;return true}return false}setSettingsProvider(e){this.provider=e;BX.componentParameters.set("SETTINGS_NOTIFY_PROVIDER",this.provider);return true}configCommit(e,t=""){if(e.indexOf(SettingsNotifyTypes.PUSH_CATEGORY)===0){if(typeof t=="object"){if(typeof this.restQueue[SettingsNotifyTypes.PUSH_CATEGORY]==="undefined"){this.restQueue[SettingsNotifyTypes.PUSH_CATEGORY]={[Symbol.iterator](){return new ObjectIterator(this)}}}this.restQueue[SettingsNotifyTypes.PUSH_CATEGORY][e]=t}}else{this.restQueue[e]=t}clearTimeout(this.restQueueTimeout);this.restQueueTimeout=setTimeout((()=>{this.configCommitWorker()}),600)}configCommitWorker(){for(let e in this.restQueue){if(!this.restQueue.hasOwnProperty(e)){continue}if(e==SettingsNotifyTypes.PUSH){console.info("SettingsNotify.configCommitWorker: push",this.restQueue[e]);BX.rest.callMethod("mobile.push.status.set",{ACTIVE:this.restQueue[e]})}else if(e==SettingsNotifyTypes.SMART_FILTER){console.info("SettingsNotify.configCommitWorker: smart filter",this.restQueue[e]);BX.rest.callMethod("mobile.push.smartfilter.status.set",{ACTIVE:this.restQueue[e]})}else if(e==SettingsNotifyTypes.COUNTERS){let e={};this.counterTypes.forEach((t=>{e[t.type]=t.value}));console.info("SettingsNotify.configCommitWorker: counters",e);BX.rest.callMethod("mobile.counter.config.set",{CONFIG:e});BX.postComponentEvent("onUpdateConfig",[e],"communication")}else if(e==SettingsNotifyTypes.PUSH_CATEGORY){let t=[];for(let s of this.restQueue[e]){t.push(s)}if(t.length>0){console.info("SettingsNotify.configCommitWorker: push types",t);BX.rest.callMethod("mobile.push.config.set",{CONFIG:t})}}}this.saveCache();this.restQueue={};return true}onDefaultFormOpen(){if(!this.requestConfigDataLoaded){this.requestConfigData()}}onSettingsProviderButtonTap(e){this.drawForm(this.prepareForm(e.id,e).setTitle(e.title));return true}onSettingsProviderValueChanged(e){if(e.sectionCode=="push"&&e.id=="push"){this.values.push=e.value;this.configCommit(SettingsNotifyTypes.PUSH,e.value);this.setFormItemValue({type:SettingsNotifyTypes.PUSH,value:e.value})}else if(e.sectionCode=="smart"&&e.id=="smart"){this.values.smart=e.value;this.configCommit(SettingsNotifyTypes.SMART_FILTER,e.value);this.setFormItemValue({type:SettingsNotifyTypes.SMART_FILTER,value:e.value})}else if(e.sectionCode=="counters"){let t=this.counterTypes.find((t=>t.type===e.id));if(t){t.value=e.value;let s={};this.counterTypes.forEach((e=>{s[e.type]=e.value}));this.configCommit(SettingsNotifyTypes.COUNTERS,s);this.setFormItemValue({type:SettingsNotifyTypes.COUNTERS,name:t.type,value:e.value})}}else if(e.sectionCode=="push_category"){let t=this.pushTypes.find((t=>t.module_id===e.params.module_id));if(t){let s=t.types.find((t=>t.type===e.params.type));if(s){s.value=e.value;this.configCommit(`push_category_${t.module_id}_${s.type}`,{module_id:t.module_id,type:s.type,active:e.value});this.setFormItemValue({type:SettingsNotifyTypes.PUSH_CATEGORY,category:t.module_id,name:s.type,value:e.value})}}}else{console.error("SettingsNotify.onSettingsProviderValueChanged: value not saved!",e)}return true}onSettingsProviderStateChanged(e,t){if(e=="onViewShown"){this.formIsVisible=true;this.formCurrent=t;BX.componentParameters.set("SETTINGS_NOTIFY_CURRENT",this.formCurrent);BX.componentParameters.set("SETTINGS_NOTIFY_VISIBLE",this.formIsVisible);if(t==this.formIdDefault){this.onDefaultFormOpen()}}else if(e=="onViewRemoved"){this.formIsVisible=false;BX.componentParameters.set("SETTINGS_NOTIFY_VISIBLE",this.formIsVisible)}return true}}this.SettingsNotifyManager=new e;BX.addCustomEvent("onRegisterProvider",(e=>{class t extends SettingsProvider{onButtonTap(e){super.onValueChanged(e);SettingsNotifyManager.setSettingsProvider(this);SettingsNotifyManager.onSettingsProviderButtonTap(e)}onValueChanged(e){super.onValueChanged(e);SettingsNotifyManager.setSettingsProvider(this);SettingsNotifyManager.onSettingsProviderValueChanged(e)}onStateChanged(e,t){super.onStateChanged(e,t);SettingsNotifyManager.setSettingsProvider(this);SettingsNotifyManager.onSettingsProviderStateChanged(e,t)}}e(new t(SettingsNotifyManager.getProviderId(),SettingsNotifyManager.getProviderTitle(),SettingsNotifyManager.getProviderSubtitle()))}))})();
//# sourceMappingURL=extension.map.js