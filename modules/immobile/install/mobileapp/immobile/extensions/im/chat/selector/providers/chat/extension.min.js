jn.define("im/chat/selector/providers/chat",((t,e,s)=>{const i="/bitrix/mobileapp/immobile/extensions/im/chat/selector/providers/chat/images/";const r={entities:{user:{itemOptions:{default:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_EMPLOYEE_SUBTITLE")},extranet:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_USER_EXTRANET_SUBTITLE"),textColor:"#ca8600"}}},"im-chat":{itemOptions:{CHANNEL:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CHANNEL_SUBTITLE")},ANNOUNCEMENT:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_ANNOUNCEMENT_SUBTITLE")},GROUP:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_GROUP_SUBTITLE")},VIDEOCONF:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_VIDEOCONF_SUBTITLE")},CALL:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CALL_SUBTITLE")},CRM:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CRM_SUBTITLE")},SONET_GROUP:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SONET_GROUP_SUBTITLE")},CALENDAR:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CALENDAR_SUBTITLE")},TASKS:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_TASKS_SUBTITLE")},SUPPORT24_NOTIFIER:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SUPPORT24_NOTIFIER_SUBTITLE"),textColor:"#0165af"},SUPPORT24_QUESTION:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SUPPORT24_QUESTION_SUBTITLE"),textColor:"#0165af",imageUrl:i+"avatar_24_question_x3.png"},LINES:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_LINES_SUBTITLE"),textColor:"#0a962f"},LIVECHAT:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_LINES_SUBTITLE"),textColor:"#0a962f"}}},"im-bot":{itemOptions:{default:{textColor:"#725acc"},network:{textColor:"#0a962f"},support24:{textColor:"#0165af"}}}}};const a="#333";const n="#fff";const o="#b1b6bb";class l extends BasePickerCache{constructor(t){super(t);this.writeCache=BasePickerCache.debounce(((t,e)=>this.storage.setObject(e,{items:t})),10,this)}}class c extends BaseSelectorProvider{constructor(t,e={}){super(t);this.context=t;this.options=e;this.customItems=e.customItems||null;this.emptyResults=[];this.recentLoaded=false;this.searchFields=["position","secondName","lastName","name","title"];this.entityWeight={user:100,"im-chat":80,"im-bot":70};this.cache=new l(this.cacheId())}static title(){return""}setQuery(t){this.queryString=t}setOptions(t){this.options=t;this.cache=new l(this.cacheId())}cacheId(){return CommonUtils.md5({id:this.id(),context:this.context})}getAjaxDialog(){let t=[];if(this.options.entities){Object.keys(this.options.entities).forEach((e=>{let s=this.options.entities[e];s.id=e;s.sort=this.entityWeight[e];t.push(s)}));t.sort(((t,e)=>{if(t.sort>e.sort){return-1}else if(t.sort<e.sort){return 1}return 0}))}return{id:"mobile",context:this.context,entities:t}}processResult(t,e,s=[]){try{t=t.toLowerCase();let i=this.splitQueryByWords(t);let r=i.length;return e.map((e=>{let a=this.getEntityWeight(e.params.type);let n=0;let o=[];if(this.searchFields.length>0&&t){let t=this.searchFields.slice(0);t.reverse().forEach((t=>{if(s.includes(t)){return}let r=e[t];if(r){let e=this.splitQueryByWords(r);let s=e.filter((t=>{let e=i.filter((e=>{let s=t.indexOf(e)===0&&!o.includes(e);if(s){o.push(e)}return s}));return e.length>0}));if(s.length>0){a+=this.searchFields.indexOf(t)+1}}}))}else{a=1}e.sort=o.length>=r?a+n:-1;return e})).filter((t=>t.sort>=0)).sort(((t,e)=>{if(t.sort>e.sort){return-1}if(t.sort<e.sort){return 1}return 0}))}catch(t){console.error(t);return e}}doSearch(t){this.queryString=t.trim();let e=this.cache.get("recent").concat(this.cache.get("items"));let s=this.processResult(t,e);let i=s.filter(((t,e,s)=>s.findIndex((e=>t.id===e.id))===e));i.push(this.getSearchingItem());this.listener.onFetchResult(i,true);if(this.emptyResults.includes(t)){this.listener.onFetchResult([]);return}let r=this.splitQueryByWords(t);BX.ajax.runAction("ui.entityselector.doSearch",{json:{dialog:this.getAjaxDialog(),searchQuery:{queryWords:r,query:t,dynamicSearchEntities:[]}},getParameters:{context:this.context}}).then((e=>{let s=this.prepareItems(e.data.dialog.items);if(s.length===0){this.emptyResults.push(t)}this.cache.save(s,"items",{unique:true});if(t.trim()===this.queryString){let e=this.processResult(t,s);this.listener.onFetchResult(e)}})).catch((t=>{console.error(t);this.listener.onFetchResult([])}))}loadRecent(t=false){if(t===false){let t=this.cache.get("recent",true);const e=t.length>0;if(this.customItems){t=[...this.customItems,...t]}if(!e){t.push(this.getLoadingItem())}this.listener.onRecentResult(t,false);if(this.recentLoaded===true){return}}BX.ajax.runAction("ui.entityselector.load",{json:{dialog:this.getAjaxDialog()},getParameters:{context:this.context}}).then((e=>{let s=this.getRecentFromResponse(e.data.dialog);let i=this.prepareItems(s);const r=this.cache.get("recent").length>0;this.cache.save(i,"recent",{saveDisk:true});if(t===false){if(!r){if(this.customItems){i=[...this.customItems,...i]}this.listener.onRecentResult(i,false)}this.recentLoaded=true}}))}getRecentFromResponse(t){return t.recentItems.map((e=>{let s=e[0];let i=e[1];return t.items.find((t=>t.entityId===s&&t.id===i))})).filter((t=>typeof t!=="undefined"))}prepareSelected(t){if(typeof t==="object"){return Object.keys(t).reduce(((e,s)=>{let i=t[s].map((t=>{let e=Object.assign({},t);if(typeof e.id!=="undefined"){e.id=s+"/"+e.id}return e}));return e.concat(i)}),[])}return{}}prepareResult(t){let e=[];let s=t.reduce(((t,s)=>{let[i,r]=s.id.split("/");if(i&&r){e.push({id:r,entityId:i});if(i==="im-chat"){r="chat"+r}t.push({id:r,name:s.title,description:s.subtitle,avatar:s.imageUrl,customData:s.params.customData||[]})}return t}),[]);t=t.filter((t=>{const e=t.id.split("/")[0];return e!=="custom"}));if(t.length>0){this.updateRecentCache(t);this.addRecentItems(e).then((()=>this.loadRecent(true)))}if(this.singleSelection){return s[0]}return s}addRecentItems(t){return new Promise(((e,s)=>{if(Array.isArray(t)&&t.length>0){BX.ajax.runAction("ui.entityselector.saveRecentItems",{json:{dialog:this.getAjaxDialog(),recentItems:t},getParameters:{context:this.context}}).then((t=>e(t))).catch((t=>s(t)))}else{s()}}))}updateRecentCache(t){let e=this.cache.get("recent",true);if(e.length>0){let s=t.map((t=>t.id));let i=[];e=e.filter((t=>{if(s.includes(t.id)){i.push(t);return false}return true}));e.unshift(...i);this.cache.save(e,"recent",{saveDisk:true})}}id(){return"chat"}prepareItemForDrawing(t){let e={title:t.title,sectionCode:"chat",height:64,color:this.getEntityOption(t,"textColor",o),styles:{title:{font:{size:16}},subtitle:{}},useLetterImage:true,id:`${t.entityId}/${t.id}`,imageUrl:t.avatar?t.avatar:this.getEntityOption(t,"imageUrl",""),params:{entityId:t.entityId,entityType:t.entityType,id:t.id,title:t.title,customData:t.customData?t.customData:{},type:t.entityId}};if(t.entityId==="user"){if(t.badges){let s=t.badges.find((t=>t.id==="IT_IS_YOU"));if(s){e.title+=" ("+String(s.title).toLowerCase()+")"}}if(t.entityType==="extranet"){e.styles.title.font.color=this.getEntityOption(t,"textColor",a);e.subtitle=this.getEntityOption(t,"subtitle","")}else{e.subtitle=t.customData.position?t.customData.position:this.getEntityOption(t,"subtitle",a)}e.name=t.customData.name;e.lastName=t.customData.lastName;e.secondName=t.customData.secondName;e.shortTitle=t.customData.name;e.position=t.customData.position;e.color=t.avatar.indexOf("upload")!==-1?n:t.customData["imUser"].COLOR}else if(t.entityId==="im-chat"){e.subtitle=this.getEntityOption(t,"subtitle","");e.shortTitle=t.title;e.styles.title.font.color=this.getEntityOption(t,"textColor",a);e.color=t.avatar.indexOf("upload")!==-1?n:t.customData["imChat"].COLOR}else if(t.entityId==="im-bot"){e.subtitle=t.customData["imUser"].WORK_POSITION;e.shortTitle=t.title;e.styles.title.font.color=this.getEntityOption(t,"textColor",a);e.color=t.avatar.indexOf("upload")!==-1?n:t.customData["imUser"].COLOR}return e}getEntityOption(t,e,s=false){let i=r.entities[t.entityId];if(!i){return s}let a=i.itemOptions;if(!a){return s}let n=a[t.entityType];if(!n){if(a.default&&a.default[e]){return a.default[e]}return s}let o=n[e];if(o){return o}return s}getSearchingItem(){return{id:"loading",title:BX.message("MOBILE_EXT_CHAT_SELECTOR_SEARCHING_ITEM"),type:"loading",unselectable:true,sectionCode:"common"}}getLoadingItem(){return{id:"loading",title:BX.message("MOBILE_EXT_CHAT_SELECTOR_LOADING_ITEM"),type:"loading",unselectable:true,sectionCode:"common"}}splitQueryByWords(t){let e=t.replace("("," ").replace(")"," ").replace("["," ").replace("]"," ").replace("{"," ").replace("}"," ").replace("<"," ").replace(">"," ").replace("-"," ").replace("#"," ").replace('"'," ").replace("'"," ").replace("/ss+/"," ");return e.toLowerCase().split(" ").filter((t=>t!==""))}}s.exports={ChatProvider:c}}));
//# sourceMappingURL=extension.map.js