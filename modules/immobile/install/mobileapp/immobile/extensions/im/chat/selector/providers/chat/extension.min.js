jn.define("im/chat/selector/providers/chat",((t,e,i)=>{const s="/bitrix/mobileapp/immobile/extensions/im/chat/selector/providers/chat/images/";const r={itemOptions:{CHANNEL:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CHANNEL_SUBTITLE")},ANNOUNCEMENT:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_ANNOUNCEMENT_SUBTITLE")},GROUP:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_GROUP_SUBTITLE")},VIDEOCONF:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_VIDEOCONF_SUBTITLE")},CALL:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CALL_SUBTITLE")},CRM:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CRM_SUBTITLE")},SONET_GROUP:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SONET_GROUP_SUBTITLE")},CALENDAR:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_CALENDAR_SUBTITLE")},TASKS:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_TASKS_SUBTITLE")},SUPPORT24_NOTIFIER:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SUPPORT24_NOTIFIER_SUBTITLE"),textColor:"#0165af"},SUPPORT24_QUESTION:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_SUPPORT24_QUESTION_SUBTITLE"),textColor:"#0165af",imageUrl:s+"avatar_24_question_x3.png"},LINES:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_LINES_SUBTITLE"),textColor:"#0a962f"},LIVECHAT:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_LINES_SUBTITLE"),textColor:"#0a962f"}}};const a={entities:{user:{itemOptions:{default:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_EMPLOYEE_SUBTITLE")},extranet:{subtitle:BX.message("MOBILE_EXT_CHAT_SELECTOR_USER_EXTRANET_SUBTITLE"),textColor:"#ca8600"}}},"im-chat":r,"im-chat-user":r,"im-bot":{itemOptions:{default:{textColor:"#725acc"},network:{textColor:"#0a962f"},support24:{textColor:"#0165af"}}},"imbot-network":{itemOptions:{NETWORK:{textColor:"#0a962f"}}}}};const n="#333";const o="#fff";const l="#b1b6bb";class c extends BasePickerCache{constructor(t){super(t);this.writeCache=BasePickerCache.debounce(((t,e)=>this.storage.setObject(e,{items:t})),10,this)}}class u extends BaseSelectorProvider{constructor(t,e={}){super(t);this.context=t;this.options=e;this.customItems=e.customItems||null;this.minSearchSize=e.minSearchSize||3;this.emptyResults=[];this.recentLoaded=false;this.searchFields=["position","secondName","lastName","name","title"];this.entityWeight={user:100,"im-chat":80,"im-bot":70,"im-chat-user":60};this.cache=new c(this.cacheId())}static title(){return""}setQuery(t){this.queryString=t}setOptions(t){this.options=t;this.cache=new c(this.cacheId())}cacheId(){return CommonUtils.md5({id:this.id(),context:this.context})}getAjaxDialog(){let t=[];if(this.options.entities){Object.keys(this.options.entities).forEach((e=>{let i=this.options.entities[e];i.id=e;i.sort=this.entityWeight[e];t.push(i)}));t.sort(((t,e)=>{if(t.sort>e.sort){return-1}else if(t.sort<e.sort){return 1}return 0}))}return{id:"mobile",context:this.context,entities:t}}processResult(t,e,i=[]){try{t=t.toLowerCase();let s=this.splitQueryByWords(t);let r=s.length;return e.map((e=>{let a=this.getEntityWeight(e.params.type);let n=0;let o=[];if(e.params.type==="im-chat-user"){e.sort=a;return e}if(this.searchFields.length>0&&t){let t=this.searchFields.slice(0);t.reverse().forEach((t=>{if(i.includes(t)){return}let r=e[t];if(r){let e=this.splitQueryByWords(r);let i=e.filter((t=>{let e=s.filter((e=>{let i=t.indexOf(e)===0&&!o.includes(e);if(i){o.push(e)}return i}));return e.length>0}));if(i.length>0){a+=this.searchFields.indexOf(t)+1}}}))}else{a=1}e.sort=o.length>=r?a+n:-1;return e})).filter((t=>t.sort>=0)).sort(((t,e)=>{if(t.sort>e.sort){return-1}if(t.sort<e.sort){return 1}return 0}))}catch(t){console.error(t);return e}}doSearch(t){this.queryString=t.trim();let e=this.cache.get("recent").concat(this.cache.get("items"));let i=this.processResult(t,e);let s=i.filter(((t,e,i)=>i.findIndex((e=>t.id===e.id))===e));if(this.emptyResults.includes(t)){this.listener.onFetchResult([]);return}if(t.length<this.minSearchSize){this.listener.onFetchResult(s);return}s.push(this.getSearchingItem());this.listener.onFetchResult(s,true);const r=this.splitQueryByWords(t);ChatUtils.throttle(this.sendRequest(t,r),500,this)}sendRequest(t,e){BX.ajax.runAction("ui.entityselector.doSearch",{json:{dialog:this.getAjaxDialog(),searchQuery:{queryWords:e,query:t,dynamicSearchEntities:[]}},getParameters:{context:this.context}}).then((e=>{let i=this.cache.get("recent").concat(this.cache.get("items"));i=this.processResult(t,i);const s=this.prepareItems(e.data.dialog.items);i.forEach((t=>{const e=s.find((e=>e.title===t.title));if(typeof e==="undefined"){s.push(t)}}));if(s.length===0){this.emptyResults.push(t)}const r=s.filter((t=>t.params.entityId==="user"||t.params.entityId==="im-chat"||t.params.entityId==="im-bot"));this.cache.save(r,"items",{unique:true});if(t.trim()===this.queryString){let e=this.processResult(t,s);this.listener.onFetchResult(e)}})).catch((t=>{console.error(t);this.listener.onFetchResult([])}))}loadRecent(t=false){if(t===false){let t=this.cache.get("recent",true);const e=t.length>0;if(this.customItems){t=[...this.customItems,...t]}if(!e){t.push(this.getLoadingItem())}this.listener.onRecentResult(t,false);if(this.recentLoaded===true){return}}BX.ajax.runAction("ui.entityselector.load",{json:{dialog:this.getAjaxDialog()},getParameters:{context:this.context}}).then((e=>{let i=this.getRecentFromResponse(e.data.dialog);let s=this.prepareItems(i);const r=this.cache.get("recent").length>0;this.cache.save(s,"recent",{saveDisk:true});if(t===false){if(!r){if(this.customItems){s=[...this.customItems,...s]}this.listener.onRecentResult(s,false)}this.recentLoaded=true}}))}getRecentFromResponse(t){return t.recentItems.map((e=>{let i=e[0];let s=e[1];return t.items.find((t=>t.entityId===i&&t.id===s))})).filter((t=>typeof t!=="undefined"))}prepareSelected(t){if(typeof t==="object"){return Object.keys(t).reduce(((e,i)=>{let s=t[i].map((t=>{let e=Object.assign({},t);if(typeof e.id!=="undefined"){e.id=i+"/"+e.id}return e}));return e.concat(s)}),[])}return{}}filterDuplicateChatUsersItems(t){const e=[];const i={};if(Array.isArray(t)){t.forEach(((t,e)=>{if(t.entityId&&t.entityId!=="im-chat-user"){i[t.id]=e}else if(!(t.id in i)){i[t.id]=e}}))}for(let s in i){if(i.hasOwnProperty(s)){e.push(t[i[s]])}}return e}prepareResult(t){let e=[];let i=t.reduce(((t,i)=>{let[s,r]=i.id.split("/");if(s&&r){e.push({id:r,entityId:s});if(s==="im-chat"||s==="im-chat-user"){r="chat"+r}t.push({id:r,name:i.title,description:i.subtitle,avatar:i.imageUrl,color:i.color,customData:i.params.customData||[]})}return t}),[]);t=t.filter((t=>{const e=t.id.split("/")[0];return e!=="custom"}));if(t.length>0){this.updateRecentCache(t);this.addRecentItems(e).then((()=>this.loadRecent(true)))}if(this.singleSelection){return i[0]}return i}addRecentItems(t){return new Promise(((e,i)=>{if(Array.isArray(t)&&t.length>0){BX.ajax.runAction("ui.entityselector.saveRecentItems",{json:{dialog:this.getAjaxDialog(),recentItems:t},getParameters:{context:this.context}}).then((t=>e(t))).catch((t=>i(t)))}else{i()}}))}updateRecentCache(t){let e=this.cache.get("recent",true);if(e.length>0){let i=t.map((t=>t.id));let s=[];e=e.filter((t=>{if(i.includes(t.id)){s.push(t);return false}return true}));e.unshift(...s);this.cache.save(e,"recent",{saveDisk:true})}}id(){return"chat"}prepareItemForDrawing(t){let e={title:t.title,sectionCode:"chat",height:64,color:this.getEntityOption(t,"textColor",l),styles:{title:{font:{size:16}},subtitle:{}},useLetterImage:true,id:`${t.entityId}/${t.id}`,imageUrl:t.avatar?t.avatar:this.getEntityOption(t,"imageUrl",""),params:{entityId:t.entityId,entityType:t.entityType,id:t.id,title:t.title,customData:t.customData?t.customData:{},type:t.entityId}};if(t.entityId==="user"){if(t.badges){let i=t.badges.find((t=>t.id==="IT_IS_YOU"));if(i){e.title+=" ("+String(i.title).toLowerCase()+")"}}if(t.entityType==="extranet"){e.styles.title.font.color=this.getEntityOption(t,"textColor",n);e.subtitle=this.getEntityOption(t,"subtitle","")}else{e.subtitle=t.customData.position?t.customData.position:this.getEntityOption(t,"subtitle",n)}e.name=t.customData.name;e.lastName=t.customData.lastName;e.secondName=t.customData.secondName;e.shortTitle=t.customData.name;e.position=t.customData.position;e.color=t.avatar&&t.avatar.indexOf("upload")!==-1?o:t.customData["imUser"].COLOR}else if(t.entityId==="im-chat"||t.entityId==="im-chat-user"){e.subtitle=this.getEntityOption(t,"subtitle","");e.shortTitle=t.title;e.styles.title.font.color=this.getEntityOption(t,"textColor",n);e.color=t.avatar&&t.avatar.indexOf("upload")!==-1?o:t.customData["imChat"].COLOR;const i=Number(BX.componentParameters.get("IM_GENERAL_CHAT_ID",0));if(t.id===i){e.imageUrl=s+"avatar_general_x3.png"}}else if(t.entityId==="im-bot"){e.subtitle=t.customData["imUser"].WORK_POSITION;e.shortTitle=t.title;e.styles.title.font.color=this.getEntityOption(t,"textColor",n);e.color=t.avatar&&t.avatar.indexOf("upload")!==-1?o:t.customData["imUser"].COLOR}else if(t.entityId==="imbot-network"){e.color=t.avatar&&t.avatar.indexOf("upload")!==-1?o:t.avatarOptions.color;e.styles.title.font.color=this.getEntityOption(t,"textColor",n);e.subtitle=t.subtitle}return e}getEntityOption(t,e,i=false){let s=a.entities[t.entityId];if(!s){return i}let r=s.itemOptions;if(!r){return i}let n=r[t.entityType];if(!n){if(r.default&&r.default[e]){return r.default[e]}return i}let o=n[e];if(o){return o}return i}getSearchingItem(){return{id:"loading",title:BX.message("MOBILE_EXT_CHAT_SELECTOR_SEARCHING_ITEM"),type:"loading",unselectable:true,sectionCode:"common"}}getLoadingItem(){return{id:"loading",title:BX.message("MOBILE_EXT_CHAT_SELECTOR_LOADING_ITEM"),type:"loading",unselectable:true,sectionCode:"common"}}splitQueryByWords(t){const e=t.replace(/\(/g," ").replace(/\)/g," ").replace(/\[/g," ").replace(/]/g," ").replace(/\{/g," ").replace(/}/g," ").replace(/</g," ").replace(/>/g," ").replace(/-/g," ").replace(/#/g," ").replace(/"/g," ").replace(/'/g," ").replace("/ss+/"," ");return e.toLowerCase().split(" ").filter((t=>t!==""))}}i.exports={ChatProvider:u}}));
//# sourceMappingURL=extension.map.js