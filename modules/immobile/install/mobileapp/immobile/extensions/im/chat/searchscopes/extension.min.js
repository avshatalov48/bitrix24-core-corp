"use strict";var ChatSearchScopes={TYPE_USER:"user",TYPE_CHAT:"chat",TYPE_LINE:"line",TYPE_DEPARTMENT:"department",TYPE_DEPARTMENT_USER:"departmentUser",MORE_TYPE_CACHE:"cache",MORE_TYPE_EXTERNAL:"external"};ChatSearchScopes.init=function(e){this.debug=false;this.businessOnly=e.businessOnly===true;this.resultLimit=parseInt(e.resultLimit)?e.resultLimit:30;this.minTokenLength={};this.minTokenLengthDefault=parseInt(e.minTokenLength)?parseInt(e.minTokenLength):BX.componentParameters.get("SEARCH_MIN_SIZE",3);if(typeof e.onDrawSearchResult=="function"){this.onDrawSearchResult=e.onDrawSearchResult}else{this.onDrawSearchResult=()=>{};console.error("ChatSearchScopes.init: function for draw result is not specified")}if(!e.dataConverterInited){ChatDataConverter.init({userId:e.userId,generalChatId:e.generalChatId})}this.list={};this.skipList={};this.skipByProperty={};this.externalSearchEnable={};this.cacheIndex={};this.cacheList={};this.cacheRequest={};this.setType(e.listType);this.result={text:"",progressIcon:false,moreButton:false,offset:{},items:[],itemsIndex:{},types:{}}};ChatSearchScopes.setType=function(e=this.TYPE_USER){this.listType=e;if(typeof this.cacheIndex[this.listType]=="undefined"){this.cacheIndex[this.listType]={}}if(typeof this.cacheList[this.listType]=="undefined"){this.cacheList[this.listType]=[]}if(typeof this.cacheRequest[this.listType]=="undefined"){this.cacheRequest[this.listType]={}}if(typeof this.list[this.listType]=="undefined"){this.list[this.listType]=[]}if(typeof this.skipList[this.listType]=="undefined"){this.skipList[this.listType]=[]}if(typeof this.skipByProperty[this.listType]=="undefined"){this.skipByProperty[this.listType]={}}return true};ChatSearchScopes.setSkipList=function(e,t=this.listType){this.skipList[t]=e};ChatSearchScopes.setSkipByProperty=function(e,t=this.listType){this.skipByProperty[t]=e};ChatSearchScopes.setList=function(e,t=this.listType){this.list[t]=e};ChatSearchScopes.setMinTokenLength=function(e=this.minTokenLengthDefault,t=this.listType){this.minTokenLength[t]=e};ChatSearchScopes.getMinTokenLength=function(e=this.listType){return typeof this.minTokenLength[e]=="number"?this.minTokenLength[e]:this.minTokenLengthDefault};ChatSearchScopes.setExternalSearchEnable=function(e=true,t=this.listType){this.externalSearchEnable[t]=e===true};ChatSearchScopes.find=function(e,t,s=this.listType){e=e.toString().trim();if(!e){this.clear()}else if(this.externalSearchEnable[s]!==false&&e.length>=this.getMinTokenLength(s)){ChatTimer.stop("search",null,true);ChatRestRequest.abort("search");this.setMoreButton(false);this.setText(e);this.setItems([]);this.findLocal(e,t,s).then((e=>{this.setItems(e.items);this.setProgressIcon(true);this.drawSearch();this.findExternal(e.text,e.offset,e.type)}))}else{ChatTimer.stop("search",null,true);ChatRestRequest.abort("search");this.setMoreButton(false);this.setText(e);this.setItems([]);this.findLocal(e,t,s).then((e=>{this.setItems(e.items);this.setProgressIcon(false);this.drawSearch()}))}return true};ChatSearchScopes.selectElement=function(e){if(e.params.action!="more"){return true}this.setProgressIcon(true);this.setMoreButton(false);this.drawSearch();this.findExternal(this.result.text,this.result.offset,e.params.value);return true};ChatSearchScopes.updateElement=function(e,t,s=this.listType){if(typeof this.cacheIndex[s][e]=="undefined"){return false}this.cacheList[s][this.cacheIndex[s][e]]=ChatUtils.objectMerge(this.cacheList[s][this.cacheIndex[s][e]],t);return true};ChatSearchScopes.deleteElement=function(e,t=this.listType){if(typeof this.cacheIndex[t][e]=="undefined"){return false}delete this.cacheList[t][this.cacheIndex[e]];delete this.cacheIndex[t][e];return true};ChatSearchScopes.getElement=function(e,t=this.listType){let s=null;if(typeof this.cacheIndex[t][e]!="undefined"){s=this.cacheList[t][this.cacheIndex[t][e]]}return s};ChatSearchScopes.clear=function(e){ChatTimer.stop("search",null,true);ChatRestRequest.abort("search");this.setText("");this.setProgressIcon(false);this.setMoreButton(false);this.setOffset(0);this.setItems([]);if(e){this.drawSearch()}return true};ChatSearchScopes.findLocal=function(e,t,s=this.listType){t=t||0;let i=new BX.Promise;let r=["name"];if(s==this.TYPE_USER){r=["name","work_position"]}else if(s==this.TYPE_DEPARTMENT){r=["name","full_name"]}i.fulfill({type:s,text:e,offset:t,items:this.filter(e,r,[this.list[s].concat(this.cacheList[s])])});return i};ChatSearchScopes.findExternal=function(e,t,s=this.listType){t=t||0;let i=new BX.Promise;i.then((e=>{this.cacheRequest[e.type][e.text][e.limit][e.offset]=e;let t=[];if(e.count){for(let s in e.items){if(!e.items.hasOwnProperty(s)){continue}t.push(e.items[s])}this.indexItems(t,e.type);let i=["name"];if(s==this.TYPE_USER){i=["name","work_position"]}else if(s==this.TYPE_DEPARTMENT){i=["name","full_name"]}if(s==this.TYPE_CHAT){t=t.slice(0,this.resultLimit).filter((e=>typeof this.result.itemsIndex[e.id]=="undefined"))}else{t=this.filter(e.text,i,[t]).filter((e=>typeof this.result.itemsIndex[e.id]=="undefined"))}if(t.length>0||e.offset==0){this.appendItems(t,false,e.type);if(t.length>0){this.setMoreButton(e.hasMore)}}else{this.setMoreButton(e.hasMore,BX.message("SEARCH_MORE_READY"))}this.setProgressIcon(false);this.setOffset(e.offset+e.limit,e.type)}else{this.setProgressIcon(false);this.setMoreButton(false)}this.drawSearch()})).catch((e=>{if(e.error.ex.error=="REQUEST_CANCELED"){console.info("ChatSearchScopes.find: execute request canceled by user",e.error.ex)}else{console.error("ChatSearchScopes.find: error has occurred ",e.error);this.setProgressIcon(e.type,false);this.setMoreButton(e.type,false);this.drawSearch()}}));ChatTimer.stop("search",null,true);if(typeof this.cacheRequest[s]=="undefined"){this.cacheRequest[s]={}}if(typeof this.cacheRequest[s][e]=="undefined"){this.cacheRequest[s][e]={}}if(typeof this.cacheRequest[s][e][this.resultLimit]=="undefined"){this.cacheRequest[s][e][this.resultLimit]={}}if(typeof this.cacheRequest[s][e][this.resultLimit][t]=="undefined"){this.cacheRequest[s][e][this.resultLimit][t]=false}if(this.cacheRequest[s][e][this.resultLimit][t]){i.fulfill(this.cacheRequest[s][e][this.resultLimit][t])}else{ChatTimer.start("search",null,1e3,((e,t)=>{this.restRequest(t.text,t.limit,t.offset,t.promise,t.type)}),{type:s.toString(),text:e.toString(),limit:this.resultLimit.toString(),offset:t.toString(),promise:i})}return true};ChatSearchScopes.restRequest=function(e,t=15,s=0,i,r=this.listType){t=parseInt(t);s=parseInt(s);i=i||new BX.Promise;let h="";let n={};if(r==this.TYPE_USER||r==this.TYPE_CHAT||r==this.TYPE_DEPARTMENT){h="im.search."+r;n={FIND:e,LIMIT:t,OFFSET:s};if((r==this.TYPE_USER||r==this.TYPE_CHAT)&&this.businessOnly){n["BUSINESS"]="Y"}}else{i.reject({type:r,text:e,offset:s,limit:t,error:{ex:{error:"REQUEST_CANCELED",error_description:"Type is not implemented!"}}});return false}console.info(`ChatSearchScopes.restRequest: %c${h}`,"font-weight: bold;",n);ChatRestRequest.abort("search");BX.rest.callMethod(h,n,null,(e=>{ChatRestRequest.register("search",e)})).then((e=>{ChatRestRequest.unregister("search");if(e.data()){let t=parseInt(e.total())-(parseInt(e.query.data.OFFSET)+parseInt(e.query.data.LIMIT))>0;let s=0;for(let t in e.data()){s++}i.fulfill({type:r,text:e.query.data.FIND,offset:e.query.data.OFFSET,limit:e.query.data.LIMIT,total:e.total()?e.total():0,count:s,hasMore:t,items:e.data()})}else{i.reject({type:r,text:e.query.TEXT,offset:e.query.OFFSET,limit:e.query.LIMIT,error:e.error()})}})).catch((e=>{ChatRestRequest.unregister("search");i.reject({type:r,text:e.query.TEXT,offset:e.query.OFFSET,limit:e.query.LIMIT,error:e.error()})}));return i};ChatSearchScopes.filter=function(e,t,s){let i=[];let r={};s.forEach((s=>{let h=s.filter((s=>{let i=false;t.forEach((t=>{if(s[t]&&!r[s.id]){if(s[t].toUpperCase().indexOf(e.toUpperCase())==0){i=true;r[s.id]=true}else{s[t].toUpperCase().split(" ").forEach((t=>{if(t.indexOf(e.toUpperCase())==0){i=true;r[s.id]=true}}))}}}));return i}));i=i.concat(h)}));return i.slice(0,this.resultLimit)};ChatSearchScopes.indexItems=function(e,t=this.listType){e.map((e=>{if(typeof this.cacheIndex[t][e.id]=="undefined"){this.cacheIndex[t][e.id]=this.cacheList[t].length;this.cacheList[t].push(e)}else{this.cacheList[t][this.cacheIndex[t][e.id]]=e}}));return true};ChatSearchScopes.setText=function(e){this.result.text=e};ChatSearchScopes.setProgressIcon=function(e){this.result.progressIcon=e==true};ChatSearchScopes.setMoreButton=function(e,t){this.result.moreButton={active:e==true,text:t?t:BX.message("SEARCH_MORE")}};ChatSearchScopes.setOffset=function(e){this.result.offset=e||0};ChatSearchScopes.setItems=function(e,t){let s=[];if(e.length<=0){this.result.itemsIndex={}}else{if(t!==false){e=e.filter((e=>typeof this.result.itemsIndex[e.id]=="undefined"))}e.map((e=>{if(this.skipList[this.listType].length>0&&this.skipList[this.listType].indexOf(e.id)>-1){return true}if(this.skipByProperty[this.listType].length>0){const t=this.skipByProperty[this.listType].find((t=>typeof e[t[0]]!=="undefined"&&e[t[0]]===t[1]));if(t){console.warn(e);return true}}this.result.itemsIndex[e.id]=true;if(this.listType==this.TYPE_USER){s.push(ChatDataConverter.getListElementByUser(e))}else if(this.listType==this.TYPE_CHAT){s.push(ChatDataConverter.getListElementByChat(e))}else if(this.listType==this.TYPE_LINE){s.push(ChatDataConverter.getListElementByLine(e))}else if(this.listType==this.TYPE_DEPARTMENT){s.push(ChatDataConverter.getListElementByDepartment(e))}return true}))}this.result.items=s};ChatSearchScopes.appendItems=function(e,t){let s=[];if(t!==false){e=e.filter((e=>typeof this.result.itemsIndex[e.id]=="undefined"))}e.map((e=>{if(this.skipList.length>0&&this.skipList.indexOf(e.id)>-1){return true}if(this.skipByProperty[this.listType].length>0){const t=this.skipByProperty[this.listType].find((t=>typeof e[t[0]]!=="undefined"&&e[t[0]]===t[1]));if(t){return true}}this.result.itemsIndex[e.id]=true;if(this.listType==this.TYPE_USER){s.push(ChatDataConverter.getListElementByUser(e))}else if(this.listType==this.TYPE_CHAT){s.push(ChatDataConverter.getListElementByChat(e))}else if(this.listType==this.TYPE_LINE){s.push(ChatDataConverter.getListElementByLine(e))}else if(this.listType==this.TYPE_DEPARTMENT){s.push(ChatDataConverter.getListElementByDepartment(e))}return true}));this.result.items=this.result.items.concat(s)};ChatSearchScopes.drawSearch=function(){let e=new Date;let t=ChatUtils.objectClone(this.result.items);if(this.result.progressIcon){t.push({title:BX.message("SEARCH"),type:"loading",unselectable:true,sectionCode:this.listType,params:{action:"progress"}})}if(!this.result.progressIcon&&this.result.items.length<=0){t.push({title:BX.message("SEARCH_EMPTY").replace("#TEXT#",this.result.text),sectionCode:this.listType,type:"button",unselectable:true,params:{action:"empty"}})}if(this.result.moreButton&&this.result.moreButton["active"]){t.push({title:this.result.moreButton["text"],type:"button",sectionCode:this.listType,params:{action:"more",value:this.listType}})}this.onDrawSearchResult(t,[{title:BX.message(`SEARCH_CATEGORY_${this.listType}`),id:this.listType,backgroundColor:"#FFFFFF"}]);console.info("ChatSearchScopes.drawSearch: update search results - "+t.length+" elements ("+(new Date-e)+"ms)",this.result.text);return true};
//# sourceMappingURL=extension.map.js