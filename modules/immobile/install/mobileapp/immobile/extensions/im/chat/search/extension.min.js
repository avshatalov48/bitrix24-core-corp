"use strict";var ChatSearch={TYPE_USER:"user",TYPE_CHAT:"chat",MORE_TYPE_CACHE:"cache",MORE_TYPE_EXTERNAL:"external"};ChatSearch.init=function(t){this.debug=false;this.showChat=t.showChat!==false;this.businessOnly=t.businessOnly===true;this.resultLimit=parseInt(t.resultLimit)?t.resultLimit:30;this.minTokenLength=parseInt(t.minTokenLength)?parseInt(t.minTokenLength):BX.componentParameters.get("SEARCH_MIN_SIZE",3);if(typeof t.onDrawSearchResult=="function"){this.onDrawSearchResult=t.onDrawSearchResult}else{this.onDrawSearchResult=()=>{};console.error("ChatSearch.init: function for draw result is not specified")}if(!t.dataConverterInited){ChatDataConverter.init({userId:t.userId,generalChatId:t.generalChatId})}this.cacheIndex={};this.cacheList=[];this.cacheRequest={};this.lastSearchList=[];this.recentList=[];this.colleaguesList=[];this.skipList=[];this.result={text:"",progressIcon:{},moreButton:{},offset:{},items:[],itemsIndex:{},types:{}}};ChatSearch.setSkipList=function(t){this.skipList=t};ChatSearch.setRecentList=function(t){this.recentList=t};ChatSearch.setColleaguesList=function(t){this.colleaguesList=t};ChatSearch.setLastSearchList=function(t){this.lastSearchList=t};ChatSearch.getElement=function(t){let e=null;if(typeof this.cacheIndex[t]!="undefined"){e=this.cacheList[this.cacheIndex[t]]}return e};ChatSearch.find=function(t,e){t=t.toString().trim();if(!t){this.clear()}else if(t.length>=this.minTokenLength){ChatTimer.stop("search",this.TYPE_USER,true);ChatRestRequest.abort("search-"+this.TYPE_USER);this.setMoreButton(this.TYPE_USER,false);this.setMoreButton(this.TYPE_CHAT,false);this.setText(t);this.setItems([]);this.findLocal(t,e).then((t=>{this.setItems(t.items);this.setProgressIcon(this.TYPE_USER,true);this.drawSearch();this.findExternal(this.TYPE_USER,t.text,t.offset)}))}else{ChatTimer.stop("search",this.TYPE_USER,true);ChatRestRequest.abort("search-"+this.TYPE_USER);this.setMoreButton(this.TYPE_USER,false);this.setMoreButton(this.TYPE_CHAT,false);this.setText(t);this.setItems([]);this.findLocal(t,e).then((t=>{this.setItems(t.items);this.setProgressIcon(this.TYPE_USER,false);this.setProgressIcon(this.TYPE_CHAT,false);this.drawSearch()}))}return true};ChatSearch.selectElement=function(t){if(t.params.action=="more"){let e=t.params.value;this.setProgressIcon(e,true);this.setMoreButton(e,false);this.drawSearch();this.findExternal(e,this.result.text,this.result.offset[t.params.value])}return true};ChatSearch.updateElement=function(t,e){if(typeof this.cacheIndex[t]!="undefined"){this.cacheList[this.cacheIndex[t]]=ChatUtils.objectMerge(this.cacheList[this.cacheIndex[t]],e)}return true};ChatSearch.deleteElement=function(t){if(typeof this.cacheIndex[t]!="undefined"){delete this.cacheList[this.cacheIndex[t]];delete this.cacheIndex[t]}return true};ChatSearch.clear=function(t){ChatTimer.stop("search",this.TYPE_USER,true);ChatRestRequest.abort("search-"+this.TYPE_USER);ChatRestRequest.abort("search-"+this.TYPE_CHAT);this.setText("");this.setProgressIcon(false);this.setMoreButton(this.TYPE_USER,false);this.setMoreButton(this.TYPE_CHAT,false);this.setOffset(this.TYPE_USER,0);this.setOffset(this.TYPE_CHAT,0);this.setItems([]);if(t){this.drawSearch()}return true};ChatSearch.findLocal=function(t,e){e=e||0;let s=new BX.Promise;let i=[];let r=[];this.lastSearchList.concat(this.recentList).concat(this.cacheList).map((t=>{if(!t)return true;if(t.type=="user"){i.push(t.user)}else if(this.showChat){r.push(t.chat)}}));i=i.concat(this.colleaguesList);let h=this.filter(t,["name","work_position"],[i]);let a=this.filter(t,["name"],[r]);s.fulfill({text:t,offset:e,items:h.slice(0,this.resultLimit).concat(a.slice(0,this.resultLimit))});return s};ChatSearch.findExternal=function(t,e,s){s=s||0;let i=new BX.Promise;i.then((t=>{this.cacheRequest[t.type][t.text][t.limit][t.offset]=t;let e=[];if(t.count){for(let s in t.items){if(!t.items.hasOwnProperty(s)){continue}e.push(t.items[s])}this.indexItems(t.type,e);e=this.filter(t.text,["name","work_position"],[e]).filter((t=>typeof this.result.itemsIndex[t.id]=="undefined"));if(e.length>0||t.offset==0){this.appendItems(e,false);this.setMoreButton(t.type,t.hasMore)}else{this.setMoreButton(t.type,t.hasMore,BX.message("SEARCH_MORE_READY"))}this.setProgressIcon(t.type,false);this.setOffset(t.type,t.offset+t.limit)}else{this.setProgressIcon(t.type,false);this.setMoreButton(t.type,false)}this.drawSearch()})).catch((t=>{if(t.error.ex.error=="REQUEST_CANCELED"){console.info("ChatSearch.find: execute request canceled by user",t.error.ex)}else{console.error("ChatSearch.find: error has occurred ",t.error);this.setProgressIcon(t.type,false);this.setMoreButton(t.type,false);this.drawSearch()}}));ChatTimer.stop("search",t,true);if(typeof this.cacheRequest[t]=="undefined"){this.cacheRequest[t]={}}if(typeof this.cacheRequest[t][e]=="undefined"){this.cacheRequest[t][e]={}}if(typeof this.cacheRequest[t][e][this.resultLimit]=="undefined"){this.cacheRequest[t][e][this.resultLimit]={}}if(typeof this.cacheRequest[t][e][this.resultLimit][s]=="undefined"){this.cacheRequest[t][e][this.resultLimit][s]=false}if(this.cacheRequest[t][e][this.resultLimit][s]){i.fulfill(this.cacheRequest[t][e][this.resultLimit][s])}else{ChatTimer.start("search",t,1e3,((t,e)=>{this.restRequest(e.type,e.text,e.limit,e.offset,e.promise)}),{type:t.toString(),text:e.toString(),limit:this.resultLimit.toString(),offset:s.toString(),promise:i})}return true};ChatSearch.restRequest=function(t,e,s,i,r){s=parseInt(s)||15;i=parseInt(i)||0;r=r||new BX.Promise;t=t=="chat"?"chat":"user";ChatRestRequest.abort("search-"+t);let h={FIND:e,LIMIT:s,OFFSET:i};if(this.businessOnly){h["BUSINESS"]="Y"}BX.rest.callMethod("im.search."+t,h,null,(e=>{ChatRestRequest.register("search-"+t,e)})).then((t=>{let e=t.query.method=="im.search.user"?this.TYPE_USER:this.TYPE_CHAT;ChatRestRequest.unregister("search-"+e);if(t.data()){let s=parseInt(t.total())-(parseInt(t.query.data.OFFSET)+parseInt(t.query.data.LIMIT))>0;let i=0;for(let e in t.data()){i++}r.fulfill({type:e,text:t.query.data.FIND,offset:t.query.data.OFFSET,limit:t.query.data.LIMIT,total:t.total()?t.total():0,count:i,hasMore:s,items:t.data()})}else{r.reject({type:t.query.method=="im.search.user"?this.TYPE_USER:this.TYPE_CHAT,text:t.query.TEXT,offset:t.query.OFFSET,limit:t.query.LIMIT,error:t.error()})}})).catch((t=>{let e=t.query.method=="im.search.user"?this.TYPE_USER:this.TYPE_CHAT;ChatRestRequest.unregister("search-"+e);r.reject({type:e,text:t.query.TEXT,offset:t.query.OFFSET,limit:t.query.LIMIT,error:t.error()})}));return r};ChatSearch.filter=function(t,e,s){let i=[];let r={};s.forEach((s=>{let h=s.filter((s=>{let i=false;e.forEach((e=>{if(s[e]&&!r[s.id]){if(s[e].toUpperCase().indexOf(t.toUpperCase())==0){i=true;r[s.id]=true}else{s[e].toUpperCase().split(" ").forEach((e=>{if(e.indexOf(t.toUpperCase())==0){i=true;r[s.id]=true}}))}}}));return i}));i=i.concat(h)}));return i.slice(0,this.resultLimit)};ChatSearch.indexItems=function(t,e){e.map((e=>{let s={avatar:{},user:{id:0}};if(t=="chat"){s.type="chat";s.id="chat"+e.id;e.id=parseInt(e.id);e.date_create=new Date(e.date_create);s.chat=e.chat;s.avatar.url=e.avatar;s.avatar.color=e.color;s.title=e.name}else{s.type="user";s.id=parseInt(e.id);s.user=e=ChatDataConverter.getUserDataFormat(e);s.avatar.url=e.avatar;s.avatar.color=e.color;s.title=e.name}if(typeof this.cacheIndex[s.id]!="undefined"){this.cacheList[this.cacheIndex[s.id]]=s}else{this.cacheIndex[s.id]=this.cacheList.length;this.cacheList.push(s)}}));return true};ChatSearch.setText=function(t){this.result.text=t};ChatSearch.setProgressIcon=function(t,e){this.result.progressIcon[t]=e==true};ChatSearch.setMoreButton=function(t,e,s){this.result.moreButton[t]={active:e==true,text:s?s:BX.message("SEARCH_MORE")}};ChatSearch.setOffset=function(t,e){this.result.offset[t]=e||0};ChatSearch.setItems=function(t,e){let s=[];if(t.length<=0){this.result.itemsIndex={}}else{if(e!==false){t=t.filter((t=>typeof this.result.itemsIndex[t.id]=="undefined"))}t.map((t=>{if(this.skipList.length>0&&this.skipList.indexOf(t.id)>-1){return true}this.result.itemsIndex[t.id]=true;s.push(ChatDataConverter.getSearchElementFormat(t));return true}))}this.result.items=s};ChatSearch.appendItems=function(t,e){let s=[];if(e!==false){t=t.filter((t=>typeof this.result.itemsIndex[t.id]=="undefined"))}t.map((t=>{if(this.skipList.length>0&&this.skipList.indexOf(t.id)>-1){return true}this.result.itemsIndex[t.id]=true;s.push(ChatDataConverter.getSearchElementFormat(t))}));this.result.items=this.result.items.concat(s)};ChatSearch.drawSearch=function(){let t=new Date;let e=ChatUtils.objectClone(this.result.items);if(this.result.moreButton[this.TYPE_USER]&&this.result.moreButton[this.TYPE_USER]["active"]){e.push({title:this.result.moreButton[this.TYPE_USER]["text"],type:"button",sectionCode:"user",params:{action:"more",value:"user"}})}if(this.result.moreButton[this.TYPE_CHAT]&&this.result.moreButton[this.TYPE_CHAT]["active"]){e.push({title:this.result.moreButton[this.TYPE_CHAT]["text"],type:"button",sectionCode:"chat",params:{action:"more",value:"chat"}})}let s=false;if(this.result.progressIcon[this.TYPE_USER]||this.result.progressIcon[this.TYPE_CHAT]){s=true;if(!this.result.types[this.TYPE_USER]&&!this.result.types[this.TYPE_CHAT]){e.push({title:BX.message("SEARCH"),type:"loading",unselectable:true,params:{action:"progress"}})}else{if(this.result.progressIcon[this.TYPE_USER]){e.push({title:BX.message("SEARCH"),type:"loading",unselectable:true,sectionCode:"user",params:{action:"progress"}})}if(this.result.progressIcon[this.TYPE_CHAT]){e.push({title:BX.message("SEARCH"),type:"loading",unselectable:true,sectionCode:"chat",params:{action:"progress"}})}}}if(!s&&this.result.items.length<=0){e.push({title:BX.message("SEARCH_EMPTY").replace("#TEXT#",this.result.text),type:"button",unselectable:true,params:{action:"empty"}})}let i=[];this.result.types[this.TYPE_USER]=false;this.result.types[this.TYPE_CHAT]=false;for(let t=0,s=e.length;t<s;t++){if(e[t].sectionCode=="user"){this.result.types[this.TYPE_USER]=true}else if(e[t].sectionCode=="chat"){this.result.types[this.TYPE_CHAT]=true}}if(this.result.types[this.TYPE_USER]){i.push({title:BX.message("SEARCH_EMPLOYEES"),id:"user",backgroundColor:"#FFFFFF"})}if(this.result.types[this.TYPE_CHAT]){i.push({title:BX.message("SEARCH_CHATS"),id:"chat",backgroundColor:"#FFFFFF"})}this.onDrawSearchResult(e,i);console.info("ChatSearch.drawSearch: update search results - "+e.length+" elements ("+(new Date-t)+"ms)",this.result.text);return true};
//# sourceMappingURL=extension.map.js