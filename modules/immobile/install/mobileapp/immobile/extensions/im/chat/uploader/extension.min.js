"use strict";var ChatUploader={};ChatUploader.init=function(){BX.addCustomEvent("onFileUploadStatusChanged",this.listener.bind(this));this.userId=BX.componentParameters.get("USER_ID",0);this.languageId=BX.componentParameters.get("LANGUAGE_ID","en");this.database=new ReactDatabase(ChatDatabaseName,this.userId,this.languageId);this.storage=Application.sharedStorage(`chatBackgroundQueue_${this.userId}`);this.restartUploadTasks();BX.addCustomEvent("chatuploader::task::restart",(()=>this.restartUploadTasks()));BX.addCustomEvent("chatbackground::task::status::success",((e,a,t)=>{this.executeBackgroundTaskSuccess(e,a,t)}));BX.addCustomEvent("chatbackground::task::status::failure",((e,a,t,s,o)=>{this.executeBackgroundTaskFailure(e,a,t,s,o)}))};ChatUploader.listener=function(e,a,t){if(!t.startsWith("imDialog")){return false}if(e===BX.FileUploadEvents.FILE_CREATED){if(a&&a.result&&a.result.data&&a.result.data.file){const e=a.result.data.file.id;this.fileCommit(t,e,a.file)}else{console.error("ChatUploader.listener error",e,a,t);this.removeUploadTaskFromStorage(t);return}}this.handleUploadTask(e,a,t);return true};ChatUploader.fileCommit=function(e,a,t){let s=t.params.chatId;let o=t.params.silentMode;let r="";t.fileId=a;console.info("ChatUploader.fileCommit:",[e,a,t]);ChatBackgroundTasks.addTask(e,["im.disk.file.commit",{CHAT_ID:s,UPLOAD_ID:a,MESSAGE_TEXT:r,SILENT_MODE:o?"Y":"N",TEMPLATE_ID:t.params.file?t.params.id:0,FILE_TEMPLATE_ID:t.params.file?t.params.file.id:0}],t)};ChatUploader.fileRemove=function(e,a,t){let s=t.params.chatId;console.error("ChatUploader.fileRemove:",[e,a,t]);BX.rest.callMethod("im.disk.file.delete",{CHAT_ID:s,DISK_ID:a})};ChatUploader.handleUploadTask=function(e,a,t){console.log("ChatUploader.handleUploadTask: ",e,a,t);switch(e){case"onloadstart":this.uploadTasks[t]={taskId:t,eventData:a};this.storage.set("uploadTasks",JSON.stringify(this.uploadTasks));break;case"onimdiskmessageaddsuccess":this.removeUploadTaskFromStorage(t);break;case"onimdiskmessageaddfail":case"onloadstartfailed":case"onerrorfilecreate":case"onfileuploadfailed":case"ontasknotfound":case"onfilereaderror":if(a.error.error&&a.error.error.code&&a.error.error.code===-2){FileUploadAgent.FileUploader.deleteTask(t);break}this.removeUploadTaskFromStorage(t);break;case"ontaskcancelled":this.removeUploadTaskFromStorage(t);break;default:break}};ChatUploader.getUploadTasksFromStorage=function(){const e=this.storage.get("uploadTasks");return e?JSON.parse(e):{}};ChatUploader.restartUploadTasks=function(){this.uploadTasks=this.getUploadTasksFromStorage();if(Object.keys(this.uploadTasks).length===0){return}const e=Object.values(this.uploadTasks).filter((e=>e.taskId.startsWith("imDialog"))).map((e=>({taskId:e.taskId})));BX.postComponentEvent("onFileUploadTaskRequest",[{files:e}],"background")};ChatUploader.removeUploadTaskFromStorage=function(e){if(this.uploadTasks.length===0){return}if(this.uploadTasks.hasOwnProperty(e)){delete this.uploadTasks[e]}this.storage.set("uploadTasks",JSON.stringify(this.uploadTasks))};ChatUploader.executeBackgroundTaskSuccess=function(e,a,t){if(e.toString().startsWith("imDialog")){let s={file:t,result:a};this.database.table(ChatTables.diskFileQueue).then((a=>a.delete({id:e})));FileUploadAgent.postFileEvent(ChatUploaderEvents.DISK_MESSAGE_ADD_SUCCESS,s,e);if(typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imFileCommit",{})}}};ChatUploader.executeBackgroundTaskFailure=function(e,a,t,s,o){if(!e.toString().startsWith("imDialog")){return false}let r={file:o,error:{status:s,code:a,description:t}};this.fileRemove(e,o.fileId,o);FileUploadAgent.postFileEvent(ChatUploaderEvents.DISK_MESSAGE_ADD_FAIL,r,e)};ChatUploader.init();
//# sourceMappingURL=extension.map.js