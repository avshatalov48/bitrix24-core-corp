"use strict";var{EventType:EventType}=jn.require("im/messenger/const");if(typeof clearInterval=="undefined"){clearInterval=e=>clearTimeout(e)}if(typeof ChatCreate!="undefined"&&typeof ChatCreate.cleaner!="undefined"){ChatCreate.cleaner()}var ChatCreate={TYPE_OPEN:"OPEN",TYPE_CHAT:"CHAT"};ChatCreate.init=function(){this.userId=parseInt(BX.componentParameters.get("USER_ID",0));this.siteId=BX.componentParameters.get("SITE_ID","s1");this.languageId=BX.componentParameters.get("LANGUAGE_ID","en");this.searchMinTokenLength=BX.componentParameters.get("SEARCH_MIN_SIZE",3);let e=["base","event","search"];e.forEach((t=>{if(typeof this[t]!="undefined"){e.forEach((e=>{if(e=="base"){this[t]["base"]=this}else if(t!=e){this[t][e]=this[e]}}))}}));ChatDataConverter.init({userId:this.userId,generalChatId:this.generalChatId});this.event.init();this.search.init();return true};ChatCreate.openDialog=function(e,t){console.log("ChatCreate.openDialog",e,t);BX.postComponentEvent("onOpenDialog",[{dialogId:e,dialogTitleParams:t},true],"im.recent");BX.postComponentEvent(EventType.messenger.openDialog,[{dialogId:e,dialogTitleParams:t}],"im.messenger");this.close();return true};ChatCreate.alert=function(e){ChatCreateInterface.showAlert(e);return true};ChatCreate.close=function(){ChatCreateInterface.close();return true};ChatCreate.cleaner=function(){BX.listeners={};console.warn("ChatCreate.cleaner: OK")};ChatCreate.event={};ChatCreate.event.init=function(){this.debug=false;this.handlersList={onViewShown:this.onPrivateView,onSearchShow:this.onPrivateSearchShow,onSearchHide:this.onPrivateSearchHide,onPrivateTypeText:this.onSearchText,onPrivateChat:this.onPrivateDialogOpen,onSearchItemSelected:this.onPrivateDialogOpen,onScopeSelected:this.onScopeSelected,onRecipientsView:this.onRecipientsView,onRecipientTypeText:this.onSearchText,onRecipientButtonSelected:this.onRecipientButtonSelected,onResult:this.onChatCreate,onInviteEmployees:this.onInviteEmployees};ChatCreateInterface.setListener(this.router.bind(this))};ChatCreate.event.router=function(e,t){if(this.handlersList[e]){if(!(e=="onPrivateTypeText"||e=="onRecipientTypeText")){console.log("ChatCreate.event.router: catch event - "+e,t)}this.handlersList[e].apply(this,[t])}else if(this.debug){console.info("ChatCreate.event.router: skipped event - "+e+" "+JSON.stringify(t))}};ChatCreate.event.onPrivateSearchShow=function(e){console.log("ChatCreate.event.onPrivateSearchShow",e)};ChatCreate.event.onPrivateSearchHide=function(e){console.log("ChatCreate.event.onPrivateSearchHide",e);ChatSearchScopes.clear();this.search.drawStartList()};ChatCreate.event.onPrivateDialogOpen=function(e){ChatSearchScopes.selectElement(e);if(e.params.action=="item"){let t=(e.params.type==="chat"?"chat":"")+e.params.id;this.base.openDialog(t,{name:e.title,description:e.subtitle,avatar:e.imageUrl})}return true};ChatCreate.event.onPrivateView=function(){this.search.state=this.search.STATE_PRIVATE;ChatSearchScopes.setSkipList([],ChatSearchScopes.TYPE_USER);this.search.listType="user";BX.componentParameters.set("SCOPE",this.search.listType);ChatSearchScopes.setType(this.search.listType);BX.componentParameters.set("STATE",this.search.state)};ChatCreate.event.onScopeSelected=function(e){if(this.search.state==this.STATE_PRIVATE){return false}console.log("ChatCreate.event.onScopeSelected",e);this.search.listType=e.id;BX.componentParameters.set("SCOPE",e.id);ChatSearchScopes.setType(e.id);this.onSearchText({text:ChatSearchScopes.result.text});return true};ChatCreate.event.onRecipientsView=function(){ChatSearchScopes.setSkipList(this.search.skipList,ChatSearchScopes.TYPE_USER);this.search.state=this.search.STATE_CHAT_RECIPIENT;BX.componentParameters.set("STATE",this.search.state);this.search.drawStartList()};ChatCreate.event.onRecipientButtonSelected=function(e){console.log("ChatCreate.event.onRecipientButtonSelected",e);ChatSearchScopes.selectElement(e)};ChatCreate.event.onSearchText=function(e){console.log("ChatCreate.event.onSearchText",e);let t=e.text.trim();if(!t){ChatSearchScopes.clear();this.search.drawStartList()}else{ChatSearchScopes.find(t)}};ChatCreate.event.onChatCreate=function(e){console.log("ChatCreate.event.onChatCreate",e);let t=[];if(e.recipients){e.recipients.forEach((e=>{t.push(e.id)}))}let a={TYPE:e.type=="public"?this.base.TYPE_OPEN:this.base.TYPE_CHAT,TITLE:e.title};if(t.length>0){a.USERS=t}if(e.icon){a.AVATAR=e.icon}BX.rest.callMethod("im.chat.add",a).then((t=>{if(typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imChatAdd",{})}let a=parseInt(t.data());if(a>0){console.info("ChatCreate.event.onChatCreate: chat id:\n",t.data());this.base.openDialog("chat"+t.data(),{name:e.title,description:e.type=="public"?BX.message("IM_CHAT_TYPE_OPEN_NEW"):BX.message("IM_CHAT_TYPE_CHAT_NEW"),avatar:""})}else{console.error("ChatCreate.event.onChatCreate: we have some problems on server\n",t.answer);this.base.alert(BX.message("IM_CREATE_API_ERROR"))}})).catch((e=>{let t=e.error();if(t.ex.error=="NO_INTERNET_CONNECTION"){console.error("ChatCreate.event.onChatCreate - error: connection error",t.ex);this.base.alert(BX.message("IM_CREATE_CONNECTION_ERROR"))}else{console.error("ChatCreate.event.onChatCreate - error: we have some problems on server\n",e.answer);this.base.alert(BX.message("IM_CREATE_API_ERROR"))}}));return true};ChatCreate.event.onInviteEmployees=function(e){console.log("ChatCreate.event.onInviteEmployees",e);if(Application.getApiVersion()<34||!BX.componentParameters.get("INTRANET_INVITATION_CAN_INVITE",false)){return false}IntranetInvite.openRegisterSlider({originator:"im.chat.create",registerUrl:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_URL",""),rootStructureSectionId:BX.componentParameters.get("INTRANET_INVITATION_ROOT_STRUCTURE_SECTION_ID",0),adminConfirm:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM",false),disableAdminConfirm:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM_DISABLE",false),sharingMessage:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_SHARING_MESSAGE","")});return true};ChatCreate.search={STATE_PRIVATE:"private",STATE_CHAT_RECIPIENT:"chat"};ChatCreate.search.init=function(){this.state=BX.componentParameters.get("STATE",this.STATE_PRIVATE);this.listType=BX.componentParameters.get("SCOPE",ChatSearchScopes.TYPE_USER);this.listUsers=BX.componentParameters.get("LIST_USERS",[]);this.listDepartment=BX.componentParameters.get("LIST_DEPARTMENTS",[]);this.skipList=BX.componentParameters.get("SKIP_LIST",[]);ChatSearchScopes.init({listType:this.listType,dataConverterInited:true,minTokenLength:this.base.searchMinTokenLength,onDrawSearchResult:this.drawSearchResult.bind(this)});ChatSearchScopes.setList(this.listUsers,ChatSearchScopes.TYPE_USER);ChatSearchScopes.setList(this.listDepartment,ChatSearchScopes.TYPE_DEPARTMENT);ChatSearchScopes.setMinTokenLength(1,ChatSearchScopes.TYPE_DEPARTMENT)};ChatCreate.search.drawSearchResult=function(e,t){console.log("ChatCreate.search.drawSearchResult",this.state,e);if(this.state==this.STATE_PRIVATE){ChatCreateInterface.setSearchPrivateResult(e,t)}else{e=e.filter((e=>!(e.source&&e.source.bot&&e.source.network)));ChatCreateInterface.setRecipientsList(e,t)}};ChatCreate.search.drawStartList=function(){console.log("ChatCreate.search.drawStartList");if(this.state==this.STATE_CHAT_RECIPIENT){this.drawSearchResult(this.prepareItems(),[])}else{this.drawSearchResult([],[])}};ChatCreate.search.prepareItems=function(e=this.listType){let t=[];let a={};if(e==ChatSearchScopes.TYPE_USER){if(this.listUsers.length>0){this.listUsers.map((e=>{if(!e||a[e.id]){return false}if(e.bot&&e.network){return false}let r=ChatDataConverter.getListElementByUser(e);t.push(r);a[r.id]=true;return true}))}t=t.filter((e=>this.skipList.indexOf(e.id)==-1))}else if(e==ChatSearchScopes.TYPE_DEPARTMENT){if(this.listDepartment.length>0){this.listDepartment.map((e=>{if(!e||a[e.id]){return false}let r=ChatDataConverter.getListElementByDepartment(e);t.push(r);a[r.id]=true;return true}))}else{t.push({title:BX.message("IM_DEPARTMENT_START"),sectionCode:this.listType,type:"button",unselectable:true,params:{action:"empty"}})}}return t};ChatCreate.init();
//# sourceMappingURL=component.map.js