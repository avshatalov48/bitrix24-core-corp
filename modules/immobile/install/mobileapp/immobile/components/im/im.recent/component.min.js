"use strict";var{ChatSelector:ChatSelector}=jn.require("im/chat/selector/chat");var{EntityReady:EntityReady}=jn.require("entity-ready");var{SelectorDialogListAdapter:SelectorDialogListAdapter}=jn.require("im/chat/selector/adapter/dialog-list");var REVISION=19;BX.message.LIMIT_ONLINE=BX.componentParameters.get("LIMIT_ONLINE",1380);if(typeof clearInterval=="undefined"){clearInterval=e=>clearTimeout(e)}if(typeof RecentList!="undefined"&&typeof RecentList.cleaner!="undefined"){RecentList.cleaner()}var RecentList={};RecentList.init=function(){let e=["base","cache","pull","push","queue","notify","notifier","event","promotion","action","search","chatCreate","topMenu"];e.forEach((t=>{if(typeof this[t]!="undefined"){e.forEach((e=>{if(e=="base"){this[t]["base"]=this}else if(t!=e){this[t][e]=this[e]}}))}}));let t=BX.componentParameters.get("MESSAGES",{});for(let e in t){if(t.hasOwnProperty(e)){BX.message[e]=t[e]}}this.debugLog=BX.componentParameters.get("PULL_DEBUG",false);this.generalChatId=BX.componentParameters.get("IM_GENERAL_CHAT_ID",0);this.viewLoaded=false;BX.onViewLoaded((()=>{this.viewLoaded=true}));this.imagePath=component.path+"images";this.ready=false;this.list=[];this.callList=[];this.listEmpty=true;this.blocked={};this.lastSyncDate=null;this.lastMessageDate=null;this.haveElementsToLoad=false;this.isLoadingNextElements=false;this.siteId=BX.componentParameters.get("SITE_ID","s1");this.siteDir=BX.componentParameters.get("SITE_DIR","/");this.languageId=BX.componentParameters.get("LANGUAGE_ID","en");this.userId=parseInt(BX.componentParameters.get("USER_ID",0));this.userData={};this.colleaguesList=[];this.businessUsersList=null;this.searchMinTokenLength=BX.componentParameters.get("SEARCH_MIN_SIZE",3);this.messageCount=0;this.counterDetail={};this.linesCount=0;this.counterLinesDetail={};this.loadMoreAfterErrorInterval=5e3;this.listRequestAfterErrorInterval=1e4;this.updateCounterInterval=300;this.firstLoadFlag=false;this.loadingFlag=true;this.cache.database=new ReactDatabase(ChatDatabaseName,this.userId,this.languageId);this.swipeHelperShowLimit=2;this.options=Application.storage.getObject("settings.chat.recent",{swipeHelperShowCounter:0});ChatDataConverter.init({userId:this.userId,generalChatId:this.generalChatId,isIntranetInvitationAdmin:this.isIntranetInvitationAdmin(),listType:this.isRecent()?"recent":"lines",updateRuntimeDataFunction:this.updateRuntimeDataElement.bind(this)});BX.addCustomEvent("failRestoreConnection",(()=>{BX.onViewLoaded(this.refresh.bind(this))}));this.push.init();this.queue.init();this.search.init();this.event.init();this.cache.init();this.pull.init();this.notifier.init();if(this.isRecent()){this.notify.init()}BX.onViewLoaded((()=>{this.dialogOptionInit();this.action.init();this.topMenu.init();this.promotion.init();this.redraw()}));if(this.isRecent()){this.refresh({start:true})}else{EntityReady.wait("chat").then((()=>this.refresh({start:true})))}IntranetInvite.init();BX.addCustomEvent("onImDetailShowed",(e=>{this.updateElement(e.dialogId,{counter:0});if(Application.getApiVersion()>=25&&Application.isWebComponentSupported()){return true}let t=this.getOpenDialogParams(e.dialogId);t.logAction="onImDetailShowed";if(this.isRecent()){if(t.type=="chat"&&t.chat.type=="lines"&&this.isOpenlinesOperator()){return false}}else if(this.isOpenlinesRecent()){if(t.type!="chat"||t.chat.type!="lines"){return false}}BX.postWebEvent("onPageParamsChangedLegacy",{url:"/mobile/im/dialog.php",data:t})}));BX.addCustomEvent("onAppActiveBefore",(()=>{BX.onViewLoaded((()=>{if(this.cache.inited){this.push.updateList();this.refresh()}}))}));BX.addCustomEvent("onAppPaused",(()=>{this.push.manager.clear()}));BX.addCustomEvent("onAppActive",(()=>{this.push.actionExecute()}));EntityReady.addCondition("chat",(()=>this.ready));return true};RecentList.isDialogOpen=function(){return PageManager.getNavigator().getAll().length>1};RecentList.openDialog=function(e,t){let s={};let i=this.getElement(e,true);if(i){if(i.unread){this.action.read(e)}s={text:i.title,imageUrl:encodeURI(i.avatar.url),useLetterImage:true,imageColor:i.avatar.color,detailText:i.type=="user"?ChatMessengerCommon.getUserPosition(i.user):ChatMessengerCommon.getChatDescription(i.chat),callback:-1}}else if(t){s={text:t.name,imageUrl:t.avatar,useLetterImage:true,detailText:t.description,callback:-1}}else{s={text:BX.message("IM_DIALOG_UNNAMED"),callback:-1}}if(i.type==="chat"&&i.chat.entity_type==="GENERAL"){s.imageUrl=this.imagePath+"/avatar_general_x3.png"}if(i.type==="chat"&&i.chat.entity_type==="SUPPORT24_QUESTION"){s.imageUrl=this.imagePath+"/avatar_24_question_x3.png";s.detailText=""}if(i.type==="notification"||e==="notify"){if(BX.componentParameters.get("NEXT_NAVIGATION","N")==="Y"){if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}BX.postComponentEvent("onTabChange",["notifications"],"im.navigation")}else{let e={unique:true,cache:false,url:env.siteDir+"mobile/im/notify.php"};BX.postWebEvent("onNotifyRefresh",{});PageManager.openPage(e)}return true}if(Application.getApiVersion()>=25&&Application.isWebComponentSupported()){let a=PageManager.getNavigator().getVisible();let n=true;if(a.type==="Web"&&a.pageId==="im-"+e){if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}return false}else if(Application.getApiVersion()===25){let t=false;PageManager.getNavigator().getAll().forEach((s=>{if(t)return true;if(s.type=="Web"&&s.pageId=="im-"+e){t=true;PageManager.getNavigator().toPageByCode(s.uniqueCode);if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}}}));if(t){return true}}else if(Application.getApiVersion()>=30){if(a.type==="Web"&&a.pageId.toString().startsWith("im-")){n=false}PageManager.getNavigator().cleanUpToCurrent()}else{let t=PageManager.getNavigator().toPageByID("im-"+e);if(t){if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}return true}}let r={};let o=Application.storage.getObject("settings.chat",{quoteEnable:ChatPerformance.isGestureQuoteSupported(),quoteFromRight:Application.getApiVersion()<31,backgroundType:"LIGHT_GRAY"});let l=RecentList.isOpenlinesRecent()||i&&(i.chat&&i.chat.type==="lines"||typeof i.lines!=="undefined")||t&&t.chatType==="lines";if(l||Application.getApiVersion()<29){r={page_id:"im-"+e,data:this.getOpenDialogParams(e,true),url:"/mobile/web_mobile_component/im.dialog/?version="+BX.componentParameters.get("COMPONENT_CHAT_DIALOG_VERSION","1.0.0"),animated:n,titleParams:s,textPanelParams:{smileButton:{},attachButton:{},useImageButton:true,placeholder:BX.message("IM_M_TEXTAREA"),mentionDataSource:{outsection:"NO",url:env.siteDir+"/mobile/index.php?mobile_action=get_user_list&use_name_format=Y&with_bots"}}}}else{if(!ChatDialogBackground[o.backgroundType]){o.backgroundType="LIGHT_GRAY"}let t=Object.assign({},ChatDialogBackground[o.backgroundType]);t.url=currentDomain+t.url;r={page_id:"im-"+e,data:this.getOpenDialogParams(e,true,true),url:"/mobile/web_mobile_component/im.dialog.vue/?version="+BX.componentParameters.get("COMPONENT_CHAT_DIALOG_VUE_VERSION","1.0.0"),customInsets:true,titleParams:s,animated:n,useSystemSwipeBehavior:o.quoteEnable&&!o.quoteFromRight,textPanelParams:{smileButton:{},attachButton:{},useImageButton:true,useAudioMessages:true,placeholder:BX.message("IM_M_TEXTAREA"),mentionDataSource:{outsection:"NO",url:env.siteDir+"/mobile/index.php?mobile_action=get_user_list&use_name_format=Y&with_bots"}},background:t}}PageManager.openWebComponent(r);let c=l?["openlines"]:["chats"];BX.postComponentEvent("onTabChange",c,"im.navigation")}else{let t=this.getOpenDialogParams(e);let s={data:t,unique:true,url:env.siteDir+"mobile/im/dialog.php"};BX.postWebEvent("onPageParamsChangedLegacy",{url:env.siteDir+"mobile/im/dialog.php",data:t});PageManager.openPage(s)}return true};RecentList.getOpenDialogParams=function(e,t,s){t=t===true;s=s===true;if(t){let t=false;let i=this.getElement(e,true);if(i){if(i.type=="user"){t=JSON.stringify(i.user)}else if(i.type=="chat"){t=JSON.stringify(i.chat)}}return{PAGE_ID:"im-"+e,DIALOG_ID:e,DIALOG_TYPE:i.type,DIALOG_ENTITY:t,USER_ID:this.userId,SITE_ID:this.siteId,SITE_DIR:env.siteDir,LANGUAGE_ID:this.languageId,STORED_EVENTS:s?this.pull.getStoredEvents():[],SEARCH_MIN_TOKEN_SIZE:this.searchMinTokenLength,WIDGET_CHAT_USERS_VERSION:BX.componentParameters.get("WIDGET_CHAT_USERS_VERSION","1.0.0"),WIDGET_CHAT_RECIPIENTS_VERSION:BX.componentParameters.get("WIDGET_CHAT_RECIPIENTS_VERSION","1.0.0"),WIDGET_CHAT_TRANSFER_VERSION:BX.componentParameters.get("WIDGET_CHAT_TRANSFER_VERSION","1.0.0"),WIDGET_BACKDROP_MENU_VERSION:BX.componentParameters.get("WIDGET_BACKDROP_MENU_VERSION","1.0.0"),LANG_ADDITIONAL:{isCrmUniversalActivityScenarioEnabled:BX.message("isCrmUniversalActivityScenarioEnabled")}}}else{let t=null;let s=null;let i=this.getElement(e,true);if(i){if(i.type=="user"){s=JSON.stringify(i.user)}else if(i.type=="chat"){t=JSON.stringify(i.chat);s=JSON.stringify(i.user)}}return{dialogId:e,userId:this.userId,type:i.type,chat:t,user:s,messageHistory:null}}};RecentList.openUserProfile=function(e,t={}){let s=this.getElement(e,true);let i={};if(s){i={userId:s.user.id,imageUrl:ChatUtils.getAvatar(s.user.avatar),title:s.user.name,workPosition:s.user.work_position,name:s.user.name,url:currentDomain+"/mobile/users/?user_id="+e+"&FROM_DIALOG=Y"}}else{i={userId:e,imageUrl:ChatUtils.getAvatar(t.avatar),title:t.name,workPosition:t.work_position,name:t.name,url:currentDomain+"/mobile/users/?user_id="+e+"&FROM_DIALOG=Y"}}const{ProfileView:a}=jn.require("user/profile");a.open(i)};RecentList.callUser=function(e,t,s){let i=this.getElement(e);if(!i){return false}let a={};a[this.userId]=this.userData;a[i.id]=i.user;if(typeof t=="undefined"){BX.postComponentEvent("onCallInvite",[{userId:i.id,video:false,userData:a}],"calls")}else{if(t=="video"){BX.postComponentEvent("onCallInvite",[{userId:i.id,video:true,userData:a}],"calls")}else if(t=="phone"){BX.postComponentEvent("onPhoneTo",[{number:s,userData:a}],"calls")}else{BX.postComponentEvent("onCallInvite",[{userId:i.id,video:false,userData:a}],"calls")}}};RecentList.updateCounter=function(e){if(e!==false){if(!this.updateCounterTimeout){this.updateCounterTimeout=setTimeout((()=>this.updateCounter(false)),this.updateCounterInterval)}return true}clearTimeout(this.updateCounterTimeout);this.updateCounterTimeout=null;this.messageCount=0;this.linesCount=0;this.list.forEach((e=>{if(e.type==="notification"){this.notify.counter=e.counter;return}if(e.lines){delete this.counterLinesDetail[e.id]}else{delete this.counterDetail[e.id]}if(e.type!=="chat"||!e.chat.mute_list[this.userId]){let t=0;if(e.counter){t=e.counter}else if(e.unread){t=1}if(t){if(e.lines){this.linesCount+=t}else{this.messageCount+=t}}}}));for(let e in this.counterDetail){if(this.counterDetail.hasOwnProperty(e)){this.messageCount+=this.counterDetail[e]}}for(let e in this.counterLinesDetail){if(this.counterLinesDetail.hasOwnProperty(e)){this.linesCount+=this.counterLinesDetail[e]}}if(!this.isRecent()){return true}let t=this.messageCount;if(Application.getApiVersion()<41&&!this.isOpenlinesOperator()){t+=this.linesCount;this.linesCount=0}let s={chats:t,openlines:this.linesCount,notifications:this.notify.counter};BX.postComponentEvent("ImRecent::counter::messages",[t],"calls");BX.postComponentEvent("ImRecent::counter::list",[s],"communication");BX.postComponentEvent("ImRecent::counter::list",[s],"im.navigation")};RecentList.getTabCode=function(){return BX.componentParameters.get("TAB_CODE","none")};RecentList.isRecent=function(){return BX.componentParameters.get("COMPONENT_CODE")=="im.recent"};RecentList.isOpenlinesRecent=function(){return BX.componentParameters.get("COMPONENT_CODE")=="im.openlines.recent"};RecentList.isOpenlinesOperator=function(){return BX.componentParameters.get("OPENLINES_USER_IS_OPERATOR",false)};RecentList.isIntranetInvitationAdmin=function(){return BX.componentParameters.get("INTRANET_INVITATION_IS_ADMIN",false)};RecentList.cleaner=function(){BX.listeners={};this.queue.destroy();this.closeEmptyScreen();console.warn("RecentList.cleaner: OK")};RecentList.checkRevision=function(e){if(typeof e!="number"||REVISION>=e){return true}console.warn("RecentList.checkRevision: reload scripts because revision up ("+REVISION+" -> "+e+")");reloadAllScripts();return false};RecentList.dialogOptionInit=function(){if(!this.viewLoaded){return false}if(!this.isRecent()){dialogList.setSections([{title:"",id:"general",backgroundColor:"#ffffff",sortItemParams:{order:"asc"}},{title:BX.message("OL_SECTION_NEW"),id:"new",backgroundColor:"#ffffff",height:30,styles:{title:{font:{size:16,color:"#e66467",fontStyle:"medium"}}},sortItemParams:{order:"asc"}},{title:BX.message("OL_SECTION_PIN"),id:"pinned",backgroundColor:"#f6f6f6",sortItemParams:{order:"asc"}},{title:BX.message("OL_SECTION_WORK_2"),id:"work",backgroundColor:"#ffffff",height:30,styles:{title:{font:{size:16,color:"#225be5",fontStyle:"medium"}}},sortItemParams:{order:"asc"}},{title:BX.message("OL_SECTION_ANSWERED"),id:"answered",backgroundColor:"#ffffff",height:30,styles:{title:{font:{size:16,color:"#6EA44E",fontStyle:"medium"}}},sortItemParams:{order:"desc"}}]);return true}dialogList.setSections([{title:"",id:"call",backgroundColor:"#ffffff",sortItemParams:{order:"desc"}},{title:"",id:"pinned",backgroundColor:"#ffffff",sortItemParams:{order:"desc"}},{title:"",id:"general",backgroundColor:"#ffffff",sortItemParams:{order:"desc"}}]);return true};RecentList.refresh=function(e){if(!e){e={start:!this.firstLoadFlag}}clearTimeout(this.refreshTimeout);let t={};if(this.isRecent()){if(this.isOpenlinesOperator()){t["SKIP_OPENLINES"]="Y"}}else if(this.isOpenlinesRecent()){t["ONLY_OPENLINES"]="Y"}ChatRestRequest.abort("refresh");console.info("RecentList.refresh: send request to server",t);let s={serverTime:["server.time"],revision:["im.revision.get"],counters:["im.counters.get",{JSON:"Y"}],desktopStatus:["im.desktop.status.get"]};if(e.start){if(this.isRecent()){this.haveElementsToLoad=true}s.promotion=["im.promotion.get",{DEVICE_TYPE:"mobile"}];s.userData=["im.user.get"];s.businessUsers=["im.user.business.get",{USER_DATA:"Y"}]}if(this.lastSyncDate||this.isOpenlinesRecent()){if(this.lastSyncDate){t["LAST_SYNC_DATE"]=this.lastSyncDate}s.recent=["im.recent.get",t]}else{s.recent=["im.recent.list",t]}if(this.isRecent()){s.userCounters=["user.counters"];if(e.start){s.lastSearch=["im.search.last.get"];s.colleagues=["im.department.colleagues.get",{USER_DATA:"Y",LIMIT:50}]}}if(this.viewLoaded){this.loadingFlag=true;dialogList.setTitle({text:BX.message("COMPONENT_TITLE"),useProgress:true,largeMode:true})}ChatTimer.start("recent","load",3e3,(()=>{console.warn("RecentList.refresh: slow connection show progress icon")}));let i=new Date;BX.rest.callBatch(s,(t=>{ChatRestRequest.unregister("refresh");ChatTimer.stop("recent","load",true);if(this.loadingFlag){if(this.viewLoaded){dialogList.setTitle({text:BX.message("COMPONENT_TITLE"),useProgress:false,largeMode:true})}this.loadingFlag=false}let s=t.revision.error();let a=t.serverTime.error();let n=t.recent.error();let r=t.counters.error();let o=t.desktopStatus.error();let l=e.start?t.userData.error():false;let c=e.start?t.promotion.error():false;let u=this.isRecent()?t.userCounters.error():false;let h=this.isRecent()&&e.start?t.lastSearch.error():false;let d=this.isRecent()&&e.start?t.colleagues.error():false;let m=e.start?t.businessUsers.error():false;if(t.revision&&!s){let e=t.revision.data();if(!this.checkRevision(e.mobile)){return true}}if(t.recent&&!n){this.lastSyncDate=t.recent.time().date_start;console.info("RecentList request: list",t.recent.data());if(t.recent.data().items){let e=t.recent.data().items;if(e.length>0){this.lastMessageDate=e.slice(-1)[0].message.date}else{this.lastMessageDate=""}this.list=ChatDataConverter.getListFormat(e);this.redraw();if(t.recent.data().hasMore){this.drawBottomLoader()}else{this.haveElementsToLoad=false}}else{let e=ChatDataConverter.getListFormat(t.recent.data());if(e.length>0){let t=e.map((e=>e.id));this.list=this.list.filter((e=>!t.includes(e.id))).concat(e)}else if(this.viewLoaded){dialogList.stopRefreshing()}this.redraw()}if(this.isRecent()&&e.start&&this.list.length>0&&this.options.swipeHelperShowCounter<this.swipeHelperShowLimit){let e=ChatDataConverter.getElementFormat(this.list[0]);e.showSwipeActions=true;if(this.viewLoaded){dialogList.updateItem({id:e.id},e)}this.options.swipeHelperShowCounter++;Application.storage.setObject("settings.chat.recent",this.options)}}if(t.counters&&!r){let e=t.counters.data();console.info("RecentList request: counters",e);this.counterDetail=e.dialog;e.dialogUnread.forEach(function(e){this.counterDetail[e]=1}.bind(this));e.chatUnread.forEach(function(e){this.counterDetail["chat"+e]=1}.bind(this));for(let t in e.chat){if(e.chat.hasOwnProperty(t)){this.counterDetail["chat"+t]=e.chat[t]}}for(let t in e.lines){if(e.lines.hasOwnProperty(t)){this.counterLinesDetail["chat"+t]=e.lines[t]}}this.messageCount=e.type.chat+e.type.dialog;this.linesCount=e.type.lines;this.notify.counter=e.type.notify;this.notify.refresh();this.updateCounter(false)}if(t.userData&&!l){this.userData=ChatDataConverter.getUserDataFormat(t.userData.data())}if(t.promotion&&!c){this.promotion.promoActive=t.promotion.data()}if(this.isRecent()&&t.colleagues&&!d){console.info("RecentList.refresh: update colleagues list",t.colleagues.data());this.colleaguesList=ChatDataConverter.getUserListFormat(t.colleagues.data())}if(t.businessUsers&&!m){console.info("RecentList.refresh: update business users list",t.businessUsers.data());let e=t.businessUsers.data();this.businessUsersList=e?ChatDataConverter.getUserListFormat(t.businessUsers.data()):false}if(!n||!l||!h||!d||!m){this.cache.update({recent:true,colleagues:this.isRecent()&&e.start,businessUsers:this.isRecent()&&e.start,lastSearch:this.isRecent()})}if(this.isRecent()&&t.userCounters&&!u){BX.postComponentEvent("onSetUserCounters",[t.userCounters.data(),t.userCounters.time?t.userCounters.time():null],"communication")}if(t.serverTime&&!a){BX.postComponentEvent("onUpdateServerTime",[t.serverTime.data()],"communication")}if(t.desktopStatus&&!o){BX.postComponentEvent("setDesktopStatus",[t.desktopStatus.data()],"communication")}console.info("RecentList.refresh: receive answer from server and update variables ("+(new Date-i)+"ms)",t);if(s||n||r||u||l){let e=null;if(s){e=s}else if(n){e=n}else if(r){e=r}else if(u){e=u}else if(l){e=l}if(e){this.loadingFlag=true;if(this.viewLoaded){dialogList.setTitle({text:BX.message("COMPONENT_TITLE"),useProgress:true,largeMode:true})}if(e.ex.error=="REQUEST_CANCELED"){console.error("RecentList.refresh: execute request canceled by user",e.ex)}else{console.error("RecentList.refresh: we have some problems with request, we will be check again soon",e.ex);clearTimeout(this.refreshTimeout);this.refreshTimeout=setTimeout((()=>{if(!this.errorNoticeFlag&&this.isRecent()){ChatTimer.start("recent","error",2e3,(()=>{this.errorNoticeFlag=true;InAppNotifier.showNotification({message:BX.message("IM_REFRESH_ERROR"),backgroundColor:"#E6000000",time:this.listRequestAfterErrorInterval/1e3-2})}))}this.refresh()}),this.listRequestAfterErrorInterval)}}else{this.errorNoticeFlag=false;ChatTimer.stop("recent","error",true)}}else{if(!this.firstLoadFlag){this.firstLoadFlag=true}this.errorNoticeFlag=false;ChatTimer.stop("recent","error",true)}if(this.viewLoaded){dialogList.stopRefreshing()}if(this.isRecent()&&e.start){this.ready=true;BX.postComponentEvent("EntityReady::ready",["chat"])}}),false,(e=>{ChatRestRequest.register("refresh",e)}));return true};RecentList.loadMore=function(){clearTimeout(this.loadMoreTimeout);let e=this.prepareLoadMoreParams();BX.rest.callMethod("im.recent.list",e).then((e=>{let t=e.data().hasMore;if(!t){this.haveElementsToLoad=false}let s=e.data().items;if(s.length>0){this.lastMessageDate=s.slice(-1)[0].message.date;let e=this.prepareListWithNewElements(s);if(this.viewLoaded){dialogList.setItems([...this.callList,...e]);if(t){this.drawBottomLoader()}}this.isLoadingNextElements=false}else{this.lastMessageDate="";this.removeBottomLoader()}})).catch((e=>{console.warn("Error during im.recent.list",e);this.loadMoreAfterTimeout()}))};RecentList.prepareLoadMoreParams=function(){let e={};if(this.isRecent()){if(this.isOpenlinesOperator()){e["SKIP_OPENLINES"]="Y"}}else if(this.isOpenlinesRecent()){if(this.isOpenlinesOperator()){e["SKIP_CHAT"]="Y";e["SKIP_DIALOG"]="Y";e["SKIP_NOTIFICATION"]="Y";e["ONLY_OPENLINES"]="Y"}}e["LAST_MESSAGE_DATE"]=this.lastMessageDate;return e};RecentList.isReadyToLoadMore=function(e){return e.offset.y>=e.contentSize.height*.8&&!this.isLoadingNextElements&&this.haveElementsToLoad};RecentList.prepareListWithNewElements=function(e){let t=ChatDataConverter.getListFormat(e);let s=this.list.map((e=>e.id));this.list=t.filter((e=>!s.includes(e.id))).concat(this.list);let i=[];this.list.forEach((e=>{i.push(ChatDataConverter.getElementFormat(e))}));return i};RecentList.drawBottomLoader=function(){if(!this.viewLoaded){return false}if(this.listEmpty){dialogList.removeItem({"params.id":"empty"})}let e=Application.getApiVersion()>=39;dialogList.addItems(this.getLoadingElement(),e);return true};RecentList.removeBottomLoader=function(){if(!this.viewLoaded){return false}dialogList.removeItem({id:"loading"});if(this.listEmpty){let e=Application.getApiVersion()>=39;dialogList.addItems(this.getEmptyElement(),e)}return true};RecentList.loadMoreAfterTimeout=function(){clearTimeout(this.loadMoreTimeout);this.loadMoreTimeout=setTimeout((()=>{this.loadMore()}),this.loadMoreAfterErrorInterval)};RecentList.clearAllCounters=function(){this.counterDetail={};if(this.viewLoaded){let e=[...this.callList];this.list.forEach((t=>{t.counter=0;t.unread=false;let s=ChatDataConverter.getElementFormat(t);e.push(s)}));dialogList.setItems(e)}else{this.list.forEach((e=>{e.counter=0;e.unread=false}))}this.updateCounter(false);this.cache.update({recent:true})};RecentList.redraw=function(){this.queue.clear();let e=[...this.callList];this.list.forEach((t=>{if(this.viewLoaded){e.push(ChatDataConverter.getElementFormat(t))}}));if(!this.viewLoaded){return false}if(e.length<=0){if(this.loadingFlag){e=this.getLoadingElement()}else{e=this.getEmptyElement();this.openEmptyScreen()}this.listEmpty=true}else if(this.listEmpty){this.listEmpty=false;dialogList.removeItem({"params.id":"empty"});this.closeEmptyScreen()}dialogList.setItems(e);dialogList.stopRefreshing();return true};RecentList.openEmptyScreen=function(){if(!this.viewLoaded){return false}if(Application.getApiVersion()<23){return false}let e={};if(this.isRecent()){if(BX.componentParameters.get("INTRANET_INVITATION_CAN_INVITE",false)){e={upperText:BX.message("IM_EMPTY_TEXT_1"),lowerText:BX.message("IM_EMPTY_TEXT_INVITE"),iconName:"ws_employees",listener:()=>IntranetInvite.openRegisterSlider({originator:"im.recent",registerUrl:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_URL",""),rootStructureSectionId:BX.componentParameters.get("INTRANET_INVITATION_ROOT_STRUCTURE_SECTION_ID",0),adminConfirm:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM",false),disableAdminConfirm:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM_DISABLE",false),sharingMessage:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_SHARING_MESSAGE","")})}}else{e={upperText:BX.message("IM_EMPTY_TEXT_1"),lowerText:BX.message("IM_EMPTY_TEXT_CREATE"),iconName:"ws_employees",listener:()=>this.chatCreate.open()}}e["startChatButton"]={text:BX.message("IM_EMPTY_BUTTON"),iconName:"ws_plus"}}else{e={upperText:BX.message("IM_EMPTY_OL_TEXT_1"),lowerText:BX.message("IM_EMPTY_OL_TEXT_2"),iconName:"ws_openlines"}}dialogList.welcomeScreen.show(e);return true};RecentList.closeEmptyScreen=function(){if(!this.viewLoaded){return false}if(Application.getApiVersion()<23){return false}dialogList.welcomeScreen.hide();return true};RecentList.getEmptyElement=function(){let e=[];if(this.isRecent()){e.push({title:BX.message("IM_LIST_EMPTY"),type:"button",sectionCode:"general",params:{id:"empty",type:"openSearch"}})}else{e.push({title:BX.message("OL_LIST_EMPTY"),type:"button",sectionCode:"general",params:{id:"empty",type:"openSearch"},unselectable:true})}return e};RecentList.getLoadingElement=function(){return[{id:"loading",title:BX.message("IM_LIST_LOADING"),type:"loading",unselectable:true,params:{action:"progress"},sectionCode:"general"}]};RecentList.getElement=function(e,t){let s=this.list.findIndex((t=>t&&t.id==e));if(s==-1){return false}return t===true?ChatUtils.objectClone(this.list[s]):this.list[s]};RecentList.getElementByMessageId=function(e,t){let s=this.list.findIndex((t=>t&&t.message.id==e));if(s==-1){return false}return t===true?ChatUtils.objectClone(this.list[s]):this.list[s]};RecentList.setElement=function(e,t,s){if(!t){return false}s=s===true;this.unblockElement(e);let i=this.list.findIndex((t=>t&&t.id==e));if(i==-1){e=t.id;this.list.push(t);this.queue.add(this.queue.TYPE_ADD,e,t)}else{e=this.list[i].id;this.list[i]=t;this.queue.add(this.queue.TYPE_UPDATE,e,t)}if(s){this.queue.worker()}return true};RecentList.updateElement=function(e,t,s){if(!t){return false}let i=this.list.findIndex((t=>t&&t.id==e));if(i==-1){return false}s=s===true;this.unblockElement(e);if(!ChatUtils.isObjectChanged(this.list[i],t)){return true}e=this.list[i].id;this.list[i]=ChatUtils.objectMerge(this.list[i],t);this.queue.add(this.queue.TYPE_UPDATE,e,this.list[i]);if(s){this.queue.worker()}return true};RecentList.deleteElement=function(e){let t=this.list.findIndex((t=>t&&t.id==e));if(t==-1){return false}this.unblockElement(e);e=this.list[t].id;delete this.list[t];ChatTimer.delete(e);this.updateCounter(false);this.cache.update({recent:true});this.queue.delete(this.queue.TYPE_ALL,e);if(!this.viewLoaded){return false}dialogList.removeItem({"params.id":e});this.listEmpty=true;for(let e of this.list){if(typeof e!="undefined"){this.listEmpty=false;break}}if(this.listEmpty){dialogList.setItems(this.getEmptyElement());this.openEmptyScreen()}return true};RecentList.blockElement=function(e,t,s,i){this.blocked[e]=true;i=typeof i=="undefined"?{}:i;i.__callback=typeof s=="function"?s:()=>{};ChatTimer.start("block",e,3e4,((e,t)=>{this.unblockElement(e,false);t.__callback(e,t)}),i);return true};RecentList.unblockElement=function(e,t){delete this.blocked[e];let s=t!==true;ChatTimer.stop("block",e,s);return true};RecentList.isElementBlocked=function(e){return this.blocked[e]===true};RecentList.drawCall=function(e){let t=this.callList.findIndex((t=>t.id===e.id));if(t>=0){this.callList[t]=e}else{this.callList.push(e)}this.drawCallNative(e)};RecentList.drawCallNative=function(e){if(!this.viewLoaded){return false}dialogList.findItem({id:e.id},(t=>{if(t){dialogList.updateItem({id:e.id},e)}else{let t=Application.getApiVersion()>=39;dialogList.addItems([e],t)}}))};RecentList.removeCall=function(e){console.warn("removeCall",e);this.callList=this.callList.filter((t=>t.id!==e));dialogList.removeItem({id:e})};RecentList.updateCallState=function(){this.callList.forEach((e=>this.drawCallNative(e)))};RecentList.updateRuntimeDataElement=function(e){let t=ChatDataConverter.getUserImageCode(e);let s=typeof e.runtime=="undefined"||e.runtime.status!=t;if(!s){return true}let i=this.list.findIndex((t=>t&&t.id==e.id));if(i==-1){return false}if(typeof e.runtime=="undefined"){e.runtime={};this.list[i].runtime={}}if(e.runtime.status!=t){e.runtime.status=t;this.list[i].runtime.status=t}return true};RecentList.capturePullEvent=function(e){if(typeof e=="undefined"){e=!this.debugLog}console.info('RecentList.capturePullEvent: capture "Pull Event" '+(e?"enabled":"disabled"));this.debugLog=!!e;BX.componentParameters.set("PULL_DEBUG",this.debugLog)};RecentList.cache={updateTimeout:"",updateInterval:2e3,database:{},inited:false};RecentList.cache.init=function(){let e=new Date;if(this.base.isRecent()){this.database.table(ChatTables.recent).then((t=>{t.get().then((t=>{this.inited=true;if(t.length>0){let s=JSON.parse(t[0].VALUE);if(this.base.list.length>0){console.info('RecentList.cache.init: cache file "recent" has been ignored because it was loaded a very late');this.push.updateList();this.push.actionExecute();this.base.redraw();return false}if(typeof s.list=="undefined"){console.info('RecentList.cache.init: cache file "recent" has been ignored because it\'s old');this.push.updateList();this.push.actionExecute();this.base.redraw();return false}this.base.list=ChatDataConverter.getListFormat(s.list);this.push.updateList();this.push.actionExecute();this.base.redraw();console.info('RecentList.cache.init: list items load from cache "recent" ('+(new Date-e)+"ms)","count: "+this.base.list.length);if(s.userData){this.base.userData=s.userData}}else{this.push.updateList();this.push.actionExecute();this.base.redraw()}}))}))}else{this.inited=true;this.push.actionExecute();this.base.redraw()}let t=new Date;this.database.table(ChatTables.colleaguesList).then((e=>{e.get().then((e=>{if(e.length>0){let s=JSON.parse(e[0].VALUE);if(this.base.colleaguesList.length>0){console.info('RecentList.cache.init: cache file "colleagues list" has been ignored because it was loaded a very late');return false}this.base.colleaguesList=ChatDataConverter.getUserListFormat(s.colleaguesList);console.info('RecentList.cache.init: list items load from cache "colleagues list" ('+(new Date-t)+"ms)","count: "+this.base.colleaguesList.length)}}))}));let s=new Date;this.database.table(ChatTables.businessUsersList).then((e=>{e.get().then((e=>{if(e.length>0){let t=JSON.parse(e[0].VALUE);if(this.base.businessUsersList!==null){console.info('RecentList.cache.init: cache file "business users list" has been ignored because it was loaded a very late');return false}this.base.businessUsersList=t.businessUsersList!==false?ChatDataConverter.getUserListFormat(t.businessUsersList):false;console.info('RecentList.cache.init: list items load from cache "business users list" ('+(new Date-s)+"ms)",this.base.businessUsersList!==false?"count: "+this.base.businessUsersList.length:"not available")}}))}));return true};RecentList.cache.update=function(e){if(!this.base.isRecent()){return true}e=e||{recent:true,lastSearch:true,colleagues:false,businessUsers:false};clearTimeout(this.refreshTimeout);this.refreshTimeout=setTimeout((()=>{let t=new Date;let s=new Date;let i=new Date;let a=new Date;if(e.recent){this.database.table(ChatTables.recent).then((e=>{e.delete().then((()=>{e.add({value:{list:this.base.list,userData:this.base.userData}}).then((()=>{console.info("RecentList.cache.update: recent list items updated ("+(new Date-t)+"ms)","count: "+this.base.list.length)}))}))}))}if(e.colleagues){this.database.table(ChatTables.colleaguesList).then((e=>{e.delete().then((()=>{e.add({value:{colleaguesList:this.base.colleaguesList}}).then((()=>{console.info("RecentList.cache.update: colleagues list items updated ("+(new Date-i)+"ms)","count: "+this.base.colleaguesList.length)}))}))}))}if(e.businessUsers){this.database.table(ChatTables.businessUsersList).then((e=>{e.delete().then((()=>{e.add({value:{businessUsersList:this.base.businessUsersList}}).then((()=>{console.info("RecentList.cache.update: business users list items updated ("+(new Date-a)+"ms)",this.base.businessUsersList?"count: "+this.base.businessUsersList.length:"not available")}))}))}))}}),this.updateInterval);return true};RecentList.push={};RecentList.push.init=function(){if(this.base.isRecent()){this.manager=Application.getNotificationHistory("im_message");this.notifyManager=Application.getNotificationHistory("im_notify")}else{this.manager=Application.getNotificationHistory("im_lines_message")}this.manager.setOnChangeListener((()=>{BX.onViewLoaded((()=>{if(this.cache.inited){this.push.updateList()}}))}))};RecentList.push.updateList=function(){let e=this.manager.get();if(!e||!e["IM_MESS"]||e["IM_MESS"].length<=0){console.info("RecentList.push.updateList: list is empty");return true}console.info("RecentList.push.updateList: parse push messages",e["IM_MESS"]);let t=this.base.isDialogOpen();e["IM_MESS"].forEach((e=>{if(!e.data){return false}if(!(e.data.cmd==="message"||e.data.cmd==="messageChat")){return false}let s="";if(typeof e.senderMessage!=="undefined"){s=e.senderMessage}else if(typeof e.aps!=="undefined"&&e.aps.alert.body){s=e.aps.alert.body}if(!s){return false}let i={module_id:"im",command:e.data.cmd,params:ChatDataConverter.preparePushFormat(e.data)};i.params.userInChat[i.params.chatId]=[this.base.userId];i.params.message.text=s.toString().replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");if(e.senderCut){i.params.message.text=i.params.message.text.substr(e.senderCut)}if(!i.params.message.textOriginal){i.params.message.textOriginal=i.params.message.text}let a=ChatUtils.objectClone(i.params);if(a.message.params.FILE_ID&&a.message.params.FILE_ID.length>0){a.message.text="";a.message.textOriginal=""}if(t){BX.postWebEvent("chatrecent::push::get",a)}else{this.pull.storedEvents=this.pull.storedEvents.filter((e=>e.message.id!==a.message.id));this.pull.storedEvents.push(a)}let n=this.base.list.find((e=>e&&e.id.toString()===i.params.dialogId.toString()));if(!n||n.message.id<i.params.message.id){this.pull.eventExecute(i)}}));this.manager.clear();return true};RecentList.push.actionExecute=function(){if(Application.isBackground())return false;let e=Application.getLastNotification();if(e==={}){return false}console.info("RecentList.push.actionExecute: execute push-notification",e);let t=ChatDataConverter.getPushFormat(e);if(t.ACTION&&t.ACTION.substr(0,8)==="IM_MESS_"){if(this.base.isOpenlinesRecent()){return false}let e=parseInt(t.ACTION.substr(8));if(e>0){this.base.openDialog(e)}}else if(t.ACTION&&t.ACTION.substr(0,8)==="IM_CHAT_"){if(this.base.isRecent()){if(this.base.isOpenlinesOperator()&&t.CHAT_TYPE==="L"){if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}BX.postComponentEvent("onTabChange",["openlines"],"im.navigation");return false}}else{if(t.CHAT_TYPE!=="L"){return false}}let e=parseInt(t.ACTION.substr(8));if(e>0){this.base.openDialog("chat"+e)}}else if(t.ACTION&&t.ACTION==="IM_NOTIFY"){this.base.openDialog("notify")}return true};RecentList.pull={};RecentList.pull.init=function(){BX.PULL.subscribe({moduleId:"im",callback:this.eventExecute.bind(this)});if(this.base.isRecent()){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Online,callback:this.eventOnlineExecute.bind(this)})}else{BX.PULL.subscribe({moduleId:"imopenlines",callback:this.eventLinesExecute.bind(this)})}this.storedEvents=[];this.notifyStoredEvents=[]};RecentList.pull.getStoredEvents=function(){let e=[].concat(this.storedEvents);this.storedEvents=[];return e};RecentList.pull.getNotifyStoredEvents=function(){let e=[].concat(this.notifyStoredEvents);this.notifyStoredEvents=[];return e};RecentList.pull.getUserDataFormat=function(e){e=ChatDataConverter.getUserDataFormat(e);if(e.id>0){if(typeof e.name!="undefined"){e.name=ChatUtils.htmlspecialcharsback(e.name)}if(typeof e.last_name!="undefined"){e.last_name=ChatUtils.htmlspecialcharsback(e.last_name)}if(typeof e.first_name!="undefined"){e.first_name=ChatUtils.htmlspecialcharsback(e.first_name)}if(typeof e.work_position!="undefined"){e.work_position=ChatUtils.htmlspecialcharsback(e.work_position)}}return e};RecentList.pull.getFormattedElement=function(e){let t={};let s=this.base.list.findIndex((t=>t&&t.id==e.id));if(s>-1){t=ChatUtils.objectClone(this.base.list[s])}else{t={avatar:{},user:{id:0},message:{},counter:0,blocked:false,writing:false};if(e.id.toString().indexOf("chat")==0){t.type="chat";t.id=e.id;t.chat={};if(typeof e.chat=="undefined"){return false}}else{t.type="user";t.id=parseInt(e.id);t.user={};if(typeof e.user=="undefined"){return false}}if(typeof e.message=="undefined"){return false}}if(typeof e.message!="undefined"){t.message.id=parseInt(e.message.id);t.message.text=ChatMessengerCommon.purifyText(e.message.text,e.message.params);t.message.author_id=e.message.senderId&&e.message.system!=="Y"?e.message.senderId:0;t.message.date=new Date(e.message.date);t.message.file=e.message.params&&e.message.params.FILE_ID?e.message.params.FILE_ID.length>0:false;t.message.attach=e.message.params&&e.message.params.ATTACH?e.message.params.ATTACH.length>0:false;t.message.status=e.message.status?e.message.status:""}if(typeof e.counter!="undefined"){t.counter=e.counter}if(typeof e.writing!="undefined"){t.writing=e.writing}if(typeof e.user!="undefined"){e.user.id=parseInt(e.user.id);if(e.user.id>0){t.user=e.user=this.getUserDataFormat(e.user);if(t.type=="user"){t.avatar.url=e.user.avatar;t.avatar.color=e.user.color;t.title=e.user.name}}else{t.user=e.user}}if(t.type=="chat"&&typeof e.chat!="undefined"){e.chat.id=parseInt(e.chat.id);e.chat.date_create=new Date(e.chat.date_create);t.chat=e.chat;t.avatar.url=e.chat.avatar;t.avatar.color=e.chat.color;t.title=e.chat.name;if(e.chat.type=="lines"&&e.lines!="undefined"){if(typeof t.lines=="undefined"){t.lines={}}t.lines.id=parseInt(e.lines.id);t.lines.status=parseInt(e.lines.status)}}return t};RecentList.pull.eventExecute=function(e){let{command:t,params:s,extra:i}=e;if(i&&(!this.base.checkRevision(i.revision_im_mobile)||i.server_time_ago>30)){return true}if(this.base.debugLog){console.warn('RecentList.pull.eventExecute: receive "'+t+'"',s)}if(t==="message"||t==="messageChat"){if(this.base.isRecent()){if(t==="messageChat"&&s.lines&&this.base.isOpenlinesOperator()){this.base.counterLinesDetail[s.dialogId]=s.counter;this.base.updateCounter();return false}if(!this.base.isDialogOpen()&&!s.message.push){let e=ChatUtils.objectClone(s);e.message.push=true;this.storedEvents=this.storedEvents.filter((t=>t.message.id!==e.message.id));this.storedEvents.push(e)}}else{if(t=="message"){return false}else if(s.chat[s.chatId].type!="lines"){return false}}if(t=="messageChat"&&s.userInChat[s.chatId].indexOf(this.base.userId)==-1){this.base.updateElement(s.userId,{user:{idle:false,last_activity_date:new Date}});return false}let e=Object.assign({},s.message);s.message.text=ChatMessengerCommon.purifyText(s.message.text,s.message.params);s.message.status=s.message.senderId==this.base.userId?"received":"";if(s.lines){delete this.base.counterLinesDetail[s.dialogId]}else{delete this.base.counterDetail[s.dialogId]}if(t=="message"){let e=s.message.senderId==this.base.userId?s.message.recipientId:s.message.senderId;let t=this.getFormattedElement({id:e,user:s.users[e],message:s.message,counter:s.counter});let a=s.notify!==true&&s.notify.indexOf(this.base.userId)==-1?this.base.getElement(e):true;if(a){this.base.setElement(e,t)}this.action.writing(e,false);if(i&&i.server_time_ago<=5&&s.message.senderId!=this.base.userId){this.notifier.show({dialogId:e,title:t.user.name,text:t.message.text,avatar:t.user.avatar})}}else if(t=="messageChat"){let e=this.getFormattedElement({id:s.message.recipientId,chat:s.chat[s.chatId],user:s.message.senderId>0?s.users[s.message.senderId]:{id:0},lines:s.lines,message:s.message,counter:s.counter});let t=s.notify!==true&&s.notify.indexOf(this.base.userId)==-1?this.base.getElement(s.message.recipientId):true;if(t){this.base.setElement(s.message.recipientId,e)}this.action.writing(s.message.recipientId,false);this.base.updateElement(s.userId,{user:{idle:false,last_activity_date:new Date}});if(i&&i.server_time_ago<=5&&s.message.senderId!=this.base.userId&&!e.chat.mute_list[this.base.userId]){this.notifier.show({dialogId:e.id,title:e.chat.name,text:(e.user.name?e.user.name+": ":"")+e.message.text,avatar:e.chat.avatar})}}}else if(t=="readMessageOpponent"||t=="readMessageChatOpponent"||t=="unreadMessageOpponent"||t=="unreadMessageChatOpponent"){if(this.base.isOpenlinesRecent()&&(t=="readMessageOpponent"||t=="unreadMessageOpponent")){return false}let e=this.base.getElement(s.dialogId);if(!e){return false}if(s.chatMessageStatus&&s.chatMessageStatus!=e.message.status){this.base.updateElement(s.dialogId,{message:{status:s.chatMessageStatus}})}this.base.updateElement(s.userId,{user:{idle:false,last_activity_date:new Date(s.date)}})}else if(t=="readMessage"||t=="readMessageChat"||t=="unreadMessage"||t=="unreadMessageChat"){if(this.base.isOpenlinesRecent()&&(t=="readMessage"||t=="unreadMessage")){return false}if(s.lines){this.base.counterLinesDetail[s.dialogId]=s.counter;this.base.updateCounter(false)}else{this.base.counterDetail[s.dialogId]=s.muted?0:s.counter}this.base.updateElement(s.dialogId,{counter:s.counter})}else if(t=="readAllChats"){if(this.base.isRecent()){this.base.clearAllCounters()}}else if(t=="startWriting"){if(this.base.isOpenlinesRecent()&&s.dialogId.toString().substr(0,4)!="chat"){return false}this.action.writing(s.dialogId,true)}else if(t=="messageUpdate"||t=="messageDelete"||t=="messageDeleteComplete"){let e=this.base.getElementByMessageId(s.id,true);if(!e){return false}e.message.text=ChatMessengerCommon.purifyText(s.text,s.params);e.message.params=s.params;e.message.file=s.params&&s.params.FILE_ID?s.params.FILE_ID.length>0:false;e.message.attach=s.params&&s.params.ATTACH?s.params.ATTACH.length>0:false;this.base.updateElement(e.id,e);this.action.writing(e.id,false)}else if(t=="dialogChange"){if(this.base.isRecent()&&PageManager.getNavigator().isActiveTab()){this.base.openDialog(s.dialogId)}}else if(t=="chatRename"){this.base.updateElement("chat"+s.chatId,{title:s.name,chat:{name:s.name}})}else if(t=="chatAvatar"){this.base.updateElement("chat"+s.chatId,{avatar:{url:s.avatar},chat:{avatar:s.avatar}})}else if(t=="chatChangeColor"){this.base.updateElement("chat"+s.chatId,{avatar:{color:s.color},chat:{color:s.color}})}else if(t=="chatUpdate"){let e={};if(e.name=="name"){e.title=e.value;e.chat={};e.chat.name=e.value}else if(e.name=="color"){e.avatar={};e.avatar.color=e.value;e.chat={};e.chat.color=e.value}else if(e.name=="avatar"){e.avatar={};e.avatar.url=e.value;e.chat={};e.chat.avatar=e.value}else if(e.name=="date_create"){e.chat={};e.chat.date_create=new Date(e.value)}this.base.updateElement("chat"+e.chatId,e)}else if(t=="chatMuteNotify"){if(this.base.isRecent()&&!s.lines||this.base.isRecent()&&s.lines&&!this.base.isOpenlinesOperator()||this.base.isOpenlinesRecent()&&s.lines){this.base.counterDetail[s.dialogId]=s.muted?0:s.counter;this.base.updateCounter(false)}let e={};e[this.base.userId]=s.muted;this.base.updateElement(s.dialogId,{chat:{mute_list:e}})}else if(t=="chatHide"){delete this.base.counterLinesDetail[s.dialogId];delete this.base.counterDetail[s.dialogId];this.base.deleteElement(s.dialogId);this.base.updateCounter()}else if(t=="chatShow"){if(s.lines){this.base.counterLinesDetail[s.dialogId]=0}else{this.base.counterDetail[s.dialogId]=0}if(this.base.isRecent()){if(s.lines&&this.base.isOpenlinesOperator()){return false}}else if(!s.lines){return false}let e=ChatDataConverter.getListElement(s);this.base.setElement(s.id,e);if(s.message.author_id>0&&s.message.author_id!=this.base.userId&&s.counter>0){this.notifier.show({dialogId:e.id,title:e.chat.name,text:(e.user.name?e.user.name+": ":"")+e.message.text,avatar:e.chat.avatar})}}else if(t=="chatPin"){this.base.updateElement(s.dialogId,{pinned:s.active},true)}else if(t=="chatUnread"){if(s.lines){this.base.counterLinesDetail[s.dialogId]=s.muted?0:s.counter?s.counter:1}else{this.base.counterDetail[s.dialogId]=s.muted?0:s.counter?s.counter:1}this.base.updateCounter(false);this.base.updateElement(s.dialogId,{unread:s.active})}else if(t=="deleteBot"){if(this.base.isOpenlinesRecent()){return false}this.base.deleteElement(s.botId)}else if(t=="chatUserLeave"){if(s.userId==this.base.userId){this.base.deleteElement(s.dialogId)}delete this.base.counterLinesDetail[s.dialogId];delete this.base.counterDetail[s.dialogId];this.base.updateCounter(false)}else if(t=="userUpdate"||t=="updateUser"||t=="botUpdate"||t=="updateBot"){if(this.base.isOpenlinesRecent()){return false}this.base.updateElement(s.user.id,this.getFormattedElement({id:s.user.id,user:s.user}))}else if(t=="userInvite"){if(this.base.isOpenlinesRecent()){return false}let e=this.base.list.findIndex((e=>e&&e.id==s.userId));if(e==-1){let e=ChatDataConverter.getElementByEntity("user",s.user);e.invited=s.invited;this.base.setElement(s.userId,e)}else{this.base.updateElement(s.userId,{user:s.user,invited:s.invited})}}else if(t=="generalChatId"){this.base.generalChatId=s.id;ChatDataConverter.generalChatId=this.base.generalChatId;BX.componentParameters.set("IM_GENERAL_CHAT_ID",s.id)}else if(t==="desktopOnline"){BX.postComponentEvent("setDesktopStatus",[{isOnline:true,version:s.version}],"communication")}else if(t==="desktopOffline"){BX.postComponentEvent("setDesktopStatus",[{isOnline:false}],"communication")}else if(this.base.isRecent()){if(t=="notifyAdd"){const e=PageManager.getNavigator().getVisible();const t=e&&e.data&&typeof e.data.DIALOG_ID!=="undefined";const a=s.settingName==="im|like"&&s.originalTag.startsWith("RATING|IM|");if(t&&a){const t=s.originalTag.split("|");const i=t[2];const a=t[3];const n=i==="P"?a:`chat${a}`;const r=n===e.data.DIALOG_ID.toString();if(r){BX.postComponentEvent("chatbackground::task::action",["readNotification","readNotification|"+s.id,{action:"Y",id:s.id}],"background");return}}this.notify.counter=s.counter;this.notify.refresh();this.base.updateCounter(false);let n=s.userName?s.userName:"";let r=n?s.userName.split(" ")[0]:"";let o=n?s.userName.split(" ")[1]:"";if(!s.onlyFlash){const e=ChatUtils.objectClone(s);this.notifyStoredEvents=this.notifyStoredEvents.filter((t=>t.id!==e.id));this.notifyStoredEvents.push(e)}if(i&&i.server_time_ago<=5){const e=ChatMessengerCommon.purifyText(s.text,s.params);this.notifier.show({dialogId:"notify",title:BX.message("IM_LIST_NOTIFICATIONS"),text:(n?n+": ":"")+e,avatar:s.userAvatar?s.userAvatar:""})}}else if(t=="notifyRead"||t=="notifyUnread"||t=="notifyConfirm"){this.notify.counter=s.counter;this.base.updateCounter(false);if(t!="notifyRead"){this.notify.refresh()}}}};RecentList.pull.eventLinesExecute=function(e){let{command:t,params:s,extra:i}=e;if(i.server_time_ago>30){return false}if(this.base.debugLog){console.warn('RecentList.pull.eventLinesExecute: receive "'+t+'"',s)}if(t=="updateSessionStatus"){this.base.updateElement("chat"+s.chatId,{lines:{status:s.status}})}};RecentList.pull.eventOnlineExecute=function(e){let{command:t,params:s,extra:i}=e;if(i.server_time_ago>30){return false}if(this.base.debugLog){console.warn('RecentList.pull.eventOnlineExecute: receive "'+t+'"',s)}if(t=="list"||t=="userStatus"){for(let e in s.users){if(s.users.hasOwnProperty(e)){this.base.updateElement(s.users[e].id,{user:this.getUserDataFormat(s.users[e])})}}}};RecentList.queue={TYPE_ALL:"all",TYPE_ADD:"add",TYPE_UPDATE:"update"};RecentList.queue.init=function(){this.list={};this.list[this.TYPE_ADD]={};this.list[this.TYPE_UPDATE]={};this.updateInterval=1e3;this.updateListInterval=59e3;clearInterval(this.updateIntervalId);this.updateIntervalId=setInterval(this.worker.bind(this),this.updateInterval);clearInterval(this.updateListIntervalId);this.updateListIntervalId=setInterval(this.listWorker.bind(this),this.updateListInterval)};RecentList.queue.add=function(e,t,s){if(e==this.TYPE_ALL){return false}this.list[e][t]=s;return true};RecentList.queue.delete=function(e,t){if(e==this.TYPE_ALL){delete this.list[this.TYPE_ADD][t];delete this.list[this.TYPE_UPDATE][t]}else{delete this.list[e][t]}return true};RecentList.queue.clear=function(){this.list[this.TYPE_ADD]={};this.list[this.TYPE_UPDATE]={};return true};RecentList.queue.worker=function(){let e=new Date;let t=false;let s=[];for(let e in this.list[this.TYPE_ADD]){if(!this.list[this.TYPE_ADD].hasOwnProperty(e)){continue}if(this.base.viewLoaded){s.push(ChatDataConverter.getElementFormat(this.list[this.TYPE_ADD][e]))}t=true;delete this.list[this.TYPE_ADD][e]}if(s.length>0){if(this.base.listEmpty){this.base.listEmpty=false;dialogList.removeItem({"params.id":"empty"});this.base.closeEmptyScreen()}let e=Application.getApiVersion()>=39;dialogList.addItems(s,e)}let i=[];for(let e in this.list[this.TYPE_UPDATE]){if(!this.list[this.TYPE_UPDATE].hasOwnProperty(e)){continue}if(this.base.viewLoaded){i.push({filter:{"params.id":this.list[this.TYPE_UPDATE][e]["id"]},element:ChatDataConverter.getElementFormat(this.list[this.TYPE_UPDATE][e])})}t=true;delete this.list[this.TYPE_UPDATE][e]}if(i.length>0){dialogList.updateItems(i)}if(t){console.info("RecentList.queue.worker: added - "+s.length+" / updated - "+i.length+" ("+(new Date-e)+"ms)",{add:s,update:i});this.base.updateCounter(false);this.cache.update({recent:true})}return true};RecentList.queue.listWorker=function(){let e=new Date;let t=[];for(let e=0,s=this.base.list.length;e<s;e++){if(!this.base.list[e]||!this.base.list[e].runtime){continue}if(this.base.list[e].type!="user"){continue}let s=false;if(this.base.list[e].runtime.status!=ChatDataConverter.getUserImageCode(this.base.list[e])){s=true}if(s){this.add(this.TYPE_UPDATE,this.base.list[e].id,this.base.list[e]);t.push(this.base.list[e].id)}}if(t.length>0){this.cache.update({recent:true})}e=new Date-e;if(t.length>0||e>3e3){console.info("RecentList.queue.listWorker: need updated elements - "+t.length+" ("+e+"ms)",t)}return true};RecentList.queue.destroy=function(){clearInterval(this.updateIntervalId);clearInterval(this.updateListIntervalId);return true};RecentList.notify={};RecentList.notify.init=function(){this.counter=0;this.show=false;BX.addCustomEvent("onNotificationsOpen",this.onNotificationsOpen.bind(this))};RecentList.notify.refresh=function(){BX.postWebEvent("onBeforeNotificationsReload",{});Application.refreshNotifications();return true};RecentList.notify.read=function(e){e=parseInt(e);if(e<=0)return false;BX.rest.callMethod("im.notify.read",{ID:e});return true};RecentList.notify.onNotificationsOpen=function(e){console.info("RecentList.notify: window is open",e);this.counter=0;this.base.updateCounter(false)};RecentList.notifier={};RecentList.notifier.init=function(){include("InAppNotifier");this.inited=typeof InAppNotifier!="undefined";if(this.inited){InAppNotifier.setHandler((e=>{if(e.dialogId){this.base.openDialog(e.dialogId)}}))}this.delayShow={}};RecentList.notifier.show=function(e,t){if(!this.inited||!e.dialogId){return false}clearTimeout(this.delayShow[e.dialogId]);if(t!==false){this.delayShow[e.dialogId]=setTimeout((()=>this.show(e,false)),1500);return true}if(PageManager.getNavigator().isActiveTab()){let t=PageManager.getNavigator().getVisible();if(t.type!="Web"){return false}else if(t.type=="Web"&&t.pageId=="im-"+e.dialogId){return false}}let s={title:ChatUtils.htmlspecialcharsback(e.title),backgroundColor:"#E6000000",message:ChatUtils.htmlspecialcharsback(e.text),data:e};let i=ChatUtils.getAvatar(e.avatar);if(i){s.imageUrl=i}InAppNotifier.showNotification(s);return true};RecentList.promotion={};RecentList.promotion.init=function(){this.promo={"im:video:01042020:mobile":{type:"spotlight",config:{target:"call_video",text:BX.message("IM_PROMO_VIDEO_01042020_MOBILE").split(" #BR# ").join("\n").split("#BR# ").join("\n").split(" #BR#").join("\n").split("#BR#").join("\n")}}};this.promoActive=[]};RecentList.promotion.dialogCheck=function(e){if(!e.startsWith("chat")&&e!==this.base.userId.toString()&&Application.getApiVersion()>=34){this.show("im:video:01042020:mobile")}};RecentList.promotion.showSpotlight=function(e){const t=dialogs.createSpotlight();t.setTarget(e.target);t.setHint({text:e.text});t.show()};RecentList.promotion.show=function(e){if(!this.promo[e]||!this.promoActive.includes(e)){return false}const t=this.promo[e];if(t.type==="spotlight"){this.showSpotlight(t.config)}this.read(e);this.save(e);return true};RecentList.promotion.read=function(e){this.promoActive=this.promoActive.filter((t=>t!==e))};RecentList.promotion.save=function(e){BX.rest.callMethod("im.promotion.read",{id:e})};RecentList.topMenu={};RecentList.topMenu.init=function(){if(!this.base.viewLoaded){return false}if(!this.base.isRecent()){return false}let e=dialogs.createPopupMenu();e.setData([{id:"readAll",title:BX.message("IM_READ_ALL"),sectionCode:"general",iconName:"read"}],[{id:"general"}],((e,t)=>{if(e==="onItemSelected"&&t.id==="readAll"){this.onReadAll()}}));dialogList.setRightButtons([{type:"search",callback:()=>{dialogList.showSearchBar()}},{type:"more",callback:()=>{e.show()}}]);return true};RecentList.topMenu.onReadAll=function(){this.base.clearAllCounters();BX.rest.callMethod("im.dialog.read.all").then((e=>{console.log("im.dialog.read.all result:",e)})).catch((e=>{console.log("im.dialog.read.all error:",e)}))};RecentList.action={};RecentList.action.init=function(){if(!this.base.viewLoaded){return false}if(!this.base.isRecent()){return false}let e={type:"plus",callback:()=>this.chatCreate.open(),icon:"plus",animation:"hide_on_scroll",color:"#60C7EF"};if(typeof dialogList["setFloatingButton"]!=="undefined"){dialogList.setFloatingButton(e)}else{dialogList.setRightButtons([e])}return true};RecentList.action.showPreview=function(e){if(e.params.type==="user"){return"/mobile/users/?user_id="+e.params.id}return""};RecentList.action.pin=function(e,t){let s=this.base.getElement(e,true);t=t===true;this.base.updateElement(e,{pinned:t},true);this.base.blockElement(e,true,((e,t)=>{this.base.updateElement(e,{pinned:t.pinned},true)}),{pinned:s.pinned});BX.rest.callMethod("im.recent.pin",{DIALOG_ID:e,ACTION:t?"Y":"N"}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.read=function(e){let t=this.base.getElement(e,true);if(Application.getApiVersion()<34){this.base.updateElement(e,{counter:0},true)}else{this.base.updateElement(e,{unread:false,counter:0},true)}this.base.updateCounter(false);this.base.blockElement(e,true,((e,t)=>{this.base.updateElement(e,{unread:t.unread,counter:t.counter},true)}),{unread:t.unread,counter:t.counter});ChatRestRequest.abort("read");let s={setReadStatus:["im.recent.unread",{DIALOG_ID:e,ACTION:"N"}]};if(t.counter){s.dialogRead=["im.dialog.read",{DIALOG_ID:e}]}BX.rest.callBatch(s,(s=>{ChatRestRequest.unregister("read");let i=s.setReadStatus.error();let a=t.counter?s.dialogRead.error():false;if(i||a){console.log("Action.read error",s);this.base.unblockElement(e,true)}else{console.log("Action.read result",s);this.base.unblockElement(e)}}),false,(e=>{ChatRestRequest.register("read",e)}));return true};RecentList.action.unread=function(e){let t=this.base.getElement(e,true);if(Application.getApiVersion()<34){this.base.updateElement(e,{counter:1},true)}else{this.base.updateElement(e,{unread:true,counter:t.counter},true)}this.base.updateCounter(false);this.base.blockElement(e,true,((e,t)=>{this.base.updateElement(e,{unread:t.unread,counter:t.counter},true)}),{unread:t.unread,counter:t.counter});BX.rest.callMethod("im.recent.unread",{DIALOG_ID:e,ACTION:"Y"}).then((t=>{console.log("Result action.unread",t);if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.mute=function(e,t){let s=this.base.getElement(e,true);if(s.type!="chat"||s.blocked===true){return false}t=t===true;let i=ChatUtils.objectClone(s.chat.mute_list);i[this.base.userId]=t;this.base.updateElement(e,{chat:{mute_list:i}},true);this.base.blockElement(e,true,((e,t)=>{this.base.updateElement(e,{chat:{mute_list:t.mute_list}},true)}),{mute_list:s.chat.mute_list});BX.rest.callMethod("im.chat.mute",{CHAT_ID:s.chat.id,ACTION:t?"Y":"N"}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.hide=function(e){let t=this.base.getElement(e,true);this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.rest.callMethod("im.recent.hide",{DIALOG_ID:e}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.leave=function(e){let t=this.base.getElement(e,true);this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.rest.callMethod("im.chat.leave",{DIALOG_ID:e}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.inviteResend=function(e){BX.ajax.runAction("intranet.controller.invite.reinvite",{data:{params:{userId:e}}}).then((e=>{InAppNotifier.showNotification({backgroundColor:"#E6000000",message:BX.message("INVITE_RESEND_DONE")})}),(e=>{if(e.status==="error"){InAppNotifier.showNotification({backgroundColor:"#E6000000",message:e.errors.map((e=>e.message)).join(". ")})}else{InAppNotifier.showNotification({backgroundColor:"#E6000000",message:BX.message("IM_LIST_ACTION_ERROR")})}}));return true};RecentList.action.inviteCancel=function(e){let t=this.base.getElement(e,true);this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.ajax.runAction("intranet.controller.invite.deleteinvitation",{data:{params:{userId:e}}}).then((t=>{this.base.unblockElement(e)}),(t=>{if(t.status=="error"){InAppNotifier.showNotification({backgroundColor:"#E6000000",message:t.errors.map((e=>e.message)).join(". ")})}else{InAppNotifier.showNotification({backgroundColor:"#E6000000",message:BX.message("IM_LIST_ACTION_ERROR")})}this.base.unblockElement(e,true)}));return true};RecentList.action.operatorAnswer=function(e){let t=this.base.getElement(e,true);if(t.type!="chat"||t.blocked===true){return false}this.base.updateElement(e,{chat:{owner:this.base.userId},message:{date:new Date,text:BX.message("IMOL_CHAT_ANSWER_"+this.base.userData.gender).replace("#USER#",this.base.userData.name)},counter:0},true);this.base.openDialog(e);this.base.blockElement(e,true,((e,t)=>{this.base.updateElement(e,{chat:{owner:t.owner},message:{date:t.messageDate,text:t.messageText},counter:t.counter},true)}),{owner:t.chat.owner,counter:t.counter,messageDate:t.message.date,messageText:t.message.text});BX.rest.callMethod("imopenlines.operator.answer",{CHAT_ID:t.chat.id}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.operatorSkip=function(e){let t=this.base.getElement(e,true);if(t.type!="chat"||t.blocked===true){return false}this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.rest.callMethod("imopenlines.operator.skip",{CHAT_ID:t.chat.id}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.operatorSpam=function(e){let t=this.base.getElement(e,true);if(t.type!="chat"||t.blocked===true){return false}this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.rest.callMethod("imopenlines.operator.spam",{CHAT_ID:t.chat.id}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.operatorFinish=function(e){let t=this.base.getElement(e,true);if(t.type!="chat"||t.blocked===true){return false}this.base.deleteElement(e);this.base.blockElement(e,true,((e,t)=>{this.base.setElement(e,t,true)}),t);BX.rest.callMethod("imopenlines.operator.finish",{CHAT_ID:t.chat.id}).then((t=>{if(t.data()){this.base.unblockElement(e)}else{this.base.unblockElement(e,true)}})).catch((()=>{this.base.unblockElement(e,true)}));return true};RecentList.action.writing=function(e,t){if(t){RecentList.updateElement(e,{writing:true});ChatTimer.start("writing",e,29500,(e=>{RecentList.updateElement(e,{writing:false})}))}else{ChatTimer.stop("writing",e)}};RecentList.event={};RecentList.event.init=function(){this.debug=false;this.lastSearchList=[];this.handlersList={onItemSelected:this.onItemSelected,onItemAction:this.onItemAction,onRefresh:this.onRefresh,onScrollAtTheTop:this.onScrollAtTheTop,onSearchShow:this.search.onSearchShow,onSearchHide:this.search.onSearchHide,onScopeSelected:this.search.ui.onScopeSelected,onUserTypeText:this.search.ui.onUserTypeText,onSearchItemSelected:this.search.ui.onSearchItemSelected,onScroll:ChatUtils.throttle(this.onScroll,50,this)};this.handlersCustomEventList={onOpenProfile:this.onOpenProfile,onOpenDialog:this.onOpenDialog,onDialogIsOpen:this.onDialogIsOpen,"chatdialog::init::complete":this.onDialogInitComplete,"chatdialog::counter::change":this.onDialogCounterChange,"chatdialog::notification::readAll":this.onNotificationReadAll,"chatbackground::task::status::success":this.onReadMessage,"CallEvents::active":this.callActive,"CallEvents::inactive":this.callInactive};dialogList.setListener(this.router.bind(this));for(let e in this.handlersCustomEventList){BX.addCustomEvent(e,this.handlersCustomEventList[e].bind(this))}};RecentList.event.router=function(e,t){if(this.handlersList[e]){if(e!="onUserTypeText"&&e!="onScroll"){console.log("RecentList.event.router: catch event - "+e,t)}if(e==="onScopeSelected"||e==="onUserTypeText"||e==="onSearchItemSelected"){this.handlersList[e].apply(this.search.ui,[t])}else{this.handlersList[e].apply(this,[t])}}else if(this.debug){console.info("RecentList.event.router: skipped event - "+e,t)}};RecentList.event.onOpenDialog=function(e){return this.base.openDialog(e.dialogId,e.dialogTitleParams)};RecentList.event.onOpenProfile=function(e){return this.base.openUserProfile(e.userId,e.userData)};RecentList.event.onDialogIsOpen=function(e){this.base.updateElement(e.dialogId,{counter:0})};RecentList.event.onDialogInitComplete=function(e){console.info("RecentList.event.onDialogInitComplete: ",e);this.promotion.dialogCheck(e.dialogId.toString())};RecentList.event.onDialogCounterChange=function(e){console.info("RecentList.event.onDialogCounterChange: ",e);this.base.updateElement(e.dialogId,{counter:e.counter})};RecentList.event.onNotificationReadAll=function(e){console.info("RecentList.event.onNotificationReadAll");this.notify.counter=0};RecentList.event.onReadMessage=function(e,t){let s=e.toString().split("|")[0];if(s==="readMessage"){if(t){this.base.updateElement(t.dialogId,{counter:t.counter})}}};RecentList.event.onLoadLastMessage=function(e){if(!this.base.getElement(e.dialogId)){return true}};RecentList.event.onItemSelected=function(e){if(e.params.type=="openSearch"){if(this.base.isRecent()){console.info("RecentList.event.onItemSelected: open search dialog");dialogList.showSearchBar()}}else if(e.params.type=="call"){if(e.params.canJoin){BX.postComponentEvent("CallEvents::joinCall",[e.params.call.id],"calls")}else{this.base.openDialog(e.params.call.associatedEntity.id)}}else{console.info("RecentList.event.onItemSelected: open dialog",e.params.id);this.base.openDialog(e.params.id)}};RecentList.event.onItemAction=function(e){if(e.action.identifier==="hide"){this.action.hide(e.item.params.id)}else if(e.action.identifier==="leave"){this.action.leave(e.item.params.id)}else if(e.action.identifier==="call"){this.base.callUser(e.item.params.id)}else if(e.action.identifier==="pin"){this.action.pin(e.item.params.id,true)}else if(e.action.identifier==="unpin"){this.action.pin(e.item.params.id,false)}else if(e.action.identifier==="unread"){this.action.unread(e.item.params.id)}else if(e.action.identifier==="read"){this.action.read(e.item.params.id)}else if(e.action.identifier==="mute"){this.action.mute(e.item.params.id,true)}else if(e.action.identifier==="unmute"){this.action.mute(e.item.params.id,false)}else if(e.action.identifier==="inviteResend"){this.action.inviteResend(e.item.params.id)}else if(e.action.identifier==="inviteCancel"){this.action.inviteCancel(e.item.params.id)}else if(e.action.identifier==="profile"){this.base.openUserProfile(e.item.params.id)}else if(e.action.identifier==="chatinfo"){PageManager.openPage({url:"/mobile/im/chat.php?chat_id="+e.item.params.id.substr(4)})}else if(e.action.identifier==="operatorAnswer"){this.action.operatorAnswer(e.item.params.id,false)}else if(e.action.identifier==="operatorSkip"){this.action.operatorSkip(e.item.params.id,false)}else if(e.action.identifier==="operatorFinish"){this.action.operatorFinish(e.item.params.id,false)}else if(e.action.identifier==="operatorSpam"){this.action.operatorSpam(e.item.params.id,false)}};RecentList.event.onRefresh=function(){this.base.refresh()};RecentList.event.onScrollAtTheTop=function(){if(typeof dialogList.toggleSearchBar!="function"){return false}dialogList.toggleSearchBar();return true};RecentList.event.onScroll=function(e){if(this.base.isReadyToLoadMore(e)){this.base.isLoadingNextElements=true;this.base.loadMore()}};RecentList.event.callActive=function(e,t){console.log("RecentList: call active",t,e);if(e.associatedEntity.advanced.entityType==="VIDEOCONF"&&e.associatedEntity.advanced.entityData1==="BROADCAST"){t="remote"}this.base.drawCall(ChatDataConverter.getCallListElement(t,e))};RecentList.event.callInactive=function(e){console.log("RecentList: call inactive",e);this.base.removeCall("call"+e)};RecentList.chatCreate={};RecentList.chatCreate.open=function(){if(Application.getApiVersion()<25){dialogList.showSearchBar();return true}let e=this.prepareItems();PageManager.openComponent("JSStackComponent",{componentCode:"im.chat.create",scriptPath:"/mobile/mobile_component/im:im.chat.create/?version="+BX.componentParameters.get("WIDGET_CHAT_CREATE_VERSION","1.0.0"),params:{USER_ID:this.base.userId,SITE_ID:this.base.siteId,LANGUAGE_ID:this.base.languageId,LIST_USERS:e,LIST_DEPARTMENTS:[],SKIP_LIST:[this.base.userId],SEARCH_MIN_SIZE:this.base.searchMinTokenLength,INTRANET_INVITATION_CAN_INVITE:BX.componentParameters.get("INTRANET_INVITATION_CAN_INVITE",false),INTRANET_INVITATION_REGISTER_URL:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_URL",""),INTRANET_INVITATION_ROOT_STRUCTURE_SECTION_ID:BX.componentParameters.get("INTRANET_INVITATION_ROOT_STRUCTURE_SECTION_ID",0),INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM",false),INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM_DISABLE:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_ADMIN_CONFIRM_DISABLE",false),INTRANET_INVITATION_REGISTER_SHARING_MESSAGE:BX.componentParameters.get("INTRANET_INVITATION_REGISTER_SHARING_MESSAGE",""),INTRANET_INVITATION_IS_ADMIN:BX.componentParameters.get("INTRANET_INVITATION_IS_ADMIN",false)},rootWidget:{name:"chat.create",settings:{objectName:"ChatCreateInterface",title:BX.message("WIDGET_CHAT_CREATE_TITLE"),items:e.map((e=>ChatDataConverter.getListElementByUser(e))),scopes:[{title:BX.message("IM_SCOPE_USERS"),id:ChatSearchScopes.TYPE_USER},{title:BX.message("IM_SCOPE_DEPARTMENTS"),id:ChatSearchScopes.TYPE_DEPARTMENT}],backdrop:{shouldResizeContent:true,showOnTop:true,topPosition:100},supportInvites:BX.componentParameters.get("INTRANET_INVITATION_CAN_INVITE",false)&&Application.getApiVersion()>=34}}})};RecentList.chatCreate.prepareItems=function(){let e=[];let t={};if(this.base.list.length>0){this.base.list.map((s=>{if(!s||t[s.id]){return false}if(s.type=="user"){e.push(s.user);t[s.id]=true}return true}))}this.base.colleaguesList.map((s=>{if(!s||t[s.id]){return false}e.push(s)}));return e};RecentList.search={};RecentList.search.init=function(){this.selector=null;this.ui=new SelectorDialogListAdapter(dialogList)};RecentList.search.onSearchShow=function(){this.selector=new ChatSelector({context:"IM_CHAT_SEARCH",ui:this.search.ui,providerOptions:{customItems:[this.search.getUserCarouselItem()]}});this.selector.setSingleChoose(true).open();this.selector.onResult=e=>{this.selector.resolve(e);this.search.openChat(e)}};RecentList.search.openChat=function(e){const t=e.id;const s={name:e.name,avatar:e.avatar,description:e.description};if(e.customData["imChat"]){s.chatType=e.customData["imChat"].TYPE;if(e.customData["imChat"].TYPE==="open"){s.description=BX.message("MOBILE_EXT_CHAT_SELECTOR_CHANNEL_SUBTITLE")}else{s.description=BX.message("MOBILE_EXT_CHAT_SELECTOR_GROUP_SUBTITLE")}}this.base.openDialog(t,s)};RecentList.search.getUserCarouselItem=function(){let e=[];let t={};if(this.base.list.length>0){this.base.list.map((s=>{if(!s){return false}if(s.type==="user"){let i=ChatDataConverter.getSearchElementFormat(s,true);i=this.getChatProviderItem(i);e.push(i);t[s.id]=true}return true}))}this.base.colleaguesList.map((s=>{if(!s||t[s.id]){return false}let i=ChatDataConverter.getSearchElementFormat(s);i=this.getChatProviderItem(i);e.push(i);return true}));e=e.filter((e=>e.userId!=this.base.userId)).sort(((e,t)=>{if(e.message&&e.message.date&&t.message&&t.message.date){return t.message.date-e.message.date}return 0}));return{type:"carousel",sectionCode:"custom",childItems:e,hideBottomLine:true}};RecentList.search.getChatProviderItem=function(e){e.title=e.shortTitle;e.userId=e.id;e.id="custom/"+e.id;e.type="info";return e};RecentList.search.onSearchHide=function(){};RecentList.init();
//# sourceMappingURL=component.map.js