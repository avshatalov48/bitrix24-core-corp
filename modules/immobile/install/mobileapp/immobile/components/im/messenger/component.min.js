var REVISION=19;BX.message.LIMIT_ONLINE=BX.componentParameters.get("LIMIT_ONLINE",1380);if(typeof window.Messenger!=="undefined"&&typeof window.Messenger.destructor!=="undefined"){window.Messenger.destructor()}(()=>{const{Type:e}=jn.require("type");const{Loc:t}=jn.require("loc");const{createStore:s}=jn.require("statemanager/vuex");const{VuexManager:n}=jn.require("statemanager/vuex-manager");const{RestManager:i}=jn.require("im/messenger/lib/rest-manager");const{applicationModel:r,recentModel:o,messagesModel:a,usersModel:l,dialoguesModel:c,filesModel:h}=jn.require("im/messenger/model");const{MessagesCache:d,RecentCache:g,UsersCache:u}=jn.require("im/messenger/cache");const{MessagePullHandler:m,DialogPullHandler:p,UserPullHandler:f,DesktopPullHandler:E,NotificationPullHandler:v,OnlinePullHandler:C}=jn.require("im/messenger/pull-handler");const{EventType:b,RestMethod:M,FeatureFlag:w}=jn.require("im/messenger/const");const{MessengerEvent:B}=jn.require("im/messenger/lib/event");const{Logger:L}=jn.require("im/messenger/lib/logger");const{SoftLoader:P}=jn.require("im/messenger/lib/helper");const{Recent:S}=jn.require("im/messenger/controller/recent");const{RecentView:T}=jn.require("im/messenger/view/recent");const{Dialog:R}=jn.require("im/messenger/controller/dialog");const{DialogSelector:X}=jn.require("im/messenger/controller/dialog-selector");const{ChatCreator:y}=jn.require("im/messenger/controller/chat-creator");const{Counters:I}=jn.require("im/messenger/lib/counters");const{EntityReady:N}=jn.require("entity-ready");const{Communication:D}=jn.require("im/messenger/lib/integration/mobile/communication");const{Promotion:j}=jn.require("im/messenger/lib/promotion");const{PushHandler:A}=jn.require("im/messenger/push-handler");const{SelectorDialogListAdapter:q}=jn.require("im/chat/selector/adapter/dialog-list");class O{constructor(){if(w.isBetaVersion){L.enable("log")}L.enable("info");L.enable("warn");L.enable("error");this.isReady=false;this.isFirstLoad=true;this.loader=new P({safeDisplayTime:500,onShow:this.showProgress.bind(this),onHide:this.hideProgress.bind(this)});this.refreshTimeout=null;this.refreshAfterErrorInterval=1e4;this.refreshErrorNoticeFlag=false;N.addCondition("chat",(()=>this.isReady));this.store=null;this.storeManager=null;this.recent=null;this.dialog=null;this.dialogSelector=null;this.chatCreator=null;this.communication=new D;this.initStore();this.initCache().then((()=>{this.initRequests();BX.onViewLoaded((()=>{this.initComponents();this.subscribeEvents();this.initPullHandlers();N.wait("im.navigation").then((()=>this.executeStoredPullEvents()));this.refresh()}))}))}initStore(){this.store=s({modules:{applicationModel:r,recentModel:o,messagesModel:a,usersModel:l,dialoguesModel:c,filesModel:h}});this.storeManager=new n(this.store).build()}initRequests(){i.on(M.imRevisionGet,{},this.checkRevision.bind(this))}initComponents(){this.recent=new S({view:new T});this.dialog=new R;this.dialogSelector=new X({view:new q(dialogList)});this.chatCreator=new y}subscribeEvents(){this.subscribeMessengerEvents();this.subscribeExternalEvents()}subscribeMessengerEvents(){BX.addCustomEvent(b.messenger.openDialog,this.openDialog.bind(this));BX.addCustomEvent(b.messenger.openLine,this.openLine.bind(this));BX.addCustomEvent(b.messenger.getOpenDialogParams,this.getOpenDialogParams.bind(this));BX.addCustomEvent(b.messenger.getOpenLineParams,this.getOpenLineParams.bind(this));BX.addCustomEvent(b.messenger.joinCall,this.joinCall.bind(this));BX.addCustomEvent(b.messenger.showSearch,this.openChatSearch.bind(this));BX.addCustomEvent(b.messenger.createChat,this.openChatCreate.bind(this));BX.addCustomEvent(b.messenger.openNotifications,this.openNotifications.bind(this));BX.addCustomEvent(b.messenger.refresh,this.refresh.bind(this))}subscribeExternalEvents(){BX.addCustomEvent(b.chatDialog.initComplete,this.onChatDialogInitComplete.bind(this));BX.addCustomEvent(b.chatDialog.counterChange,this.onChatDialogCounterChange.bind(this));BX.addCustomEvent(b.chatDialog.accessError,this.onChatDialogAccessError.bind(this));BX.addCustomEvent(b.chatDialog.taskStatusSuccess,this.onTaskStatusSuccess.bind(this));BX.addCustomEvent(b.call.active,this.onCallActive.bind(this));BX.addCustomEvent(b.call.inactive,this.onCallInactive.bind(this));BX.addCustomEvent(b.notification.open,this.onNotificationOpen.bind(this));BX.addCustomEvent(b.notification.reload,this.onNotificationReload.bind(this));BX.addCustomEvent(b.app.activeBefore,this.onAppActiveBefore.bind(this));BX.addCustomEvent(b.app.paused,this.onAppPaused.bind(this));BX.addCustomEvent(b.app.active,this.onAppActive.bind(this));BX.addCustomEvent(b.app.failRestoreConnection,this.refresh.bind(this))}initPullHandlers(){BX.PULL.subscribe(new m);BX.PULL.subscribe(new p);BX.PULL.subscribe(new f);BX.PULL.subscribe(new E);BX.PULL.subscribe(new v);BX.PULL.subscribe(new C)}executeStoredPullEvents(){A.updateList();A.executeAction()}onAppActiveBefore(){BX.onViewLoaded((()=>{A.updateList();this.refresh()}))}onAppActive(){BX.onViewLoaded((()=>{A.executeAction()}))}onAppPaused(){A.clearHistory()}refresh(){this.loader.show();i.callBatch().then((e=>this.afterRefresh(e))).catch((e=>this.afterRefreshError(e)))}afterRefresh(e){this.loader.hide();this.refreshErrorNoticeFlag=false;ChatTimer.stop("recent","error",true);I.update();this.ready()}afterRefreshError(e){const s=Object.keys(e)[0];if(s){const t=e[s].error();if(t.ex.error==="REQUEST_CANCELED"){L.error("Messenger.afterRefreshError",t.ex);return}}const n=this.refreshAfterErrorInterval/1e3;L.error("Messenger: refresh error. Try again in "+n+" seconds.");clearTimeout(this.refreshTimeout);this.refreshTimeout=setTimeout((()=>{if(!this.refreshErrorNoticeFlag&&!Application.isBackground()){const e=()=>{this.refreshErrorNoticeFlag=true;InAppNotifier.showNotification({message:t.getMessage("IMMOBILE_MESSENGER_REFRESH_ERROR"),backgroundColor:"#E6000000",time:this.refreshAfterErrorInterval/1e3-2})};ChatTimer.start("recent","error",2e3,e)}L.warn("Messenger.refresh after error");this.refresh()}),this.refreshAfterErrorInterval)}ready(){this.isReady=true;if(this.isFirstLoad){L.warn("Messenger.ready");N.ready("chat")}this.isFirstLoad=false;new B(b.messenger.afterRefreshSuccess).send()}openDialog(e){L.info("EventType.messenger.openDialog",e);this.dialog.open(e)}openLine(e){L.info("EventType.messenger.openLine",e);this.dialog.openLine(e)}joinCall(e){L.info("EventType.messenger.joinCall",e);const{callId:t}=e;BX.postComponentEvent(b.call.join,[t],"calls")}openNotifications(){if(!PageManager.getNavigator().isActiveTab()){PageManager.getNavigator().makeTabActive()}BX.postComponentEvent("onTabChange",["notifications"],"im.navigation")}openChatSearch(){L.log("EventType.messenger.showSearch");this.dialogSelector.open()}openChatCreate(){L.log("EventType.messenger.createChat");this.chatCreator.open()}onNotificationOpen(){L.log("EventType.notification.open");I.notificationCounter.reset();I.update()}onNotificationReload(){L.log("EventType.notification.reload");BX.postWebEvent("onBeforeNotificationsReload",{});Application.refreshNotifications()}onCallActive(e,t){L.log("EventType.call.active");this.recent.addCall(e,t)}onCallInactive(e){L.log("EventType.call.inactive");this.recent.removeCallById(e)}onTaskStatusSuccess(e,t){L.log("EventType.chatDialog.taskStatusSuccess",e,t)}getOpenDialogParams(e={}){const t=b.messenger.openDialogParams+"::"+e.dialogId;const s=R.getOpenDialogParams(e);BX.postComponentEvent(t,[s])}getOpenLineParams(e={}){const t=b.messenger.openLineParams+"::"+e.userCode;R.getOpenLineParams(e).then((e=>{BX.postComponentEvent(t,[e])}))}onChatDialogInitComplete(e){L.log("EventType.chatDialog.initComplete",e);j.checkDialog(e.dialogId.toString())}onChatDialogCounterChange(e){L.log("EventType.chatDialog.counterChange",e);const t=ChatUtils.objectClone(MessengerStore.getters["recentModel/getById"](e.dialogId));if(!t){return}t.counter=e.counter;MessengerStore.dispatch("recentModel/set",[t])}onChatDialogAccessError(){L.warn("EventType.chatDialog.accessError");this.dialog.deleteCurrentDialog()}showProgress(){dialogList.setTitle({text:t.getMessage("COMPONENT_TITLE"),useProgress:true,largeMode:true})}hideProgress(){dialogList.setTitle({text:t.getMessage("COMPONENT_TITLE"),useProgress:false,largeMode:true})}initCache(){const e=d.get();const t=g.get();const s=u.get();const n=[];if(t){n.push(this.store.dispatch("recentModel/setState",t))}if(s){n.push(this.store.dispatch("usersModel/setState",s))}if(e){n.push(this.store.dispatch("messagesModel/setState",e))}return Promise.all(n)}checkRevision(t){const s=t.error();if(s){L.error("Messenger.checkRevision",s);return}const n=t.data().mobile;if(!e.isNumber(n)||REVISION>=n){L.warn("Messenger.checkRevision: current",REVISION,"actual",n);return true}L.warn("Messenger.checkRevision: reload scripts because revision up",REVISION," -> ",n);reloadAllScripts();return false}destructor(){BX.listeners={};console.warn("Messenger: Garbage collection after refresh complete")}}window.Messenger=new O;window.MessengerStore=window.Messenger.store;window.MessengerStoreManager=window.Messenger.storeManager})();
//# sourceMappingURL=component.map.js