(function(){const e={incoming:"incoming",startCall:"startcall"};const t={INCOMING:"INCOMING",FINISHED:"FINISHED",STARTED:"STARTED",OUTGOING:"OUTGOING",WAITING:"WAITING",CALLBACK:"CALLBACK"};const i={onHangup:"onHangupCallClicked",onSpeakerphoneChanged:"onSpeakerphoneCallClicked",onMuteChanged:"onMuteCallClicked",onPauseChanged:"onPauseCallClicked",onNumpadClicked:"onNumpadClicked",onFormFolded:"onFoldCallClicked",onFormExpanded:"onUnfoldIconClicked",onCloseClicked:"onCloseCallClicked",onSkipClicked:"onSkipCallClicked",onAnswerClicked:"onAnswerCallClicked",onNumpadClosed:"onNumpadClosed",onNumpadButtonClicked:"onNumpadButtonClicked",onPhoneNumberReceived:"onPhoneNumberReceived",onContactListChoose:"onContactListChoose",onContactListMenuChoose:"onContactListMenuChoose"};const l=30;const s="mobile/crm/#ENTITY#/?page=view&#ENTITY#_id=#ID#";const a=["lead","contact","company","deal"];const n=()=>{try{const{inAppUrl:e}=jn.require("in-app-url");return e}catch(e){console.log(e,"In-app-url not found");return null}};function o(e){const t=(new Date).getTime();return Math.round(Math.abs(t-e)/1e3)}function r(e){if(typeof e!=="object"||typeof e.params==="undefined"){return{ACTION:"NONE"}}let t={};try{t=JSON.parse(e.params)}catch(i){t={ACTION:e.params}}return t}function h(e,t){e=e.toLowerCase();if(a.indexOf(e)===-1){return""}return currentDomain+BX.componentParameters.get("siteDir","/")+s.replace(/#ENTITY#/g,e).replace(/#ID#/g,t)}function c(e){e=e.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replaceAll(/&#(\d+);/g,((e,t)=>String.fromCharCode(t)));return e}include("Calls");if(Application.getApiVersion()>=36&&typeof media=="undefined"){include("media")}class d{constructor(){this.ui=new VoiceCallForm({eventListener:this.onUiEvent.bind(this)});this.userId=parseInt(BX.componentParameters.get("userId",0));Object.defineProperties(this,{isAdmin:{get:()=>BX.componentParameters.get("isAdmin",false)},voximplantInstalled:{get:()=>BX.componentParameters.get("voximplantInstalled",false)},canPerformCalls:{get:()=>BX.componentParameters.get("canPerformCalls",false)},lines:{get:()=>BX.componentParameters.get("lines",{}),set:e=>BX.componentParameters.set("lines",e)},defaultLineId:{get:()=>BX.componentParameters.get("defaultLineId",""),set:e=>BX.componentParameters.set("defaultLineId",e)}});this._callId=null;Object.defineProperty(this,"callId",{get:()=>this._callId,set:e=>{if(this._callId!=e){this._callId=e;BX.postComponentEvent("CallEvents::hasActiveTelephonyCall",[!!this._callId],"communication")}}});this.call=null;this.phoneNumber=null;this.phoneFullNumber=null;this.lineNumber="";this.phoneRinging=0;this.callConfig={};this.callDevice="PHONE";this.crmData={};this.transferUser=0;this.callInit=false;this.callActive=false;this.answered=false;this.debug=true;this.connected=false;this.authorized=false;this.ignoreAnswerSelf=false;this.isIncoming=false;this.isTransfer=false;this.isRestCall=false;this.formShown=false;this.portalCall=false;Object.defineProperty(this,"nativeCall",{get:()=>{if("callservice"in window){const e=callservice.currentCall();return e&&e.params.type==="telephony"?e:null}else{return null}}});this._onNativeCallAnsweredHandler=this._onNativeCallAnswered.bind(this);this._onNativeCallEndedHandler=this._onNativeCallEnded.bind(this);this._onNativeCallMutedHandler=this._onNativeCallMuted.bind(this);this.init()}init(){BX.addCustomEvent("onPhoneTo",this.onPhoneTo.bind(this));BX.addCustomEvent("onNumpadRequestShow",this.onNumpadRequestShow.bind(this));BX.addCustomEvent("onPullEvent-voximplant",this.onPullEvent.bind(this));BX.addCustomEvent("onAppActive",this.onAppActive.bind(this));VIClient.getInstance().on(VIClient.Events.IncomingCall,this._onIncomingCall.bind(this));this._onNativeIncomingCallHandler=this._onNativeIncomingCall.bind(this);if("callservice"in window){callservice.on("incoming",this._onNativeIncomingCallHandler);if(this.nativeCall){setTimeout((()=>this._onNativeIncomingCall(this.nativeCall)),0)}}this.onAppActive()}onAppActive(){let e=r(Application.getLastNotification());if(BX.type.isNotEmptyString(e["ACTION"])&&e["ACTION"].indexOf("VI_CALL_")===0){this.log("Starting application from push",e);let t=e.PARAMS||{};if(t.callId){t.autoAnswer=true;this._onCallInvite(t)}}}onPhoneTo(e){this.log("onPhoneTo",e);let t=e.number;let i=e.params;i=i||{};if(typeof i!="object"){try{i=JSON.parse(i)}catch(e){i={}}}if(this.canUseTelephony()){this.phoneCall(t,i)}}onNumpadRequestShow(){this.log("onNumpadRequestShow");if(Application.getApiVersion()>=22){if(this.canUseTelephony()){this.ui.showNumpad()}}}canUseTelephony(){return this.voximplantInstalled&&this.canPerformCalls}onUiEvent(e){this.log("onUiEvent: ",e);let t=e.eventName;let l={[i.onHangup]:this._onUiHangup,[i.onSpeakerphoneChanged]:this._onUiSpeakerphoneChanged,[i.onMuteChanged]:this._onUiMuteChanged,[i.onPauseChanged]:this._onUiPauseChanged,[i.onCloseClicked]:this._onUiCloseClicked,[i.onSkipClicked]:this._onUiSkipClicked,[i.onAnswerClicked]:this._onUiAnswerClicked,[i.onNumpadButtonClicked]:this._onUiNumpadButtonClicked,[i.onPhoneNumberReceived]:this._onUiPhoneNumberReceived};if(BX.type.isFunction(l[t])){l[t].call(this,e)}else if(t.substr(0,4)=="crm_"){let e=t.split("_");this._onUiCrmLinkClick({entityType:e[1],entityId:e[2]})}}onPullEvent(e,t,i){this.log("onPullEvent-voximplant",e,t,i);let l={invite:this._onPullEventInvite.bind(this),answer_self:this._onPullEventAnswerSelf.bind(this),timeout:this._onPullEventTimeout.bind(this),outgoing:this._onPullEventOutgoing.bind(this),start:this._onPullEventStart.bind(this),hold:this._onPullEventHold.bind(this),unhold:this._onPullEventUnHold.bind(this),updatePortalUser:this._onPullEventUpdatePortalUser.bind(this),update_crm:this._onPullEventUpdateCrm.bind(this),completeTransfer:this._onPullEventCompleteTransfer,changeDefaultLineId:this._onPullEventChangeDefaultLineId.bind(this),replaceCallerId:this._onPullEventReplaceCallerId.bind(this)};if(BX.type.isFunction(l[e])){l[e](t,i)}}requestMicrophoneAccess(){return new Promise(((e,t)=>{MediaDevices.requestMicrophoneAccess().then((()=>e())).catch((({justDenied:e})=>t(new DeviceAccessError(e))))}))}answerCall(){if(this.answered){return}this.answered=true;this.setUiState(t.WAITING);this.setUiStateLabel(BX.message("IM_M_CALL_ST_CONNECT"));C.sendAnswer(this.callId).catch((e=>{let i=e.answer;this.log("voximplant.call.answer error: ",i);if(!this.callInit&&!this.callActive){return}this.setUiState(t.FINISHED);this.ui.stopSound();if(i.error==="ERROR_NOT_FOUND"){this.setUiStateLabel(BX.message("IM_M_CALL_ALREADY_FINISHED"))}else if(i.error==="ERROR_WRONG_STATE"){this.setUiStateLabel(BX.message("IM_M_CALL_ALREADY_ANSWERED"))}else{this.setUiStateLabel(BX.message("IM_PHONE_ERROR"))}})).then((()=>VIClientWrapper.getClient())).then((()=>{CallUtil.log("voximplant.call.sendReady");BX.rest.callMethod("voximplant.call.sendReady",{CALL_ID:this.callId})}))}phoneCall(i,l){if(!this.canUseTelephony()){return false}if(!CallUtil.isDeviceSupported()){navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"));return}this.log("phoneCall",i,l);if(typeof fabric==="object"){fabric.Answers.sendCustomEvent("outgoingCallTelephony",{})}let s=this.phoneCorrect(i);if(!BX.type.isPlainObject(l)){l={}}if(s.length<=0){this.log("Wrong number");return false}if(this.callActive||this.callInit){return false}this.ui.playSound({soundId:e.startCall});if(this.isRestLine(this.defaultLineId)){this.startCallViaRest(i,this.defaultLineId,l);return}this.callInit=true;this.callActive=false;this.phoneNumber=s;this.phoneFullNumber=s;this.phoneParams=l;var a=/(\+?\d+)([;#]*)([\d,]*)/.exec(s);if(a){this.phoneNumber=a[1]}if(this.phoneFullNumber!=this.phoneNumber){this.phoneParams["FULL_NUMBER"]=this.phoneFullNumber}this.showCallForm({status:BX.message("IM_M_CALL_ST_CONNECT"),state:t.OUTGOING});this.requestMicrophoneAccess().then((()=>VIClientWrapper.getClient())).then((e=>{this.call=e.call(this.phoneNumber,this.phoneParams);this.call.on(JNVICall.Events.Connected,this._onCallConnected.bind(this));this.call.on(JNVICall.Events.Disconnected,this._onCallDisconnected.bind(this));this.call.on(JNVICall.Events.Failed,this._onCallFailed.bind(this));this.call.on(JNVICall.Events.Ringing,this._onCallProgressToneStart.bind(this));this.call.start()})).catch((e=>{console.error(e);this.setUiState(t.FINISHED);if(e instanceof DeviceAccessError){this.setUiStateLabel(BX.message("IM_PHONE_ERR_NO_MIC"));CallUtil.showDeviceAccessConfirm(false,(()=>Application.openSettings()))}else{this.setUiStateLabel(BX.message("MOBILEAPP_SOME_ERROR"))}this.finishCall()}))}startCallViaRest(e,i,l){let s=this.getRestAppName(i);this.isRestCall=true;this.phoneNumber=e;this.showCallForm({status:BX.message("IM_PHONE_OUTGOING_REST").replace("#APP_NAME#",s),state:t.FINISHED});BX.rest.callMethod("voximplant.call.startViaRest",{NUMBER:e,LINE_ID:i,PARAMS:l}).then((e=>{this.log("voximplant.call.startViaRest: ",e);let t=e.data();if(t.DATA&&t.DATA.CRM){this.setCrmData(t.DATA.CRM)}}))}finishCall(){if(this.call){this.call.hangup();this.call=null}if(this.nativeCall){this.nativeCall.finish()}this.callId=null;this.phoneNumber=null;this.lineNumber="";this.phoneRinging=0;this.callConfig={};this.callDevice="PHONE";this.crmData={};this.transferUser=0;this.callInit=false;this.callActive=false;this.answered=false;this.ignoreAnswerSelf=false;this.isIncoming=false;this.isTransfer=false;this.isRestCall=false;this.portalCall=false;this.ui.pauseTimer()}sendSkip(){if(this.callInit&&this.isIncoming){BX.rest.callMethod("voximplant.call.skip",{CALL_ID:this.callId})}}setCallHold(e){if(!this.call){return false}this.call.sendMessage(JSON.stringify({COMMAND:e?"hold":"unhold"}))}getUiFields(){let e={};let t={};let i={};let l="";if(this.crmData.FOUND=="Y"){let s=this.crmData.CONTACT&&this.crmData.CONTACT.NAME?this.crmData.CONTACT.NAME:"";let a=this.crmData.CONTACT&&this.crmData.CONTACT.PHOTO?this.crmData.CONTACT.PHOTO:"";let n=this.crmData.CONTACT&&this.crmData.CONTACT.POST?this.crmData.CONTACT.POST:"";let o=this.crmData.COMPANY?this.crmData.COMPANY:"";if(!this.portalCall&&!this.isRestCall&&this.callConfig.hasOwnProperty("RECORDING")){if(this.callConfig.RECORDING=="Y"){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_ON"),textColor:"#ecd748"}}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"}}}if(s){e.firstHeader={text:s}}if(n){e.firstSmallHeader={text:n}}if(o){e.secondSmallHeader={text:o}}l="";if(!CallUtil.isAvatarBlank(a)){if(a.startsWith("http")){l=encodeURI(a)}else{l=currentDomain+encodeURI(a)}}if(this.crmData.DEALS&&this.crmData.DEALS.length>0){t={infoTitle:{text:""},infoDesc:{text:this.crmData.DEALS[0].TITLE},infoHeader:{text:this.crmData.DEALS[0].STAGE,textColor:this.crmData.DEALS[0].STAGE_COLOR},infoSum:{text:c(this.crmData.DEALS[0].OPPORTUNITY)}};if(this.crmData.DEAL_URL){i["button1"]={text:BX.message("IM_PHONE_ACTION_T_DEAL"),sort:100,eventName:"crm_deal_"+this.crmData.DEALS[0].ID}}}let r=[];if(this.crmData.COMPANY_DATA&&this.crmData.CONTACT_DATA){r=["CONTACT_DATA","COMPANY_DATA","LEAD_DATA"]}else if(this.crmData.CONTACT_DATA&&this.crmData.LEAD_DATA){r=["CONTACT_DATA","LEAD_DATA"]}else if(this.crmData.LEAD_DATA&&this.crmData.COMPANY_DATA){r=["LEAD_DATA","COMPANY_DATA"]}else{if(this.crmData.CONTACT_DATA){r=["CONTACT_DATA"]}else if(this.crmData.COMPANY_DATA){r=["COMPANY_DATA"]}else if(this.crmData.LEAD_DATA){r=["LEAD_DATA"]}}for(let e=0;e<r.length;e++){let t=r[e];if(this.crmData[t]){if(t=="CONTACT_DATA"){i["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_CONTACT"),sort:200+e,eventName:"crm_contact_"+this.crmData[t].ID}}else if(t=="COMPANY_DATA"){i["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_COMPANY"),sort:200+e,eventName:"crm_company_"+this.crmData[t].ID}}else if(t=="LEAD_DATA"){i["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_LEAD"),sort:200+e,eventName:"crm_lead_"+this.crmData[t].ID}}}}if(this.portalCall){t.imageStub={backgroundColor:"#464f58",display:"visible"}}}else{let i;if(!this.phoneNumber||this.phoneNumber=="hidden"){i=BX.message("IM_PHONE_HIDDEN_NUMBER")}else{i=this.phoneNumber.toString();if(i.substr(0,1)!=="8"&&i.substr(0,1)!=="+"&&!isNaN(parseInt(i))&&i.length>=10){i="+"+i}}e.firstHeader={text:i};e.firstSmallHeader={};if(this.isIncoming){e.firstSmallHeader.text=this.lineNumber?BX.message("IM_PHONE_CALL_TO_PHONE").replace("#PHONE#",this.lineNumber):BX.message("IM_VI_CALL")}else{e.firstSmallHeader.text=BX.message("IM_PHONE_OUTGOING")}e.firstSmallHeader.textColor="#999999";if(!this.portalCall&&!this.isRestCall&&this.callConfig.hasOwnProperty("RECORDING")){if(this.callConfig.RECORDING=="Y"){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_ON"),textColor:"#ecd748"}}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"}}}t.imageStub={backgroundColor:"#464f58",display:"visible"}}return{headerLabels:e,middleLabels:t,middleButtons:i,avatarUrl:l}}showCallForm(e){let t=this.getUiFields();if(e.status){t.footerLabels={callStateLabel:{text:e.status}}}if(e.state){t.state=e.state}this.log("callFormParams: ",t);this.ui.show(t);this.formShown=true;device.setProximitySensorEnabled(true);device.setIdleTimerDisabled(true)}updateCallForm(){if(!this.formShown){return false}let{headerLabels:e,middleLabels:t,middleButtons:i,avatarUrl:l}=this.getUiFields();this.ui.updateHeader({headerLabels:e,avatarUrl:l});this.ui.updateMiddle({middleLabels:t,middleButtons:i})}closeCallForm(){this.ui.closeNumpad();this.ui.close();this.formShown=false;device.setProximitySensorEnabled(false);device.setIdleTimerDisabled(false)}setCrmData(e){if(!BX.type.isPlainObject(e)){e={FOUND:"N"}}this.crmData=e;if(this.crmData.FOUND==="Y"){this.updateCallForm()}}setUiStateLabel(e){if(this.formShown){this.ui.updateFooter({footerLabels:{callStateLabel:{text:e}}})}}setUiState(e){if(this.formShown){this.ui.updateFooter({state:e})}}setProgress(e){if(e=="connect"){}else if(e=="wait"){this.setUiState(t.WAITING)}else if(e=="online"){if(!this.portalCall&&this.callConfig.hasOwnProperty("RECORDING")){let e={};if(this.callConfig.RECORDING=="Y"){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_NOW"),textColor:"#7fc62c"}}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"}}this.ui.updateHeader({headerLabels:e})}this.setUiState(t.STARTED)}else if(e=="offline"||e=="error"){if(e=="offline"){if(!this.portalCall){let e={};if(this.callConfig.RECORDING=="Y"&&this.phoneCallTime>0){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_DONE"),textColor:"#7fc62c"}}else{e.thirdSmallHeader={text:""}}this.ui.updateHeader({headerLabels:e});let t={};if(this.crmData.LEAD_DATA&&!this.crmData.CONTACT_DATA&&!this.crmData.COMPANY_DATA&&this.callConfig.CRM_CREATE=="lead"){t.actionDoneHint={text:BX.message("IM_PHONE_LEAD_SAVED")}}else{t.actionDoneHint={text:""}}this.ui.updateFooter({footerLabels:t})}}else{let e={};e.thirdSmallHeader={text:""};this.ui.updateHeader({headerLabels:e});let t={};t.actionDoneHint={text:""};this.ui.updateFooter({footerLabels:t})}this.setUiState(t.FINISHED);if(this.formShown){this.ui.expand()}}}toggleMute(e){if(!this.call){return}this.call.sendAudio=!e}isRestLine(e){return this.lines.hasOwnProperty(e)&&this.lines[e]["TYPE"]==="REST"}getRestAppName(e){if(!this.lines.hasOwnProperty(e)){return""}if(this.lines[e]["TYPE"]!=="REST"){return""}let t=this.lines[e]["FULL_NAME"];return t.substr(t.indexOf(":")+2)}_onNativeIncomingCall(e){if(e.params.type!=="telephony"){return}let t=e.params.ts;let i=(new Date).getTime()/1e3-t;if(i>15){CallUtil.error("Call originated too long time ago")}this._onCallInvite(e.params);this._bindNativeCallEvents(e);if(Application.isBackground()){CallUtil.log("Application in background, starting p&p");CallUtil.forceBackgroundConnectPull(15).then((()=>{CallUtil.log("p&p connected")})).catch((e=>{CallUtil.error(e)}))}else{CallUtil.log("Received native call in foreground",e.params)}}_bindNativeCallEvents(e){e.on("answered",this._onNativeCallAnsweredHandler).on("ended",this._onNativeCallEndedHandler).on("muted",this._onNativeCallMutedHandler)}_onIncomingCall(e){this.log("_onIncomingCall",e);if(this.call){this.log("call already exists");return}if(!("on"in e)){this.sendSkip();this.finishCall();navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"))}this.call=e;this.call.on(JNVICall.Events.Connected,this._onCallConnected.bind(this));this.call.on(JNVICall.Events.Disconnected,this._onCallDisconnected.bind(this));this.call.on(JNVICall.Events.Failed,this._onCallFailed.bind(this));this.requestMicrophoneAccess().then((()=>this.call.answer())).catch((e=>{console.error(e);this.setUiState(t.FINISHED);if(e instanceof DeviceAccessError){this.setUiStateLabel(BX.message("IM_PHONE_ERR_NO_MIC"));CallUtil.showDeviceAccessConfirm(false,(()=>Application.openSettings()))}else{this.setUiStateLabel(BX.message("MOBILEAPP_SOME_ERROR"))}this.finishCall()}))}_onConnectionEstablished(e){this.log("_onConnectionEstablished",e);CallUtil.log("_onConnectionEstablished",e);this.connected=true}_onConnectionClosed(e){this.log("_onConnectionClosed",e);this.connected=false;this.authorized=false;if(this.callInit||this.callActive){this.setProgress("error");this.setUiStateLabel(BX.message("IM_M_CALL_ERR"));this.finishCall()}}_onConnectionFailed(e){this.log("_onConnectionFailed",e);this.connected=false;this.authorized=false;if(this.callInit||this.callActive){this.setProgress("error");this.setUiStateLabel(BX.message("IM_M_CALL_ERR"));this.finishCall()}}_onCallConnected(e){this.log("_onCallConnected",e);this.setProgress("online");this.setUiStateLabel(BX.message("IM_M_CALL_ST_ONLINE"));this.callActive=true}_onCallDisconnected(e){this.log("_onCallDisconnected",e);this.finishCall();this.closeCallForm()}_onCallFailed(e){this.log("_onCallFailed",e);let i=BX.message("IM_PHONE_END");if(this.phoneNumber==911||this.phoneNumber==112){i=BX.message("IM_PHONE_NO_EMERGENCY")}else if(e.code==603){i=BX.message("IM_PHONE_DECLINE")}else if(e.code==380){i=BX.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){i=BX.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){i=BX.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){i=BX.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){i=BX.message("IM_PHONE_401")}else if(e.code==480||e.code==503){i=BX.message("IM_PHONE_UNAVAILABLE")}else if(e.code==484||e.code==404){i=BX.message("IM_PHONE_INCOMPLETED")}else if(e.code==402){i=BX.message("IM_PHONE_NO_MONEY")+(this.isAdmin?" "+BX.message("IM_PHONE_PAY_URL_NEW"):"")}else if(e.code==486&&this.phoneRinging>1){i=BX.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){i=BX.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){i=BX.message("IM_PHONE_403")}this.finishCall();this.setUiState(t.FINISHED);this.setUiStateLabel(i)}_onCallProgressToneStart(e){this.log("_onCallProgressToneStart",e);this.phoneRinging++;this.setUiState(t.WAITING);this.setUiStateLabel(BX.message("IM_PHONE_WAIT_ANSWER"))}_onCallProgressToneStop(e){this.log("_onCallProgressToneStop",e)}_onUiHangup(e){this.ui.cancelDelayedClosing();this.finishCall();this.closeCallForm()}_onUiSpeakerphoneChanged(e){let t=e.params;let i=t.selected;if(!this.call){return false}}_onUiMuteChanged(e){CallUtil.log("_onUiMuteChanged",e);let t=e.params;let i=t.selected;this.toggleMute(i);if(this.nativeCall){this.nativeCall.mute(i)}}_onUiPauseChanged(e){let t=e.params;let i=t.selected;this.setCallHold(i)}_onUiCloseClicked(e){this.finishCall();this.formShown=false}_onUiSkipClicked(e){this.sendSkip();this.finishCall();this.closeCallForm()}_onUiAnswerClicked(){this.ignoreAnswerSelf=true;this.ui.stopSound();this.answerCall();if(this.nativeCall){this.nativeCall.answer()}}_onUiNumpadButtonClicked(e){let t=e.params;if(this.call){this.call.sendDTMF(t)}}_onUiPhoneNumberReceived(e){if(Application.getApiVersion()>=22){var t=e.params;this.phoneCall(t)}}_onUiCrmLinkClick(e){let t=e.entityType;let i=e.entityId;let l=h(t,i);if(!l){return}if(Application.getApiVersion()>=45){if(typeof BX.MobileTools!=="undefined"){const e=BX.MobileTools.resolveOpenFunction(l);if(e){e()}}else{const e=n();if(e){e.open(`/crm/${t}/details/${i}/`,{canOpenInDefault:true,bx24ModernStyle:true},(()=>{this._onOpenPage(l)}))}}}else{this._onOpenPage(l)}this.ui.rollUp()}_onOpenPage(e){PageManager.openPage({url:e,bx24ModernStyle:true})}_onNativeCallAnswered(e){CallUtil.log("onNativeCallAnswered");this.ignoreAnswerSelf=true;this.ui.stopSound();this.answerCall()}_onNativeCallEnded(e){CallUtil.log("onNativeCallEnded");if(e){setTimeout((()=>e.fullfill()),500)}if(!this.callId){return}if(this.callActive){this._onUiHangup()}else if(this.callInit){this._onUiSkipClicked()}}_onNativeCallMuted(e){CallUtil.log("onNativeCallMuted ",e);this.toggleMute(e);if(this.ui.setUiMicEnabled){this.ui.setUiMicEnabled(e)}}_onCallInvite(i){this.log("_onCallInvite",i);if(!CallUtil.isDeviceSupported()){navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"));return}if(typeof fabric==="object"){fabric.Answers.sendCustomEvent("incomingCallTelephony",{})}if(this.callInit||this.callActive){return false}this.crmData=i.CRM&&i.CRM.FOUND?i.CRM:{};this.portalCall=i.portalCall===true;if(this.portalCall&&i.portalCallData){i.phoneNumber="";if(i.portalCallUserId){this.crmData.FOUND="Y";this.crmData.CONTACT={NAME:i.portalCallData.users[i.portalCallUserId].name,PHOTO:i.portalCallData.users[i.portalCallUserId].avatar}}else{}}this.callConfig=i.config?i.config:{};this.phoneCallTime=0;if(!this.nativeCall){this.ui.playSound({soundId:e.incoming})}i.isCallback=!!i.isCallback;i.isTransfer=!!i.isTransfer;this.phoneNumberUser=i.callerId;i.callerId=i.callerId.replace(/[^a-zA-Z0-9\.]/g,"");this.callInit=true;this.callActive=false;this.isIncoming=true;this.phoneCallTime=0;this.callId=i.callId;this.phoneNumber=i.callerId;this.phoneParams={};this.isTransfer=i.isTransfer;this.lineNumber=i.companyPhoneNumber;CallUtil.log("this.showCallForm");this.showCallForm({status:BX.message("IM_PHONE_INITIALIZATION"),state:t.OUTGOING});BX.rest.callMethod("voximplant.call.sendWait",{CALL_ID:i.callId,DEBUG_INFO:this.getDebugInfo()}).then((e=>{let l=e.data();this.log("voximplant.call.sendWait data:",l);if(!this.callInit&&!this.callActive){return}if(l.SUCCESS){this.setUiState(t.INCOMING);this.setUiStateLabel(i.isCallback?BX.message("IM_PHONE_INVITE_CALLBACK"):BX.message("IM_PHONE_INVITE"));if(i.autoAnswer){this._onUiAnswerClicked()}}else{this.setUiState(t.FINISHED);this.setUiStateLabel(BX.message("IM_PHONE_ERROR"));this.ui.stopSound()}})).catch((e=>{let i=e.answer;this.log("voximplant.call.sendWait"+" error: ",i);if(!this.callInit&&!this.callActive){return}this.setUiState(t.FINISHED);this.ui.stopSound();if(i.error==="ERROR_NOT_FOUND"){this.setUiStateLabel(BX.message("IM_M_CALL_ALREADY_FINISHED"))}else if(i.error==="ERROR_WRONG_STATE"){this.setUiStateLabel(BX.message("IM_M_CALL_ALREADY_ANSWERED"))}else{this.setUiStateLabel(BX.message("IM_PHONE_ERROR"))}}))}_onPullEventInvite(e,t){if(t.server_time_ago>=l){this.log("Call was started too long time ago");return}if(this.callInit||this.callActive){return false}this._onCallInvite(e)}_onPullEventAnswerSelf(e){if(this.ignoreAnswerSelf||this.callId!=e.callId){return false}this.finishCall();this.ui.stopSound();this.closeCallForm();this.callInit=true;this.callId=e.callId}_onPullEventTimeout(e){if(this.callId!=e.callId){return false}this.ui.stopSound();this.closeCallForm();this.finishCall()}_onPullEventOutgoing(e,t){if(t.server_time_ago>=l){this.log("Call was started too long time ago");return}this.portalCall=e.portalCall===true;if(this.callInit&&this.phoneNumber==e.phoneNumber){if(!this.callId){this.setProgress("connect");this.setUiStateLabel(BX.message("IM_PHONE_WAIT_ANSWER"));this.callConfig=e.config||{};this.callId=e.callId;this.phoneCallTime=0;this.setCrmData(e.CRM)}if(this.portalCall){if(e.portalCallUserId){this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallData.users[e.portalCallUserId].name,PHOTO:e.portalCallData.users[e.portalCallUserId].avatar}})}else{this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallQueueName}})}}}}_onPullEventStart(e){if(this.callId!=e.callId){return false}this.ui.startTimer();this.ui.stopSound();this.callActive=true;if(e.CRM){this.setCrmData(e.CRM)}}_onPullEventHold(e){if(this.callId==e.callId){this.phoneHolded=true}}_onPullEventUnHold(e){this.phoneHolded=false}_onPullEventUpdatePortalUser(e){if(this.callId==e.callId&&e.portalCallUserId){this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallData.users[e.portalCallUserId].name,PHOTO:e.portalCallData.users[e.portalCallUserId].avatar}})}}_onPullEventUpdateCrm(e){if(this.callId==e.callId&&e.CRM){this.setCrmData(e.CRM)}}_onPullEventCompleteTransfer(e){if(this.callId!=e.callId){return false}this.callId=e.newCallId;this.isTransfer=false}_onPullEventPhoneDeviceActive(e){}_onPullEventChangeDefaultLineId(e){this.defaultLineId=e.defaultLineId;if(!this.lines.hasOwnProperty(this.defaultLineId)){this.lines[this.defaultLineId]=e.line}}_onPullEventReplaceCallerId(e){let t=BX.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",e.callerId);this.setCallOverlayTitle(t);if(e.CRM){this.setCrmData(e.CRM)}}getDebugInfo(){return{isMobile:"Y",callInit:this.callInit?"Y":"N",callActive:this.callActive?"Y":"N",appVersion:Application.getAppVersion(),apiVersion:Application.getApiVersion(),buildVersion:Application.getBuildVersion()}}phoneCorrect(e){return e.toString().replace(/[^0-9+#*;,]/g,"")}log(){if(this.debug){console.log.apply(null,arguments)}}logged(e){let t=this;return function(){let i=[e.name].concat(arguments);console.log.apply(null,i);e.apply(t,arguments)}}}class C{static sendAnswer(e){return new Promise(((t,i)=>{BX.rest.callMethod("voximplant.call.answer",{CALL_ID:e}).then(t).catch(i)}))}}if("callEngine"in window){}window.CallUtil=new CCallUtil;window.callEngine=new CallEngine;window.callController=new CallController;window.mtelephony=new d;window.TelephonyUiState=t;console.log("Telephony initialized")})();
//# sourceMappingURL=component.map.js