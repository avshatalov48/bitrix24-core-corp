(()=>{const t=t=>jn.require(t);const e=t("apptheme");const{Wizard:r}=t("layout/ui/wizard");const{CrmProductPricesStep:s}=t("catalog/product-wizard-step/crm/prices");const{CatalogProductPhotoStep:o}=t("catalog/product-wizard-step/photo");const{StoreCatalogProductAmountStep:i}=t("catalog/product-wizard-step/store/amount");const{StoreCatalogProductPricesStep:n}=t("catalog/product-wizard-step/store/prices");const{CatalogProductTitleStep:a}=t("catalog/product-wizard-step/title");const{Alert:c}=t("alert");class l extends LayoutComponent{constructor(t){super(t);this.product=this.makeProductEntity();const e=BX.componentParameters.get("entityData",{});Object.keys(e).forEach((t=>{this.product.set(t,e[t])}))}makeProductEntity(){}getSteps(){return[]}getStepForId(t){const e=this.getSteps().find((e=>e.id===t));if(e){return new e.component(this.product,e.options)}}render(){return View({style:{backgroundColor:e.colors.bgSecondary}},new r({parentLayout:layout,steps:this.getSteps().map((t=>t.id)),stepForId:this.getStepForId.bind(this)}))}}class u extends l{makeProductEntity(){return new g(result.iblock)}getSteps(){const t=[];const e=!!result.permissions["catalog_product_edit"];const r=result.permissions["catalog_store"].length>0;t.push({id:"title",component:a,options:{isFinishStep:!e&&!r}});if(e){t.push({id:"photo",component:o});t.push({id:"prices",component:n})}if(r){t.push({id:"amount",component:i})}return t}}class h extends l{makeProductEntity(){return new E(result.iblock)}getSteps(){return[{id:"title",component:a},{id:"photo",component:o},{id:"prices",component:s}]}}class d{static make(t){switch(t){case"crm":return new h;default:return new u}}}class p{constructor(t){this.iblock=t;this.config=null;this.fields=this.getDefaultFields();this.hasUnsavedChanges=false}getContext(){return""}getDefaultFields(){return{IBLOCK_SECTION_ID:0,ID:0,NAME:"",BARCODE:"",MORE_PHOTO:[]}}getTitle(){const t=this.get("NAME");return t&&this.get("ID")?t:BX.message("WIZARD_STEP1_TITLE")}getIblockId(){return this.iblock.ID}getDictionaryValues(t){return this.config&&this.config.dictionaries.hasOwnProperty(t)?this.config.dictionaries[t]:[]}get(t,e=null){return this.fields.hasOwnProperty(t)?this.fields[t]:e}getFields(){return{...this.fields}}set(t,e){this.fields[t]=e;const r=Object.keys(this.getDefaultFields());if(r.includes(t)){this.hasUnsavedChanges=true}}save(t=false){if(!this.hasUnsavedChanges&&this.config){return Promise.resolve()}const e=this.get("ID");const r={NAME:this.get("NAME"),IBLOCK_SECTION_ID:this.get("SECTION_ID"),IBLOCK_ID:this.getIblockId(),...this.prepareOptionalFields(),...this.prepareBasePrice()};if(t){r.MORE_PHOTO=this.prepareMorePhoto()}const s={fields:r};if(e){s.id=e}const o={};if(!this.config){o.config=["catalogmobile.ProductWizard.config",{wizardType:this.getContext()}]}if(this.hasUnsavedChanges){o.save=["catalogmobile.ProductWizard.saveProduct",s]}return new Promise(((t,e)=>{BX.rest.callBatch(o,(r=>{let s=false;const i=this.getErrorFromResponse(r);if(i){this.showError(i);e();s=true}Object.keys(o).forEach((t=>{if(!r[t].answer&&!s){this.showError(BX.message("WIZARD_SAVE_PRODUCT_ERROR"));e();s=true}else if(!s){const o=this.getErrorFromResponse(r[t].answer);if(o){this.showError(o);e();s=true}}}));if(!s){if(!this.config){this.config=r.config.answer.result}if(this.hasUnsavedChanges){const t=r.save.answer.result;this.set("ID",String(t.id));this.synchronizeMorePhotoValue(t.morePhoto);this.hasUnsavedChanges=false}t()}}))}))}prepareOptionalFields(){const t={};const e=["BARCODE","MEASURE_CODE","QUANTITY","VAT_ID"];e.forEach((e=>{const r=this.get(e,null);if(r!==null){t[e]=r}}));const r=this.get("VAT_INCLUDED",null);if(r!==null){t.VAT_INCLUDED=r?"Y":"N"}return t}prepareBasePrice(){const t=this.get("ID");const e=this.get("BASE_PRICE",null);if(e){const r={PRICE:e.amount,CURRENCY:e.currency};return t?{PRICES:{BASE:r}}:r}return{}}prepareMorePhoto(){const t=this.get("MORE_PHOTO",[]);const e=t.filter((t=>t.hasOwnProperty("iblockPropertyValue")));const r=t.filter((t=>!t.hasOwnProperty("iblockPropertyValue")));const s={};e.forEach((t=>{s[t.valueCode]=t.signedFileId}));r.forEach((t=>{s["file"+Math.floor(Math.random()*1e7)]=t}));return s}synchronizeMorePhotoValue(t){t=Array.isArray(t)?t:[];const e=this.get("MORE_PHOTO",[]);let r=0;e.forEach((e=>{if(r<t.length){e.iblockPropertyValue=t[r].iblockPropertyValue;e.fileId=t[r].fileId;e.valueCode=t[r].valueCode;e.signedFileId=t[r].signedFileId;r++}}));this.set("MORE_PHOTO",e)}getErrorFromResponse(t){if(t.error){if(t.error.error_description){return t.error.error_description.replace(/<br>/g,"")}if(t.error.description){return t.error.description.replace(/<br>/g,"")}return BX.message("WIZARD_SAVE_PRODUCT_ERROR")}return null}showError(t){c.alert(BX.message("WIZARD_ERROR_MESSAGE_TITLE"),t)}}class g extends p{getContext(){return"store"}getDefaultFields(){return{IBLOCK_SECTION_ID:0,SECTION_ID:0,ID:0,NAME:"",BARCODE:"",MORE_PHOTO:[],BASE_PRICE:null}}}class E extends p{getContext(){return"crm"}getDefaultFields(){return{IBLOCK_SECTION_ID:0,SECTION_ID:0,ID:0,NAME:"",BARCODE:"",MORE_PHOTO:[],BASE_PRICE:null,MEASURE_CODE:null,QUANTITY:0,VAT_ID:null,VAT_INCLUDED:null}}}BX.onViewLoaded((()=>{const t=BX.componentParameters.get("type","store");layout.enableNavigationBarBorder(false);layout.showComponent(d.make(t))}))})();
//# sourceMappingURL=component.map.js