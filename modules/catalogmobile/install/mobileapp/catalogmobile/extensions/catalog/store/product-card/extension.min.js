jn.define("catalog/store/product-card",((t,e,o)=>{const r=t("apptheme");const{InlineSkuTree:s}=t("layout/ui/product-grid/components/inline-sku-tree");const{isEmpty:n}=t("utils/object");const{ProductCard:i}=t("layout/ui/product-grid/components/product-card");const{StoreProductRow:a}=t("catalog/store/product-list/model");const{CatalogStoreProductDetails:c}=t("catalog/store/product-details");const{StoreDocumentProductContextMenu:l}=t("catalog/store/product-list/menu/product-context-menu");const{StoreSkuSelector:u}=t("catalog/store/sku-selector");const{DocumentType:d}=t("catalog/store/document-type");const{Haptics:p}=t("haptics");class m extends LayoutComponent{constructor(t){super(t);this.productCardRef=null;this.state=this.buildState(t)}buildState(t){return{productRow:t.productRow}}render(){const t=this.props.document?this.props.document.type:"";return View({style:{...h.container.outer,paddingTop:this.props.index===0?12:0}},new i({ref:t=>this.productCardRef=t,index:this.props.index+1,name:this.state.productRow.getProductName(),gallery:this.state.productRow.getPhotos(),renderInnerContent:()=>View({onClick:()=>this.showProductDetailsBackdrop()},View({},this.renderProperties(),this.renderDummyPadding(),View({},...this.renderStoreAmount(),this.renderLineSeparator(),t!=="W"&&this.renderPurchasePrice(),this.renderSellPrice()))),onNameClick:()=>this.showProductDetailsBackdrop(),onImageClick:()=>this.showProductDetailsBackdrop(),onLongClick:()=>this.showProductContextMenu(),onContextMenuClick:()=>this.showProductContextMenu(),onRemove:()=>{if(this.props.document.editable){this.onRemove()}}}))}showProductDetailsBackdrop(){const t=this.state.productRow;const e=t.getRawValues();const o=this.props.document??{};const s=this.props.measures??{};const n=this.props.permissions??{};const i=this.props.catalog??{};PageManager.openWidget("layout",{title:BX.message("CSPL_DETAILS_BACKDROP_TITLE"),modal:true,backdrop:{onlyMediumPosition:false,mediumPositionPercent:80,navigationBarColor:r.colors.bgSecondary,horizontalSwipeAllowed:false,swipeAllowed:true,swipeContentAllowed:false},onReady:r=>{r.showComponent(new c({layout:r,product:e,measures:s,permissions:n,catalog:i,document:o,onChange:e=>{t.setFields(e);this.setState({productRow:t},(()=>{this.blink();this.onChange()}))}}))}})}showProductContextMenu(){p.impactLight();const t=new l({editable:Boolean(this.props.document.editable),onChooseOpen:()=>this.showProductDetailsBackdrop(),onChooseEdit:()=>this.showProductDetailsBackdrop(),onChooseChangeVariation:this.hasVariations()?()=>this.showSkuSelector():null,onChooseRemove:()=>{if(this.props.document.editable){this.onRemove()}}});t.show()}onRemove(){if(this.props.onRemove){this.props.onRemove(this.state.productRow)}}onChange(){if(this.props.onChange){this.props.onChange(this.state.productRow)}}blink(){if(this.productCardRef){this.productCardRef.blink()}}renderProperties(){if(!this.hasVariations()){return null}const t=this.state.productRow.getSkuTree();return View({},new s({...t,editable:this.props.document.editable,onChangeSku:()=>this.showSkuSelector()}))}showSkuSelector(t){const e=this.state.productRow;const o=e.getId();const s={onlyMediumPosition:true,swipeAllowed:true,swipeContentAllowed:false,mediumPositionPercent:80,navigationBarColor:r.colors.bgSecondary};PageManager.openWidget("layout",{backdrop:s}).then((r=>{r.showComponent(new u({layout:r,selectedVariationId:e.getProductId(),currencyId:"RUB",skuTree:e.getSkuTree(),saveButtonCaption:BX.message("CSPL_SELECT_VARIATION_BUTTON"),onWidgetClosed:e=>{this.changeVariation(o,e).then((()=>{if(t.onVariationChanged){t.onVariationChanged()}}))}}))}))}hasVariations(){const t=this.state.productRow.getSkuTree();if(t&&t.OFFERS_PROP&&!n(t.OFFERS_PROP)){return true}return false}changeVariation(t,{variationData:e,skuTree:o}){const r=this.state.productRow;const s=e.ID;const n="catalogmobile.StoreDocumentProduct.loadProductModel";const i=this.props.document.id||null;const a=this.props.document.type||null;const c={data:{productId:s,documentId:i,documentType:a}};Notify.showIndicatorLoading();return new Promise(((e,o)=>{BX.ajax.runAction(n,c).then((o=>{Notify.hideCurrentIndicator();const s=o.data;s.id=t;const n=["amount","storeFromId","storeFrom","storeToId","storeTo"];n.forEach((t=>delete s[t]));r.setFields({...r.getRawValues(),...s});this.setState({productRow:r},(()=>{this.blink();this.onChange()}));e()})).catch((t=>{Notify.hideCurrentIndicator();console.error(t);ErrorNotifier.showError(BX.message("CSPL_UPDATE_TAB_ERROR"))}))}))}renderDummyPadding(){if(!(this.props.permissions.catalog_store_all||this.props.permissions.catalog_store.includes(this.state.productRow.getStoreToId()))&&!this.props.permissions.catalog_purchas_info){return View({style:{height:16}})}return null}renderStoreAmount(){if(!(this.props.permissions.catalog_store_all||this.props.permissions.catalog_store.includes(this.state.productRow.getStoreToId()))){return[]}let t=Number(this.state.productRow.getAmount());if(isNaN(t)){t=0}const e=this.state.productRow.getMeasure();const o=e?e.name:"";return[View({style:h.amount.wrapper},this.renderStoreName(),View({style:{width:"50%",flexDirection:"row",justifyContent:"flex-end"}},Text({text:`${t} `,style:h.amount.value,numberOfLines:1}),Text({text:String(o),style:{...h.amount.value,color:r.colors.base3},numberOfLines:1})))]}renderStoreName(){const t=this.props.document;const e=t?t.type:"";const o=this.state.productRow.getStoreFrom();const r=this.state.productRow.getStoreTo();let s="";if((e===d.Arrival||e===d.StoreAdjustment)&&r){s=r.title?r.title:""}else if((e===d.Deduct||e==="W")&&o){s=o.title?o.title:""}else if(e===d.Moving&&o&&r){const t=o.title?o.title:BX.message("CSPL_STORE_EMPTY");const e=r.title?r.title:BX.message("CSPL_STORE_EMPTY");return View({style:h.summaryRow.storesWrapper},View({onClick:()=>{this.showHint(t)}},Text({text:t,style:h.summaryRow.title,ellipsize:"end",numberOfLines:1})),View({onClick:()=>{this.showHint(e)}},Text({text:e,style:h.summaryRow.title,ellipsize:"end",numberOfLines:1})))}if(s){return View({style:h.summaryRow.leftWrapper,onClick:()=>{this.showHint(s)}},Text({text:s,style:h.summaryRow.title,ellipsize:"end",numberOfLines:1}))}return View({style:h.summaryRow.leftWrapper},Text({text:BX.message("CSPL_STORE_EMPTY"),style:h.summaryRow.title}))}renderLineSeparator(){return View({style:{height:1,width:"100%",backgroundColor:r.colors.bgSeparatorPrimary,marginTop:4,marginBottom:6}})}renderPurchasePrice(){if(!this.props.permissions.catalog_purchas_info){return[]}const t=()=>View({style:h.summaryRow.leftWrapper},Text({text:BX.message("CSPL_PURCHASE_PRICE"),style:h.summaryRow.title}));const e=()=>{let t;let{amount:e,currency:o}=this.props.productRow.getPurchasePrice();e=parseFloat(e);if(isFinite(e)){t=MoneyView({money:Money.create({amount:e,currency:o}),renderAmount:t=>Text({text:t,style:h.summaryRow.mainPrice}),renderCurrency:t=>Text({text:t,style:h.summaryRow.mainPriceCurrency})})}else{t=Text({text:String(BX.message("CSPL_PRICE_EMPTY")),style:h.summaryRow.mainPriceEmpty})}return View({style:h.summaryRow.rightWrapper},t)};return View({style:{flexDirection:"row",marginBottom:4}},t(),e())}renderSellPrice(){const t=this.props.document?this.props.document.type:"";const e=()=>View({style:h.summaryRow.leftWrapper},Text({text:BX.message("CSPL_SELLING_PRICE"),style:t==="W"?h.summaryRow.title:h.summaryRow.secondaryTitle}));const o=()=>{let e;let{amount:o,currency:r}=this.state.productRow.getSellPrice();o=parseFloat(o);if(isFinite(o)){e=MoneyView({money:Money.create({amount:o,currency:r}),renderAmount:e=>Text({text:e,style:t==="W"?h.summaryRow.mainPrice:h.summaryRow.secondaryPrice}),renderCurrency:e=>Text({text:e,style:t==="W"?h.summaryRow.mainPriceCurrency:h.summaryRow.secondaryPriceCurrency})})}else{e=Text({text:String(BX.message("CSPL_PRICE_EMPTY")),style:h.summaryRow.secondaryPrice})}return View({style:h.summaryRow.rightWrapper},e)};return View({style:{flexDirection:"row"}},e(),o())}showHint(t){const e={title:t,showCloseButton:true,id:"catalog-store-product-card-hint",backgroundColor:r.colors.base0,textColor:r.colors.bgContentPrimary,hideOnTap:true,autoHide:true};const o=()=>{};dialogs.showSnackbar(e,o)}}const h={container:{outer:{backgroundColor:r.colors.bgSecondary}},amount:{wrapper:{flexDirection:"row"},value:{fontSize:18,fontWeight:"bold",textAlign:"right",color:r.colors.base1}},summaryRow:{leftWrapper:{width:"50%",flexDirection:"row",justifyContent:"flex-end",paddingRight:4,alignItems:"center"},rightWrapper:{width:"50%",flexDirection:"row",justifyContent:"flex-end"},storesWrapper:{width:"50%",flexDirection:"column",justifyContent:"flex-end",paddingRight:4},title:{fontSize:16,color:r.colors.base3,textAlign:"right"},secondaryTitle:{fontSize:14,color:r.colors.base5,textAlign:"right"},mainPrice:{fontSize:18,color:r.colors.base1,fontWeight:"bold"},mainPriceCurrency:{fontSize:18,color:r.colors.base3,fontWeight:"bold"},mainPriceEmpty:{fontSize:16,fontWeight:"bold",color:r.colors.base4},secondaryPrice:{fontSize:14,color:r.colors.base4,fontWeight:"bold"},secondaryPriceCurrency:{fontSize:14,fontWeight:"bold",color:r.colors.base5}}};o.exports={StoreProductCard:m}}));
//# sourceMappingURL=extension.map.js