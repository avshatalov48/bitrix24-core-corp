jn.define("catalog/store/product-card",((t,e,o)=>{const r=t("apptheme");const{InlineSkuTree:s}=t("layout/ui/product-grid/components/inline-sku-tree");const{isEmpty:n,mergeImmutable:i}=t("utils/object");const{ProductCard:a}=t("layout/ui/product-grid/components/product-card");const{StoreProductRow:c}=t("catalog/store/product-list/model");const{CatalogStoreProductDetails:l}=t("catalog/store/product-details");const{StoreDocumentProductContextMenu:u}=t("catalog/store/product-list/menu/product-context-menu");const{StoreSkuSelector:d}=t("catalog/store/sku-selector");const{DocumentType:p}=t("catalog/store/document-type");const{Haptics:m}=t("haptics");class h extends LayoutComponent{constructor(t){super(t);this.productCardRef=null;this.state=this.buildState(t)}buildState(t){return{productRow:t.productRow}}render(){const t=this.props.document?this.props.document.type:"";return View({style:{...g.container.outer,paddingTop:this.props.index===0?12:0}},new a({ref:t=>this.productCardRef=t,index:this.props.index+1,name:this.state.productRow.getProductName(),gallery:this.state.productRow.getPhotos(),renderInnerContent:()=>View({onClick:()=>this.showProductDetailsBackdrop()},View({},this.renderProperties(),this.renderDummyPadding(),View({},...this.renderStoreAmount(),this.renderLineSeparator(),t!=="W"&&this.renderPurchasePrice(),this.renderSellPrice(),this.renderTaxes()))),onNameClick:()=>this.showProductDetailsBackdrop(),onImageClick:()=>this.showProductDetailsBackdrop(),onLongClick:()=>this.showProductContextMenu(),onContextMenuClick:()=>this.showProductContextMenu(),onRemove:()=>{if(this.props.document.editable){this.onRemove()}}}))}showProductDetailsBackdrop(){const t=this.state.productRow;const e=t.getRawValues();const o=this.props.document??{};const s=this.props.measures??{};const n=this.props.permissions??{};const i=this.props.catalog??{};const a=this.props.config??{};PageManager.openWidget("layout",{title:BX.message("CSPL_DETAILS_BACKDROP_TITLE"),modal:true,backdrop:{onlyMediumPosition:false,mediumPositionPercent:80,navigationBarColor:r.colors.bgSecondary,horizontalSwipeAllowed:false,swipeAllowed:true,swipeContentAllowed:false},onReady:r=>{r.showComponent(new l({layout:r,product:e,measures:s,permissions:n,catalog:i,document:o,config:a,onChange:e=>{t.setFields(e);this.setState({productRow:t},(()=>{this.blink();this.onChange()}))}}))}})}renderTaxes(){const t=this.state.productRow.getVatRate();if(t===null||parseFloat(t)===0){return null}const e=t*100;if(e===0){return null}const o=this.state.productRow.isVatIncluded();const s=o?"CSPL_SELLING_PRICE_TAX_INCLUDED":"CSPL_SELLING_PRICE_TAX_NOT_INCLUDED";const n=BX.message(s);const i=BX.message("CSPL_SELLING_PRICE_TAX").replace("#PERCENT#",e);const a=this.state.productRow.getVatValue();const c=this.state.productRow.getCurrency();const l=Money.create({amount:a,currency:c});const u=`${i}, ${l.formatted}`;const d={fontSize:12,color:r.colors.base4,textAlign:"right"};return w({style:{marginTop:4,marginBottom:0}},View({style:{flexDirection:"row",justifyContent:"flex-end"}},View({style:{flexDirection:"column"}},Text({style:d,text:u}),Text({style:d,text:n}))))}showProductContextMenu(){m.impactLight();const t=new u({editable:Boolean(this.props.document.editable),onChooseOpen:()=>this.showProductDetailsBackdrop(),onChooseEdit:()=>this.showProductDetailsBackdrop(),onChooseChangeVariation:this.hasVariations()?()=>this.showSkuSelector():null,onChooseRemove:()=>{if(this.props.document.editable){this.onRemove()}}});t.show()}onRemove(){if(this.props.onRemove){this.props.onRemove(this.state.productRow)}}onChange(){if(this.props.onChange){this.props.onChange(this.state.productRow)}}blink(){if(this.productCardRef){this.productCardRef.blink()}}renderProperties(){if(!this.hasVariations()){return null}const t=this.state.productRow.getSkuTree();return View({},new s({...t,editable:this.props.document.editable,onChangeSku:()=>this.showSkuSelector()}))}showSkuSelector(t){const e=this.state.productRow;const o=e.getId();const s={onlyMediumPosition:true,swipeAllowed:true,swipeContentAllowed:false,mediumPositionPercent:80,navigationBarColor:r.colors.bgSecondary};PageManager.openWidget("layout",{backdrop:s}).then((r=>{r.showComponent(new d({layout:r,selectedVariationId:e.getProductId(),currencyId:"RUB",skuTree:e.getSkuTree(),saveButtonCaption:BX.message("CSPL_SELECT_VARIATION_BUTTON"),onWidgetClosed:e=>{this.changeVariation(o,e).then((()=>{if(t.onVariationChanged){t.onVariationChanged()}}))}}))}))}hasVariations(){const t=this.state.productRow.getSkuTree();if(t&&t.OFFERS_PROP&&!n(t.OFFERS_PROP)){return true}return false}changeVariation(t,{variationData:e,skuTree:o}){const r=this.state.productRow;const s=e.ID;const n="catalogmobile.StoreDocumentProduct.loadProductModel";const i=this.props.document.id||null;const a=this.props.document.type||null;const c={data:{productId:s,documentId:i,documentType:a}};Notify.showIndicatorLoading();return new Promise(((e,o)=>{BX.ajax.runAction(n,c).then((o=>{Notify.hideCurrentIndicator();const s=o.data;s.id=t;const n=["amount","storeFromId","storeFrom","storeToId","storeTo"];n.forEach((t=>delete s[t]));r.setFields({...r.getRawValues(),...s});this.setState({productRow:r},(()=>{this.blink();this.onChange()}));e()})).catch((t=>{Notify.hideCurrentIndicator();console.error(t);ErrorNotifier.showError(BX.message("CSPL_UPDATE_TAB_ERROR"))}))}))}renderDummyPadding(){if(!(this.props.permissions.catalog_store_all||this.props.permissions.catalog_store.includes(this.state.productRow.getStoreToId()))&&!this.props.permissions.catalog_purchas_info){return View({style:{height:16}})}return null}renderStoreAmount(){if(!(this.props.permissions.catalog_store_all||this.props.permissions.catalog_store.includes(this.state.productRow.getStoreToId()))){return[]}let t=Number(this.state.productRow.getAmount());if(isNaN(t)){t=0}const e=this.state.productRow.getMeasure();const o=e?e.name:"";return[View({style:g.amount.wrapper},this.renderStoreName(),View({style:{width:"50%",flexDirection:"row",justifyContent:"flex-end"}},Text({text:`${t} `,style:g.amount.value,numberOfLines:1}),Text({text:String(o),style:{...g.amount.value,color:r.colors.base3},numberOfLines:1})))]}renderStoreName(){const t=this.props.document;const e=t?t.type:"";const o=this.state.productRow.getStoreFrom();const r=this.state.productRow.getStoreTo();let s="";if((e===p.Arrival||e===p.StoreAdjustment)&&r){s=r.title?r.title:""}else if((e===p.Deduct||e==="W")&&o){s=o.title?o.title:""}else if(e===p.Moving&&o&&r){const t=o.title?o.title:BX.message("CSPL_STORE_EMPTY");const e=r.title?r.title:BX.message("CSPL_STORE_EMPTY");return View({style:g.summaryRow.storesWrapper},View({onClick:()=>{this.showHint(t)}},Text({text:t,style:g.summaryRow.title,ellipsize:"end",numberOfLines:1})),View({onClick:()=>{this.showHint(e)}},Text({text:e,style:g.summaryRow.title,ellipsize:"end",numberOfLines:1})))}if(s){return View({style:g.summaryRow.leftWrapper,onClick:()=>{this.showHint(s)}},Text({text:s,style:g.summaryRow.title,ellipsize:"end",numberOfLines:1}))}return View({style:g.summaryRow.leftWrapper},Text({text:BX.message("CSPL_STORE_EMPTY"),style:g.summaryRow.title}))}renderLineSeparator(){return View({style:{height:1,width:"100%",backgroundColor:r.colors.bgSeparatorPrimary,marginTop:4,marginBottom:6}})}renderPurchasePrice(){if(!this.props.permissions.catalog_purchas_info){return[]}const t=()=>View({style:g.summaryRow.leftWrapper},Text({text:BX.message("CSPL_PURCHASE_PRICE"),style:g.summaryRow.title}));const e=()=>{let t;let{amount:e,currency:o}=this.props.productRow.getPurchasePrice();e=parseFloat(e);if(isFinite(e)){t=MoneyView({money:Money.create({amount:e,currency:o}),renderAmount:t=>Text({text:t,style:g.summaryRow.mainPrice}),renderCurrency:t=>Text({text:t,style:g.summaryRow.mainPriceCurrency})})}else{t=Text({text:String(BX.message("CSPL_PRICE_EMPTY")),style:g.summaryRow.mainPriceEmpty})}return View({style:g.summaryRow.rightWrapper},t)};return View({style:{flexDirection:"row",marginBottom:4}},t(),e())}renderSellPrice(){const t=this.props.document?this.props.document.type:"";let{amount:e,currency:o}=this.state.productRow.getSellPrice();return View({style:{flexDirection:"row"}},this.renderPriceTitle(BX.message("CSPL_SELLING_PRICE"),t),this.renderPriceValue(parseFloat(e),o,t))}renderPriceValue(t,e,o){if(!isFinite(t)){return View({style:g.summaryRow.rightWrapper},Text({text:String(BX.message("CSPL_PRICE_EMPTY")),style:g.summaryRow.secondaryPrice}))}return View({style:g.summaryRow.rightWrapper},MoneyView({money:Money.create({amount:t,currency:e}),renderAmount:t=>Text({text:t,style:o==="W"?g.summaryRow.mainPrice:g.summaryRow.secondaryPrice}),renderCurrency:t=>Text({text:t,style:o==="W"?g.summaryRow.mainPriceCurrency:g.summaryRow.secondaryPriceCurrency})}))}renderPriceTitle(t,e){return View({style:g.summaryRow.leftWrapper},Text({text:t,style:e==="W"?g.summaryRow.title:g.summaryRow.secondaryTitle}))}showHint(t){const e={title:t,showCloseButton:true,id:"catalog-store-product-card-hint",backgroundColor:r.colors.base0,textColor:r.colors.bgContentPrimary,hideOnTap:true,autoHide:true};const o=()=>{};dialogs.showSnackbar(e,o)}}function w(t,...e){const o=8;const r=8;const s=e.map(((t,e,r)=>{const s=r.length-1;const n={flexGrow:1,flexBasis:0,marginLeft:e===0?0:o,marginRight:e===s?0:o};return View({style:n},t)}));const n={style:{flexDirection:"row",justifyContent:"space-between",marginBottom:r}};return View(i(n,t),...s)}const g={container:{outer:{backgroundColor:r.colors.bgSecondary}},amount:{wrapper:{flexDirection:"row"},value:{fontSize:18,fontWeight:"bold",textAlign:"right",color:r.colors.base1}},summaryRow:{leftWrapper:{width:"50%",flexDirection:"row",justifyContent:"flex-end",paddingRight:4,alignItems:"center"},rightWrapper:{width:"50%",flexDirection:"row",justifyContent:"flex-end"},storesWrapper:{width:"50%",flexDirection:"column",justifyContent:"flex-end",paddingRight:4},title:{fontSize:16,color:r.colors.base3,textAlign:"right"},secondaryTitle:{fontSize:14,color:r.colors.base5,textAlign:"right"},mainPrice:{fontSize:18,color:r.colors.base1,fontWeight:"bold"},mainPriceCurrency:{fontSize:18,color:r.colors.base3,fontWeight:"bold"},mainPriceEmpty:{fontSize:16,fontWeight:"bold",color:r.colors.base4},secondaryPrice:{fontSize:14,color:r.colors.base4,fontWeight:"bold"},secondaryPriceCurrency:{fontSize:14,fontWeight:"bold",color:r.colors.base5}}};o.exports={StoreProductCard:h}}));
//# sourceMappingURL=extension.map.js