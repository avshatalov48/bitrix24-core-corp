jn.define("catalog/store/product-details",((e,t,s)=>{const{Alert:o}=e("alert");const i=e("apptheme");const{BannerButton:r}=e("layout/ui/banners");const{BarcodeField:a}=e("layout/ui/fields/barcode");const{CombinedField:l}=e("layout/ui/fields/combined");const{EntitySelectorField:n}=e("layout/ui/fields/entity-selector");const{FileField:d}=e("layout/ui/fields/file");const{MoneyField:c}=e("layout/ui/fields/money");const{NumberField:u,NumberPrecision:h}=e("layout/ui/fields/number");const{SelectField:p}=e("layout/ui/fields/select");const{StringField:g}=e("layout/ui/fields/string");const{Loc:S}=e("loc");const{clone:m,set:f,get:F}=e("utils/object");const{DocumentType:y}=e("catalog/store/document-type");const{capitalize:P}=e("utils/string");const{EntitySelectorFactory:D}=e("selector/widget/factory");class _ extends LayoutComponent{constructor(e){super(e);this.state={product:m(this.props.product)};this.nameFieldRef=null;this.photoFieldRef=null;this.storeFromFieldRef=null;this.storeToFieldRef=null;this.layout=e.layout;this.initLayout();this.showReadAccessDenied=this.showReadAccessDenied.bind(this);this.showEditAccessDenied=this.showEditAccessDenied.bind(this)}render(){return View({style:{backgroundColor:i.colors.bgSecondary},resizableByKeyboard:true},ScrollView({style:{flexDirection:"column",flexGrow:1,backgroundColor:i.colors.bgSecondary}},View({},this.renderForm(S.getMessage("CSPD_TITLE_ABOUT"),this.buildProductInfoFieldsList()),this.renderForm(S.getMessage("CSPD_TITLE_STORE_INFO"),this.buildStoreInfoFieldsList()),this.renderMoreOpportunitiesButton())))}renderForm(e,t){return View({style:{paddingBottom:16,paddingTop:0,backgroundColor:i.colors.bgContentPrimary,borderRadius:12,marginBottom:12}},Text({style:{color:i.colors.base1,fontWeight:"bold",fontSize:16,width:"100%",textAlign:"left",paddingTop:0,paddingBottom:0,marginHorizontal:16,marginTop:16,marginBottom:8},text:e}),FieldsWrapper({fields:t,config:{fieldStyles:{paddingHorizontal:16}}}))}renderMoreOpportunitiesButton(){return r({title:S.getMessage("CSPD_MORE_OPPORTUNITIES"),description:S.getMessage("CSPD_ADD_SKU"),onClick:this.openDesktopVersion.bind(this)})}buildProductInfoFieldsList(){const e=this.hasAccess("catalog_product_edit");const t=m(this.state.product.gallery);const s=m(this.state.product.galleryInfo);return[g({ref:e=>this.nameFieldRef=e,title:S.getMessage("CSPD_FIELDS_PRODUCT_NAME"),value:this.state.product.name,readOnly:this.areProductInfoFieldsReadonly(),required:true,onChange:e=>this.updateFieldState("name",e),...this.getAccessProps(true,e)}),n({title:S.getMessage("CSPD_FIELDS_PRODUCT_SECTIONS"),value:this.state.product.sections.map((e=>e.id)),readOnly:this.areProductInfoFieldsReadonly(),multiple:true,showEditIcon:false,config:{selectorType:D.Type.SECTION,enableCreation:true,provider:{options:{iblockId:this.props.catalog.id}},entityList:this.state.product.sections.map((e=>({title:e.name,id:e.id,type:"section"}))),parentWidget:this.layout},onChange:(e,t)=>{const s=t.map((e=>({id:e.id,name:e.title})));this.updateFieldState("sections",s)},...this.getAccessProps(true,e)}),a({title:S.getMessage("CSPD_FIELDS_BARCODE"),value:this.state.product.barcode,readOnly:this.areProductInfoFieldsReadonly(),onChange:e=>this.updateFieldState("barcode",e),...this.getAccessProps(true,e),config:{parentWidget:this.layout}}),d({ref:e=>{this.photoFieldRef=e},title:S.getMessage("CSPD_FIELDS_PHOTOS"),multiple:true,value:t,config:{fileInfo:s,mediaType:"image",controller:{entityId:"catalog-product",options:{productId:this.state.product.productId}}},readOnly:this.areProductInfoFieldsReadonly(),onChange:e=>this.updateFieldState("gallery",e),...this.getAccessProps(true,e)})]}buildStoreInfoFieldsList(){const e=this.getFieldsListForCurrentDocumentType();const t=this.getFieldsDescriptions();const s=[];e.forEach((e=>{if(t[e]){s.push(t[e])}}));return s}getFieldsListForCurrentDocumentType(){const e=this.props.document.type;if(e===y.Arrival||e===y.StoreAdjustment){return["purchasingPrice","sellingPrice","amount","storeTo","totalPrice"]}if(e===y.Moving){return["purchasingPrice","sellingPrice","amount","storeFrom","storeTo","totalPrice"]}if(e===y.Deduct){return["purchasingPrice","sellingPrice","amount","storeFrom","totalPrice"]}if(e===y.SalesOrders){return["sellingPrice","amount","storeFrom","totalPrice"]}return[]}getFieldsDescriptions(){const e={};const t=this.hasAccess("catalog_product_edit");e.name=g({testId:"ProductGridProductDetailsNameField",ref:e=>{this.nameFieldRef=e},title:S.getMessage("CSPD_FIELDS_PRODUCT_NAME"),value:this.state.product.name,readOnly:this.isReadonly(),required:true,onChange:e=>this.updateFieldState("name",e),...this.getAccessProps(true,t)});e.sections=n({testId:"ProductGridProductDetailsSectionsField",title:S.getMessage("CSPD_FIELDS_PRODUCT_SECTIONS"),value:this.state.product.sections.map((e=>e.id)),readOnly:this.isReadonly(),multiple:true,showEditIcon:false,config:{selectorType:D.Type.SECTION,enableCreation:true,provider:{options:{iblockId:this.props.catalog.id}},entityList:this.state.product.sections.map((e=>({title:e.name,id:e.id,type:"section"}))),parentWidget:this.layout},onChange:(e,t)=>{const s=t.map((e=>({id:e.id,name:e.title})));this.updateFieldState("sections",s)},...this.getAccessProps(true,t)});e.barcode=a({testId:"ProductGridProductDetailsBarcodeField",title:S.getMessage("CSPD_FIELDS_BARCODE"),value:this.state.product.barcode,readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("barcode",e),...this.getAccessProps(true,t),config:{parentWidget:this.layout}});const s=m(this.state.product.gallery);const o=m(this.state.product.galleryInfo);e.gallery=d({testId:"ProductGridProductDetailsGalleryField",ref:e=>{this.photoFieldRef=e},title:S.getMessage("CSPD_FIELDS_PHOTOS"),multiple:true,value:s,config:{fileInfo:o,mediaType:"image",controller:{entityId:"catalog-product",options:{productId:this.state.product.productId}}},readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("gallery",e),...this.getAccessProps(true,t)});const i=this.hasAccess("catalog_purchas_info");e.purchasingPrice=c({testId:"ProductGridProductDetailsPurchasingPriceField",title:S.getMessage("CSPD_FIELDS_PURCHASING_PRICE"),value:this.state.product.price.purchase,readOnly:this.arePricesReadonly(),config:{currencyReadOnly:true},onChange:e=>this.updateFieldState("price.purchase",e),...this.getAccessProps(i,t)});const r=this.hasAccess("catalog_price");e.sellingPrice=c({testId:"ProductGridProductDetailsSellingPriceField",title:S.getMessage("CSPD_FIELDS_SELLING_PRICE"),value:this.state.product.price.sell,readOnly:this.arePricesReadonly(),config:{currencyReadOnly:true},onChange:e=>{this.updateFieldState("price.sell",e);const t=Number(e.amount);let s;let o;const i=this.state.product.price.vat.vatRate;if(this.state.product.price.vat.vatIncluded==="Y"){s=t*i/(i+1);o=t}else{s=t*i;o=t+s}this.updateFieldState("price.vat.vatValue",s);this.updateFieldState("price.vat.priceWithVat",o)},...this.getAccessProps(true,r)});const f=this.props.document.type;const P=this.state.product.hasStoreToAccess!==false;const _=this.state.product.hasStoreFromAccess!==false;let C=true;switch(f){case y.Arrival:case y.StoreAdjustment:{C=P;break}case y.Moving:{C=_&&P;break}case y.Deduct:case y.SalesOrders:{C=_;break}}e.amount=l({testId:"ProductGridProductDetailsAmountField",value:{amount:this.state.product.amount,measure:F(this.state.product,"measure.code","")},onChange:({amount:e,measure:t})=>{e=e===""?null:Number(e);this.updateFieldState("amount",e);this.updateFieldState("measure",this.props.measures[t])},ref:e=>{this.amountFieldRef=e},config:{primaryField:{id:"amount",renderField:u,title:[y.Arrival,y.StoreAdjustment].includes(f)?S.getMessage("CSPD_FIELDS_STORE_TO_AMOUNT"):S.getMessage("CSPD_FIELDS_AMOUNT"),value:this.state.product.amount,placeholder:"0",config:{type:h.DOUBLE,precision:10},required:f==="W",showRequired:f==="W",customValidation:e=>f==="W"&&e.getValue()<=0?S.getMessage("CSPD_FIELDS_AMOUNT_POSITIVE_ERROR"):null,...this.getAccessProps(C,true)},secondaryField:{id:"measure",renderField:p,title:S.getMessage("CSPD_FIELDS_MEASURES"),required:true,showRequired:false,config:{items:Object.values(this.props.measures).map((e=>({name:e.name,value:e.code})))},...this.getAccessProps(C,t),disabled:!t}},readOnly:this.isReadonly(),...this.getAccessProps(C,true)});e.storeFrom=this.getStoreSelectorField({fieldTitle:f===y.Moving?S.getMessage("CSPD_FIELDS_STORE_FROM"):S.getMessage("CSPD_FIELDS_STORE"),fieldCode:"storeFrom",storeInfo:this.state.product.storeFrom||null,access:_,amount:this.state.product.storeFromAmount,availableAmount:this.state.product.storeFromAvailableAmount,measure:this.state.product.measure.name});e.storeTo=this.getStoreSelectorField({fieldTitle:f===y.Moving?S.getMessage("CSPD_FIELDS_STORE_TO"):S.getMessage("CSPD_FIELDS_STORE"),fieldCode:"storeTo",storeInfo:this.state.product.storeTo||null,access:P,amount:this.state.product.storeToAmount,availableAmount:this.state.product.storeToAvailableAmount,measure:this.state.product.measure.name});const E=f===y.SalesOrders?{...this.state.product.price.sell}:{...this.state.product.price.purchase};E.amount=(E.amount*this.state.product.amount).toFixed(2);e.totalPrice=c({title:S.getMessage("CSPD_FIELDS_TOTAL_PRICE"),value:E,readOnly:true,config:{currencyReadOnly:true},...f===y.SalesOrders?this.getAccessProps(C,r):this.getAccessProps(i&&C,t)});return e}getStoreSelectorField(e={}){const{fieldTitle:t,fieldCode:s,storeInfo:o,access:r,amount:a,availableAmount:l}=e;let d=null;const c=[];if(o){d=o.id;c.push({id:o.id,title:o.title,type:"store",customData:{amount:a,availableAmount:l}})}const u=this.hasAccess("catalog_store_all")&&this.hasAccess("catalog_store_modify");const h=P(s);return n({testId:`ProductGridProductDetails${h}Field`,ref:e=>{this[`${s}FieldRef`]=e},title:t,value:d,readOnly:this.isReadonly(),multiple:false,required:true,showEditIcon:false,showChevronDown:true,showBorder:r,hasSolidBorderContainer:r,config:{selectorType:D.Type.STORE,enableCreation:u,entityList:c,provider:{options:{useAddressAsTitle:true,productId:this.state.product.productId}},styles:{externalWrapperBackgroundColor:this.isReadonly()?i.colors.bgContentSecondary:i.colors.bgSecondary,externalWrapperBorderColor:i.colors.base6,emptyValue:{flex:0,fontSize:16,fontWeight:"400",color:i.colors.base4}},parentWidget:this.layout},wrapperConfig:{showWrapperBorder:!r,style:r?{paddingHorizontal:0,paddingVertical:8}:{}},renderAdditionalBottomContent:this.renderStoreSelectorBottomContent.bind(this,r),onChange:this.onStoreSelectorChange.bind(this,s),...this.getAccessProps(r,true)})}onStoreSelectorChange(e,t,s){const o={id:s[0]?s[0].id:null,title:s[0]?s[0].title:null};this.updateFieldsState([{name:e,value:o},{name:`${e}Id`,value:o.id}])}renderStoreSelectorBottomContent(e,t){const s=t.getEntityList();if(!e||s.length===0){return null}const o=s[0].customData.amount||0;const i=s[0].customData.availableAmount||0;return View({},Text({text:S.getMessage("CSPD_STORE_SELECTOR_AVAILABLE_AMOUNT",{"#VALUE#":i,"#MEASURE#":this.state.product.measure.name})}),Text({text:S.getMessage("CSPD_STORE_SELECTOR_AMOUNT",{"#VALUE#":o,"#MEASURE#":this.state.product.measure.name})}))}getAccessProps(e=false,t=false){if(!e){return{disabled:true,placeholder:S.getMessage("CSPD_ACCESS_DENIED"),emptyValue:S.getMessage("CSPD_ACCESS_DENIED"),value:null,onContentClick:this.showReadAccessDenied}}if(!t){return{readOnly:true,onContentClick:this.showEditAccessDenied}}return{}}showReadAccessDenied(){Notify.showUniqueMessage(S.getMessage("CSPD_ACCESS_DENIED_NOTIFY_TEXT"),S.getMessage("CSPD_READ_ACCESS_DENIED_NOTIFY_TITLE"),{time:3})}showEditAccessDenied(){Notify.showUniqueMessage(S.getMessage("CSPD_ACCESS_DENIED_NOTIFY_TEXT"),S.getMessage("CSPD_EDIT_ACCESS_DENIED_NOTIFY_TITLE"),{time:3})}updateFieldsState(e){this.setState((t=>{const s=m(t.product);e.forEach((e=>{f(s,e.name,e.value)}));return{product:s}}))}updateFieldState(e,t){this.setState((s=>{const o=m(s.product);f(o,e,t);return{product:o}}))}openDesktopVersion(){const e=this.state.product.desktopUrl;const t=F(this.props,"catalog.url.create_product","/");qrauth.open({title:S.getMessage("CSPD_OPEN_PRODUCT_IN_DESKTOP_VERSION"),redirectUrl:e||t,layout:this.layout})}initLayout(){this.layout.setRightButtons([{name:this.isReadonly()?S.getMessage("CSPD_CLOSE"):S.getMessage("CSPD_DONE"),type:"text",color:i.colors.accentMainLinks,callback:this.close.bind(this)}]);this.layout.enableNavigationBarBorder(false)}close(){if(this.isReadonly()){this.layout.close()}else if(this.hasUploadingFiles()){this.showAlertToWaitUploading()}else if(this.validateFields()){if(this.props.onChange){this.props.onChange(this.state.product)}this.emit("StoreEvents.ProductDetails.Change",[this.state.product]);this.layout.close()}}hasUploadingFiles(){if(!this.photoFieldRef){return false}return this.photoFieldRef.hasUploadingFiles()}showAlertToWaitUploading(){o.alert(S.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING"),S.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING_DESC"),null,S.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING_BUTTON"))}areProductInfoFieldsReadonly(){const e=Boolean(this.props.document.editable);const t=Boolean(this.props.config.isCatalogHidden);return!e||t}isReadonly(){const e=Boolean(this.props.document.editable);return!e}arePricesReadonly(){return[y.Deduct,y.Moving].includes(this.props.document.type)||this.isReadonly()}validateFields(){const e=!this.nameFieldRef||this.nameFieldRef.validate();if(!e){return false}if(this.storeFromFieldRef&&!this.storeFromFieldRef.validate()){return false}if(this.storeToFieldRef&&!this.storeToFieldRef.validate()){return false}if(this.amountFieldRef&&!this.amountFieldRef.primaryFieldRef.validate()){return false}return true}emit(e,t){BX.postComponentEvent(e,t)}hasAccess(e){return Boolean(this.props.permissions[e])}}s.exports={CatalogStoreProductDetails:_}}));
//# sourceMappingURL=extension.map.js