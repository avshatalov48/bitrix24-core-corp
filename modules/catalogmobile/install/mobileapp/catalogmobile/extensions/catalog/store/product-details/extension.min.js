jn.define("catalog/store/product-details",((e,t,s)=>{const{Alert:i}=e("alert");const{BannerButton:o}=e("layout/ui/banners");const{BarcodeField:r}=e("layout/ui/fields/barcode");const{CombinedField:a}=e("layout/ui/fields/combined");const{EntitySelectorField:l}=e("layout/ui/fields/entity-selector");const{FileField:n}=e("layout/ui/fields/file");const{MoneyField:d}=e("layout/ui/fields/money");const{NumberField:c,NumberPrecision:u}=e("layout/ui/fields/number");const{SelectField:h}=e("layout/ui/fields/select");const{StringField:p}=e("layout/ui/fields/string");const{Loc:g}=e("loc");const{clone:S,set:m,get:f}=e("utils/object");const{DocumentType:y}=e("catalog/store/document-type");const{capitalize:F}=e("utils/string");class D extends LayoutComponent{constructor(e){super(e);this.state={product:S(this.props.product)};this.nameFieldRef=null;this.photoFieldRef=null;this.storeFromFieldRef=null;this.storeToFieldRef=null;this.layout=e.layout;this.initLayout();this.showReadAccessDenied=this.showReadAccessDenied.bind(this);this.showEditAccessDenied=this.showEditAccessDenied.bind(this)}render(){return View({style:{backgroundColor:"#eef2f4"},resizableByKeyboard:true},ScrollView({style:{backgroundColor:"#eef2f4",flexDirection:"column",flexGrow:1}},View({},this.renderForm(g.getMessage("CSPD_TITLE_ABOUT"),this.buildProductInfoFieldsList()),this.renderForm(g.getMessage("CSPD_TITLE_STORE_INFO"),this.buildStoreInfoFieldsList()),this.renderMoreOpportunitiesButton())))}renderForm(e,t){return View({style:{paddingBottom:16,paddingTop:0,backgroundColor:"#ffffff",borderRadius:12,marginBottom:12}},Text({style:{color:"#333333",fontWeight:"bold",fontSize:16,width:"100%",textAlign:"left",paddingTop:0,paddingBottom:0,marginHorizontal:16,marginTop:16,marginBottom:8},text:e}),FieldsWrapper({fields:t,config:{fieldStyles:{paddingHorizontal:16}}}))}renderMoreOpportunitiesButton(){return o({title:g.getMessage("CSPD_MORE_OPPORTUNITIES"),description:g.getMessage("CSPD_ADD_SKU"),onClick:this.openDesktopVersion.bind(this)})}buildProductInfoFieldsList(){const e=this.hasAccess("catalog_product_edit");const t=S(this.state.product.gallery);const s=S(this.state.product.galleryInfo);return[p({ref:e=>this.nameFieldRef=e,title:g.getMessage("CSPD_FIELDS_PRODUCT_NAME"),value:this.state.product.name,readOnly:this.isReadonly(),required:true,onChange:e=>this.updateFieldState("name",e),...this.getAccessProps(true,e)}),l({title:g.getMessage("CSPD_FIELDS_PRODUCT_SECTIONS"),value:this.state.product.sections.map((e=>e.id)),readOnly:this.isReadonly(),multiple:true,showEditIcon:false,config:{selectorType:EntitySelectorFactory.Type.SECTION,enableCreation:true,provider:{options:{iblockId:this.props.catalog.id}},entityList:this.state.product.sections.map((e=>({title:e.name,id:e.id,type:"section"}))),parentWidget:this.layout},onChange:(e,t)=>{const s=t.map((e=>({id:e.id,name:e.title})));this.updateFieldState("sections",s)},...this.getAccessProps(true,e)}),r({title:g.getMessage("CSPD_FIELDS_BARCODE"),value:this.state.product.barcode,readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("barcode",e),...this.getAccessProps(true,e),config:{parentWidget:this.layout}}),n({ref:e=>this.photoFieldRef=e,title:g.getMessage("CSPD_FIELDS_PHOTOS"),multiple:true,value:t,config:{fileInfo:s,mediaType:"image",controller:{entityId:"catalog-product",options:{productId:this.state.product.productId}}},readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("gallery",e),...this.getAccessProps(true,e)})]}buildStoreInfoFieldsList(){const e=this.getFieldsListForCurrentDocumentType();const t=this.getFieldsDescriptions();const s=[];e.forEach((e=>{if(t[e]){s.push(t[e])}}));return s}getFieldsListForCurrentDocumentType(){const e=this.props.document.type;if(e===y.Arrival||e===y.StoreAdjustment){return["purchasingPrice","sellingPrice","amount","storeTo","totalPrice"]}if(e===y.Moving){return["purchasingPrice","sellingPrice","amount","storeFrom","storeTo","totalPrice"]}if(e===y.Deduct){return["purchasingPrice","sellingPrice","amount","storeFrom","totalPrice"]}if(e===y.SalesOrders){return["sellingPrice","amount","storeFrom","totalPrice"]}return[]}getFieldsDescriptions(){const e={};const t=this.hasAccess("catalog_product_edit");e.name=p({testId:"ProductGridProductDetailsNameField",ref:e=>this.nameFieldRef=e,title:g.getMessage("CSPD_FIELDS_PRODUCT_NAME"),value:this.state.product.name,readOnly:this.isReadonly(),required:true,onChange:e=>this.updateFieldState("name",e),...this.getAccessProps(true,t)});e.sections=l({testId:"ProductGridProductDetailsSectionsField",title:g.getMessage("CSPD_FIELDS_PRODUCT_SECTIONS"),value:this.state.product.sections.map((e=>e.id)),readOnly:this.isReadonly(),multiple:true,showEditIcon:false,config:{selectorType:EntitySelectorFactory.Type.SECTION,enableCreation:true,provider:{options:{iblockId:this.props.catalog.id}},entityList:this.state.product.sections.map((e=>({title:e.name,id:e.id,type:"section"}))),parentWidget:this.layout},onChange:(e,t)=>{const s=t.map((e=>({id:e.id,name:e.title})));this.updateFieldState("sections",s)},...this.getAccessProps(true,t)});e.barcode=r({testId:"ProductGridProductDetailsBarcodeField",title:g.getMessage("CSPD_FIELDS_BARCODE"),value:this.state.product.barcode,readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("barcode",e),...this.getAccessProps(true,t),config:{parentWidget:this.layout}});const s=S(this.state.product.gallery);const i=S(this.state.product.galleryInfo);e.gallery=n({testId:"ProductGridProductDetailsGalleryField",ref:e=>this.photoFieldRef=e,title:g.getMessage("CSPD_FIELDS_PHOTOS"),multiple:true,value:s,config:{fileInfo:i,mediaType:"image",controller:{entityId:"catalog-product",options:{productId:this.state.product.productId}}},readOnly:this.isReadonly(),onChange:e=>this.updateFieldState("gallery",e),...this.getAccessProps(true,t)});const o=this.hasAccess("catalog_purchas_info");e.purchasingPrice=d({testId:"ProductGridProductDetailsPurchasingPriceField",title:g.getMessage("CSPD_FIELDS_PURCHASING_PRICE"),value:this.state.product.price.purchase,readOnly:this.arePricesReadonly(),config:{currencyReadOnly:true},onChange:e=>this.updateFieldState("price.purchase",e),...this.getAccessProps(o,t)});const m=this.hasAccess("catalog_price");e.sellingPrice=d({testId:"ProductGridProductDetailsSellingPriceField",title:g.getMessage("CSPD_FIELDS_SELLING_PRICE"),value:this.state.product.price.sell,readOnly:this.arePricesReadonly(),config:{currencyReadOnly:true},onChange:e=>this.updateFieldState("price.sell",e),...this.getAccessProps(true,m)});const F=this.props.document.type;const D=this.state.product.hasStoreToAccess!==false;const _=this.state.product.hasStoreFromAccess!==false;let P=true;if(F===y.Arrival||F===y.StoreAdjustment){P=D}else if(F===y.Moving){P=_&&D}else if(F===y.Deduct||F===y.SalesOrders){P=_}e.amount=a({testId:"ProductGridProductDetailsAmountField",value:{amount:this.state.product.amount,measure:f(this.state.product,"measure.code","")},onChange:({amount:e,measure:t})=>{this.updateFieldState("amount",e);this.updateFieldState("measure",this.props.measures[t])},ref:e=>this.amountFieldRef=e,config:{primaryField:{id:"amount",renderField:c,title:[y.Arrival,y.StoreAdjustment].includes(F)?g.getMessage("CSPD_FIELDS_STORE_TO_AMOUNT"):g.getMessage("CSPD_FIELDS_AMOUNT"),value:this.state.product.amount,placeholder:"0",config:{type:u.DOUBLE,precision:10},required:F==="W",showRequired:F==="W",customValidation:e=>F==="W"&&e.getValue()<=0?g.getMessage("CSPD_FIELDS_AMOUNT_POSITIVE_ERROR"):null,...this.getAccessProps(P,true)},secondaryField:{id:"measure",renderField:h,title:g.getMessage("CSPD_FIELDS_MEASURES"),required:true,showRequired:false,config:{items:Object.values(this.props.measures).map((e=>({name:e.name,value:e.code})))},...this.getAccessProps(P,t),disabled:!t}},readOnly:this.isReadonly(),...this.getAccessProps(P,true)});e.storeFrom=this.getStoreSelectorField({fieldTitle:F===y.Moving?g.getMessage("CSPD_FIELDS_STORE_FROM"):g.getMessage("CSPD_FIELDS_STORE"),fieldCode:"storeFrom",storeInfo:this.state.product.storeFrom?this.state.product.storeFrom:null,access:_,amount:this.state.product.storeFromAmount,availableAmount:this.state.product.storeFromAvailableAmount,measure:this.state.product.measure.name});e.storeTo=this.getStoreSelectorField({fieldTitle:F===y.Moving?g.getMessage("CSPD_FIELDS_STORE_TO"):g.getMessage("CSPD_FIELDS_STORE"),fieldCode:"storeTo",storeInfo:this.state.product.storeTo?this.state.product.storeTo:null,access:D,amount:this.state.product.storeToAmount,availableAmount:this.state.product.storeToAvailableAmount,measure:this.state.product.measure.name});const C=F===y.SalesOrders?{...this.state.product.price.sell}:{...this.state.product.price.purchase};C.amount=(C.amount*this.state.product.amount).toFixed(2);e.totalPrice=d({title:g.getMessage("CSPD_FIELDS_TOTAL_PRICE"),value:C,readOnly:true,config:{currencyReadOnly:true},...F===y.SalesOrders?this.getAccessProps(P,m):this.getAccessProps(o&&P,t)});return e}getStoreSelectorField(e={}){const{fieldTitle:t,fieldCode:s,storeInfo:i,access:o,amount:r,availableAmount:a}=e;let n=null;const d=[];if(i){n=i.id;d.push({id:i.id,title:i.title,type:"store",customData:{amount:r,availableAmount:a}})}const c=this.hasAccess("catalog_store_all")&&this.hasAccess("catalog_store_modify");const u=F(s);return l({testId:`ProductGridProductDetails${u}Field`,ref:e=>this[s+"FieldRef"]=e,title:t,value:n,readOnly:this.isReadonly(),multiple:false,required:true,showEditIcon:false,showChevronDown:true,showBorder:o,hasSolidBorderContainer:o,config:{selectorType:EntitySelectorFactory.Type.STORE,enableCreation:c,entityList:d,provider:{options:{useAddressAsTitle:true,productId:this.state.product.productId}},styles:{externalWrapperBackgroundColor:this.isReadonly()?"#fcfcfd":"#f8fafb",externalWrapperBorderColor:"#dfe0e3",emptyValue:{flex:0,fontSize:16,fontWeight:"400",color:"#a8adb4"}},parentWidget:this.layout},wrapperConfig:{showWrapperBorder:!o,style:o?{paddingHorizontal:0,paddingVertical:8}:{}},renderAdditionalBottomContent:this.renderStoreSelectorBottomContent.bind(this,o),onChange:this.onStoreSelectorChange.bind(this,s),...this.getAccessProps(o,true)})}onStoreSelectorChange(e,t,s){const i={id:s[0]?s[0].id:null,title:s[0]?s[0].title:null};this.updateFieldsState([{name:e,value:i},{name:`${e}Id`,value:i.id}])}renderStoreSelectorBottomContent(e,t){const s=t.getEntityList();if(!e||s.length===0){return null}const i=s[0].customData.amount||0;const o=s[0].customData.availableAmount||0;return View({},Text({text:g.getMessage("CSPD_STORE_SELECTOR_AVAILABLE_AMOUNT",{"#VALUE#":o,"#MEASURE#":this.state.product.measure.name})}),Text({text:g.getMessage("CSPD_STORE_SELECTOR_AMOUNT",{"#VALUE#":i,"#MEASURE#":this.state.product.measure.name})}))}getAccessProps(e=false,t=false){if(!e){return{disabled:true,placeholder:g.getMessage("CSPD_ACCESS_DENIED"),emptyValue:g.getMessage("CSPD_ACCESS_DENIED"),value:null,onContentClick:this.showReadAccessDenied}}if(!t){return{readOnly:true,onContentClick:this.showEditAccessDenied}}return{}}showReadAccessDenied(){Notify.showUniqueMessage(g.getMessage("CSPD_ACCESS_DENIED_NOTIFY_TEXT"),g.getMessage("CSPD_READ_ACCESS_DENIED_NOTIFY_TITLE"),{time:3})}showEditAccessDenied(){Notify.showUniqueMessage(g.getMessage("CSPD_ACCESS_DENIED_NOTIFY_TEXT"),g.getMessage("CSPD_EDIT_ACCESS_DENIED_NOTIFY_TITLE"),{time:3})}updateFieldsState(e){this.setState((t=>{const s=S(t.product);e.forEach((e=>{m(s,e.name,e.value)}));return{product:s}}))}updateFieldState(e,t){this.setState((s=>{const i=S(s.product);m(i,e,t);return{product:i}}))}openDesktopVersion(){const e=this.state.product.desktopUrl;const t=f(this.props,"catalog.url.create_product","/");qrauth.open({title:g.getMessage("CSPD_OPEN_PRODUCT_IN_DESKTOP_VERSION"),redirectUrl:e||t,layout:this.layout})}initLayout(){this.layout.setRightButtons([{name:this.isReadonly()?g.getMessage("CSPD_CLOSE"):g.getMessage("CSPD_DONE"),type:"text",color:"#0b66c3",callback:this.close.bind(this)}]);this.layout.enableNavigationBarBorder(false)}close(){if(this.isReadonly()){this.layout.close()}else if(this.hasUploadingFiles()){this.showAlertToWaitUploading()}else if(this.validateFields()){if(this.props.onChange){this.props.onChange(this.state.product)}this.emit("StoreEvents.ProductDetails.Change",[this.state.product]);this.layout.close()}}hasUploadingFiles(){if(!this.photoFieldRef){return false}return this.photoFieldRef.hasUploadingFiles()}showAlertToWaitUploading(){i.alert(g.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING"),g.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING_DESC"),null,g.getMessage("CSPD_FIELDS_PHOTOS_UPLOADING_BUTTON"))}isReadonly(){const e=Boolean(this.props.document.editable);return!e}arePricesReadonly(){return[y.Deduct,y.Moving].includes(this.props.document.type)||this.isReadonly()}validateFields(){const e=!this.nameFieldRef||this.nameFieldRef.validate();if(!e){return false}if(this.storeFromFieldRef&&!this.storeFromFieldRef.validate()){return false}if(this.storeToFieldRef&&!this.storeToFieldRef.validate()){return false}if(this.amountFieldRef&&!this.amountFieldRef.primaryFieldRef.validate()){return false}return true}emit(e,t){BX.postComponentEvent(e,t)}hasAccess(e){return!!this.props.permissions[e]}}s.exports={CatalogStoreProductDetails:D}}));
//# sourceMappingURL=extension.map.js