jn.define("catalog/store/product-list",((t,e,o)=>{const{StoreProductRow:s}=t("catalog/store/product-list/model");const{ProductGrid:r}=t("layout/ui/product-grid");const{BarcodeScanner:c}=t("layout/ui/product-grid/services/barcode-scanner");const{AnalyticsLabel:i}=t("analytics-label");const{DocumentType:n}=t("catalog/store/document-type");const{StoreProductCard:a}=t("catalog/store/product-card");const{StoreDocumentAddProductMenu:d}=t("catalog/store/product-list/menu/add-product-menu");const{StoreProductCurrencyConverter:u}=t("catalog/store/product-list/services/currency-converter");const{StoreProductModelLoader:l}=t("catalog/store/product-list/services/product-model-loader");const{StoreProductSelectorAdapter:h}=t("catalog/store/product-list/services/product-selector-adapter");const{StoreProductListWizardAdapter:m}=t("catalog/store/product-list/services/wizard-adapter");const{clone:p}=t("utils/object");const{confirmDestructiveAction:g}=t("alert");const{Loc:I}=t("loc");class y extends r{constructor(t){super(t);this.itemRefs={};this.delayedRefHandlers={}}initServices(){this.wizardAdapter=new m({root:this,onUpdate:(t,e,o)=>{this.setStateWithNotification({items:t},(()=>{if(o){this.sendProductAddedAnalyticsLabel(e)}this.updateTotal();this.scrollListToTheEnd()}))}});let t=false;if(this.props.config.defaultStore){t={storeFromId:this.props.config.defaultStore.id,storeToId:this.props.config.defaultStore.id,storeFrom:this.props.config.defaultStore,storeTo:this.props.config.defaultStore}}this.productSelectorAdapter=new h({root:this,iblockId:this.state.catalog.id,restrictedProductTypes:this.state.catalog.restricted_product_types,basePriceId:this.state.catalog.base_price_id,currency:this.state.catalog.currency_id,enableCreation:Boolean(this.props.permissions.catalog_product_add),onCreate:t=>this.wizardAdapter.openWizard(t),onSelect:t=>{this.addProductById(t)}});this.barcodeScannerAdapter=new c({onSelect:(e,o)=>{const s=this.getLastSelectedStores();t=s||t;this.loadProductModel(e,{...t,barcode:o}).then((({newItem:t})=>{const e=this.getItems();e.push(t);this.setStateWithNotification({products:e},(()=>{setTimeout((()=>{this.updateTotal();this.scrollListToTheEnd()}),300);const e=t=>{t.showProductDetailsBackdrop()};const o=this.itemRefs[t.getId()];if(o){e(o)}else{this.delayedRefHandlers[t.getId()]=e}}))}))}});this.productModelLoader=new l({root:this});this.currencyConverter=new u({root:this})}getLastSelectedStores(){const t=this.getItems();if(t.length>0){const e=t[t.length-1];return{storeFromId:e.props.storeFromId,storeToId:e.props.storeToId,storeFrom:e.props.storeFrom,storeTo:e.props.storeTo}}return false}buildState(t){return{items:p(t.items).map((t=>new s(t))),document:p(t.document),documentCurrencyId:t.document.currency,catalog:t.catalog,measures:t.measures,permissions:t.permissions,total:{totalRows:t.items.length,totalCost:t.document.total.amount,currency:t.document.currency,totalDiscount:0}}}addProductById(t,e={}){this.loadProductModel(t,e).then((({newItem:t})=>{this.addItem(t)}))}addItem(t){const e=this.getItems();e.push(t);this.setStateWithNotification({products:e},(()=>{this.updateTotal();this.scrollListToTheEnd();const e=t=>{if(t.hasVariations()){t.showSkuSelector({onVariationChanged:()=>{t.showProductDetailsBackdrop()}})}else{t.showProductDetailsBackdrop()}};const o=this.itemRefs[t.getId()];if(o){e(o)}else{this.delayedRefHandlers[t.getId()]=e}}))}getSummary(){return this.state.total}isEditable(){return this.state.document.editable}onAddItemButtonClick(){this.showAddProductMenu()}confirmRemovingItem(t){g({title:"",description:I.getMessage("CSPL_PRODUCT_DELETE_CONFIRMATION"),onDestruct:()=>{this.removeItem(t)}})}removeItem(t){const e=this.getItems().filter((e=>e.getId()!==t.getId()));this.setStateWithNotification({items:e},(()=>this.updateTotal()))}renderSingleItem(t,e){return new a({ref:e=>{this.itemRefs[t.getId()]=e;if(e&&this.delayedRefHandlers[t.getId()]){const o=this.delayedRefHandlers[t.getId()];delete this.delayedRefHandlers[t.getId()];o(e)}},productRow:t,index:e,document:this.state.document,catalog:this.state.catalog,permissions:this.props.permissions,measures:this.props.measures,onChange:t=>{this.notifyGridChanged();this.updateTotal()},onRemove:t=>this.confirmRemovingItem(t)})}getEmptyScreenTitle(){return I.getMessage("CSPL_EMPTY_PRODUCTS_TITLE")}getEmptyScreenDescription(){const t=this.getDocumentTypeName();return I.getMessage(`CSPL_EMPTY_PRODUCTS_${t}_DESCRIPTION`.toUpperCase())}getDocumentTypeName(){switch(this.state.document.type){case n.StoreAdjustment:return"STORE_ADJUSTMENT";case n.Arrival:return"ARRIVAL";case n.Deduct:return"DEDUCT";case n.Moving:return"MOVING";case n.SalesOrders:return"SHIPMENT";default:return"ARRIVAL"}}getItems(){return this.state.items}getDocumentCurrency(){return this.state.documentCurrencyId}updateTotal(){this.forceUpdateSummary((()=>new Promise(((t,e)=>{const o=this.calculateTotal();this.state.total=o;this.customEventEmitter.emit("StoreEvents.ProductList.TotalChanged",[{count:o.totalRows,total:{amount:o.amount,currency:o.currency}}]);t(o)}))))}calculateTotal(){let t=0;this.getItems().map((e=>{let o;if(this.state.document.type===n.SalesOrders){o=e.getSellPrice().amount||0}else{o=e.getPurchasePrice().amount||0}const s=parseFloat(e.getAmount()||0);t+=o*s}));return{totalRows:this.getItems().length,totalCost:t,currency:this.getDocumentCurrency(),totalDiscount:0}}getSummaryComponents(){return{summary:true,discount:false,taxes:false}}loadProductModel(t,e={}){return new Promise(((o,s)=>{this.productModelLoader.load(t,e).then((({items:t,loadedRecordId:e,newItem:s})=>{this.sendProductAddedAnalyticsLabel(s.getId());o({items:t,loadedRecordId:e,newItem:s})}))}))}sendProductAddedAnalyticsLabel(t){const e=this.getItem(t);if(e){i.send({event:"productChosen",entity:"store-document",type:this.state.document.type,isNewDocument:!this.state.document.id,productType:e.getType()})}}showAddProductMenu(){const t=new d({onChooseBarcode:()=>this.barcodeScannerAdapter.open(),onChooseDb:()=>this.productSelectorAdapter.openSelector()});t.show()}on(t,e){const o=(...t)=>{if(this.mounted){return e(...t)}};BX.addCustomEvent(t,o);return this}emit(t,e){BX.postComponentEvent(t,e)}notifyGridChanged(){this.customEventEmitter.emit("DetailCard::onTabChange",[this.props.tabId]);this.customEventEmitter.emit("StoreEvents.ProductList.TotalChanged",[{count:this.state.items.length,total:{amount:this.calculateTotal().totalCost,currency:this.state.documentCurrencyId}}])}onChangeCurrency(t){if(this.state.documentCurrencyId!==t){this.currencyConverter.convert(t).then((t=>{this.setStateWithNotification(t)}))}}onAddItemButtonLongClick(){}}o.exports={StoreProductList:y}}));
//# sourceMappingURL=extension.map.js