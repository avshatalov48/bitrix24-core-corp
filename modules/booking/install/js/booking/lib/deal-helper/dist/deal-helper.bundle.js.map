{"version":3,"file":"deal-helper.bundle.js","sources":["../src/deal-helper.js"],"sourcesContent":["import { Uri } from 'main.core';\nimport { SidePanel } from 'main.sidepanel';\n\nimport { Core } from 'booking.core';\nimport { CrmEntity, Model, Module } from 'booking.const';\nimport { bookingService } from 'booking.provider.service.booking-service';\nimport type { BookingModel, DealData } from 'booking.model.bookings';\nimport type { ClientData } from 'booking.model.clients';\n\nexport class DealHelper\n{\n\t#bookingId: number;\n\n\tconstructor(bookingId: number)\n\t{\n\t\tthis.#bookingId = bookingId;\n\t}\n\n\thasDeal(): boolean\n\t{\n\t\treturn Boolean(this.#deal);\n\t}\n\n\topenDeal(): void\n\t{\n\t\tSidePanel.Instance.open(`/crm/deal/details/${this.#deal.value}/`, {\n\t\t\tevents: {\n\t\t\t\tonClose: () => {\n\t\t\t\t\tif (this.#deal?.value)\n\t\t\t\t\t{\n\t\t\t\t\t\tvoid bookingService.getById(this.#bookingId);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateDeal(): void\n\t{\n\t\tconst bookingIdParamName = 'bookingId';\n\n\t\tconst createDealUrl = new Uri('/crm/deal/details/0/');\n\t\tcreateDealUrl.setQueryParam(bookingIdParamName, this.#bookingId);\n\n\t\t(this.#booking.clients ?? []).forEach((client: ClientData) => {\n\t\t\tconst paramName = {\n\t\t\t\t[CrmEntity.Contact]: 'contact_id',\n\t\t\t\t[CrmEntity.Company]: 'company_id',\n\t\t\t}[client.type.code];\n\n\t\t\tcreateDealUrl.setQueryParam(paramName, client.id);\n\t\t});\n\n\t\tSidePanel.Instance.open(createDealUrl.toString(), {\n\t\t\tevents: {\n\t\t\t\tonLoad: ({ slider }) => {\n\t\t\t\t\tslider.getWindow().BX.Event.EventEmitter.subscribe('onCrmEntityCreate', (event) => {\n\t\t\t\t\t\tconst [data] = event.getData();\n\n\t\t\t\t\t\tconst isDeal = data.entityTypeName === CrmEntity.Deal;\n\t\t\t\t\t\tconst bookingId = Number(new Uri(data.sliderUrl).getQueryParam(bookingIdParamName));\n\t\t\t\t\t\tif (!isDeal || bookingId !== this.#bookingId)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst dealData = this.mapEntityInfoToDeal(data.entityInfo);\n\n\t\t\t\t\t\tthis.saveDeal(dealData);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonClose: () => {\n\t\t\t\t\tif (this.#deal?.value)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.saveDeal(this.#deal);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\tmapEntityInfoToDeal(info: Object): DealData\n\t{\n\t\treturn {\n\t\t\tmoduleId: Module.Crm,\n\t\t\tentityTypeId: info.typeName,\n\t\t\tvalue: info.id,\n\t\t\tdata: [],\n\t\t};\n\t}\n\n\tsaveDeal(dealData: DealData | null): void\n\t{\n\t\tconst externalData = dealData ? [dealData] : [];\n\n\t\tvoid bookingService.update({\n\t\t\tid: this.#bookingId,\n\t\t\texternalData,\n\t\t});\n\t}\n\n\tget #deal(): DealData | null\n\t{\n\t\treturn this.#booking.externalData?.find((data) => data.entityTypeId === CrmEntity.Deal) ?? null;\n\t}\n\n\tget #booking(): BookingModel\n\t{\n\t\treturn Core.getStore().getters[`${Model.Bookings}/getById`](this.#bookingId);\n\t}\n}\n"],"names":["DealHelper","constructor","bookingId","hasDeal","Boolean","openDeal","SidePanel","Instance","open","value","events","onClose","bookingService","getById","createDeal","bookingIdParamName","createDealUrl","Uri","setQueryParam","clients","forEach","client","paramName","CrmEntity","Contact","Company","type","code","id","toString","onLoad","slider","getWindow","BX","Event","EventEmitter","subscribe","event","data","getData","isDeal","entityTypeName","Deal","Number","sliderUrl","getQueryParam","dealData","mapEntityInfoToDeal","entityInfo","saveDeal","info","moduleId","Module","Crm","entityTypeId","typeName","externalData","update","find","Core","getStore","getters","Model","Bookings"],"mappings":"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"}