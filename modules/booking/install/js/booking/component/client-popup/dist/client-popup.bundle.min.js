this.BX=this.BX||{};this.BX.Booking=this.BX.Booking||{};(function(t,n,e,i,o,l,s,a,c,r,u,p,d,m,h,C,I){"use strict";const f={props:{name:{type:String,required:true},dataElement:{type:String,required:true}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-client-popup-field"\n\t\t\t:data-element="dataElement"\n\t\t>\n\t\t\t<div class="booking-booking-client-popup-field-name">\n\t\t\t\t{{ name }}\n\t\t\t</div>\n\t\t\t<div class="booking-booking-client-popup-field-input-container">\n\t\t\t\t<slot></slot>\n\t\t\t</div>\n\t\t</div>\n\t`};function g(t,n){let e="";const i=[];if(BX.validation.checkIfPhone(t.title)){i.push(t.title)}else{e=t.title}return{name:e,type:{module:h.Module.Crm,code:n},phones:i,emails:[]}}function O(t){return{id:t.id,module:t.type.module,type:t.type.code,title:t.name,attributes:{phone:t.phones.map((t=>({value:t}))),email:t.emails.map((t=>({value:t})))}}}function _(t){var n,e,i,o,l,s;return{id:t.id,name:t.title,type:{module:t.module,code:t.type},phones:(n=(e=t.attributes)==null?void 0:(i=e.phone)==null?void 0:i.map((({value:t})=>t)))!=null?n:[],emails:(o=(l=t.attributes)==null?void 0:(s=l.email)==null?void 0:s.map((({value:t})=>t)))!=null?o:[]}}function E(t){const n=t=>{if(Array.isArray(t)){return t.map((t=>n(t)))}if(m.isRef(t)||m.isReactive(t)||m.isProxy(t)){return n(m.toRaw(t))}if(d.Type.isObject(t)){return Object.keys(t).reduce(((e,i)=>{e[i]=n(t[i]);return e}),{})}return t};return n(t)}const y={emits:["setClient"],props:{client:{type:Object,default:null},code:{type:String,required:true},isWarning:{type:Boolean,default:false}},mounted(){this.dropdown=new BX.UI.Dropdown({targetElement:this.$refs.clientInput,searchAction:"crm.api.entity.search",searchOptions:{types:[this.code],scope:"index"},enableCreation:true,autocompleteDelay:200,items:this.clientsItems,messages:{creationLegend:this.creationLegend},events:{onSelect:(t,n)=>this.setClient(this.itemToClient(n)),onAdd:(t,n)=>this.setClient(this.itemToClient(n))}});this.updateValue();this.onInput();l.EventEmitter.subscribe(this.dropdown,"BX.UI.Dropdown:onSearchComplete",this.onDropdownContactsLoaded)},beforeUnmount(){this.dropdown.destroyPopupWindow();l.EventEmitter.unsubscribe(this.dropdown,"BX.UI.Dropdown:onSearchComplete",this.onDropdownContactsLoaded)},computed:{clientId(){var t;return(t=this.client)==null?void 0:t.id},clientsItems(){switch(this.code){case h.CrmEntity.Contact:return this.$store.getters[`${h.Model.Clients}/getContacts`].map((t=>O(t)));case h.CrmEntity.Company:return this.$store.getters[`${h.Model.Clients}/getCompanies`].map((t=>O(t)));default:return[]}},fieldName(){switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_FIELD_CONTACT");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_FIELD_COMPANY");default:return""}},inputPlaceholder(){switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CONTACT_PLACEHOLDER");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_COMPANY_PLACEHOLDER");default:return""}},creationLegend(){switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_DROPDOWN_CREATE_NEW_CONTACT");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_DROPDOWN_CREATE_NEW_COMPANY");default:return""}},inputLabel(){if(this.isWarning){return this.loc("BOOKING_BOOKING_ADD_CLIENT_CLIENT_REQUIRED")}if(this.isNew){switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CONTACT_NEW");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_COMPANY_NEW");default:return""}}switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CLIENT_EDIT");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CLIENT_EDIT");default:return""}},isNew(){return this.hasClient&&!this.isEditing},isEditing(){var t;return this.hasClient&&Boolean((t=this.client)==null?void 0:t.id)},hasClient(){return Boolean(this.client)},clearHint(){switch(this.code){case h.CrmEntity.Contact:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CHOOSE_ANOTHER_CONTACT");case h.CrmEntity.Company:return this.loc("BOOKING_BOOKING_ADD_CLIENT_CHOOSE_ANOTHER_COMPANY");default:return""}},leftIcon(){switch(this.code){case h.CrmEntity.Contact:return a.Set.PERSON;case h.CrmEntity.Company:return a.Set.COMPANY;default:return""}},searchIcon(){return a.Set.SEARCH_2},arrowsIcon(){return a.Set.SWAP}},methods:{onInput(){if(this.client){this.setClient({...this.client,name:this.getValue()})}},getValue(){return this.$refs.clientInput.value},getPopup(){return this.dropdown.popupWindow},onDropdownContactsLoaded(t){const[,n]=t.getData();this.$store.dispatch(`${h.Model.Clients}/upsertMany`,n.map((t=>this.itemToClient(t))))},getClient(t){const n=this.$store.getters[`${h.Model.Clients}/getByClientData`]({id:t.id,type:{module:t.module,code:t.type}});return n!=null?n:this.itemToClient(t)},itemToClient(t){if(t.id){return _(t)}return this.getEmptyClient(t)},getEmptyClient(t){return g(t,this.code)},clear(){this.setClient(null)},setClient(t){this.$emit("setClient",t)},updateValue(){if(this.client){this.$refs.clientInput.value=this.client.name;this.dropdown.isDisabled=true;this.dropdown.destroyPopupWindow();this.dropdown.popupAlertContainer=null}else{this.$refs.clientInput.value="";this.dropdown.isDisabled=false}}},watch:{client(){this.updateValue()},clientId(){this.onInput()},clientsItems(t){this.dropdown.setDefaultItems(t)}},components:{InputField:f,Icon:a.BIcon},template:`\n\t\t<InputField\n\t\t\t:name="fieldName"\n\t\t\t:data-element="'booking-client-field-' + code"\n\t\t>\n\t\t\t<input\n\t\t\t\tclass="booking-booking-client-popup-field-input --left-icon --right-icon"\n\t\t\t\t:class="{'--warning': isWarning}"\n\t\t\t\t:placeholder="inputPlaceholder"\n\t\t\t\tdata-element="booking-client-input"\n\t\t\t\t:data-id="client?.id || 0"\n\t\t\t\t:data-code="code"\n\t\t\t\t:data-new="isNew"\n\t\t\t\t:data-editing="isEditing"\n\t\t\t\tref="clientInput"\n\t\t\t\t@input="onInput"\n\t\t\t/>\n\t\t\t<div class="booking-booking-client-popup-field-input-icon">\n\t\t\t\t<div class="booking-booking-client-popup-field-input-avatar-icon">\n\t\t\t\t\t<Icon :name="leftIcon"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="hasClient"\n\t\t\t\tclass="booking-booking-client-popup-field-input-label"\n\t\t\t\t:class="{'--warning': isWarning}"\n\t\t\t\tdata-element="booking-client-input-label"\n\t\t\t>\n\t\t\t\t{{ inputLabel }}\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-else\n\t\t\t\tclass="booking-booking-client-popup-field-input-icon-right"\n\t\t\t\tdata-element="booking-client-search-icon"\n\t\t\t>\n\t\t\t\t<Icon :name="searchIcon"/>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="hasClient"\n\t\t\t\tclass="booking-booking-client-popup-field-input-icon-right --clickable"\n\t\t\t\t:title="clearHint"\n\t\t\t\tdata-element="booking-client-clear-icon"\n\t\t\t\t@click="clear"\n\t\t\t>\n\t\t\t\t<Icon :name="arrowsIcon"/>\n\t\t\t</div>\n\t\t</InputField>\n\t`};const N={emits:["update:modelValue"],props:{modelValue:String,clientId:{type:Number,required:true},code:{type:String,required:true}},async mounted(){new I.PhoneNumberInput({node:this.$refs.input,flagNode:this.$refs.flag})},components:{InputField:f},template:`\n\t\t<InputField\n\t\t\t:name="loc('BOOKING_BOOKING_ADD_CLIENT_FIELD_PHONE')"\n\t\t\t:data-element="'booking-client-field-phone'"\n\t\t>\n\t\t\t<input\n\t\t\t\tclass="booking-booking-client-popup-field-input --left-icon"\n\t\t\t\t:placeholder="loc('BOOKING_BOOKING_ADD_CLIENT_FIELD_PLACEHOLDER')"\n\t\t\t\t:value="modelValue"\n\t\t\t\tdata-element="booking-client-phone-input"\n\t\t\t\t:data-id="clientId"\n\t\t\t\t:data-code="code"\n\t\t\t\tref="input"\n\t\t\t\t@input="$emit('update:modelValue', $refs.input.value)"\n\t\t\t/>\n\t\t\t<div class="booking-booking-client-popup-field-input-icon --no-border" ref="flag"></div>\n\t\t</InputField>\n\t`};const v={emits:["update:modelValue"],props:{modelValue:String,clientId:{type:Number,required:true},code:{type:String,required:true}},components:{InputField:f},template:`\n\t\t<InputField\n\t\t\t:name="loc('BOOKING_BOOKING_ADD_CLIENT_FIELD_EMAIL')"\n\t\t\t:data-element="'booking-client-field-email'"\n\t\t>\n\t\t\t<input\n\t\t\t\tclass="booking-booking-client-popup-field-input"\n\t\t\t\t:placeholder="loc('BOOKING_BOOKING_ADD_CLIENT_FIELD_PLACEHOLDER')"\n\t\t\t\t:value="modelValue"\n\t\t\t\tdata-element="booking-client-email-input"\n\t\t\t\t:data-id="clientId"\n\t\t\t\t:data-code="code"\n\t\t\t\tref="input"\n\t\t\t\t@input="$emit('update:modelValue', $refs.input.value)"\n\t\t\t/>\n\t\t</InputField>\n\t`};const B={name:"ClientPopupContent",emits:["create","close"],props:{adjustPosition:{type:Function,required:true},currentClient:{type:Object,default:null}},data(){return{ButtonSize:o.ButtonSize,ButtonColor:o.ButtonColor,CrmEntity:h.CrmEntity,contact:null,company:null,isSaving:false}},computed:{hasClient(){return this.hasContact||this.hasCompany},hasContact(){return Boolean(this.contact)},hasCompany(){return Boolean(this.company)},cannotSave(){return this.clients.length>0&&this.filledClients.length===0},filledClients(){return this.clients.filter((t=>{var n;return(n=t.name)==null?void 0:n.trim()}))},clients(){const t=[];if(this.contact){var n,e;t.push({...this.contact,name:(n=(e=this.$refs.contactInput)==null?void 0:e.getValue())!=null?n:""})}if(this.company){var i,o;t.push({...this.company,name:(i=(o=this.$refs.companyInput)==null?void 0:o.getValue())!=null?i:""})}return t}},beforeMount(){const t=this.currentClient;if(!t){return}if(t.contact){this.setContact(E(t.contact))}if(t.company){this.company=E(t.company)}},methods:{setContact(t){this.contact=t},async setCompany(t){var n;const e=(n=this.company)==null?void 0:n.id;const o=t==null?void 0:t.id;this.company=t;if(!o||e===o){return}const l=await i.clientService.getLinkedContactByCompany(this.company);if(l){this.contact=l}},async saveClients(){this.isSaving=true;const{clients:t,error:n}=await i.clientService.saveMany(this.filledClients);this.isSaving=false;if(n){e.Notifier.notify({id:"booking-client-popup-save-error",text:n.message});return}this.$emit("create",t);this.closePopup()},getClientsPopup(){const t=this.$refs.contactInput.getPopup();const n=this.$refs.companyInput.getPopup();if(t!=null&&t.isShown()){return t}if(n!=null&&n.isShown()){return n}return null},closePopup(){this.$emit("close")}},watch:{isNew(){void this.$nextTick((()=>this.adjustPosition()))}},components:{Button:o.Button,ClientInput:y,PhoneInput:N,EmailInput:v},template:`\n\t\t<div class="booking-booking-client-popup-header">\n\t\t\t<div class="booking-booking-client-popup-header-text">\n\t\t\t\t{{ loc('BOOKING_BOOKING_ADD_CLIENT_POPUP_HEADER') }}\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="ui-icon-set --cross-45"\n\t\t\t\tdata-element="booking-client-popup-close"\n\t\t\t\t@click="closePopup"\n\t\t\t></div>\n\t\t</div>\n\t\t<div class="booking-booking-client-popup-contact">\n\t\t\t<ClientInput\n\t\t\t\t:code="CrmEntity.Contact"\n\t\t\t\t:client="contact"\n\t\t\t\t:isWarning="contact && cannotSave"\n\t\t\t\tref="contactInput"\n\t\t\t\t@setClient="setContact"\n\t\t\t/>\n\t\t\t<template v-if="hasContact">\n\t\t\t\t<PhoneInput v-model="contact.phones[0]" :clientId="contact.id || 0" :code="CrmEntity.Contact"/>\n\t\t\t\t<EmailInput v-model="contact.emails[0]" :clientId="contact.id || 0" :code="CrmEntity.Contact"/>\n\t\t\t</template>\n\t\t\t<ClientInput\n\t\t\t\t:code="CrmEntity.Company"\n\t\t\t\t:client="company"\n\t\t\t\t:isWarning="company && cannotSave"\n\t\t\t\tref="companyInput"\n\t\t\t\t@setClient="setCompany"\n\t\t\t/>\n\t\t\t<template v-if="hasCompany">\n\t\t\t\t<PhoneInput v-model="company.phones[0]" :clientId="company.id || 0" :code="CrmEntity.Company"/>\n\t\t\t\t<EmailInput v-model="company.emails[0]" :clientId="company.id || 0" :code="CrmEntity.Company"/>\n\t\t\t</template>\n\t\t</div>\n\t\t<div v-if="hasClient" class="booking-booking-client-popup-buttons">\n\t\t\t<Button\n\t\t\t\t:dataset="{element: 'booking-client-popup-save'}"\n\t\t\t\t:text="loc('BOOKING_BOOKING_ADD_CLIENT_SAVE')"\n\t\t\t\t:size="ButtonSize.EXTRA_SMALL"\n\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t:round="true"\n\t\t\t\t:disabled="cannotSave"\n\t\t\t\t:waiting="isSaving"\n\t\t\t\t@click="saveClients"\n\t\t\t/>\n\t\t\t<Button\n\t\t\t\t:dataset="{element: 'booking-client-popup-cancel'}"\n\t\t\t\t:text="loc('BOOKING_BOOKING_ADD_CLIENT_CANCEL')"\n\t\t\t\t:size="ButtonSize.EXTRA_SMALL"\n\t\t\t\t:color="ButtonColor.LINK"\n\t\t\t\t:round="true"\n\t\t\t\t@click="closePopup"\n\t\t\t/>\n\t\t</div>\n\t\t<div v-else class="booking-booking-client-popup-hint">\n\t\t\t{{ loc('BOOKING_BOOKING_ADD_CLIENT_POPUP_HINT') }}\n\t\t</div>\n\t`};const b={name:"ClientPopup",emits:["create","close"],props:{bindElement:{type:HTMLElement,required:true},currentClient:{type:Object,default:null},offsetTop:{type:Number,default:null},offsetLeft:{type:Number,default:null}},computed:{popupId(){return"booking-booking-client-popup"},config(){var t,n;return{bindElement:this.bindElement,width:305,offsetLeft:(t=this.offsetLeft)!=null?t:0-this.bindElement.offsetWidth,offsetTop:(n=this.offsetTop)!=null?n:this.bindElement.offsetHeight,autoHideHandler:({target:t})=>{var n,e;const i=this.$refs.content;const o=this.$refs.popup.contains(t);const l=(n=i.getClientsPopup())==null?void 0:(e=n.getPopupContainer())==null?void 0:e.contains(t);const s=i.hasClient;return!l&&!o&&!s}}}},mounted(){this.onAdjustPosition()},methods:{onAdjustPosition(){var t;(t=this.$refs.content.getClientsPopup())==null?void 0:t.adjustPosition()},closePopup(){this.$emit("close")}},components:{StickyPopup:n.StickyPopup,ClientPopupContent:B},template:`\n\t\t<StickyPopup\n\t\t\tv-slot="{adjustPosition}"\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\tref="popup"\n\t\t\t@close="closePopup"\n\t\t\t@adjustPosition="onAdjustPosition"\n\t\t>\n\t\t\t<ClientPopupContent\n\t\t\t\t:adjust-position\n\t\t\t\t:current-client\n\t\t\t\tref="content"\n\t\t\t\t@create="$emit('create', $event)"\n\t\t\t\t@close="closePopup"\n\t\t\t/>\n\t\t</StickyPopup>\n\t`};t.ClientPopup=b})(this.BX.Booking.Component=this.BX.Booking.Component||{},BX.Booking.Component,BX.UI.NotificationManager,BX.Booking.Provider.Service,BX.Booking.Component,BX.Event,BX.Main,BX.UI.IconSet,BX,BX,BX,BX,BX,BX.Vue3,BX.Booking.Const,BX,BX.Crm);
//# sourceMappingURL=client-popup.bundle.map.js