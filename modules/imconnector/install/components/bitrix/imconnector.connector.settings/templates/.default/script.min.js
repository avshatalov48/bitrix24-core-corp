(function(e){if(!!e.BX.OpenLinesConfigEdit)return;var t=null;var i=null;var n=function(e,t){this.p=!!e?e:{};if(!!e["SELECTED"]){var i={},n,o;for(n in e["SELECTED"]){if(e["SELECTED"].hasOwnProperty(n)&&typeof e["SELECTED"][n]=="object"){for(o in e["SELECTED"][n]){if(e["SELECTED"][n].hasOwnProperty(o)){if(n=="USERS")i["U"+e["SELECTED"][n][o]]="users";else if(n=="SG")i["SG"+e["SELECTED"][n][o]]="sonetgroups";else if(n=="DR")i["DR"+e["SELECTED"][n][o]]="department"}}}}this.p["SELECTED"]=i}this.nodes={};var s=function(e,t){var i={},n,o,a;if(t[e]){for(a in t[e]){if(t[e].hasOwnProperty(a)){n=t[e][a];o=[];if(t[n]&&t[n].length>0)o=s(n,t);i[n]={id:n,type:"category",items:o}}}}return i},a=function(e){var t={},i;for(var n in e){if(e.hasOwnProperty(n)){i=e[n]["parent"];if(!t[i])t[i]=[];t[i][t[i].length]=n}}return s("DR0",t)};if(true||t=="users"){this.params={name:null,searchInput:null,extranetUser:this.p["EXTRANET_USER"]=="Y",bindMainPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,callback:{select:BX.delegate(this.select,this),unSelect:BX.delegate(this.unSelect,this),openDialog:BX.delegate(this.openDialog,this),closeDialog:BX.delegate(this.closeDialog,this),openSearch:BX.delegate(this.openDialog,this),closeSearch:BX.delegate(this.closeSearch,this)},items:{users:!!this.p["USERS"]?this.p["USERS"]:{},groups:{},sonetgroups:{},department:!!this.p["DEPARTMENT"]?this.p["DEPARTMENT"]:{},departmentRelation:!!this.p["DEPARTMENT"]?a(this.p["DEPARTMENT"]):{},contacts:{},companies:{},leads:{},deals:{}},itemsLast:{users:!!this.p["LAST"]&&!!this.p["LAST"]["USERS"]?this.p["LAST"]["USERS"]:{},sonetgroups:{},department:{},groups:{},contacts:{},companies:{},leads:{},deals:{},crm:[]},itemsSelected:!!this.p["SELECTED"]?BX.clone(this.p["SELECTED"]):{},isCrmFeed:false,destSort:!!this.p["DEST_SORT"]?BX.clone(this.p["DEST_SORT"]):{}}}};n.prototype={setInput:function(e,t){e=BX(e);if(!!e&&!e.hasAttribute("bx-destination-id")){var i="destination"+(""+(new Date).getTime()).substr(6),n;e.setAttribute("bx-destination-id",i);n=new o(i,e,t);this.nodes[i]=e;BX.defer_proxy(function(){this.params.name=n.id;this.params.searchInput=n.nodes.input;this.params.bindMainPopup.node=n.nodes.container;this.params.bindSearchPopup.node=n.nodes.container;BX.SocNetLogDestination.init(this.params)},this)()}},select:function(t,i,n,o,s){var a=i,r="S";if(i=="groups"){a="all-users"}else if(BX.util.in_array(i,["contacts","companies","leads","deals"])){a="crm"}if(i=="sonetgroups"){r="SG"}else if(i=="groups"){r="UA"}else if(i=="users"){r="U"}else if(i=="department"){r="DR"}else if(i=="contacts"){r="CRMCONTACT"}else if(i=="companies"){r="CRMCOMPANY"}else if(i=="leads"){r="CRMLEAD"}else if(i=="deals"){r="CRMDEAL"}var c=o?" bx-destination-undelete":"";c+=i=="sonetgroups"&&typeof e["arExtranetGroupID"]!="undefined"&&BX.util.in_array(t.entityId,e["arExtranetGroupID"])?" bx-destination-extranet":"";var l=BX.create("div",{attrs:{"data-id":t.id},props:{className:"imconnector-field-user-item bx-destination bx-destination-"+a+c},children:[BX.create("div",{props:{className:"imconnector-field-user-icon"},attrs:{style:t.avatar?"background-image:url('"+t.avatar+"')":""}}),BX.create("div",{props:{className:"imconnector-field-user-info"},children:[BX.create("a",{attrs:{href:t.link},props:{className:"imconnector-field-user-name"},html:t.name}),BX.create("div",{props:{className:"imconnector-field-user-desc"},html:t.desc})]})]});if(!o){l.appendChild(BX.create("span",{props:{className:"imconnector-close-icon"},events:{click:function(e){BX.PreventDefault(e);BX.SocNetLogDestination.deleteItem(t.id,i,s);var n=new FormData(BX("user-queue-save"));var o=new BX.ImConnectorConnectorSettings;o.saveUsers(n)}}}))}BX.onCustomEvent(this.nodes[s],"select",[t,l,r])},unSelect:function(e,t,i,n){BX.onCustomEvent(this.nodes[n],"unSelect",[e])},openDialog:function(e){BX.onCustomEvent(this.nodes[e],"openDialog",[])},closeDialog:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeDialog",[]);this.disableBackspace()}},closeSearch:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeSearch",[]);this.disableBackspace()}},disableBackspace:function(){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!==null)BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(e,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){BX.PreventDefault(e);return false}return true});setTimeout(function(){BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)}};var o=function(e,t,i){this.node=t;this.id=e;this.inputName=i;this.node.appendChild(BX.create("DIV",{props:{className:"imconnector-field-box imconnector-field-user-box"},html:['<div class="imconnector-field-box-subtitle" id="bx-imconnector-tooltip">',BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_QUEUE"),"</div>",'<div id="',this.id,'-container" class="bx-destination-wrap-item imconnector-field-user"></div>','<span class="bx-destination-input-box" id="',this.id,'-input-box" style="display: none;">','<input type="text" value="" class="bx-destination-input imconnector-field-control-input" id="',this.id,'-input">',"</span>",'<a href="#" class="bx-destination-add imconnector-field-link-grey" id="',this.id,'-add-button"></a>'].join("")}));BX.defer_proxy(this.bind,this)();BX("bx-imconnector-tooltip").appendChild(BX.UI.Hint.createNode(BX.message("LM_QUEUE_DESCRIPTION")))};o.prototype={bind:function(){this.nodes={inputBox:BX(this.id+"-input-box"),input:BX(this.id+"-input"),container:BX(this.id+"-container"),button:BX(this.id+"-add-button"),form:BX("user-queue-save")};BX.bind(this.nodes.input,"keyup",BX.proxy(this.search,this));BX.bind(this.nodes.input,"keydown",BX.proxy(this.searchBefore,this));BX.bind(this.nodes.button,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id);BX.PreventDefault(e)},this));BX.bind(this.nodes.container,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id);BX.PreventDefault(e)},this));this.onChangeDestination();BX.addCustomEvent(this.node,"select",BX.proxy(this.select,this));BX.addCustomEvent(this.node,"unSelect",BX.proxy(this.unSelect,this));BX.addCustomEvent(this.node,"delete",BX.proxy(this.delete,this));BX.addCustomEvent(this.node,"openDialog",BX.proxy(this.openDialog,this));BX.addCustomEvent(this.node,"closeDialog",BX.proxy(this.closeDialog,this));BX.addCustomEvent(this.node,"closeSearch",BX.proxy(this.closeSearch,this))},select:function(e,t,i){if(BX.message("LM_BUSINESS_USERS_ON")=="Y"&&BX.message("LM_BUSINESS_USERS").split(",").indexOf(e.id)==-1){BX.SocNetLogDestination.closeDialog(this.id);BX.OpenLinesConfigEdit.openTrialPopup("imol_queue",BX.message("LM_BUSINESS_USERS_TEXT"));return false}if(!BX.findChild(this.nodes.container,{attr:{"data-id":e.id}},false,false)){t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"queue[]",value:e.id}}));this.nodes.container.appendChild(t)}this.onChangeDestination()},unSelect:function(e){var t=BX.findChildren(this.nodes.container,{attribute:{"data-id":""+e.id+""}},true);if(t!==null){for(var i=0;i<t.length;i++)BX.remove(t[i])}this.onChangeDestination()},onChangeDestination:function(){this.nodes.input.innerHTML="";this.nodes.button.innerHTML=BX.SocNetLogDestination.getSelectedCount(this.id)<=0?BX.message("LM_ADD1"):BX.message("LM_ADD2")},openDialog:function(){BX.style(this.nodes.inputBox,"display","inline-block");BX.style(this.nodes.button,"display","none");BX.focus(this.nodes.input)},closeDialog:function(){if(this.nodes.input.value.length<=0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}var e=new FormData(this.nodes.form);this.saveUsers(e)},closeSearch:function(){if(this.nodes.input.value.length>0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}var e=new FormData(this.nodes.form);this.saveUsers(e)},searchBefore:function(e){if(e.keyCode==8&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(this.id)}return true},search:function(e){if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(this.id);return true}if(e.keyCode==27){this.nodes.input.value="";BX.style(this.nodes.button,"display","inline")}else{BX.SocNetLogDestination.search(this.nodes.input.value,true,this.id)}if(!BX.SocNetLogDestination.isOpenDialog()&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.openDialog(this.id)}else if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return true},saveUsers:function(e){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","getSaveUsers",{mode:"ajax",data:e}).then(function(e){})}};e.BX.OpenLinesConfigEdit={popupTooltip:{},openTrialPopup:function(e,t){if(typeof B24!="undefined"&&typeof B24.licenseInfoPopup!="undefined"){B24.licenseInfoPopup.show(e,BX.message("LM_QUEUE_TITLE"),t)}else{alert(t)}},initDestination:function(e,i,o){if(t===null)t=new n(o);t.setInput(BX(e),i);this.receiveReloadUsersMessage()},createLineAction:function(e,t){var i=new BX.ImConnectorConnectorSettings;i.createLine(e,t)},receiveReloadUsersMessage:function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(e){if(e.getEventId()==="ImOpenlines:reloadUsersList"){var n=BX("users_for_queue").getAttribute("bx-destination-id");var o=BX(n+"-container");var s=BX.findChild(o,{class:"bx-destination-users"},false,true);for(var a=0;a<s.length;a++){BX.SocNetLogDestination.deleteItem(s[a].dataset.id,"users",n)}var r=e.getData();if(typeof r==="object"){r=Object.values(r)}for(a=0;a<r.length;a++){t.select(r[a],"users",false,false,n)}}else if(e.getEventId()==="ImOpenlines:updateLinesSubmit"){if(i!==null){var c=e.getData();setTimeout(function(){i.reloadItem(c)},500)}}},this))},initConfigMenu:function(e){i=new BX.ImConnectorLinesMenu(e)}};BX.ready(function(){BX.UI.Hint.init(BX("bx-connector-user-list"))});BX.ImConnectorConnectorSettings=function(e){this.ajaxUrl="/bitrix/components/bitrix/imopenlines.lines/ajax.php";return this};BX.ImConnectorConnectorSettings.prototype={createLine:function(t,i){if(this.isActiveControlLocked){return}this.isActiveControlLocked=true;this.sendActionRequest("create",function(n){if(i){BX.SidePanel.Instance.close();BX.SidePanel.Instance.open(t.replace("#LINE#",n.config_id),{width:700})}else{e.location.href=t.replace("#LINE#",n.config_id)}},function(e){e=e||{error:true,text:""};this.isActiveControlLocked=false;if(e.limited){if(!B24||!B24["licenseInfoPopup"]){return}B24.licenseInfoPopup.show("imconnector_line_activation",BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_POPUP_LIMITED_TITLE"),"<span>"+BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_POPUP_LIMITED_TEXT")+"</span>")}else{this.showErrorPopup(e)}})},sendActionRequest:function(e,t,i){t=t||null;i=i||BX.proxy(this.showErrorPopup,this);BX.ajax({url:this.ajaxUrl,method:"POST",data:{action:e,config_id:this.id,sessid:BX.bitrix_sessid()},timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(e){e=e||{};if(e.error){i.apply(this,[e])}else if(t){t.apply(this,[e])}},this),onfailure:BX.proxy(function(){var e={error:true,text:""};i.apply(this,[e])},this)})},showErrorPopup:function(e){e=e||{};var t=e.text||BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_ERROR_ACTION");var i=BX.PopupWindowManager.create("crm_webform_list_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_CLOSE"),events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-webform-edit-warning-popup-alert">'+t+"</span>");i.show()},saveUsers:function(e){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","getSaveUsers",{mode:"ajax",data:e}).then(function(e){})}};BX.ImConnectorLinesMenu=function(e){this.element=e.element;this.bindElement=document.getElementById(e.bindElement);this.items=this.prepareItems(e.items);this.iframe=e.iframe;this.init()};BX.ImConnectorLinesMenu.prototype={init:function(){var e={maxHeight:400,minWidth:this.bindElement.offsetWidth};this.menu=new BX.PopupMenuWindow(this.element,this.bindElement,this.items,e);BX.bind(this.bindElement,"click",BX.delegate(this.show,this))},show:function(){this.menu.show()},close:function(){this.menu.close()},prepareItems:function(e){if(typeof e==="object"){e=Object.values(e)}var t=[];var i;for(var n=0;n<e.length;n++){i=this.prepareItem(e[n]);if(i.delimiterBefore){t.push({delimiter:true})}t.push(i);if(i.delimiterAfter){t.push({delimiter:true})}}return t},prepareItem:function(t){var i={};i.id=t.ID;i.title=t.NAME;i.text=t.NAME;i.delimiterAfter=t.DELIMITER_AFTER;i.delimiterBefore=t.DELIMITER_BEFORE;if(t.IS_LINE_ACTIVE==="Y"){i.className="imconnector-line-status-active"}else if(t.IS_LINE_ACTIVE==="N"){i.className="imconnector-line-status-inactive"}if(t.URL){i.onclick=BX.delegate(function(i){var n=this.iframe;if(t.NEW==="Y"){BX.OpenLinesConfigEdit.createLineAction(t.URL,n)}else if(n){if(t.IS_LINE_ACTIVE==="N"){this.activatePopupShow(t)}else{this.changeLine(t.URL)}}else{e.location.href=t.URL}this.close()},this)}return i},changeLine:function(t){BX.SidePanel.Instance.close();var i=BX.SidePanel.Instance.getSliderByWindow(e),n=i.options;BX.SidePanel.Instance.open(t,n);i.destroy()},activateLine:function(e){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","activateLine",{mode:"ajax",data:{lineId:e}}).then(BX.proxy(function(e){if(e.data.result===false&&e.data.error){alert(e.data.error)}},this)).then(BX.proxy(function(e){},this))},activatePopupShow:function(e){var t=e.ID,i=e.URL;var n=new BX.PopupWindow("uid-config-activate-"+t,null,{closeIcon:{right:"5px",top:"5px"},titleBar:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_TITLE"),closeByEsc:true,autoHide:true,content:'<p class="imconnector-popup-text">'+BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_DESCRIPTION")+"</p>",overlay:{backgroundColor:"black",opacity:"80"},buttons:[new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_BUTTON_ACTIVE"),className:"popup-window-button-accept",events:{click:BX.proxy(function(){this.activateLine(t);setTimeout(BX.delegate(function(){this.changeLine(i)},this),200)},this)}}),new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_BUTTON_NO"),className:"popup-window-button-link",events:{click:BX.proxy(function(){this.changeLine(i)},this)}})]});n.show()},reloadItem:function(t){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","getConfigItem",{mode:"ajax",data:{lineId:t}}).then(BX.proxy(function(i){if(i.data.ID){var n=i.data;n.URL=e.location.href;var o=this.prepareItem(n);if(o.id&&o.id==t){var s=this.menu.getMenuItemPosition(t);this.menu.removeMenuItem(t);var a=this.menu.menuItems[s];if(a.id){this.menu.addMenuItem(o,a.id)}else{this.menu.addMenuItem(o)}var r=document.getElementById("imconnector-lines-list");r.innerHTML=o.title}}},this)).then(BX.proxy(function(e){},this))}}})(window);
//# sourceMappingURL=script.map.js