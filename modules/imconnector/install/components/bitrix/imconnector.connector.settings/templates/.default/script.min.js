(function(e){if(!!e.BX.ImConnectorLinesConfigEdit)return;var t=null;var n=null;e.BX.ImConnectorLinesConfigEdit={initDestination:function(e,n){if(t===null){t=new i(n)}t.setInput(BX(e));this.receiveReloadUsersMessage()},createLineAction:function(e,t){var n=new BX.ImConnectorConnectorSettings;n.createLine(e,t)},initConfigMenu:function(e){n=new BX.ImConnectorLinesMenu(e)},receiveReloadUsersMessage:function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate((function(e){if(e.getEventId()==="ImOpenlines:reloadUsersList"){var i=e.getData();if(!!i&&!!t){t.params.queueItems=[];t.destroy();i.forEach(BX.proxy((function(e){t.params.queueItems.push(JSON.parse(JSON.stringify(e)))}),this));t.createSelector()}}else if(e.getEventId()==="ImOpenlines:updateLinesSubmit"){if(n!==null){var s=e.getData();setTimeout((function(){n.reloadItem(s)}),500)}}}),this))}};var i=function(e){this.id=e.lineId;this.nodes={};this.nodesType={destInput:"",userInputContainer:"",userInputButton:""};this.popupDepartment=false;this.params={queueItems:e.queueItems,readOnly:e.readOnly,popupDepartment:e.popupDepartment}};i.prototype={getDialog:function(){if(!this.dialog){this.dialog=new BX.UI.EntitySelector.Dialog({targetNode:this.nodes[this.nodesType.userInputButton],context:"IMOL_QUEUE_USERS",enableSearch:true,selectedItems:this.params.queueItems,events:{"Item:onSelect":BX.proxy((function(e){this.addItemQueue(e)}),this),"Item:onDeselect":BX.proxy((function(e){this.deleteItemQueue(e)}),this)},entities:[{id:"user",options:{inviteEmployeeLink:false,intranetUsersOnly:true}},{id:"department",options:{inviteEmployeeLink:false,selectMode:"usersAndDepartments"}}]})}return this.dialog},destroy:function(){if(!!this.dialog){this.dialog.destroy();delete this.dialog;BX.cleanNode(this.nodes[this.nodesType.userInputContainer])}},createSelector:function(){var e;this.getDialog().getSelectedItems().forEach(BX.proxy((function(t){e=this.selectInputNodes(t,e)}),this))},setInput:function(e){e=BX(e);if(!!e&&!e.hasAttribute("bx-destination-id")){var t=false;if(this.params.readOnly){t=true}var n="destination"+(""+(new Date).getTime()).substr(6),i;e.setAttribute("bx-destination-id",n);this.nodesType.destInput=e.id;this.nodesType.userInputContainer=n+"-container";this.nodesType.userInputButton=n+"-add-button";e.appendChild(BX.create("DIV",{props:{className:"imconnector-field-box imconnector-field-user-box"},html:['<div class="imconnector-field-box-subtitle" id="bx-imconnector-tooltip-queue">',BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_QUEUE"),"</div>",'<div id="',this.nodesType.userInputContainer,'" class="bx-destination-wrap-item imconnector-field-user"></div>',t?"":'<span class="bx-destination-add imconnector-field-link-grey" id="'+this.nodesType.userInputButton+'">'+BX.message("LM_ADD")+"</span>"].join("")}));BX("bx-imconnector-tooltip-queue").appendChild(BX.UI.Hint.createNode(BX.message("LM_QUEUE_DESCRIPTION")));this.nodes[e.id]=e;this.nodes[this.nodesType.userInputContainer]=BX(this.nodesType.userInputContainer);this.nodes[this.nodesType.userInputButton]=BX(this.nodesType.userInputButton);if(!t){this.nodes[this.nodesType.userInputButton].addEventListener("click",BX.delegate((function(){this.getDialog().show()}),this))}BX.addCustomEvent("ItemUser:onDeselect",BX.delegate((function(e){this.getDialog().getItem({id:e,entityId:"user"}).deselect()}),this));this.createSelector()}},selectInputNodes:function(e,t){var n=BX.findChild(this.nodes[this.nodesType.userInputContainer],{attr:{"data-id":e.id}},false,false);if(!n){var i=this.createInputNode(e)}else{var i=n}if(!t){BX.prepend(i,BX(this.nodes[this.nodesType.userInputContainer]))}else{BX.insertAfter(i,t)}return i},createInputNode:function(e){var t=BX.create("div",{attrs:{"data-id":e.getId()},props:{className:"imconnector-field-user-item bx-destination bx-destination-"+BX.util.htmlspecialchars(e.getEntityId())},children:[BX.create("div",{props:{className:"imconnector-field-user-icon"},attrs:{style:e.getAvatar()?"background-image:url('"+encodeURI(BX.util.htmlspecialchars(e.getAvatar()))+"')":""}}),BX.create("div",{props:{className:"imconnector-field-user-info"},children:[e.getTagLink()!==null?BX.create("a",{attrs:{href:BX.util.htmlspecialchars(e.getTagLink())},props:{className:"imconnector-field-user-name"},html:BX.util.htmlspecialchars(e.getTitle())}):BX.create("span",{props:{className:"imconnector-field-user-name"},text:e.getTitle()}),BX.create("div",{props:{className:"imconnector-field-user-desc"},text:e.getCustomData().get("position")||""})]})]});if(!this.params.readOnly){t.appendChild(BX.create("span",{props:{className:"imconnector-close-icon"},events:{click:function(){e.deselect();BX.Dom.remove(t)}}}))}return t},addItemQueue:function(e){this.showPopupDepartment(e.getData().item);this.reloadUserInputQueue(e.getData().item.getDialog())},deleteItemQueue:function(e){this.reloadUserInputQueue(e.getData().item.getDialog())},reloadUserInputQueue:function(e){var t=e.getSelectedItems();var n=[];t.forEach((function(e){n.push({type:e.entityId,id:e.id})}));this.sendActionRequest("saveUsers",{queue:n},BX.proxy(this.setResultRequestSaveUsers,this))},showPopupDepartment:function(e){var t={id:e.getId(),entityId:e.getEntityId()};if(this.params.popupDepartment.valueDisables!==true&&e.getEntityId()==="department"&&!!this.dialog){if(!!this.popupDepartment){this.popupDepartment.close();this.popupDepartment.destroy()}var n=this.dialog.getTagSelector().getTag(t).getContainer();if(n){var i=[BX.create("DIV",{html:BX.message("LM_HEAD_DEPARTMENT_EXCLUDED_QUEUE"),style:{margin:"10px 20px 10px 5px"}}),BX.create("DIV",{style:{margin:"10px 20px 10px 5px"},children:[BX.create("A",{props:{href:"javascript:void(0)"},text:this.params.popupDepartment.titleOption,events:{click:BX.proxy((function(){this.setDisablesPopupDepartment()}),this)}})]})];this.popupDepartment=BX.PopupWindowManager.create("popup-department",n,{content:BX.create("DIV",{attrs:{className:"imconnector-hint-popup-contents"},children:i}),zIndex:100,closeIcon:{opacity:1},closeByEsc:true,darkMode:false,autoHide:true,angle:true,offsetLeft:20,offsetTop:10,events:{onPopupClose:BX.proxy((function(){this.popupDepartment.destroy()}),this)}});this.popupDepartment.show()}}},setDisablesPopupDepartment:function(){if(!!this.popupDepartment){BX.userOptions.save(this.params.popupDepartment.nameOption.category,this.params.popupDepartment.nameOption.name,this.params.popupDepartment.nameOption.nameValue,"N",false);this.params.popupDepartment.valueDisables=true;this.popupDepartment.close();this.popupDepartment.destroy()}},setResultRequestSaveUsers:function(e){if(!e.error){BX.cleanNode(this.nodes[this.nodesType.userInputContainer]);this.createSelector()}},sendActionRequest:function(e,t,n,i){n=n||null;i=i||null;t=t||{};if(t instanceof FormData){t.append("action",e);t.append("configId",this.id)}else{t.action=e;t.configId=this.id}BX.ajax.runComponentAction("bitrix:imconnector.connector.settings",e,{mode:"ajax",data:t}).then(BX.proxy((function(e){e=e||{};if(e.error){i.apply(this,[e])}else if(n){n.apply(this,[e])}}),this)).then(BX.proxy((function(e){var t={error:true,text:e.error};i.apply(this,[t])}),this))}};BX.ready((function(){BX.UI.Hint.init(BX("bx-connector-user-list"))}));BX.ImConnectorConnectorSettings=function(e){this.ajaxUrl="/bitrix/components/bitrix/imopenlines.lines/ajax.php";return this};BX.ImConnectorConnectorSettings.prototype={createLine:function(t,n){if(this.isActiveControlLocked){return}this.isActiveControlLocked=true;this.sendActionRequest("create",(function(i){if(n){BX.SidePanel.Instance.reload();e.location.href=t.replace("#LINE#",i.config_id)+"&IFRAME=Y"}else{e.location.href=t.replace("#LINE#",i.config_id)}}),(function(e){e=e||{error:true,text:""};this.isActiveControlLocked=false;if(e.limited){if(!B24||!B24["licenseInfoPopup"]){return}if(BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_LIMIT_INFO_HELPER")){BX.UI.InfoHelper.show(BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_LIMIT_INFO_HELPER"))}}else{this.showErrorPopup(e)}}))},sendActionRequest:function(e,t,n){t=t||null;n=n||BX.proxy(this.showErrorPopup,this);BX.ajax({url:this.ajaxUrl,method:"POST",data:{action:e,config_id:this.id,sessid:BX.bitrix_sessid()},timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy((function(e){e=e||{};if(e.error){n.apply(this,[e])}else if(t){t.apply(this,[e])}}),this),onfailure:BX.proxy((function(){var e={error:true,text:""};n.apply(this,[e])}),this)})},showErrorPopup:function(e){e=e||{};var t=e.text||BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_ERROR_ACTION");var n=BX.PopupWindowManager.create("crm_webform_list_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});n.setButtons([new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_SETTINGS_CLOSE"),events:{click:function(){this.popupWindow.close()}}})]);n.setContent('<span class="crm-webform-edit-warning-popup-alert">'+t+"</span>");n.show()}};BX.ImConnectorLinesMenu=function(e){this.element=e.element;this.bindElement=document.getElementById(e.bindElement);this.items=this.prepareItems(e.items);this.iframe=e.iframe;this.init()};BX.ImConnectorLinesMenu.prototype={init:function(){var e={maxHeight:400,minWidth:this.bindElement.offsetWidth};this.menu=new BX.PopupMenuWindow(this.element,this.bindElement,this.items,e);BX.bind(this.bindElement,"click",BX.delegate(this.show,this))},show:function(){this.menu.show()},close:function(){this.menu.close()},prepareItems:function(e){if(typeof e==="object"){e=Object.values(e)}var t=[];var n;for(var i=0;i<e.length;i++){n=this.prepareItem(e[i]);if(n.delimiterBefore){t.push({delimiter:true})}t.push(n);if(n.delimiterAfter){t.push({delimiter:true})}}return t},prepareItem:function(t){var n={};t.NAME=BX.util.htmlspecialchars(t.NAME);n.id=t.ID;n.title=BX.util.htmlspecialcharsback(t.NAME);n.text=t.NAME;n.delimiterAfter=t.DELIMITER_AFTER;n.delimiterBefore=t.DELIMITER_BEFORE;n.dataset={id:t.ID};if(t.IS_LINE_ACTIVE==="Y"){n.className="imconnector-line-status-active"}else if(t.IS_LINE_ACTIVE==="N"){n.className="imconnector-line-status-inactive"}if(t.URL){var i=new URL(document.location).searchParams.get("scenario");if(i){t.URL=BX.util.add_url_param(t.URL,{scenario:i})}n.onclick=BX.delegate((function(n){var i=this.iframe;if(t.NEW==="Y"){BX.ImConnectorLinesConfigEdit.createLineAction(t.URL,i)}else if(i){if(t.IS_LINE_ACTIVE==="N"){this.activatePopupShow(t)}else{this.changeLine(t.URL)}}else{e.location.href=t.URL}this.close()}),this)}return n},changeLine:function(t){BX.SidePanel.Instance.getSliderByWindow(e).showLoader();e.location=`${t}&IFRAME=Y`},activateLine:function(e){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","activateLine",{mode:"ajax",data:{lineId:e}}).then(BX.proxy((function(e){if(e.data.result===false&&e.data.error){alert(e.data.error)}}),this)).then(BX.proxy((function(e){}),this))},activatePopupShow:function(e){var t=e.ID,n=e.URL;var i=new BX.PopupWindow("uid-config-activate-"+t,null,{closeIcon:{right:"5px",top:"5px"},titleBar:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_TITLE"),closeByEsc:true,autoHide:true,content:'<p class="imconnector-popup-text">'+BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_DESCRIPTION")+"</p>",overlay:{backgroundColor:"black",opacity:"80"},buttons:[new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_BUTTON_ACTIVE"),className:"popup-window-button-accept",events:{click:BX.proxy((function(){this.activateLine(t);setTimeout(BX.delegate((function(){this.changeLine(n)}),this),200)}),this)}}),new BX.PopupWindowButton({text:BX.message("IMCONNECTOR_COMPONENT_CONNECTOR_LINE_ACTIVATION_BUTTON_NO"),className:"popup-window-button-link",events:{click:BX.proxy((function(){this.changeLine(n)}),this)}})]});i.show()},reloadItem:function(t){BX.ajax.runComponentAction("bitrix:imconnector.connector.settings","getConfigItem",{mode:"ajax",data:{lineId:t}}).then(BX.proxy((function(n){if(n.data.ID){var i=n.data;i.URL=e.location.href;var s=this.prepareItem(i);if(s.id&&s.id==t){var o=this.menu.getMenuItemPosition(t);this.menu.removeMenuItem(t);var a=this.menu.menuItems[o];if(a.id){this.menu.addMenuItem(s,a.id)}else{this.menu.addMenuItem(s)}var r=document.getElementById("imconnector-lines-list");r.innerHTML=s.title}}}),this)).then(BX.proxy((function(e){}),this))}}})(window);
//# sourceMappingURL=script.map.js