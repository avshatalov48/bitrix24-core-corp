<?php
namespace Bitrix\Im\Integration\UI\EntitySelector;

use Bitrix\Im\User;
use Bitrix\Main\Localization\Loc;
use Bitrix\UI\EntitySelector\BaseFilter;
use Bitrix\UI\EntitySelector\Dialog;
use Bitrix\UI\EntitySelector\Item;

class UserDataFilter extends BaseFilter
{
	public function __construct()
	{
		parent::__construct();
	}

	public function isAvailable(): bool
	{
		return $GLOBALS['USER']->isAuthorized();
	}

	public function apply(array $items, Dialog $dialog): void
	{
		$defaultIcon =
			'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2228%22%20'
			. 'height%3D%2228%22%20viewBox%3D%220%200%2028%2028%22%3E%0A%20%20%3Cg%20fill%3D%22none%22%20'
			. 'fill-rule%3D%22evenodd%22%3E%0A%20%20%20%20%3Ccircle%20cx%3D%2214%22%20cy%3D%2214%22%20r%3D%2214%22%20'
			. 'fill%3D%22%232FC6F6%22%2F%3E%0A%20%20%20%20%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M12.1841171%2C6'
			. '.73273519%20C11.6138376%2C5.82923103%2016.4233456%2C5.07821703%2016.7427927%2C7.84464255%20C16'
			. '.8684938%2C8.6785876%2016.8684938%2C9.52614965%2016.7427927%2C10.3600947%20C16.7427927%2C10'
			. '.3600947%2017.461306%2C10.2774959%2016.9816498%2C11.6435535%20C16.9816498%2C11.6435535%2016'
			. '.7175476%2C12.6267973%2016.3120084%2C12.4060042%20C16.3120084%2C12.4060042%2016.3777103%2C13'
			. '.6484813%2015.7391397%2C13.8591083%20C15.7391397%2C13.8591083%2015.784775%2C14.5208521%2015'
			. '.784775%2C14.565646%20L15.784775%2C14.565646%20L16.3184815%2C14.6453857%20C16.3184815%2C14'
			. '.6453857%2016.3022987%2C15.1972094%2016.4087811%2C15.2569347%20C16.895681%2C15.5714132%2017'
			. '.4293814%2C15.8097658%2017.990805%2C15.9634724%20C19.6479167%2C16.3840911%2020.4894188%2C17.'
			. '1058778%2020.4894188%2C17.7377589%20L20.4894188%2C17.7377589%20L20.9355389%2C20.0043755%20C19.'
			. '0078622%2C20.8122367%2016.7692614%2C21.2938734%2014.3752743%2C21.340248%20L13.6125521%2C21.340248%20C11'
			. '.2243639%2C21.2939856%208.99082029%2C20.8145657%207.0665204%2C20.0102074%20C7.15409205%2C19.3838399%207'
			. '.2677592%2C18.6740761%207.38528973%2C18.2158791%20C7.63741669%2C17.232953%209.05567133%2C16'
			. '.5029064%2010.3606468%2C15.941552%20C11.0361141%2C15.6508676%2011.182406%2C15.476457%2011.8620807%2C15'
			. '.1791012%20C11.9002145%2C14.9981118%2011.9155411%2C14.813208%2011.907716%2C14.6285482%20L11.907716%2C14'
			. '.6285482%20L12.4857632%2C14.5599277%20C12.4857632%2C14.5599277%2012.5618221%2C14.6981219%2012'
			. '.4398043%2C13.8861118%20C12.4398043%2C13.8861118%2011.7902294%2C13.7177372%2011.7601295%2C12'
			. '.4247478%20C11.7601295%2C12.4247478%2011.2717347%2C12.5870863%2011.2422821%2C11.8036681%20C11'
			. '.2215682%2C11.2731295%2010.8053483%2C10.8121645%2011.4041094%2C10.4309391%20L11.4041094%2C10'
			. '.4309391%20L11.0992267%2C9.61797595%20C11.0992267%2C9.61797595%2010.778485%2C6.47858493%2012'
			. '.1841171%2C6.73273519%20Z%22%2F%3E%0A%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E%0A'
		;

		foreach ($items as $item)
		{
			if (!($item instanceof Item))
			{
				continue;
			}

			if ($item->getId() === Helper\User::getCurrentUserId())
			{
				$item->addBadges([[
					'id' => 'IT_IS_YOU',
					'title' => Loc::getMessage('IM_UI_ENTITY_SELECTOR_IT_IS_YOU'),
				]]);
			}

			$customData = $item->getCustomData();
			$userInfo = User::getInstance($item->getId())->getArray();
			$customData->set('imUser', $userInfo);

			if (!$item->getAvatar())
			{
				if ($userInfo['COLOR'] !== '')
				{
					$avatar = str_replace(
						'2FC6F6',
						explode('#', $userInfo['COLOR'])[1],
						$defaultIcon
					);
				}
				else
				{
					$avatar = $defaultIcon;
				}

				$item->setAvatar($avatar);
			}
		}
	}
}
