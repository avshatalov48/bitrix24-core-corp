{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { Reflection, Event, Dom, Tag, Text, Type } from 'main.core';\nimport { Dialog } from 'ui.entity-selector';\nimport { MessageTemplateSelector } from 'im.robot.message-template-selector';\n\nimport 'bp_field_type';\n\nconst namespace = Reflection.namespace('BX.Im.Activity');\n\nclass ImMessageActivity\n{\n\t#form: HTMLFormElement;\n\t#documentType: Array;\n\t#isRobot: boolean;\n\t#currentValues: Object;\n\t#chatSelector: Dialog;\n\t#messageTemplateFields: Object;\n\t#messageTemplateList: Object;\n\t#messageFieldsElement: ?(HTMLDivElement | HTMLTableElement);\n\t#messageTypeBtn: ?(HTMLDivElement | HTMLTableElement);\n\n\tconstructor(parameters: {\n\t\tform: HTMLFormElement,\n\t\tisRobot: boolean,\n\t\tdocumentType: Array,\n\t\tcurrentValues: Object,\n\t\tchatFieldName: string,\n\t\tmessageTemplateFields: Object,\n\t\tmessageTemplateList: Object\n\t})\n\t{\n\t\tthis.#form = parameters.form;\n\t\tthis.#isRobot = parameters.isRobot;\n\t\tthis.#documentType = parameters.documentType;\n\t\tthis.#currentValues = parameters.currentValues;\n\t\tthis.#messageTemplateFields = parameters.messageTemplateFields;\n\t\tthis.#messageTemplateList = parameters.messageTemplateList;\n\t\tthis.#messageFieldsElement = document.getElementById('id_message_fields');\n\t\tthis.#messageTypeBtn = document.querySelector('[data-role=\"message-type\"]');\n\n\t\tif (!Type.isPlainObject(this.#currentValues['message_fields']))\n\t\t{\n\t\t\tthis.#currentValues['message_fields'] = {};\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tthis.#initChatSelector();\n\t\tthis.#initTemplateSelector();\n\n\t\tEvent.bind(this.#chatSelector.getTargetNode(), 'click', () => {this.#chatSelector.show();});\n\n\t\tthis.#setTemplate(this.#form['message_template'].value, true);\n\t}\n\n\t#setTemplate(value, forced)\n\t{\n\t\tif (this.#form['message_template'].value === value && !forced)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#messageTypeBtn)\n\t\t{\n\t\t\tthis.#form['message_template'].value = value;\n\t\t\tthis.#messageTypeBtn.textContent = this.#messageTemplateList[value] || '';\n\t\t}\n\n\t\tthis.showTemplateMessageFields(value);\n\t}\n\n\tshowTemplateMessageFields(newMessageTemplate)\n\t{\n\t\tif (!this.#messageFieldsElement)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.clean(this.#messageFieldsElement);\n\n\t\tif (this.#messageTemplateFields.hasOwnProperty(newMessageTemplate))\n\t\t{\n\t\t\tObject.entries(this.#messageTemplateFields[newMessageTemplate]).forEach(([id, property]) => {\n\t\t\t\tDom.append(\n\t\t\t\t\tthis.#renderProperty(id, property),\n\t\t\t\t\tthis.#messageFieldsElement,\n\t\t\t\t);\n\t\t\t})\n\t\t}\n\t}\n\n\t#renderProperty(id, property)\n\t{\n\t\treturn this.#isRobot ? this.#renderRobotProperty(id, property) : this.#renderDesignerProperty(id, property);\n\t}\n\n\t#renderRobotProperty(id, property)\n\t{\n\t\treturn Tag.render`\n\t\t\t<div class=\"bizproc-automation-popup-settings\">\n\t\t\t\t<span class=\"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-top bizproc-automation-popup-settings-title-autocomplete\">\n\t\t\t\t\t${Text.encode(property.Name)}\n\t\t\t\t</span>\n\t\t\t\t${this.#renderValueElement(id, property)}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#renderDesignerProperty(id, property)\n\t{\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\">\n\t\t\t\t\t${property.Required ? '<span class=\"adm-required-field\">' : ''}\n\t\t\t\t\t${Text.encode(property.Name)}:\n\t\t\t\t\t${property.Required ? '</span>' : ''}\n\t\t\t\t</td>\n\t\t\t\t<td width=\"60%\">\n\t\t\t\t\t${this.#renderValueElement(id, property)}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#renderValueElement(id, property)\n\t{\n\t\tconst fieldName = property['FieldName'];\n\t\tconst fieldValueElement = BX.Bizproc.FieldType.renderControl(\n\t\t\tthis.#documentType,\n\t\t\tproperty,\n\t\t\tfieldName,\n\t\t\tthis.#currentValues['message_fields'][id],\n\t\t\tthis.#isRobot ? 'public' : 'designer',\n\t\t);\n\t\tfieldValueElement.onchange = (event) => { this.#currentValues['message_fields'][id] = event.target.value; }\n\n\t\treturn fieldValueElement;\n\t}\n\n\t#initChatSelector()\n\t{\n\t\tconst chatFieldName = 'chat_id';\n\t\tconst chatNode = this.#form[chatFieldName];\n\n\t\tthis.#chatSelector = new Dialog({\n\t\t\tentities: [\n\t\t\t\t{\n\t\t\t\t\tid: 'im-chat',\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tsearchableChatTypes: ['C'],\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t],\n\t\t\ttargetNode: chatNode,\n\t\t\tmultiple: false,\n\t\t\tenableSearch: true,\n\t\t\thideOnSelect: true,\n\t\t\theight: 300,\n\t\t\twidth: 490,\n\t\t\tautoHide: true,\n\t\t\tcompactView: true,\n\t\t\tshowAvatars: false,\n\t\t\tdropdownMode: true,\n\t\t\tevents: {\n\t\t\t\t'Item:onBeforeSelect': (event) =>\n\t\t\t\t{\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tchatNode.value = event.getData().item.getId();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tthis.#chatSelector.load();\n\t}\n\n\t#initTemplateSelector()\n\t{\n\t\tif (!this.#isRobot)\n\t\t{\n\t\t\tEvent.bind(this.#form['message_template'], 'change', (event) => {\n\t\t\t\tthis.#setTemplate(event.target.value, true);\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst selector = new MessageTemplateSelector();\n\n\t\tEvent.bind(this.#messageTypeBtn, 'click', () => {\n\t\t\tselector.show(this.#messageTypeBtn, this.#form['message_template'].value);\n\t\t});\n\n\t\tselector.subscribe('select', (event) => {\n\t\t\tthis.#setTemplate(event.getData().selected);\n\t\t});\n\t}\n}\n\nnamespace.ImMessageActivity = ImMessageActivity;\n"],"names":["namespace","Reflection","ImMessageActivity","parameters","form","isRobot","documentType","currentValues","messageTemplateFields","messageTemplateList","document","getElementById","querySelector","Type","isPlainObject","Event","bind","getTargetNode","show","value","newMessageTemplate","Dom","clean","hasOwnProperty","Object","entries","forEach","id","property","append","forced","textContent","showTemplateMessageFields","Tag","render","Text","encode","Name","Required","fieldName","fieldValueElement","BX","Bizproc","FieldType","renderControl","onchange","event","target","chatFieldName","chatNode","Dialog","entities","options","searchableChatTypes","targetNode","multiple","enableSearch","hideOnSelect","height","width","autoHide","compactView","showAvatars","dropdownMode","events","preventDefault","getData","item","getId","load","selector","MessageTemplateSelector","subscribe","selected"],"mappings":"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"}