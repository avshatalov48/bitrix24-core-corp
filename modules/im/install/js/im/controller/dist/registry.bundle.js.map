{"version":3,"file":"registry.bundle.js","sources":["../src/application.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * Application controller\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nimport {Timer} from 'im.tools.timer';\nimport {RestMethod} from \"im.const\";\n\nclass ApplicationController\n{\n\tconstructor()\n\t{\n\t\tthis.store = null;\n\t\tthis.restClient = null;\n\n\t\tthis.timer = new Timer();\n\n\t\tthis._prepareFilesBeforeSave = params => { return params };\n\n\t\tthis.defaultMessageLimit = 20;\n\t\tthis.requestMessageLimit = this.getDefaultMessageLimit();\n\n\t\tthis.messageLastReadId = {};\n\t\tthis.messageReadQueue = {};\n\t}\n\n\tsetRestClient(client)\n\t{\n\t\tthis.restClient = client;\n\t}\n\n\tsetVuexStore(store)\n\t{\n\t\tthis.store = store;\n\t}\n\n\tgetSiteId()\n\t{\n\t\treturn this.store.state.application.common.siteId;\n\t}\n\n\tgetChatId()\n\t{\n\t\treturn this.store.state.application.dialog.chatId;\n\t}\n\n\tgetUserId()\n\t{\n\t\treturn this.store.state.application.common.userId;\n\t}\n\n\tgetDialogId()\n\t{\n\t\treturn this.store.state.application.dialog.dialogId;\n\t}\n\n\tgetDialogIdByChatId(chatId) // TODO error with work user dialog id (not chat)\n\t{\n\t\treturn 'chat'+chatId;\n\t}\n\n\tgetDiskFolderId()\n\t{\n\t\treturn this.store.state.application.dialog.diskFolderId;\n\t}\n\n\tgetMessageLimit()\n\t{\n\t\treturn this.store.state.application.dialog.messageLimit;\n\t}\n\n\tgetDefaultMessageLimit()\n\t{\n\t\treturn this.defaultMessageLimit;\n\t}\n\n\tgetRequestMessageLimit()\n\t{\n\t\treturn this.requestMessageLimit;\n\t}\n\n\tisUnreadMessagesLoaded()\n\t{\n\t\tlet dialog = this.store.state.dialogues.collection[this.getDialogId()];\n\t\tif (!dialog)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tif (dialog.unreadLastId <= 0)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tlet collection = this.store.state.messages.collection[this.getChatId()];\n\t\tif (!collection || collection.length <= 0)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tlet lastElementId = 0;\n\t\tfor (let index = collection.length-1; index >= 0; index--)\n\t\t{\n\t\t\tlet lastElement = collection[index];\n\t\t\tif (typeof lastElement.id === \"number\")\n\t\t\t{\n\t\t\t\tlastElementId = lastElement.id;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn lastElementId >= dialog.unreadLastId;\n\t}\n\n\tprepareFilesBeforeSave(files)\n\t{\n\t\treturn this._prepareFilesBeforeSave(files);\n\t}\n\n\tsetPrepareFilesBeforeSaveFunction(func)\n\t{\n\t\tthis._prepareFilesBeforeSave = func.bind(this);\n\t}\n\n\tstartOpponentWriting(params)\n\t{\n\t\tlet {dialogId, userId, userName} = params;\n\n\t\tthis.store.dispatch('dialogues/updateWriting', {\n\t\t\tdialogId,\n\t\t\tuserId,\n\t\t\tuserName,\n\t\t\taction : true\n\t\t});\n\n\t\tthis.timer.start('writingEnd', dialogId+'|'+userId, 35, (id, params) => {\n\t\t\tlet {dialogId, userId} = params;\n\t\t\tthis.store.dispatch('dialogues/updateWriting', {\n\t\t\t\tdialogId,\n\t\t\t\tuserId,\n\t\t\t\taction: false\n\t\t\t});\n\t\t}, {dialogId, userId});\n\n\t\treturn true;\n\t}\n\n\tstopOpponentWriting(params = {})\n\t{\n\t\tlet {dialogId, userId, userName} = params;\n\n\t\tthis.timer.stop('writingStart', dialogId+'|'+userId, true);\n\t\tthis.timer.stop('writingEnd', dialogId+'|'+userId);\n\n\t\treturn true;\n\t}\n\n\tstartWriting()\n\t{\n\t\tif (!this.getChatId() || this.timer.has('writes'))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.timer.start('writes', null, 28);\n\n\t\tthis.timer.start('writesSend', null, 5, (id) => {\n\t\t\tthis.restClient.callMethod(RestMethod.imChatSendTyping, {\n\t\t\t\t'CHAT_ID': this.getChatId()\n\t\t\t}).catch(() => {\n\t\t\t\tthis.timer.stop('writes', this.getChatId());\n\t\t\t});\n\t\t});\n\t}\n\n\tstopWriting()\n\t{\n\t\tthis.timer.stop('writes');\n\t\tthis.timer.stop('writesSend');\n\t}\n\n\tsetSendingMessageFlag(messageId)\n\t{\n\t\tthis.store.dispatch('messages/actionStart', {\n\t\t\tid: messageId,\n\t\t\tchatId: this.getChatId()\n\t\t});\n\t}\n\n\treadMessage(messageId = null)\n\t{\n\t\tlet chatId = this.getChatId();\n\n\t\tif (typeof this.messageLastReadId[chatId] == 'undefined')\n\t\t{\n\t\t\tthis.messageLastReadId[chatId] = null;\n\t\t}\n\t\tif (typeof this.messageReadQueue[chatId] == 'undefined')\n\t\t{\n\t\t\tthis.messageReadQueue[chatId] = [];\n\t\t}\n\n\t\tif (messageId)\n\t\t{\n\t\t\tthis.messageReadQueue[chatId].push(parseInt(messageId));\n\t\t}\n\n\t\tthis.timer.start('readMessage', chatId, .1, (chatId, params) =>\n\t\t{\n\t\t\tthis.messageReadQueue[chatId] = this.messageReadQueue[chatId].filter(elementId => {\n\t\t\t\tif (!this.messageLastReadId[chatId])\n\t\t\t\t{\n\t\t\t\t\tthis.messageLastReadId[chatId] = elementId;\n\t\t\t\t}\n\t\t\t\telse if (this.messageLastReadId[chatId] < elementId)\n\t\t\t\t{\n\t\t\t\t\tthis.messageLastReadId[chatId] = elementId;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t});\n\n\t\t\tif (this.messageLastReadId[chatId] <= 0)\n\t\t\t{\n\t\t\t\treturn false\n\t\t\t}\n\n\t\t\tthis.store.dispatch('messages/readMessages', {\n\t\t\t\tchatId: chatId,\n\t\t\t\treadId: this.messageLastReadId[chatId]\n\t\t\t}).then(result => {\n\t\t\t\tthis.store.dispatch('dialogues/decreaseCounter', {\n\t\t\t\t\tdialogId: this.getDialogIdByChatId(chatId),\n\t\t\t\t\tcount: result.count\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.timer.start('readMessageServer', chatId, .5, (chatId, params) => {\n\t\t\t\tthis.restClient.callMethod(RestMethod.imDialogRead, {\n\t\t\t\t\t'DIALOG_ID': this.getDialogIdByChatId(chatId),\n\t\t\t\t\t'MESSAGE_ID': this.messageLastReadId[chatId]\n\t\t\t\t})\n\t\t\t\t// TODO catch set message to unread status\n\t\t\t});\n\t\t});\n\t}\n}\n\nexport {ApplicationController};"],"names":["ApplicationController","store","restClient","timer","Timer","_prepareFilesBeforeSave","params","defaultMessageLimit","requestMessageLimit","getDefaultMessageLimit","messageLastReadId","messageReadQueue","client","state","application","common","siteId","dialog","chatId","userId","dialogId","diskFolderId","messageLimit","dialogues","collection","getDialogId","unreadLastId","messages","getChatId","length","lastElementId","index","lastElement","id","files","func","bind","userName","dispatch","action","start","stop","has","callMethod","RestMethod","imChatSendTyping","catch","messageId","push","parseInt","filter","elementId","readId","then","result","getDialogIdByChatId","count","imDialogRead"],"mappings":"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"}