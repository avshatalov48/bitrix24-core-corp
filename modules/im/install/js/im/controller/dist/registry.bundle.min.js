this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,s){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.store=null;this.restClient=null;this.timer=new t.Timer;this._prepareFilesBeforeSave=function(e){return e};this.defaultMessageLimit=20;this.requestMessageLimit=this.getDefaultMessageLimit();this.messageLastReadId={};this.messageReadQueue={}}babelHelpers.createClass(e,[{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setVuexStore",value:function e(t){this.store=t}},{key:"getSiteId",value:function e(){return this.store.state.application.common.siteId}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getUserId",value:function e(){return this.store.state.application.common.userId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"getDialogIdByChatId",value:function e(t){return"chat"+t}},{key:"getDiskFolderId",value:function e(){return this.store.state.application.dialog.diskFolderId}},{key:"getMessageLimit",value:function e(){return this.store.state.application.dialog.messageLimit}},{key:"getDefaultMessageLimit",value:function e(){return this.defaultMessageLimit}},{key:"getRequestMessageLimit",value:function e(){return this.requestMessageLimit}},{key:"isUnreadMessagesLoaded",value:function e(){var t=this.store.state.dialogues.collection[this.getDialogId()];if(!t){return true}if(t.unreadLastId<=0){return true}var s=this.store.state.messages.collection[this.getChatId()];if(!s||s.length<=0){return true}var i=0;for(var a=s.length-1;a>=0;a--){var r=s[a];if(typeof r.id==="number"){i=r.id;break}}return i>=t.unreadLastId}},{key:"prepareFilesBeforeSave",value:function e(t){return this._prepareFilesBeforeSave(t)}},{key:"setPrepareFilesBeforeSaveFunction",value:function e(t){this._prepareFilesBeforeSave=t.bind(this)}},{key:"startOpponentWriting",value:function e(t){var s=this;var i=t.dialogId,a=t.userId,r=t.userName;this.store.dispatch("dialogues/updateWriting",{dialogId:i,userId:a,userName:r,action:true});this.timer.start("writingEnd",i+"|"+a,35,function(e,t){var i=t.dialogId,a=t.userId;s.store.dispatch("dialogues/updateWriting",{dialogId:i,userId:a,action:false})},{dialogId:i,userId:a});return true}},{key:"stopOpponentWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var s=t.dialogId,i=t.userId,a=t.userName;this.timer.stop("writingStart",s+"|"+i,true);this.timer.stop("writingEnd",s+"|"+i);return true}},{key:"startWriting",value:function e(){var t=this;if(!this.getChatId()||this.timer.has("writes")){return false}this.timer.start("writes",null,28);this.timer.start("writesSend",null,5,function(e){t.restClient.callMethod(s.RestMethod.imChatSendTyping,{CHAT_ID:t.getChatId()}).catch(function(){t.timer.stop("writes",t.getChatId())})})}},{key:"stopWriting",value:function e(){this.timer.stop("writes");this.timer.stop("writesSend")}},{key:"setSendingMessageFlag",value:function e(t){this.store.dispatch("messages/actionStart",{id:t,chatId:this.getChatId()})}},{key:"readMessage",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var a=this.getChatId();if(typeof this.messageLastReadId[a]=="undefined"){this.messageLastReadId[a]=null}if(typeof this.messageReadQueue[a]=="undefined"){this.messageReadQueue[a]=[]}if(i){this.messageReadQueue[a].push(parseInt(i))}this.timer.start("readMessage",a,.1,function(e,i){t.messageReadQueue[e]=t.messageReadQueue[e].filter(function(s){if(!t.messageLastReadId[e]){t.messageLastReadId[e]=s}else if(t.messageLastReadId[e]<s){t.messageLastReadId[e]=s}return false});if(t.messageLastReadId[e]<=0){return false}t.store.dispatch("messages/readMessages",{chatId:e,readId:t.messageLastReadId[e]}).then(function(s){t.store.dispatch("dialogues/decreaseCounter",{dialogId:t.getDialogIdByChatId(e),count:s.count})});t.timer.start("readMessageServer",e,.5,function(e,i){t.restClient.callMethod(s.RestMethod.imDialogRead,{DIALOG_ID:t.getDialogIdByChatId(e),MESSAGE_ID:t.messageLastReadId[e]})})})}}]);return e}();e.ApplicationController=i})(this.BX.Messenger.Controller=this.BX.Messenger.Controller||{},BX.Messenger,BX.Messenger.Const);
//# sourceMappingURL=registry.bundle.map.js