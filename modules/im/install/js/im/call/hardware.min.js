(function(){const e={defaultMicrophone:"bx-im-settings-default-microphone",defaultCamera:"bx-im-settings-default-camera",defaultSpeaker:"bx-im-settings-default-speaker",enableMicAutoParameters:"bx-im-settings-enable-mic-auto-parameters",preferHd:"bx-im-settings-camera-prefer-hd",enableMirroring:"bx-im-settings-camera-enable-mirroring"};const t={initialized:"initialized",deviceChanged:"deviceChange",onChangeMirroringVideo:"onChangeMirroringVideo"};class i{constructor(){this.initialized=false;this._currentDeviceList=[];this.updating=false;this.eventEmitter=new BX.Event.EventEmitter(this,"HardwareManager")}init(){if(this.initialized){return Promise.resolve()}if(this.initPromise){return this.initPromise}this.initPromise=new Promise(((e,i)=>{this.enumerateDevices().then((i=>{this._currentDeviceList=this.filterDeviceList(i);navigator.mediaDevices.addEventListener("devicechange",BX.debounce(this.onNavigatorDeviceChanged.bind(this),500));this.initialized=true;this.initPromise=null;this.eventEmitter.emit(t.initialized,{});e()})).catch((e=>{this.initPromise=null;i(e)}))}));return this.initPromise}enumerateDevices(){return new Promise(((e,t)=>{if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){return t("NO_WEBRTC")}navigator.mediaDevices.enumerateDevices().then((t=>e(t)))}))}get cameraList(){return this._getDeviceMap("videoinput")}get microphoneList(){return this._getDeviceMap("audioinput")}get audioOutputList(){return this._getDeviceMap("audiooutput")}get defaultMicrophone(){const t=localStorage?localStorage.getItem(e.defaultMicrophone):"";return this.microphoneList[t]?t:""}set defaultMicrophone(t){if(localStorage){localStorage.setItem(e.defaultMicrophone,t)}}get defaultCamera(){const t=localStorage?localStorage.getItem(e.defaultCamera):"";return this.cameraList[t]?t:""}set defaultCamera(t){if(localStorage){localStorage.setItem(e.defaultCamera,t)}}get defaultSpeaker(){const t=localStorage?localStorage.getItem(e.defaultSpeaker):"";return this.audioOutputList[t]?t:""}set defaultSpeaker(t){if(localStorage){localStorage.setItem(e.defaultSpeaker,t)}}get enableMicAutoParameters(){return localStorage?localStorage.getItem(e.enableMicAutoParameters)!=="N":true}set enableMicAutoParameters(t){if(localStorage){localStorage.setItem(e.enableMicAutoParameters,t?"Y":"N")}}get preferHdQuality(){return localStorage?localStorage.getItem(e.preferHd)!=="N":true}set preferHdQuality(t){if(localStorage){localStorage.setItem(e.preferHd,t?"Y":"N")}}get enableMirroring(){return localStorage?localStorage.getItem(e.enableMirroring)!=="N":true}set enableMirroring(i){if(this.enableMirroring!==i){this.eventEmitter.emit(t.onChangeMirroringVideo,{enableMirroring:i});if(BX.desktop){BX.desktop.onCustomEvent(t.onChangeMirroringVideo,[i])}if(localStorage){localStorage.setItem(e.enableMirroring,i?"Y":"N")}}}hasCamera(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.cameraList).length>0}getMicrophoneList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind=="audioinput"))}getCameraList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind=="videoinput"))}getSpeakerList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind=="audiooutput"))}canSelectSpeaker(){return"setSinkId"in HTMLMediaElement.prototype}updateDeviceList(e){if(this.updating){return}this.updating=true;let i=this._currentDeviceList;let r=[];const a=this._currentDeviceList.every((e=>e.deviceId==""&&e.label==""));navigator.mediaDevices.enumerateDevices().then((e=>{e=this.filterDeviceList(e);e.forEach((e=>{const t=i.findIndex((t=>t.kind===e.kind&&t.deviceId===e.deviceId));if(t!=-1){i.splice(t,1)}else{r.push(e)}}));if(!a){this.eventEmitter.emit(t.deviceChanged,{added:r,removed:i})}this._currentDeviceList=e;this.updating=false}))}filterDeviceList(e){return e.filter((e=>{switch(e.kind){case"audioinput":return e.deviceId!=="default"&&e.deviceId!=="communications";case"audiooutput":return e.deviceId!=="default";default:return true}}))}onNavigatorDeviceChanged(e){if(!this.initialized){return}this.updateDeviceList()}subscribe(e,t){return this.eventEmitter.subscribe(e,t)}unsubscribe(e,t){return this.eventEmitter.unsubscribe(e,t)}_getDeviceMap(e){let t={};if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}for(let i=0;i<this._currentDeviceList.length;i++){if(this._currentDeviceList[i].kind==e){t[this._currentDeviceList[i].deviceId]=this._currentDeviceList[i].label}}return t}}class r{isAvailable(){if(BX.getClass("BX.desktop")){return BX.desktop.getApiVersion()>=52}else if(BX.getClass("BX.Messenger.Lib.Utils.platform")){return BX.Messenger.Lib.Utils.platform.getDesktopVersion()>=52}return false}isMaskAvailable(){if(BX.getClass("BX.desktop")){return BX.desktop.isFeatureEnabled("mask")}else if(BX.getClass("BX.Messenger.Lib.Utils.platform")){return BX.Messenger.Lib.Utils.platform.isDesktopFeatureEnabled("mask")}return false}open(e){e=BX.type.isPlainObject(e)?e:{};const t=BX.type.isStringFilled(e.tab)?e.tab:"background";if(!this.isAvailable()){if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=12398124")}return false}const i=`<div id="bx-desktop-loader" class="bx-desktop-loader-wrap">\n\t\t\t\t\t\t<div class="bx-desktop-loader">\n\t\t\t\t\t\t\t<svg class="bx-desktop-loader-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t\t\t<circle class="bx-desktop-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="placeholder"></div>`;const r=`BX.Runtime.loadExtension("im.v2.component.call-background").then(function(exports) {\n\t\t\t\tBX.Vue3.BitrixVue.createApp({\n\t\t\t\t\tcomponents: {CallBackground: exports.CallBackground},\n\t\t\t\t\ttemplate: '<CallBackground tab="${t}"/>',\n\t\t\t\t}).mount("#placeholder");\n\t\t\t});`;(opener||top).BX.desktop.createWindow("callBackground",BX.delegate((function(e){const t=this.isMaskAvailable()?BX.message("BXD_CALL_BG_MASK_TITLE"):BX.message("BXD_CALL_BG_TITLE");e.SetProperty("title",t);e.SetProperty("clientSize",{Width:943,Height:670});e.SetProperty("minClientSize",{Width:943,Height:670});e.SetProperty("backgroundColor","#2B3038");e.ExecuteCommand("center");e.ExecuteCommand("html.load",(opener||top).BXIM.desktop.getHtmlPage(i,r,false))}),this));return true}}BX.Call.Hardware=new i;BX.Call.Hardware.Events=t;BX.Call.Hardware.BackgroundDialog=new r})();
//# sourceMappingURL=hardware.map.js