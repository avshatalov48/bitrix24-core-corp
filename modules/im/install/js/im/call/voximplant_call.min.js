(function(){debug=false;BX.namespace("BX.Call");var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var t={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped"};var i=25e3;navigator["getDisplayMedia"]=function(){var e={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[{googTemporalLayeredScreencast:true}]}};return navigator.mediaDevices.getUserMedia(e)};BX.Call.VoximplantCall=function(e){BX.Call.PlainCall.superclass.constructor.apply(this,arguments);if(!window.VoxImplant){throw new Error("Voximplant SDK is not found")}this.voximplant=null;this.voximplantCall=null;this.signaling=new BX.Call.VoximplantCall.Signaling({call:this});this.peers={};this.voiceDetection=null;this.screenShared=false;this.deviceList=[];this.__onMicAccessResultHandler=this.__onMicAccessResult.bind(this);this.__onLocalDevicesUpdatedHandler=this.__onLocalDevicesUpdated.bind(this);this.__onLocalMediaRendererAddedHandler=this.__onLocalMediaRendererAdded.bind(this);this.__onBeforeLocalMediaRendererRemovedHandler=this.__onBeforeLocalMediaRendererRemoved.bind(this);this.init();this.ping();this.pingInterval=setInterval(this.ping.bind(this),i)};BX.extend(BX.Call.VoximplantCall,BX.Call.AbstractCall);BX.Call.VoximplantCall.prototype.init=function(){this.users.forEach(function(e){this.peers[e]=this.createPeer(e)},this)};BX.Call.VoximplantCall.prototype.ping=function(){this.signaling.sendPing({userId:this.users})};BX.Call.VoximplantCall.prototype.createPeer=function(e){return new BX.Call.VoximplantCall.Peer({call:this,userId:e,ready:e==this.initiatorId,onStreamReceived:function(e){this.runCallback(BX.Call.Event.onStreamReceived,e)}.bind(this),onStreamRemoved:function(e){this.runCallback(BX.Call.Event.onStreamRemoved,e)}.bind(this),onStateChanged:this.__onPeerStateChanged.bind(this)})};BX.Call.VoximplantCall.prototype.getUsers=function(){var e={};for(var t in this.peers){e[t]=this.peers[t].calculatedState}return e};BX.Call.VoximplantCall.prototype.getClient=function(){var e=this;return new Promise(function(t,i){if(e.voximplant){return t()}BX.Voximplant.getClient().then(function(i){e.voximplant=i;e.voximplant.enableSilentLogging();e.voximplant.setLoggerCallback(function(t){if(e.debug){e.log(t.label+": "+t.message)}});e.bindClientEvents();t()}).catch(function(e){i(e)})})};BX.Call.VoximplantCall.prototype.bindClientEvents=function(){this.voximplant.addEventListener(VoxImplant.Events.MicAccessResult,this.__onMicAccessResultHandler);var e=VoxImplant.Hardware.StreamManager.get();e.on(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler)};BX.Call.VoximplantCall.prototype.removeClientEvents=function(){if(this.voximplant){this.voximplant.removeEventListener(VoxImplant.Events.MicAccessResult,this.__onMicAccessResultHandler)}var e=VoxImplant.Hardware.StreamManager.get();e.off(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler)};BX.Call.VoximplantCall.prototype.setMuted=function(e){if(this.muted==e){return}this.muted=e;if(this.voximplantCall){if(this.muted){this.voximplantCall.muteMicrophone()}else{this.voximplantCall.unmuteMicrophone()}}};BX.Call.VoximplantCall.prototype.setVideoEnabled=function(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.voximplantCall){this.voximplantCall.sendVideo(this.videoEnabled);if(!this.videoEnabled){this.voximplantCall.sendVideo(this.videoEnabled)}}};BX.Call.VoximplantCall.prototype.setCameraId=function(e){if(this.cameraId==e){return}this.cameraId=e;if(this.voximplantCall){VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(this.voximplantCall,{cameraId:this.cameraId})}};BX.Call.VoximplantCall.prototype.setMicrophoneId=function(e){if(this.microphoneId==e){return}this.microphoneId=e;if(this.voximplantCall){VoxImplant.Hardware.AudioDeviceManager.get().setCallAudioSettings(this.voximplantCall,{inputId:this.microphoneId})}};BX.Call.VoximplantCall.prototype.startScreenSharing=function(){if(!this.voximplantCall){return}this.voximplantCall.shareScreen(true).then(function(){this.screenShared=true}.bind(this))};BX.Call.VoximplantCall.prototype.stopScreenSharing=function(){if(!this.voximplantCall){return}this.voximplantCall.stopSharingScreen();this.screenShared=false;this.runCallback(BX.Call.Event.onLocalMediaStopped,{tag:"screen"})};BX.Call.VoximplantCall.prototype.isScreenSharingStarted=function(){return this.screenShared};BX.Call.VoximplantCall.prototype.inviteUsers=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}var i=BX.type.isArray(e.users)?e.users:this.users;this.attachToConference().then(function(){return t.signaling.inviteUsers({userIds:i,video:t.videoEnabled?"Y":"N"})}).then(function(e){for(var n=0;n<i.length;n++){if(!t.peers[i[n]]){t.peers[i[n]]=t.createPeer(i[n]);t.runCallback(BX.Call.Event.onUserInvited,{userId:i[n]})}t.peers[i[n]].onInvited()}}).catch(function(e){t.runCallback(BX.Call.Event.onCallFailure,{error:e})})};BX.Call.VoximplantCall.prototype.answer=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}this.videoEnabled=e.useVideo==true;this.signaling.sendAnswer();this.attachToConference().catch(function(e){t.runCallback(BX.Call.Event.onCallFailure,{error:e})})};BX.Call.VoximplantCall.prototype.decline=function(){this.ready=false;BX.ajax.runAction(e.decline,{data:{callId:this.id,callInstanceId:this.instanceId}}).then(function(){this.destroy()}.bind(this))};BX.Call.VoximplantCall.prototype.hangup=function(e,t){var i=this;return new Promise(function(n,a){var l={};if(typeof e!="undefined"){l.code=e}if(typeof t!="undefined"){l.reason=t}i.signaling.sendHangup(l);if(i.voximplantCall){if(i.voximplantCall.state()!="ENDED"){i.voximplantCall.hangup()}}return n()})};BX.Call.VoximplantCall.prototype.attachToConference=function(){var e=this;return new Promise(function(t,i){if(e.voximplantCall){return t()}e.getClient().then(function(){if(!e.voximplant._config.experiments){e.voximplant._config.experiments={}}e.voximplantCall=e.voximplant.callConference({number:"bx_conf_"+e.id,video:{sendVideo:e.videoEnabled,receiveVideo:true},customData:null});e.bindCallEvents();var n=function(){e.log("Call connected");e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,a);if(e.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then(function(t){e.deviceList=t;e.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:e.deviceList})})}t()};var a=function(t){e.log("Could not attach to conference",t);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,a);i(t)};e.voximplantCall.addEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.addEventListener(VoxImplant.CallEvents.Failed,a)}).catch(function(t){var i;if(typeof t==="string"){e.runCallback(BX.Call.Event.onCallFailure,{error:t})}else if(BX.type.isPlainObject(t)){if(t.hasOwnProperty("status")&&t.status==401){i="AUTHORIZE_ERROR"}else if(t.name==="AuthResult"){i="AUTHORIZE_ERROR"}else{i="UNKNOWN_ERROR"}e.runCallback(BX.Call.Event.onCallFailure,{error:i})}})})};BX.Call.VoximplantCall.prototype.bindCallEvents=function(){this.voximplantCall.addEventListener(VoxImplant.CallEvents.Disconnected,this.__onCallDisconnected.bind(this));this.voximplantCall.addEventListener(VoxImplant.CallEvents.MessageReceived,this.__onCallMessageReceived.bind(this));this.voximplantCall.addEventListener(VoxImplant.CallEvents.EndpointAdded,this.__onCallEndpointAdded.bind(this))};BX.Call.VoximplantCall.prototype.isAnyoneParticipating=function(){for(var e in this.peers){if(this.peers[e].isParticipating()){return true}}return false};BX.Call.VoximplantCall.prototype.attachVoiceDetection=function(e){if(this.voiceDetection){this.voiceDetection.destroy()}this.voiceDetection=new BX.SimpleVAD({mediaStream:e,onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)})};BX.Call.VoximplantCall.prototype.onLocalVoiceStarted=function(e){this.signaling.sendVoiceStarted()};BX.Call.VoximplantCall.prototype.onLocalVoiceStopped=function(e){this.signaling.sendVoiceStopped()};BX.Call.VoximplantCall.prototype.__onPeerStateChanged=function(e){this.runCallback(BX.Call.Event.onUserStateChanged,e);if(e.state==BX.Call.UserState.Failed){if(!this.isAnyoneParticipating()){this.hangup()}}};BX.Call.VoximplantCall.prototype.__onPullEvent=function(e,t,i){var n={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::finish":this.__onPullEventFinish.bind(this)};if(n[e]){n[e].call(this,t)}};BX.Call.VoximplantCall.prototype.__onPullEventAnswer=function(e){var t=e.senderId;if(t===this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.peers[t]){return}this.peers[t].setReady(true)};BX.Call.VoximplantCall.prototype.__onPullEventAnswerSelf=function(e){if(e.callInstanceId===this.instanceId){return}this.destroy()};BX.Call.VoximplantCall.prototype.__onPullEventHangup=function(e){var t=e.senderId;if(this.userId==t&&this.instanceId!=e.callInstanceId){this.destroy();return}if(!this.peers[t])return;this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()){this.hangup()}};BX.Call.VoximplantCall.prototype.__onPullEventUsersInvited=function(e){this.log("__onPullEventUsersInvited",e);var t=e.users;for(var i=0;i<t.length;i++){var n=t[i];if(this.peers[n]){if(this.peers[n].calculatedState===BX.Call.UserState.Failed||this.peers[n].calculatedState===BX.Call.UserState.Idle){this.peers[n].onInvited()}}else{this.peers[n]=this.createPeer(n);this.runCallback(BX.Call.Event.onUserInvited,{userId:n});this.peers[n].onInvited()}}};BX.Call.VoximplantCall.prototype.__onPullEventFinish=function(e){this.destroy()};BX.Call.VoximplantCall.prototype.__onMicAccessResult=function(e){this.log("__onMicAccessResult",e);if(e.result){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"main",stream:e.stream})}else{this.log("Could not get access to media input devices",e)}};BX.Call.VoximplantCall.prototype.__onLocalDevicesUpdated=function(e){this.log("__onLocalDevicesUpdated",e)};BX.Call.VoximplantCall.prototype.__onLocalMediaRendererAdded=function(e){this.log("__onLocalMediaRendererAdded",e);var t=e.renderer;if(t.kind==="sharing"){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"screen",stream:t.stream})}};BX.Call.VoximplantCall.prototype.__onBeforeLocalMediaRendererRemoved=function(e){this.log("__onBeforeLocalMediaRendererRemoved",e);var t=e.renderer;if(t.kind==="sharing"){this.runCallback(BX.Call.Event.onLocalMediaStopped,{tag:"screen"})}};BX.Call.VoximplantCall.prototype.__onCallDisconnected=function(e){this.log("__onCallDisconnected",e);this.destroy()};BX.Call.VoximplantCall.prototype.__onCallEndpointAdded=function(e){this.log("__onCallEndpointAdded",e);var t=this;var i=e.endpoint;var n=i.userName;if(BX.type.isNotEmptyString(n)&&n.substr(0,4)=="user"){var a=parseInt(n.substr(4));if(this.peers[a]){this.peers[a].setEndpoint(i)}}else{i.addEventListener(VoxImplant.EndpointEvents.InfoUpdated,function(e){this.log("VoxImplant.EndpointEvents.InfoUpdated",e);var t=e.endpoint;var i=t.userName;if(BX.type.isNotEmptyString(i)&&i.substr(0,4)=="user"){var n=parseInt(i.substr(4));if(this.peers[n]){this.peers[n].setEndpoint(t)}}}.bind(this));this.log("Unknown endpoint "+n)}};BX.Call.VoximplantCall.prototype.__onCallMessageReceived=function(e){var i;try{i=JSON.parse(e.text)}catch(e){this.log("Could not parse scenario message.",e)}var n=i.eventName;if(n===t.voiceStarted){this.runCallback(BX.Call.Event.onUserVoiceStarted,{userId:i.senderId})}else if(n===t.voiceStopped){this.runCallback(BX.Call.Event.onUserVoiceStopped,{userId:i.senderId})}else{this.log("Unknown scenario event")}};BX.Call.VoximplantCall.prototype.destroy=function(){if(this.voximplantCall){if(this.voximplantCall.state()!="ENDED"){this.voximplantCall.hangup()}}this.voximplantCall=null;for(var e in this.peers){if(this.peers.hasOwnProperty(e)){this.peers[e].destroy()}}this.removeClientEvents();clearInterval(this.pingInterval);this.runCallback(BX.Call.Event.onDestroy)};BX.Call.VoximplantCall.Signaling=function(e){this.call=e.call};BX.Call.VoximplantCall.Signaling.prototype.inviteUsers=function(t){return this.__runAjaxAction(e.invite,t)};BX.Call.VoximplantCall.Signaling.prototype.sendAnswer=function(t){return this.__runAjaxAction(e.answer,t)};BX.Call.VoximplantCall.Signaling.prototype.sendCancel=function(t){return this.__runAjaxAction(e.cancel,t)};BX.Call.VoximplantCall.Signaling.prototype.sendHangup=function(t){return this.__runAjaxAction(e.hangup,t)};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStarted=function(e){return this.__sendMessage(t.voiceStarted,e)};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStopped=function(e){return this.__sendMessage(t.voiceStopped,e)};BX.Call.VoximplantCall.Signaling.prototype.sendPing=function(t){this.__runAjaxAction(e.ping,{retransmit:false})};BX.Call.VoximplantCall.Signaling.prototype.__sendMessage=function(e,t){if(!this.call.voximplantCall){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))};BX.Call.VoximplantCall.Signaling.prototype.__runAjaxAction=function(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=BX.Call.Engine.getInstance().getUuidv4();return BX.ajax.runAction(e,{data:t})};BX.Call.VoximplantCall.Peer=function(e){this.userId=e.userId;this.call=e.call;this.ready=!!e.ready;this.calling=false;this.declined=false;this.inviteTimeout=false;this.endpoint=null;this.stream=null;this.tracks={audio:null,video:null,sharing:null};this.callingTimeout=0;this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing};this.__onEndpointRemoteMediaAddedHandler=this.__onEndpointRemoteMediaAdded.bind(this);this.__onEndpointRemoteMediaRemovedHandler=this.__onEndpointRemoteMediaRemoved.bind(this);this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.calculatedState=this.calculateState()};BX.Call.VoximplantCall.Peer.prototype={setReady:function(e){this.ready=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()},setDeclined:function(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()},setEndpoint:function(e){this.log("Adding endpoint with "+e.mediaRenderers.length+" media renderers");if(!this.ready){this.setReady(true)}if(this.endpoint){throw new Error("Endpoint already exists for user "+this.userId)}this.endpoint=e;for(var t=0;t<this.endpoint.mediaRenderers.length;t++){this.addMediaRenderer(this.endpoint.mediaRenderers[t]);if(this.endpoint.mediaRenderers[t].element){BX.remove(this.endpoint.mediaRenderers[t].element)}}this.bindEndpointEventHandlers()},addMediaRenderer:function(e){this.log("Adding media renderer");if(!this.stream){this.stream=new MediaStream}e.stream.getTracks().forEach(function(t){if(t.kind=="audio"){this.tracks.audio=t}else if(t.kind=="video"){if(e.kind=="sharing"){this.tracks.sharing=t}else{this.tracks.video=t}}else{this.log("Unknown track kind "+t.kind)}},this);this.updateMediaStream();this.updateCalculatedState()},updateMediaStream:function(){if(!this.stream){this.stream=new MediaStream}this.stream.getTracks().forEach(function(e){if(!this.hasTrack(e)){this.stream.removeTrack(e)}},this);if(this.tracks.audio&&!this.stream.getTrackById(this.tracks.audio.id)){this.stream.addTrack(this.tracks.audio)}if(this.tracks.sharing){if(this.tracks.video&&this.stream.getTrackById(this.tracks.video.id)){this.stream.removeTrack(this.tracks.video)}if(!this.stream.getTrackById(this.tracks.sharing.id)){this.stream.addTrack(this.tracks.sharing)}}else{if(this.tracks.video&&!this.stream.getTrackById(this.tracks.video.id)){this.stream.addTrack(this.tracks.video)}}this.callbacks.onStreamReceived({userId:this.userId,stream:this.stream})},hasTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}if(this.tracks.kind&&this.tracks.kind.id==e.id){return true}}return false},removeTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}var i=this.tracks[t]?this.tracks[t].id:"";if(i==e.id){this.tracks[t]=null}}},bindEndpointEventHandlers:function(){this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},removeEndpointEventHandlers:function(){this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},calculateState:function(){if(this.stream)return BX.Call.UserState.Connected;if(this.endpoint)return BX.Call.UserState.Connecting;if(this.calling)return BX.Call.UserState.Calling;if(this.inviteTimeout)return BX.Call.UserState.Failed;if(this.declined)return BX.Call.UserState.Declined;if(this.ready)return BX.Call.UserState.Ready;return BX.Call.UserState.Idle},updateCalculatedState:function(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState});this.calculatedState=e}},isParticipating:function(){return(this.calling||this.ready||this.endpoint)&&!this.declined},onInvited:function(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(this.onInviteTimeout.bind(this),3e4);this.updateCalculatedState()},onInviteTimeout:function(){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;this.updateCalculatedState()},__onEndpointRemoteMediaAdded:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaAdded",e);this.addMediaRenderer(e.mediaRenderer)},__onEndpointRemoteMediaRemoved:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, track id: "+e.mediaRenderer.stream.getTracks()[0].id,e);e.mediaRenderer.stream.getTracks().forEach(function(e){this.removeTrack(e)},this);if(this.stream){this.updateMediaStream()}this.updateCalculatedState()},__onEndpointRemoved:function(e){this.log("VoxImplant.EndpointEvents.Removed",e);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}if(this.stream){this.stream=null}for(var t in this.tracks){if(this.tracks.hasOwnProperty(t)){this.tracks[t]=null}}this.updateCalculatedState()},log:function(){this.call.log.apply(this.call,arguments)},destroy:function(){if(this.stream){this.stream=null}if(this.endpoint){this.endpoint=null}for(var e in this.tracks){if(this.tracks.hasOwnProperty(e)){this.tracks[e]=null}}clearTimeout(this.callingTimeout);this.callingTimeout=null}}})();
//# sourceMappingURL=voximplant_call.map.js