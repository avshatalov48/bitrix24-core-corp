this.BX=this.BX||{};(function(e,t,i,n,s,a,r,o,l,c,d,u,h){"use strict";function p(){if(window["BXDesktopSystem"]){navigator["getDisplayMedia"]=function(){var e={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[{googTemporalLayeredScreencast:true}]}};return navigator.mediaDevices.getUserMedia(e)}}}var v=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"isAvailable",value:function e(){return t.Utils.platform.getDesktopVersion()>=52}},{key:"isMaskAvailable",value:function e(){return t.Utils.platform.isDesktopFeatureEnabled("mask")}},{key:"open",value:function e(t){var i=this;t=l.Type.isPlainObject(t)?t:{};var n=l.Type.isStringFilled(t.tab)?t.tab:"background";if(!this.isAvailable()){if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=12398124")}return false}var s='<div id="bx-desktop-loader" class="bx-desktop-loader-wrap">\n\t\t\t\t<div class="bx-desktop-loader">\n\t\t\t\t\t<svg class="bx-desktop-loader-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t<circle class="bx-desktop-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="placeholder"></div>';var r='BX.Runtime.loadExtension("im.v2.component.call-background").then(function(exports) {\n\t\t\t\tBX.Vue3.BitrixVue.createApp({\n\t\t\t\t\tcomponents: {CallBackground: exports.CallBackground},\n\t\t\t\t\ttemplate: \'<CallBackground tab="'.concat(n,'"/>\',\n\t\t\t\t}).mount("#placeholder");\n\t\t\t});');a.DesktopApi.createWindow("callBackground",(function(e){var t=i.isMaskAvailable()?BX.message("BXD_CALL_BG_MASK_TITLE"):BX.message("BXD_CALL_BG_TITLE");e.SetProperty("title",t);e.SetProperty("clientSize",{Width:943,Height:670});e.SetProperty("minClientSize",{Width:943,Height:670});e.SetProperty("backgroundColor","#2B3038");e.ExecuteCommand("center");e.ExecuteCommand("html.load",a.DesktopApi.prepareHtml(s,r))}));return true}}]);return e}();var m=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.serviceUrl=t;this.token=i;this.socket=null;this.attempt=0;this.reconnectTimeout=null;this.unsentMessages=[];this.onSocketOpenHandler=this.onSocketOpen.bind(this);this.onSocketCloseHandler=this.onSocketClose.bind(this);this.onSocketErrorHandler=this.onSocketError.bind(this);this.connect()}babelHelpers.createClass(e,[{key:"log",value:function e(t){if(typeof t!="string"){console.error("Message should be string");return}if(this.isConnected){this.socket.send(JSON.stringify({action:"log",message:t}))}else{this.unsentMessages.push(t)}}},{key:"sendStat",value:function e(t){if(babelHelpers["typeof"](t)=="object"){t=JSON.stringify(t)}if(this.isConnected){this.socket.send(JSON.stringify({action:"stat",message:t}))}}},{key:"connect",value:function e(){if(this.socket){return}if(!this.serviceUrl){console.error("Logging service url is empty");return}if(!this.serviceUrl.startsWith("ws://")&&!this.serviceUrl.startsWith("wss://")){console.error("Logging service url should start with ws:// or wss://");return}if(!this.token){console.error("Logging token is empty");return}this.attempt++;this.socket=new WebSocket(this.serviceUrl+"?token="+this.token);this.bindSocketEvents()}},{key:"scheduleReconnect",value:function e(){clearTimeout(this.reconnectTimeout);if(this.attempt>3){console.error("Could not connect to the logging service, giving up");return}this.reconnectTimeout=setTimeout(this.connect.bind(this),this.getConnectionDelay(this.attempt)*1e3)}},{key:"getConnectionDelay",value:function e(t){switch(t){case 0:case 1:return 15;case 2:return 30;default:return 60}}},{key:"disconnect",value:function e(){clearTimeout(this.reconnectTimeout);if(this.socket){this.removeSocketEvents();this.socket.close(1e3);this.socket=null}}},{key:"bindSocketEvents",value:function e(){this.socket.addEventListener("open",this.onSocketOpenHandler);this.socket.addEventListener("close",this.onSocketCloseHandler);this.socket.addEventListener("error",this.onSocketErrorHandler)}},{key:"removeSocketEvents",value:function e(){this.socket.removeEventListener("open",this.onSocketOpenHandler);this.socket.removeEventListener("close",this.onSocketCloseHandler);this.socket.removeEventListener("error",this.onSocketErrorHandler)}},{key:"onSocketOpen",value:function e(){this.attempt=0;for(var t=0;t<this.unsentMessages.length;t++){this.socket.send(JSON.stringify({action:"log",message:this.unsentMessages[t]}))}this.unsentMessages=[]}},{key:"onSocketClose",value:function e(){this.socket=null;this.scheduleReconnect()}},{key:"onSocketError",value:function e(){this.socket=null;this.scheduleReconnect()}},{key:"destroy",value:function e(){this.disconnect();this.unsentMessages=null}},{key:"isConnected",get:function e(){return this.socket&&this.socket.readyState===1}}]);return e}();var f=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.id=t.id;this.instanceId=t.instanceId;this.parentId=t.parentId||null;this.direction=t.direction;this.type=BX.prop.getInteger(t,"type",gr.Instant);this.state=BX.prop.getString(t,"state",vr.Idle);this.ready=false;this.userId=Gr.getCurrentUserId();this.initiatorId=t.initiatorId||"";this.users=l.Type.isArray(t.users)?t.users.filter((function(e){return e!=i.userId})):[];this.associatedEntity=l.Type.isPlainObject(t.associatedEntity)?t.associatedEntity:{};this.startDate=new Date(BX.prop.getString(t,"startDate",""));this.videoEnabled=t.videoEnabled===true;this.videoHd=t.videoHd===true;this.cameraId=t.cameraId||"";this.microphoneId=t.microphoneId||"";this.muted=t.muted===true;this.wasConnected=false;this.logToken=t.logToken||"";if(Gr.getLogService()&&this.logToken){this.logger=new m(Gr.getLogService(),this.logToken)}this.localStreams={main:null,screen:null};this.eventListeners={};if(l.Type.isPlainObject(t.events)){this.initEventListeners(t.events)}this.connectionData=t.connectionData;this._microphoneLevel=0}babelHelpers.createClass(e,[{key:"initEventListeners",value:function e(t){for(var i in t){this.addEventListener(i,t[i])}}},{key:"addEventListener",value:function e(t,i){if(!l.Type.isArray(this.eventListeners[t])){this.eventListeners[t]=[]}if(l.Type.isFunction(i)){this.eventListeners[t].push(i)}}},{key:"removeEventListener",value:function e(t,i){if(l.Type.isArray(this.eventListeners[t])&&this.eventListeners[t].indexOf(i)>=0){var n=this.eventListeners[t].indexOf(i);if(n>=0){this.eventListeners[t].splice(n,1)}}}},{key:"runCallback",value:function e(t,i){if(l.Type.isArray(this.eventListeners[t])&&this.eventListeners[t].length>0){if(t===null||babelHelpers["typeof"](i)!=="object"){i={}}i.call=this;for(var n=0;n<this.eventListeners[t].length;n++){try{this.eventListeners[t][n].call(this,i)}catch(e){console.error(t+" callback error: ",e);this.log(t+" callback error: ",e)}}}}},{key:"getLocalStream",value:function e(t){return this.localStreams[t]}},{key:"setLocalStream",value:function e(t,i){i=i||"main";this.localStreams[i]=t}},{key:"isVideoEnabled",value:function e(){return this.videoEnabled}},{key:"isAnyoneParticipating",value:function e(){throw new Error("isAnyoneParticipating should be implemented")}},{key:"__onPullEvent",value:function e(t,i){throw new Error("__onPullEvent should be implemented")}},{key:"inviteUsers",value:function e(){throw new Error("inviteUsers is not implemented")}},{key:"cancel",value:function e(){throw new Error("cancel is not implemented")}},{key:"answer",value:function e(){throw new Error("answer is not implemented")}},{key:"decline",value:function e(t,i){throw new Error("decline is not implemented")}},{key:"hangup",value:function e(){throw new Error("hangup is not implemented")}},{key:"log",value:function e(){var t=Do.getLogMessage.apply(null,arguments);if(a.DesktopApi.isDesktop()){a.DesktopApi.writeToLogFile(BX.message("USER_ID")+".video.log",t.substr(3))}if(Gr.debugFlag&&console){var i=["Call log ["+Do.getTimeForLog()+"]: "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(t)}if(BX.MessengerDebug){BX.MessengerDebug.addLog(this.id,t)}}},{key:"destroy",value:function e(){if(this.logger){this.logger.destroy();this.logger=null}this.state=vr.Finished;this.runCallback(Sr.onDestroy)}},{key:"provider",get:function e(){throw new Error("must be overwritten")}},{key:"microphoneLevel",get:function e(){return this._microphoneLevel},set:function e(t){if(t!=this._microphoneLevel){this._microphoneLevel=t;this.runCallback(Sr.onMicrophoneLevel,{level:t})}}}]);return e}();var g=function(){function e(t){babelHelpers.classCallCheck(this,e);this.data={id:BX.prop.getInteger(t,"id",t.id),name:BX.prop.getString(t,"name",""),avatar:BX.prop.getString(t,"avatar",""),gender:BX.prop.getString(t,"gender",""),state:BX.prop.getString(t,"state",mr.Idle),talking:BX.prop.getBoolean(t,"talking",false),cameraState:BX.prop.getBoolean(t,"cameraState",true),microphoneState:BX.prop.getBoolean(t,"microphoneState",true),screenState:BX.prop.getBoolean(t,"screenState",false),videoPaused:BX.prop.getBoolean(t,"videoPaused",false),floorRequestState:BX.prop.getBoolean(t,"floorRequestState",false),localUser:BX.prop.getBoolean(t,"localUser",false),centralUser:BX.prop.getBoolean(t,"centralUser",false),pinned:BX.prop.getBoolean(t,"pinned",false),presenter:BX.prop.getBoolean(t,"presenter",false),order:BX.prop.getInteger(t,"order",false),allowRename:BX.prop.getBoolean(t,"allowRename",false),wasRenamed:BX.prop.getBoolean(t,"wasRenamed",false),renameRequested:BX.prop.getBoolean(t,"renameRequested",false),direction:BX.prop.getString(t,"direction",fr.SendRecv)};for(var i in this.data){if(this.data.hasOwnProperty(i)){Object.defineProperty(this,i,{get:this._getField(i).bind(this),set:this._setField(i).bind(this)})}}this.onUpdate={talking:this._onUpdateTalking.bind(this),state:this._onUpdateState.bind(this)};this.talkingStop=null;this.eventEmitter=new r.EventEmitter(this,"UserModel")}babelHelpers.createClass(e,[{key:"_getField",value:function e(t){return function(){return this.data[t]}}},{key:"_setField",value:function e(t){return function(e){var i=this.data[t];if(i==e){return}this.data[t]=e;if(this.onUpdate.hasOwnProperty(t)){this.onUpdate[t](e,i)}this.eventEmitter.emit("changed",{user:this,fieldName:t,oldValue:i,newValue:e})}}},{key:"_onUpdateTalking",value:function e(t){if(t){this.floorRequestState=false}else{this.talkingStop=(new Date).getTime()}}},{key:"_onUpdateState",value:function e(t){if(t!=mr.Connected){this.talking=false;this.screenState=false}}},{key:"wasTalkingAgo",value:function e(){if(this.state!=mr.Connected){return+Infinity}if(this.talking){return 0}if(!this.talkingStop){return+Infinity}return(new Date).getTime()-this.talkingStop}},{key:"subscribe",value:function e(t,i){this.eventEmitter.subscribe(t,i)}},{key:"unsubscribe",value:function e(t,i){this.eventEmitter.unsubscribe(t,i)}}]);return e}();var b=function(e){babelHelpers.inherits(t,e);function t(){var e;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.setEventNamespace("BX.Call.UserRegistry");e.users=l.Type.isArray(i.users)?i.users:[];e._sort();return e}babelHelpers.createClass(t,[{key:"get",value:function e(t){for(var i=0;i<this.users.length;i++){if(this.users[i].id==t){return this.users[i]}}return null}},{key:"push",value:function e(t){if(!(t instanceof g)){throw Error("user should be instance of UserModel")}this.users.push(t);this._sort();t.subscribe("changed",this._onUserChanged.bind(this));this.emit("userAdded",{user:t})}},{key:"_onUserChanged",value:function e(t){if(t.data.fieldName==="order"){this._sort()}this.emit("userChanged",t.data)}},{key:"_sort",value:function e(){this.users=this.users.sort((function(e,t){return e.order-t.order}))}}]);return t}(r.EventEmitter);function C(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);if("attrNS"in t&&l.Type.isObject(t.attrNS)){for(var n in t.attrNS){if(t.attrNS.hasOwnProperty(n)){i.setAttributeNS(null,n,t.attrNS[n])}}}l.Dom.adjust(i,t);return i}var k=function(){function e(t){babelHelpers.classCallCheck(this,e);this.elements={root:null};this.text=l.Type.isStringFilled(t.text)?t.text:"";this.isGroupCall=t.isGroupCall}babelHelpers.createClass(e,[{key:"render",value:function e(){this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-title"},html:this.getTitle()});return this.elements.root}},{key:"getTitle",value:function e(){var t='<span class="bx-messenger-videocall-panel-title-name">'+l.Text.encode(this.text)+"</span>";if(this.isGroupCall){return BX.message("IM_M_GROUP_CALL_WITH").replace("#CHAT_NAME#",t)}else{return BX.message("IM_M_CALL_WITH").replace("#USER_NAME#",t)}}}]);return e}();var y=function(){function e(t){babelHelpers.classCallCheck(this,e);this["class"]=t["class"];this.backgroundClass=BX.prop.getString(t,"backgroundClass","");this.backgroundClass="bx-messenger-videocall-panel-icon-background"+(this.backgroundClass?" ":"")+this.backgroundClass;this.blocked=t.blocked===true;this.text=BX.prop.getString(t,"text","");this.isActive=false;this.counter=BX.prop.getInteger(t,"counter",0);this.elements={root:null,counter:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing),onMouseOver:BX.prop.getFunction(t,"onMouseOver",BX.DoNothing),onMouseOut:BX.prop.getFunction(t,"onMouseOut",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t;if(this.text!==""){t=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})}else{t=null}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item"+(this.blocked?" blocked":"")},children:[l.Dom.create("div",{props:{className:this.backgroundClass},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-"+this["class"]},children:[this.elements.counter=l.Dom.create("span",{props:{className:"bx-messenger-videocall-panel-item-counter"},text:0,dataset:{counter:0,counterType:"digits"}})]})]}),t,l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-bottom-spacer"}})],events:{click:this.callbacks.onClick,mouseover:this.callbacks.onMouseOver,mouseout:this.callbacks.onMouseOut}});if(this.isActive){this.elements.root.classList.add("active")}if(this.counter){this.setCounter(this.counter)}return this.elements.root}},{key:"setActive",value:function e(t){if(this.isActive==t){return}this.isActive=t;if(!this.elements.root){return}if(this.isActive){this.elements.root.classList.add("active")}else{this.elements.root.classList.remove("active")}}},{key:"setBlocked",value:function e(t){if(this.blocked==t){return}this.blocked=t;if(this.blocked){this.elements.root.classList.add("blocked")}else{this.elements.root.classList.remove("blocked")}}},{key:"setCounter",value:function e(t){this.counter=parseInt(t,10);var i=this.counter;if(i>999){i=999}var n="digits";if(i.toString().length===2){n="dozens"}else if(i.toString().length>2){n="hundreds"}this.elements.counter.dataset.counter=i;this.elements.counter.dataset.counterType=n;this.elements.counter.innerText=i}}]);return e}();var S=function(){function e(t){babelHelpers.classCallCheck(this,e);this["class"]=t["class"];this.text=t.text;this.enabled=t.enabled===true;this.arrowEnabled=t.arrowEnabled===true;this.arrowHidden=t.arrowHidden===true;this.blocked=t.blocked===true;this.showLevel=t.showLevel===true;this.level=t.level||0;this.sideIcon=BX.prop.getString(t,"sideIcon","");this.elements={root:null,iconContainer:null,icon:null,arrow:null,levelMeter:null,pointer:null,ellipsis:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing),onArrowClick:BX.prop.getFunction(t,"onArrowClick",BX.DoNothing),onSideIconClick:BX.prop.getFunction(t,"onSideIconClick",BX.DoNothing),onMouseOver:BX.prop.getFunction(t,"onMouseOver",BX.DoNothing),onMouseOut:BX.prop.getFunction(t,"onMouseOut",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{id:"bx-messenger-videocall-panel-item-with-arrow-"+this["class"],className:"bx-messenger-videocall-panel-item-with-arrow"+(this.blocked?" blocked":"")},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-left"},children:[this.elements.iconContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-icon-container"},children:[this.elements.icon=l.Dom.create("div",{props:{className:this.getIconClass()}})]}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})]})],events:{click:this.callbacks.onClick,mouseover:this.callbacks.onMouseOver,mouseout:this.callbacks.onMouseOut}});this.elements.arrow=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-right"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-right-icon"}})],events:{click:function(e){this.callbacks.onArrowClick.apply(this,arguments);e.stopPropagation()}.bind(this)}});if(!this.arrowHidden){this.elements.root.appendChild(this.elements.arrow)}if(this.showLevel){this.elements.icon.appendChild(C("svg",{attrNS:{class:"bx-messenger-videocall-panel-item-level-meter-container",width:3,height:20},children:[C("g",{attrNS:{fill:"#30B1DC"},children:[C("rect",{attrNS:{x:0,y:0,width:3,height:20,rx:1.5,opacity:.1}}),this.elements.levelMeter=C("rect",{attrNS:{x:0,y:20,width:3,height:20,rx:1.5}})]})]}))}this.elements.ellipsis=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon-ellipsis"},events:{click:this.callbacks.onSideIconClick}});this.elements.pointer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon-pointer"},events:{click:this.callbacks.onSideIconClick}});if(this.sideIcon=="pointer"){BX.Dom.insertAfter(this.elements.pointer,this.elements.icon)}else if(this.sideIcon=="ellipsis"){BX.Dom.insertAfter(this.elements.ellipsis,this.elements.icon)}return this.elements.root}},{key:"getIconClass",value:function e(){return"bx-messenger-videocall-panel-item-with-arrow-icon bx-messenger-videocall-panel-item-with-arrow-icon-"+this["class"]+(this.enabled?"":"-off")}},{key:"enable",value:function e(){if(this.enabled){return}this.enabled=true;this.elements.icon.className=this.getIconClass();if(this.elements.levelMeter){this.elements.levelMeter.setAttribute("y",Math.round((1-this.level)*20))}}},{key:"disable",value:function e(){if(!this.enabled){return}this.enabled=false;this.elements.icon.className=this.getIconClass();if(this.elements.levelMeter){this.elements.levelMeter.setAttribute("y",20)}}},{key:"setBlocked",value:function e(t){if(this.blocked==t){return}this.blocked=t;this.elements.icon.className=this.getIconClass();if(this.blocked){this.elements.root.classList.add("blocked")}else{this.elements.root.classList.remove("blocked")}}},{key:"setSideIcon",value:function e(t){if(this.sideIcon==t){return}this.sideIcon=t;BX.Dom.remove(this.elements.pointer);BX.Dom.remove(this.elements.ellipsis);if(this.sideIcon=="pointer"){BX.Dom.insertAfter(this.elements.pointer,this.elements.icon)}else if(this.sideIcon=="ellipsis"){BX.Dom.insertAfter(this.elements.ellipsis,this.elements.icon)}}},{key:"showArrow",value:function e(){if(!this.arrowHidden){return}this.arrowHidden=false;this.elements.root.appendChild(this.elements.arrow)}},{key:"hideArrow",value:function e(){if(this.arrowHidden){return}this.arrowHidden=false;this.elements.root.removeChild(this.elements.arrow)}},{key:"setLevel",value:function e(t){this.level=Math.log(t*100)/4.6;if(this.showLevel&&this.enabled){this.elements.levelMeter.setAttribute("y",Math.round((1-this.level)*20))}}}]);return e}();var w=function(){function e(t){babelHelpers.classCallCheck(this,e);this.language=t.language}babelHelpers.createClass(e,[{key:"render",value:function e(){return l.Dom.create("div",{props:{className:"bx-messenger-videocall-watermark"},children:[l.Dom.create("img",{props:{className:"bx-messenger-videocall-watermark-img",src:this.getWatermarkUrl(this.language)}})]})}},{key:"getWatermarkUrl",value:function e(t){switch(t){case"ua":return"/bitrix/js/im/images/watermark-white-ua.svg";case"ru":case"kz":case"by":return"/bitrix/js/im/images/watermark-white-ru.svg";default:return"/bitrix/js/im/images/watermark-white-en.svg"}}}]);return e}();var I=function(){function e(t){babelHelpers.classCallCheck(this,e);this.iconClass=BX.prop.getString(t,"iconClass","");this.text=BX.prop.getString(t,"text","");this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing),onMouseOver:BX.prop.getFunction(t,"onMouseOver",BX.DoNothing),onMouseOut:BX.prop.getFunction(t,"onMouseOut",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){return l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon "+this.iconClass}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-text "},text:this.text})],events:{click:this.callbacks.onClick,mouseover:this.callbacks.onMouseOver,mouseout:this.callbacks.onMouseOut}})}}]);return e}();var M=function(){function e(t){babelHelpers.classCallCheck(this,e);this.iconClass=BX.prop.getString(t,"iconClass","");this.textClass=BX.prop.getString(t,"textClass","");this.text=BX.prop.getString(t,"text","");this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing),onMouseOver:BX.prop.getFunction(t,"onMouseOver",BX.DoNothing),onMouseOut:BX.prop.getFunction(t,"onMouseOut",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){return l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-frameless"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon "+this.iconClass}}),this.text!=""?l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-text "+this.textClass},text:this.text}):null],events:{click:this.callbacks.onClick,mouseover:this.callbacks.onMouseOver,mouseout:this.callbacks.onMouseOut}})}}]);return e}();var _=function(){function e(t){babelHelpers.classCallCheck(this,e);this.count=BX.prop.getInteger(t,"count",0);this.foldButtonState=BX.prop.getString(t,"foldButtonState",e.FoldButtonState.Hidden);this.allowAdding=BX.prop.getBoolean(t,"allowAdding",false);this.elements={root:null,leftContainer:null,rightContainer:null,foldIcon:null,count:null,separator:null};this.callbacks={onListClick:BX.prop.getFunction(t,"onListClick",BX.DoNothing),onAddClick:BX.prop.getFunction(t,"onAddClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function t(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants"},children:[this.elements.leftContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-inner left"+(this.foldButtonState!=e.FoldButtonState.Hidden?" active":"")},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon participants"}}),this.elements.count=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-text-count"},text:this.count}),this.elements.foldIcon=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-fold-icon "+this.foldButtonState}})],events:{click:this.callbacks.onListClick}})]});this.elements.separator=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-separator"}});this.elements.rightContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-inner active"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon add"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-text"},text:BX.message("IM_M_CALL_BTN_ADD")})],events:{click:this.callbacks.onAddClick}});if(this.allowAdding){this.elements.root.appendChild(this.elements.separator);this.elements.root.appendChild(this.elements.rightContainer)}return this.elements.root}},{key:"update",value:function t(i){this.count=BX.prop.getInteger(i,"count",this.count);this.foldButtonState=BX.prop.getString(i,"foldButtonState",this.foldButtonState);this.allowAdding=BX.prop.getBoolean(i,"allowAdding",this.allowAdding);this.elements.count.innerText=this.count;this.elements.foldIcon.className="bx-messenger-videocall-top-participants-fold-icon "+this.foldButtonState;if(this.foldButtonState==e.FoldButtonState.Hidden){this.elements.leftContainer.classList.remove("active")}else{this.elements.leftContainer.classList.add("active")}if(this.allowAdding&&!this.elements.separator.parentElement){this.elements.root.appendChild(this.elements.separator);this.elements.root.appendChild(this.elements.rightContainer)}if(!this.allowAdding&&this.elements.separator.parentElement){BX.remove(this.elements.separator);BX.remove(this.elements.rightContainer)}}}]);return e}();babelHelpers.defineProperty(_,"FoldButtonState",{Active:"active",Fold:"fold",Unfold:"unfold",Hidden:"hidden"});var T=function(){function e(t){babelHelpers.classCallCheck(this,e);this.count=BX.prop.getInteger(t,"count",0);this.elements={root:null,icon:null,text:null,arrow:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile"},children:[this.elements.icon=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-icon"}}),this.elements.text=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-text"},text:BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.count)}),this.elements.arrow=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-arrow"}})],events:{click:this.callbacks.onClick}});return this.elements.root}},{key:"setCount",value:function e(t){if(this.count==t){return}this.count=t;this.elements.text.innerText=BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.count)}}]);return e}();var E=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.recordState=t.recordState;this.updateViewInterval=null;this.elements={root:null,timeText:null,stateText:null};this.callbacks={onPauseClick:BX.prop.getFunction(t,"onPauseClick",BX.DoNothing),onStopClick:BX.prop.getFunction(t,"onStopClick",BX.DoNothing),onMouseOver:BX.prop.getFunction(t,"onMouseOver",BX.DoNothing),onMouseOut:BX.prop.getFunction(t,"onMouseOut",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus record-status-"+this.recordState.state+" "+(this.recordState.userId==this.userId?"":"record-user-viewer")},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-status"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon record-status"}})]}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-time"},children:[this.elements.timeText=l.Dom.create("span",{props:{className:"bx-messenger-videocall-top-recordstatus-time-text"},text:this.getTimeText()}),l.Dom.create("span",{props:{className:"bx-messenger-videocall-top-recordstatus-time-separator"},html:" &ndash; "}),this.elements.stateText=l.Dom.create("span",{props:{className:"bx-messenger-videocall-top-recordstatus-time-state"},text:BX.message("IM_M_CALL_RECORD_TITLE")})]}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-buttons"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-separator"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon record-pause"}})],events:{click:this.callbacks.onPauseClick}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-separator"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon record-stop"}})],events:{click:this.callbacks.onStopClick}})]})],events:{mouseover:this.callbacks.onMouseOver,mouseout:this.callbacks.onMouseOut}});return this.elements.root}},{key:"getTimeText",value:function e(){if(this.recordState.state===Rt.RecordState.Stopped){return""}var t=new Date;var i=new Date(this.recordState.date.start);if(i.getTime()<t.getDate()){i=t}var n=this.recordState.date.pause.map((function(e){var i=e.finish?new Date(e.finish):t;return i-new Date(e.start)})).reduce((function(e,t){return e+t}),0);var s=t-i-n;if(s<=0){s=0}var a=Math.floor(s/1e3);var r=Math.floor(a/60/60);if(r>0){a-=r*60*60}var o=Math.floor(a/60);if(o>0){a-=o*60}return(r>0?r+":":"")+(r>0?o.toString().padStart(2,"0")+":":o+":")+a.toString().padStart(2,"0")}},{key:"update",value:function e(t){if(this.recordState.state!==t.state){clearInterval(this.updateViewInterval);if(t.state===Rt.RecordState.Started){this.updateViewInterval=setInterval(this.updateView.bind(this),1e3)}}this.recordState=t;this.updateView()}},{key:"updateView",value:function e(){var t=this.getTimeText();if(this.elements.timeText.innerText!==t){this.elements.timeText.innerText=this.getTimeText()}if(!this.elements.root.classList.contains("record-status-"+this.recordState.state)){this.elements.root.className="bx-messenger-videocall-top-recordstatus record-status-"+this.recordState.state+" "+(this.recordState.userId==this.userId?"":"record-user-viewer")}}},{key:"stopViewUpdate",value:function e(){if(this.updateViewInterval){clearInterval(this.updateViewInterval);this.updateViewInterval=null}}}]);return e}();var R=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userModel=t.userModel;this.elements={root:null,avatar:null,avatarOutline:null,userName:null,userStatus:null,menuArrow:null,floorRequest:null,mic:null,cam:null};this._onUserFieldChangeHandler=this._onUserFieldChange.bind(this);this.userModel.subscribe("changed",this._onUserFieldChangeHandler);this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile"},children:[this.elements.avatar=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-avatar"+(this.userModel.talking?" talking":"")},children:[this.elements.floorRequest=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-floor-request bx-messenger-videocall-floor-request-icon"}})]}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-body"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-text"},children:[this.elements.mic=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-icon"+(this.userModel.microphoneState?"":" bx-call-view-icon-red-microphone-off")}}),this.elements.cam=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-icon"+(this.userModel.cameraState?"":" bx-call-view-icon-red-camera-off")}}),this.elements.userName=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-username"},text:this.userModel.name}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-menu-arrow"}})]}),this.elements.userStatus=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-user-status"},text:this.userModel.pinned?BX.message("IM_M_CALL_PINNED_USER"):BX.message("IM_M_CALL_CURRENT_PRESENTER")})]})],events:{click:this.callbacks.onClick}});return this.elements.root}},{key:"update",value:function e(){if(!this.elements.root){return}this.elements.userName.innerText=this.userModel.name;if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('"+this.userModel.avatar+"')")}else{this.elements.root.style.removeProperty("--avatar")}this.elements.avatar.classList.toggle("talking",this.userModel.talking);this.elements.floorRequest.classList.toggle("active",this.userModel.floorRequestState);this.elements.mic.classList.toggle("bx-call-view-icon-red-microphone-off",!this.userModel.microphoneState);this.elements.cam.classList.toggle("bx-call-view-icon-red-camera-off",!this.userModel.cameraState);this.elements.userStatus.innerText=this.userModel.pinned?BX.message("IM_M_CALL_PINNED_USER"):BX.message("IM_M_CALL_CURRENT_PRESENTER")}},{key:"mount",value:function e(t){t.appendChild(this.render())}},{key:"dismount",value:function e(){if(!this.elements.root){return}l.Dom.remove(this.elements.root)}},{key:"setUserModel",value:function e(t){this.userModel.unsubscribe("changed",this._onUserFieldChangeHandler);this.userModel=t;this.userModel.subscribe("changed",this._onUserFieldChangeHandler);this.update()}},{key:"_onUserFieldChange",value:function e(t){this.update()}}]);return e}();var P=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userRegistry=t.userRegistry;this.userRegistry.subscribe("userAdded",this._onUserAdded.bind(this));this.userRegistry.subscribe("userChanged",this._onUserChanged.bind(this));this.elements={root:null,users:{}}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-selector-mobile"}});this.updateUsers();return this.elements.root}},{key:"renderUser",value:function e(t){return C("svg",{attrNS:{width:14.5,height:11.6},style:{order:t.order},children:[C("circle",{attrNS:{class:"bx-messenger-videocall-user-selector-mobile-border"+(t.talking?" talking":""),cx:7.25,cy:5.8,r:4.6}}),C("circle",{attrNS:{class:"bx-messenger-videocall-user-selector-mobile-dot"+(t.centralUser?" pinned":""),cx:7.25,cy:5.8,r:3.3}})]})}},{key:"updateUsers",value:function e(){this.userRegistry.users.forEach((function(e){if(e.localUser||e.state!=mr.Connected){if(this.elements.users[e.id]){BX.remove(this.elements.users[e.id]);this.elements.users[e.id]=null}}else{var t=this.renderUser(e);if(this.elements.users[e.id]){BX.replace(this.elements.users[e.id],t)}else{this.elements.root.appendChild(t)}this.elements.users[e.id]=t}}),this)}},{key:"_onUserAdded",value:function e(t){this.updateUsers()}},{key:"_onUserChanged",value:function e(t){this.updateUsers()}},{key:"mount",value:function e(t){t.appendChild(this.render())}},{key:"dismount",value:function e(){if(!this.elements.root){return}BX.remove(this.elements.root)}}]);return e}();var B=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t.parent||null;this.content=t.content||null;this.elements={background:null,root:null,handle:null,body:null};this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing),onDestroy:BX.prop.getFunction(t,"onDestroy",BX.DoNothing)};this.touchStartY=0;this.processedTouchId=0}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.background=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-background"},events:{click:this._onBackgroundClick.bind(this)}});this.elements.root=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-container"},children:[this.elements.handle=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-handle"}}),this.elements.body=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu"},children:[this.content]})],events:{touchstart:this._onTouchStart.bind(this),touchmove:this._onTouchMove.bind(this),touchend:this._onTouchEnd.bind(this)}});return this.elements.root}},{key:"show",value:function e(){if(this.parent){this.render();this.parent.appendChild(this.elements.root);this.parent.appendChild(this.elements.background)}}},{key:"close",value:function e(){BX.remove(this.elements.root);BX.remove(this.elements.background);this.callbacks.onClose()}},{key:"closeWithAnimation",value:function e(){if(!this.elements.root){return}this.elements.root.classList.add("closing");this.elements.background.classList.add("closing");this.elements.root.addEventListener("animationend",function(){this.close()}.bind(this))}},{key:"_onTouchStart",value:function e(t){this.touchStartY=t.pageY;if(this.processedTouchId||t.touches.length>1){return}if(t.target==this.elements.header||t.target==this.elements.root||this.elements.body.scrollTop===0){this.processedTouchId=t.touches[0].identifier}}},{key:"_onTouchMove",value:function e(t){if(t.touches.length>1){return}if(t.touches[0].identifier!=this.processedTouchId){return}var i=this.touchStartY-t.pageY;if(i>0){i=0}this.elements.root.style.bottom=i+"px";if(i){t.preventDefault()}}},{key:"_onTouchEnd",value:function e(t){var i=false;for(var n=0;n<t.changedTouches.length;n++){if(t.changedTouches[n].identifier==this.processedTouchId){i=true;break}}if(!i){return}var s=t.pageY-this.touchStartY;if(s>100){this.closeWithAnimation();t.preventDefault()}else{this.elements.root.style.removeProperty("bottom")}this.processedTouchId=0;this.touchStartY=0}},{key:"destroy",value:function e(){this.callbacks.onDestroy();this.elements={};this.callbacks={};this.parent=null}},{key:"_onBackgroundClick",value:function e(){this.closeWithAnimation()}}]);return e}();var H=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t.parent||null;this.header=BX.prop.getString(t,"header","");this.largeIcons=BX.prop.getBoolean(t,"largeIcons",false);this.slider=null;var i=BX.prop.getArray(t,"items",[]);if(i.length===0){throw Error("Items array should not be empty")}this.items=i.filter((function(e){return babelHelpers["typeof"](e)==="object"&&!!e})).map((function(e){return new D(e)}));this.elements={root:null,header:null,body:null};this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing),onDestroy:BX.prop.getFunction(t,"onDestroy",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this;this.elements.header=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-header"},text:this.header});this.elements.body=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-body"+(this.largeIcons?" bx-videocall-mobile-menu-large":"")}});this.items.forEach((function(e){if(e){t.elements.body.appendChild(e.render())}}));return BX.createFragment([this.elements.header,this.elements.body])}},{key:"setHeader",value:function e(t){this.header=t;if(this.elements.header){this.elements.header.innerText=t}}},{key:"show",value:function e(){if(!this.slider){this.slider=new B({parent:this.parent,content:this.render(),onClose:this.onSliderClose.bind(this),onDestroy:this.onSliderDestroy.bind(this)})}this.slider.show()}},{key:"close",value:function e(){if(this.slider){this.slider.close()}}},{key:"onSliderClose",value:function e(){this.slider.destroy()}},{key:"onSliderDestroy",value:function e(){this.slider=null;this.destroy()}},{key:"destroy",value:function e(){if(this.slider){this.slider.destroy()}this.slider=null;this.items.forEach((function(e){e.destroy()}));this.items=[];this.callbacks.onDestroy();this.elements={};this.callbacks={};this.parent=null}}]);return e}();var D=function(){function e(t){babelHelpers.classCallCheck(this,e);this.id=BX.prop.getString(t,"id",Util.getUuidv4());this.icon=BX.prop.getString(t,"icon","");this.iconClass=BX.prop.getString(t,"iconClass","");this.text=BX.prop.getString(t,"text","");this.showSubMenu=BX.prop.getBoolean(t,"showSubMenu",false);this.separator=BX.prop.getBoolean(t,"separator",false);this.enabled=BX.prop.getBoolean(t,"enabled",true);this.userModel=BX.prop.get(t,"userModel",null);if(this.userModel){this._userChangeHandler=this._onUserChange.bind(this);this.subscribeUserEvents();this.text=this.userModel.name;this.icon=this.userModel.avatar;this.iconClass="user-avatar"}this.elements={root:null,icon:null,content:null,submenu:null,separator:null,mic:null,cam:null};this.callbacks={click:BX.prop.getFunction(t,"onClick",BX.DoNothing),clickSubMenu:BX.prop.getFunction(t,"onClickSubMenu",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}if(this.separator){this.elements.root=l.Dom.create("hr",{props:{className:"bx-videocall-mobile-menu-item-separator"}})}else{this.elements.root=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item"+(this.enabled?"":" disabled")},children:[this.elements.icon=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-icon "+this.iconClass}}),this.elements.content=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-content"},children:[l.Dom.create("span",{text:this.text})]})],events:{click:this.callbacks.click}});if(this.icon!=""){this.elements.icon.style.backgroundImage='url("'+this.icon+'")'}if(this.showSubMenu){this.elements.submenu=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-submenu-icon"}});this.elements.root.appendChild(this.elements.submenu)}if(this.userModel){this.elements.mic=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-icon-user bx-call-view-icon-red-microphone-off"}});this.elements.cam=l.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-icon-user bx-call-view-icon-red-camera-off"}});if(!this.userModel.cameraState){this.elements.content.prepend(this.elements.cam)}if(!this.userModel.microphoneState){this.elements.content.prepend(this.elements.mic)}}}return this.elements.root}},{key:"updateUserIcons",value:function e(){if(!this.userModel){return}if(this.userModel.microphoneState){BX.remove(this.elements.mic)}else{this.elements.content.prepend(this.elements.mic)}if(this.userModel.cameraState){BX.remove(this.elements.cam)}else{this.elements.content.prepend(this.elements.cam)}}},{key:"subscribeUserEvents",value:function e(){this.userModel.subscribe("changed",this._userChangeHandler)}},{key:"_onUserChange",value:function e(t){this.updateUserIcons()}},{key:"destroy",value:function e(){if(this.userModel){this.userModel.unsubscribe("changed",this._userChangeHandler);this.userModel=null}this.callbacks=null;this.elements=null}}]);return e}();function L(e){console.error("Playback start error: ",e)}function x(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=A(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var s=function e(){};return{s:s,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,r=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){r=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(r)throw o}}}}function A(e,t){if(!e)return;if(typeof e==="string")return N(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return N(e,t)}function N(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function U(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function V(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?U(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):U(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function F(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */F=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",r=s.asyncIterator||"@@asyncIterator",o=s.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,s){var a=t&&t.prototype instanceof h?t:h,r=Object.create(a.prototype),o=new M(s||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function d(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u={};function h(){}function p(){}function v(){}var m={};l(m,a,(function(){return this}));var f=Object.getPrototypeOf,g=f&&f(f(_([])));g&&g!==t&&i.call(g,a)&&(m=g);var b=v.prototype=h.prototype=Object.create(m);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function s(n,a,r,o){var l=d(e[n],e,a);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==babelHelpers["typeof"](u)&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){s("next",e,r,o)}),(function(e){s("throw",e,r,o)})):t.resolve(u).then((function(e){c.value=e,r(c)}),(function(e){return s("throw",e,r,o)}))}o(l.arg)}var a;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){s(i,n,e,t)}))}return a=a?a.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(s,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===s)throw a;return T()}for(i.method=s,i.arg=a;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===u)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=d(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===u)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),u;var s=d(n,e.iterator,t.arg);if("throw"===s.type)return t.method="throw",t.arg=s.arg,t.delegate=null,u;var a=s.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,u):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function M(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function _(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return s.next=s}}return{next:T}}function T(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,s,a){void 0===a&&(a=Promise);var r=new k(c(t,i,n,s),a);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,a,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=_,M.prototype={constructor:M,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function s(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a],o=r.completion;if("root"===r.tryLoc)return s("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return s(r.catchLoc,!0);if(this.prev<r.finallyLoc)return s(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return s(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return s(r.finallyLoc)}}}},abrupt:function e(t,n){for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s];if(a.tryLoc<=this.prev&&i.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var r=a;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,u):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),u},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),u}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var s=n.completion;if("throw"===s.type){var a=s.arg;I(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:_(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),u}},e}function O(e,t){W(e,t);t.add(e)}function X(e,t,i){W(e,t);t.set(e,i)}function W(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function G(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var z={Camera:1,Microphone:2,Screen:3};var j=function e(t,i){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id",null);babelHelpers.defineProperty(this,"source","");babelHelpers.defineProperty(this,"track",{});this.id=t;this.source=i.source;this.track=i};var q=function e(t){babelHelpers.classCallCheck(this,e);this.text=t.message;this.from=t.senderSid;this.timestamp=Math.floor(Date.now()/1e3)};var K={HIGH:2,MEDIUM:1,LOW:0};var J={CONNECTED:"Connected",PROGRESSING:"Progressing",TERMINATED:"Terminated"};var Y={INITIAL:"",ENABLE:"enable",DISABLE:"disable"};var Q=new WeakMap;var Z=new WeakSet;var $=new WeakSet;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ne=new WeakSet;var se=new WeakSet;var ae=new WeakSet;var re=new WeakSet;var oe=new WeakSet;var le=new WeakSet;var ce=new WeakSet;var de=new WeakSet;var ue=new WeakSet;var he=new WeakSet;var pe=new WeakSet;var ve=new WeakSet;var me=new WeakSet;var fe=new WeakSet;var ge=new WeakSet;var be=new WeakSet;var Ce=new WeakSet;var ke=new WeakSet;var ye=new WeakSet;var Se=function(){function e(){babelHelpers.classCallCheck(this,e);O(this,ye);O(this,ke);O(this,Ce);O(this,be);O(this,ge);O(this,fe);O(this,me);O(this,ve);O(this,pe);O(this,he);O(this,ue);O(this,de);O(this,ce);O(this,le);O(this,oe);O(this,re);O(this,ae);O(this,se);O(this,ne);O(this,ie);O(this,te);O(this,ee);O(this,$);O(this,Z);babelHelpers.defineProperty(this,"sender",null);babelHelpers.defineProperty(this,"recipient",null);X(this,Q,{writable:true,value:{logs:{},isloggingEnable:true,loggerCallback:null,isWaitAnswer:false,prevPacketsLost:{},prevPacketsReceived:{},prevParticipantsWithLargeDataLoss:new Set,tracksDataFromSocket:{},realTracksIds:{},url:null,roomId:null,token:null,endpoint:null,jwt:null,options:null,iceServers:null,socketConnect:null,peerConnectionFailed:false,pendingCandidates:{recipient:[],sender:[]},pendingPublications:{},publicationTimeout:1e4,cameraStream:null,microphoneStream:null,screenStream:null,localTracks:{},rtt:0,pingIntervalDuration:0,pingTimeoutDuration:0,remoteTracks:{},remoteParticipants:{},mainStream:{},pingPongTimeout:null,pingPongInterval:null,userData:"",myUserId:"",defaultVideoResolution:{width:1280,height:720},defaultSimulcastBitrate:{q:12e4,h:3e5,f:1e6},defaultRemoteStreamsQuality:K.MEDIUM,audioBitrate:7e4,videoBitrate:15e5,screenBitrate:15e5,videoSimulcast:true,screenSimulcast:false,events:new Map,offersStack:0,audioDeviceId:"",videoDeviceId:"",isReconnecting:false,reconnectionAttempt:0,reconnectionTimeout:null,reconnectionDelay:1e3,callStatsInterval:null,callState:"",packetLostThreshold:7,statsTimeout:3e3,videoQueue:Y.INITIAL}});this.sendLeaveBound=G(this,ye,Ye).bind(this)}babelHelpers.createClass(e,[{key:"connect",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i=this;var n,s;return F().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:this.setLog("Connecting to a call (desktop: ".concat(window["BXDesktopSystem"]?"true":"false",")"));babelHelpers.classPrivateFieldGet(this,Q).callState=J.PROGRESSING;for(n in t){babelHelpers.classPrivateFieldGet(this,Q)["".concat(n)]=t[n]}if(babelHelpers.classPrivateFieldGet(this,Q).endpoint){a.next=7;break}this.setLog("Missing required param 'endpoint' from the backend, disconnecting");this.triggerEvents("Failed",[{name:"AUTHORIZE_ERROR",message:"Missing required param 'endpoint'"}]);return a.abrupt("return");case 7:if(babelHelpers.classPrivateFieldGet(this,Q).jwt){a.next=11;break}this.setLog("Missing required param 'jwt' from the backend, disconnecting");this.triggerEvents("Failed",[{name:"AUTHORIZE_ERROR",message:"Missing required param 'jwt'"}]);return a.abrupt("return");case 11:babelHelpers.classPrivateFieldGet(this,Q).endpoint=babelHelpers.classPrivateFieldGet(this,Q).endpoint.replace(/\/+$/,"");a.prev=12;a.next=15;return this.getMediaServerInfo();case 15:s=a.sent;babelHelpers.classPrivateFieldGet(this,Q).url=s.url;babelHelpers.classPrivateFieldGet(this,Q).token=s.token;babelHelpers.classPrivateFieldGet(this,Q).data=s.data;a.next=25;break;case 21:a.prev=21;a.t0=a["catch"](12);if(!babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){try{fetch("".concat(babelHelpers.classPrivateFieldGet(this,Q).endpoint,"/send-to-log"),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify({roomId:babelHelpers.classPrivateFieldGet(this,Q).roomId,token:babelHelpers.classPrivateFieldGet(this,Q).jwt,data:"Can't connect to a mediaserver: ".concat(a.t0)})})}finally{this.triggerEvents("Failed",[a.t0])}}else{G(this,Z,we).call(this)}return a.abrupt("return");case 25:babelHelpers.classPrivateFieldGet(this,Q).socketConnect=new WebSocket("".concat(babelHelpers.classPrivateFieldGet(this,Q).url,"?access_token=").concat(babelHelpers.classPrivateFieldGet(this,Q).token,"&auto_subscribe=1&sdk=js&version=1.6.7&protocol=8&roomData=").concat(babelHelpers.classPrivateFieldGet(this,Q).data));babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onmessage=function(e){return i.socketOnMessageHandler(e)};babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onopen=function(){return i.socketOnOpenHandler()};babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onerror=function(){return i.socketOnErrorHandler()};babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onclose=function(e){return i.socketOnCloseHandler(e)};case 30:case"end":return a.stop()}}),e,this,[[12,21]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getMediaServerInfo",value:function e(){var t=this;return new Promise(function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(i,n){var s,a,r;var o,l,c;return F().wrap((function e(d){while(1)switch(d.prev=d.next){case 0:o="".concat(babelHelpers.classPrivateFieldGet(t,Q).endpoint,"/join?token=").concat(babelHelpers.classPrivateFieldGet(t,Q).jwt);d.prev=1;d.next=4;return fetch(o,{method:"GET"});case 4:l=d.sent;if(l.ok){d.next=7;break}throw new Error("Got response code ".concat(l.status));case 7:d.next=13;break;case 9:d.prev=9;d.t0=d["catch"](1);n({name:"MEDIASERVER_UNREACHABLE",message:d.t0.message});return d.abrupt("return");case 13:d.prev=13;d.next=16;return l.json();case 16:c=d.sent;d.next=23;break;case 19:d.prev=19;d.t1=d["catch"](13);n({name:"MEDIASERVER_UNEXPECTED_ANSWER",message:d.t1.message});return d.abrupt("return");case 23:if((s=c.result)!==null&&s!==void 0&&s.mediaServerUrl&&(a=c.result)!==null&&a!==void 0&&a.tokenToAccessMediaServer&&(r=c.result)!==null&&r!==void 0&&r.roomData){i({url:c.result.mediaServerUrl,token:c.result.tokenToAccessMediaServer,data:c.result.roomData})}else{n({name:"MEDIASERVER_MISSING_PARAMS",message:"Incorrect signaling response"})}case 24:case"end":return d.stop()}}),e,null,[[1,9],[13,19]])})));return function(t,i){return e.apply(this,arguments)}}())}},{key:"sendOffer",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;return F().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:if(!(babelHelpers.classPrivateFieldGet(this,Q).offersStack>0&&!babelHelpers.classPrivateFieldGet(this,Q).isWaitAnswer)){i.next=20;break}this.setLog("Start sending an offer");babelHelpers.classPrivateFieldGet(this,Q).isWaitAnswer=true;babelHelpers.classPrivateFieldGet(this,Q).offersStack--;i.prev=4;i.next=7;return this.sender.createOffer();case 7:t=i.sent;i.next=10;return this.sender.setLocalDescription(t);case 10:G(this,ke,Je).call(this,{offer:t});this.setLog("Sending an offer succeed");i.next=20;break;case 14:i.prev=14;i.t0=i["catch"](4);this.setLog("Sending an offer failed: ".concat(i.t0));babelHelpers.classPrivateFieldGet(this,Q).isWaitAnswer=false;i.next=20;return this.sendOffer();case 20:case"end":return i.stop()}}),e,this,[[4,14]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"startStream",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t,i;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:n.next=2;return this.getLocalVideo();case 2:t=n.sent;if(!t){n.next=8;break}n.next=6;return this.publishTrack(z.Camera,t);case 6:n.next=10;break;case 8:G(this,be,qe).call(this,z.Camera);this.triggerEvents("PublishFailed",[z.Camera]);case 10:n.next=12;return this.getLocalAudio();case 12:i=n.sent;if(!i){n.next=18;break}n.next=16;return this.publishTrack(z.Microphone,i);case 16:n.next=20;break;case 18:G(this,be,qe).call(this,z.Microphone);this.triggerEvents("PublishFailed",[z.Microphone]);case 20:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"socketOnMessageHandler",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i,n,s,a=this,r,o,l,c,d,u,h,p,v,m,f;var g,b,C,k,y,S,w,I,M,_,T,E,R,P,B,H,D,L,x,A,N,U,O,X,W,j,K,Y,te;return F().wrap((function e(F){while(1)switch(F.prev=F.next){case 0:if(!(typeof t.data!=="string")){F.next=2;break}return F.abrupt("return");case 2:F.prev=2;g=JSON.parse(t.data);F.next=10;break;case 6:F.prev=6;F.t0=F["catch"](2);this.setLog("Could not parse a socket message: ".concat(t.data));return F.abrupt("return");case 10:if(!((i=g)!==null&&i!==void 0&&i.answer)){F.next=15;break}F.next=13;return G(this,ue,Ue).call(this,g);case 13:F.next=120;break;case 15:if(!((n=g)!==null&&n!==void 0&&n.offer)){F.next=20;break}F.next=18;return G(this,he,Fe).call(this,g);case 18:F.next=120;break;case 20:if(!((s=g)!==null&&s!==void 0&&s.joinResponse)){F.next=34;break}babelHelpers.classPrivateFieldGet(this,Q).iceServers=g.joinResponse.iceServers;babelHelpers.classPrivateFieldGet(this,Q).myUserId=g.joinResponse.localParticipant.userId;babelHelpers.classPrivateFieldGet(this,Q).callState=J.CONNECTED;G(this,fe,ze).call(this);if(babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){babelHelpers.classPrivateFieldGet(this,Q).isReconnecting=false;this.setLog("Reconnected to a mediaserver after ".concat(babelHelpers.classPrivateFieldGet(this,Q).reconnectionAttempt," attempts"));this.triggerEvents("Reconnected");babelHelpers.classPrivateFieldGet(this,Q).reconnectionAttempt=0}else{this.setLog("Connected to room ".concat(babelHelpers.classPrivateFieldGet(this,Q).roomId," on a mediaserver"));this.triggerEvents("Connected")}b=V({},babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants);Object.values(g.joinResponse.otherParticipants).forEach((function(e){if(b[e.userId]){delete b[e.userId]}a.setLog("Adding an early connected participant with id ".concat(e.userId," (sid: ").concat(e.sid,")"));G(a,ve,We).call(a,e)}));for(C in b){k=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[C];this.setLog("Deleting a missing participant with id ".concat(k.userId," (sid: ").concat(k.sid,")"));this.triggerEvents("ParticipantLeaved",[k]);delete babelHelpers.classPrivateFieldGet(this,Q).remoteTracks[C];delete babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[C]}babelHelpers.classPrivateFieldGet(this,Q).pingIntervalDuration=g.joinResponse.pingInterval*1e3;babelHelpers.classPrivateFieldGet(this,Q).pingTimeoutDuration=babelHelpers.classPrivateFieldGet(this,Q).pingIntervalDuration*2;G(this,ie,Te).call(this);F.next=120;break;case 34:if(!((r=g)!==null&&r!==void 0&&r.participantJoined)){F.next=39;break}this.setLog("Adding a new participant with id ".concat(g.participantJoined.participant.userId," (sid: ").concat(g.participantJoined.participant.sid,")"));G(this,ve,We).call(this,g.participantJoined.participant);F.next=120;break;case 39:if(!((o=g)!==null&&o!==void 0&&o.participantLeft)){F.next=45;break}S=(y=g)===null||y===void 0?void 0:y.participantLeft.userId;w=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[S];if(w){this.setLog("Deleting a participant with id ".concat(w.userId," (sid: ").concat(w.sid,")"));this.triggerEvents("ParticipantLeaved",[w]);delete babelHelpers.classPrivateFieldGet(this,Q).remoteTracks[S];delete babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[S]}else{this.setLog("Got participantLeft signal for non-existent participant with id ".concat(S," (sid: ").concat(g.participantLeft.sid,")"))}F.next=120;break;case 45:if(!((l=g)!==null&&l!==void 0&&l.trackCreated)){F.next=82;break}I=g.trackCreated.userId;M=g.trackCreated.cid;_=g.trackCreated.track;T=_.sid;_.userId=I;if(!(I===babelHelpers.classPrivateFieldGet(this,Q).myUserId)){F.next=64;break}E=babelHelpers.classPrivateFieldGet(this,Q).pendingPublications[M];if(!E){F.next=61;break}clearTimeout(babelHelpers.classPrivateFieldGet(this,Q).pendingPublications[M]);delete babelHelpers.classPrivateFieldGet(this,Q).pendingPublications[M];this.setLog("Publishing a local track with kind ".concat(_.source," succeed (sid: ").concat(g.trackCreated.track.sid,")"));babelHelpers.classPrivateFieldGet(this,Q).localTracks[_.source]=_;this.triggerEvents("PublishSucceed",[_.source]);if(_.source===z.Camera&&babelHelpers.classPrivateFieldGet(this,Q).videoQueue){G(this,oe,He).call(this)}return F.abrupt("return");case 61:this.setLog("Got a trackCreated signal for unknown publication ".concat(M," for track with kind ").concat(_.source));F.next=80;break;case 64:babelHelpers.classPrivateFieldGet(this,Q).tracksDataFromSocket[T]=_;R=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[I];if(!R){F.next=79;break}this.setLog("Got a track info with kind ".concat(_.source," (sid: ").concat(g.trackCreated.track.sid,") for a participant with id ").concat(I," (sid: ").concat(R.sid,"), waiting for it"));F.t1=_.source;F.next=F.t1===z.Camera?71:F.t1===z.Microphone?73:F.t1===z.Screen?75:77;break;case 71:R.videoEnabled=true;return F.abrupt("break",77);case 73:R.audioEnabled=true;return F.abrupt("break",77);case 75:R.screenSharingEnabled=true;return F.abrupt("break",77);case 77:F.next=80;break;case 79:this.setLog("Got a track info with kind ".concat(_.source," (sid: ").concat(g.trackCreated.track.sid,") without a participant"));case 80:F.next=120;break;case 82:if(!((c=g)!==null&&c!==void 0&&c.trackDeleted)){F.next=103;break}F.prev=83;D=(P=g)===null||P===void 0?void 0:P.trackDeleted.publisher;if(!(D===babelHelpers.classPrivateFieldGet(this,Q).myUserId)){F.next=87;break}return F.abrupt("return");case 87:this.setLog("Start deleting a track with id ".concat(g.trackDeleted.shortId," from ").concat(D,")"));L=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[D];if(L){F.next=92;break}this.setLog("Deleting a track with id ".concat(g.trackDeleted.shortId," failed: can't find a participant"));return F.abrupt("return");case 92:x=(B=g)===null||B===void 0?void 0:B.trackDeleted.shortId;A=(H=Object.values(L.tracks))===null||H===void 0?void 0:H.find((function(e){return(e===null||e===void 0?void 0:e.id)===x}));delete babelHelpers.classPrivateFieldGet(this,Q).tracksDataFromSocket[x];if(A){if(A.source===z.Microphone){L.audioEnabled=false}else if(A.source===z.Camera){L.videoEnabled=false}else if(A.source===z.Screen){L.screenSharingEnabled=false}L.removeTrack(A.source);this.setLog("Deleting a track with id ".concat(g.trackDeleted.shortId," succeed"));this.triggerEvents("RemoteMediaRemoved",[L,A])}else{this.setLog("Deleting a track with id ".concat(g.trackDeleted.shortId," failed: can't find a track"))}F.next=101;break;case 98:F.prev=98;F.t2=F["catch"](83);this.setLog("Deleting a track with id ".concat(g.trackDeleted.shortId," failed: ").concat(F.t2));case 101:F.next=120;break;case 103:if(!((d=g)!==null&&d!==void 0&&d.trackMuted)){F.next=119;break}U=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[g.trackMuted.track.publisher];if(!(g.trackMuted.track.publisher===babelHelpers.classPrivateFieldGet(this,Q).myUserId)){F.next=109;break}X=(O=Object.values(babelHelpers.classPrivateFieldGet(this,Q).localTracks))===null||O===void 0?void 0:O.find((function(e){return(e===null||e===void 0?void 0:e.sid)===g.trackMuted.track.shortId}));if(X){if(X.source===z.Camera){if(g.trackMuted.muted&&!X.muted){this.triggerEvents("PublishEnded",[X.source])}else if(!g.trackMuted.muted&&X.muted){this.triggerEvents("PublishSucceed",[X.source])}else{this.triggerEvents("PublishPaused",[X.source])}if(babelHelpers.classPrivateFieldGet(this,Q).videoQueue){G(this,oe,He).call(this)}}else if(X.source===z.Microphone){this.triggerEvents("PublishPaused",[X.source,g.trackMuted.muted])}}return F.abrupt("return");case 109:if(U){F.next=112;break}if(g.trackMuted.track.publisher!=babelHelpers.classPrivateFieldGet(this,Q).myUserId){this.setLog("Got mute signal (".concat(g.trackMuted.muted,") for a non-existent participant ").concat(g.trackMuted.track.publisher))}return F.abrupt("return");case 112:W=(N=Object.values(U.tracks))===null||N===void 0?void 0:N.find((function(e){return(e===null||e===void 0?void 0:e.id)===g.trackMuted.track.shortId}));if(W){F.next=116;break}this.setLog("Got mute signal (".concat(g.trackMuted.muted,") for a non-existent track ").concat(g.trackMuted.track.shortId));return F.abrupt("return");case 116:if(W.source===z.Microphone){U.isMutedAudio=g.trackMuted.muted;j=g.trackMuted.muted?"RemoteMediaMuted":"RemoteMediaUnmuted";this.setLog("Got mute signal (".concat(g.trackMuted.muted,") for ").concat(U.userId," (sid: ").concat(U.sid,")"));this.triggerEvents(j,[U,W])}else if(W.source===z.Camera){U.isMutedVideo=g.trackMuted.muted;K=g.trackMuted.muted?"RemoteMediaRemoved":"RemoteMediaAdded";this.setLog("Got mute signal (".concat(g.trackMuted.muted,") for ").concat(U.userId," (sid: ").concat(U.sid,")"));this.triggerEvents(K,[U,W])}F.next=120;break;case 119:if((u=g)!==null&&u!==void 0&&u.trickle){G(this,pe,Xe).call(this,g.trickle)}else if((h=g)!==null&&h!==void 0&&h.newMessage){Y=new q(g.newMessage);this.triggerEvents("MessageReceived",[Y])}else if((p=g)!==null&&p!==void 0&&p.handRaised){te=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[g.handRaised.participantId];if(te){te.isHandRaised=g.handRaised.isHandRaised;this.triggerEvents("HandRaised",[te])}}else if((v=g)!==null&&v!==void 0&&v.speakersChanged){G(this,me,Ge).call(this,g)}else if((m=g)!==null&&m!==void 0&&m.connectionQuality||(f=g)!==null&&f!==void 0&&f.subscribedQualityUpdate){console.log(g)}else if(g.pong){G(this,ee,Me).call(this)}else if(g.pongResp){babelHelpers.classPrivateFieldGet(this,Q).rtt=Date.now()-g.pongResp.lastPingTimestamp;G(this,ee,Me).call(this)}else if(g.leave){this.setLog("got leave signal with ".concat(g.leave.reason," reason"));if(g.leave.reason==="CHANGING_MEDIA_SERVER"){G(this,$,Ie).call(this);G(this,Z,we).call(this)}}case 120:case"end":return F.stop()}}),e,this,[[2,6],[83,98]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"socketOnOpenHandler",value:function e(){window.addEventListener("unload",this.sendLeaveBound)}},{key:"socketOnCloseHandler",value:function e(t){G(this,$,Ie).call(this);if(t!==null&&t!==void 0&&t.code&&(t===null||t===void 0?void 0:t.code)!==1005){this.setLog("Socket closed with a code ".concat(t.code,", reconnecting"));G(this,Z,we).call(this)}else{this.setLog("Socket closed with a code ".concat(t.code))}}},{key:"socketOnErrorHandler",value:function e(){this.setLog("Got a socket error");if(!this.isConnected()&&!babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){this.triggerEvents("Failed",[{name:"WEBSOCKET_ERROR"}])}}},{key:"onIceCandidate",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t,i){var n,s,a;var r;return F().wrap((function e(o){while(1)switch(o.prev=o.next){case 0:if(i.candidate){o.next=2;break}return o.abrupt("return");case 2:r={candidateInit:JSON.stringify({candidate:i.candidate.candidate,sdpMid:(n=i.candidate)===null||n===void 0?void 0:n.sdpMid,sdpMLineIndex:(s=i.candidate)===null||s===void 0?void 0:s.sdpMLineIndex,usernameFragment:(a=i.candidate)===null||a===void 0?void 0:a.usernameFragment})};if(t){r.target=t}G(this,ke,Je).call(this,{trickle:r});case 5:case"end":return o.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"onConnectionStateChange",value:function e(t){var i=t?this.recipient.connectionState:this.sender.connectionState;if(i==="failed"&&!babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){this.setLog("Peer connection state changed to 'failed', reconnecting");if(babelHelpers.classPrivateFieldGet(this,Q).peerConnectionFailed){return}babelHelpers.classPrivateFieldGet(this,Q).peerConnectionFailed=true;G(this,$,Ie).call(this);G(this,Z,we).call(this)}}},{key:"on",value:function e(t,i){babelHelpers.classPrivateFieldGet(this,Q).events.set(t,i);return this}},{key:"off",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,Q).events.has(t)){return babelHelpers.classPrivateFieldGet(this,Q).events["delete"](t)}return this}},{key:"triggerEvents",value:function e(t,i){if(babelHelpers.classPrivateFieldGet(this,Q).events.has(t)){var n=babelHelpers.classPrivateFieldGet(this,Q).events.get(t);if(i){n.apply(void 0,babelHelpers.toConsumableArray(i))}else{n()}}}},{key:"isRecordable",value:function e(){console.log("isRecordable")}},{key:"setBitrate",value:function e(t,i){var n=this;this.setLog("Start setting bitrate");var s;var a;switch(i){case z.Camera:s=babelHelpers.classPrivateFieldGet(this,Q).cameraStream.getVideoTracks[0];a=babelHelpers.classPrivateFieldGet(this,Q).videoSimulcast;break;case z.Microphone:s=babelHelpers.classPrivateFieldGet(this,Q).microphoneStream.getAudioTracks[0];break;case z.Screen:s=babelHelpers.classPrivateFieldGet(this,Q).screenStream.getVideoTracks[0];break}var r=this.sender.getSenders();r.forEach((function(e){var i=e.getParameters();if(!i||!i.encodings||i.encodings.length===0){n.setLog("Setting bitrate failed: has no encodings in the sender parameters")}else{i.encodings.forEach((function(e){if(a){e.maxBitrate=t<babelHelpers.classPrivateFieldGet(n,Q).defaultSimulcastBitrate[e.rid]?t:babelHelpers.classPrivateFieldGet(n,Q).defaultSimulcastBitrate[e.rid]}else{e.maxBitrate=t}}));e.setParameters(i);n.setLog("Setting bitrate succeed")}}))}},{key:"publishTrack",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t,i){var n,s,a,r,o,l,c,d,u,h,p,v,m=arguments;return F().wrap((function e(f){while(1)switch(f.prev=f.next){case 0:n=m.length>2&&m[2]!==undefined?m[2]:{};if(this.sender){f.next=4;break}this.setLog("Publishing a track before a peer connection was created, ignoring");return f.abrupt("return");case 4:this.setLog("Start publishing a track with kind ".concat(t));f.prev=5;for(s in n){babelHelpers.classPrivateFieldGet(this,Q)["".concat(s)]=n[s]}a=t;i.source=a;if(!(a===z.Camera)){f.next=42;break}if(!babelHelpers.classPrivateFieldGet(this,Q).videoSimulcast){f.next=26;break}r=i.getSettings().width;o=i.getSettings().height;l=G(this,Ce,Ke).call(this,z.Camera);if(!l){f.next=21;break}f.next=17;return l.replaceTrack(i);case 17:this.triggerEvents("PublishSucceed",[z.Camera]);return f.abrupt("return");case 21:this.sender.addTransceiver(i,{direction:"sendonly",streams:[babelHelpers.classPrivateFieldGet(this,Q).cameraStream],sendEncodings:i.sendEncodings||[{rid:"q",active:true,maxBitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate["q"],scaleResolutionDownBy:4},{rid:"h",active:true,maxBitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate["h"],scaleResolutionDownBy:2},{rid:"f",active:true,maxBitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate["f"]}]});G(this,ae,Pe).call(this,i.id,a);G(this,ke,Je).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:r,height:o,source:a,layers:[{quality:"LOW",width:r/4,height:o/4,bitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate.q},{quality:"MEDIUM",width:r/2,height:o/2,bitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate.h},{quality:"HIGH",width:r,height:o,bitrate:babelHelpers.classPrivateFieldGet(this,Q).defaultSimulcastBitrate.f}]}});case 24:f.next=40;break;case 26:c=G(this,Ce,Ke).call(this,z.Camera);if(!c){f.next=34;break}f.next=30;return c.replaceTrack(i);case 30:this.triggerEvents("PublishSucceed",[z.Camera]);return f.abrupt("return");case 34:this.sender.addTransceiver(i,{direction:"sendonly"});this.setBitrate(babelHelpers.classPrivateFieldGet(this,Q).videoBitrate,z.Camera);d=i.getSettings().width;u=i.getSettings().height;G(this,ae,Pe).call(this,i.id,a);G(this,ke,Je).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:d,height:u,source:a}});case 40:f.next=57;break;case 42:if(!(a===z.Microphone)){f.next=56;break}h=G(this,Ce,Ke).call(this,z.Microphone);if(!h){f.next=51;break}f.next=47;return h.replaceTrack(i);case 47:this.triggerEvents("PublishSucceed",[z.Microphone]);return f.abrupt("return");case 51:this.sender.addTransceiver(i,{direction:"sendonly"});G(this,ae,Pe).call(this,i.id,a);G(this,ke,Je).call(this,{addTrack:{cid:i.id,source:a}});case 54:f.next=57;break;case 56:if(a===z.Screen){this.sender.addTransceiver(i,{direction:"sendonly"});p=i.getSettings().width;v=i.getSettings().height;G(this,ae,Pe).call(this,i.id,a);G(this,ke,Je).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:p,height:v,source:a}})}case 57:babelHelpers.classPrivateFieldGet(this,Q).offersStack++;f.next=60;return this.sendOffer();case 60:f.next=67;break;case 62:f.prev=62;f.t0=f["catch"](5);this.setLog("Publishing a track with kind ".concat(t," failed: ").concat(f.t0));G(this,be,qe).call(this,t);this.triggerEvents("PublishFailed",[t]);case 67:case"end":return f.stop()}}),e,this,[[5,62]])})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"changeStreamQuality",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i,n,s;return F().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:a.t0=F().keys(t);case 1:if((a.t1=a.t0()).done){a.next=18;break}i=a.t1.value;if(!(babelHelpers.classPrivateFieldGet(this,Q)["".concat(i)]!==t[i])){a.next=16;break}babelHelpers.classPrivateFieldGet(this,Q)["".concat(i)]=t[i];if(!(i==="videoSimulcast"||i==="screenSimulcast"&&babelHelpers.classPrivateFieldGet(this,Q).screenStream)){a.next=12;break}n=i==="videoSimulcast"?z.Camera:z.Screen;if(!G(this,Ce,Ke).call(this,n)){a.next=10;break}a.next=10;return this.republishTrack(n);case 10:a.next=16;break;case 12:if(!["videoBitrate","audioBitrate","screenBitrate"].includes(i)){a.next=16;break}s=i==="videoBitrate"?z.Camera:i==="screenBitrate"?z.Screen:z.Microphone;a.next=16;return this.setBitrate(t[i],s);case 16:a.next=1;break;case 18:case"end":return a.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"republishTrack",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start republishing a track with kind ".concat(t));n.next=3;return this.unpublishTrack(t);case 3:n.next=5;return this.getTrack(t);case 5:i=n.sent;if(!i){n.next=11;break}n.next=9;return this.publishTrack(t,i);case 9:n.next=14;break;case 11:this.setLog("Republishing a track with kind ".concat(t," failed: ").concat(error));G(this,be,qe).call(this,t);this.triggerEvents("PublishFailed",[t]);case 14:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"unpublishTrack",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start unpublishing a track with kind ".concat(t));i=G(this,Ce,Ke).call(this,t);if(!i){n.next=10;break}this.sender.removeTrack(i);babelHelpers.classPrivateFieldGet(this,Q).offersStack++;n.next=7;return this.sendOffer();case 7:this.setLog("Unpublishing a track with kind ".concat(t," succeed"));n.next=11;break;case 10:this.setLog("Unpublishing a track with kind ".concat(t," failed: has no sender for a track"));case 11:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"hangup",value:function e(){this.setLog("Disconnecting from a call");G(this,ye,Ye).call(this);G(this,$,Ie).call(this);G(this,ge,je).call(this);clearTimeout(babelHelpers.classPrivateFieldGet(this,Q).reconnectionTimeout);babelHelpers.classPrivateFieldGet(this,Q).url=null;babelHelpers.classPrivateFieldGet(this,Q).token=null;babelHelpers.classPrivateFieldGet(this,Q).endpoint=null;babelHelpers.classPrivateFieldGet(this,Q).jwt=null;babelHelpers.classPrivateFieldGet(this,Q).options=null;babelHelpers.classPrivateFieldGet(this,Q).iceServers=null;G(this,be,qe).call(this,z.Camera);G(this,be,qe).call(this,z.Microphone);G(this,be,qe).call(this,z.Screen);babelHelpers.classPrivateFieldGet(this,Q).rtt=0;babelHelpers.classPrivateFieldGet(this,Q).remoteTracks={};babelHelpers.classPrivateFieldGet(this,Q).isReconnecting=false;babelHelpers.classPrivateFieldGet(this,Q).reconnectionAttempt=0;babelHelpers.classPrivateFieldGet(this,Q).mainStream={};if(this.isConnected()){babelHelpers.classPrivateFieldGet(this,Q).callState=J.TERMINATED;this.triggerEvents("Disconnected")}}},{key:"isConnected",value:function e(){return babelHelpers.classPrivateFieldGet(this,Q).callState===J.CONNECTED}},{key:"setMainStream",value:function e(t,i){this.setLog("Setting main stream for a participant width id ".concat(t," (sid: ").concat(babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[t].sid,")"));G(this,re,Be).call(this,t,i)}},{key:"resetMainStream",value:function e(){this.setLog("Resetting main stream");G(this,re,Be).call(this)}},{key:"removeTrack",value:function e(t){var i;var n=(i=babelHelpers.classPrivateFieldGet(this,Q).localTracks[t])===null||i===void 0?void 0:i.sid;if(n){delete babelHelpers.classPrivateFieldGet(this,Q).localTracks[t];G(this,ke,Je).call(this,{removeTrack:{sid:n}})}}},{key:"pauseTrack",value:function e(t,i){var n;var s=(n=babelHelpers.classPrivateFieldGet(this,Q).localTracks[t])===null||n===void 0?void 0:n.sid;if(s){this.setLog("Got pause signal (keep: ".concat(i,") for a track with kind ").concat(t," (id: ").concat(s,")"));if(!i){delete babelHelpers.classPrivateFieldGet(this,Q).localTracks[t]}G(this,ke,Je).call(this,{mute:{sid:s,muted:true}})}else{this.setLog("Got pause signal for a non-existent track with kind ".concat(t))}}},{key:"unpauseTrack",value:function e(t){var i;var n=(i=babelHelpers.classPrivateFieldGet(this,Q).localTracks[t])===null||i===void 0?void 0:i.sid;if(n){this.setLog("Got unpause signal for a track with kind ".concat(t," (id: ").concat(n,")"));G(this,ke,Je).call(this,{mute:{sid:n,muted:false}})}else{this.setLog("Got unpause signal for a non-existent track with kind ".concat(t))}}},{key:"disableAudio",value:function e(){var t;this.setLog("Start disabling audio");var i=(t=babelHelpers.classPrivateFieldGet(this,Q).microphoneStream)===null||t===void 0?void 0:t.getAudioTracks()[0];if(i){i.enabled=false;this.pauseTrack(z.Microphone,true)}else{this.setLog("Disabling audio failed: has no track")}}},{key:"enableAudio",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;var i;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start enabling audio");i=(t=babelHelpers.classPrivateFieldGet(this,Q).microphoneStream)===null||t===void 0?void 0:t.getAudioTracks()[0];if(!(i&&babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Microphone])){n.next=8;break}this.setLog("Enabling audio via unpause signal");i.enabled=true;this.unpauseTrack(z.Microphone);n.next=21;break;case 8:n.next=10;return this.getLocalAudio();case 10:i=n.sent;if(!i){n.next=18;break}this.setLog("Enabling audio via publish");i.enabled=true;n.next=16;return this.publishTrack(z.Microphone,i);case 16:n.next=21;break;case 18:this.setLog("Enabling audio failed: has no track");G(this,be,qe).call(this,z.Microphone);this.triggerEvents("PublishFailed",[z.Microphone]);case 21:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"disableVideo",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;var i,n;return F().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:if(!babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){s.next=2;break}return s.abrupt("return");case 2:i=babelHelpers.classPrivateFieldGet(this,Q).videoQueue!==Y.INITIAL;babelHelpers.classPrivateFieldGet(this,Q).videoQueue=Y.DISABLE;if(!i){s.next=6;break}return s.abrupt("return");case 6:this.setLog("Start disabling video");n=(t=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||t===void 0?void 0:t.getVideoTracks()[0];if(n){n.stop();babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Camera].muted=true;this.pauseTrack(z.Camera,true)}else{this.setLog("Disabling video failed: has no track")}case 9:case"end":return s.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"enableVideo",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;var i,n;return F().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:if(!babelHelpers.classPrivateFieldGet(this,Q).isReconnecting){s.next=2;break}return s.abrupt("return");case 2:i=babelHelpers.classPrivateFieldGet(this,Q).videoQueue!==Y.INITIAL;babelHelpers.classPrivateFieldGet(this,Q).videoQueue=Y.ENABLE;if(!i){s.next=6;break}return s.abrupt("return");case 6:this.setLog("Start enabling video");n=(t=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||t===void 0?void 0:t.getVideoTracks()[0];if(!(n&&babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Camera])){s.next=19;break}s.next=11;return this.getLocalVideo();case 11:n=s.sent;this.setLog("Enabling video via unpause signal");babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Camera].muted=false;s.next=16;return this.publishTrack(z.Camera,n);case 16:this.unpauseTrack(z.Camera);s.next=31;break;case 19:s.next=21;return this.getLocalVideo();case 21:n=s.sent;if(!n){s.next=28;break}this.setLog("Enabling video via publish");s.next=26;return this.publishTrack(z.Camera,n);case 26:s.next=31;break;case 28:this.setLog("Enabling video failed: has no track");G(this,be,qe).call(this,z.Camera);this.triggerEvents("PublishFailed",[z.Camera]);case 31:case"end":return s.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"startScreenShare",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;return F().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:this.setLog("Start enabling screen sharing");i.next=3;return this.getLocalScreen();case 3:t=i.sent;if(!t){i.next=9;break}i.next=7;return this.publishTrack(z.Screen,t);case 7:i.next=12;break;case 9:this.setLog("Enabling screen sharing failed: has no track");G(this,be,qe).call(this,z.Screen);this.triggerEvents("PublishFailed",[z.Screen]);case 12:case"end":return i.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"stopScreenShare",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){return F().wrap((function e(t){while(1)switch(t.prev=t.next){case 0:this.setLog("Start disabling screen sharing");G(this,be,qe).call(this,z.Screen);this.removeTrack(z.Screen);t.next=5;return this.unpublishTrack(z.Screen);case 5:case"end":return t.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"sendMessage",value:function e(t){G(this,ke,Je).call(this,{sendMessage:{message:t}})}},{key:"raiseHand",value:function e(t){G(this,ke,Je).call(this,{raiseHand:{raised:t}})}},{key:"getLocalVideo",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t,i;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(!(((t=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||t===void 0?void 0:t.getVideoTracks()[0].readyState)!=="live")){n.next=3;break}n.next=3;return this.getTrack(z.Camera);case 3:return n.abrupt("return",(i=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||i===void 0?void 0:i.getVideoTracks()[0]);case 4:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getLocalAudio",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;return F().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:if(babelHelpers.classPrivateFieldGet(this,Q).microphoneStream){i.next=3;break}i.next=3;return this.getTrack(z.Microphone);case 3:return i.abrupt("return",(t=babelHelpers.classPrivateFieldGet(this,Q).microphoneStream)===null||t===void 0?void 0:t.getAudioTracks()[0]);case 4:case"end":return i.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getLocalScreen",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(){var t;return F().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:if(babelHelpers.classPrivateFieldGet(this,Q).screenStream){i.next=3;break}i.next=3;return this.getTrack(z.Screen);case 3:return i.abrupt("return",(t=babelHelpers.classPrivateFieldGet(this,Q).screenStream)===null||t===void 0?void 0:t.getVideoTracks()[0]);case 4:case"end":return i.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getTrack",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i,n=this;var s,a,r,o,l;return F().wrap((function e(c){while(1)switch(c.prev=c.next){case 0:if(!(t===z.Camera&&((i=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||i===void 0?void 0:i.getVideoTracks().readyState)!=="live")){c.next=6;break}c.next=3;return G(this,le,De).call(this,{video:true});case 3:babelHelpers.classPrivateFieldGet(this,Q).cameraStream=c.sent;c.next=16;break;case 6:if(!(t===z.Microphone&&!babelHelpers.classPrivateFieldGet(this,Q).microphoneStream)){c.next=12;break}c.next=9;return G(this,le,De).call(this,{audio:true});case 9:babelHelpers.classPrivateFieldGet(this,Q).microphoneStream=c.sent;c.next=16;break;case 12:if(!(t===z.Screen&&!babelHelpers.classPrivateFieldGet(this,Q).screenStream)){c.next=16;break}c.next=15;return G(this,ce,xe).call(this);case 15:babelHelpers.classPrivateFieldGet(this,Q).screenStream=c.sent;case 16:if(t===z.Screen){s=(a=babelHelpers.classPrivateFieldGet(this,Q).screenStream)===null||a===void 0?void 0:a.getVideoTracks()[0];if(s&&s.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,Q).screenStream=null;s=this.getLocalScreen()}}else if(t===z.Camera){s=(r=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||r===void 0?void 0:r.getVideoTracks()[0];if(s&&s.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,Q).cameraStream=null;s=this.getLocalVideo()}}else if(t===z.Microphone){s=(o=babelHelpers.classPrivateFieldGet(this,Q).microphoneStream)===null||o===void 0?void 0:o.getAudioTracks()[0];if(s&&s.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,Q).microphoneStream=null;s=this.getLocalAudio()}}if(s&&!s.onended){l=t===z.Microphone;s.onended=function(){if(babelHelpers.classPrivateFieldGet(n,Q).localTracks[t]){babelHelpers.classPrivateFieldGet(n,Q).localTracks[t].muted=true}n.triggerEvents("PublishEnded",[t,l])}}return c.abrupt("return",s);case 19:case"end":return c.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"switchActiveAudioDevice",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i=this;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start switching an audio device");return n.abrupt("return",new Promise(function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(n,s){var a,r,o,l,c,d;return F().wrap((function e(u){while(1)switch(u.prev=u.next){case 0:babelHelpers.classPrivateFieldGet(i,Q).audioDeviceId=t;u.prev=1;r=(a=babelHelpers.classPrivateFieldGet(i,Q).microphoneStream)===null||a===void 0?void 0:a.getAudioTracks()[0];babelHelpers.classPrivateFieldGet(i,Q).microphoneStream=null;o=true;l="";if(r){o=r.enabled;l=r.id;r.stop()}u.next=9;return i.getLocalAudio();case 9:c=u.sent;c.source=z.Microphone;c.enabled=o;d=G(i,Ce,Ke).call(i,z.Microphone);if(!(d&&(i.isAudioPublished()||d.track.id!==c.id||c.id!==l))){u.next=18;break}i.setLog("Have sender for audio, start replacing track");u.next=17;return d.replaceTrack(c);case 17:n();case 18:i.setLog("Switching an audio device succeed");u.next=25;break;case 21:u.prev=21;u.t0=u["catch"](1);i.setLog("Switching an audio device failed: ".concat(u.t0));s(u.t0);case 25:case"end":return u.stop()}}),e,null,[[1,21]])})));return function(t,i){return e.apply(this,arguments)}}()));case 2:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"switchActiveVideoDevice",value:function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(t){var i=this;return F().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start switching a video device");return n.abrupt("return",new Promise(function(){var e=babelHelpers.asyncToGenerator(F().mark((function e(n,s){var a,r,o;return F().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:babelHelpers.classPrivateFieldGet(i,Q).videoDeviceId=t;l.prev=1;a=G(i,Ce,Ke).call(i,z.Camera);if(!(a&&i.isVideoPublished())){l.next=14;break}i.setLog("Have sender for video, start replacing track");(r=babelHelpers.classPrivateFieldGet(i,Q).cameraStream)===null||r===void 0?void 0:r.getVideoTracks()[0].stop();babelHelpers.classPrivateFieldGet(i,Q).cameraStream=null;l.next=9;return i.getLocalVideo();case 9:o=l.sent;o.source=z.Camera;l.next=13;return a.replaceTrack(o);case 13:n();case 14:i.setLog("Switching a video device succeed");l.next=21;break;case 17:l.prev=17;l.t0=l["catch"](1);i.setLog("Switching a video device failed: ".concat(l.t0));s(l.t0);case 21:case"end":return l.stop()}}),e,null,[[1,17]])})));return function(t,i){return e.apply(this,arguments)}}()));case 2:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"isAudioPublished",value:function e(){var t;return babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Microphone]&&((t=babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Microphone])===null||t===void 0?void 0:t.muted)!==true}},{key:"isVideoPublished",value:function e(){var t;return babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Camera]&&((t=babelHelpers.classPrivateFieldGet(this,Q).localTracks[z.Camera])===null||t===void 0?void 0:t.muted)!==true}},{key:"getLocalUserId",value:function e(){return babelHelpers.classPrivateFieldGet(this,Q).myUserId}},{key:"getParticipants",value:function e(){return babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants}},{key:"getState",value:function e(){return babelHelpers.classPrivateFieldGet(this,Q).callState}},{key:"setLog",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,Q).isloggingEnable){var i={timestamp:Math.floor(Date.now()/1e3),event:t};var n=Object.values(babelHelpers.classPrivateFieldGet(this,Q).logs).length;babelHelpers.classPrivateFieldGet(this,Q).logs[n]=i;var s=0;for(var a in babelHelpers.classPrivateFieldGet(this,Q).logs){if(G(this,de,Ne).call(this,babelHelpers.classPrivateFieldGet(this,Q).logs[a])){s=a}else{break}}if(s){babelHelpers.classPrivateFieldGet(this,Q).logs=Object.values(babelHelpers.classPrivateFieldGet(this,Q).logs).slice(s+1)}if(babelHelpers.classPrivateFieldGet(this,Q).loggerCallback){babelHelpers.classPrivateFieldGet(this,Q).loggerCallback()}}}},{key:"setLoggerCallback",value:function e(t){babelHelpers.classPrivateFieldGet(this,Q).loggerCallback=t}},{key:"enableSilentLogging",value:function e(t){babelHelpers.classPrivateFieldGet(this,Q).isloggingEnable=t}}]);return e}();function we(){var e=this;babelHelpers.classPrivateFieldGet(this,Q).isReconnecting=true;babelHelpers.classPrivateFieldGet(this,Q).videoQueue=Y.INITIAL;var t=function t(){e.setLog("Reconnecting attempt : ".concat(++babelHelpers.classPrivateFieldGet(e,Q).reconnectionAttempt));babelHelpers.classPrivateFieldGet(e,Q).reconnectionTimeout=setTimeout(e.connect.bind(e),babelHelpers.classPrivateFieldGet(e,Q).reconnectionDelay)};t();this.triggerEvents("Reconnecting")}function Ie(){window.removeEventListener("unload",this.sendLeaveBound);G(this,ne,Ee).call(this);G(this,te,_e).call(this);clearInterval(babelHelpers.classPrivateFieldGet(this,Q).callStatsInterval);babelHelpers.classPrivateFieldGet(this,Q).localTracks={};babelHelpers.classPrivateFieldGet(this,Q).isWaitAnswer=false;if(babelHelpers.classPrivateFieldGet(this,Q).socketConnect){babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onmessage=null;babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onopen=null;babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onerror=null;babelHelpers.classPrivateFieldGet(this,Q).socketConnect.onclose=null;babelHelpers.classPrivateFieldGet(this,Q).socketConnect.close();babelHelpers.classPrivateFieldGet(this,Q).socketConnect=null}}function Me(){var e=this;G(this,te,_e).call(this);if(!babelHelpers.classPrivateFieldGet(this,Q).pingTimeoutDuration){return}babelHelpers.classPrivateFieldGet(this,Q).pingTimeout=setTimeout((function(){e.setLog("Ping signal was not received, reconnecting");G(e,$,Ie).call(e);G(e,Z,we).call(e)}),babelHelpers.classPrivateFieldGet(this,Q).pingTimeoutDuration)}function _e(){if(babelHelpers.classPrivateFieldGet(this,Q).pingTimeout){clearTimeout(babelHelpers.classPrivateFieldGet(this,Q).pingTimeout)}}function Te(){var e=this;G(this,ne,Ee).call(this);G(this,ee,Me).call(this);if(!babelHelpers.classPrivateFieldGet(this,Q).pingIntervalDuration){return}babelHelpers.classPrivateFieldGet(this,Q).pingPongInterval=setInterval((function(){G(e,se,Re).call(e)}),babelHelpers.classPrivateFieldGet(this,Q).pingIntervalDuration)}function Ee(){G(this,te,_e).call(this);if(babelHelpers.classPrivateFieldGet(this,Q).pingPongInterval){clearInterval(babelHelpers.classPrivateFieldGet(this,Q).pingPongInterval)}}function Re(){G(this,ke,Je).call(this,{ping:Date.now()});G(this,ke,Je).call(this,{pingReq:{timestamp:Date.now(),rtt:babelHelpers.classPrivateFieldGet(this,Q).rtt}})}function Pe(e,t){var i=this;babelHelpers.classPrivateFieldGet(this,Q).pendingPublications[e]=setTimeout((function(){delete babelHelpers.classPrivateFieldGet(i,Q).pendingPublications[e];i.triggerEvents("PublishFailed",[t])}),babelHelpers.classPrivateFieldGet(this,Q).publicationTimeout)}function Be(e,t){var i=this;this.setLog("Start changing a streams quality");Object.values(this.getParticipants()).forEach((function(n){var s=babelHelpers.classPrivateFieldGet(i,Q).defaultRemoteStreamsQuality;if(e){var a=e==n.userId;s=a&&t===z.Camera?K.HIGH:K.MEDIUM;if(a){babelHelpers.classPrivateFieldGet(i,Q).mainStream={userId:e,kind:t}}}else{babelHelpers.classPrivateFieldGet(i,Q).mainStream={}}n.setStreamQuality(s);i.setLog("Quality of video for a participant with id ".concat(n.userId," (sid: ").concat(n.sid,") was changed to ").concat(s))}))}function He(){var e,t;var i=babelHelpers.classPrivateFieldGet(this,Q).videoQueue;babelHelpers.classPrivateFieldGet(this,Q).videoQueue=Y.INITIAL;if(i===Y.ENABLE&&((e=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||e===void 0?void 0:e.getVideoTracks()[0].readyState)!=="live"){this.enableVideo()}else if(i===Y.DISABLE&&((t=babelHelpers.classPrivateFieldGet(this,Q).cameraStream)===null||t===void 0?void 0:t.getVideoTracks()[0].readyState)==="live"){this.disableVideo()}}function De(e){return Le.apply(this,arguments)}function Le(){Le=babelHelpers.asyncToGenerator(F().mark((function e(t){var i,n;return F().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:this.setLog("Start getting user media with options: ".concat(JSON.stringify(t)));i={audio:false,video:false};n=null;s.prev=3;if(t.video){i.video={width:{ideal:babelHelpers.classPrivateFieldGet(this,Q).defaultVideoResolution.width},height:{ideal:babelHelpers.classPrivateFieldGet(this,Q).defaultVideoResolution.height}};if(babelHelpers.classPrivateFieldGet(this,Q).videoDeviceId){i.video.deviceId={exact:babelHelpers.classPrivateFieldGet(this,Q).videoDeviceId}}}else if(t.audio){if(babelHelpers.classPrivateFieldGet(this,Q).audioDeviceId){i.audio={deviceId:{exact:babelHelpers.classPrivateFieldGet(this,Q).audioDeviceId}}}else{i.audio=true}}s.next=7;return navigator.mediaDevices.getUserMedia(i);case 7:n=s.sent;this.setLog("Getting user media with constraints: ".concat(JSON.stringify(i)," succeed"));s.next=14;break;case 11:s.prev=11;s.t0=s["catch"](3);this.setLog("Getting user media  with constraints: ".concat(JSON.stringify(i)," failed: ").concat(s.t0));case 14:s.prev=14;this.triggerEvents("GetUserMediaEnded");return s.abrupt("return",n);case 18:case"end":return s.stop()}}),e,this,[[3,11,14,18]])})));return Le.apply(this,arguments)}function xe(){return Ae.apply(this,arguments)}function Ae(){Ae=babelHelpers.asyncToGenerator(F().mark((function e(){var t;return F().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:this.setLog("Start getting display media");t=null;i.prev=2;if(!window["BXDesktopSystem"]){i.next=9;break}i.next=6;return navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"screen",maxWidth:1920,maxHeight:1080,maxFrameRate:5}}});case 6:t=i.sent;i.next=12;break;case 9:i.next=11;return navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:false});case 11:t=i.sent;case 12:this.setLog("Getting display media succeed");i.next=18;break;case 15:i.prev=15;i.t0=i["catch"](2);this.setLog("Getting display media failed: ".concat(i.t0));case 18:i.prev=18;return i.abrupt("return",t);case 21:case"end":return i.stop()}}),e,this,[[2,15,18,21]])})));return Ae.apply(this,arguments)}function Ne(e){var t={sendLog:{userName:babelHelpers.classPrivateFieldGet(this,Q).userData.name,data:JSON.stringify(e)}};return this.isConnected()?G(this,ke,Je).call(this,t):false}function Ue(e){return Ve.apply(this,arguments)}function Ve(){Ve=babelHelpers.asyncToGenerator(F().mark((function e(t){var i=this;var n;return F().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:this.setLog("Start handling a remote answer");n=false;s.prev=2;s.next=5;return this.sender.setRemoteDescription(t.answer);case 5:babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.sender.forEach((function(e){i.sender.addIceCandidate(e);i.setLog("Added a deferred ICE candidate")}));babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.sender=[];s.next=13;break;case 9:s.prev=9;s.t0=s["catch"](2);this.setLog("Handling a remote answer failed: ".concat(s.t0));n=true;case 13:s.prev=13;if(!n){this.setLog("Handling a remote answer succeed")}babelHelpers.classPrivateFieldGet(this,Q).isWaitAnswer=false;s.next=18;return this.sendOffer();case 18:return s.finish(13);case 19:case"end":return s.stop()}}),e,this,[[2,9,13,19]])})));return Ve.apply(this,arguments)}function Fe(e){return Oe.apply(this,arguments)}function Oe(){Oe=babelHelpers.asyncToGenerator(F().mark((function e(t){var i=this;var n;return F().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:this.setLog("Handling a remote offer");s.prev=1;s.next=4;return this.recipient.setRemoteDescription(t.offer);case 4:babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.recipient.forEach((function(e){i.recipient.addIceCandidate(e);i.setLog("Added a deferred ICE candidate")}));babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.recipient=[];s.next=8;return this.recipient.createAnswer();case 8:n=s.sent;s.next=11;return this.recipient.setLocalDescription(n);case 11:G(this,ke,Je).call(this,{answer:n});this.setLog("Handling a remote offer succeed");s.next=18;break;case 15:s.prev=15;s.t0=s["catch"](1);this.setLog("Handling a remote offer failed: ".concat(s.t0));case 18:case"end":return s.stop()}}),e,this,[[1,15]])})));return Oe.apply(this,arguments)}function Xe(e){this.setLog("Start adding an ICE candidate");try{var t=JSON.parse(e.candidateInit);if(e.target){if(this.recipient.remoteDescription){this.recipient.addIceCandidate(t);this.setLog("Adding an ICE candidate succeed");return}babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.recipient.push(t);this.setLog("Adding an ICE candidate deferred: has no remote description")}else{if(this.sender.remoteDescription){this.sender.addIceCandidate(t);this.setLog("Adding an ICE candidate succeed");return}babelHelpers.classPrivateFieldGet(this,Q).pendingCandidates.sender.push(t);this.setLog("Adding an ICE candidate deferred: has no remote description")}}catch(e){this.setLog("Adding an ICE candidate failed: ".concat(e))}}function We(e){var t=this;var i=e.userId;var n=babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[i]?"ParticipantStateUpdated":"ParticipantJoined";var s=new Ze(e,babelHelpers.classPrivateFieldGet(this,Q).socketConnect);if(e.participantTracks){Object.values(e.participantTracks).forEach((function(e){e.userId=i;babelHelpers.classPrivateFieldGet(t,Q).tracksDataFromSocket[e.sid]=e;if(e.muted&&e.source===z.Microphone){s.isMutedAudio=true}if(e.muted&&e.source===z.Camera){s.isMutedVideo=true}switch(e.source){case z.Camera:s.videoEnabled=true;break;case z.Microphone:s.audioEnabled=true;break;case z.Screen:s.screenSharingEnabled=true;break}}))}babelHelpers.classPrivateFieldGet(this,Q).remoteParticipants[i]=s;this.triggerEvents(n,[s])}function Ge(e){var t=this;e.speakersChanged.speakers.forEach((function(e){var i=Object.values(babelHelpers.classPrivateFieldGet(t,Q).remoteParticipants).find((function(t){return t.sid===e.sid}));if(i&&(i===null||i===void 0?void 0:i.userId)!==babelHelpers.classPrivateFieldGet(t,Q).myUserId){i.isSpeaking=(e===null||e===void 0?void 0:e.active)||false;if(e!==null&&e!==void 0&&e.active){t.triggerEvents("VoiceStarted",[i])}else{t.triggerEvents("VoiceEnded",[i])}}}))}function ze(){var e=this;G(this,ge,je).call(this);var t={};if(babelHelpers.classPrivateFieldGet(this,Q).iceServers){t.iceServers=babelHelpers.classPrivateFieldGet(this,Q).iceServers}this.sender=new RTCPeerConnection(t);this.sender.addEventListener("icecandidate",(function(t){return e.onIceCandidate(null,t)}));this.sender.addEventListener("connectionstatechange",(function(t){return e.onConnectionStateChange()}));this.recipient=new RTCPeerConnection(t);this.recipient.ontrack=function(t){var i,n,s,a;var r=t.streams[0].id.split("|");var o=r[1];var l=(i=babelHelpers.classPrivateFieldGet(e,Q).tracksDataFromSocket[o])===null||i===void 0?void 0:i.userId;t.track.source=(n=babelHelpers.classPrivateFieldGet(e,Q).tracksDataFromSocket[o])===null||n===void 0?void 0:n.source;t.track.layers=((s=babelHelpers.classPrivateFieldGet(e,Q).tracksDataFromSocket[o])===null||s===void 0?void 0:s.layers)||null;babelHelpers.classPrivateFieldGet(e,Q).realTracksIds[t.track.id]=o;var c=babelHelpers.classPrivateFieldGet(e,Q).remoteParticipants[l];if(!c){e.setLog("Got a track with kind ".concat(t.track.source," (sid: ").concat(o,") without a participant"));return}if(!((a=babelHelpers.classPrivateFieldGet(e,Q).remoteTracks)!==null&&a!==void 0&&a[l])){babelHelpers.classPrivateFieldGet(e,Q).remoteTracks[l]={}}var d=new j(o,t.track);babelHelpers.classPrivateFieldGet(e,Q).remoteTracks[l][o]=d;if(d){e.setLog("Got an expected track with kind ".concat(t.track.source," (sid: ").concat(o,") for a participant with id ").concat(c.userId," (sid: ").concat(c.sid,")"));c.addTrack(t.track.source,d);if(t.track.source!==z.Camera||!c.isMutedVideo){e.triggerEvents("RemoteMediaAdded",[c,d])}}if(t.track.source===z.Camera){var u=babelHelpers.classPrivateFieldGet(e,Q).mainStream.userId==l;var h=babelHelpers.classPrivateFieldGet(e,Q).mainStream.kind===t.track.source;var p=K.LOW;if(u&&(h||!c.screenSharingEnabled)){p=K.HIGH}else if(!babelHelpers.classPrivateFieldGet(e,Q).mainStream.userId){p=babelHelpers.classPrivateFieldGet(e,Q).defaultRemoteStreamsQuality}e.setLog("Quality of video for a participant with id ".concat(c.userId," (sid: ").concat(c.sid,") was changed to ").concat(p," after receiving"));c.setStreamQuality(p)}};this.recipient.addEventListener("icecandidate",(function(t){return e.onIceCandidate("SUBSCRIBER",t)}));this.recipient.addEventListener("connectionstatechange",(function(t){return e.onConnectionStateChange(true)}));babelHelpers.classPrivateFieldGet(this,Q).callStatsInterval=setInterval(babelHelpers.asyncToGenerator(F().mark((function t(){var i;return F().wrap((function t(n){while(1)switch(n.prev=n.next){case 0:n.prev=0;i={};n.next=4;return e.sender.getStats(null).then((function(e){var t=[];e.forEach((function(e){t.push(e)}));i.sender=t}));case 4:n.next=6;return e.recipient.getStats(null).then((function(t){var n=[];var s=new Set;var a={};var r={};t.forEach((function(t){n.push(t);var i=(t===null||t===void 0?void 0:t.trackIdentifier)&&(t===null||t===void 0?void 0:t.kind)==="video"&&t.hasOwnProperty("packetsLost")&&t.hasOwnProperty("packetsReceived");if(i){var o,l;var c=t.packetsLost,d=t.trackIdentifier,u=t.packetsReceived;babelHelpers.classPrivateFieldGet(e,Q).prevPacketsLost[d]=((o=babelHelpers.classPrivateFieldGet(e,Q).prevPacketsLost)===null||o===void 0?void 0:o[d])||0;babelHelpers.classPrivateFieldGet(e,Q).prevPacketsReceived[d]=((l=babelHelpers.classPrivateFieldGet(e,Q).prevPacketsReceived)===null||l===void 0?void 0:l[d])||0;var h=(u-babelHelpers.classPrivateFieldGet(e,Q).prevPacketsReceived[d])/100*(c-babelHelpers.classPrivateFieldGet(e,Q).prevPacketsLost[d]);babelHelpers.classPrivateFieldGet(e,Q).prevPacketsLost[d]=c;babelHelpers.classPrivateFieldGet(e,Q).prevPacketsReceived[d]=u;if(h>babelHelpers.classPrivateFieldGet(e,Q).packetLostThreshold){var p=Object.values(babelHelpers.classPrivateFieldGet(e,Q).remoteParticipants).find((function(e){var i,n,s;return(e===null||e===void 0?void 0:(i=e.tracks)===null||i===void 0?void 0:(n=i[z.Camera])===null||n===void 0?void 0:(s=n.track)===null||s===void 0?void 0:s.id)===(t===null||t===void 0?void 0:t.trackIdentifier)}));if(p&&p.userId!==babelHelpers.classPrivateFieldGet(e,Q).myUserId){s.add(p.userId);babelHelpers.classPrivateFieldGet(e,Q).prevParticipantsWithLargeDataLoss["delete"](p.userId)}}}if(t.type==="codec"){a[t.id]=t.mimeType;if(r[t.id]){r[t.id].forEach((function(e){e.codecName=t.mimeType}));delete r[t.id]}}if(t.type==="inbound-rtp"&&t.kind==="video"){var v=babelHelpers.classPrivateFieldGet(e,Q).realTracksIds[t.trackIdentifier];var m=babelHelpers.classPrivateFieldGet(e,Q).tracksDataFromSocket[v];if(m){var f=m.report||{};m.report=t;var g=t.bytesReceived-(f.bytesReceived||0);var b=t.timestamp-(f.timestamp||0);var C=8*g/(b/1e3);t.bitrate=C<0?0:Math.trunc(C);t.userId=m.userId;t.source=m.source;if(a[t.codecId]){t.codecName=a[t.codecId]}else{if(r[t.codecId]){r[t.codecId].push(t)}else{r[t.codecId]=[t]}}}}}));i.recipient=n;if(s.size||babelHelpers.classPrivateFieldGet(e,Q).prevParticipantsWithLargeDataLoss.size){e.setLog("Have high packetsLost on users: ".concat(babelHelpers.toConsumableArray(s)));e.triggerEvents("UpdatePacketLoss",[babelHelpers.toConsumableArray(s)])}babelHelpers.classPrivateFieldGet(e,Q).prevParticipantsWithLargeDataLoss=s}));case 6:e.triggerEvents("CallStatsReceived",[i]);n.next=11;break;case 9:n.prev=9;n.t0=n["catch"](0);case 11:case"end":return n.stop()}}),t,null,[[0,9]])}))),babelHelpers.classPrivateFieldGet(this,Q).statsTimeout)}function je(){if(this.sender){this.sender.close();this.sender=null}if(this.recipient){this.recipient.close();this.recipient=null}babelHelpers.classPrivateFieldGet(this,Q).peerConnectionFailed=false}function qe(e){var t;switch(e){case z.Camera:t="cameraStream";break;case z.Microphone:t="microphoneStream";break;case z.Screen:t="screenStream";break}if(t){var i,n,s;(i=babelHelpers.classPrivateFieldGet(this,Q)[t])===null||i===void 0?void 0:(n=i.getTracks)===null||n===void 0?void 0:(s=n.call(i))===null||s===void 0?void 0:s.forEach((function(e){e.onended=null;e.stop()}));babelHelpers.classPrivateFieldGet(this,Q)[t]=null}}function Ke(e){var t,i;var n=(t=this.sender)===null||t===void 0?void 0:(i=t.getSenders)===null||i===void 0?void 0:i.call(t);var s=null;if((n===null||n===void 0?void 0:n.length)>0){var a=x(n),r;try{for(a.s();!(r=a.n()).done;){var o;var l=r.value;if(((o=l.track)===null||o===void 0?void 0:o.source)===e){s=l;break}}}catch(e){a.e(e)}finally{a.f()}}return s}function Je(e){var t;if(((t=babelHelpers.classPrivateFieldGet(this,Q).socketConnect)===null||t===void 0?void 0:t.readyState)===1){babelHelpers.classPrivateFieldGet(this,Q).socketConnect.send(JSON.stringify(e));return true}return false}function Ye(){var e;if(((e=babelHelpers.classPrivateFieldGet(this,Q).socketConnect)===null||e===void 0?void 0:e.readyState)===1){G(this,ke,Je).call(this,{leave:{reason:"CLIENT_INITIATED"}})}}var Qe=new WeakMap;var Ze=function(){function e(t,i){babelHelpers.classCallCheck(this,e);X(this,Qe,{writable:true,value:void 0});babelHelpers.defineProperty(this,"name","");babelHelpers.defineProperty(this,"image","");babelHelpers.defineProperty(this,"userId","");babelHelpers.defineProperty(this,"videoEnabled",false);babelHelpers.defineProperty(this,"audioEnabled",false);babelHelpers.defineProperty(this,"screenSharingEnabled",false);babelHelpers.defineProperty(this,"isSpeaking",false);babelHelpers.defineProperty(this,"tracks",{});babelHelpers.defineProperty(this,"sid","");babelHelpers.defineProperty(this,"isMutedVideo",false);babelHelpers.defineProperty(this,"isMutedAudio",false);babelHelpers.defineProperty(this,"isHandRaised",false);this.name=(t===null||t===void 0?void 0:t.name)||"";this.image=(t===null||t===void 0?void 0:t.image)||"";this.userId=(t===null||t===void 0?void 0:t.userId)||"";this.sid=(t===null||t===void 0?void 0:t.sid)||"";this.videoEnabled=(t===null||t===void 0?void 0:t.videoEnabled)||false;this.audioEnabled=(t===null||t===void 0?void 0:t.audioEnabled)||false;this.screenSharingEnabled=(t===null||t===void 0?void 0:t.screenSharingEnabled)||false;this.isSpeaking=(t===null||t===void 0?void 0:t.isSpeaking)||false;this.isHandRaised=(t===null||t===void 0?void 0:t.isHandRaised)||false;babelHelpers.classPrivateFieldSet(this,Qe,i)}babelHelpers.createClass(e,[{key:"subscribeTrack",value:function e(t){}},{key:"unsubscribeTrack",value:function e(t){}},{key:"attachTrack",value:function e(t){}},{key:"detachTrack",value:function e(t){}},{key:"disableAudio",value:function e(){this.tracks[z.Microphone].track.enabled=false;this.isMutedAudio=true}},{key:"enableAudio",value:function e(){this.tracks[z.Microphone].track.enabled=true;this.isMutedAudio=false}},{key:"disableVideo",value:function e(){this.tracks[z.Camera].track.enabled=false;this.isMutedVideo=true}},{key:"enableVideo",value:function e(){this.tracks[z.Camera].track.enabled=true;this.isMutedVideo=false}},{key:"addTrack",value:function e(t,i){this.tracks[t]=i}},{key:"removeTrack",value:function e(t,i){delete this.tracks[t]}},{key:"getTrack",value:function e(t){var i;return(i=this.tracks)===null||i===void 0?void 0:i[t]}},{key:"setStreamQuality",value:function e(t){var i;if(this.cameraStreamQuality===t){return}if((i=this.tracks)!==null&&i!==void 0&&i[z.Camera]){this.cameraStreamQuality=t;var n=this.tracks[z.Camera].id;this.tracks[z.Camera].track.currentVideoQuality=t;var s={trackSetting:{trackSids:[n],quality:t}};babelHelpers.classPrivateFieldGet(this,Qe).send(JSON.stringify(s))}}}]);return e}();var $e=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"elements",{});this.userModel=t.userModel;this.userModel.subscribe("changed",this._onUserFieldChanged.bind(this));this.parentContainer=t.parentContainer;this.screenSharingUser=l.Type.isBoolean(t.screenSharingUser)?t.screenSharingUser:false;this.allowBackgroundItem=l.Type.isBoolean(t.allowBackgroundItem)?t.allowBackgroundItem:true;this.allowMaskItem=l.Type.isBoolean(t.allowMaskItem)?t.allowMaskItem:true;this._allowPinButton=l.Type.isBoolean(t.allowPinButton)?t.allowPinButton:true;this._visible=true;this._audioTrack=t.audioTrack;this._audioStream=this._audioTrack?new MediaStream([this._audioTrack]):null;this._videoTrack=t.videoTrack;this._stream=this._videoTrack?new MediaStream([this._videoTrack]):null;this._videoRenderer=null;this._previewRenderer=null;this._flipVideo=false;this.hidden=false;this.videoBlurState=false;this.isChangingName=false;this._badNetworkIndicator=false;this.incomingVideoConstraints={width:0,height:0};if(t.audioElement){this.elements.audio=t.audioElement}this.callBacks={onClick:l.Type.isFunction(t.onClick)?t.onClick:BX.DoNothing,onUserRename:l.Type.isFunction(t.onUserRename)?t.onUserRename:BX.DoNothing,onUserRenameInputFocus:l.Type.isFunction(t.onUserRenameInputFocus)?t.onUserRenameInputFocus:BX.DoNothing,onUserRenameInputBlur:l.Type.isFunction(t.onUserRenameInputBlur)?t.onUserRenameInputBlur:BX.DoNothing,onPin:l.Type.isFunction(t.onPin)?t.onPin:BX.DoNothing,onUnPin:l.Type.isFunction(t.onUnPin)?t.onUnPin:BX.DoNothing};this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500);this.hintManager=BX.UI.Hint.createInstance({popupParameters:{targetContainer:document.body,className:"bx-messenger-videocall-panel-item-hotkey-hint ".concat(this.userModel.id),bindOptions:{forceBindPosition:true}}});this.connectionStats={};this.connectionStatsVisible=false}babelHelpers.createClass(e,[{key:"showStats",value:function e(t){this.connectionStats=t;if(this.elements.statsOverlay&&this.connectionStatsVisible){this.showConnectionStats()}}},{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user"},dataset:{userId:this.userModel.id,order:this.userModel.order},children:[this.elements.videoBorder=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-border"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-talking-icon"}})]}),this.elements.container=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-inner"},children:[this.elements.avatarBackground=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-background"}}),this.elements.avatarContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-border"},children:[this.elements.avatar=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-overlay-border"}})]}),this.elements.panel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel"}}),this.elements.state=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-status-text"},text:this.getStateMessage(this.userModel.state)}),this.elements.badNetworkIndicator=l.Dom.create("span",{props:{className:"bx-messenger-videocall-user-bad-network-indicator"},events:{mouseover:function e(i){t.hintManager.show(i.currentTarget,BX.message("IM_M_CALL_BAD_NETWORK_HINT"))},mouseout:function e(i){t.hintManager.hide()}}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-bottom"},children:[this.elements.nameContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-name-container"+(this.userModel.allowRename&&!this.userModel.wasRenamed?" hidden":"")},children:[this.elements.micState=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-device-state mic"+(this.userModel.microphoneState?" hidden":"")}}),this.elements.cameraState=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-device-state camera"+(this.userModel.cameraState?" hidden":"")}}),this.elements.name=l.Dom.create("span",{props:{className:"bx-messenger-videocall-user-name"},text:this.screenSharingUser?BX.message("IM_CALL_USERS_SCREEN").replace("#NAME#",this.userModel.name):this.userModel.name}),this.elements.changeNameIcon=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-icon hidden"}})],events:{click:this.toggleNameInput.bind(this)}}),this.elements.changeNameContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-container hidden"},children:[this.elements.changeNameCancel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-cancel"},events:{click:this.toggleNameInput.bind(this)}}),this.elements.changeNameInput=l.Dom.create("input",{props:{className:"bx-messenger-videocall-user-change-name-input"},attrs:{type:"text",value:this.userModel.name},events:{keydown:this.onNameInputKeyDown.bind(this),focus:this.callBacks.onUserRenameInputFocus,blur:this.callBacks.onUserRenameInputBlur}}),this.elements.changeNameConfirm=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-confirm"},events:{click:this.changeName.bind(this)}}),this.elements.changeNameLoader=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-loader hidden"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-loader-icon"}})]})]}),this.elements.introduceYourselfContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-introduce-yourself-container"+(!this.userModel.allowRename||this.userModel.wasRenamed?" hidden":"")},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-introduce-yourself-text"},text:BX.message("IM_CALL_GUEST_INTRODUCE_YOURSELF")})],events:{click:this.toggleNameInput.bind(this)}})]}),this.elements.floorRequest=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-floor-request bx-messenger-videocall-floor-request-icon"}}),this.elements.statsOverlay=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-stats-overlay"}})]})],style:{order:this.userModel.order},events:{click:function(e){e.stopPropagation();this.callBacks.onClick({userId:this.id})}.bind(this)}});if(this.userModel.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}this.elements.debugPanel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button connection-stats"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button-icon connection-stats-icon"}})],events:{click:function e(i){i.stopPropagation();t.connectionStatsVisible=!t.connectionStatsVisible;if(t.connectionStatsVisible){t.showConnectionStats();t.elements.statsOverlay.classList.add("stats-overlay-visble")}else{t.elements.statsOverlay.classList.remove("stats-overlay-visble")}}}}),this.elements.connectionProblem=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button connection-problem"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button-icon connection-problem-icon"},events:{mouseover:function e(i){t.hintManager.show(i.currentTarget,BX.message("IM_M_CALL_POOR_CONNECTION_WITH_USER"))},mouseout:function e(i){t.hintManager.hide()}}})]})]});if(this.userModel.localUser){this.elements.root.classList.add("bx-messenger-videocall-user-self")}if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('"+this.userModel.avatar+"')")}else{this.elements.root.style.removeProperty("--avatar")}this.elements.videoContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-video-container"},children:[this.elements.video=l.Dom.create("video",{props:{className:"bx-messenger-videocall-video",volume:0,autoplay:true},attrs:{playsinline:true,muted:true}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-preview"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-preview-container"},children:[this.elements.preview=l.Dom.create("video",{props:{className:"bx-messenger-videocall-preview-video",volume:0,autoplay:true},attrs:{playsinline:true,muted:true}})]})]})]});this.elements.container.appendChild(this.elements.videoContainer);if(this.stream&&this.stream.active){this.elements.video.srcObject=this.stream}if(this.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}if(this.userModel.screenState){this.elements.video.classList.add("bx-messenger-videocall-video-contain")}if(this.userModel.cameraState&&this.userModel.microphoneState){this.elements.nameContainer.classList.add("extra-padding")}this.elements.buttonBackground=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon background"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_CHANGE_BACKGROUND")})],events:{click:function e(t){t.stopPropagation();v.open()}}});this.elements.buttonMenu=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon menu"}})],events:{click:function e(i){i.stopPropagation();t.showMenu()}}});this.elements.buttonPin=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon pin"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_PIN")})],events:{click:function e(i){i.stopPropagation();t.callBacks.onPin({userId:t.userModel.id})}}});this.elements.buttonUnPin=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon unpin"}}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_UNPIN")})],events:{click:function e(i){i.stopPropagation();t.callBacks.onUnPin()}}});this.updatePanelDeferred();return this.elements.root}},{key:"showConnectionStats",value:function e(){var t,i;if(!this.elements.statsOverlay){return}var n="";var s=(t=this.connectionStats)===null||t===void 0?void 0:t[z.Camera];var a=(i=this.connectionStats)===null||i===void 0?void 0:i[z.Screen];if(s||!a){n+="Video track #1 (Camera):\n";n+="Bitrate: ".concat((s===null||s===void 0?void 0:s.bitrate)||0,"\n");n+="PacketsLost: ".concat((s===null||s===void 0?void 0:s.packetsLost)||0,"\n");n+="Codec: ".concat((s===null||s===void 0?void 0:s.codecName)||"-","\n");n+="Resolution: ".concat((s===null||s===void 0?void 0:s.frameWidth)||0,"x").concat((s===null||s===void 0?void 0:s.frameHeight)||0," ");n+="(".concat((s===null||s===void 0?void 0:s.framesPerSecond)||0," FPS)")}if(a){if(s){n+="\n\n"}n+="Video track #".concat(s?2:1," (Screen):\n");n+="Bitrate: ".concat((a===null||a===void 0?void 0:a.bitrate)||0,"\n");n+="PacketsLost: ".concat((a===null||a===void 0?void 0:a.packetsLost)||0,"\n");n+="Codec: ".concat((a===null||a===void 0?void 0:a.codecName)||"-","\n");n+="Resolution: ".concat((a===null||a===void 0?void 0:a.frameWidth)||0,"x").concat((a===null||a===void 0?void 0:a.frameHeight)||0," ");n+="(".concat((a===null||a===void 0?void 0:a.framesPerSecond)||0," FPS)")}this.elements.statsOverlay.innerText=n}},{key:"setIncomingVideoConstraints",value:function e(t,i){this.incomingVideoConstraints.width=typeof t==="undefined"?this.incomingVideoConstraints.width:t;this.incomingVideoConstraints.height=typeof i==="undefined"?this.incomingVideoConstraints.height:i;if(!this.videoRenderer){return}this.videoRenderer.requestVideoSize(this.incomingVideoConstraints.width,this.incomingVideoConstraints.height)}},{key:"updateRendererState",value:function e(){}},{key:"_onUserFieldChanged",value:function e(t){var i=t.data;switch(i.fieldName){case"id":return this.updateId();case"name":return this.updateName();case"avatar":return this.updateAvatar();case"state":return this.updateState();case"talking":return this.updateTalking();case"microphoneState":return this.updateMicrophoneState();case"cameraState":return this.updateCameraState();case"videoPaused":return this.updateVideoPaused();case"floorRequestState":return this.updateFloorRequestState();case"screenState":return this.updateScreenState();case"pinned":return this.updatePanel();case"allowRename":return this.updateRenameAllowed();case"wasRenamed":return this.updateWasRenamed();case"renameRequested":return this.updateRenameRequested();case"order":return this.updateOrder()}}},{key:"toggleRenameIcon",value:function e(){if(!this.userModel.allowRename){return}this.elements.changeNameIcon.classList.toggle("hidden")}},{key:"toggleNameInput",value:function e(t){if(!this.userModel.allowRename||!this.elements.root){return}t.stopPropagation();if(this.isChangingName){this.isChangingName=false;if(!this.userModel.wasRenamed){this.elements.introduceYourselfContainer.classList.remove("hidden");this.elements.changeNameContainer.classList.add("hidden")}else{this.elements.changeNameContainer.classList.add("hidden");this.elements.nameContainer.classList.remove("hidden")}}else{if(!this.userModel.wasRenamed){this.elements.introduceYourselfContainer.classList.add("hidden")}this.isChangingName=true;this.elements.nameContainer.classList.add("hidden");this.elements.changeNameContainer.classList.remove("hidden");this.elements.changeNameInput.value=this.userModel.name;this.elements.changeNameInput.focus();this.elements.changeNameInput.select()}}},{key:"onNameInputKeyDown",value:function e(t){if(!this.userModel.allowRename){return}if(t.keyCode===13){this.changeName(t)}else if(t.keyCode===27){this.toggleNameInput(t)}}},{key:"onNameInputFocus",value:function e(t){}},{key:"onNameInputBlur",value:function e(t){}},{key:"changeName",value:function e(t){t.stopPropagation();var i=this.elements.changeNameInput.value;var n=i.trim();var s=true;if(n===this.userModel.name||n===""){s=false}if(s){this.elements.changeNameConfirm.classList.toggle("hidden");this.elements.changeNameLoader.classList.toggle("hidden");this.callBacks.onUserRename(n)}else{this.toggleNameInput(t)}}},{key:"showMenu",value:function e(){var t=this;var i=[];if(this.userModel.localUser&&this.allowBackgroundItem){i.push({text:this.allowMaskItem?BX.message("IM_CALL_CHANGE_BG_MASK"):BX.message("IM_CALL_CHANGE_BACKGROUND"),onclick:function e(){t.menu.close();v.open()}})}if(i.length===0){return}var n=l.Dom.getRelativePosition(this.elements.buttonMenu,this.parentContainer);this.menu=new o.Menu({id:"call-view-user-menu-"+this.userModel.id,bindElement:{left:n.left,top:n.top,bottom:n.bottom},items:i,targetContainer:this.parentContainer,autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"bottom"},angle:true,overlay:{backgroundColor:"white",opacity:0},cacheable:false,events:{onPopupDestroy:function e(){return t.menu=null}}});this.menu.show()}},{key:"updateAvatar",value:function e(){if(this.elements.root){if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('"+this.userModel.avatar+"')")}else{this.elements.root.style.removeProperty("--avatar")}}}},{key:"updateId",value:function e(){if(this.elements.root){this.elements.root.dataset.userId=this.userModel.id}}},{key:"updateName",value:function e(){if(this.isChangingName){this.isChangingName=false;this.elements.changeNameConfirm.classList.toggle("hidden");this.elements.changeNameLoader.classList.toggle("hidden");this.elements.changeNameContainer.classList.add("hidden");this.elements.nameContainer.classList.remove("hidden")}if(this.elements.name){this.elements.name.innerText=this.screenSharingUser?BX.message("IM_CALL_USERS_SCREEN").replace("#NAME#",this.userModel.name):this.userModel.name}}},{key:"updateRenameAllowed",value:function e(){if(this.userModel.allowRename&&this.elements.nameContainer&&this.elements.introduceYourselfContainer){this.elements.nameContainer.classList.add("hidden");this.elements.introduceYourselfContainer.classList.remove("hidden")}}},{key:"updateWasRenamed",value:function e(){if(!this.elements.root){return}if(this.userModel.allowRename){this.elements.introduceYourselfContainer.classList.add("hidden");this.elements.changeNameIcon.classList.remove("hidden");if(this.elements.changeNameContainer.classList.contains("hidden")){this.elements.nameContainer.classList.remove("hidden")}}}},{key:"updateRenameRequested",value:function e(){if(this.userModel.allowRename){this.elements.introduceYourselfContainer.classList.add("hidden")}}},{key:"updateOrder",value:function e(){if(this.elements.root){this.elements.root.dataset.order=this.userModel.order;this.elements.root.style.order=this.userModel.order}}},{key:"updatePanelDeferred",value:function e(){setTimeout(this.updatePanel.bind(this),0)}},{key:"updatePanel",value:function e(){if(!this.isMounted()){return}var t=this.elements.root.offsetWidth;l.Dom.clean(this.elements.panel);if(this.userModel.localUser&&this.allowBackgroundItem){if(t>300){this.elements.panel.appendChild(this.elements.buttonBackground)}else{this.elements.panel.appendChild(this.elements.buttonMenu)}}if(this.allowPinButton){if(this.userModel.pinned){this.elements.panel.appendChild(this.elements.buttonUnPin)}else{this.elements.panel.appendChild(this.elements.buttonPin)}if(t>250){this.elements.buttonPin.classList.remove("no-text");this.elements.buttonUnPin.classList.remove("no-text")}else{this.elements.buttonPin.classList.add("no-text");this.elements.buttonUnPin.classList.add("no-text")}}}},{key:"update",value:function e(){if(!this.elements.root){return}if(this.hasVideo()){var t,i;if(this.visible){if(this.videoRenderer){this.videoRenderer.render(this.elements.video);if(this._previewRenderer){this._previewRenderer.render(this.elements.preview)}else{this.elements.preview.srcObject=null}}else if(this.elements.video.srcObject!=this.stream){this.elements.video.srcObject=this.stream}}if(((t=this.videoRenderer)===null||t===void 0?void 0:t.kind)==="video"&&this.flipVideo){this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo);this.elements.preview.classList.toggle("bx-messenger-videocall-video-flipped",!this.flipVideo)}else if(((i=this.videoRenderer)===null||i===void 0?void 0:i.kind)==="sharing"&&this.flipVideo){this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",!this.flipVideo);this.elements.preview.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo)}else{this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo)}this.elements.video.classList.toggle("bx-messenger-videocall-video-contain",this.userModel.screenState)}else{this.elements.video.srcObject=null;this.elements.preview.srcObject=null}if(Do.isBitrixCallServerAllowed()&&this.userModel.state===mr.Connected&&!this.userModel.localUser&&!this.elements.debugPanel.parentElement){this.elements.container.appendChild(this.elements.debugPanel)}this.updatePanelDeferred()}},{key:"playAudio",value:function e(){if(!this.audioStream){this.elements.audio.srcObject=null;return}if(this.speakerId&&l.Type.isFunction(this.elements.audio.setSinkId)){this.elements.audio.setSinkId(this.speakerId).then(function(){this.elements.audio.srcObject=this.audioStream;this.elements.audio.play()["catch"](L)}.bind(this))["catch"](console.error)}else{this.elements.audio.srcObject=this.audioStream;this.elements.audio.play()["catch"](L)}}},{key:"playVideo",value:function e(){if(this.elements.video){this.elements.video.play()["catch"](L)}if(this.elements.preview){this.elements.preview.play()["catch"](L)}}},{key:"blurVideo",value:function e(t){t=!!t;if(this.videoBlurState==t){return}this.videoBlurState=t;if(this.elements.video){this.elements.video.classList.toggle("bx-messenger-videocall-video-blurred")}}},{key:"getStateMessage",value:function e(t,i){switch(t){case mr.Idle:return"";case mr.Calling:return BX.message("IM_M_CALL_STATUS_WAIT_ANSWER");case mr.Declined:return BX.message("IM_M_CALL_STATUS_DECLINED");case mr.Ready:case mr.Connecting:return BX.message("IM_M_CALL_STATUS_WAIT_CONNECT");case mr.Connected:return i?BX.message("IM_M_CALL_STATUS_VIDEO_PAUSED"):"";case mr.Failed:return BX.message("IM_M_CALL_STATUS_CONNECTION_ERROR");case mr.Unavailable:return BX.message("IM_M_CALL_STATUS_UNAVAILABLE");default:return""}}},{key:"mount",value:function e(t,i){i=i===true;if(!this.elements.root){this.render()}if(this.isMounted()&&this.elements.root.parentElement==t&&!i){this.updatePanelDeferred();return false}t.appendChild(this.elements.root);this.update()}},{key:"dismount",value:function e(){if(!this.isMounted()){return false}this.elements.video.srcObject=null;l.Dom.remove(this.elements.root)}},{key:"isMounted",value:function e(){return!!(this.elements.root&&this.elements.root.parentElement)}},{key:"updateState",value:function e(){if(!this.elements.root){return}if(this.userModel.state==mr.Calling||this.userModel.state==mr.Connecting){this.elements.avatar.classList.add("bx-messenger-videocall-user-avatar-pulse")}else{this.elements.avatar.classList.remove("bx-messenger-videocall-user-avatar-pulse")}if(this.userModel.state==mr.Idle){this._videoRenderer=null;this._previewRenderer=null;this._audioTrack=null;this._audioStream=null}this.elements.state.innerText=this.getStateMessage(this.userModel.state,this.userModel.videoPaused);this.update()}},{key:"updateTalking",value:function e(){if(!this.elements.root){return}if(this.userModel.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}else{this.elements.root.classList.remove("bx-messenger-videocall-user-talking")}}},{key:"updateMicrophoneState",value:function e(){if(!this.elements.root){return}if(this.userModel.microphoneState){this.elements.micState.classList.add("hidden")}else{this.elements.micState.classList.remove("hidden")}if(this.userModel.cameraState&&this.userModel.microphoneState){this.elements.nameContainer.classList.add("extra-padding")}else{this.elements.nameContainer.classList.remove("extra-padding")}}},{key:"updateCameraState",value:function e(){if(!this.elements.root){return}if(this.userModel.cameraState){this.elements.cameraState.classList.add("hidden")}else{this.elements.cameraState.classList.remove("hidden")}if(this.userModel.cameraState&&this.userModel.microphoneState){this.elements.nameContainer.classList.add("extra-padding")}else{this.elements.nameContainer.classList.remove("extra-padding")}}},{key:"updateVideoPaused",value:function e(){if(!this.elements.root){return}if(this.stream&&this.hasVideo()){this.blurVideo(this.userModel.videoPaused)}this.updateState()}},{key:"updateFloorRequestState",value:function e(){if(!this.elements.floorRequest){return}if(this.userModel.floorRequestState){this.elements.floorRequest.classList.add("active");this.elements.debugPanel.classList.add("under-other-panels");this.elements.statsOverlay.classList.add("under-other-panels")}else{this.elements.floorRequest.classList.remove("active");this.elements.debugPanel.classList.remove("under-other-panels");this.elements.statsOverlay.classList.remove("under-other-panels")}}},{key:"updateScreenState",value:function e(){if(!this.elements.video){return}if(this.userModel.screenState){this.elements.video.classList.add("bx-messenger-videocall-video-contain")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-contain")}}},{key:"hide",value:function e(){if(!this.elements.root){return}this.elements.root.dataset.hidden=1}},{key:"show",value:function e(){if(!this.elements.root){return}delete this.elements.root.dataset.hidden}},{key:"hasVideo",value:function e(){return this.userModel.state==mr.Connected&&(!!this._videoTrack||!!this._videoRenderer)}},{key:"hasCameraVideo",value:function e(){var t,i;return this.userModel.state==mr.Connected&&(!!this._videoTrack||((t=this._videoRenderer)===null||t===void 0?void 0:t.kind)==="video"||((i=this._previewRenderer)===null||i===void 0?void 0:i.kind)==="video")}},{key:"checkVideoAspect",value:function e(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}}},{key:"releaseStream",value:function e(){if(this._videoRenderer&&!this._previewRenderer){if(this.elements.video){this.elements.video.srcObject=null}this._videoRenderer=null}else{if(this.elements.video){this.elements.video.srcObject=null}this.videoTrack=null}}},{key:"destroy",value:function e(){if(this.hintManager){this.hintManager.hide();this.hintManager=null}this.releaseStream();clearInterval(this.checkAspectInterval)}},{key:"id",get:function e(){return this.userModel.id}},{key:"allowPinButton",get:function e(){return this._allowPinButton},set:function e(t){if(this._allowPinButton==t){return}this._allowPinButton=t;this.update()}},{key:"audioTrack",get:function e(){return this._audioTrack},set:function e(t){if(this._audioTrack===t){return}this._audioTrack=t;this._audioStream=this._audioTrack?new MediaStream([this._audioTrack]):null;this.playAudio()}},{key:"audioStream",get:function e(){return this._audioStream}},{key:"flipVideo",get:function e(){return this._flipVideo},set:function e(t){this._flipVideo=t;this.update()}},{key:"stream",get:function e(){return this._stream}},{key:"visible",get:function e(){return this._visible},set:function e(t){if(this._visible!==t){this._visible=t;this.update();this.updateRendererState()}}},{key:"videoRenderer",get:function e(){return this._videoRenderer},set:function e(t){if(this._badNetworkIndicator){if(t.stream){this._tempVideoRenderer=t;this._videoRenderer=null}else{this._tempVideoRenderer=this._videoRenderer=null}}else{var i;this._tempVideoRenderer=null;var n=(i=this._videoRenderer)===null||i===void 0?void 0:i.kind;var s=t===null||t===void 0?void 0:t.kind;if(t.stream){if(s==="sharing"&&n==="video"){this._previewRenderer=this._videoRenderer;this._videoRenderer=t}else if(s==="video"&&n==="sharing"){this._previewRenderer=t}else{this._videoRenderer=t}}else{if(s==="sharing"){if(n==="sharing"){this._videoRenderer=this._previewRenderer}this._previewRenderer=null;delete this.connectionStats[z.Screen]}else if(s==="video"){if(n==="sharing"){this._previewRenderer=null}else{this._videoRenderer=null}delete this.connectionStats[z.Camera]}this.showConnectionStats()}}this.update();this.updateRendererState()}},{key:"videoTrack",get:function e(){return this._videoTrack},set:function e(t){if(this._videoTrack===t){return}this._videoTrack=t;this._stream=this._videoTrack?new MediaStream([this._videoTrack]):null;this.update()}},{key:"badNetworkIndicator",set:function e(t){if(this._badNetworkIndicator===t){return}this._badNetworkIndicator=t;if(this._badNetworkIndicator){this.elements.badNetworkIndicator.classList.add("bx-messenger-videocall-user-bad-network-indicator-visible");if(this._videoRenderer){this._tempVideoRenderer=this._videoRenderer;this._videoRenderer=null}}else{this.elements.badNetworkIndicator.classList.remove("bx-messenger-videocall-user-bad-network-indicator-visible");if(this._tempVideoRenderer){this._videoRenderer=this._tempVideoRenderer;this._tempVideoRenderer=null}}this.update()}},{key:"hasConnectionProblem",set:function e(t){this._hasConnectionProblem=t;if(this._hasConnectionProblem){this.elements.connectionProblem.classList.add("connection-problem-visible")}else{this.elements.connectionProblem.classList.remove("connection-problem-visible")}}}]);return e}();var et={defaultMicrophone:"bx-im-settings-default-microphone",defaultCamera:"bx-im-settings-default-camera",defaultSpeaker:"bx-im-settings-default-speaker",enableMicAutoParameters:"bx-im-settings-enable-mic-auto-parameters",preferHd:"bx-im-settings-camera-prefer-hd",enableMirroring:"bx-im-settings-camera-enable-mirroring"};var tt={initialized:"initialized",deviceChanged:"deviceChange",onChangeMirroringVideo:"onChangeMirroringVideo"};var it=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(e),"Events",tt);e.setEventNamespace("BX.Call.HardwareManager");e.initialized=false;e._currentDeviceList=[];e.updating=false;return e}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;if(this.initialized){return Promise.resolve()}if(this.initPromise){return this.initPromise}this.initPromise=new Promise((function(e,i){t.enumerateDevices().then((function(i){t._currentDeviceList=t.filterDeviceList(i);navigator.mediaDevices.addEventListener("devicechange",BX.debounce(t.onNavigatorDeviceChanged.bind(t),500));t.initialized=true;t.initPromise=null;t.emit(tt.initialized,{});e()}))["catch"]((function(e){t.initPromise=null;i(e)}))}));return this.initPromise}},{key:"enumerateDevices",value:function e(){return new Promise((function(e,t){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){return t("NO_WEBRTC")}navigator.mediaDevices.enumerateDevices().then((function(t){return e(t)}))}))}},{key:"hasCamera",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.cameraList).length>0}},{key:"getMicrophoneList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind==="audioinput"&&e.deviceId!=="default"}))}},{key:"getCameraList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind=="videoinput"}))}},{key:"getSpeakerList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind==="audiooutput"&&e.deviceId!=="default"}))}},{key:"canSelectSpeaker",value:function e(){return"setSinkId"in HTMLMediaElement.prototype}},{key:"updateDeviceList",value:function e(t){var i=this;if(this.updating){return}this.updating=true;var n=this._currentDeviceList;var s=[];var a=this._currentDeviceList.every((function(e){return e.deviceId==""&&e.label==""}));navigator.mediaDevices.enumerateDevices().then((function(e){e=i.filterDeviceList(e);e.forEach((function(e){var t=n.findIndex((function(t){return t.kind===e.kind&&t.deviceId===e.deviceId&&t.groupId===e.groupId}));if(t!=-1){n.splice(t,1)}else{s.push(e)}}));if(!a){i.emit(tt.deviceChanged,{added:s,removed:n})}i._currentDeviceList=e;i.updating=false}))}},{key:"filterDeviceList",value:function e(t){var i=this;return t.filter((function(e){switch(e.kind){case"audioinput":return e.deviceId!=="communications"&&!i.isDeviceInBlackList(e);case"audiooutput":return e.deviceId!=="communications"&&!i.isDeviceInBlackList(e);default:return true}}))}},{key:"isDeviceInBlackList",value:function e(t){var i=["(virtual)","zoomaudiodevice","microsoft teams audio","bitrixaudio"];var n=false;i.forEach((function(e){if(t.label.toLowerCase().includes(e)){n=true;return false}}));return n}},{key:"onNavigatorDeviceChanged",value:function e(t){if(!this.initialized){return}this.updateDeviceList()}},{key:"_getDeviceMap",value:function e(t){var i={};if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}for(var n=0;n<this._currentDeviceList.length;n++){if(this._currentDeviceList[n].kind==t){i[this._currentDeviceList[n].deviceId]=this._currentDeviceList[n].label}}return i}},{key:"getDefaultDeviceIdByGroupId",value:function e(t,i){var n;this._currentDeviceList.forEach((function(e){if(e.groupId===t&&e.deviceId!=="default"&&e.kind===i){n=e.deviceId;return false}}));return n}},{key:"getDeviceGroupIdByDeviceId",value:function e(t,i){var n;this._currentDeviceList.forEach((function(e){if(e.deviceId===t&&e.kind===i){n=e.groupId;return false}}));return n}},{key:"removeDevicesByDefaultGroup",value:function e(t){var i=t;t.forEach((function(e){if(e.deviceId==="default"){i=i.filter((function(t){return t.kind!==e.kind||t.groupId!==e.groupId}))}}));return i}},{key:"getCurrentDeviceList",value:function e(){var t=this;return new Promise((function(e,i){t.enumerateDevices().then((function(i){t._currentDeviceList=t.filterDeviceList(i);e()}))}))}},{key:"cameraList",get:function e(){return this._getDeviceMap("videoinput")}},{key:"microphoneList",get:function e(){return this._getDeviceMap("audioinput")}},{key:"audioOutputList",get:function e(){return this._getDeviceMap("audiooutput")}},{key:"defaultMicrophone",get:function e(){var t=localStorage?localStorage.getItem(et.defaultMicrophone):"";if((!t||!this.microphoneList[t])&&Object.keys(this.microphoneList).length){t=Object.keys(this.microphoneList).includes("default")?this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audioinput"),"audioinput"):Object.keys(this.microphoneList)[0];return t}return this.microphoneList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(et.defaultMicrophone,t)}}},{key:"defaultCamera",get:function e(){var t=localStorage?localStorage.getItem(et.defaultCamera):"";return this.cameraList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(et.defaultCamera,t)}}},{key:"defaultSpeaker",get:function e(){var t=localStorage?localStorage.getItem(et.defaultSpeaker):"";if((!t||this.audioOutputList[t])&&Object.keys(this.audioOutputList).length){t=Object.keys(this.audioOutputList).includes("default")?this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audiooutput"),"audiooutput"):Object.keys(this.audioOutputList)[0];return t}return this.audioOutputList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(et.defaultSpeaker,t)}}},{key:"enableMicAutoParameters",get:function e(){return localStorage?localStorage.getItem(et.enableMicAutoParameters)!=="N":true},set:function e(t){if(localStorage){localStorage.setItem(et.enableMicAutoParameters,t?"Y":"N")}}},{key:"preferHdQuality",get:function e(){return localStorage?localStorage.getItem(et.preferHd)!=="N":true},set:function e(t){if(localStorage){localStorage.setItem(et.preferHd,t?"Y":"N")}}},{key:"enableMirroring",get:function e(){return localStorage?localStorage.getItem(et.enableMirroring)!=="N":true},set:function e(t){if(this.enableMirroring!==t){this.emit(tt.onChangeMirroringVideo,{enableMirroring:t});if(a.DesktopApi.isDesktop()){a.DesktopApi.emit(tt.onChangeMirroringVideo,[t])}if(localStorage){localStorage.setItem(et.enableMirroring,t?"Y":"N")}}}}]);return t}(r.EventEmitter);var nt=new it;var st=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.setEventNamespace("BX.Call.FloorRequest");i.hideTime=BX.prop.getInteger(e,"hideTime",10);i.userModel=e.userModel;i.elements={root:null,avatar:null};i._hideTimeout=null;i._onUserModelChangedHandler=i._onUserModelChanged.bind(babelHelpers.assertThisInitialized(i));i.userModel.subscribe("changed",i._onUserModelChangedHandler);return i}babelHelpers.createClass(t,[{key:"mount",value:function e(t){t.appendChild(this.render());this.scheduleDismount()}},{key:"dismount",value:function e(){BX.remove(this.elements.root);this.destroy()}},{key:"dismountWithAnimation",value:function e(){var t=this;if(!this.elements.root){return}this.elements.root.classList.add("closing");this.elements.root.addEventListener("animationend",(function(){return t.dismount()}))}},{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification"},children:[l.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-icon-container"},children:[this.elements.avatar=l.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-avatar"}}),l.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-icon bx-messenger-videocall-floor-request-icon"}})]}),l.Dom.create("span",{props:{className:"bx-call-view-floor-request-notification-text-container"},html:BX.message("IM_CALL_WANTS_TO_SAY_"+(this.userModel.gender=="F"?"F":"M")).replace("#NAME#",'<span class ="bx-call-view-floor-request-notification-text-name">'+BX.util.htmlspecialchars(this.userModel.name)+"</span>")}),l.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-close"},events:{click:this.dismount.bind(this)}})]});if(this.userModel.avatar){this.elements.avatar.style.setProperty("--avatar","url('"+this.userModel.avatar+"')")}return this.elements.root}},{key:"scheduleDismount",value:function e(){return;this._hideTimeout=setTimeout(this.dismountWithAnimation.bind(this),this.hideTime*1e3)}},{key:"_onUserModelChanged",value:function e(t){var i=t.data;if(i.fieldName=="floorRequestState"&&!this.userModel.floorRequestState){this.dismountWithAnimation()}}},{key:"destroy",value:function e(){clearTimeout(this._hideTimeout);this._hideTimeout=null;this.elements=null;if(this.userModel){this.userModel.unsubscribe("changed",this._onUserModelChangedHandler);this.userModel=null}this.emit("onDestroy",{})}}],[{key:"create",value:function e(i){return new t(i)}}]);return t}(r.EventEmitter);var at=5;var rt;var ot=function(){function e(){babelHelpers.classCallCheck(this,e);this.maxNotification=at;this.notifications=[]}babelHelpers.createClass(e,[{key:"addNotification",value:function e(t){var i=this;t.subscribe("onDestroy",(function(){return i.onNotificationDestroy(t)}));this.notifications.push(t);if(this.notifications.length>this.maxNotification){var n=this.notifications.shift();n.dismount()}}},{key:"onNotificationDestroy",value:function e(t){var i=this.notifications.indexOf(t);if(i!=-1){this.notifications.splice(i,1)}}}],[{key:"Instance",get:function t(){if(!rt){rt=new e}return rt}}]);return e}();var lt={onMicrophoneSelect:"onMicrophoneSelect",onMicrophoneSwitch:"onMicrophoneSwitch",onCameraSelect:"onCameraSelect",onCameraSwitch:"onCameraSwitch",onSpeakerSelect:"onSpeakerSelect",onSpeakerSwitch:"onSpeakerSwitch",onChangeHdVideo:"onChangeHdVideo",onChangeMicAutoParams:"onChangeMicAutoParams",onChangeFaceImprove:"onChangeFaceImprove",onAdvancedSettingsClick:"onOpenAdvancedSettingsClick",onShow:"onShow",onDestroy:"onDestroy"};var ct=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.viewElement=t.viewElement||null;this.parentElement=t.parentElement;this.zIndex=t.zIndex;this.cameraEnabled=BX.prop.getBoolean(t,"cameraEnabled",false);this.cameraId=BX.prop.getString(t,"cameraId",false);this.microphoneEnabled=BX.prop.getBoolean(t,"microphoneEnabled",false);this.microphoneId=BX.prop.getString(t,"microphoneId",false);this.speakerEnabled=BX.prop.getBoolean(t,"speakerEnabled",false);this.speakerId=BX.prop.getString(t,"speakerId",false);this.allowHdVideo=BX.prop.getBoolean(t,"allowHdVideo",false);this.faceImproveEnabled=BX.prop.getBoolean(t,"faceImproveEnabled",false);this.allowFaceImprove=BX.prop.getBoolean(t,"allowFaceImprove",false);this.allowBackground=BX.prop.getBoolean(t,"allowBackground",true);this.allowMask=BX.prop.getBoolean(t,"allowMask",true);this.allowAdvancedSettings=BX.prop.getBoolean(t,"allowAdvancedSettings",false);this.switchCameraBlocked=t.switchCameraBlocked||false;this.switchMicrophoneBlocked=t.switchMicrophoneBlocked||false;this.isDestroying=false;this.popup=null;this.eventEmitter=new BX.Event.EventEmitter(this,"DeviceSelector");this.elements={root:null,micContainer:null,cameraContainer:null,speakerContainer:null};var n=BX.prop.getObject(t,"events",{});Object.values(lt).forEach((function(e){if(n[e]){i.eventEmitter.subscribe(e,n[e])}}))}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;if(this.popup){this.popup.show();return}this.popup=new o.Popup({id:"call-view-device-selector",bindElement:this.parentElement,targetContainer:this.viewElement,autoHide:true,zIndex:this.zIndex,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"top"},angle:{position:"bottom"},overlay:{backgroundColor:"white",opacity:0},content:this.render(),events:{onPopupClose:function e(){return t.popup.destroy()},onPopupDestroy:function e(){return t.destroy()}}});this.popup.show();this.eventEmitter.emit(lt.onShow,{})}},{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}return l.Dom.create("div",{props:{className:"bx-call-view-device-selector"},children:[l.Dom.create("div",{props:{className:"bx-call-view-device-selector-top"},children:[(this.microphoneContainer=ut.create({blocked:this.switchMicrophoneBlocked,deviceLabel:BX.message("IM_M_CALL_BTN_MIC"),deviceList:nt.getMicrophoneList(),selectedDevice:this.microphoneId,deviceEnabled:this.microphoneEnabled,icons:["microphone","microphone-off"],events:{onSwitch:this.onMicrophoneSwitch.bind(this),onSelect:this.onMicrophoneSelect.bind(this)}})).render(),(this.cameraContainer=ut.create({blocked:this.switchCameraBlocked,deviceLabel:BX.message("IM_M_CALL_BTN_CAMERA"),deviceList:nt.getCameraList(),selectedDevice:this.cameraId,deviceEnabled:this.cameraEnabled,icons:["camera","camera-off"],events:{onSwitch:this.onCameraSwitch.bind(this),onSelect:this.onCameraSelect.bind(this)}})).render(),nt.canSelectSpeaker()?ut.create({deviceLabel:BX.message("IM_M_CALL_BTN_SPEAKER"),deviceList:nt.getSpeakerList(),selectedDevice:this.speakerId,deviceEnabled:this.speakerEnabled,icons:["speaker","speaker-off"],events:{onSwitch:this.onSpeakerSwitch.bind(this),onSelect:this.onSpeakerSelect.bind(this)}}).render():null]}),l.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom"},children:[l.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[l.Dom.create("input",{props:{id:"device-selector-hd-video",className:"bx-call-view-device-selector-bottom-item-checkbox"},attrs:{type:"checkbox",checked:this.allowHdVideo},events:{change:this.onAllowHdVideoChange.bind(this)}}),l.Dom.create("label",{props:{className:"bx-call-view-device-selector-bottom-item-label"},attrs:{for:"device-selector-hd-video"},text:BX.message("IM_M_CALL_HD_VIDEO")})]}),this.allowFaceImprove?l.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[l.Dom.create("input",{props:{id:"device-selector-mic-auto-params",className:"bx-call-view-device-selector-bottom-item-checkbox"},attrs:{type:"checkbox",checked:this.faceImproveEnabled},events:{change:this.onFaceImproveChange.bind(this)}}),l.Dom.create("label",{props:{className:"bx-call-view-device-selector-bottom-item-label"},attrs:{for:"device-selector-mic-auto-params"},text:BX.message("IM_SETTINGS_HARDWARE_CAMERA_FACE_IMPROVE")})]}):null,this.allowBackground?l.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[l.Dom.create("span",{props:{className:"bx-call-view-device-selector-bottom-item-action"},text:this.allowMask?BX.message("IM_M_CALL_BG_MASK_CHANGE"):BX.message("IM_M_CALL_BACKGROUND_CHANGE"),events:{click:function e(){v.open();t.popup.close()}}})]}):null,this.allowAdvancedSettings&&!!BX.MessengerCommon?l.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[l.Dom.create("span",{props:{className:"bx-call-view-device-selector-bottom-item-action"},text:BX.message("IM_M_CALL_ADVANCED_SETTINGS"),events:{click:function e(i){i.stopPropagation();t.eventEmitter.emit(lt.onAdvancedSettingsClick);t.popup.close()}}})]}):null]})]})}},{key:"toggleCameraAvailability",value:function e(t){if(t){this.cameraContainer.unblock();return}this.cameraContainer.block()}},{key:"toggleMicrophoneAvailability",value:function e(t){if(t){this.microphoneContainer.unblock();return}this.microphoneContainer.block()}},{key:"onMicrophoneSwitch",value:function e(){this.microphoneEnabled=!this.microphoneEnabled;this.eventEmitter.emit(lt.onMicrophoneSwitch,{microphoneEnabled:this.microphoneEnabled})}},{key:"onMicrophoneSelect",value:function e(t){this.eventEmitter.emit(lt.onMicrophoneSelect,{deviceId:t.data.deviceId})}},{key:"onCameraSwitch",value:function e(){this.cameraEnabled=!this.cameraEnabled;this.eventEmitter.emit(lt.onCameraSwitch,{cameraEnabled:this.cameraEnabled})}},{key:"onCameraSelect",value:function e(t){this.eventEmitter.emit(lt.onCameraSelect,{deviceId:t.data.deviceId})}},{key:"onSpeakerSwitch",value:function e(){this.speakerEnabled=!this.speakerEnabled;this.eventEmitter.emit(lt.onSpeakerSwitch,{speakerEnabled:this.speakerEnabled})}},{key:"onSpeakerSelect",value:function e(t){this.eventEmitter.emit(lt.onSpeakerSelect,{deviceId:t.data.deviceId})}},{key:"onAllowHdVideoChange",value:function e(t){this.allowHdVideo=t.currentTarget.checked;this.eventEmitter.emit(lt.onChangeHdVideo,{allowHdVideo:this.allowHdVideo})}},{key:"onAllowMirroringVideoChange",value:function e(t){nt.enableMirroring=t.target.checked}},{key:"onFaceImproveChange",value:function e(t){this.faceImproveEnabled=t.currentTarget.checked;this.eventEmitter.emit(lt.onChangeFaceImprove,{faceImproveEnabled:this.faceImproveEnabled})}},{key:"destroy",value:function e(){if(this.isDestroying){return}this.isDestroying=true;if(this.popup){this.popup.destroy();this.popup=null}this.eventEmitter.emit(lt.onDestroy,{})}}]);return e}();babelHelpers.defineProperty(ct,"Events",lt);var dt={onSelect:"onSelect",onSwitch:"onSwitch"};var ut=function(){function e(t){babelHelpers.classCallCheck(this,e);t=BX.type.isObject(t)?t:{};this.menuBlocked=t.blocked||false;this.deviceList=BX.prop.getArray(t,"deviceList",[]);this.selectedDevice=BX.prop.getString(t,"selectedDevice","");this.deviceEnabled=BX.prop.getBoolean(t,"deviceEnabled",false);this.deviceLabel=BX.prop.getString(t,"deviceLabel","");this.icons=BX.prop.getArray(t,"icons",[]);this.eventEmitter=new r.EventEmitter(this,"DeviceMenu");this.elements={root:null,switchIcon:null,menuInner:null,menuItems:{}};var i=BX.prop.getObject(t,"events",{});for(var n in i){if(!i.hasOwnProperty(n)){continue}this.eventEmitter.subscribe(n,i[n])}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-container"},children:[l.Dom.create("div",{props:{className:"bx-call-view-device-selector-switch-wrapper"},children:[this.elements.switchIcon=l.Dom.create("div",{props:{className:"bx-call-view-device-selector-device-icon "+this.getDeviceIconClass()}}),l.Dom.create("span",{props:{className:"bx-call-view-device-selector-device-text"},text:this.deviceLabel}),l.Dom.create("div",{props:{className:"bx-call-view-device-selector-device-switch"},children:[new BX.UI.Switcher({size:"small",checked:this.deviceEnabled,handlers:{toggled:this.onSwitchToggled.bind(this)}}).getNode()]})]}),this.elements.menuInner=l.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-inner"},children:this.deviceList.map(this.renderDevice.bind(this))})]});return this.elements.root}},{key:"renderDevice",value:function e(t){var i=this.selectedDevice===t.deviceId?"selected":"";var n={};n.root=l.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item"},dataset:{deviceId:t.deviceId},children:[n.icon=l.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item-icon "+i}}),l.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item-text"},text:t.label||"("+BX.message("IM_M_CALL_DEVICE_NO_NAME")+")"})],events:{click:this.onMenuItemClick.bind(this)}});this.elements.menuItems[t.deviceId]=n;return n.root}},{key:"block",value:function e(){this.menuBlocked=true;this.elements.root.classList.add("bx-call-view-device-selector-menu-container-blocked")}},{key:"unblock",value:function e(){this.menuBlocked=false;this.elements.root.classList.remove("bx-call-view-device-selector-menu-container-blocked")}},{key:"getDeviceIconClass",value:function e(){var t="";if(this.deviceEnabled&&this.icons.length>0){t=this.icons[0]}else if(!this.deviceEnabled&&this.icons.length>1){t=this.icons[1]}return t}},{key:"onSwitchToggled",value:function e(){if(this.menuBlocked){return}this.deviceEnabled=!this.deviceEnabled;this.elements.switchIcon.className="bx-call-view-device-selector-device-icon "+this.getDeviceIconClass();this.eventEmitter.emit(dt.onSwitch,{deviceEnabled:this.deviceEnabled})}},{key:"onMenuItemClick",value:function e(t){var i=this.selectedDevice;var n=t.currentTarget.dataset.deviceId;this.selectedDevice=n;if(this.elements.menuItems[i]){this.elements.menuItems[i]["icon"].classList.remove("selected")}if(this.elements.menuItems[this.selectedDevice]){this.elements.menuItems[this.selectedDevice]["icon"].classList.add("selected")}this.eventEmitter.emit(dt.onSelect,{deviceId:this.selectedDevice})}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var ht=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userList=t.userList;this.current=t.current;this.parentElement=t.parentElement;this.zIndex=t.zIndex;this.menu=null;this.callbacks={onSelect:l.Type.isFunction(t.onSelect)?t.onSelect:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;var i=[];this.userList.forEach((function(e){i.push({id:e.id,text:e.name||"unknown ("+e.id+")",className:t.current==e.id?"menu-popup-item-accept":"device-selector-empty",onclick:function i(){t.menu.close();t.callbacks.onSelect(e.id)}})}));this.menu=new o.Menu({id:"call-view-select-user",bindElement:this.parentElement,items:i,autoHide:true,zIndex:this.zIndex,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"bottom"},angle:false,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function e(){t.menu.popupWindow.destroy();o.MenuManager.destroy("call-view-select-device")},onPopupDestroy:function e(){t.menu=null}}});this.menu.popupWindow.show()}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var pt={Grid:1,Centered:2,Mobile:3};var vt={Preparing:1,Initializing:2,Calling:3,Connected:4,Error:5};var mt={Folded:"folded",Full:"full"};var ft={Started:"started",Resumed:"resumed",Paused:"paused",Stopped:"stopped"};var gt={None:"none",Video:"video",Audio:"audio"};var bt={None:1,Speaker:2,NonSpeaker:3};var Ct={onShow:"onShow",onClose:"onClose",onDestroy:"onDestroy",onButtonClick:"onButtonClick",onBodyClick:"onBodyClick",onReplaceCamera:"onReplaceCamera",onReplaceMicrophone:"onReplaceMicrophone",onReplaceSpeaker:"onReplaceSpeaker",onSetCentralUser:"onSetCentralUser",onLayoutChange:"onLayoutChange",onChangeHdVideo:"onChangeHdVideo",onChangeMicAutoParams:"onChangeMicAutoParams",onChangeFaceImprove:"onChangeFaceImprove",onUserClick:"onUserClick",onUserRename:"onUserRename",onUserPinned:"onUserPinned",onDeviceSelectorShow:"onDeviceSelectorShow",onOpenAdvancedSettings:"onOpenAdvancedSettings",onHasMainStream:"onHasMainStream"};var kt=999;var yt=1e3;var St=1001;var wt=250;var It=160;var Mt=90;var _t=15;var Tt=249;var Et=140;var Rt=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.title=t.title;this.container=t.container;this.baseZIndex=t.baseZIndex;this.cameraId=t.cameraId;this.microphoneId=t.microphoneId;this.speakerId="";this.speakerMuted=false;this.showChatButtons=t.showChatButtons===true;this.showUsersButton=t.showUsersButton===true;this.showShareButton=t.showShareButton!==false;this.showRecordButton=t.showRecordButton!==false;this.showDocumentButton=t.showDocumentButton!==false;this.showButtonPanel=t.showButtonPanel!==false;this.broadcastingMode=BX.prop.getBoolean(t,"broadcastingMode",false);this.broadcastingPresenters=BX.prop.getArray(t,"broadcastingPresenters",[]);this.currentPage=1;this.pagesCount=1;this.usersPerPage=0;this.language=t.language||"";this.lastPosition=1;this.userData={};if(t.userData){this.updateUserData(t.userData)}this.userLimit=t.userLimit||1;this.userId=BX.message("USER_ID");this.isIntranetOrExtranet=BX.prop.getBoolean(t,"isIntranetOrExtranet",true);this.users={};this.screenUsers={};this.userRegistry=new b;var n=new g({id:this.userId,state:BX.prop.getString(t,"localUserState",mr.Connected),localUser:true,order:yt,name:this.userData[this.userId]?this.userData[this.userId].name:"",avatar:this.userData[this.userId]?this.userData[this.userId].avatar_hr:""});this.userRegistry.push(n);this.localUser=new $e({parentContainer:this.container,userModel:n,allowBackgroundItem:v.isAvailable()&&this.isIntranetOrExtranet,allowMaskItem:v.isMaskAvailable()&&this.isIntranetOrExtranet,onUserRename:this._onUserRename.bind(this),onUserRenameInputFocus:this._onUserRenameInputFocus.bind(this),onUserRenameInputBlur:this._onUserRenameInputBlur.bind(this),onClick:this._onUserClick.bind(this),onPin:this._onUserPin.bind(this),onUnPin:this._onUserUnPin.bind(this)});this.centralUser=this.localUser;this.centralUserMobile=null;this.pinnedUser=null;this.presenterId=null;this.returnToGridAfterScreenStopped=false;this.mediaSelectionBlocked=t.mediaSelectionBlocked===true;this.visible=false;this.elements={root:null,wrap:null,watermark:null,container:null,overlay:null,topPanel:null,bottom:null,notificationPanel:null,panel:null,audioContainer:null,audio:{},center:null,localUserMobile:null,userBlock:null,ear:{left:null,right:null},userList:{container:null,addButton:null},userSelectorContainer:null,pinnedUserContainer:null,renameSlider:{input:null,button:null},pageNavigatorLeft:null,pageNavigatorLeftCounter:null,pageNavigatorRight:null,pageNavigatorRightCounter:null};this.buttons={title:null,grid:null,add:null,share:null,record:null,document:null,microphone:null,camera:null,speaker:null,screen:null,mobileMenu:null,chat:null,users:null,history:null,hangup:null,fullscreen:null,overlay:null,status:null,returnToCall:null,recordStatus:null,participants:null,participantsMobile:null,watermark:null,hd:null,protected:null,more:null};this.size=mt.Full;this.maxWidth=null;this.isMuted=false;this.isCameraOn=false;this.isFullScreen=false;this.isUserBlockFolded=false;this.recordState=this.getDefaultRecordState();this.blockedButtons={};var s=BX.prop.getArray(t,"blockedButtons",[]);s.forEach((function(e){return i.blockedButtons[e]=true}));this.hiddenButtons={};this.overflownButtons={};if(!this.showUsersButton){this.hiddenButtons["users"]=true}var a=BX.prop.getArray(t,"hiddenButtons",[]);a.forEach((function(e){return i.hiddenButtons[e]=true}));this.hiddenTopButtons={};var o=BX.prop.getArray(t,"hiddenTopButtons",[]);o.forEach((function(e){return i.hiddenTopButtons[e]=true}));this.uiState=t.uiState||vt.Calling;this.layout=t.layout||pt.Centered;this.roomState=bt.None;this.eventEmitter=new r.EventEmitter(this,"BX.Call.View");this.scrollInterval=0;this._onFullScreenChangeHandler=this._onFullScreenChange.bind(this);this._onResizeHandler=this._onResize.bind(this);this._onOrientationChangeHandler=BX.debounce(this._onOrientationChange.bind(this),500);this._onKeyDownHandler=this._onKeyDown.bind(this);this._onKeyUpHandler=this._onKeyUp.bind(this);this.resizeObserver=new BX.ResizeObserver(this._onResizeHandler);this.intersectionObserver=null;this.switchPresenterTimeout=0;this.deviceSelector=null;this.userSelector=null;this.pinnedUserContainer=null;this.renameSlider=null;this.userSize={width:0,height:0};this.hintManager=BX.UI.Hint.createInstance({popupParameters:{targetContainer:document.body,className:"bx-messenger-videocall-panel-item-hotkey-hint",bindOptions:{forceBindPosition:true}}});this.hotKey={all:Do.isDesktop(),microphone:true,microphoneSpace:true,camera:true,screen:true,record:true,speaker:true,chat:true,users:true,floorRequest:true,muteSpeaker:true,grid:true};this.hotKeyTemporaryBlock=0;this.init();this.subscribeEvents(t);if(l.Type.isPlainObject(t.userStates)){this.appendUsers(t.userStates)}}babelHelpers.createClass(e,[{key:"init",value:function e(){if(this.isFullScreenSupported()){if(l.Browser.isChrome()||l.Browser.isSafari()){window.addEventListener("fullscreenchange",this._onFullScreenChangeHandler);window.addEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler)}else if(l.Browser.isFirefox()){window.addEventListener("mozfullscreenchange",this._onFullScreenChangeHandler)}}if(l.Browser.isMobile()){document.documentElement.style.setProperty("--view-height",window.innerHeight+"px");window.addEventListener("orientationchange",this._onOrientationChangeHandler)}this.elements.audioContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-audio-container"}});if(nt.initialized){this.setSpeakerId(nt.defaultSpeaker)}else{nt.subscribe(nt.Events.initialized,function(){this.setSpeakerId(nt.defaultSpeaker)}.bind(this))}window.addEventListener("keydown",this._onKeyDownHandler);window.addEventListener("keyup",this._onKeyUpHandler);if(l.Browser.isMac()){this.keyModifier="&#8984; + Shift"}else{this.keyModifier="Ctrl + Shift"}this.container.appendChild(this.elements.audioContainer)}},{key:"subscribeEvents",value:function e(t){for(var i in Ct){if(Ct.hasOwnProperty(i)&&l.Type.isFunction(t[i])){this.setCallback(i,t[i])}}}},{key:"setCallback",value:function e(t,i){if(l.Type.isFunction(i)&&Ct.hasOwnProperty(t)){this.eventEmitter.subscribe(t,(function(e){i(e.data)}))}}},{key:"subscribe",value:function e(t,i){return this.eventEmitter.subscribe(t,i)}},{key:"unsubscribe",value:function e(t,i){return this.eventEmitter.unsubscribe(t,i)}},{key:"getNextPosition",value:function e(){return this.lastPosition++}},{key:"appendUsers",value:function e(t){if(!l.Type.isPlainObject(t)){return}var i=Object.keys(t);for(var n=0;n<i.length;n++){var s=i[n];this.addUser(s,t[s]?t[s]:mr.Idle)}}},{key:"setCentralUser",value:function e(t){var i=this;if(this.centralUser.id==t){return}if(!this.users[t]&&t!=this.userId){return}var n=this.centralUser;this.centralUser=t==this.userId?this.localUser:this.users[t];if(this.layout==pt.Centered||this.layout==pt.Mobile){if(this.layout==pt.Mobile){n.dismount()}this.updateUserList()}if(this.layout==pt.Mobile){if(this.centralUserMobile){this.centralUserMobile.setUserModel(this.userRegistry.get(t))}else{this.centralUserMobile=new R({userModel:this.userRegistry.get(t),onClick:function e(){return i.showUserMenu(i.centralUser.id)}});this.centralUserMobile.mount(this.elements.pinnedUserContainer)}}this.userRegistry.users.forEach((function(e){return e.centralUser=e.id==t}));this.eventEmitter.emit(Ct.onSetCentralUser,{userId:t,stream:t==this.userId?this.localUser.stream:this.users[t].stream})}},{key:"getLeftUser",value:function e(t){var i=null;for(var n=0;n<this.userRegistry.users.length;n++){var s=this.userRegistry.users[n];if(s.id==t&&i){return i}if(!s.localUser&&s.state==mr.Connected){i=s.id}}return i}},{key:"getRightUser",value:function e(t){var i=null;for(var n=this.userRegistry.users.length-1;n>=0;n--){var s=this.userRegistry.users[n];if(s.id==t&&i){return i}if(!s.localUser&&s.state==mr.Connected){i=s.id}}return i}},{key:"getUserCount",value:function e(){return Object.keys(this.users).length}},{key:"getConnectedUserCount",value:function e(t){var i=this.getConnectedUsers().length;if(t){var n=parseInt(this.userId);if(!this.broadcastingMode||this.broadcastingPresenters.includes(n)){i+=1}}return i}},{key:"getUsersWithVideo",value:function e(){var t=[];for(var i in this.users){if(this.users[i].hasVideo()){t.push(i)}}return t}},{key:"getConnectedUsers",value:function e(){var t=[];for(var i=0;i<this.userRegistry.users.length;i++){var n=this.userRegistry.users[i];if(n.id!=this.userId&&n.state==mr.Connected){t.push(n.id)}}return t}},{key:"getDisplayedUsers",value:function e(){var t=[];for(var i=0;i<this.userRegistry.users.length;i++){var n=this.userRegistry.users[i];if(n.id!=this.userId&&(n.state==mr.Connected||n.state==mr.Connecting)){t.push(n.id)}}return t}},{key:"hasUserWithScreenSharing",value:function e(){return this.userRegistry.users.some((function(e){return e.screenState}))}},{key:"getPresenterUserId",value:function e(){var t=this.presenterId||0;if(t==this.localUser.id){t=0}var i;var n=this.userRegistry.get(t);if(n&&n.screenState===true){return t}for(i in this.users){if(this.users.hasOwnProperty(i)&&this.userRegistry.get(i).screenState===true){return parseInt(i)}}if(n&&n.wasTalkingAgo()<1e3){return t}var s=0;var a=0;for(i in this.users){if(!this.users.hasOwnProperty(i)){continue}var r=this.userRegistry.get(i).wasTalkingAgo();if(r<1e3){return parseInt(i)}if(r<s){a=parseInt(i)}}if(a){return a}return this.centralUser.id}},{key:"switchPresenter",value:function e(){var t=this;var i=this.presenterId||0;var n=this.getPresenterUserId();if(!n){return}this.presenterId=n;this.userRegistry.users.forEach((function(e){return e.presenter=e.id==t.presenterId}));if(this.pinnedUser===null){this.setCentralUser(n);if(this.layout==pt.Centered&&i!==n){this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id})}}else if(i!==n){this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id})}if(this.layout==pt.Grid){var s=this.findUsersPage(this.presenterId);if(s){this.setCurrentPage(s)}}}},{key:"switchPresenterDeferred",value:function e(){clearTimeout(this.switchPresenterTimeout);this.switchPresenterTimeout=setTimeout(this.switchPresenter.bind(this),1e3)}},{key:"cancelSwitchPresenter",value:function e(){clearTimeout(this.switchPresenterTimeout)}},{key:"setUiState",value:function e(t){if(this.uiState==t){return}this.uiState=t;if(this.uiState==vt.Error&&this.elements.container){l.Dom.clean(this.elements.container);this.elements.container.appendChild(this.elements.overlay)}if(!this.elements.root){return}this.updateButtons();this.elements.wrap.classList.toggle("with-clouds",this.uiState==vt.Preparing)}},{key:"setLayout",value:function e(t){if(t==this.layout){return}this.layout=t;if(this.layout==pt.Centered||this.layout==pt.Mobile){this.elements.root.classList.remove("bx-messenger-videocall-grid");this.elements.root.classList.add("bx-messenger-videocall-centered");this.centralUser.mount(this.elements.center);this.elements.container.appendChild(this.elements.userBlock);if(this.layout!=pt.Mobile){this.elements.userBlock.appendChild(this.elements.userList.container)}this.centralUser.playVideo()}if(this.layout==pt.Grid){this.elements.root.classList.remove("bx-messenger-videocall-centered");this.elements.root.classList.add("bx-messenger-videocall-grid");this.elements.container.appendChild(this.elements.userList.container);this.elements.container.removeChild(this.elements.userBlock);if(this.isFullScreen&&this.buttons.participants){this.buttons.participants.update({foldButtonState:_.FoldButtonState.Hidden})}this.unpinUser();this.eventEmitter.emit(Ct.onHasMainStream,{userId:null})}if(this.layout==pt.Centered&&this.isFullScreen){this.setUserBlockFolded(true)}this.elements.root.classList.toggle("bx-messenger-videocall-fullscreen-mobile",this.layout==pt.Mobile);this.renderUserList();this.toggleEars();this.updateButtons();this.eventEmitter.emit(Ct.onLayoutChange,{layout:this.layout})}},{key:"setRoomState",value:function e(t){if(this.roomState===t){return}this.roomState=t;if(this.buttons.microphone){this.buttons.microphone.setSideIcon(this.getMicrophoneSideIcon(this.roomState))}}},{key:"getMicrophoneSideIcon",value:function e(t){switch(t){case bt.Speaker:return"ellipsis";case bt.NonSpeaker:return"pointer";case bt.None:default:return null}}},{key:"setCurrentPage",value:function e(t){if(t<1||t>this.pagesCount||t==this.currentPage){return}this.currentPage=t;if(this.elements.root){this.elements.pageNavigatorLeftCounter.innerHTML=this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount;this.elements.pageNavigatorRightCounter.innerHTML=this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}if(this.layout!==pt.Grid){return}this.renderUserList();this.toggleEars()}},{key:"calculateUsersPerPage",value:function e(){if(!this.elements.userList){return 1e3}var t=this.elements.userList.container.getBoundingClientRect();var i=Math.floor(t.width/Tt)||1;var n=Math.floor(t.height/Et)||1;var s=i*n-1;if(!s){return 1e3}if(s<=_t){return s}else{var a=Do.findBestElementSize(t.width,t.height,_t+1,Tt,Et);i=Math.floor(t.width/a.width);n=Math.floor(t.height/a.height);return i*n-1}}},{key:"calculatePagesCount",value:function e(t){var i=Math.ceil(this.getDisplayedUsers().length/t);return i>0?i:1}},{key:"recalculatePages",value:function e(){this.usersPerPage=this.calculateUsersPerPage();this.pagesCount=this.calculatePagesCount(this.usersPerPage);if(this.elements.root){this.elements.pageNavigatorLeftCounter.innerHTML=this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount;this.elements.pageNavigatorRightCounter.innerHTML=this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}}},{key:"findUsersPage",value:function e(t){if(t==this.userId||this.usersPerPage===0){return 0}var i=this.getDisplayedUsers();var n=0;for(var s=0;s<i.length;s++){if(i[s]==t){n=s+1;break}}return n?Math.ceil(n/this.usersPerPage):0}},{key:"setCameraId",value:function e(t){if(this.cameraId==t){return}if(this.localUser.stream&&this.localUser.stream.getVideoTracks().length>0){throw new Error("Can not set camera id while having active stream")}this.cameraId=t}},{key:"setMicrophoneId",value:function e(t){if(this.microphoneId==t){return}if(this.localUser.stream&&this.localUser.stream.getAudioTracks().length>0){throw new Error("Can not set microphone id while having active stream")}this.microphoneId=t}},{key:"setMicrophoneLevel",value:function e(t){var i;this.microphoneLevel=t;(i=this.buttons.microphone)===null||i===void 0?void 0:i.setLevel(t)}},{key:"setCameraState",value:function e(t){t=!!t;if(this.isCameraOn==t){return}this.isCameraOn=t;if(this.buttons.camera){if(this.isCameraOn){this.buttons.camera.enable()}else{this.buttons.camera.disable()}}}},{key:"setMuted",value:function e(t){t=!!t;if(this.isMuted==t){return}this.isMuted=t;if(this.buttons.microphone){if(this.isMuted){this.buttons.microphone.disable()}else{this.buttons.microphone.enable()}}this.userRegistry.get(this.userId).microphoneState=!t}},{key:"setLocalUserId",value:function e(t){if(t==this.userId){return}this.userId=parseInt(t);this.localUser.userModel.id=this.userId;this.localUser.userModel.name=this.userData[this.userId]?this.userData[this.userId].name:"";this.localUser.userModel.avatar=this.userData[this.userId]?this.userData[this.userId].avatar_hr:""}},{key:"setUserBlockFolded",value:function e(t){var i,n;this.isUserBlockFolded=t;(i=this.elements.userBlock)===null||i===void 0?void 0:i.classList.toggle("folded",this.isUserBlockFolded);(n=this.elements.root)===null||n===void 0?void 0:n.classList.toggle("bx-messenger-videocall-userblock-folded",this.isUserBlockFolded);if(this.isUserBlockFolded){if(this.buttons.participants&&this.layout==pt.Centered){this.buttons.participants.update({foldButtonState:_.FoldButtonState.Unfold})}}else{if(this.buttons.participants){this.buttons.participants.update({foldButtonState:this.isFullScreen&&this.layout==pt.Centered?_.FoldButtonState.Fold:_.FoldButtonState.Hidden})}}}},{key:"addUser",value:function e(t,i,n){t=t;if(this.users[t]){return}i=i||mr.Idle;if(!n){if(this.broadcastingPresenters.length>0&&!this.broadcastingPresenters.includes(t)){n=fr.RecvOnly}else{n=fr.SendRecv}}var s=new g({id:t,name:this.userData[t]?this.userData[t].name:"",avatar:this.userData[t]?this.userData[t].avatar_hr:"",state:i,order:i==mr.Connected?this.getNextPosition():kt,direction:n});this.userRegistry.push(s);if(!this.elements.audio[t]){this.elements.audio[t]=l.Dom.create("audio");this.elements.audioContainer.appendChild(this.elements.audio[t])}this.users[t]=new $e({parentContainer:this.container,userModel:s,audioElement:this.elements.audio[t],allowPinButton:this.getConnectedUserCount()>1,onClick:this._onUserClick.bind(this),onPin:this._onUserPin.bind(this),onUnPin:this._onUserUnPin.bind(this)});this.screenUsers[t]=new $e({parentContainer:this.container,userModel:s,allowPinButton:false,screenSharingUser:true});if(this.elements.root){this.updateUserList();this.updateButtons();this.updateUserButtons()}}},{key:"setUserDirection",value:function e(t,i){var n=this.userRegistry.get(t);if(!n||n.direction==i){return}n.direction=i;this.updateUserList()}},{key:"setLocalUserDirection",value:function e(t){if(this.localUser.userModel.direction!=t){this.localUser.userModel.direction=t;this.updateUserList()}}},{key:"setUserState",value:function e(t,i){var n=this.userRegistry.get(t);if(!n){return}if(i===mr.Connected&&this.uiState===vt.Calling){this.setUiState(vt.Connected)}n.state=i;if(this.centralUser.id==this.userId&&i==mr.Connected){this.setCentralUser(t)}else if(t==this.centralUser.id){if(i==mr.Connecting||i==mr.Failed){this.centralUser.blurVideo()}else if(i==mr.Connected){this.centralUser.blurVideo(false)}else if(i==mr.Idle){var s=this.getUsersWithVideo();var a=this.getConnectedUsers();if(a.length===0){this.setCentralUser(this.userId)}else if(s.length>0){this.setCentralUser(s[0])}else{this.setCentralUser(a[0])}}}if(i==mr.Connected&&n.order==kt){n.order=this.getNextPosition()}else if(i==mr.Idle){this.setUserFloorRequestState(t,false)}if(t==this.localUser.id){this.setCameraState(this.localUser.hasCameraVideo());this.localUser.userModel.cameraState=this.localUser.hasCameraVideo()}var r=t===this.localUser.id?[]:["panel"];this.updateUserList();this.updateButtons(r);this.updateUserButtons()}},{key:"setTitle",value:function e(t){this.title=t}},{key:"getUserTalking",value:function e(t){var i=this.userRegistry.get(t);if(!i){return false}return!!i.talking}},{key:"setUserTalking",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.talking=i}if(t==this.userId){return}if(t==this.presenterId&&!i){this.switchPresenterDeferred()}else{this.switchPresenter()}}},{key:"setUserStats",value:function e(t,i){if(this.users[t]){this.users[t].showStats(i)}if(this.screenUsers[t]){this.screenUsers[t].showStats(i)}}},{key:"setUserMicrophoneState",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.microphoneState=i}}},{key:"setUserCameraState",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.cameraState=i}}},{key:"setUserVideoPaused",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.videoPaused=i}}},{key:"getUserFloorRequestState",value:function e(t){var i=this.userRegistry.get(t);return i&&i.floorRequestState}},{key:"setUserFloorRequestState",value:function e(t,i){var n=this.userRegistry.get(t);if(!n){return}if(n.floorRequestState!=i){n.floorRequestState=i;if(t!=this.localUser.id&&i){this.showFloorRequestNotification(t)}}if(t==this.userId){this.setButtonActive("floorRequest",i)}}},{key:"pinUser",value:function e(t){if(!(t in this.users)&&t!==Number(this.userId)){console.error("User "+t+" is not known");return}this.pinnedUser=!this.users[t]?this.localUser:this.users[t];this.userRegistry.users.forEach((function(e){return e.pinned=e.id==t}));this.setCentralUser(t);this.eventEmitter.emit(Ct.onUserPinned,{userId:t});this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id})}},{key:"unpinUser",value:function e(){this.pinnedUser=null;this.userRegistry.users.forEach((function(e){return e.pinned=false}));this.eventEmitter.emit(Ct.onUserPinned,{userId:null});this.switchPresenterDeferred()}},{key:"showFloorRequestNotification",value:function e(t){var i=this.userRegistry.get(t);if(!i){return}var n=st.create({userModel:i});n.mount(this.elements.notificationPanel);ot.Instance.addNotification(n)}},{key:"setUserScreenState",value:function t(i,n){var s=this.userRegistry.get(i);if(!s){return}s.screenState=n;if(i!=this.userId){if(n===true&&this.layout===e.Layout.Grid){this.setLayout(pt.Centered);this.returnToGridAfterScreenStopped=true}if(n===false&&this.layout===pt.Centered&&!this.hasUserWithScreenSharing()&&!this.pinnedUser&&this.returnToGridAfterScreenStopped){this.returnToGridAfterScreenStopped=false;this.setLayout(pt.Grid)}this.switchPresenter()}}},{key:"flipLocalVideo",value:function e(t){this.localUser.flipVideo=!!t}},{key:"setLocalStream",value:function e(t){var i=t.mediaRenderer;var n=t.stream;var s=t.removed;var a=t.flipVideo;if(s){i.stream=null}if(i){this.localUser.videoRenderer=i}else{this.localUser.videoTrack=n.getVideoTracks().length>0?n.getVideoTracks()[0]:null}if(!l.Type.isUndefined(a)){this.flipLocalVideo(a)}this.setCameraState(this.localUser.hasCameraVideo());this.localUser.userModel.cameraState=this.localUser.hasCameraVideo();var r=n.getVideoTracks();if(r.length>0){var o=r[0].getSettings();this.cameraId=o.deviceId||""}else if(!i){this.cameraId=""}var c=n.getAudioTracks();if(c.length>0){var d=c[0].getSettings();this.microphoneId=d.deviceId||""}if(this.layout!==pt.Grid&&this.centralUser.id==this.userId){if(i){this.centralUser.videoRenderer=i}else if(r.length>0||Object.keys(this.users).length===0){this.centralUser.videoTrack=r[0]}else{this.setCentralUser(Object.keys(this.users)[0])}}else{this.updateUserList()}}},{key:"setSpeakerId",value:function e(t){if(this.speakerId==t){return}if(!("setSinkId"in HTMLMediaElement.prototype)){console.error("Speaker selection is not supported")}this.speakerId=t;for(var i in this.elements.audio){this.elements.audio[i].setSinkId(this.speakerId)}}},{key:"muteSpeaker",value:function e(t){this.speakerMuted=!!t;for(var i in this.elements.audio){this.elements.audio[i].volume=this.speakerMuted?0:1}if(!this.buttons.speaker){return}if(this.speakerMuted){this.buttons.speaker.disable();this.buttons.speaker.hideArrow()}else{this.buttons.speaker.enable();if(nt.canSelectSpeaker()){this.buttons.speaker.showArrow()}}}},{key:"setVideoRenderer",value:function e(t,i){if(!this.users[t]){throw Error("User "+t+" is not a part of this call")}if(i===null){this.users[t].videoRenderer=null;return}if(!("render"in i)||!l.Type.isFunction(i.render)){throw Error("mediaRenderer should have method render")}if(!("kind"in i)||i.kind!=="video"&&i.kind!=="sharing"){throw Error("mediaRenderer should be of video kind")}this.users[t].videoRenderer=i}},{key:"setUserMedia",value:function e(t,i,n){if(i==="audio"){this.users[t].audioTrack=n}if(i==="video"){this.users[t].videoTrack=n}if(i==="screen"){this.screenUsers[t].videoTrack=n;this.updateUserList();this.setUserScreenState(t,n!==null)}}},{key:"removeScreenUsers",value:function e(){for(var t in this.screenUsers){this.screenUsers[t].videoTrack=null}this.updateUserList()}},{key:"setBadNetworkIndicator",value:function e(t,i){if(this.users[t]){this.users[t].badNetworkIndicator=i}}},{key:"setUserHasConnectionProblem",value:function e(t,i){if(this.users[t]){this.users[t].hasConnectionProblem=i}}},{key:"applyIncomingVideoConstraints",value:function e(){var t;var i;if(this.layout===pt.Grid){for(t in this.users){i=this.users[t];i.setIncomingVideoConstraints(this.userSize.width,this.userSize.height)}}else if(this.layout===pt.Centered){for(t in this.users){i=this.users[t];if(t==this.centralUser.id){var n=this.elements.center.getBoundingClientRect();i.setIncomingVideoConstraints(Math.floor(n.width),Math.floor(n.height))}else{i.setIncomingVideoConstraints(It,Mt)}}}}},{key:"getDefaultRecordState",value:function e(){return{state:ft.Stopped,userId:0,date:{start:null,pause:[]}}}},{key:"setRecordState",value:function e(t){this.recordState=t;if(this.buttons.recordStatus){this.buttons.recordStatus.update(this.recordState)}if(this.recordState.userId!=this.userId){if(this.recordState.state===ft.Stopped){this.unblockButtons(["record"])}else{this.blockButtons(["record"])}}if(this.elements.topPanel){if(this.recordState.state===ft.Stopped){delete this.elements.topPanel.dataset.recordState}else{this.elements.topPanel.dataset.recordState=t.state}}}},{key:"show",value:function e(){if(!this.elements.root){this.render()}this.container.appendChild(this.elements.root);if(this.layout!==pt.Mobile){this.startIntersectionObserver()}this.updateButtons();this.updateUserList();this.resumeVideo();this.toggleEars();this.visible=true;this.eventEmitter.emit(Ct.onShow)}},{key:"hide",value:function e(){if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}l.Dom.remove(this.elements.root);this.visible=false}},{key:"startIntersectionObserver",value:function e(){if(!("IntersectionObserver"in window)){return}this.intersectionObserver=new IntersectionObserver(this._onIntersectionChange.bind(this),{root:this.elements.userList.container,threshold:.5})}},{key:"observeIntersections",value:function e(t){if(this.intersectionObserver&&t.elements.root){this.intersectionObserver.observe(t.elements.root)}}},{key:"unobserveIntersections",value:function e(t){if(this.intersectionObserver&&t.elements.root){this.intersectionObserver.unobserve(t.elements.root)}}},{key:"showDeviceSelector",value:function e(t){var i=this,n;if(this.deviceSelector){return}this.deviceSelector=new ct({viewElement:this.container,parentElement:t,zIndex:this.baseZIndex+500,microphoneEnabled:!this.isMuted,microphoneId:this.microphoneId||nt.defaultMicrophone,cameraEnabled:this.isCameraOn,cameraId:this.cameraId,speakerEnabled:!this.speakerMuted,speakerId:this.speakerId,allowHdVideo:nt.preferHdQuality,faceImproveEnabled:Do.isDesktop()&&a.DesktopApi.isDesktop()&&a.DesktopApi.getCameraSmoothingStatus(),allowFaceImprove:Do.isDesktop()&&a.DesktopApi.isDesktop()&&a.DesktopApi.getApiVersion()>64,allowBackground:v.isAvailable()&&this.isIntranetOrExtranet,allowMask:v.isMaskAvailable()&&this.isIntranetOrExtranet,allowAdvancedSettings:typeof BXIM!=="undefined"&&this.isIntranetOrExtranet,switchCameraBlocked:this.blockedButtons["camera"],switchMicrophoneBlocked:this.blockedButtons["microphone"],events:(n={},babelHelpers.defineProperty(n,ct.Events.onMicrophoneSelect,this._onMicrophoneSelected.bind(this)),babelHelpers.defineProperty(n,ct.Events.onMicrophoneSwitch,this._onMicrophoneButtonClick.bind(this)),babelHelpers.defineProperty(n,ct.Events.onCameraSelect,this._onCameraSelected.bind(this)),babelHelpers.defineProperty(n,ct.Events.onCameraSwitch,this._onCameraButtonClick.bind(this)),babelHelpers.defineProperty(n,ct.Events.onSpeakerSelect,this._onSpeakerSelected.bind(this)),babelHelpers.defineProperty(n,ct.Events.onSpeakerSwitch,this._onSpeakerButtonClick.bind(this)),babelHelpers.defineProperty(n,ct.Events.onChangeHdVideo,this._onChangeHdVideo.bind(this)),babelHelpers.defineProperty(n,ct.Events.onChangeMicAutoParams,this._onChangeMicAutoParams.bind(this)),babelHelpers.defineProperty(n,ct.Events.onChangeFaceImprove,this._onChangeFaceImprove.bind(this)),babelHelpers.defineProperty(n,ct.Events.onAdvancedSettingsClick,(function(){return i.eventEmitter.emit(Ct.onOpenAdvancedSettings)})),babelHelpers.defineProperty(n,ct.Events.onDestroy,(function(){return i.deviceSelector=null})),babelHelpers.defineProperty(n,ct.Events.onShow,(function(){return i.eventEmitter.emit(Ct.onDeviceSelectorShow,{})})),n)});this.deviceSelector.show()}},{key:"showCallMenu",value:function e(){var t=this;var i=[{text:BX.message("IM_M_CALL_BTN_WANT_TO_SAY"),iconClass:"hand",onClick:this._onMobileCallMenuFloorRequestClick.bind(this)},{text:BX.message("IM_M_CALL_MOBILE_MENU_PARTICIPANTS_LIST"),iconClass:"participants",onClick:this._onMobileCallMenShowParticipantsClick.bind(this)},{text:BX.message("IM_M_CALL_MOBILE_MENU_COPY_INVITE"),iconClass:"add-participant",onClick:this._onMobileCallMenuCopyInviteClick.bind(this)},!this.isIntranetOrExtranet?{text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME"),iconClass:"change-name",onClick:function e(){t.callMenu.close();setTimeout(t.showRenameSlider.bind(t),100)}}:null,{separator:true},{text:BX.message("IM_M_CALL_MOBILE_MENU_CANCEL"),enabled:false,onClick:this._onMobileCallMenuCancelClick.bind(this)}];this.callMenu=new H({parent:this.elements.root,items:i,onClose:function e(){return t.callMenu.destroy()},onDestroy:function e(){return t.callMenu=null}});this.callMenu.show()}},{key:"showUserMenu",value:function e(t){var i=this;var n=this.userRegistry.get(t);if(!n){return false}var s=null;if(this.pinnedUser&&this.pinnedUser.id==t){s={text:BX.message("IM_M_CALL_MOBILE_MENU_UNPIN"),iconClass:"unpin",onClick:function e(){i.userMenu.close();i.unpinUser()}}}else if(this.userId!=t){s={text:BX.message("IM_M_CALL_MOBILE_MENU_PIN"),iconClass:"pin",onClick:function e(){i.userMenu.close();i.pinUser(t)}}}var a=[{userModel:n,enabled:false},{separator:true},s,this.userId==t&&!this.isIntranetOrExtranet?{text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME"),iconClass:"change-name",onClick:function e(){i.userMenu.close();setTimeout(i.showRenameSlider.bind(i),100)}}:null,{separator:true},{text:BX.message("IM_M_CALL_MOBILE_MENU_CANCEL"),enabled:false,onClick:function e(){return i.userMenu.close()}}];this.userMenu=new H({parent:this.elements.root,items:a,onClose:function e(){return i.userMenu.destroy()},onDestroy:function e(){return i.userMenu=null}});this.userMenu.show()}},{key:"showParticipantsMenu",value:function e(){var t=this;if(this.participantsMenu){return}var i=[];i.push({userModel:this.localUser.userModel,showSubMenu:true,onClick:function(){this.participantsMenu.close();this.showUserMenu(this.localUser.userModel.id)}.bind(this)});this.userRegistry.users.forEach((function(e){if(e.localUser||e.state!=mr.Connected){return}if(i.length>0){i.push({separator:true})}i.push({userModel:e,showSubMenu:true,onClick:function i(){t.participantsMenu.close();t.showUserMenu(e.id)}})}));if(i.length===0){return false}this.participantsMenu=new H({parent:this.elements.root,items:i,header:BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.getConnectedUserCount(true)),largeIcons:true,onClose:function(){this.participantsMenu.destroy()}.bind(this),onDestroy:function(){this.participantsMenu=null}.bind(this)});this.participantsMenu.show();return true}},{key:"showMessage",value:function e(t){if(!this.elements.root){this.render();this.container.appendChild(this.elements.root)}var i=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"}});if(l.Type.isStringFilled(t.text)){var n=l.Dom.create("div",{props:{className:"bx-messenger-videocall-status-text"},text:t.text});i.appendChild(n)}if(this.elements.overlay.childElementCount){l.Dom.clean(this.elements.overlay)}this.elements.overlay.appendChild(i)}},{key:"hideMessage",value:function e(){this.elements.overlay.textContent=""}},{key:"showFatalError",value:function e(t){this.showMessage(t);this.setUiState(vt.Error);this.elements.userList.container.style.display="none"}},{key:"close",value:function e(){if(this.buttons.recordStatus){this.buttons.recordStatus.stopViewUpdate()}this.recordState=this.getDefaultRecordState();if(this.elements.root){BX.remove(this.elements.root)}this.visible=false;this.eventEmitter.emit(Ct.onClose)}},{key:"setSize",value:function e(t){if(this.size==t){return}this.size=t;if(this.size==mt.Folded){if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}if(this.elements.panel){this.elements.panel.classList.add("bx-messenger-videocall-panel-folded")}l.Dom.remove(this.elements.container);l.Dom.remove(this.elements.topPanel);this.elements.root.style.removeProperty("max-width");this.updateButtons()}else{if(this.elements.panel){this.elements.panel.classList.remove("bx-messenger-videocall-panel-folded")}this.elements.wrap.appendChild(this.elements.topPanel);this.elements.wrap.appendChild(this.elements.container);if(this.maxWidth>0){this.elements.root.style.maxWidth=Math.max(this.maxWidth,wt)+"px"}this.updateButtons();this.updateUserList();this.resumeVideo()}}},{key:"isButtonBlocked",value:function e(t){switch(t){case"camera":return this.uiState!==vt.Preparing&&this.uiState!==vt.Connected||this.blockedButtons[t]===true;case"chat":return!this.showChatButtons||this.blockedButtons[t]===true;case"floorRequest":return this.uiState!==vt.Connected||this.blockedButtons[t]===true;case"screen":return!this.showShareButton||!this.isScreenSharingSupported()||this.isFullScreen||this.blockedButtons[t]===true;case"users":return!this.showUsersButton||this.blockedButtons[t]===true;case"record":return!this.showRecordButton||this.blockedButtons[t]===true;case"document":return!this.showDocumentButton||this.blockedButtons[t]===true;default:return this.blockedButtons[t]===true}}},{key:"isButtonHidden",value:function e(t){return this.hiddenButtons[t]===true}},{key:"showButton",value:function e(t){this.showButtons([t])}},{key:"hideButton",value:function e(t){this.hideButtons([t])}},{key:"checkPanelOverflow",value:function e(){var t=this.elements.panel.scrollWidth-this.elements.panel.offsetWidth;var i=55;if(t>0){var n=Math.ceil(t/i);if(Object.keys(this.overflownButtons).length===0){n+=1}var s=this.getButtonList();for(var a=s.length-1;a>0;a--){if(s[a]==="hangup"||s[a]==="close"||s[a]==="more"){continue}this.overflownButtons[s[a]]=true;n-=1;if(!n){break}}return true}else{var r=Object.keys(this.overflownButtons).length;if(r>0){var o=this.calculateUnusedPanelSpace();if(o>i){var l=Math.min(Math.floor(o/i),r);var c=r-l;if(c===1){l+=1}if(l==r){this.overflownButtons={}}else{for(var d=0;d<l;d++){delete this.overflownButtons[Object.keys(this.overflownButtons)[0]]}}return true}}}return false}},{key:"showButtons",value:function e(t){var i=this;if(!l.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){if(i.hiddenButtons.hasOwnProperty(e)){delete i.hiddenButtons[e]}}));this.updateButtons()}},{key:"hideButtons",value:function e(t){var i=this;if(!l.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){return i.hiddenButtons[e]=true}));this.updateButtons()}},{key:"blockAddUser",value:function e(){this.blockedButtons["add"]=true;if(this.elements.userList.addButton){l.Dom.remove(this.elements.userList.addButton);this.elements.userList.addButton=null}}},{key:"blockSwitchCamera",value:function e(){this.blockedButtons["camera"]=true;if(this.deviceSelector){this.deviceSelector.toggleCameraAvailability(false)}}},{key:"unblockSwitchCamera",value:function e(){delete this.blockedButtons["camera"];if(this.deviceSelector){this.deviceSelector.toggleCameraAvailability(true)}}},{key:"blockSwitchMicrophone",value:function e(){this.blockedButtons["microphone"]=true;if(this.deviceSelector){this.deviceSelector.toggleMicrophoneAvailability(false)}}},{key:"unblockSwitchMicrophone",value:function e(){delete this.blockedButtons["microphone"];if(this.deviceSelector){this.deviceSelector.toggleMicrophoneAvailability(true)}}},{key:"blockScreenSharing",value:function e(){this.blockedButtons["screen"]=true}},{key:"blockHistoryButton",value:function e(){this.blockedButtons["history"]=true}},{key:"blockButtons",value:function e(t){var i=this;if(!l.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){i.blockedButtons[e]=true;if(i.buttons[e]){i.buttons[e].setBlocked(true)}}))}},{key:"unblockButtons",value:function e(t){var i=this;if(!l.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){delete i.blockedButtons[e];if(i.buttons[e]){i.buttons[e].setBlocked(i.isButtonBlocked(e))}}))}},{key:"disableMediaSelection",value:function e(){this.mediaSelectionBlocked=true}},{key:"enableMediaSelection",value:function e(){this.mediaSelectionBlocked=false;if(this.buttons.microphone&&this.isMediaSelectionAllowed()){this.buttons.microphone.showArrow()}if(this.buttons.camera&&this.isMediaSelectionAllowed()){this.buttons.camera.showArrow()}}},{key:"isMediaSelectionAllowed",value:function e(){return this.layout!=pt.Mobile&&(this.uiState==vt.Preparing||this.uiState==vt.Connected)&&!this.mediaSelectionBlocked&&!this.isFullScreen}},{key:"getButtonList",value:function e(){var t=this;if(this.uiState==vt.Error){return["close"]}if(this.uiState==vt.Initializing){return["hangup"]}if(this.size==mt.Folded){return["title","spacer","returnToCall","hangup"]}var i=[];i.push("microphone");i.push("camera");if(this.layout!=pt.Mobile){i.push("speaker")}else{i.push("mobileMenu")}i.push("chat");i.push("users");if(this.layout!=pt.Mobile){i.push("floorRequest");i.push("screen");i.push("record");i.push("document")}i=i.filter((function(e){return!t.hiddenButtons.hasOwnProperty(e)&&!t.overflownButtons.hasOwnProperty(e)}));if(Object.keys(this.overflownButtons).length>0){i.push("more")}if(this.uiState==vt.Preparing){i.push("close")}else{i.push("hangup")}return i}},{key:"getTopButtonList",value:function e(){var t=this;var i=[];if(this.layout==pt.Mobile){return["participantsMobile"]}i.push("watermark");i.push("hd");i.push("separator");i.push("protected");i.push("recordStatus");i.push("spacer");var n=false;if(this.uiState===vt.Connected&&this.layout!=pt.Mobile){i.push("grid");n=true}if(this.uiState!=vt.Preparing&&this.isFullScreenSupported()&&this.layout!=pt.Mobile){i.push("fullscreen");n=true}if(this.uiState!=vt.Preparing){if(n){i.push("separator")}i.push("participants")}var s="";i=i.filter((function(e){if(s==="spacer"&&e==="separator"){return true}s=e;return!t.hiddenTopButtons.hasOwnProperty(e)}));return i}},{key:"render",value:function e(){var t=this;this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-videocall"},children:[this.elements.wrap=l.Dom.create("div",{props:{className:"bx-messenger-videocall-wrap"},children:[this.elements.container=l.Dom.create("div",{props:{className:"bx-messenger-videocall-inner"},children:[this.elements.center=l.Dom.create("div",{props:{className:"bx-messenger-videocall-central-user"},events:{touchstart:this._onCenterTouchStart.bind(this),touchend:this._onCenterTouchEnd.bind(this)}}),this.elements.pageNavigatorLeft=l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator left"},children:[this.elements.pageNavigatorLeftCounter=l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-counter left"},html:this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-icon left"}})],events:{click:this._onLeftPageNavigatorClick.bind(this)}}),this.elements.pageNavigatorRight=l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator right"},children:[this.elements.pageNavigatorRightCounter=l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-counter right"},html:this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}),l.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-icon right"}})],events:{click:this._onRightPageNavigatorClick.bind(this)}})]}),this.elements.topPanel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-panel"}}),this.elements.notificationPanel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-notification-panel"}}),this.elements.bottom=l.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom"},children:[this.elements.userSelectorContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom-user-selector-container"}}),this.elements.pinnedUserContainer=l.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom-pinned-user-container"}})]})]})],events:{click:this._onBodyClick.bind(this)}});if(this.uiState==vt.Preparing){this.elements.wrap.classList.add("with-clouds")}if(this.showButtonPanel){this.elements.panel=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel"}});this.elements.bottom.appendChild(this.elements.panel)}else{this.elements.root.classList.add("bx-messenger-videocall-no-button-panel")}if(this.layout==pt.Mobile){this.userSelector=new P({userRegistry:this.userRegistry});this.userSelector.mount(this.elements.userSelectorContainer);this.elements.ear.left=l.Dom.create("div",{props:{className:"bx-messenger-videocall-mobile-ear left"},events:{click:this._onLeftEarClick.bind(this)}});this.elements.ear.right=l.Dom.create("div",{props:{className:"bx-messenger-videocall-mobile-ear right"},events:{click:this._onRightEarClick.bind(this)}});this.elements.localUserMobile=l.Dom.create("div",{props:{className:"bx-messenger-videocall-local-user-mobile"}});if(window.innerHeight<window.innerWidth){this.elements.root.classList.add("orientation-landscape")}this.elements.wrap.appendChild(this.elements.ear.left);this.elements.wrap.appendChild(this.elements.ear.right);this.elements.wrap.appendChild(this.elements.localUserMobile)}this.centralUser.mount(this.elements.center);this.elements.overlay=l.Dom.create("div",{props:{className:"bx-messenger-videocall-overlay"}});this.elements.userBlock=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-block"},children:[this.elements.ear.top=l.Dom.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-top"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-ear-icon"}})],events:{mouseenter:this.scrollUserListUp.bind(this),mouseleave:this.stopScroll.bind(this)}}),this.elements.ear.bottom=l.Dom.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-bottom"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-ear-icon"}})],events:{mouseenter:this.scrollUserListDown.bind(this),mouseleave:this.stopScroll.bind(this)}})]});this.elements.userList.container=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-list"},events:{scroll:l.Runtime.debounce(this.toggleEars.bind(this),300),wheel:function e(i){return t.elements.userList.container.scrollTop+=i.deltaY}}});this.elements.userList.addButton=l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-add"},children:[l.Dom.create("div",{props:{className:"bx-messenger-videocall-user-add-inner"}})],style:{order:St},events:{click:this._onAddButtonClick.bind(this)}});if(this.layout==pt.Centered||this.layout==pt.Mobile){this.centralUser.mount(this.elements.center);this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id});this.elements.root.classList.add("bx-messenger-videocall-centered");if(this.layout!=pt.Mobile){this.elements.container.appendChild(this.elements.userBlock)}}if(this.layout==pt.Grid){this.elements.root.classList.add("bx-messenger-videocall-grid")}if(this.layout==pt.Mobile){this.elements.root.classList.add("bx-messenger-videocall-fullscreen-mobile")}this.resizeObserver.observe(this.elements.root);this.resizeObserver.observe(this.container);return this.elements.root}},{key:"renderUserList",value:function e(){var t=this.shouldShowLocalUser();var i=0;var n=0;var s=0;var a=0;if(this.layout==pt.Grid&&this.pagesCount>1){n=(this.currentPage-1)*this.usersPerPage}for(var r=0;r<this.userRegistry.users.length;r++){var o=this.userRegistry.users[r];var c=o.id;if(!this.users.hasOwnProperty(c)){continue}var d=this.users[c];var u=this.screenUsers[c];if(c==this.centralUser.id&&(this.layout==pt.Centered||this.layout==pt.Mobile)){this.unobserveIntersections(d);if(u.hasVideo()){u.mount(this.elements.center);u.visible=true;d.mount(this.elements.userList.container)}else{d.visible=true;d.mount(this.elements.center);u.dismount()}continue}var h=o.state;var p=h!=mr.Idle&&h!=mr.Declined&&h!=mr.Unavailable&&h!=mr.Busy&&o.direction!=fr.RecvOnly;if(p&&n>0&&s<n){s++;p=false}if(p&&this.layout==pt.Grid&&this.usersPerPage>0&&a>=this.usersPerPage){p=false}if(!p){d.dismount();this.unobserveIntersections(d);u.dismount();continue}if(u.hasVideo()){u.mount(this.elements.userList.container);i++}else{u.dismount()}d.mount(this.elements.userList.container);this.observeIntersections(d);a++;i++}if(t){if(this.layout==pt.Centered&&this.userId==this.centralUser.id||this.layout==pt.Mobile){this.localUser.mount(this.elements.center,true);this.localUser.visible=true}else{this.localUser.mount(this.elements.userList.container);if(this.layout==pt.Centered&&this.intersectionObserver);else{this.localUser.visible=true}}i++}else{this.localUser.dismount()}if(this.layout==pt.Grid){this.updateGridUserSize(i)}else{this.elements.userList.container.classList.add("bx-messenger-videocall-user-list-small");this.elements.userList.container.style.removeProperty("--avatar-size");this.updateCentralUserAvatarSize()}this.applyIncomingVideoConstraints();var v=this.layout==pt.Centered&&i>0&&this.uiState===vt.Connected&&!this.isButtonBlocked("add")&&this.getConnectedUserCount()<this.userLimit-1;if(v&&!this.isFullScreen){this.elements.userList.container.appendChild(this.elements.userList.addButton)}else{l.Dom.remove(this.elements.userList.addButton)}this.elements.root.classList.toggle("bx-messenger-videocall-user-list-empty",this.elements.userList.container.childElementCount===0);this.localUser.updatePanelDeferred()}},{key:"shouldShowLocalUser",value:function e(){return this.localUser.userModel.state!=mr.Idle&&this.localUser.userModel.direction!=fr.RecvOnly}},{key:"updateGridUserSize",value:function e(t){var i=this.elements.userList.container.getBoundingClientRect();this.userSize=Do.findBestElementSize(i.width,i.height,t,Tt,Et);var n=Math.round(this.userSize.height*.45);this.elements.userList.container.style.setProperty("--grid-user-width",this.userSize.width+"px");this.elements.userList.container.style.setProperty("--grid-user-height",this.userSize.height+"px");this.elements.userList.container.style.setProperty("--avatar-size",n+"px");if(this.userSize.width<220){this.elements.userList.container.classList.add("bx-messenger-videocall-user-list-small")}else{this.elements.userList.container.classList.remove("bx-messenger-videocall-user-list-small")}}},{key:"updateCentralUserAvatarSize",value:function e(){var t;var i;if(this.layout==pt.Mobile){t=this.elements.root.getBoundingClientRect();i=Math.round(t.width*.55)}else if(this.layout==pt.Centered){t=this.elements.center.getBoundingClientRect();i=Math.min(Math.round(t.height*.45),Math.round(t.width*.45));this.centralUser.setIncomingVideoConstraints(Math.floor(t.width),Math.floor(t.height))}this.elements.center.style.setProperty("--avatar-size",i+"px")}},{key:"renderButtons",value:function e(t){var i=this;var n,s,a,r;n=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner"}});if(this.layout===pt.Mobile||this.size===mt.Folded){s=n;a=n;r=n}else{s=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-left"}});a=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-center"}});r=l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-right"}});n.appendChild(s);n.appendChild(a);n.appendChild(r)}for(var o=0;o<t.length;o++){switch(t[o]){case"title":this.buttons.title=new k({text:this.title,isGroupCall:Object.keys(this.users).length>1});s.appendChild(this.buttons.title.render());break;case"share":this.buttons.share=new y({class:"share",text:BX.message("IM_M_CALL_BTN_LINK"),onClick:this._onShareButtonClick.bind(this)});a.appendChild(this.buttons.share.render());break;case"microphone":this.buttons.microphone=new S({class:"microphone",text:BX.message("IM_M_CALL_BTN_MIC"),enabled:!this.isMuted,arrowHidden:this.layout==pt.Mobile,arrowEnabled:this.isMediaSelectionAllowed(),showPointer:true,blocked:this.isButtonBlocked("microphone"),showLevel:true,sideIcon:this.getMicrophoneSideIcon(this.roomState),onClick:function e(t){i._onMicrophoneButtonClick(t);i._showMicrophoneHint(t)},onArrowClick:this._onMicrophoneArrowClick.bind(this),onMouseOver:this._showMicrophoneHint.bind(this),onMouseOut:function e(){return i._destroyHotKeyHint()},onSideIconClick:this._onMicrophoneSideIconClick.bind(this)});s.appendChild(this.buttons.microphone.render());break;case"camera":this.buttons.camera=new S({class:"camera",text:BX.message("IM_M_CALL_BTN_CAMERA"),enabled:this.isCameraOn,arrowHidden:this.layout==pt.Mobile,arrowEnabled:this.isMediaSelectionAllowed(),blocked:this.isButtonBlocked("camera"),onClick:this._onCameraButtonClick.bind(this),onArrowClick:this._onCameraArrowClick.bind(this),onMouseOver:function e(t){i._showHotKeyHint(t.currentTarget.firstChild,"camera",i.keyModifier+" + V")},onMouseOut:function e(){i._destroyHotKeyHint()}});s.appendChild(this.buttons.camera.render());break;case"screen":if(!this.buttons.screen){this.buttons.screen=new y({class:"screen",text:BX.message("IM_M_CALL_BTN_SCREEN"),blocked:this.isButtonBlocked("screen"),onClick:this._onScreenButtonClick.bind(this),onMouseOver:function e(t){i._showHotKeyHint(t.currentTarget,"screen",i.keyModifier+" + S")},onMouseOut:function e(){i._destroyHotKeyHint()}})}else{this.buttons.screen.setBlocked(this.isButtonBlocked("screen"))}a.appendChild(this.buttons.screen.render());break;case"users":if(!this.buttons.users){this.buttons.users=new y({class:"users",backgroundClass:"calm-counter",text:BX.message("IM_M_CALL_BTN_USERS"),blocked:this.isButtonBlocked("users"),onClick:this._onUsersButtonClick.bind(this),onMouseOver:function(e){this._showHotKeyHint(e.currentTarget,"users",this.keyModifier+" + U")}.bind(this),onMouseOut:function(){this._destroyHotKeyHint()}.bind(this)})}else{this.buttons.users.setBlocked(this.isButtonBlocked("users"))}a.appendChild(this.buttons.users.render());break;case"record":if(!this.buttons.record){this.buttons.record=new y({class:"record",backgroundClass:"bx-messenger-videocall-panel-background-record",text:BX.message("IM_M_CALL_BTN_RECORD"),blocked:this.isButtonBlocked("record"),onClick:this._onRecordToggleClick.bind(this),onMouseOver:function e(t){if(i.isRecordingHotKeySupported()){i._showHotKeyHint(t.currentTarget,"record",i.keyModifier+" + R")}},onMouseOut:function e(){if(i.isRecordingHotKeySupported()){i._destroyHotKeyHint()}}})}else{this.buttons.record.setBlocked(this.isButtonBlocked("record"))}a.appendChild(this.buttons.record.render());break;case"document":if(!this.buttons.document){this.buttons.document=new y({class:"document",text:BX.message("IM_M_CALL_BTN_DOCUMENT"),blocked:this.isButtonBlocked("document"),onClick:this._onDocumentButtonClick.bind(this)})}else{this.buttons.document.setBlocked(this.isButtonBlocked("document"))}a.appendChild(this.buttons.document.render());break;case"returnToCall":this.buttons.returnToCall=new y({class:"returnToCall",text:BX.message("IM_M_CALL_BTN_RETURN_TO_CALL"),onClick:this._onBodyClick.bind(this)});r.appendChild(this.buttons.returnToCall.render());break;case"hangup":this.buttons.hangup=new y({class:"hangup",backgroundClass:"bx-messenger-videocall-panel-icon-background-hangup",text:Object.keys(this.users).length>1?BX.message("IM_M_CALL_BTN_DISCONNECT"):BX.message("IM_M_CALL_BTN_HANGUP"),onClick:this._onHangupButtonClick.bind(this)});r.appendChild(this.buttons.hangup.render());break;case"close":this.buttons.close=new y({class:"close",backgroundClass:"bx-messenger-videocall-panel-icon-background-hangup",text:BX.message("IM_M_CALL_BTN_CLOSE"),onClick:this._onCloseButtonClick.bind(this)});r.appendChild(this.buttons.close.render());break;case"speaker":break;case"mobileMenu":if(!this.buttons.mobileMenu){this.buttons.mobileMenu=new y({class:"sandwich",text:BX.message("IM_M_CALL_BTN_MENU"),onClick:this._onMobileMenuButtonClick.bind(this)})}a.appendChild(this.buttons.mobileMenu.render());break;case"chat":if(!this.buttons.chat){this.buttons.chat=new y({class:"chat",text:BX.message("IM_M_CALL_BTN_CHAT"),blocked:this.isButtonBlocked("chat"),onClick:this._onChatButtonClick.bind(this),onMouseOver:function e(t){i._showHotKeyHint(t.currentTarget,"chat",i.keyModifier+" + C")},onMouseOut:function e(){i._destroyHotKeyHint()}})}else{this.buttons.chat.setBlocked(this.isButtonBlocked("chat"))}a.appendChild(this.buttons.chat.render());break;case"floorRequest":if(!this.buttons.floorRequest){this.buttons.floorRequest=new y({class:"floor-request",backgroundClass:"bx-messenger-videocall-panel-background-floor-request",text:BX.message("IM_M_CALL_BTN_WANT_TO_SAY"),blocked:this.isButtonBlocked("floorRequest"),onClick:this._onFloorRequestButtonClick.bind(this),onMouseOver:function e(t){i._showHotKeyHint(t.currentTarget,"floorRequest",i.keyModifier+" + H")},onMouseOut:function e(){return i._destroyHotKeyHint()}})}else{this.buttons.floorRequest.setBlocked(this.isButtonBlocked("floorRequest"))}a.appendChild(this.buttons.floorRequest.render());break;case"more":if(!this.buttons.more){this.buttons.more=new y({class:"more",onClick:this._onMoreButtonClick.bind(this)})}a.appendChild(this.buttons.more.render());break;case"spacer":n.appendChild(l.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-spacer"}}));break}}return n}},{key:"renderTopButtons",value:function e(t){var i=this;var n=BX.createFragment();for(var s=0;s<t.length;s++){switch(t[s]){case"watermark":this.buttons.waterMark=new w({language:this.language});n.appendChild(this.buttons.waterMark.render());break;case"hd":this.buttons.hd=new M({iconClass:"hd"});n.appendChild(this.buttons.hd.render());break;case"protected":this.buttons["protected"]=new M({iconClass:"protected",textClass:"protected",text:BX.message("IM_M_CALL_PROTECTED"),onMouseOver:function e(t){i.hintManager.show(t.currentTarget,BX.message("IM_M_CALL_PROTECTED_HINT"))},onMouseOut:function e(){i.hintManager.hide()}});n.appendChild(this.buttons["protected"].render());break;case"recordStatus":if(this.buttons.recordStatus){this.buttons.recordStatus.updateView()}else{this.buttons.recordStatus=new E({userId:this.userId,recordState:this.recordState,onPauseClick:this._onRecordPauseClick.bind(this),onStopClick:this._onRecordStopClick.bind(this),onMouseOver:this._onRecordMouseOver.bind(this),onMouseOut:this._onRecordMouseOut.bind(this)})}n.appendChild(this.buttons.recordStatus.render());break;case"grid":this.buttons.grid=new I({iconClass:this.layout==pt.Grid?"speaker":"grid",text:this.layout==pt.Grid?BX.message("IM_M_CALL_SPEAKER_MODE"):BX.message("IM_M_CALL_GRID_MODE"),onClick:this._onGridButtonClick.bind(this),onMouseOver:function e(t){i._showHotKeyHint(t.currentTarget,"grid",i.keyModifier+" + W",{position:"bottom"})},onMouseOut:function e(){i._destroyHotKeyHint()}});n.appendChild(this.buttons.grid.render());break;case"fullscreen":this.buttons.fullscreen=new I({iconClass:this.isFullScreen?"fullscreen-leave":"fullscreen-enter",text:this.isFullScreen?BX.message("IM_M_CALL_WINDOW_MODE"):BX.message("IM_M_CALL_FULLSCREEN_MODE"),onClick:this._onFullScreenButtonClick.bind(this)});n.appendChild(this.buttons.fullscreen.render());break;case"participants":var a=void 0;if(this.isFullScreen&&this.layout==pt.Centered){a=this.isUserBlockFolded?_.FoldButtonState.Unfold:_.FoldButtonState.Fold}else if(this.showUsersButton){a=_.FoldButtonState.Active}else{a=_.FoldButtonState.Hidden}if(this.buttons.participants){this.buttons.participants.update({foldButtonState:a,allowAdding:!this.isButtonBlocked("add"),count:this.getConnectedUserCount(true)})}else{this.buttons.participants=new _({foldButtonState:a,allowAdding:!this.isButtonBlocked("add"),count:this.getConnectedUserCount(true),onListClick:this._onParticipantsButtonListClick.bind(this),onAddClick:this._onAddButtonClick.bind(this)})}n.appendChild(this.buttons.participants.render());break;case"participantsMobile":this.buttons.participantsMobile=new T({count:this.getConnectedUserCount(true),onClick:this._onParticipantsButtonMobileListClick.bind(this)});n.appendChild(this.buttons.participantsMobile.render());break;case"separator":n.appendChild(l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-separator"}}));break;case"spacer":n.appendChild(l.Dom.create("div",{props:{className:"bx-messenger-videocall-top-panel-spacer"}}));break}}return n}},{key:"calculateUnusedPanelSpace",value:function e(t){if(!t){t=this.getButtonList()}var i=0;for(var n=0;n<t.length;n++){var s=this.buttons[t[n]];if(!s){continue}var a=s.elements.root?s.elements.root.getBoundingClientRect().width:0;i+=a}return this.elements.panel.scrollWidth-i-32}},{key:"setButtonActive",value:function e(t,i){if(!this.buttons[t]){return}this.buttons[t].setActive(i)}},{key:"getButtonActive",value:function e(t){if(!this.buttons[t]){return false}return this.buttons[t].isActive}},{key:"setButtonCounter",value:function e(t,i){if(!this.buttons[t]){return}this.buttons[t].setCounter(i)}},{key:"updateUserList",value:function e(){if(this.layout==pt.Mobile){if(this.localUser!=this.centralUser){if(this.localUser.hasVideo()){this.localUser.mount(this.elements.localUserMobile);this.localUser.visible=true}else{this.localUser.dismount()}this.centralUser.mount(this.elements.center);this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id});this.centralUser.visible=true}return}if(this.layout==pt.Grid&&this.size==mt.Full){this.recalculatePages()}this.renderUserList();if(this.layout==pt.Centered){if(!this.elements.userList.container.parentElement){this.elements.userBlock.appendChild(this.elements.userList.container)}}else if(this.layout==pt.Grid){if(!this.elements.userList.container.parentElement){this.elements.container.appendChild(this.elements.userList.container)}}this.toggleEars()}},{key:"showOverflownButtonsPopup",value:function e(){var t=this;if(this.overflownButtonsPopup){this.overflownButtonsPopup.show();return}var i=this.buttons.more&&this.buttons.more.elements.root?this.buttons.more.elements.root:this.elements.panel;this.overflownButtonsPopup=new o.Popup({id:"bx-call-buttons-popup",bindElement:i,targetContainer:this.container,content:this.renderButtons(Object.keys(this.overflownButtons)),cacheable:false,closeIcon:false,autoHide:true,overlay:{backgroundColor:"white",opacity:0},bindOptions:{position:"top"},angle:{position:"bottom",offset:49},className:"bx-call-buttons-popup",contentBackground:"unset",events:{onPopupDestroy:function e(){t.overflownButtonsPopup=null;t.buttons.more.setActive(false)}}});this.overflownButtonsPopup.show()}},{key:"resumeVideo",value:function e(){for(var t in this.users){var i=this.users[t];i.playVideo();var n=this.screenUsers[t];n.playVideo()}this.localUser.playVideo()}},{key:"updateUserButtons",value:function e(){for(var t in this.users){if(this.users.hasOwnProperty(t)){this.users[t].allowPinButton=this.getConnectedUserCount()>1}}}},{key:"updateButtons",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];if(!this.elements.panel){return}if(!t.includes("panel")){l.Dom.clean(this.elements.panel);this.elements.panel.appendChild(this.renderButtons(this.getButtonList()))}l.Dom.clean(this.elements.topPanel);if(this.elements.topPanel){this.elements.topPanel.appendChild(this.renderTopButtons(this.getTopButtonList()))}if(this.buttons.participantsMobile){this.buttons.participantsMobile.setCount(this.getConnectedUserCount(true))}}},{key:"updateUserData",value:function e(t){for(var i in t){if(!this.userData[i]){this.userData[i]={name:"",avatar_hr:"",gender:"M"}}if(t[i].name){this.userData[i].name=t[i].name}if(t[i].avatar_hr){this.userData[i].avatar_hr=Do.isAvatarBlank(t[i].avatar_hr)?"":t[i].avatar_hr}else if(t[i].avatar){this.userData[i].avatar_hr=Do.isAvatarBlank(t[i].avatar)?"":t[i].avatar}if(t[i].gender){this.userData[i].gender=t[i].gender==="F"?"F":"M"}var n=this.userRegistry.get(i);if(n){n.name=this.userData[i].name;n.avatar=this.userData[i].avatar_hr}}}},{key:"isScreenSharingSupported",value:function e(){return navigator.mediaDevices&&typeof navigator.mediaDevices.getDisplayMedia==="function"||typeof BXDesktopSystem!=="undefined"}},{key:"isRecordingHotKeySupported",value:function e(){return typeof BXDesktopSystem!=="undefined"&&BXDesktopSystem.ApiVersion()>=60}},{key:"isFullScreenSupported",value:function e(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){return document.webkitFullscreenEnabled===true}else if(BX.browser.IsFirefox()){return document.fullscreenEnabled===true}else{return false}}},{key:"toggleEars",value:function e(){this.toggleTopEar();this.toggleBottomEar();if(this.layout==pt.Grid&&this.pagesCount>1&&this.currentPage>1){this.elements.pageNavigatorLeft.classList.add("active")}else{this.elements.pageNavigatorLeft.classList.remove("active")}if(this.layout==pt.Grid&&this.pagesCount>1&&this.currentPage<this.pagesCount){this.elements.pageNavigatorRight.classList.add("active")}else{this.elements.pageNavigatorRight.classList.remove("active")}}},{key:"toggleTopEar",value:function e(){if(this.layout!==pt.Grid&&this.elements.userList.container.scrollHeight>this.elements.userList.container.offsetHeight&&this.elements.userList.container.scrollTop>0){this.elements.ear.top.classList.add("active")}else{this.elements.ear.top.classList.remove("active")}}},{key:"toggleBottomEar",value:function e(){if(this.layout!==pt.Grid&&this.elements.userList.container.offsetHeight+this.elements.userList.container.scrollTop<this.elements.userList.container.scrollHeight){this.elements.ear.bottom.classList.add("active")}else{this.elements.ear.bottom.classList.remove("active")}}},{key:"scrollUserListUp",value:function e(){var t=this;this.stopScroll();this.scrollInterval=setInterval((function(){return t.elements.userList.container.scrollTop-=10}),20)}},{key:"scrollUserListDown",value:function e(){var t=this;this.stopScroll();this.scrollInterval=setInterval((function(){return t.elements.userList.container.scrollTop+=10}),20)}},{key:"stopScroll",value:function e(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=0}}},{key:"toggleRenameSliderInputLoader",value:function e(){this.elements.renameSlider.button.classList.add("ui-btn-wait")}},{key:"setHotKeyTemporaryBlock",value:function e(t,i){if(!!t){this.hotKeyTemporaryBlock++}else{this.hotKeyTemporaryBlock--;if(this.hotKeyTemporaryBlock<0||i){this.hotKeyTemporaryBlock=0}}}},{key:"setHotKeyActive",value:function e(t,i){if(typeof this.hotKey[t]==="undefined"){return}this.hotKey[t]=!!i}},{key:"isHotKeyActive",value:function e(t){if(!this.hotKey["all"]){return false}if(this.hotKeyTemporaryBlock>0){return false}if(this.isButtonHidden(t)){return false}if(this.isButtonBlocked(t)){return false}return!!this.hotKey[t]}},{key:"_onBodyClick",value:function e(){this.eventEmitter.emit(Ct.onBodyClick)}},{key:"_onCenterTouchStart",value:function e(t){this.centerTouchX=t.pageX}},{key:"_onCenterTouchEnd",value:function e(t){var i=t.pageX-this.centerTouchX;if(i>100){this.pinUser(this.getRightUser(this.centralUser.id));t.preventDefault()}if(i<-100){this.pinUser(this.getLeftUser(this.centralUser.id));t.preventDefault()}}},{key:"_onFullScreenChange",value:function e(){if("webkitFullscreenElement"in document){this.isFullScreen=!!document.webkitFullscreenElement}else if("fullscreenElement"in document){this.isFullScreen=!!document.fullscreenElement}else{return}setTimeout(function(){if(!this.elements.root){return}if(this.isFullScreen){this.elements.root.classList.add("bx-messenger-videocall-fullscreen")}else{this.elements.root.classList.remove("bx-messenger-videocall-fullscreen")}this.updateUserList();this.updateButtons();this.setUserBlockFolded(this.isFullScreen)}.bind(this),0)}},{key:"_onIntersectionChange",value:function e(t){var i={};t.forEach((function(e){i[e.target.dataset.userId]=e.isIntersecting}));for(var n in i){if(this.users[n]){this.users[n].visible=i[n]}if(n==this.localUser.id){this.localUser.visible=i[n]}}}},{key:"_onResize",value:function e(){if(!this.elements.root){return}if(this.centralUser);if(BX.browser.IsMobile()){document.documentElement.style.setProperty("--view-height",window.innerHeight+"px")}if(this.layout==pt.Grid){this.updateUserList()}else{this.updateCentralUserAvatarSize();this.toggleEars()}var t=this.elements.root.getBoundingClientRect();this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-450",t.width<450);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-550",t.width<550);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-650",t.width<650);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-700",t.width<700);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-850",t.width<850);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-900",t.width<900);if(this.checkPanelOverflow()){this.updateButtons();if(this.overflownButtonsPopup&&!Object.keys(this.overflownButtons).length){this.overflownButtonsPopup.close()}}}},{key:"_onOrientationChange",value:function e(){if(!this.elements.root){return}if(window.innerHeight>window.innerWidth){this.elements.root.classList.remove("orientation-landscape")}else{this.elements.root.classList.add("orientation-landscape")}}},{key:"_showHotKeyHint",value:function e(t,i,n,s){var a=BX.PopupWindowManager.getPopupById("ui-hint-popup");if(a){a.destroy()}if(!this.isHotKeyActive(i)){return}s=s||{};this.hintManager.popupParameters.events={onShow:function e(i){var n=i.getTarget();n.getPopupContainer().style.display="block";if(s.position==="bottom"){n.setOffset({offsetTop:10,offsetLeft:t.offsetWidth/2-n.getPopupContainer().offsetWidth/2})}else{n.setOffset({offsetLeft:t.offsetWidth/2-n.getPopupContainer().offsetWidth/2})}}};this.hintManager.show(t,n)}},{key:"_destroyHotKeyHint",value:function e(){if(!Do.isDesktop()){return}if(!this.hintManager.popup){return}this.hintManager.popup.destroy();this.hintManager.popup=null}},{key:"_showMicrophoneHint",value:function e(t){this.hintManager.hide();if(!this.isHotKeyActive("microphone")){return}var i="";if(this.isMuted&&this.isHotKeyActive("microphoneSpace")){i=BX.message("IM_SPACE_HOTKEY")+"<br>"}i+=this.keyModifier+" + A";this._showHotKeyHint(t.currentTarget.firstChild,"microphone",i)}},{key:"_onKeyDown",value:function t(i){if(!Do.isDesktop()){return}if(!(i.shiftKey&&(i.ctrlKey||i.metaKey))&&!(i.code==="Space")){return}if(event.repeat){return}var n=this.size===e.Size.Folded;if(i.code==="KeyA"&&this.isHotKeyActive("microphone")){i.preventDefault();if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(i)}else if(i.code==="Space"&&this.isMuted&&this.isHotKeyActive("microphoneSpace")){if(!n){i.preventDefault();this.pushToTalk=true;this.microphoneHotkeyTimerId=setTimeout(function(){if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(i)}.bind(this),100)}}else if(i.code==="KeyS"&&this.isHotKeyActive("screen")){i.preventDefault();this._onScreenButtonClick(i)}else if(i.code==="KeyV"&&this.isHotKeyActive("camera")){i.preventDefault();if(this.deviceSelector){this.deviceSelector.destroy()}this._onCameraButtonClick(i)}else if(i.code==="KeyU"&&this.isHotKeyActive("users")){i.preventDefault();this._onUsersButtonClick(i)}else if(i.code==="KeyR"&&this.isRecordingHotKeySupported()&&this.isHotKeyActive("record")){i.preventDefault();this._onForceRecordToggleClick(i)}else if(i.code==="KeyH"&&this.isHotKeyActive("floorRequest")){i.preventDefault();this._onFloorRequestButtonClick(i)}else if(i.code==="KeyC"&&this.isHotKeyActive("chat")){i.preventDefault();if(n){this._onBodyClick(i)}else{this._onChatButtonClick(i);this._destroyHotKeyHint()}}else if(i.code==="KeyM"&&this.isHotKeyActive("muteSpeaker")){i.preventDefault();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleSpeaker",speakerMuted:this.speakerMuted,fromHotKey:true})}else if(i.code==="KeyW"&&this.isHotKeyActive("grid")){i.preventDefault();this.setLayout(this.layout==pt.Centered?pt.Grid:pt.Centered)}}},{key:"_onKeyUp",value:function e(t){if(!Do.isDesktop()){return}clearTimeout(this.microphoneHotkeyTimerId);if(this.pushToTalk&&!this.isMuted&&t.code==="Space"){t.preventDefault();this.pushToTalk=false;if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(t)}}},{key:"_onUserClick",value:function e(t){var i=t.userId;if(i==this.centralUser.id&&this.layout!=pt.Grid){this.elements.root.classList.toggle("bx-messenger-videocall-hidden-panels")}if(this.layout==pt.Centered&&i!=this.centralUser.id){this.pinUser(i)}else{this.pinnedUser&&this.pinnedUser.id===i?this._onUserUnPin():this._onUserPin({userId:i})}this.eventEmitter.emit(Ct.onUserClick,{userId:i,stream:i==this.userId?this.localUser.stream:this.users[i].stream})}},{key:"_onUserRename",value:function e(t){this.eventEmitter.emit(Ct.onUserRename,{newName:t})}},{key:"_onUserRenameInputFocus",value:function e(){this.setHotKeyTemporaryBlock(true)}},{key:"_onUserRenameInputBlur",value:function e(){this.setHotKeyTemporaryBlock(false)}},{key:"_onUserPin",value:function e(t){if(this.layout==pt.Grid){this.setLayout(pt.Centered)}this.pinUser(t.userId)}},{key:"_onUserUnPin",value:function e(){if(this.layout==pt.Centered){this.setLayout(pt.Grid)}this.unpinUser()}},{key:"_onRecordToggleClick",value:function t(i){if(this.recordState.state===e.RecordState.Stopped){this._onRecordStartClick(i)}else{this._onRecordStopClick(i)}}},{key:"_onForceRecordToggleClick",value:function t(i){if(this.recordState.state===e.RecordState.Stopped){this._onForceRecordStartClick(e.RecordType.Video)}else{this._onRecordStopClick(i)}}},{key:"_onForceRecordStartClick",value:function t(i){if(typeof i==="undefined"){i=e.RecordType.None}this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"record",recordState:e.RecordState.Started,forceRecord:i,node:null})}},{key:"_onRecordStartClick",value:function t(i){this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"record",recordState:e.RecordState.Started,node:i.currentTarget})}},{key:"_onRecordPauseClick",value:function t(i){var n;if(this.recordState.state===e.RecordState.Paused){this.recordState.state=e.RecordState.Started;n=e.RecordState.Resumed}else{this.recordState.state=e.RecordState.Paused;n=this.recordState.state}this.buttons.recordStatus.update(this.recordState);this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"record",recordState:n,node:i.currentTarget})}},{key:"_onRecordStopClick",value:function t(i){this.recordState.state=e.RecordState.Stopped;this.buttons.recordStatus.update(this.recordState);this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"record",recordState:this.recordState.state,node:i.currentTarget})}},{key:"_onRecordMouseOver",value:function e(t){if(this.recordState.userId==this.userId||!this.userData[this.recordState.userId]){return}var i=l.Text.encode(this.userData[this.recordState.userId].name);this.hintManager.show(t.currentTarget,BX.message("IM_M_CALL_RECORD_HINT").replace("#USER_NAME#",i))}},{key:"_onRecordMouseOut",value:function e(){this.hintManager.hide()}},{key:"_onDocumentButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"document",node:t.target})}},{key:"_onGridButtonClick",value:function e(){this.setLayout(this.layout==pt.Centered?pt.Grid:pt.Centered);if(this.layout==pt.Centered&&this.localUser.id!==this.centralUser.id){this.eventEmitter.emit(Ct.onHasMainStream,{userId:this.centralUser.id})}}},{key:"_onAddButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"inviteUser",node:t.currentTarget})}},{key:"_onShareButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"share",node:t.currentTarget})}},{key:"_onMicrophoneButtonClick",value:function e(t){if("stopPropagation"in t){t.stopPropagation()}this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleMute",muted:!this.isMuted})}},{key:"_onMicrophoneArrowClick",value:function e(t){t.stopPropagation();this.showDeviceSelector(t.currentTarget)}},{key:"_onMicrophoneSideIconClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"microphoneSideIcon"})}},{key:"_onMicrophoneSelected",value:function e(t){this.eventEmitter.emit(Ct.onReplaceMicrophone,{deviceId:t.data.deviceId})}},{key:"_onCameraButtonClick",value:function e(t){if("stopPropagation"in t){t.stopPropagation()}this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleVideo",video:!this.isCameraOn})}},{key:"_onCameraArrowClick",value:function e(t){t.stopPropagation();this.showDeviceSelector(t.currentTarget)}},{key:"_onCameraSelected",value:function e(t){this.eventEmitter.emit(Ct.onReplaceCamera,{deviceId:t.data.deviceId})}},{key:"_onSpeakerButtonClick",value:function e(){this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleSpeaker",speakerMuted:this.speakerMuted})}},{key:"_onChangeHdVideo",value:function e(t){this.eventEmitter.emit(Ct.onChangeHdVideo,t.data)}},{key:"_onChangeMicAutoParams",value:function e(t){this.eventEmitter.emit(Ct.onChangeMicAutoParams,t.data)}},{key:"_onChangeFaceImprove",value:function e(t){this.eventEmitter.emit(Ct.onChangeFaceImprove,t.data)}},{key:"_onSpeakerSelected",value:function e(t){this.setSpeakerId(t.data.deviceId);this.eventEmitter.emit(Ct.onReplaceSpeaker,{deviceId:t.data.deviceId})}},{key:"_onScreenButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleScreenSharing",node:t.target})}},{key:"_onChatButtonClick",value:function e(t){this.hintManager.hide();t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"showChat",node:t.target})}},{key:"_onUsersButtonClick",value:function e(t){this.hintManager.hide();t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"toggleUsers",node:t.target})}},{key:"_onMobileMenuButtonClick",value:function e(t){t.stopPropagation();this.showCallMenu()}},{key:"_onFloorRequestButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"floorRequest",node:t.target})}},{key:"_onMoreButtonClick",value:function e(t){t.stopPropagation();if(this.overflownButtonsPopup){this.overflownButtonsPopup.close();this.buttons.more.setActive(false)}else{this.showOverflownButtonsPopup();this.buttons.more.setActive(true)}}},{key:"_onHistoryButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"showHistory",node:t.target})}},{key:"_onHangupButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"hangup",node:t.target})}},{key:"_onCloseButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"close",node:t.target})}},{key:"_onFullScreenButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"fullscreen",node:t.target})}},{key:"_onParticipantsButtonListClick",value:function e(t){if(!this.isButtonBlocked("users")){this._onUsersButtonClick(t);return}if(!this.isFullScreen){return}this.setUserBlockFolded(!this.isUserBlockFolded)}},{key:"_onParticipantsListButtonClick",value:function e(t){var i=this;t.stopPropagation();var n=new r.BaseEvent({data:{buttonName:"participantsList",node:t.target},compatData:["participantsList",t.target]});this.eventEmitter.emit(Ct.onButtonClick,n);if(n.isDefaultPrevented()){return}ht.create({parentElement:t.currentTarget,zIndex:this.baseZIndex+500,userList:Object.values(this.users),current:this.centralUser.id,onSelect:function e(t){return i.setCentralUser(t)}}).show()}},{key:"_onParticipantsButtonMobileListClick",value:function e(){this.showParticipantsMenu()}},{key:"_onMobileCallMenuFloorRequestClick",value:function e(){this.callMenu.close();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"floorRequest"})}},{key:"_onMobileCallMenShowParticipantsClick",value:function e(){this.callMenu.close();this.showParticipantsMenu()}},{key:"_onMobileCallMenuCopyInviteClick",value:function e(){this.callMenu.close();this.eventEmitter.emit(Ct.onButtonClick,{buttonName:"share",node:null})}},{key:"showRenameSlider",value:function e(){var t=this;if(!this.renameSlider){this.renameSlider=new B({parent:this.elements.root,content:this.renderRenameSlider(),onClose:function e(){return t.renameSlider.destroy()},onDestroy:function e(){return t.renameSlider=null}})}this.renameSlider.show();setTimeout((function(){t.elements.renameSlider.input.focus();t.elements.renameSlider.input.select()}),400)}},{key:"renderRenameSlider",value:function e(){return l.Dom.create("div",{props:{className:"bx-videocall-mobile-rename-slider-wrap"},children:[l.Dom.create("div",{props:{className:"bx-videocall-mobile-rename-slider-title"},text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME")}),this.elements.renameSlider.input=l.Dom.create("input",{props:{className:"bx-videocall-mobile-rename-slider-input"},attrs:{type:"text",value:this.localUser.userModel.name}}),this.elements.renameSlider.button=l.Dom.create("button",{props:{className:"bx-videocall-mobile-rename-slider-button ui-btn ui-btn-md ui-btn-primary"},text:BX.message("IM_M_CALL_MOBILE_RENAME_CONFIRM"),events:{click:this._onMobileUserRename.bind(this)}})]})}},{key:"_onMobileUserRename",value:function e(t){t.stopPropagation();var i=this.elements.renameSlider.input.value;var n=i.trim();var s=true;if(n===this.localUser.userModel.name||n===""){s=false}if(s){this.toggleRenameSliderInputLoader();this._onUserRename(n)}else{this.renameSlider.close()}}},{key:"_onMobileCallMenuCancelClick",value:function e(){this.callMenu.close()}},{key:"_onLeftEarClick",value:function e(){this.pinUser(this.getLeftUser(this.centralUser.id))}},{key:"_onRightEarClick",value:function e(){this.pinUser(this.getRightUser(this.centralUser.id))}},{key:"_onLeftPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage-1)}},{key:"_onRightPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage+1)}},{key:"setMaxWidth",value:function t(i){if(this.maxWidth!==i){var n=650;if(i<n&&(!this.maxWidth||this.maxWidth>n)&&this.layout===pt.Centered){this.setLayout(pt.Grid)}var s=this.maxWidth===null;this.maxWidth=i;if(this.size!==e.Size.Folded){this._applyMaxWidth(s)}}}},{key:"removeMaxWidth",value:function e(){this.setMaxWidth(null)}},{key:"_applyMaxWidth",value:function e(t){var i=this;var n=this.container.getBoundingClientRect();if(this.maxWidth!==null){if(!this.elements.root.style.maxWidth&&t){this.elements.root.style.maxWidth=n.width+"px"}setTimeout((function(){return i.elements.root.style.maxWidth=Math.max(i.maxWidth,wt)+"px"}),0)}else{this.elements.root.style.maxWidth=n.width+"px";this.elements.root.addEventListener("transitionend",(function(){return i.elements.root.style.removeProperty("max-width")}),{once:true})}}},{key:"releaseLocalMedia",value:function e(){this.localUser.releaseStream();if(this.centralUser.id==this.userId){this.centralUser.releaseStream()}}},{key:"destroy",value:function e(){if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}if(this.elements.root){l.Dom.remove(this.elements.root);this.elements.root=null}this.visible=false;window.removeEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("mozfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("orientationchange",this._onOrientationChangeHandler);window.removeEventListener("keydown",this._onKeyDownHandler);window.removeEventListener("keyup",this._onKeyUpHandler);this.resizeObserver.disconnect();this.resizeObserver=null;if(this.intersectionObserver){this.intersectionObserver.disconnect();this.intersectionObserver=null}for(var t in this.users){if(this.users.hasOwnProperty(t)){this.users[t].destroy()}}this.userData=null;this.centralUser.destroy();this.hintManager.hide();this.hintManager=null;clearTimeout(this.switchPresenterTimeout);if(this.buttons.recordStatus){this.buttons.recordStatus.stopViewUpdate()}this.recordState=this.getDefaultRecordState();this.buttons=null;this.eventEmitter.emit(Ct.onDestroy);this.eventEmitter.unsubscribeAll()}}]);return e}();babelHelpers.defineProperty(Rt,"Layout",pt);babelHelpers.defineProperty(Rt,"Size",mt);babelHelpers.defineProperty(Rt,"RecordState",ft);babelHelpers.defineProperty(Rt,"RecordType",gt);babelHelpers.defineProperty(Rt,"RecordSource",{Chat:"BXCLIENT_CHAT"});babelHelpers.defineProperty(Rt,"UiState",vt);babelHelpers.defineProperty(Rt,"Event",Ct);babelHelpers.defineProperty(Rt,"RoomState",bt);babelHelpers.defineProperty(Rt,"DeviceSelector",ct);babelHelpers.defineProperty(Rt,"NotificationManager",ot);babelHelpers.defineProperty(Rt,"MIN_WIDTH",wt);var Pt=.02;var Bt=2e3;var Ht=.6;var Dt=function(){function e(t){babelHelpers.classCallCheck(this,e);if(!(t.mediaStream instanceof MediaStream)){throw new Error("config.mediaStream should be instance of MediaStream")}if(t.mediaStream.getAudioTracks().length===0){throw new Error("config.mediaStream should contain audio track")}this.mediaStream=new MediaStream;this.mediaStream.addTrack(t.mediaStream.getAudioTracks()[0].clone());this.audioContext=null;this.mediaStreamNode=null;this.analyserNode=null;this.audioTimeDomainData=null;this.voiceState=false;this.measureInterval=0;this.inactivityTimeout=0;this.currentVolume=0;this.callbacks={voiceStarted:l.Type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,voiceStopped:l.Type.isFunction(t.onVoiceStopped)?t.onVoiceStopped:BX.DoNothing};if(e.isSupported()){this.init()}}babelHelpers.createClass(e,[{key:"init",value:function e(){this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.analyserNode=this.audioContext.createAnalyser();this.analyserNode.fftSize=128;this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.mediaStream);this.mediaStreamNode.connect(this.analyserNode);this.audioTimeDomainData=new Float32Array(this.analyserNode.fftSize);this.measureInterval=setInterval(this.analyzeAudioStream.bind(this),100)}},{key:"analyzeAudioStream",value:function e(){this.analyserNode.getFloatTimeDomainData(this.audioTimeDomainData);this.updateCurrentVolume(this.audioTimeDomainData);this.setVoiceState(this.currentVolume>=Pt)}},{key:"setVoiceState",value:function e(t){if(this.voiceState==t){return}if(t){this.callbacks.voiceStarted();clearTimeout(this.inactivityTimeout);this.inactivityTimeout=0;this.voiceState=true}else{if(!this.inactivityTimeout){this.inactivityTimeout=setTimeout(this.onInactivityTimeout.bind(this),Bt)}}}},{key:"onInactivityTimeout",value:function e(){this.inactivityTimeout=0;this.voiceState=false;this.callbacks.voiceStopped()}},{key:"updateCurrentVolume",value:function e(t){var i=0;for(var n=0;n<t.length;n++){i+=t[n]*t[n]}var s=Math.sqrt(i/t.length);this.currentVolume=Math.max(s,this.currentVolume*Ht)}},{key:"destroy",value:function e(){if(this.analyserNode){this.analyserNode.disconnect()}if(this.mediaStreamNode){this.mediaStreamNode.disconnect()}if(this.audioContext){this.audioContext.close()}if(this.mediaStream){this.mediaStream.getTracks().forEach((function(e){return e.stop()}));this.mediaStream=null}clearInterval(this.measureInterval);this.analyserNode=null;this.mediaStreamNode=null;this.audioContext=null;this.callbacks={voiceStarted:BX.DoNothing,voiceStopped:BX.DoNothing}}}],[{key:"isSupported",value:function e(){return(window.AudioContext||window.webkitAudioContext)&&window.AnalyserNode&&typeof window.AnalyserNode.prototype["getFloatTimeDomainData"]==="function"}}]);return e}();function Lt(e,t){xt(e,t);t.add(e)}function xt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function At(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Nt={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping",negotiationNeeded:"im.call.negotiationNeeded",connectionOffer:"im.call.connectionOffer",connectionAnswer:"im.call.connectionAnswer",iceCandidate:"im.call.iceCandidate"};var Ut={ping:"Call::ping",answer:"Call::answer",negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",recordState:"Call::recordState",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",customMessage:"Call::customMessage",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout"};var Vt={offerToReceiveVideo:true,offerToReceiveAudio:true};var Ft=3e4;var Ot=1e4;var Xt=5e3;var Wt=25e3;var Gt=5500;var zt=new WeakSet;var jt=new WeakSet;var qt=new WeakSet;var Kt=new WeakSet;var Jt=new WeakSet;var Yt=new WeakSet;var Qt=new WeakSet;var Zt=new WeakSet;var $t=new WeakSet;var ei=new WeakSet;var ti=new WeakSet;var ii=new WeakSet;var ni=new WeakSet;var si=new WeakSet;var ai=new WeakSet;var ri=new WeakSet;var oi=new WeakSet;var li=new WeakSet;var ci=new WeakSet;var di=new WeakSet;var ui=new WeakSet;var hi=new WeakSet;var pi=new WeakSet;var vi=new WeakSet;var mi=new WeakSet;var fi=new WeakSet;var gi=new WeakSet;var bi=new WeakSet;var Ci=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));Lt(babelHelpers.assertThisInitialized(i),bi);Lt(babelHelpers.assertThisInitialized(i),gi);Lt(babelHelpers.assertThisInitialized(i),fi);Lt(babelHelpers.assertThisInitialized(i),mi);Lt(babelHelpers.assertThisInitialized(i),vi);Lt(babelHelpers.assertThisInitialized(i),pi);Lt(babelHelpers.assertThisInitialized(i),hi);Lt(babelHelpers.assertThisInitialized(i),ui);Lt(babelHelpers.assertThisInitialized(i),di);Lt(babelHelpers.assertThisInitialized(i),ci);Lt(babelHelpers.assertThisInitialized(i),li);Lt(babelHelpers.assertThisInitialized(i),oi);Lt(babelHelpers.assertThisInitialized(i),ri);Lt(babelHelpers.assertThisInitialized(i),ai);Lt(babelHelpers.assertThisInitialized(i),si);Lt(babelHelpers.assertThisInitialized(i),ni);Lt(babelHelpers.assertThisInitialized(i),ii);Lt(babelHelpers.assertThisInitialized(i),ti);Lt(babelHelpers.assertThisInitialized(i),ei);Lt(babelHelpers.assertThisInitialized(i),$t);Lt(babelHelpers.assertThisInitialized(i),Zt);Lt(babelHelpers.assertThisInitialized(i),Qt);Lt(babelHelpers.assertThisInitialized(i),Yt);Lt(babelHelpers.assertThisInitialized(i),Jt);Lt(babelHelpers.assertThisInitialized(i),Kt);Lt(babelHelpers.assertThisInitialized(i),qt);Lt(babelHelpers.assertThisInitialized(i),jt);Lt(babelHelpers.assertThisInitialized(i),zt);i.callFromMobile=e.callFromMobile;i.state=e.state||"";i.peers=i.initPeers(i.users);i.signaling=new Yi({call:babelHelpers.assertThisInitialized(i)});i.recordState={state:"stopped",userId:0,date:{start:null,pause:[]}};i.deviceList=[];i.turnServer=(l.Browser.isFirefox()?BX.message("turn_server_firefox"):BX.message("turn_server"))||"turn.calls.bitrix24.com";i.turnServerLogin=BX.message("turn_server_login")||"bitrix";i.turnServerPassword=BX.message("turn_server_password")||"bitrix";i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),Xt);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),Wt);i.reinviteTimeout=null;i._onUnloadHandler=At(babelHelpers.assertThisInitialized(i),gi,ji).bind(babelHelpers.assertThisInitialized(i));i.enableMicAutoParameters=e.enableMicAutoParameters!==false;i.microphoneLevelInterval=null;window.addEventListener("unload",i._onUnloadHandler);return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(t){var i={};for(var n=0;n<t.length;n++){var s=Number(t[n]);if(s==this.userId){continue}i[s]=this.createPeer(s)}return i}},{key:"createPeer",value:function e(t){var i=this;return new hn({call:this,userId:t,ready:t==this.initiatorId,signalingConnected:t==this.initiatorId,isLegacyMobile:t==this.initiatorId&&this.callFromMobile,onMediaReceived:function e(t){console.log("onMediaReceived: ",t);i.runCallback(Sr.onRemoteMediaReceived,t)},onMediaStopped:function e(t){i.runCallback(Sr.onRemoteMediaStopped,t)},onStateChanged:At(this,pi,Xi).bind(this),onInviteTimeout:At(this,vi,Wi).bind(this),onRTCStatsReceived:At(this,mi,Gi).bind(this),onRTCQualityChanged:At(this,fi,zi).bind(this),onNetworkProblem:function e(t){i.runCallback(Sr.onNetworkProblem,t)},onReconnecting:function e(){i.runCallback(Sr.onReconnecting)},onReconnected:function e(){i.runCallback(Sr.onReconnected)}})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"isReady",value:function e(){return this.ready}},{key:"setVideoEnabled",value:function e(t){var i=this;t=t===true;if(this.videoEnabled==t){return}this.videoEnabled=t;var n=this.localStreams["main"]&&this.localStreams["main"].getVideoTracks().length>0;if(this.ready&&n!==this.videoEnabled){this.replaceLocalMediaStream().then((function(){var e=i.localStreams["main"]&&i.localStreams["main"].getVideoTracks().length>0;if(i.videoEnabled&&!e){i.videoEnabled=false}i.signaling.sendCameraState(i.users,i.videoEnabled)}))["catch"]((function(){}))}}},{key:"setMuted",value:function e(t){t=!!t;if(this.muted==t){return}this.muted=t;if(this.localStreams["main"]){var i=this.localStreams["main"].getAudioTracks();if(i[0]){i[0].enabled=!this.muted}}this.signaling.sendMicrophoneState(this.users,!this.muted);this.sendTalkingState()}},{key:"isMuted",value:function e(){return this.muted}},{key:"setCameraId",value:function e(t){if(this.cameraId==t){return}this.cameraId=t;if(this.ready&&this.videoEnabled){l.Runtime.debounce(this.replaceLocalMediaStream,100,this)()}}},{key:"setMicrophoneId",value:function e(t){if(this.microphoneId==t){return}this.microphoneId=t;if(this.ready){l.Runtime.debounce(this.replaceLocalMediaStream,100,this)()}}},{key:"getCurrentMicrophoneId",value:function e(){if(!this.localStreams["main"]){return this.microphoneId}var t=this.localStreams["main"].getAudioTracks();if(t.length>0){var i=t[0].getSettings();return i.deviceId}else{return this.microphoneId}}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"sendRecordState",value:function e(t){t.senderId=this.userId;if(!At(this,zt,ki).call(this,t)){return false}var i=[this.userId].concat(this.users);this.signaling.sendRecordState(i,this.recordState)}},{key:"stopSendingStream",value:function e(t){}},{key:"allowVideoFrom",value:function e(t){}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=l.Type.isArray(i.users)?i.users:Object.keys(this.peers);this.ready=true;if(i.localStream instanceof MediaStream&&!this.localStreams["main"]){this.localStreams["main"]=i.localStream}this.getLocalMediaStream("main",true).then((function(){return t.signaling.inviteUsers({userIds:n,video:t.videoEnabled?"Y":"N"})})).then((function(){t.state=vr.Connected;t.runCallback(Sr.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=Number(n[e]);if(!t.peers[i]){t.peers[i]=t.createPeer(i);t.runCallback(Sr.onUserInvited,{userId:i})}t.peers[i].onInvited();t.scheduleRepeatInvite()}}))["catch"]((function(e){console.error(e);t.runCallback(Sr.onCallFailure,e)}))}},{key:"scheduleRepeatInvite",value:function e(){clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout(this.repeatInviteUsers.bind(this),Gt)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===mr.Calling){i.push(n)}}if(i.length===0){return}this.signaling.inviteUsers({userIds:i,video:this.videoEnabled?"Y":"N",isRepeated:"Y"}).then((function(){return t.scheduleRepeatInvite()}))}},{key:"getMediaConstraints",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i={};var n=t.videoEnabled?{}:false;var s=!!t.hdVideo;var a=navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{};if(this.microphoneId){i.deviceId={ideal:this.microphoneId}}if(!this.enableMicAutoParameters){if(a.echoCancellation){i.echoCancellation=false}if(a.noiseSuppression){i.noiseSuppression=false}if(a.autoGainControl){i.autoGainControl=false}}if(n){if(this.cameraId){n.deviceId={exact:this.cameraId}}n.width={ideal:1280};n.height={ideal:720}}return{audio:i,video:n}}},{key:"getUserMedia",value:function e(t){return new Promise(function(e,i){var n=t[0];navigator.mediaDevices.getUserMedia(n).then((function(t){e(t)}),function(s){this.log("getUserMedia error: ",s);this.log("Current constraints",n);if(t.length>1){this.getUserMedia(t.slice(1)).then((function(t){e(t)}),(function(e){i(e)}))}else{this.log("Last fallback constraints used, failing");i(s)}}.bind(this))}.bind(this))}},{key:"getLocalMediaStream",value:function e(t,i){var n=this;if(!l.Type.isStringFilled(t)){t="main"}if(this.localStreams[t]){this.runCallback(Sr.onLocalMediaReceived,{tag:t,stream:this.localStreams[t]});return Promise.resolve(this.localStreams[t])}this.log("Requesting access to media devices");return new Promise((function(e,s){var a=[];if(n.videoEnabled){if(n.videoHd){a.push(n.getMediaConstraints({videoEnabled:true,hdVideo:true}))}a.push(n.getMediaConstraints({videoEnabled:true,hdVideo:false}));if(i){a.push(n.getMediaConstraints({videoEnabled:false}))}}else{a.push(n.getMediaConstraints({videoEnabled:false}))}n.getUserMedia(a).then((function(i){n.log("Local media stream received");n.localStreams[t]=i;n.runCallback(Sr.onLocalMediaReceived,{tag:t,stream:i});if(t==="main"){n.attachVoiceDetection();if(n.muted){var s=i.getAudioTracks();if(s[0]){s[0].enabled=false}}}if(n.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then((function(e){n.deviceList=e;n.runCallback(Sr.onDeviceListUpdated,{deviceList:n.deviceList})}))}e(n.localStreams[t])}))["catch"]((function(e){n.log("Could not get local media stream.",e);n.log("Request constraints: .",a);n.runCallback("onLocalMediaError",{tag:t,error:e});s(e)}))}))}},{key:"startMediaCapture",value:function e(){return this.getLocalMediaStream()}},{key:"attachVoiceDetection",value:function e(){if(this.voiceDetection){this.voiceDetection.destroy()}if(this.microphoneLevelInterval){clearInterval(this.microphoneLevelInterval)}try{this.voiceDetection=new Dt({mediaStream:this.localStreams["main"],onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)});this.microphoneLevelInterval=setInterval(function(){this.microphoneLevel=this.voiceDetection.currentVolume}.bind(this),200)}catch(e){this.log("Could not attach voice detection to media stream")}}},{key:"getDisplayMedia",value:function e(){return new Promise((function(e,t){if(window["BXDesktopSystem"]){navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"screen",maxWidth:1920,maxHeight:1080,maxFrameRate:5}}}).then((function(t){e(t)}),(function(e){t(e)}))}else if(navigator.mediaDevices.getDisplayMedia){navigator.mediaDevices.getDisplayMedia({video:{width:{max:1920},height:{max:1080},frameRate:{max:5}}}).then((function(t){e(t)}),(function(e){t(e)}))}else{console.error("Screen sharing is not supported");t("Screen sharing is not supported")}}))}},{key:"startScreenSharing",value:function e(t){var i=this;t=!!t;if(this.localStreams["screen"]&&!t){return}this.getDisplayMedia().then((function(e){i.localStreams["screen"]=e;e.getVideoTracks().forEach((function(e){e.addEventListener("ended",(function(){return i.stopScreenSharing()}))}));i.runCallback(Sr.onUserScreenState,{userId:i.userId,screenState:true});if(i.ready){for(var t in i.peers){if(i.peers[t].calculatedState===mr.Connected){i.peers[t].sendMedia()}}}}))["catch"]((function(e){i.log(e)}))}},{key:"stopScreenSharing",value:function e(){if(!this.localStreams["screen"]){return}Do.stopMediaStream(this.localStreams["screen"]);this.localStreams["screen"]=null;this.runCallback(Sr.onUserScreenState,{userId:this.userId,screenState:false});for(var t in this.peers){if(this.peers[t].calculatedState===mr.Connected){this.peers[t].sendMedia()}}}},{key:"isScreenSharingStarted",value:function e(){return this.localStreams["screen"]instanceof MediaStream}},{key:"onLocalVoiceStarted",value:function e(){this.talking=true;this.sendTalkingState()}},{key:"onLocalVoiceStopped",value:function e(){this.talking=false;this.sendTalkingState()}},{key:"sendTalkingState",value:function e(){if(this.talking&&!this.muted){this.runCallback(Sr.onUserVoiceStarted,{userId:this.userId,local:true});this.signaling.sendVoiceStarted({userId:this.users})}else{this.runCallback(Sr.onUserVoiceStopped,{userId:this.userId,local:true});this.signaling.sendVoiceStopped({userId:this.users})}}},{key:"sendCustomMessage",value:function e(t){this.signaling.sendCustomMessage({userId:this.users,message:t})}},{key:"answer",value:function e(t){var i=this;if(!l.Type.isPlainObject(t)){t={}}this.ready=true;this.videoEnabled=t.useVideo===true;this.enableMicAutoParameters=t.enableMicAutoParameters!==false;if(t.localStream instanceof MediaStream){this.localStreams["main"]=t.localStream}return new Promise((function(e,t){i.getLocalMediaStream("main",true).then((function(){i.state=vr.Connected;i.runCallback(Sr.onJoin,{local:true});return i.sendAnswer()})).then((function(){return e()}))["catch"]((function(e){i.runCallback(Sr.onCallFailure,e);t(e)}))}))}},{key:"sendAnswer",value:function e(){this.signaling.sendAnswer()}},{key:"decline",value:function e(t,i){var n=this;this.ready=false;var s={callId:this.id,callInstanceId:this.instanceId};if(typeof t!="undefined"){s.code=t}if(typeof i!="undefined"){s.reason=i}Gr.getRestClient().callMethod(Nt.decline,s).then((function(){n.destroy()}))}},{key:"hangup",value:function e(){var t=this;if(!this.ready){var i=new Error("Hangup in wrong state");this.log(i);return Promise.reject(i)}var n=new Error;n.name="Call stack:";this.log("Hangup received \n"+n.stack);this.ready=false;this.state=vr.Proceeding;return new Promise((function(e,i){for(var n in t.peers){t.peers[n].disconnect()}At(t,bi,qi).call(t);t.runCallback(Sr.onLeave,{local:true});t.signaling.sendHangup({userId:t.users}).then((function(){return e()}))["catch"]((function(e){return i(e)}))}))}},{key:"pingUsers",value:function e(){if(this.ready){this.signaling.sendPingToUsers({userId:this.users.concat(this.userId)})}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"getState",value:function e(){}},{key:"replaceLocalMediaStream",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"main";if(this.localStreams[i]){Do.stopMediaStream(this.localStreams[i]);this.localStreams[i]=null}return new Promise((function(e,n){t.getLocalMediaStream(i).then((function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(i)}}}e()}))["catch"]((function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e);n(e)}))}))}},{key:"sendAllStreams",value:function e(t){if(!this.peers[t]){return}if(!this.peers[t].isReady()){return}for(var i in this.localStreams){if(this.localStreams[i]){this.peers[t].sendMedia()}}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}}}},{key:"addInvitedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId){continue}if(!this.peers[n]){this.peers[n]=this.createPeer(n);this.runCallback(Sr.onUserInvited,{userId:n})}this.peers[n].onInvited();if(!this.users.includes(n)){this.users.push(n)}}}},{key:"__onPullEvent",value:function e(t,i,n){var s={"Call::answer":At(this,Jt,Ii).bind(this),"Call::hangup":At(this,Qt,_i).bind(this),"Call::ping":At(this,Zt,Ti).bind(this),"Call::negotiationNeeded":At(this,$t,Ei).bind(this),"Call::connectionOffer":At(this,ei,Ri).bind(this),"Call::connectionAnswer":At(this,ti,Pi).bind(this),"Call::iceCandidate":At(this,ii,Bi).bind(this),"Call::voiceStarted":At(this,ni,Hi).bind(this),"Call::voiceStopped":At(this,si,Di).bind(this),"Call::microphoneState":At(this,ai,Li).bind(this),"Call::cameraState":At(this,ri,xi).bind(this),"Call::videoPaused":At(this,oi,Ai).bind(this),"Call::recordState":At(this,li,Ni).bind(this),"Call::usersJoined":At(this,jt,yi).bind(this),"Call::usersInvited":At(this,qt,Si).bind(this),"Call::userInviteTimeout":At(this,Kt,wi).bind(this),"Call::associatedEntityReplaced":At(this,ci,Ui).bind(this),"Call::finish":At(this,di,Vi).bind(this),"Call::repeatAnswer":At(this,ui,Fi).bind(this),"Call::customMessage":At(this,hi,Oi).bind(this)};if(s[t]){if(t==="Call::ping"){if(i.senderId!=this.userId||i.instanceId!=this.instanceId){this.log("Signaling: ping from user "+i.senderId)}}else{this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}s[t].call(this,i)}}},{key:"destroy",value:function e(){var i=new Error;i.name="Call stack:";this.log("Call destroy \n"+i.stack);for(var n in this.peers){if(this.peers[n]){this.peers[n].destroy()}}At(this,bi,qi).call(this);return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return br.Plain}}]);return t}(f);function ki(e){if(e.action!==Rt.RecordState.Started&&this.recordState.userId!=e.senderId){return false}if(e.action===Rt.RecordState.Started){if(this.recordState.state!==Rt.RecordState.Stopped){return false}this.recordState.state=Rt.RecordState.Started;this.recordState.userId=e.senderId;this.recordState.date.start=e.date;this.recordState.date.pause=[]}else if(e.action===Rt.RecordState.Paused){if(this.recordState.state!==Rt.RecordState.Started){return false}this.recordState.state=Rt.RecordState.Paused;this.recordState.date.pause.push({start:e.date,finish:null})}else if(e.action===Rt.RecordState.Resumed){if(this.recordState.state!==Rt.RecordState.Paused){return false}this.recordState.state=Rt.RecordState.Started;var t=this.recordState.date.pause.find((function(e){return e.finish===null}));if(t){t.finish=e.date}}else if(e.action===Rt.RecordState.Stopped){this.recordState.state=Rt.RecordState.Stopped;this.recordState.userId=0;this.recordState.date.start=null;this.recordState.date.pause=[]}return true}function yi(e){if(!this.ready){return}var t=e.users;this.addJoinedUsers(t)}function Si(e){if(!this.ready){return}var t=e.users;this.addInvitedUsers(t)}function wi(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}}function Ii(e){var t=Number(e.senderId);if(t==this.userId){return At(this,Yt,Mi).call(this,e)}if(!this.ready){return}if(!this.peers[t]){return}if(this.peers[t].isReady()){this.log("Received answer for user "+t+" in ready state, ignoring");return}this.peers[t].setSignalingConnected(true);this.peers[t].setReady(true);this.peers[t].isLegacyMobile=e.isLegacyMobile===true;if(this.ready){this.sendAllStreams(t)}}function Mi(e){this.runCallback("onGetUserMediaEnded",{});if(e.callInstanceId===this.instanceId){return}if(this.ready){this.log("Received remote self-answer in ready state, ignoring");return}this.log("Call was answered elsewhere");this.runCallback(Sr.onJoin,{local:false})}function _i(e){var t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.runCallback(Sr.onLeave,{local:false})}return}if(!this.peers[t]){return}this.peers[t].disconnect(e.code);this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()){this.hangup()}}function Ti(e){if(e.callInstanceId==this.instanceId){return}var t=this.peers[e.senderId];if(!t){return}t.setSignalingConnected(true)}function Ei(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);if(e.restart){t.reconnect()}else{t.onNegotiationNeeded()}}function Ri(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp,e.tracks)}function Pi(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}var i=e.connectionId;t.setUserAgent(e.userAgent);t.setConnectionAnswer(i,e.sdp,e.tracks)}function Bi(e){if(!this.ready){return}var t=this.peers[e.senderId];var i;if(!t){return}try{i=e.candidates;for(var n=0;n<i.length;n++){t.addIceCandidate(e.connectionId,i[n])}}catch(e){this.log("Error parsing serialized candidate: ",e)}}function Hi(e){this.runCallback(Sr.onUserVoiceStarted,{userId:e.senderId})}function Di(e){this.runCallback(Sr.onUserVoiceStopped,{userId:e.senderId})}function Li(e){this.runCallback(Sr.onUserMicrophoneState,{userId:e.senderId,microphoneState:e.microphoneState})}function xi(e){this.runCallback(Sr.onUserCameraState,{userId:e.senderId,cameraState:e.cameraState})}function Ai(e){var t=this.peers[e.senderId];if(!t){return}this.runCallback(Sr.onUserVideoPaused,{userId:e.senderId,videoPaused:e.videoPaused});t.holdOutgoingVideo(!!e.videoPaused)}function Ni(e){this.runCallback(Sr.onUserRecordState,{userId:e.senderId,recordState:e.recordState})}function Ui(e){if(e.call&&e.call.ASSOCIATED_ENTITY){this.associatedEntity=e.call.ASSOCIATED_ENTITY}}function Vi(){this.destroy()}function Fi(){if(this.ready){this.signaling.sendAnswer({userId:this.userId},true)}}function Oi(e){this.runCallback(Sr.onCustomMessage,{message:e.message})}function Xi(e){var t=this;this.runCallback(Sr.onUserStateChanged,e);if(e.state==mr.Failed||e.state==mr.Unavailable){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this))["catch"]((function(){t.destroy()}))}}else if(e.state==mr.Connected){this.signaling.sendMicrophoneState(e.userId,!this.muted);this.signaling.sendCameraState(e.userId,this.videoEnabled);this.wasConnected=true}}function Wi(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})}function Gi(e){var t={};e.stats.forEach((function(e){if(e.type==="inbound-rtp"&&e.kind==="video"&&e.source){t[e.source]=e}}));this.runCallback(Sr.onUserStatsReceived,{userId:e.userId,report:t});this.runCallback(Sr.onRTCStatsReceived,e)}function zi(e){this.runCallback(Sr.onConnectionQualityChanged,{userId:e.userId,hasConnectionProblem:e.hasConnectionProblem})}function ji(){if(!this.ready){return}Gr.getRestClient().callMethod(Nt.hangup,{callId:this.id,callInstanceId:this.instanceId});for(var e in this.peers){this.peers[e].disconnect()}}function qi(){for(var e in this.localStreams){if(this.localStreams[e]){Do.stopMediaStream(this.localStreams[e]);this.localStreams[e]=null}}if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}window.removeEventListener("unload",this._onUnloadHandler);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);clearInterval(this.microphoneLevelInterval);clearTimeout(this.reinviteTimeout)}var Ki=new WeakSet;var Ji=new WeakSet;var Yi=function(){function e(t){babelHelpers.classCallCheck(this,e);Lt(this,Ji);Lt(this,Ki);this.call=t.call}babelHelpers.createClass(e,[{key:"isIceTricklingAllowed",value:function e(){return Gr.getPullClient().isPublishingSupported()}},{key:"inviteUsers",value:function e(t){return At(this,Ji,Zi).call(this,Nt.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.answer,t)}else{return At(this,Ji,Zi).call(this,Nt.answer,t)}}},{key:"sendConnectionOffer",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.connectionOffer,t)}else{return At(this,Ji,Zi).call(this,Nt.connectionOffer,t)}}},{key:"sendConnectionAnswer",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.connectionAnswer,t)}else{return At(this,Ji,Zi).call(this,Nt.connectionAnswer,t)}}},{key:"sendIceCandidate",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.iceCandidate,t)}else{return At(this,Ji,Zi).call(this,Nt.iceCandidate,t)}}},{key:"sendNegotiationNeeded",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.negotiationNeeded,t)}else{return At(this,Ji,Zi).call(this,Nt.negotiationNeeded,t)}}},{key:"sendVoiceStarted",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.voiceStarted,t)}}},{key:"sendVoiceStopped",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.voiceStopped,t)}}},{key:"sendMicrophoneState",value:function e(t,i){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.microphoneState,{userId:t,microphoneState:i},0)}}},{key:"sendCameraState",value:function e(t,i){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.cameraState,{userId:t,cameraState:i},0)}}},{key:"sendRecordState",value:function e(t,i){if(Gr.getPullClient().isPublishingSupported()){return At(this,Ki,Qi).call(this,Ut.recordState,{userId:t,recordState:i},0)}}},{key:"sendPingToUsers",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){At(this,Ki,Qi).call(this,Ut.ping,t,5)}}},{key:"sendCustomMessage",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){At(this,Ki,Qi).call(this,Ut.customMessage,t,5)}}},{key:"sendPingToBackend",value:function e(){var t=!Gr.getPullClient().isPublishingEnabled();At(this,Ji,Zi).call(this,Nt.ping,{retransmit:t})}},{key:"sendUserInviteTimeout",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){At(this,Ki,Qi).call(this,Ut.userInviteTimeout,t,0)}}},{key:"sendHangup",value:function e(t){if(Gr.getPullClient().isPublishingSupported()){At(this,Ki,Qi).call(this,Ut.hangup,t,3600);t.retransmit=false;return At(this,Ji,Zi).call(this,Nt.hangup,t)}else{t.retransmit=true;return At(this,Ji,Zi).call(this,Nt.hangup,t)}}}]);return e}();function Qi(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!l.Type.isArray(t.userId)){t.userId=[t.userId]}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Do.getUuidv4();if(e=="Call::ping"){this.call.log("Sending p2p signaling event "+e)}else{this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t))}Gr.getPullClient().sendMessage(t.userId,"im",e,t,i)}function Zi(e,t){if(!l.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Do.getUuidv4();if(e=="Call::ping"){this.call.log("Sending ajax-based signaling event "+e)}else{this.call.log("Sending ajax-based signaling event "+e+"; "+JSON.stringify(t))}return Gr.getRestClient().callMethod(e,t)["catch"]((function(e){console.error(e)}))}var $i=new WeakSet;var en=new WeakSet;var tn=new WeakSet;var nn=new WeakSet;var sn=new WeakSet;var an=new WeakSet;var rn=new WeakSet;var on=new WeakSet;var ln=new WeakSet;var cn=new WeakSet;var dn=new WeakSet;var un=new WeakSet;var hn=function(){function e(t){babelHelpers.classCallCheck(this,e);Lt(this,un);Lt(this,dn);Lt(this,cn);Lt(this,ln);Lt(this,on);Lt(this,rn);Lt(this,an);Lt(this,sn);Lt(this,nn);Lt(this,tn);Lt(this,en);Lt(this,$i);this.call=t.call;this.userId=t.userId;this.ready=t.ready===true;this.calling=false;this.inviteTimeout=false;this.declined=false;this.busy=false;this.signalingConnected=t.signalingConnected===true;this.failureReason="";this.userAgent="";this.isFirefox=false;this.isChrome=false;this.isLegacyMobile=t.isLegacyMobile===true;this.calculatedState=this.calculateState();this.localStreams={main:null,screen:null};this.pendingIceCandidates={};this.localIceCandidates=[];this.trackList={};this.callbacks={onStateChanged:l.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:l.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:l.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaStopped:l.Type.isFunction(t.onMediaStopped)?t.onMediaStopped:BX.DoNothing,onRTCStatsReceived:l.Type.isFunction(t.onRTCStatsReceived)?t.onRTCStatsReceived:BX.DoNothing,onRTCQualityChanged:l.Type.isFunction(t.onRTCQualityChanged)?t.onRTCQualityChanged:BX.DoNothing,onNetworkProblem:l.Type.isFunction(t.onNetworkProblem)?t.onNetworkProblem:BX.DoNothing,onReconnecting:l.Type.isFunction(t.onReconnecting)?t.onReconnecting:BX.DoNothing,onReconnected:l.Type.isFunction(t.onReconnected)?t.onReconnected:BX.DoNothing};this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.statsInterval=null;this.connectionOfferReplyTimeout=null;this.negotiationNeededReplyTimeout=null;this.reconnectAfterDisconnectTimeout=null;this.connectionAttempt=0;this.hasStun=false;this.hasTurn=false;this._outgoingVideoTrack=null;Object.defineProperty(this,"outgoingVideoTrack",{get:function e(){return this._outgoingVideoTrack},set:function e(t){if(this._outgoingVideoTrack){this._outgoingVideoTrack.stop()}this._outgoingVideoTrack=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}});this._outgoingScreenTrack=null;Object.defineProperty(this,"outgoingScreenTrack",{get:function e(){return this._outgoingScreenTrack},set:function e(t){if(this._outgoingScreenTrack){this._outgoingScreenTrack.stop()}this._outgoingScreenTrack=t;if(this._outgoingScreenTrack){this._outgoingScreenTrack.enabled=!this.outgoingVideoHoldState}}});this._incomingAudioTrack=null;this._incomingVideoTrack=null;this._incomingScreenTrack=null;Object.defineProperty(this,"incomingAudioTrack",{get:this._mediaGetter("_incomingAudioTrack"),set:this._mediaSetter("_incomingAudioTrack","audio")});Object.defineProperty(this,"incomingVideoTrack",{get:this._mediaGetter("_incomingVideoTrack"),set:this._mediaSetter("_incomingVideoTrack","video")});Object.defineProperty(this,"incomingScreenTrack",{get:this._mediaGetter("_incomingScreenTrack"),set:this._mediaSetter("_incomingScreenTrack","screen")});this.outgoingVideoHoldState=false;this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionIceConnectionStateChangeHandler=At(this,en,vn).bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=At(this,tn,mn).bind(this);this._onPeerConnectionSignalingStateChangeHandler=At(this,nn,fn).bind(this);this._onPeerConnectionTrackHandler=At(this,an,gn).bind(this);this._onPeerConnectionRemoveStreamHandler=At(this,rn,bn).bind(this);this._updateTracksDebounced=l.Runtime.debounce(At(this,dn,Sn).bind(this),50);this._waitTurnCandidatesTimeout=null;this.prevReport={};this.packetLostThreshold=7;this.videoBitrate=1e6;this.screenShareBitrate=15e5}babelHelpers.createClass(e,[{key:"_mediaGetter",value:function e(t){return function(){return this[t]}.bind(this)}},{key:"_mediaSetter",value:function e(t,i){return function(e){if(this[t]!=e){this[t]=e;if(e){this.callbacks.onMediaReceived({userId:this.userId,kind:i,track:e})}else{this.callbacks.onMediaStopped({userId:this.userId,kind:i})}}}.bind(this)}},{key:"sendMedia",value:function e(t){if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.sendNegotiationNeeded(false);return}}if(!this.peerConnection){var i=Do.getUuidv4();At(this,$i,pn).call(this,i)}this.updateOutgoingTracks();if(!t){this.applyResolutionScale();this.createAndSendOffer()}}},{key:"updateOutgoingTracks",value:function e(){if(!this.peerConnection){return}var t;var i;var n;if(this.call.localStreams["main"]&&this.call.localStreams["main"].getAudioTracks().length>0){t=this.call.localStreams["main"].getAudioTracks()[0]}if(this.call.localStreams["screen"]&&this.call.localStreams["screen"].getVideoTracks().length>0){n=this.call.localStreams["screen"].getVideoTracks()[0]}if(this.call.localStreams["main"]&&this.call.localStreams["main"].getVideoTracks().length>0){i=this.call.localStreams["main"].getVideoTracks()[0]}this.outgoingVideoTrack=i?i.clone():null;this.outgoingScreenTrack=n?n.clone():null;var s=[];if(t){s.push(t.id+" (audio)")}if(i){s.push(i.id+" ("+i.kind+")")}if(n){s.push(n.id+" ("+n.kind+")")}console.log("User: "+this.userId+"; Sending media streams. Tracks: "+s.join("; "));if(this.videoSender&&this.outgoingVideoTrack){this.videoSender.replaceTrack(this.outgoingVideoTrack)}if(!this.videoSender&&this.outgoingVideoTrack){this.videoSender=this.peerConnection.addTrack(this.outgoingVideoTrack)}if(this.videoSender&&!this.outgoingVideoTrack){this.peerConnection.removeTrack(this.videoSender);this.videoSender=null}if(this.screenSender&&this.outgoingScreenTrack){this.screenSender.replaceTrack(this.outgoingScreenTrack)}if(!this.screenSender&&this.outgoingScreenTrack){this.screenSender=this.peerConnection.addTrack(this.outgoingScreenTrack)}if(this.screenSender&&!this.outgoingScreenTrack){this.peerConnection.removeTrack(this.screenSender);this.screenSender=null}if(this.audioSender&&t){this.audioSender.replaceTrack(t)}if(!this.audioSender&&t){this.audioSender=this.peerConnection.addTrack(t)}if(this.audioSender&&!t){this.peerConnection.removeTrack(this.audioSender);this.audioSender=null}}},{key:"getSenderMid",value:function e(t){if(t===null||!this.peerConnection){return null}var i=this.peerConnection.getTransceivers().find((function(e){return e.sender==t}));return i?i.mid:null}},{key:"applyResolutionScale",value:function e(t){if(this.videoSender){var i=t||(this.screenSender?2:1);var n=this.videoBitrate/i;var s=this.videoSender.getParameters();if(s.encodings&&s.encodings.length>0){s.encodings[0].scaleResolutionDownBy=i;s.encodings[0].maxBitrate=n;this.videoSender.setParameters(s)}}if(this.screenSender){var a=this.screenSender.getParameters();if(a.encodings&&a.encodings.length>0){a.encodings[0].maxBitrate=this.screenShareBitrate;this.screenSender.setParameters(a)}}}},{key:"replaceMediaStream",value:function e(t){if(this.isRenegotiationSupported()){this.sendMedia()}else{this.localStreams[t]=this.call.getLocalStream(t);this.reconnect()}}},{key:"holdOutgoingVideo",value:function e(t){if(this.outgoingVideoHoldState==t){return}this.outgoingVideoHoldState=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}},{key:"isInitiator",value:function e(){return this.call.userId<this.userId}},{key:"isRenegotiationSupported",value:function e(){return true}},{key:"setReady",value:function e(t){this.ready=t;if(this.ready){this.declined=false;this.busy=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isReady",value:function e(){return this.ready}},{key:"onInvited",value:function e(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(function(){this.onInviteTimeout(true)}.bind(this),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"setUserAgent",value:function e(t){this.userAgent=t;this.isFirefox=t.toLowerCase().indexOf("firefox")!=-1;this.isChrome=t.toLowerCase().indexOf("chrome")!=-1;this.isLegacyMobile=t==="Bitrix Legacy Mobile"}},{key:"getUserAgent",value:function e(){return this.userAgent}},{key:"isParticipating",value:function e(){if(this.calling){return true}if(this.declined||this.busy){return false}if(this.peerConnection){var t=this.peerConnection.iceConnectionState;if(t=="checking"||t=="connected"||t=="completed"){return true}}return false}},{key:"setSignalingConnected",value:function e(t){this.signalingConnected=t;this.updateCalculatedState();if(this.signalingConnected){this.refreshSignalingTimeout()}else{this.stopSignalingTimeout()}}},{key:"isSignalingConnected",value:function e(){return this.signalingConnected}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isDeclined",value:function e(){return this.declined}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,isLegacyMobile:this.isLegacyMobile,networkProblem:!this.hasStun||!this.hasTurn});this.calculatedState=t}}},{key:"calculateState",value:function e(){if(this.peerConnection){if(this.failureReason!==""){return mr.Failed}if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return mr.Connected}return mr.Connecting}if(this.calling){return mr.Calling}if(this.inviteTimeout){return mr.Unavailable}if(this.declined){return mr.Declined}if(this.busy){return mr.Busy}if(this.ready){return mr.Ready}return mr.Idle}},{key:"getSignaling",value:function e(){return this.call.signaling}},{key:"startStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=setInterval(function(){if(!this.peerConnection){return false}this.peerConnection.getStats().then(function(e){var t,i=this;var n=[];var s={};var a={};var r=!!((t=this.prevReport[z.Camera])!==null&&t!==void 0&&t.largeDataLoss);var o;e.forEach((function(e){n.push(e);var t=(e===null||e===void 0?void 0:e.trackIdentifier)&&(e===null||e===void 0?void 0:e.kind)==="video"&&(e===null||e===void 0?void 0:e.type)==="inbound-rtp"&&e.hasOwnProperty("packetsLost")&&e.hasOwnProperty("packetsReceived");if(t){switch(i.trackList[e.mid]){case"video":e.source=z.Camera;break;case"screen":e.source=z.Screen;break;default:return}i.prevReport[e.source]=i.prevReport[e.source]||{};var r=e.packetsLost,l=e.packetsReceived;var c=l-(i.prevReport[e.source].packetsReceived||0);var d=r-(i.prevReport[e.source].packetsLost||0);var u=c/100*d;i.prevReport[e.source].packetsLost=r;i.prevReport[e.source].packetsReceived=l;if(e.source===z.Camera){o=u>i.packetLostThreshold;i.prevReport[e.source].largeDataLoss=o}var h=e.bytesReceived-(i.prevReport[e.source].bytesReceived||0);var p=e.timestamp-(i.prevReport[e.source].timestamp||0);var v=8*h/(p/1e3);e.bitrate=v<0?0:Math.trunc(v);i.prevReport[e.source].bytesReceived=e.bytesReceived;i.prevReport[e.source].timestamp=e.timestamp;if(s[e.codecId]){e.codecName=s[e.codecId]}else if(a[e.codecId]){a[e.codecId].push(e)}else{a[e.codecId]=[e]}}else if(e.type==="codec"){s[e.id]=e.mimeType;if(a[e.id]){a[e.id].forEach((function(t){t.codecName=e.mimeType}));delete a[e.id]}}}));if(o!==undefined&&o!==r){this.callbacks.onRTCQualityChanged({userId:this.userId,hasConnectionProblem:o})}this.callbacks.onRTCStatsReceived({userId:this.userId,stats:n})}.bind(this))}.bind(this),1e3)}},{key:"stopStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=null}},{key:"updateCandidatesTimeout",value:function e(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)}},{key:"sendIceCandidates",value:function e(){this.log("User "+this.userId+": sending ICE candidates due to the timeout");this.candidatesTimeout=null;if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}}},{key:"_destroyPeerConnection",value:function e(){if(!this.peerConnection){return}clearTimeout(this.reconnectAfterDisconnectTimeout);this.log("User "+this.userId+": Destroying peer connection "+this.peerConnectionId);this.stopStatisticsGathering();this.peerConnection.removeEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.removeEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.removeEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.removeEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.removeEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.removeEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.localIceCandidates=[];if(this.pendingIceCandidates[this.peerConnectionId]){delete this.pendingIceCandidates[this.peerConnectionId]}this.peerConnection.close();this.peerConnection=null;this.peerConnectionId=null;this.videoSender=null;this.screenSender=null;this.audioSender=null;this.incomingAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"_onPeerConnectionIceCandidate",value:function e(t){var i=t.candidate;this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+(i?i.candidate:i));if(i){if(this.getSignaling().isIceTricklingAllowed()){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:[i.toJSON()]})}else{this.localIceCandidates.push(i.toJSON());this.updateCandidatesTimeout()}var n=i.candidate.match(/typ\s(\w+)?/);if(n){var s=n[1];if(s=="srflx"){this.hasStun=true}else if(s=="relay"){this.hasTurn=true}}}}},{key:"stopSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout)}},{key:"refreshSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(At(this,un,wn).bind(this),Ft)}},{key:"_onConnectionOfferReplyTimeout",value:function e(t){this.log("did not receive connection answer for connection "+t);this.reconnect()}},{key:"_onNegotiationNeededReplyTimeout",value:function e(){this.log("did not receive connection offer in time");this.reconnect()}},{key:"setConnectionOffer",value:function e(t,i,n){this.log("User "+this.userId+": applying connection offer for connection "+t);clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=null;if(!this.call.isReady()){return}if(!this.isReady()){return}if(n){this.trackList=BX.util.array_flip(n)}if(this.peerConnection){if(this.peerConnectionId!==t){this._destroyPeerConnection();At(this,$i,pn).call(this,t)}}else{At(this,$i,pn).call(this,t)}this.applyOfferAndSendAnswer(i)}},{key:"createAndSendOffer",value:function e(t){var i=this;var n=Vt;for(var s in t){n[s]=t[s]}this.peerConnection.createOffer(n).then((function(e){i.log("User "+i.userId+": Created connection offer.");i.log("Applying local description");return i.peerConnection.setLocalDescription(e)})).then((function(){i.sendOffer()}))}},{key:"sendOffer",value:function e(){var t=this;clearTimeout(this.connectionOfferReplyTimeout);this.connectionOfferReplyTimeout=setTimeout((function(){return t._onConnectionOfferReplyTimeout(t.peerConnectionId)}),Ot);this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:this.peerConnectionId,sdp:this.peerConnection.localDescription.sdp,tracks:{audio:this.getSenderMid(this.audioSender),video:this.getSenderMid(this.videoSender),screen:this.getSenderMid(this.screenSender)},userAgent:navigator.userAgent})}},{key:"sendNegotiationNeeded",value:function e(t){var i=this;t=t===true;clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=setTimeout((function(){return i._onNegotiationNeededReplyTimeout()}),Ot);var n={userId:this.userId};if(t){n.restart=true}this.getSignaling().sendNegotiationNeeded(n)}},{key:"applyOfferAndSendAnswer",value:function e(t){var i=this;var n=new RTCSessionDescription({type:"offer",sdp:t});this.log("User: "+this.userId+"; Applying remote offer");this.log("User: "+this.userId+"; Peer ice connection state ",this.peerConnection.iceConnectionState);this.peerConnection.setRemoteDescription(n).then((function(){if(i.peerConnection.iceConnectionState==="new"){i.sendMedia(true)}return i.peerConnection.createAnswer()})).then((function(e){i.log("Created connection answer.");i.log("Applying local description.");return i.peerConnection.setLocalDescription(e)})).then((function(){i.applyResolutionScale();i.applyPendingIceCandidates();i.getSignaling().sendConnectionAnswer({userId:i.userId,connectionId:i.peerConnectionId,sdp:i.peerConnection.localDescription.sdp,tracks:{audio:i.getSenderMid(i.audioSender),video:i.getSenderMid(i.videoSender),screen:i.getSenderMid(i.screenSender)},userAgent:navigator.userAgent})}))["catch"]((function(e){i.failureReason=e.toString();i.updateCalculatedState();i.log("Could not apply remote offer",e);console.error("Could not apply remote offer",e)}))}},{key:"setConnectionAnswer",value:function e(t,i,n){var s=this;if(!this.peerConnection||this.peerConnectionId!=t){this.log("Could not apply answer, for unknown connection "+t);return}if(this.peerConnection.signalingState!=="have-local-offer"){this.log("Could not apply answer, wrong peer connection signaling state "+this.peerConnection.signalingState);return}if(n){this.trackList=BX.util.array_flip(n)}var a=new RTCSessionDescription({type:"answer",sdp:i});clearTimeout(this.connectionOfferReplyTimeout);this.log("User: "+this.userId+"; Applying remote answer");this.peerConnection.setRemoteDescription(a).then((function(){s.applyPendingIceCandidates()}))["catch"]((function(e){s.failureReason=e.toString();s.updateCalculatedState();s.log(e)}))}},{key:"addIceCandidate",value:function e(t,i){var n=this;if(!this.peerConnection){return}if(this.peerConnectionId!=t){this.log("Error: Candidate for unknown connection "+t);return}if(this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){this.peerConnection.addIceCandidate(i).then((function(){n.log("User: "+n.userId+"; Added remote ICE candidate: "+(i?i.candidate:i))}))["catch"]((function(e){n.log(e)}))}else{if(!this.pendingIceCandidates[t]){this.pendingIceCandidates[t]=[]}this.pendingIceCandidates[t].push(i)}}},{key:"applyPendingIceCandidates",value:function e(){var t=this;if(!this.peerConnection||!this.peerConnection.remoteDescription.type){return}if(l.Type.isArray(this.pendingIceCandidates[this.peerConnectionId])){this.pendingIceCandidates[this.peerConnectionId].forEach((function(e){t.peerConnection.addIceCandidate(e).then((function(){t.log("User: "+t.userId+"; Added remote ICE candidate: "+(e?e.candidate:e))}))}));this.pendingIceCandidates[this.peerConnectionId]=[]}}},{key:"onNegotiationNeeded",value:function e(){if(this.peerConnection){if(this.peerConnection.signalingState=="have-local-offer"){this.sendOffer()}else{this.createAndSendOffer({iceRestart:true})}}else{this.sendMedia()}}},{key:"reconnect",value:function e(){clearTimeout(this.reconnectAfterDisconnectTimeout);this.connectionAttempt++;this.callbacks.onReconnecting();this.log("Trying to restore ICE connection. Attempt "+this.connectionAttempt);if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}else{this.sendNegotiationNeeded(true)}}},{key:"disconnect",value:function e(){this._destroyPeerConnection();this.outgoingVideoTrack=null;this.outgoingScreenTrack=null;this.outgoingVideoHoldState=false;this.incomingAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){this.disconnect();if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}for(var t in this.localStreams){this.localStreams[t]=null}clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaStopped=BX.DoNothing}}]);return e}();function pn(e){this.log("User "+this.userId+": Creating peer connection");var t={iceServers:[{urls:"stun:"+this.call.turnServer},{urls:"turn:"+this.call.turnServer,username:this.call.turnServerLogin,credential:this.call.turnServerPassword}]};this.localIceCandidates=[];this.peerConnection=new RTCPeerConnection(t);this.peerConnectionId=e;this.peerConnection.addEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.addEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.addEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.addEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.addEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.addEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.failureReason="";this.hasStun=false;this.hasTurn=false;this.updateCalculatedState();this.startStatisticsGathering()}function vn(){var e=this;this.log("User "+this.userId+": ICE connection state changed. New state: "+this.peerConnection.iceConnectionState);if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){this.connectionAttempt=0;this.callbacks.onReconnected();clearTimeout(this.reconnectAfterDisconnectTimeout);this._updateTracksDebounced()}else if(this.peerConnection.iceConnectionState==="failed"){this.log("ICE connection failed. Trying to restore connection immediately");this.reconnect()}else if(this.peerConnection.iceConnectionState==="disconnected"){this.log("ICE connection lost. Waiting 5 seconds before trying to restore it");clearTimeout(this.reconnectAfterDisconnectTimeout);this.reconnectAfterDisconnectTimeout=setTimeout((function(){return e.reconnect()}),5e3)}this.updateCalculatedState()}function mn(e){var t=e.target;this.log("User "+this.userId+": ICE gathering state changed to : "+t.iceGatheringState);if(t.iceGatheringState==="complete"){this.log("User "+this.userId+": ICE gathering complete");if(!this.hasStun||!this.hasTurn){var i=[];if(!this.hasTurn){i.push("TURN")}if(!this.hasStun){i.push("STUN")}this.log("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");console.error("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");this.callbacks.onNetworkProblem()}if(!this.hasTurn&&!this.hasStun);if(!this.getSignaling().isIceTricklingAllowed()){if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates already sent")}}}}function fn(){this.log("User "+this.userId+" PC signalingState: "+this.peerConnection.signalingState);if(this.peerConnection.signalingState==="stable"){this._updateTracksDebounced()}}function gn(e){this.log("User "+this.userId+": media track received: ",e.track.id+" ("+e.track.kind+")");if(e.track.kind==="video"){e.track.addEventListener("mute",At(this,on,Cn).bind(this));e.track.addEventListener("unmute",At(this,ln,kn).bind(this));e.track.addEventListener("ended",At(this,cn,yn).bind(this));if(this.trackList[e.track.id]==="screen"){this.incomingScreenTrack=e.track}else{this.incomingVideoTrack=e.track}}else if(e.track.kind==="audio"){this.incomingAudioTrack=e.track}}function bn(e){this.log("User: "+this.userId+"_onPeerConnectionRemoveStream: ",e)}function Cn(){console.log("Video track muted")}function kn(){console.log("Video track unmuted")}function yn(){console.log("Video track ended")}function Sn(){var e=this;if(!this.peerConnection){return null}var t=null;var i=null;var n=null;this.peerConnection.getTransceivers().forEach((function(s){e.call.log("[debug] tr direction: "+s.direction+" currentDirection: "+s.currentDirection);if(s.currentDirection==="sendrecv"||s.currentDirection==="recvonly"){if(s.receiver&&s.receiver.track){var a=s.receiver.track;if(a.kind==="audio"){t=a}else if(a.kind==="video"){if(e.trackList[s.mid]==="screen"){n=a}else{i=a}}}}}));this.incomingAudioTrack=t;this.incomingVideoTrack=i;this.incomingScreenTrack=n}function wn(){this.setSignalingConnected(false)}var In;function Mn(e,t,i){Tn(e,t);t.set(e,i)}function _n(e,t){Tn(e,t);t.add(e)}function Tn(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function En(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Rn={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var Pn={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};var Bn={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",recordState:"Call::recordState",emotion:"Call::emotion",customMessage:"Call::customMessage",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll",joinRoom:"Call::joinRoom",leaveRoom:"Call::leaveRoom",listRooms:"Call::listRooms",requestRoomSpeaker:"Call::requestRoomSpeaker"};var Hn={viewerJoined:"Call::viewerJoined",viewerLeft:"Call::viewerLeft",joinRoomOffer:"Call::joinRoomOffer",transferRoomHost:"Call::transferRoomHost",listRoomsResponse:"Call::listRoomsResponse",roomUpdated:"Call::roomUpdated"};var Dn={onCallConference:"BitrixCall::onCallConference"};var Ln=(In={},babelHelpers.defineProperty(In,z.Camera,"video"),babelHelpers.defineProperty(In,z.Microphone,"audio"),babelHelpers.defineProperty(In,z.Screen,"sharing"),In);var xn=5e3;var An=25e3;var Nn=5500;var Un=15e3;var Vn=new WeakSet;var Fn=new WeakSet;var On=new WeakSet;var Xn=new WeakSet;var Wn=new WeakSet;var Gn=new WeakMap;var zn=new WeakMap;var jn=new WeakSet;var qn=new WeakMap;var Kn=new WeakMap;var Jn=new WeakMap;var Yn=new WeakMap;var Qn=new WeakMap;var Zn=new WeakMap;var $n=new WeakMap;var es=new WeakMap;var ts=new WeakMap;var is=new WeakMap;var ns=new WeakMap;var ss=new WeakMap;var as=new WeakMap;var rs=new WeakMap;var os=new WeakMap;var ls=new WeakMap;var cs=new WeakMap;var ds=new WeakMap;var us=new WeakMap;var hs=new WeakMap;var ps=new WeakMap;var vs=new WeakMap;var ms=new WeakMap;var fs=new WeakMap;var gs=new WeakMap;var bs=new WeakMap;var Cs=new WeakMap;var ks=new WeakMap;var ys=new WeakSet;var Ss=new WeakMap;var ws=new WeakMap;var Is=new WeakMap;var Ms=new WeakMap;var _s=new WeakMap;var Ts=new WeakMap;var Es=new WeakMap;var Rs=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));_n(babelHelpers.assertThisInitialized(i),ys);_n(babelHelpers.assertThisInitialized(i),jn);_n(babelHelpers.assertThisInitialized(i),Wn);_n(babelHelpers.assertThisInitialized(i),Xn);_n(babelHelpers.assertThisInitialized(i),On);_n(babelHelpers.assertThisInitialized(i),Fn);_n(babelHelpers.assertThisInitialized(i),Vn);Mn(babelHelpers.assertThisInitialized(i),Gn,{writable:true,value:function e(t){i.runCallback(Sr.onUserStateChanged,t);if(!i.ready){return}if(t.state==mr.Failed||t.state==mr.Unavailable||t.state==mr.Declined||t.state==mr.Idle){if(i.type==gr.Instant&&!i.isAnyoneParticipating()){i.hangup()}}}});Mn(babelHelpers.assertThisInitialized(i),zn,{writable:true,value:function e(t){if(!i.ready){return}i.signaling.sendUserInviteTimeout({userId:i.users.filter((function(e){return Number.isInteger(e)})),failedUserId:t.userId})}});Mn(babelHelpers.assertThisInitialized(i),qn,{writable:true,value:function e(t){var n=t.external?t.senderId:Number(t.senderId);if(n==i.userId){return i.__onPullEventAnswerSelf(t)}if(!i.peers[n]){i.peers[n]=i.createPeer(n);i.runCallback(Sr.onUserInvited,{userId:n})}if(!i.users.includes(n)){i.users.push(n)}i.peers[n].setReady(true)}});Mn(babelHelpers.assertThisInitialized(i),Kn,{writable:true,value:function e(t){var n=t.senderId;if(i.userId==n&&i.instanceId!=t.callInstanceId){i.runCallback(Sr.onLeave,{local:false});return}if(!i.peers[n]){return}i.peers[n].participant=null;i.peers[n].setReady(false);if(t.code==603){i.peers[n].setDeclined(true)}else if(t.code==486){i.peers[n].setBusy(true);console.error("user "+n+" is busy")}if(i.ready&&i.type==gr.Instant&&!i.isAnyoneParticipating()){i.hangup()}}});Mn(babelHelpers.assertThisInitialized(i),Jn,{writable:true,value:function e(t){i.log("__onPullEventUsersJoined",t);var n=t.users;i.addJoinedUsers(n)}});Mn(babelHelpers.assertThisInitialized(i),Yn,{writable:true,value:function e(t){i.log("__onPullEventUsersInvited",t);var n=t.users;if(i.type===gr.Instant){i.addInvitedUsers(n)}}});Mn(babelHelpers.assertThisInitialized(i),Qn,{writable:true,value:function e(t){i.log("__onPullEventUserInviteTimeout",t);var n=t.failedUserId;if(i.peers[n]){i.peers[n].onInviteTimeout(false)}}});Mn(babelHelpers.assertThisInitialized(i),Zn,{writable:true,value:function e(t){if(t.callInstanceId==i.instanceId){return}var n=Number(t.senderId);if(n==i.userId){if(!i.joinedElsewhere){i.runCallback(Sr.onJoin,{local:false});i.joinedElsewhere=true}clearTimeout(i.lastSelfPingReceivedTimeout);i.lastSelfPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),es),xn*2.1)}clearTimeout(i.lastPingReceivedTimeout);i.lastPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),$n),xn*2.1);if(i.peers[n]){i.peers[n].setReady(true)}}});Mn(babelHelpers.assertThisInitialized(i),$n,{writable:true,value:function e(){if(!i.ready){i.destroy()}}});Mn(babelHelpers.assertThisInitialized(i),es,{writable:true,value:function e(){i.runCallback(Sr.onLeave,{local:false});i.joinedElsewhere=false}});Mn(babelHelpers.assertThisInitialized(i),ts,{writable:true,value:function e(){if(!i.isAnyoneParticipating()){i.destroy()}}});Mn(babelHelpers.assertThisInitialized(i),is,{writable:true,value:function e(){if(i.ready){i.signaling.sendAnswer({userId:i.userId},true)}}});Mn(babelHelpers.assertThisInitialized(i),ns,{writable:true,value:function e(t){var n;var s;switch(t){case z.Camera:i.BitrixCall.getLocalVideo().then((function(e){n=(e===null||e===void 0?void 0:e.label)||"";s="video";var t=new Ys({kind:s,track:e});i.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:t,tag:"main",stream:t.stream});i.signaling.sendCameraState(i.videoEnabled)}));break;case z.Screen:i.log("Screen shared");i.screenShared=true;i.waitingLocalScreenShare=false;i.BitrixCall.getLocalScreen().then((function(e){n=(e===null||e===void 0?void 0:e.label)||"";s="sharing";i.screenShared=true;var t=new Ys({kind:s,track:e});i.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:t,tag:"screen",stream:new MediaStream})}));break;case z.Microphone:i.BitrixCall.getLocalAudio().then((function(e){En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Microphone,false);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ps).call(babelHelpers.assertThisInitialized(i),{result:true,stream:new MediaStream([e])});i.signaling.sendMicrophoneState(i.muted)}));break}i.log("__onLocalMediaRendererAdded",s,n)}});Mn(babelHelpers.assertThisInitialized(i),ss,{writable:true,value:function e(t){if(t===z.Microphone){i.signaling.sendMicrophoneState(i.muted);En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Microphone,false)}else if(t===z.Camera){i.signaling.sendCameraState(i.videoEnabled);En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Camera,false)}}});Mn(babelHelpers.assertThisInitialized(i),as,{writable:true,value:function e(t,n){var s=Ln[t];if(!s){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}switch(t){case z.Camera:case z.Microphone:if(!n){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),os).call(babelHelpers.assertThisInitialized(i),t)}break;case z.Screen:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),os).call(babelHelpers.assertThisInitialized(i),t);break}}});Mn(babelHelpers.assertThisInitialized(i),rs,{writable:true,value:function e(){i.runCallback("onGetUserMediaEnded",{})}});Mn(babelHelpers.assertThisInitialized(i),os,{writable:true,value:function e(t){var n=Ln[t];if(!n){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}i.log("__onBeforeLocalMediaRendererRemoved",n);var s=new Ys({kind:n});switch(t){case z.Camera:i.localVideoShown=false;i.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:s,tag:"main",stream:new MediaStream,removed:true});i.signaling.sendCameraState(i.videoEnabled);i.BitrixCall.disableVideo();break;case z.Microphone:En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Microphone,false);i.signaling.sendMicrophoneState(i.muted);i.BitrixCall.disableAudio();break;case z.Screen:i.BitrixCall.stopScreenShare();i.log("Screen is no longer shared");i.runCallback(Sr.onUserScreenState,{userId:i.userId,screenState:false});i.screenShared=false;i.waitingLocalScreenShare=false;i.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:s,tag:"screen",stream:new MediaStream,removed:true});break}}});Mn(babelHelpers.assertThisInitialized(i),ls,{writable:true,value:function e(t,n){var s=Ln[n.source];if(!s){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var a={mediaRenderer:new Ys({kind:s,track:n.track})};var r=i.peers[t.userId];if(r){r.addMediaRenderer(a.mediaRenderer)}switch(n.source){case z.Camera:i.runCallback(Sr.onUserCameraState,{userId:t.userId,cameraState:!t.isMutedVideo});break;case z.Microphone:i.runCallback(Sr.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio});break}}});Mn(babelHelpers.assertThisInitialized(i),cs,{writable:true,value:function e(t,n){var s=Ln[n.source];if(!s){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var a={mediaRenderer:new Ys({kind:s,track:n.track})};var r=i.peers[t.userId];if(r){r.removeMediaRenderer(a.mediaRenderer)}}});Mn(babelHelpers.assertThisInitialized(i),ds,{writable:true,value:function e(t,n){if(n.source===z.Microphone){i.runCallback(Sr.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio})}}});Mn(babelHelpers.assertThisInitialized(i),us,{writable:true,value:function e(t){var n=i.peers[t.userId];if(n){if(!t.audioEnabled||t.isMutedAudio){i.runCallback(Sr.onUserMicrophoneState,{userId:t.userId,microphoneState:false})}if(!t.videoEnabled||t.isMutedVideo){i.runCallback(Sr.onUserCameraState,{userId:t.userId,cameraState:false})}if(t.isHandRaised){i.runCallback(Sr.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}n.participant=t;n.updateCalculatedState();if(i.recordState.state!==Rt.RecordState.Stopped&&i.recordState.userId===i.userId){i.signaling.sendRecordState(i.userId,i.recordState)}}else{i.users.push(t.userId);var s=i.createPeer(t.userId);s.participant=t;i.peers[t.userId]=s;i.runCallback("onUserFromWeb",t);if(!t.audioEnabled||t.isMutedAudio){i.runCallback(Sr.onUserMicrophoneState,{userId:t.userId,microphoneState:false})}if(!t.videoEnabled||t.isMutedVideo){i.runCallback(Sr.onUserCameraState,{userId:t.userId,cameraState:false})}if(!s.ready){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),qn).call(babelHelpers.assertThisInitialized(i),{senderId:t.userId,external:true})}}}});Mn(babelHelpers.assertThisInitialized(i),hs,{writable:true,value:function e(t){var n=i.peers[t.userId];if(n){if(n.ready&&Number.isNaN(t.userId)){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Kn).call(babelHelpers.assertThisInitialized(i),{senderId:t.userId})}n.participant=null;for(var s in z){var a=z[s];var r=Ln[a];var o={mediaRenderer:new Ys({kind:r})};n.removeMediaRenderer(o.mediaRenderer)}n.updateCalculatedState()}}});Mn(babelHelpers.assertThisInitialized(i),ps,{writable:true,value:function e(t){if(t.result){if(t.stream.getAudioTracks().length>0){if(i.localVAD){i.localVAD.destroy()}i.localVAD=new Dt({mediaStream:t.stream,onVoiceStarted:function e(){i.runCallback(Sr.onUserVoiceStarted,{userId:i.userId,local:true});if(!i.muted){i.signaling.sendVoiceStarted()}},onVoiceStopped:function e(){i.runCallback(Sr.onUserVoiceStopped,{userId:i.userId,local:true});i.signaling.sendVoiceStopped()}});clearInterval(i.microphoneLevelInterval);i.microphoneLevelInterval=setInterval((function(){return i.microphoneLevel=i.localVAD.currentVolume}),200)}}}});Mn(babelHelpers.assertThisInitialized(i),vs,{writable:true,value:function e(){i.reconnectionEventCount++;for(var t in i.peers){if(t!==i.userId&&i.peers.hasOwnProperty(t)&&i.peers[t].calculatedState===mr.Connected){for(var n in z){var s=z[n];var a=Ln[s];var r={mediaRenderer:new Ys({kind:a})};i.peers[t].removeMediaRenderer(r.mediaRenderer)}}}}});Mn(babelHelpers.assertThisInitialized(i),ms,{writable:true,value:function e(){i.reconnectionEventCount=0;i.log("Call reconnected");i.sendTelemetryEvent("reconnect");i.localUserState=mr.Connected;if(!i.muted){if(!i.BitrixCall.isAudioPublished()){En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Microphone,true)}i.BitrixCall.enableAudio()}if(i.videoEnabled){if(!i.BitrixCall.isVideoPublished()){En(babelHelpers.assertThisInitialized(i),Vn,Ps).call(babelHelpers.assertThisInitialized(i),z.Camera,true)}i.BitrixCall.enableVideo()}if(i.screenShared||i.waitingLocalScreenShare){i.BitrixCall.startScreenShare()}if(i.videoAllowedFrom==yr.none){i.signaling.sendHideAll()}else if(l.Type.isArray(i.videoAllowedFrom)){i.signaling.sendShowUsers(i.videoAllowedFrom)}}});Mn(babelHelpers.assertThisInitialized(i),fs,{writable:true,value:function e(){i.reconnectionEventCount++}});Mn(babelHelpers.assertThisInitialized(i),gs,{writable:true,value:function e(){i.reconnectionEventCount--}});Mn(babelHelpers.assertThisInitialized(i),bs,{writable:true,value:function e(t){i.log("__onCallDisconnected",t&&t.headers?{headers:t.headers}:null);i.sendTelemetryEvent("disconnect");i.localUserState=mr.Idle;i.ready=false;i.muted=false;i.joinedAsViewer=false;i.reinitPeers();En(babelHelpers.assertThisInitialized(i),On,Hs).call(babelHelpers.assertThisInitialized(i));i.removeCallEvents();i.BitrixCall=null;i.state=vr.Proceeding;i.runCallback(Sr.onLeave,{local:true})}});Mn(babelHelpers.assertThisInitialized(i),Cs,{writable:true,value:function e(){if(i.ready&&i.BitrixCall){i.signaling.sendHangup({userId:i.users.filter((function(e){return Number.isInteger(e)}))})}}});Mn(babelHelpers.assertThisInitialized(i),ks,{writable:true,value:function e(t){if(t&&t.call){delete t.call}i.log("onFatalError",t);i.ready=false;i.muted=false;i.localUserState=mr.Failed;i.reinitPeers();En(babelHelpers.assertThisInitialized(i),On,Hs).call(babelHelpers.assertThisInitialized(i)).then((function(){if(i.BitrixCall){i.removeCallEvents();try{i.BitrixCall.hangup({"X-Reason":"Fatal error","X-Error":typeof t==="string"?t:t.code||t.name})}catch(e){i.log("Bitrix hangup error: ",e);console.error("Bitrix hangup error: ",e)}i.BitrixCall=null}if(typeof t==="string"){i.runCallback(Sr.onCallFailure,{name:t})}else if(t.name){i.runCallback(Sr.onCallFailure,t)}}))}});Mn(babelHelpers.assertThisInitialized(i),Ss,{writable:true,value:function e(t){var n=t.endpoint;var s=n.userName;i.log("__onCallEndpointAdded ("+s+")",t.endpoint);console.log("__onCallEndpointAdded ("+s+")",t.endpoint);if(l.Type.isStringFilled(s)&&s.startsWith("user")){En(babelHelpers.assertThisInitialized(i),ys,As).call(babelHelpers.assertThisInitialized(i),s,n)}else{i.log("Unknown endpoint "+s);console.warn("Unknown endpoint "+s)}}});Mn(babelHelpers.assertThisInitialized(i),ws,{writable:true,value:function e(t){var n={};t.recipient.forEach((function(e){if(e.userId&&e.kind==="video"){if(!n[e.userId]){n[e.userId]={}}n[e.userId][e.source]=e}}));for(var s in n){i.runCallback(Sr.onUserStatsReceived,{userId:s,report:n[s]})}}});Mn(babelHelpers.assertThisInitialized(i),Is,{writable:true,value:function e(t){var n=new Set(babelHelpers.toConsumableArray(i.peersWithBadConnection.values()));t.forEach((function(e){var t=i.peers[e];if(t){if(!n.has(e)){i.peersWithBadConnection.add(e);i.runCallback(Sr.onConnectionQualityChanged,{userId:e,hasConnectionProblem:true})}else{n["delete"](e)}}}));n.forEach((function(e){i.runCallback(Sr.onConnectionQualityChanged,{userId:e,hasConnectionProblem:false})}))}});Mn(babelHelpers.assertThisInitialized(i),Ms,{writable:true,value:function e(t){console.warn("__onJoinRoomOffer",t);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});i.runCallback(Sr.onJoinRoomOffer,{roomId:t.roomId,users:t.users,initiator:t.initiator,speaker:t.speaker})}});Mn(babelHelpers.assertThisInitialized(i),_s,{writable:true,value:function e(t){var n=t.roomId===i._currentRoomId&&i.rooms[t.roomId]&&i.rooms[t.roomId].speaker!=t.speaker;var s=n&&i.rooms[t.roomId].speaker;console.log("__onRoomUpdated; speakerChanged: ",n);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});if(t.roomId===i._currentRoomId&&t.users.indexOf(i.userId)===-1){i._currentRoomId=null;i.runCallback(Sr.onLeaveRoom,{roomId:t.roomId})}else if(t.roomId!==i._currentRoomId&&t.users.indexOf(i.userId)!==-1){i._currentRoomId=t.roomId;i.runCallback(Sr.onJoinRoom,{roomId:t.roomId,speaker:i.currentRoom().speaker,users:i.currentRoom().users})}else if(n){i.runCallback(Sr.onTransferRoomSpeaker,{roomId:t.roomId,speaker:t.speaker,previousSpeaker:s,initiator:t.initiator})}}});Mn(babelHelpers.assertThisInitialized(i),Ts,{writable:true,value:function e(t){var n;var s;try{n=JSON.parse(t.text)}catch(e){i.log("Could not parse scenario message.",e);return}var a=n.eventName;if(a===Bn.voiceStarted){i.runCallback(Sr.onUserVoiceStarted,{userId:n.senderId})}else if(a===Bn.voiceStopped){i.runCallback(Sr.onUserVoiceStopped,{userId:n.senderId})}else if(a===Bn.cameraState){i.runCallback(Sr.onUserCameraState,{userId:n.senderId,cameraState:n.cameraState==="Y"})}else if(a===Bn.videoPaused){i.runCallback(Sr.onUserVideoPaused,{userId:n.senderId,videoPaused:n.videoPaused==="Y"})}else if(a===Bn.screenState){i.runCallback(Sr.onUserScreenState,{userId:n.senderId,screenState:n.screenState==="Y"})}else if(a===Bn.recordState){i.runCallback(Sr.onUserRecordState,{userId:n.senderId,recordState:n.recordState})}else if(a===Bn.emotion){i.runCallback(Sr.onUserEmotion,{userId:n.senderId,toUserId:n.toUserId,emotion:n.emotion})}else if(a===Bn.customMessage){i.runCallback(Sr.onCustomMessage,{message:n.message})}else if(a==="scenarioLogUrl"){console.warn("scenario log url: "+n.logUrl)}else if(a===Hn.joinRoomOffer){console.log(n);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ms).call(babelHelpers.assertThisInitialized(i),n)}else if(a===Hn.roomUpdated){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_s).call(babelHelpers.assertThisInitialized(i),n)}else if(a===Hn.listRoomsResponse){if(i.__resolveListRooms){i.__resolveListRooms(n.rooms);delete i.__resolveListRooms}}else if(a===Hn.viewerJoined){console.log("viewer "+n.senderId+" joined");s=i.peers[n.senderId];if(s){s.setDirection(fr.RecvOnly);s.setReady(true)}}else if(a===Hn.viewerLeft){console.log("viewer "+n.senderId+" left");s=i.peers[n.senderId];if(s){s.setReady(false)}}else{i.log("Unknown scenario event "+a)}}});Mn(babelHelpers.assertThisInitialized(i),Es,{writable:true,value:function e(t){i.runCallback(Sr.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}});i.videoQuality=kr.VeryHigh;i.BitrixCall=null;i.signaling=new Fs({call:babelHelpers.assertThisInitialized(i)});i.peers={};i.peersWithBadConnection=new Set;i.joinedElsewhere=false;i.joinedAsViewer=false;i.localVideoShown=false;i._localUserState=mr.Idle;i.clientEventsBound=false;i._screenShared=false;i.videoAllowedFrom=yr.all;i.direction=fr.SendRecv;i.userData=e.userData;i.recordState={state:Rt.RecordState.Stopped,userId:0,date:{start:null,pause:[]}};i.microphoneLevelInterval=null;i.rooms={};window.addEventListener("unload",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Cs));i.initPeers();i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),xn);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),An);i.lastPingReceivedTimeout=null;i.lastSelfPingReceivedTimeout=null;i.reinviteTimeout=null;i._reconnectionEventCount=0;i.pullEventHandlers={"Call::answer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),qn),"Call::hangup":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Kn),"Call::usersJoined":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Jn),"Call::usersInvited":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Yn),"Call::userInviteTimeout":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Qn),"Call::ping":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Zn),"Call::finish":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ts),"Call::repeatAnswer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),is)};return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(){var t=this;this.users.forEach((function(e){e=Number(e);if(e){t.peers[e]=t.createPeer(e)}}))}},{key:"reinitPeers",value:function e(){for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t]){this.peers[t].destroy();this.peers[t]=null;if(!Number(t)){delete this.peers[t]}}}this.initPeers()}},{key:"pingUsers",value:function e(){if(this.ready){var t=this.users.filter((function(e){return Number.isInteger(e)})).concat(this.userId);this.signaling.sendPingToUsers({userId:t},true)}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"createPeer",value:function e(t){var i=this;var n;if(this.videoAllowedFrom===yr.all){n=true}else if(this.videoAllowedFrom===yr.none){n=false}else if(l.Type.isArray(this.videoAllowedFrom)){n=this.videoAllowedFrom.some((function(e){return e==t}))}else{n=true}return new Js({call:this,userId:t,ready:t==this.initiatorId,isIncomingVideoAllowed:n,onMediaReceived:function e(n){i.runCallback(Sr.onRemoteMediaReceived,n);if(n.kind==="video"){i.runCallback(Sr.onUserVideoPaused,{userId:t,videoPaused:false})}},onMediaRemoved:function e(t){i.runCallback(Sr.onRemoteMediaStopped,t)},onVoiceStarted:function e(){},onVoiceEnded:function e(){},onStateChanged:babelHelpers.classPrivateFieldGet(this,Gn),onInviteTimeout:babelHelpers.classPrivateFieldGet(this,zn)})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"getUserCount",value:function e(){return Object.keys(this.peers).length}},{key:"getClient",value:function e(){var t=this;return new Promise((function(e){e(t)}));return new Promise((function(e,i){BX.Voximplant.getClient({restClient:Gr.getRestClient()}).then((function(i){i.enableSilentLogging();i.setLoggerCallback((function(e){return t.log(e.label+": "+e.message)}));t.log("User agent: "+navigator.userAgent);t.log("Voximplant SDK version: "+VoxImplant.version);t.bindClientEvents();e(i)}))["catch"](i)}))}},{key:"bindClientEvents",value:function e(){return;var t=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){VoxImplant.getInstance().on(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,ps));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().on(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,fs));VoxImplant.getInstance().on(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,gs))}t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,ns));t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,babelHelpers.classPrivateFieldGet(this,ns));t.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,os));this.clientEventsBound=true}}},{key:"removeClientEvents",value:function e(){return;if(!("VoxImplant"in window)){return}VoxImplant.getInstance().off(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,ps));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().off(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,fs));VoxImplant.getInstance().off(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,gs))}var t=VoxImplant.Hardware.StreamManager.get();t.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,ns));t.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,os));this.clientEventsBound=false}},{key:"setMuted",value:function e(t){if(this.muted==t){return}this.muted=t;if(this.BitrixCall){if(this.muted){this.BitrixCall.disableAudio()}else{if(!this.BitrixCall.isAudioPublished()){En(this,Vn,Ps).call(this,z.Microphone,true)}this.BitrixCall.enableAudio()}}}},{key:"isMuted",value:function e(){return this.muted}},{key:"setVideoEnabled",value:function e(t){t=t===true;if(this.videoEnabled==t){return}this.videoEnabled=t;if(this.BitrixCall){if(t){if(!this.BitrixCall.isVideoPublished()){En(this,Vn,Ps).call(this,z.Camera,true)}En(this,Fn,Bs).call(this);this.BitrixCall.enableVideo()}else{if(this.localVideoShown){this.localVideoShown=false;this.BitrixCall.disableVideo();var i=new Ys({kind:"video"});this.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:i,tag:"main",stream:new MediaStream,removed:true})}}}}},{key:"setCameraId",value:function e(t){var i=this;if(this.cameraId==t){return}this.cameraId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,os).call(this,z.Camera);return}if(this.BitrixCall.isVideoPublished()){En(this,Vn,Ps).call(this,z.Camera,true)}this.BitrixCall.switchActiveVideoDevice(this.cameraId).then((function(){if(i.videoEnabled){if(i.BitrixCall.isVideoPublished()){i.BitrixCall.getLocalVideo().then((function(e){var t=new Ys({kind:"video",track:e});i.runCallback(Sr.onLocalMediaReceived,{mediaRenderer:t,tag:"main",stream:t.stream})}))["finally"]((function(){if(i.BitrixCall.isVideoPublished()){En(i,Vn,Ps).call(i,z.Camera,false)}}))}else{En(i,Vn,Ps).call(i,z.Camera,true);En(i,Fn,Bs).call(i);i.BitrixCall.enableVideo()}}else{En(i,Vn,Ps).call(i,z.Camera,false)}}))["catch"]((function(e){i.log(e);console.error(e)}))}}},{key:"setMicrophoneId",value:function e(t){var i=this;if(this.microphoneId==t){return}this.microphoneId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,os).call(this,z.Microphone);return}En(this,Vn,Ps).call(this,z.Microphone,true);this.runCallback(Sr.onUserVoiceStopped,{userId:this.userId,local:true});this.signaling.sendVoiceStopped();this.BitrixCall.switchActiveAudioDevice(this.microphoneId).then((function(){i.BitrixCall.getLocalAudio().then((function(e){babelHelpers.classPrivateFieldGet(i,ps).call(i,{result:true,stream:new MediaStream([e])})}))}))["catch"]((function(e){i.log(e);console.error(e)}))["finally"]((function(){En(i,Vn,Ps).call(i,z.Microphone,false);if(i.muted){i.BitrixCall.disableAudio()}}))}}},{key:"getCurrentMicrophoneId",value:function e(){return this.microphoneId}},{key:"constructCameraParams",value:function e(){var t={};return t;if(this.cameraId){t.cameraId=this.cameraId}t.videoQuality=this.videoHd?VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_HD:VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_nHD;t.facingMode=true;return t}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"setMainStream",value:function e(t){if(t&&t!==this.userId){var i;var n=(i=this.peers[t])===null||i===void 0?void 0:i.participant;var s=n!==null&&n!==void 0&&n.screenSharingEnabled?z.Screen:z.Camera;this.BitrixCall.setMainStream(t,s)}else{this.BitrixCall.resetMainStream()}}},{key:"requestFloor",value:function e(t){this.BitrixCall.raiseHand(t)}},{key:"sendRecordState",value:function e(t){t.senderId=this.userId;if(!En(this,jn,xs).call(this,t)){return}this.runCallback(Sr.onUserRecordState,{userId:this.userId,recordState:this.recordState});this.signaling.sendRecordState(this.userId,this.recordState)}},{key:"sendEmotion",value:function e(t,i){this.signaling.sendEmotion(t,i)}},{key:"sendCustomMessage",value:function e(t,i){this.signaling.sendCustomMessage(t,i)}},{key:"allowVideoFrom",value:function e(t){if(this.videoAllowedFrom==t){return}this.videoAllowedFrom=t;if(t===yr.all){this.signaling.sendShowAll();t=Object.keys(this.peers)}else if(t===yr.none){this.signaling.sendHideAll();t=[]}else if(l.Type.isArray(t)){this.signaling.sendShowUsers(t)}else{throw new Error("userList is in wrong format")}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.peers){if(!this.peers.hasOwnProperty(n)){continue}if(i[n]){this.peers[n].allowIncomingVideo(true)}else{this.peers[n].allowIncomingVideo(false)}}}},{key:"startScreenSharing",value:function e(){if(!this.BitrixCall){return}var t=!this.videoEnabled;var i=this.videoEnabled||this.screenShared;this.waitingLocalScreenShare=true;this.runCallback(Sr.onUserScreenState,{userId:this.userId,screenState:true});this.BitrixCall.startScreenShare()}},{key:"stopScreenSharing",value:function e(){babelHelpers.classPrivateFieldGet(this,os).call(this,z.Screen)}},{key:"isScreenSharingStarted",value:function e(){return this.screenShared||this.waitingLocalScreenShare}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=l.Type.isArray(i.users)?i.users:this.users;this.attachToConference().then((function(){t.signaling.sendPingToUsers({userId:n});if(n.length>0){return t.signaling.inviteUsers({userIds:n,video:t.videoEnabled?"Y":"N"})}})).then((function(){t.state=vr.Connected;t.runCallback(Sr.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=parseInt(n[e]);if(!t.users.includes(i)){t.users.push(i)}if(!t.peers[i]){t.peers[i]=t.createPeer(i);if(t.type===gr.Instant){t.runCallback(Sr.onUserInvited,{userId:i})}}if(t.type===gr.Instant){t.peers[i].onInvited();t.scheduleRepeatInvite()}}}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,ks).call(t,e)}))}},{key:"scheduleRepeatInvite",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout((function(){return t.repeatInviteUsers()}),Nn)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===mr.Calling){i.push(n)}}if(i.length===0){return}var s={userIds:i,video:this.videoEnabled?"Y":"N",isRepeated:"Y"};this.signaling.inviteUsers(s).then((function(){return t.scheduleRepeatInvite()}))}},{key:"answer",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=i.joinAsViewer===true;this.videoEnabled=i.useVideo===true;if(!n){this.signaling.sendAnswer()}this.attachToConference({joinAsViewer:n}).then((function(){t.log("Attached to conference");t.state=vr.Connected;t.runCallback(Sr.onJoin,{local:true})}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,ks).call(t,e)}))}},{key:"decline",value:function e(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}Gr.getRestClient().callMethod(Rn.decline,i)}},{key:"hangup",value:function e(t,i){if(!this.ready){var n=new Error("Hangup in wrong state");this.log(n);return}var s=new Error;s.name="Call stack:";this.log("Hangup received \n"+s.stack);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);var a={};this.ready=false;if(typeof t!="undefined"){a.code=t}if(typeof i!="undefined"){a.reason=i}this.state=vr.Proceeding;this.runCallback(Sr.onLeave,{local:true});a.userId=this.users.filter((function(e){return Number.isInteger(e)})).concat(this.userId);this.signaling.sendHangup(a);this.muted=false;this.reinitPeers();if(this.BitrixCall){this.BitrixCall._replaceVideoSharing=false;try{this.BitrixCall.hangup()}catch(e){this.log("Voximplant hangup error: ",e);console.error("Voximplant hangup error: ",e)}}else{this.log("Tried to hangup, but this.BitrixCall points nowhere");console.error("Tried to hangup, but this.BitrixCall points nowhere")}this.screenShared=false;En(this,On,Hs).call(this)}},{key:"attachToConference",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.joinAsViewer===true;if(this.BitrixCall&&this.BitrixCall.getState()===J.CONNECTED){if(this.joinedAsViewer===n){return Promise.resolve()}else{return Promise.reject("Already joined call in another mode")}}return new Promise((function(e,i){t.direction=n?fr.RecvOnly:fr.SendRecv;t.sendTelemetryEvent("call");t.getClient().then((function(s){t.localUserState=mr.Connecting;t.BitrixCall=new Se(t.userId);if(t.videoEnabled){En(t,Fn,Bs).call(t)}try{}catch(e){console.error(e);return i(e)}t.joinedAsViewer=n;if(!t.BitrixCall){t.log("Error: could not create Bitrix call");return i({code:"VOX_NO_CALL"})}t.runCallback(Dn.onCallConference,{call:t});t.bindCallEvents();t.BitrixCall.on("Connected",(function(){console.log("handleConnected");En(t,Xn,Ds).call(t);e()}));t.BitrixCall.on("Failed",(function(e){En(t,Wn,Ls).call(t,e);i(e)}));t.BitrixCall.connect({roomId:t.id,userData:t.userData[t.userId],endpoint:t.connectionData.endpoint,jwt:t.connectionData.jwt,videoBitrate:1e6,videoSimulcast:true,audioDeviceId:t.microphoneId,videoDeviceId:t.cameraId})}))["catch"](babelHelpers.classPrivateFieldGet(t,ks).bind(t))}))}},{key:"bindCallEvents",value:function e(){this.BitrixCall.on("PublishSucceed",babelHelpers.classPrivateFieldGet(this,ns));this.BitrixCall.on("PublishPaused",babelHelpers.classPrivateFieldGet(this,ss));this.BitrixCall.on("PublishFailed",babelHelpers.classPrivateFieldGet(this,as));this.BitrixCall.on("PublishEnded",babelHelpers.classPrivateFieldGet(this,as));this.BitrixCall.on("GetUserMediaEnded",babelHelpers.classPrivateFieldGet(this,rs));this.BitrixCall.on("RemoteMediaAdded",babelHelpers.classPrivateFieldGet(this,ls));this.BitrixCall.on("RemoteMediaRemoved",babelHelpers.classPrivateFieldGet(this,cs));this.BitrixCall.on("RemoteMediaMuted",babelHelpers.classPrivateFieldGet(this,ds));this.BitrixCall.on("RemoteMediaUnmuted",babelHelpers.classPrivateFieldGet(this,ds));this.BitrixCall.on("ParticipantJoined",babelHelpers.classPrivateFieldGet(this,us));this.BitrixCall.on("ParticipantStateUpdated",(function(){return console.log("handleParticipantStateUpdated")}));this.BitrixCall.on("ParticipantLeaved",babelHelpers.classPrivateFieldGet(this,hs));this.BitrixCall.on("MessageReceived",babelHelpers.classPrivateFieldGet(this,Ts));this.BitrixCall.on("HandRaised",babelHelpers.classPrivateFieldGet(this,Es));this.BitrixCall.on("Reconnecting",babelHelpers.classPrivateFieldGet(this,vs));this.BitrixCall.on("Reconnected",babelHelpers.classPrivateFieldGet(this,ms));this.BitrixCall.on("Disconnected",babelHelpers.classPrivateFieldGet(this,bs));this.BitrixCall.on("CallStatsReceived",babelHelpers.classPrivateFieldGet(this,ws));this.BitrixCall.on("UpdatePacketLoss",babelHelpers.classPrivateFieldGet(this,Is))}},{key:"removeCallEvents",value:function e(){if(this.BitrixCall){this.BitrixCall.on("Failed",BX.DoNothing);this.BitrixCall.on("PublishSucceed",BX.DoNothing);this.BitrixCall.on("PublishFailed",BX.DoNothing);this.BitrixCall.on("PublishEnded",BX.DoNothing);this.BitrixCall.on("GetUserMediaEnded",BX.DoNothing);this.BitrixCall.on("RemoteMediaAdded",BX.DoNothing);this.BitrixCall.on("RemoteMediaRemoved",BX.DoNothing);this.BitrixCall.on("ParticipantJoined",BX.DoNothing);this.BitrixCall.on("ParticipantStateUpdated",BX.DoNothing);this.BitrixCall.on("MessageReceived",BX.DoNothing);this.BitrixCall.on("HandRaised",BX.DoNothing);this.BitrixCall.on("Reconnecting",BX.DoNothing);this.BitrixCall.on("Reconnected",BX.DoNothing);this.BitrixCall.on("Disconnected",BX.DoNothing);this.BitrixCall.on("CallStatsReceived",BX.DoNothing);this.BitrixCall.on("UpdatePacketLoss",BX.DoNothing)}}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Sr.onUserInvited,{userId:n})}}},{key:"addInvitedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId){continue}if(!this.peers[n]){this.peers[n]=this.createPeer(n);this.runCallback(Sr.onUserInvited,{userId:n})}if(this.type===gr.Instant&&this.peers[n].calculatedState!==mr.Calling){this.peers[n].onInvited()}if(!this.users.includes(n)){this.users.push(n)}}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"updateRoom",value:function e(t){if(!this.rooms[t.id]){this.rooms[t.id]={id:t.id,users:t.users,speaker:t.speaker}}else{this.rooms[t.id].users=t.users;this.rooms[t.id].speaker=t.speaker}}},{key:"currentRoom",value:function e(){return this._currentRoomId?this.rooms[this._currentRoomId]:null}},{key:"isRoomSpeaker",value:function e(){return this.currentRoom()?this.currentRoom().speaker==this.userId:false}},{key:"joinRoom",value:function e(t){this.signaling.sendJoinRoom(t)}},{key:"requestRoomSpeaker",value:function e(){this.signaling.sendRequestRoomSpeaker(this._currentRoomId)}},{key:"leaveCurrentRoom",value:function e(){this.signaling.sendLeaveRoom(this._currentRoomId)}},{key:"listRooms",value:function e(){var t=this;return new Promise((function(e){t.signaling.sendListRooms();t.__resolveListRooms=e}))}},{key:"__onPullEvent",value:function e(t,i,n){if(this.pullEventHandlers[t]){if(t!="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}this.pullEventHandlers[t].call(this,i)}}},{key:"__onPullEventAnswerSelf",value:function e(t){if(t.callInstanceId===this.instanceId){return}this.joinedElsewhere=true;this.runCallback(Sr.onJoin,{local:false})}},{key:"sendTelemetryEvent",value:function e(t){Do.sendTelemetryEvent({call_id:this.id,user_id:this.userId,kind:"Bitrix",event:t})}},{key:"destroy",value:function e(){this.ready=false;this.joinedAsViewer=false;En(this,On,Hs).call(this);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);if(this.BitrixCall){this.removeCallEvents();this.BitrixCall.hangup();this.BitrixCall=null}for(var i in this.peers){if(this.peers.hasOwnProperty(i)&&this.peers[i]){this.peers[i].destroy()}}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);window.removeEventListener("unload",babelHelpers.classPrivateFieldGet(this,Cs));return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return br.Bitrix}},{key:"screenShared",get:function e(){return this._screenShared},set:function e(t){if(t!=this._screenShared){this._screenShared=t;this.signaling.sendScreenState(this._screenShared)}}},{key:"localUserState",get:function e(){return this._localUserState},set:function e(t){if(t==this._localUserState){return}this.runCallback(Sr.onUserStateChanged,{userId:this.userId,state:t,previousState:this._localUserState,direction:this.direction});this._localUserState=t}},{key:"reconnectionEventCount",get:function e(){return this._reconnectionEventCount},set:function e(t){if(this._reconnectionEventCount===0&&t>0){this.runCallback(Sr.onReconnecting)}if(t===0){this.runCallback(Sr.onReconnected)}this._reconnectionEventCount=t}}]);return t}(f);function Ps(e,t){if(e===z.Camera){this.runCallback(Sr.onCameraPublishing,{publishing:t})}else if(e===z.Microphone){this.runCallback(Sr.onMicrophonePublishing,{publishing:t})}}function Bs(){var e=this;return new Promise((function(t){e.localVideoShown=true;t()}))}function Hs(){var e=this;return new Promise((function(t){e.localVideoShown=false;t()}))}function Ds(){this.log("Call connected");this.sendTelemetryEvent("connect");this.localUserState=mr.Connected;this.BitrixCall.on("Failed",babelHelpers.classPrivateFieldGet(this,bs));if(this.muted){this.BitrixCall.disableAudio()}else{if(!this.BitrixCall.isAudioPublished()){En(this,Vn,Ps).call(this,z.Microphone,true)}this.BitrixCall.enableAudio()}if(this.videoEnabled){if(!this.BitrixCall.isVideoPublished()){En(this,Vn,Ps).call(this,z.Camera,true)}this.BitrixCall.enableVideo()}if(this.videoAllowedFrom==yr.none){this.signaling.sendHideAll()}else if(l.Type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}}function Ls(e){this.log("Could not attach to conference",e);this.sendTelemetryEvent("connect_failure");this.localUserState=mr.Failed;this.BitrixCall.enableSilentLogging(false);this.BitrixCall.setLoggerCallback(null)}function xs(e){if(e.action!==Rt.RecordState.Started&&this.recordState.userId!=e.senderId){return false}if(e.action===Rt.RecordState.Started){if(this.recordState.state!==Rt.RecordState.Stopped){return false}this.recordState.state=Rt.RecordState.Started;this.recordState.userId=e.senderId;this.recordState.date.start=e.date;this.recordState.date.pause=[]}else if(e.action===Rt.RecordState.Paused){if(this.recordState.state!==Rt.RecordState.Started){return false}this.recordState.state=Rt.RecordState.Paused;this.recordState.date.pause.push({start:e.date,finish:null})}else if(e.action===Rt.RecordState.Resumed){if(this.recordState.state!==Rt.RecordState.Paused){return false}this.recordState.state=Rt.RecordState.Started;var t=this.recordState.date.pause.find((function(e){return e.finish===null}));if(t){t.finish=e.date}}else if(e.action===Rt.RecordState.Stopped){this.recordState.state=Rt.RecordState.Stopped;this.recordState.userId=0;this.recordState.date.start=null;this.recordState.date.pause=[]}return true}function As(e,t){var i=parseInt(e.substring(4));if(this.peers[i]){this.peers[i].setEndpoint(t)}this.wasConnected=true}babelHelpers.defineProperty(Rs,"Event",Dn);var Ns=new WeakSet;var Us=new WeakSet;var Vs=new WeakSet;var Fs=function(){function e(t){babelHelpers.classCallCheck(this,e);_n(this,Vs);_n(this,Us);_n(this,Ns);this.call=t.call}babelHelpers.createClass(e,[{key:"inviteUsers",value:function e(t){return En(this,Vs,Ws).call(this,Rn.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&Gr.getPullClient().isPublishingEnabled()){En(this,Ns,Os).call(this,Pn.answer,t)}else{return En(this,Vs,Ws).call(this,Rn.answer,t)}}},{key:"sendCancel",value:function e(t){return En(this,Vs,Ws).call(this,Rn.cancel,t)}},{key:"sendHangup",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){En(this,Ns,Os).call(this,Pn.hangup,t);t.retransmit=false;En(this,Vs,Ws).call(this,Rn.hangup,t)}else{t.retransmit=true;En(this,Vs,Ws).call(this,Rn.hangup,t)}}},{key:"sendVoiceStarted",value:function e(t){return En(this,Us,Xs).call(this,Bn.voiceStarted,t)}},{key:"sendVoiceStopped",value:function e(t){return En(this,Us,Xs).call(this,Bn.voiceStopped,t)}},{key:"sendCameraState",value:function e(t){return En(this,Us,Xs).call(this,Bn.cameraState,{cameraState:t?"Y":"N"})}},{key:"sendMicrophoneState",value:function e(t){return En(this,Us,Xs).call(this,Bn.microphoneState,{microphoneState:t?"N":"Y"})}},{key:"sendScreenState",value:function e(t){return En(this,Us,Xs).call(this,Bn.screenState,{screenState:t?"Y":"N"})}},{key:"sendRecordState",value:function e(t,i){En(this,Us,Xs).call(this,Bn.recordState,{senderId:t,recordState:i})}},{key:"sendEmotion",value:function e(t,i){return En(this,Us,Xs).call(this,Bn.emotion,{toUserId:t,emotion:i})}},{key:"sendCustomMessage",value:function e(t,i){return En(this,Us,Xs).call(this,Bn.customMessage,{message:t,repeatOnConnect:!!i})}},{key:"sendShowUsers",value:function e(t){return En(this,Us,Xs).call(this,Bn.showUsers,{users:t})}},{key:"sendShowAll",value:function e(){return En(this,Us,Xs).call(this,Bn.showAll,{})}},{key:"sendHideAll",value:function e(){return En(this,Us,Xs).call(this,Bn.hideAll,{})}},{key:"sendPingToUsers",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){En(this,Ns,Os).call(this,Pn.ping,t,0)}}},{key:"sendPingToBackend",value:function e(){En(this,Vs,Ws).call(this,Rn.ping,{retransmit:false})}},{key:"sendUserInviteTimeout",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){En(this,Ns,Os).call(this,Pn.userInviteTimeout,t,0)}}},{key:"sendJoinRoom",value:function e(t){return En(this,Us,Xs).call(this,Bn.joinRoom,{roomId:t})}},{key:"sendLeaveRoom",value:function e(t){return En(this,Us,Xs).call(this,Bn.leaveRoom,{roomId:t})}},{key:"sendListRooms",value:function e(){return En(this,Us,Xs).call(this,Bn.listRooms)}},{key:"sendRequestRoomSpeaker",value:function e(t){return En(this,Us,Xs).call(this,Bn.requestRoomSpeaker,{roomId:t})}}]);return e}();function Os(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!l.Type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Do.getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));Gr.getPullClient().sendMessage(t.userId,"im",e,t,i)}function Xs(e,t){if(!this.call.BitrixCall){return}if(!l.Type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=Do.getUuidv4();t.senderId=this.call.userId;this.call.BitrixCall.sendMessage(JSON.stringify(t))}function Ws(e,t){if(!l.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Do.getUuidv4();return Gr.getRestClient().callMethod(e,t)}var Gs=new WeakMap;var zs=new WeakMap;var js=new WeakMap;var qs=new WeakMap;var Ks=new WeakMap;var Js=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);Mn(this,Gs,{writable:true,value:function e(t,n){var s={mediaRenderer:new Ys({track:n})};i.log("VoxImplant.EndpointEvents.RemoteMediaAdded",s.mediaRenderer);if(s.mediaRenderer.element){s.mediaRenderer.element.volume=0;s.mediaRenderer.element.srcObject=null}i.addMediaRenderer(s.mediaRenderer)}});Mn(this,zs,{writable:true,value:function e(t,n){var s={mediaRenderer:new Ys};console.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, ",s.mediaRenderer);i.removeMediaRenderer(s.mediaRenderer)}});Mn(this,js,{writable:true,value:function e(){i.callbacks.onVoiceStarted()}});Mn(this,qs,{writable:true,value:function e(){i.callbacks.onVoiceEnded()}});Mn(this,Ks,{writable:true,value:function e(t){i.log("VoxImplant.EndpointEvents.Removed",t);if(i.endpoint){i.removeEndpointEventHandlers();i.endpoint=null}if(i.stream){i.stream=null}if(i.ready){i.waitForConnectionRestore()}i.updateCalculatedState()}});this.userId=t.userId;this.call=t.call;this.ready=!!t.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.direction=t.direction||fr.SendRecv;this.stream=null;this.mediaRenderers=[];this.isIncomingVideoAllowed=t.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:l.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:l.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:l.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaRemoved:l.Type.isFunction(t.onMediaRemoved)?t.onMediaRemoved:BX.DoNothing,onVoiceStarted:l.Type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,onVoiceEnded:l.Type.isFunction(t.onVoiceEnded)?t.onVoiceEnded:BX.DoNothing};this.calculatedState=this.calculateState()}babelHelpers.createClass(e,[{key:"setReady",value:function e(t){t=!!t;if(this.ready==t){return}this.ready=t;this.readyStack=(new Error).stack;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()}},{key:"setDirection",value:function e(t){if(this.direction==t){return}this.direction=t}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setEndpoint",value:function e(t){this.log("Adding endpoint with "+t.mediaRenderers.length+" media renderers");this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=t;for(var i=0;i<this.endpoint.mediaRenderers.length;i++){this.addMediaRenderer(this.endpoint.mediaRenderers[i]);if(this.endpoint.mediaRenderers[i].element);}this.bindEndpointEventHandlers()}},{key:"allowIncomingVideo",value:function e(t){if(this.isIncomingVideoAllowed==t){return}this.isIncomingVideoAllowed=!!t}},{key:"addMediaRenderer",value:function e(t){this.log("Adding media renderer for user"+this.userId,t);this.mediaRenderers.push(t);this.callbacks.onMediaReceived({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user"+this.userId,t);var i;this.mediaRenderers.forEach((function(e,n){if(e.kind===t.kind){i=n}}));if(i>=0){this.mediaRenderers.splice(i,1)}this.callbacks.onMediaRemoved({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"bindEndpointEventHandlers",value:function e(){return;this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,Gs));this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,zs));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,js));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,qs));this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,Ks))}},{key:"removeEndpointEventHandlers",value:function e(){return;this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,Gs));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,zs));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,js));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,qs));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,Ks))}},{key:"calculateState",value:function e(){if(this.endpoint||this.participant){return mr.Connected}if(this.calling){return mr.Calling}if(this.inviteTimeout){return mr.Unavailable}if(this.declined){return mr.Declined}if(this.busy){return mr.Busy}if(this.ready){return mr.Ready}return mr.Idle}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,direction:this.direction});this.calculatedState=t}}},{key:"isParticipating",value:function e(){return(this.calling||this.ready||this.endpoint)&&!this.declined}},{key:"waitForConnectionRestore",value:function e(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),Un)}},{key:"onInvited",value:function e(){var t=this;this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((function(){return t.onInviteTimeout(true)}),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"onConnectionRestoreTimeout",value:function e(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){if(this.stream){Do.stopMediaStream(this.stream);this.stream=null}if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onInviteTimeout=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaRemoved=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null}}]);return e}();var Ys=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"element",null);t=t||{};this.kind=t.kind||"video";if(t.track){this.stream=new MediaStream([t.track])}else{this.stream=new MediaStream}}babelHelpers.createClass(e,[{key:"render",value:function e(t){if(!t.srcObject||!t.srcObject.active||t.srcObject.id!==this.stream.id){t.srcObject=this.stream}}},{key:"requestVideoSize",value:function e(){}}]);return e}();function Qs(e,t,i){$s(e,t);t.set(e,i)}function Zs(e,t){$s(e,t);t.add(e)}function $s(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function ea(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ta={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var ia={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};var na={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",recordState:"Call::recordState",floorRequest:"Call::floorRequest",emotion:"Call::emotion",customMessage:"Call::customMessage",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll",joinRoom:"Call::joinRoom",leaveRoom:"Call::leaveRoom",listRooms:"Call::listRooms",requestRoomSpeaker:"Call::requestRoomSpeaker"};var sa={viewerJoined:"Call::viewerJoined",viewerLeft:"Call::viewerLeft",joinRoomOffer:"Call::joinRoomOffer",transferRoomHost:"Call::transferRoomHost",listRoomsResponse:"Call::listRoomsResponse",roomUpdated:"Call::roomUpdated"};var aa={onCallConference:"VoximplantCall::onCallConference"};var ra=5e3;var oa=25e3;var la=5500;var ca=15e3;var da=new WeakSet;var ua=new WeakSet;var ha=new WeakSet;var pa=new WeakSet;var va=new WeakMap;var ma=new WeakMap;var fa=new WeakMap;var ga=new WeakMap;var ba=new WeakMap;var Ca=new WeakMap;var ka=new WeakMap;var ya=new WeakMap;var Sa=new WeakMap;var wa=new WeakMap;var Ia=new WeakMap;var Ma=new WeakMap;var _a=new WeakMap;var Ta=new WeakMap;var Ea=new WeakMap;var Ra=new WeakMap;var Pa=new WeakMap;var Ba=new WeakMap;var Ha=new WeakMap;var Da=new WeakMap;var La=new WeakMap;var xa=new WeakMap;var Aa=new WeakSet;var Na=new WeakMap;var Ua=new WeakMap;var Va=new WeakMap;var Fa=new WeakMap;var Oa=new WeakMap;var Xa=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));Zs(babelHelpers.assertThisInitialized(i),Aa);Zs(babelHelpers.assertThisInitialized(i),pa);Zs(babelHelpers.assertThisInitialized(i),ha);Zs(babelHelpers.assertThisInitialized(i),ua);Zs(babelHelpers.assertThisInitialized(i),da);Qs(babelHelpers.assertThisInitialized(i),va,{writable:true,value:function e(t){i.runCallback(Sr.onUserStateChanged,t);if(!i.ready){return}if(t.state==mr.Failed||t.state==mr.Unavailable||t.state==mr.Declined||t.state==mr.Idle){if(i.type==gr.Instant&&!i.isAnyoneParticipating()){i.hangup()}}}});Qs(babelHelpers.assertThisInitialized(i),ma,{writable:true,value:function e(t){if(!i.ready){return}i.signaling.sendUserInviteTimeout({userId:i.users,failedUserId:t.userId})}});Qs(babelHelpers.assertThisInitialized(i),fa,{writable:true,value:function e(t){var n=Number(t.senderId);if(n==i.userId){return i.__onPullEventAnswerSelf(t)}if(!i.peers[n]){i.peers[n]=i.createPeer(n);i.runCallback(Sr.onUserInvited,{userId:n})}if(!i.users.includes(n)){i.users.push(n)}i.peers[n].setReady(true)}});Qs(babelHelpers.assertThisInitialized(i),ga,{writable:true,value:function e(t){var n=t.senderId;if(i.userId==n&&i.instanceId!=t.callInstanceId){i.runCallback(Sr.onLeave,{local:false});return}if(!i.peers[n]){return}i.peers[n].setReady(false);if(t.code==603){i.peers[n].setDeclined(true)}else if(t.code==486){i.peers[n].setBusy(true);console.error("user "+n+" is busy")}if(i.ready&&i.type==gr.Instant&&!i.isAnyoneParticipating()){i.hangup()}}});Qs(babelHelpers.assertThisInitialized(i),ba,{writable:true,value:function e(t){i.log("__onPullEventUsersJoined",t);var n=t.users;i.addJoinedUsers(n)}});Qs(babelHelpers.assertThisInitialized(i),Ca,{writable:true,value:function e(t){i.log("__onPullEventUsersInvited",t);var n=t.users;if(i.type===gr.Instant){i.addInvitedUsers(n)}}});Qs(babelHelpers.assertThisInitialized(i),ka,{writable:true,value:function e(t){i.log("__onPullEventUserInviteTimeout",t);var n=t.failedUserId;if(i.peers[n]){i.peers[n].onInviteTimeout(false)}}});Qs(babelHelpers.assertThisInitialized(i),ya,{writable:true,value:function e(t){if(t.callInstanceId==i.instanceId){return}var n=Number(t.senderId);if(n==i.userId){if(!i.joinedElsewhere){i.runCallback(Sr.onJoin,{local:false});i.joinedElsewhere=true}clearTimeout(i.lastSelfPingReceivedTimeout);i.lastSelfPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),wa),ra*2.1)}clearTimeout(i.lastPingReceivedTimeout);i.lastPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Sa),ra*2.1);if(i.peers[n]){i.peers[n].setReady(true)}}});Qs(babelHelpers.assertThisInitialized(i),Sa,{writable:true,value:function e(){if(!i.ready){i.destroy()}}});Qs(babelHelpers.assertThisInitialized(i),wa,{writable:true,value:function e(){i.runCallback(Sr.onLeave,{local:false});i.joinedElsewhere=false}});Qs(babelHelpers.assertThisInitialized(i),Ia,{writable:true,value:function e(){i.destroy()}});Qs(babelHelpers.assertThisInitialized(i),Ma,{writable:true,value:function e(){if(i.ready){i.signaling.sendAnswer({userId:i.userId},true)}}});Qs(babelHelpers.assertThisInitialized(i),_a,{writable:true,value:function e(t){var n=t.renderer;var s=n.stream.getVideoTracks().length>0?n.stream.getVideoTracks()[0].label:"";i.log("__onLocalMediaRendererAdded",n.kind,s);if(n.kind==="video"){var a;if(s.match(/^screen|window|tab|web-contents-media-stream/i)){a="screen"}else{a="main"}i.screenShared=a==="screen";i.runCallback(Sr.onLocalMediaReceived,{tag:a,stream:n.stream})}else if(n.kind==="sharing"){i.runCallback(Sr.onLocalMediaReceived,{tag:"screen",stream:n.stream});i.screenShared=true}}});Qs(babelHelpers.assertThisInitialized(i),Ta,{writable:true,value:function e(t){var n=t.renderer;i.log("__onBeforeLocalMediaRendererRemoved",n.kind);if(n.kind==="sharing"&&!i.videoEnabled){i.runCallback(Sr.onLocalMediaReceived,{tag:"main",stream:new MediaStream});i.screenShared=false}}});Qs(babelHelpers.assertThisInitialized(i),Ea,{writable:true,value:function e(t){if(t.result){if(t.stream.getAudioTracks().length>0){if(i.localVAD){i.localVAD.destroy()}i.localVAD=new Dt({mediaStream:t.stream,onVoiceStarted:function e(){i.runCallback(Sr.onUserVoiceStarted,{userId:i.userId,local:true})},onVoiceStopped:function e(){i.runCallback(Sr.onUserVoiceStopped,{userId:i.userId,local:true})}});clearInterval(i.microphoneLevelInterval);i.microphoneLevelInterval=setInterval((function(){return i.microphoneLevel=i.localVAD.currentVolume}),200)}}}});Qs(babelHelpers.assertThisInitialized(i),Ra,{writable:true,value:function e(){i.reconnectionEventCount++}});Qs(babelHelpers.assertThisInitialized(i),Pa,{writable:true,value:function e(){i.reconnectionEventCount--}});Qs(babelHelpers.assertThisInitialized(i),Ba,{writable:true,value:function e(){i.reconnectionEventCount++}});Qs(babelHelpers.assertThisInitialized(i),Ha,{writable:true,value:function e(){i.reconnectionEventCount--}});Qs(babelHelpers.assertThisInitialized(i),Da,{writable:true,value:function e(t){i.log("__onCallDisconnected",t&&t.headers?{headers:t.headers}:null);i.sendTelemetryEvent("disconnect");i.localUserState=mr.Idle;i.ready=false;i.muted=false;i.joinedAsViewer=false;i.reinitPeers();ea(babelHelpers.assertThisInitialized(i),ua,Ga).call(babelHelpers.assertThisInitialized(i));i.removeCallEvents();i.voximplantCall=null;var n=VoxImplant.getInstance();n.enableSilentLogging(false);n.setLoggerCallback(null);i.state=vr.Proceeding;i.runCallback(Sr.onLeave,{local:true})}});Qs(babelHelpers.assertThisInitialized(i),La,{writable:true,value:function e(){if(i.ready&&i.voximplantCall){i.signaling.sendHangup({userId:i.users})}}});Qs(babelHelpers.assertThisInitialized(i),xa,{writable:true,value:function e(t){if(t&&t.call){delete t.call}i.log("onFatalError",t);i.ready=false;i.muted=false;i.localUserState=mr.Failed;i.reinitPeers();ea(babelHelpers.assertThisInitialized(i),ua,Ga).call(babelHelpers.assertThisInitialized(i)).then((function(){if(i.voximplantCall){i.removeCallEvents();try{i.voximplantCall.hangup({"X-Reason":"Fatal error","X-Error":typeof t==="string"?t:t.code||t.name})}catch(e){i.log("Voximplant hangup error: ",e);console.error("Voximplant hangup error: ",e)}i.voximplantCall=null}if(typeof VoxImplant!=="undefined"){var e=VoxImplant.getInstance();e.enableSilentLogging(false);e.setLoggerCallback(null)}if(typeof t==="string"){i.runCallback(Sr.onCallFailure,{name:t})}else if(t.name){i.runCallback(Sr.onCallFailure,t)}}))}});Qs(babelHelpers.assertThisInitialized(i),Na,{writable:true,value:function e(t){var n=t.endpoint;var s=n.userName;i.log("__onCallEndpointAdded ("+s+")",t.endpoint);console.log("__onCallEndpointAdded ("+s+")",t.endpoint);if(l.Type.isStringFilled(s)&&s.startsWith("user")){ea(babelHelpers.assertThisInitialized(i),Aa,qa).call(babelHelpers.assertThisInitialized(i),s,n)}else{n.addEventListener(VoxImplant.EndpointEvents.InfoUpdated,(function(e){var t=e.endpoint;var n=t.userName;i.log("VoxImplant.EndpointEvents.InfoUpdated ("+n+")",e.endpoint);if(l.Type.isStringFilled(n)&&n.startsWith("user")){ea(babelHelpers.assertThisInitialized(i),Aa,qa).call(babelHelpers.assertThisInitialized(i),n,t)}}));i.log("Unknown endpoint "+s);console.warn("Unknown endpoint "+s)}}});Qs(babelHelpers.assertThisInitialized(i),Ua,{writable:true,value:function e(t){if(i.logger){i.logger.sendStat(cr(t.stats,i.voximplantCall))}}});Qs(babelHelpers.assertThisInitialized(i),Va,{writable:true,value:function e(t){console.warn("__onJoinRoomOffer",t);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});i.runCallback(Sr.onJoinRoomOffer,{roomId:t.roomId,users:t.users,initiator:t.initiator,speaker:t.speaker})}});Qs(babelHelpers.assertThisInitialized(i),Fa,{writable:true,value:function e(t){var n=t.roomId===i._currentRoomId&&i.rooms[t.roomId]&&i.rooms[t.roomId].speaker!=t.speaker;var s=n&&i.rooms[t.roomId].speaker;console.log("__onRoomUpdated; speakerChanged: ",n);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});if(t.roomId===i._currentRoomId&&t.users.indexOf(i.userId)===-1){i._currentRoomId=null;i.runCallback(Sr.onLeaveRoom,{roomId:t.roomId})}else if(t.roomId!==i._currentRoomId&&t.users.indexOf(i.userId)!==-1){i._currentRoomId=t.roomId;i.runCallback(Sr.onJoinRoom,{roomId:t.roomId,speaker:i.currentRoom().speaker,users:i.currentRoom().users})}else if(n){i.runCallback(Sr.onTransferRoomSpeaker,{roomId:t.roomId,speaker:t.speaker,previousSpeaker:s,initiator:t.initiator})}}});Qs(babelHelpers.assertThisInitialized(i),Oa,{writable:true,value:function e(t){var n;var s;try{n=JSON.parse(t.text)}catch(e){i.log("Could not parse scenario message.",e);return}var a=n.eventName;if(a===na.voiceStarted){i.runCallback(Sr.onUserVoiceStarted,{userId:n.senderId})}else if(a===na.voiceStopped){i.runCallback(Sr.onUserVoiceStopped,{userId:n.senderId})}else if(a===na.microphoneState){i.runCallback(Sr.onUserMicrophoneState,{userId:n.senderId,microphoneState:n.microphoneState==="Y"})}else if(a===na.cameraState){i.runCallback(Sr.onUserCameraState,{userId:n.senderId,cameraState:n.cameraState==="Y"})}else if(a===na.videoPaused){i.runCallback(Sr.onUserVideoPaused,{userId:n.senderId,videoPaused:n.videoPaused==="Y"})}else if(a===na.screenState){i.runCallback(Sr.onUserScreenState,{userId:n.senderId,screenState:n.screenState==="Y"})}else if(a===na.recordState){i.runCallback(Sr.onUserRecordState,{userId:n.senderId,recordState:n.recordState})}else if(a===na.floorRequest){i.runCallback(Sr.onUserFloorRequest,{userId:n.senderId,requestActive:n.requestActive==="Y"})}else if(a===na.emotion){i.runCallback(Sr.onUserEmotion,{userId:n.senderId,toUserId:n.toUserId,emotion:n.emotion})}else if(a===na.customMessage){i.runCallback(Sr.onCustomMessage,{message:n.message})}else if(a==="scenarioLogUrl"){console.warn("scenario log url: "+n.logUrl)}else if(a===sa.joinRoomOffer){console.log(n);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Va).call(babelHelpers.assertThisInitialized(i),n)}else if(a===sa.roomUpdated){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Fa).call(babelHelpers.assertThisInitialized(i),n)}else if(a===sa.listRoomsResponse){if(i.__resolveListRooms){i.__resolveListRooms(n.rooms);delete i.__resolveListRooms}}else if(a===sa.viewerJoined){console.log("viewer "+n.senderId+" joined");s=i.peers[n.senderId];if(s){s.setDirection(fr.RecvOnly);s.setReady(true)}}else if(a===sa.viewerLeft){console.log("viewer "+n.senderId+" left");s=i.peers[n.senderId];if(s){s.setReady(false)}}else{i.log("Unknown scenario event "+a)}}});i.videoQuality=kr.VeryHigh;i.voximplantCall=null;i.signaling=new Qa({call:babelHelpers.assertThisInitialized(i)});i.peers={};i.joinedElsewhere=false;i.joinedAsViewer=false;i.localVideoShown=false;i._localUserState=mr.Idle;i.clientEventsBound=false;i._screenShared=false;i.videoAllowedFrom=yr.all;i.direction=fr.SendRecv;i.microphoneLevelInterval=null;i.rooms={};window.addEventListener("unload",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),La));i.initPeers();i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),ra);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),oa);i.lastPingReceivedTimeout=null;i.lastSelfPingReceivedTimeout=null;i.reinviteTimeout=null;i._reconnectionEventCount=0;i.pullEventHandlers={"Call::answer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),fa),"Call::hangup":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ga),"Call::usersJoined":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ba),"Call::usersInvited":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ca),"Call::userInviteTimeout":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ka),"Call::ping":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ya),"Call::finish":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ia),"Call::repeatAnswer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ma)};return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(){var t=this;this.users.forEach((function(e){e=Number(e);t.peers[e]=t.createPeer(e)}))}},{key:"reinitPeers",value:function e(){for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t]){this.peers[t].destroy();this.peers[t]=null}}this.initPeers()}},{key:"pingUsers",value:function e(){if(this.ready){var t=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:t},true)}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"createPeer",value:function e(t){var i=this;var n;if(this.videoAllowedFrom===yr.all){n=true}else if(this.videoAllowedFrom===yr.none){n=false}else if(l.Type.isArray(this.videoAllowedFrom)){n=this.videoAllowedFrom.some((function(e){return e==t}))}else{n=true}return new lr({call:this,userId:t,ready:t==this.initiatorId,isIncomingVideoAllowed:n,onMediaReceived:function e(n){i.runCallback(Sr.onRemoteMediaReceived,n);if(n.kind==="video"){i.runCallback(Sr.onUserVideoPaused,{userId:t,videoPaused:false})}},onMediaRemoved:function e(t){i.runCallback(Sr.onRemoteMediaStopped,t)},onMediaRenderEnabled:function e(t){var n=t.endpoint;var s=n.userName;var a=parseInt(s.substring(4));if(i.peers[a]){i.runCallback(Sr.onBadNetworkIndicator,{userId:a,badNetworkIndicator:false})}},onMediaRenderDisabled:function e(t){var n=t.endpoint;var s=n.userName;if(l.Type.isStringFilled(s)&&s.startsWith("user")){var a=parseInt(s.substring(4));if(i.peers[a]&&t.reason==="disabledByServer"){i.runCallback(Sr.onBadNetworkIndicator,{userId:a,badNetworkIndicator:true})}}},onVoiceStarted:function e(){},onVoiceEnded:function e(){},onStateChanged:babelHelpers.classPrivateFieldGet(this,va),onInviteTimeout:babelHelpers.classPrivateFieldGet(this,ma)})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"getUserCount",value:function e(){return Object.keys(this.peers).length}},{key:"getClient",value:function e(){var t=this;return new Promise((function(e,i){BX.Voximplant.getClient({restClient:Gr.getRestClient()}).then((function(i){i.enableSilentLogging();i.setLoggerCallback((function(e){return t.log(e.label+": "+e.message)}));t.log("User agent: "+navigator.userAgent);t.log("Voximplant SDK version: "+VoxImplant.version);t.bindClientEvents();e(i)}))["catch"](i)}))}},{key:"bindClientEvents",value:function e(){var t=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){VoxImplant.getInstance().on(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,Ea));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().on(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ba));VoxImplant.getInstance().on(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,Ha))}t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,_a));t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,babelHelpers.classPrivateFieldGet(this,_a));t.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,Ta));this.clientEventsBound=true}}},{key:"removeClientEvents",value:function e(){if(!("VoxImplant"in window)){return}VoxImplant.getInstance().off(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,Ea));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().off(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ba));VoxImplant.getInstance().off(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,Ha))}var t=VoxImplant.Hardware.StreamManager.get();t.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,_a));t.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,Ta));this.clientEventsBound=false}},{key:"setMuted",value:function e(t){if(this.muted==t){return}this.muted=t;if(this.voximplantCall){if(this.muted){this.voximplantCall.muteMicrophone()}else{this.voximplantCall.unmuteMicrophone()}this.signaling.sendMicrophoneState(!this.muted)}}},{key:"isMuted",value:function e(){return this.muted}},{key:"setVideoEnabled",value:function e(t){var i=this;t=t===true;if(this.videoEnabled==t){return}this.videoEnabled=t;if(this.voximplantCall){if(t){ea(this,da,Wa).call(this)}else{if(this.localVideoShown){VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then((function(){i.localVideoShown=false;i.runCallback(Sr.onLocalMediaReceived,{tag:"main",stream:new MediaStream})}))}}this.voximplantCall.sendVideo(this.videoEnabled);this.signaling.sendCameraState(this.videoEnabled)}}},{key:"setCameraId",value:function e(t){var i=this;if(this.cameraId==t){return}this.cameraId=t;if(this.voximplantCall){VoxImplant.Hardware.CameraManager.get().getInputDevices().then((function(){VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(i.voximplantCall,i.constructCameraParams())}))}}},{key:"setMicrophoneId",value:function e(t){var i=this;if(this.microphoneId==t){return}this.microphoneId=t;if(this.voximplantCall){VoxImplant.Hardware.AudioDeviceManager.get().getInputDevices().then((function(){VoxImplant.Hardware.AudioDeviceManager.get().setCallAudioSettings(i.voximplantCall,{inputId:i.microphoneId})}))}}},{key:"getCurrentMicrophoneId",value:function e(){if(this.voximplantCall.peerConnection.impl.getTransceivers){var t=this.voximplantCall.peerConnection.impl.getTransceivers();if(t.length>0){var i=t[0].sender.track;var n=i.getSettings();return n.deviceId}}return this.microphoneId}},{key:"constructCameraParams",value:function e(){var t={};if(this.cameraId){t.cameraId=this.cameraId}t.videoQuality=this.videoHd?VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_HD:VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_nHD;t.facingMode=true;return t}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"requestFloor",value:function e(t){this.signaling.sendFloorRequest(t)}},{key:"sendRecordState",value:function e(t){this.signaling.sendRecordState(t)}},{key:"sendEmotion",value:function e(t,i){this.signaling.sendEmotion(t,i)}},{key:"sendCustomMessage",value:function e(t,i){this.signaling.sendCustomMessage(t,i)}},{key:"allowVideoFrom",value:function e(t){if(this.videoAllowedFrom==t){return}this.videoAllowedFrom=t;if(t===yr.all){this.signaling.sendShowAll();t=Object.keys(this.peers)}else if(t===yr.none){this.signaling.sendHideAll();t=[]}else if(l.Type.isArray(t)){this.signaling.sendShowUsers(t)}else{throw new Error("userList is in wrong format")}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.peers){if(!this.peers.hasOwnProperty(n)){continue}if(i[n]){this.peers[n].allowIncomingVideo(true)}else{this.peers[n].allowIncomingVideo(false)}}}},{key:"startScreenSharing",value:function e(){var t=this;if(!this.voximplantCall){return}var i=!this.videoEnabled;var n=this.videoEnabled||this.screenShared;this.voximplantCall.shareScreen(i,n).then((function(){t.log("Screen shared");t.screenShared=true}))["catch"]((function(e){console.error(e);t.log("Screen sharing error:",e)}))}},{key:"stopScreenSharing",value:function e(){var t=this;if(!this.voximplantCall){return}this.voximplantCall.stopSharingScreen().then((function(){t.log("Screen is no longer shared");t.screenShared=false}))}},{key:"isScreenSharingStarted",value:function e(){return this.screenShared}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=l.Type.isArray(i.users)?i.users:this.users;this.attachToConference().then((function(){t.signaling.sendPingToUsers({userId:n});if(n.length>0){return t.signaling.inviteUsers({userIds:n,video:t.videoEnabled?"Y":"N"})}})).then((function(){t.state=vr.Connected;t.runCallback(Sr.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=parseInt(n[e]);if(!t.users.includes(i)){t.users.push(i)}if(!t.peers[i]){t.peers[i]=t.createPeer(i);if(t.type===gr.Instant){t.runCallback(Sr.onUserInvited,{userId:i})}}if(t.type===gr.Instant){t.peers[i].onInvited();t.scheduleRepeatInvite()}}}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,xa).call(t,e)}))}},{key:"scheduleRepeatInvite",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout((function(){return t.repeatInviteUsers()}),la)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===mr.Calling){i.push(n)}}if(i.length===0){return}var s={userIds:i,video:this.videoEnabled?"Y":"N",isRepeated:"Y"};this.signaling.inviteUsers(s).then((function(){return t.scheduleRepeatInvite()}))}},{key:"answer",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=i.joinAsViewer===true;this.videoEnabled=i.useVideo===true;if(!n){this.signaling.sendAnswer()}this.attachToConference({joinAsViewer:n}).then((function(){t.log("Attached to conference");t.state=vr.Connected;t.runCallback(Sr.onJoin,{local:true})}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,xa).call(t,e)}))}},{key:"decline",value:function e(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}Gr.getRestClient().callMethod(ta.decline,i)}},{key:"hangup",value:function e(t,i){if(!this.ready){var n=new Error("Hangup in wrong state");this.log(n);return}var s=new Error;s.name="Call stack:";this.log("Hangup received \n"+s.stack);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);var a={};this.ready=false;if(typeof t!="undefined"){a.code=t}if(typeof i!="undefined"){a.reason=i}this.state=vr.Proceeding;this.runCallback(Sr.onLeave,{local:true});a.userId=this.users.slice(0).concat(this.userId);this.signaling.sendHangup(a);this.muted=false;this.reinitPeers();if(this.voximplantCall){this.voximplantCall._replaceVideoSharing=false;try{this.voximplantCall.hangup()}catch(e){this.log("Voximplant hangup error: ",e);console.error("Voximplant hangup error: ",e)}}else{this.log("Tried to hangup, but this.voximplantCall points nowhere");console.error("Tried to hangup, but this.voximplantCall points nowhere")}this.screenShared=false;ea(this,ua,Ga).call(this)}},{key:"attachToConference",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.joinAsViewer===true;if(this.voximplantCall&&this.voximplantCall.state()==="CONNECTED"){if(this.joinedAsViewer===n){return Promise.resolve()}else{return Promise.reject("Already joined call in another mode")}}return new Promise((function(e,i){t.direction=n?fr.RecvOnly:fr.SendRecv;t.sendTelemetryEvent("call");t.getClient().then((function(s){t.localUserState=mr.Connecting;VoxImplant.Hardware.CameraManager.get().setDefaultVideoSettings(t.constructCameraParams());if(t.microphoneId){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({inputId:t.microphoneId})}if(t.videoEnabled){ea(t,da,Wa).call(t)}try{if(n){t.voximplantCall=s.joinAsViewer("bx_conf_"+t.id,{"X-Direction":fr.RecvOnly})}else{t.voximplantCall=s.callConference({number:"bx_conf_"+t.id,video:{sendVideo:t.videoEnabled,receiveVideo:true},customData:JSON.stringify({cameraState:t.videoEnabled})})}}catch(e){console.error(e);return i(e)}t.joinedAsViewer=n;if(!t.voximplantCall){t.log("Error: could not create voximplant call");return i({code:"VOX_NO_CALL"})}t.runCallback(aa.onCallConference,{call:t});t.bindCallEvents();t.voximplantCall.on(VoxImplant.CallEvents.Connected,(function(){ea(t,ha,za).call(t);e()}),{once:true});t.voximplantCall.on(VoxImplant.CallEvents.Failed,(function(e){ea(t,pa,ja).call(t,e);i(e)}),{once:true})}))["catch"](babelHelpers.classPrivateFieldGet(t,xa).bind(t))}))}},{key:"bindCallEvents",value:function e(){this.voximplantCall.on(VoxImplant.CallEvents.Disconnected,babelHelpers.classPrivateFieldGet(this,Da));this.voximplantCall.on(VoxImplant.CallEvents.MessageReceived,babelHelpers.classPrivateFieldGet(this,Oa));if(Do.shouldCollectStats()){this.voximplantCall.on(VoxImplant.CallEvents.CallStatsReceived,babelHelpers.classPrivateFieldGet(this,Ua))}this.voximplantCall.on(VoxImplant.CallEvents.EndpointAdded,babelHelpers.classPrivateFieldGet(this,Na));if(VoxImplant.CallEvents.Reconnecting){this.voximplantCall.on(VoxImplant.CallEvents.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ra));this.voximplantCall.on(VoxImplant.CallEvents.Reconnected,babelHelpers.classPrivateFieldGet(this,Pa))}}},{key:"removeCallEvents",value:function e(){if(this.voximplantCall){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Disconnected,babelHelpers.classPrivateFieldGet(this,Da));this.voximplantCall.removeEventListener(VoxImplant.CallEvents.MessageReceived,babelHelpers.classPrivateFieldGet(this,Oa));if(Do.shouldCollectStats()){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.CallStatsReceived,babelHelpers.classPrivateFieldGet(this,Ua))}this.voximplantCall.removeEventListener(VoxImplant.CallEvents.EndpointAdded,babelHelpers.classPrivateFieldGet(this,Na));if(VoxImplant.CallEvents.Reconnecting){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ra));this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Reconnected,babelHelpers.classPrivateFieldGet(this,Pa))}}}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Sr.onUserInvited,{userId:n})}}},{key:"addInvitedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId){continue}if(this.peers[n]){if(this.peers[n].calculatedState===mr.Failed||this.peers[n].calculatedState===mr.Idle){if(this.type===gr.Instant){this.peers[n].onInvited()}}}else{this.peers[n]=this.createPeer(n);if(this.type===gr.Instant){this.peers[n].onInvited()}}if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Sr.onUserInvited,{userId:n})}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"updateRoom",value:function e(t){if(!this.rooms[t.id]){this.rooms[t.id]={id:t.id,users:t.users,speaker:t.speaker}}else{this.rooms[t.id].users=t.users;this.rooms[t.id].speaker=t.speaker}}},{key:"currentRoom",value:function e(){return this._currentRoomId?this.rooms[this._currentRoomId]:null}},{key:"isRoomSpeaker",value:function e(){return this.currentRoom()?this.currentRoom().speaker==this.userId:false}},{key:"joinRoom",value:function e(t){this.signaling.sendJoinRoom(t)}},{key:"requestRoomSpeaker",value:function e(){this.signaling.sendRequestRoomSpeaker(this._currentRoomId)}},{key:"leaveCurrentRoom",value:function e(){this.signaling.sendLeaveRoom(this._currentRoomId)}},{key:"listRooms",value:function e(){var t=this;return new Promise((function(e){t.signaling.sendListRooms();t.__resolveListRooms=e}))}},{key:"__onPullEvent",value:function e(t,i,n){if(this.pullEventHandlers[t]){if(t!="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}this.pullEventHandlers[t].call(this,i)}}},{key:"__onPullEventAnswerSelf",value:function e(t){if(t.callInstanceId===this.instanceId){return}this.joinedElsewhere=true;this.runCallback(Sr.onJoin,{local:false})}},{key:"sendTelemetryEvent",value:function e(t){Do.sendTelemetryEvent({call_id:this.id,user_id:this.userId,kind:"voximplant",event:t})}},{key:"destroy",value:function e(){this.ready=false;this.joinedAsViewer=false;ea(this,ua,Ga).call(this);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);if(this.voximplantCall){this.removeCallEvents();if(this.voximplantCall.state()!="ENDED"){this.voximplantCall.hangup()}this.voximplantCall=null}for(var i in this.peers){if(this.peers.hasOwnProperty(i)&&this.peers[i]){this.peers[i].destroy()}}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);window.removeEventListener("unload",babelHelpers.classPrivateFieldGet(this,La));return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return br.Voximplant}},{key:"screenShared",get:function e(){return this._screenShared},set:function e(t){if(t!=this._screenShared){this._screenShared=t;this.signaling.sendScreenState(this._screenShared)}}},{key:"localUserState",get:function e(){return this._localUserState},set:function e(t){if(t==this._localUserState){return}this.runCallback(Sr.onUserStateChanged,{userId:this.userId,state:t,previousState:this._localUserState,direction:this.direction});this._localUserState=t}},{key:"reconnectionEventCount",get:function e(){return this._reconnectionEventCount},set:function e(t){if(this._reconnectionEventCount===0&&t>0){this.runCallback(Sr.onReconnecting)}if(t===0){this.runCallback(Sr.onReconnected)}this._reconnectionEventCount=t}}]);return t}(f);function Wa(){var e=this;return new Promise((function(t){VoxImplant.Hardware.StreamManager.get().showLocalVideo(false).then((function(){e.localVideoShown=true;t()}),(function(){e.localVideoShown=true;t()}))}))}function Ga(){var e=this;return new Promise((function(t){if(!("VoxImplant"in window)){t();return}VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then((function(){e.localVideoShown=false;t()}),(function(){e.localVideoShown=false;t()}))}))}function za(){this.log("Call connected");this.sendTelemetryEvent("connect");this.localUserState=mr.Connected;this.voximplantCall.on(VoxImplant.CallEvents.Failed,babelHelpers.classPrivateFieldGet(this,Da));if(this.muted){this.voximplantCall.muteMicrophone()}this.signaling.sendMicrophoneState(!this.muted);this.signaling.sendCameraState(this.videoEnabled);if(this.videoAllowedFrom==yr.none){this.signaling.sendHideAll()}else if(l.Type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}}function ja(e){this.log("Could not attach to conference",e);this.sendTelemetryEvent("connect_failure");this.localUserState=mr.Failed;var t=VoxImplant.getInstance();t.enableSilentLogging(false);t.setLoggerCallback(null)}function qa(e,t){var i=parseInt(e.substring(4));if(this.peers[i]){this.peers[i].setEndpoint(t)}this.wasConnected=true}babelHelpers.defineProperty(Xa,"Event",aa);var Ka=new WeakSet;var Ja=new WeakSet;var Ya=new WeakSet;var Qa=function(){function e(t){babelHelpers.classCallCheck(this,e);Zs(this,Ya);Zs(this,Ja);Zs(this,Ka);this.call=t.call}babelHelpers.createClass(e,[{key:"inviteUsers",value:function e(t){return ea(this,Ya,er).call(this,ta.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&Gr.getPullClient().isPublishingEnabled()){ea(this,Ka,Za).call(this,ia.answer,t)}else{return ea(this,Ya,er).call(this,ta.answer,t)}}},{key:"sendCancel",value:function e(t){return ea(this,Ya,er).call(this,ta.cancel,t)}},{key:"sendHangup",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){ea(this,Ka,Za).call(this,ia.hangup,t);t.retransmit=false;ea(this,Ya,er).call(this,ta.hangup,t)}else{t.retransmit=true;ea(this,Ya,er).call(this,ta.hangup,t)}}},{key:"sendVoiceStarted",value:function e(t){return ea(this,Ja,$a).call(this,na.voiceStarted,t)}},{key:"sendVoiceStopped",value:function e(t){return ea(this,Ja,$a).call(this,na.voiceStopped,t)}},{key:"sendMicrophoneState",value:function e(t){return ea(this,Ja,$a).call(this,na.microphoneState,{microphoneState:t?"Y":"N"})}},{key:"sendCameraState",value:function e(t){return ea(this,Ja,$a).call(this,na.cameraState,{cameraState:t?"Y":"N"})}},{key:"sendScreenState",value:function e(t){return ea(this,Ja,$a).call(this,na.screenState,{screenState:t?"Y":"N"})}},{key:"sendRecordState",value:function e(t){return ea(this,Ja,$a).call(this,na.recordState,t)}},{key:"sendFloorRequest",value:function e(t){return ea(this,Ja,$a).call(this,na.floorRequest,{requestActive:t?"Y":"N"})}},{key:"sendEmotion",value:function e(t,i){return ea(this,Ja,$a).call(this,na.emotion,{toUserId:t,emotion:i})}},{key:"sendCustomMessage",value:function e(t,i){return ea(this,Ja,$a).call(this,na.customMessage,{message:t,repeatOnConnect:!!i})}},{key:"sendShowUsers",value:function e(t){return ea(this,Ja,$a).call(this,na.showUsers,{users:t})}},{key:"sendShowAll",value:function e(){return ea(this,Ja,$a).call(this,na.showAll,{})}},{key:"sendHideAll",value:function e(){return ea(this,Ja,$a).call(this,na.hideAll,{})}},{key:"sendPingToUsers",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){ea(this,Ka,Za).call(this,ia.ping,t,0)}}},{key:"sendPingToBackend",value:function e(){ea(this,Ya,er).call(this,ta.ping,{retransmit:false})}},{key:"sendUserInviteTimeout",value:function e(t){if(Gr.getPullClient().isPublishingEnabled()){ea(this,Ka,Za).call(this,ia.userInviteTimeout,t,0)}}},{key:"sendJoinRoom",value:function e(t){return ea(this,Ja,$a).call(this,na.joinRoom,{roomId:t})}},{key:"sendLeaveRoom",value:function e(t){return ea(this,Ja,$a).call(this,na.leaveRoom,{roomId:t})}},{key:"sendListRooms",value:function e(){return ea(this,Ja,$a).call(this,na.listRooms)}},{key:"sendRequestRoomSpeaker",value:function e(t){return ea(this,Ja,$a).call(this,na.requestRoomSpeaker,{roomId:t})}}]);return e}();function Za(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!l.Type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Do.getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));Gr.getPullClient().sendMessage(t.userId,"im",e,t,i)}function $a(e,t){if(!this.call.voximplantCall){return}if(!l.Type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=Do.getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))}function er(e,t){if(!l.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Do.getUuidv4();return Gr.getRestClient().callMethod(e,t)}var tr=new WeakMap;var ir=new WeakMap;var nr=new WeakMap;var sr=new WeakMap;var ar=new WeakMap;var rr=new WeakMap;var or=new WeakMap;var lr=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);Qs(this,tr,{writable:true,value:function e(t){i.log("VoxImplant.EndpointEvents.RemoteMediaAdded",t.mediaRenderer);if(t.mediaRenderer.element){t.mediaRenderer.element.volume=0;t.mediaRenderer.element.srcObject=null}i.addMediaRenderer(t.mediaRenderer)}});Qs(this,ir,{writable:true,value:function e(t){console.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, ",t.mediaRenderer);i.removeMediaRenderer(t.mediaRenderer)}});Qs(this,nr,{writable:true,value:function e(){i.callbacks.onVoiceStarted()}});Qs(this,sr,{writable:true,value:function e(){i.callbacks.onVoiceEnded()}});Qs(this,ar,{writable:true,value:function e(t){i.log("VoxImplant.EndpointEvents.Removed",t);if(i.endpoint){i.removeEndpointEventHandlers();i.endpoint=null}if(i.stream){i.stream=null}if(i.ready){i.waitForConnectionRestore()}i.updateCalculatedState()}});Qs(this,rr,{writable:true,value:function e(t){i.callbacks.onMediaRenderEnabled(t)}});Qs(this,or,{writable:true,value:function e(t){i.callbacks.onMediaRenderDisabled(t)}});this.userId=t.userId;this.call=t.call;this.ready=!!t.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.direction=t.direction||fr.SendRecv;this.stream=null;this.mediaRenderers=[];this.isIncomingVideoAllowed=t.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:l.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:l.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:l.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaRemoved:l.Type.isFunction(t.onMediaRemoved)?t.onMediaRemoved:BX.DoNothing,onVoiceStarted:l.Type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,onVoiceEnded:l.Type.isFunction(t.onVoiceEnded)?t.onVoiceEnded:BX.DoNothing,onMediaRenderEnabled:l.Type.isFunction(t.onMediaRenderEnabled)?t.onMediaRenderEnabled:BX.DoNothing,onMediaRenderDisabled:l.Type.isFunction(t.onMediaRenderDisabled)?t.onMediaRenderDisabled:BX.DoNothing};this.calculatedState=this.calculateState()}babelHelpers.createClass(e,[{key:"setReady",value:function e(t){t=!!t;if(this.ready==t){return}this.ready=t;this.readyStack=(new Error).stack;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()}},{key:"setDirection",value:function e(t){if(this.direction==t){return}this.direction=t}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setEndpoint",value:function e(t){this.log("Adding endpoint with "+t.mediaRenderers.length+" media renderers");this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=t;for(var i=0;i<this.endpoint.mediaRenderers.length;i++){this.addMediaRenderer(this.endpoint.mediaRenderers[i]);if(this.endpoint.mediaRenderers[i].element);}this.bindEndpointEventHandlers()}},{key:"allowIncomingVideo",value:function e(t){if(this.isIncomingVideoAllowed==t){return}this.isIncomingVideoAllowed=!!t}},{key:"addMediaRenderer",value:function e(t){this.log("Adding media renderer for user"+this.userId,t);this.mediaRenderers.push(t);this.callbacks.onMediaReceived({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user"+this.userId,t);var i=this.mediaRenderers.indexOf(t);if(i>=0){this.mediaRenderers.splice(i,1)}this.callbacks.onMediaRemoved({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"bindEndpointEventHandlers",value:function e(){this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,tr));this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,ir));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,nr));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,sr));this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,ar));this.endpoint.addEventListener(VoxImplant.EndpointEvents.MediaRenderEnabled,babelHelpers.classPrivateFieldGet(this,rr));this.endpoint.addEventListener(VoxImplant.EndpointEvents.MediaRenderDisabled,babelHelpers.classPrivateFieldGet(this,or))}},{key:"removeEndpointEventHandlers",value:function e(){this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,tr));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,ir));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,nr));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,sr));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,ar));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.MediaRenderEnabled,babelHelpers.classPrivateFieldGet(this,rr));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.MediaRenderDisabled,babelHelpers.classPrivateFieldGet(this,or))}},{key:"calculateState",value:function e(){if(this.endpoint){return mr.Connected}if(this.calling){return mr.Calling}if(this.inviteTimeout){return mr.Unavailable}if(this.declined){return mr.Declined}if(this.busy){return mr.Busy}if(this.ready){return mr.Ready}return mr.Idle}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,direction:this.direction});this.calculatedState=t}}},{key:"isParticipating",value:function e(){return(this.calling||this.ready||this.endpoint)&&!this.declined}},{key:"waitForConnectionRestore",value:function e(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),ca)}},{key:"onInvited",value:function e(){var t=this;this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((function(){return t.onInviteTimeout(true)}),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"onConnectionRestoreTimeout",value:function e(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){if(this.stream){Do.stopMediaStream(this.stream);this.stream=null}if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onInviteTimeout=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaRemoved=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null}}]);return e}();var cr=function e(t,i){var n={connection:t.connection,outboundAudio:[],outboundVideo:[],inboundAudio:[],inboundVideo:[]};var s={};if(i.getEndpoints){i.getEndpoints().forEach((function(e){return s[e.id]=e}))}if(!n.connection.timestamp){n.connection.timestamp=Date.now()}for(var a in t.outbound){if(!t.outbound.hasOwnProperty(a)){continue}var r=t.outbound[a];for(var o=0;o<r.length;o++){var l=r[o];l.trackId=a;if("audioLevel"in l){n.outboundAudio.push(l)}else{n.outboundVideo.push(l)}}}var c=function e(){if(!t.inbound.hasOwnProperty(d)){return"continue"}var i=t.inbound[d];if(!("endpoint"in i)){return"continue"}i.trackId=d;if("audioLevel"in i){n.inboundAudio.push(i)}else{if(s[i.endpoint]){var a=s[i.endpoint].mediaRenderers.find((function(e){return e.id==i.trackId}));if(a&&a.element){i.actualHeight=a.element.videoHeight;i.actualWidth=a.element.videoWidth}}n.inboundVideo.push(i)}};for(var d in t.inbound){var u=c();if(u==="continue")continue}return n};var dr=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.callId=t.callId;this.lifetime=t.lifetime||120;this.callbacks={onDelete:l.Type.isFunction(t.onDelete)?t.onDelete:BX.DoNothing};this.deleteTimeout=setTimeout((function(){i.callbacks.onDelete({callId:i.callId})}),this.lifetime*1e3)}babelHelpers.createClass(e,[{key:"__onPullEvent",value:function e(t,i,n){}},{key:"isAnyoneParticipating",value:function e(){return false}},{key:"addEventListener",value:function e(){return false}},{key:"removeEventListener",value:function e(){return false}},{key:"addInvitedUsers",value:function e(){console.error("unexpected call to CallStub.addInvitedUsers")}},{key:"destroy",value:function e(){clearTimeout(this.deleteTimeout);this.callbacks.onDelete=BX.DoNothing}}]);return e}();function ur(e,t){hr(e,t);t.add(e)}function hr(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function pr(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var vr={Idle:"Idle",Proceeding:"Proceeding",Connected:"Connected",Finished:"Finished"};var mr={Idle:"Idle",Busy:"Busy",Calling:"Calling",Unavailable:"Unavailable",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};var fr={SendOnly:"send",RecvOnly:"recv",SendRecv:"sendrecv"};var gr={Instant:1,Permanent:2};var br={Plain:"Plain",Voximplant:"Voximplant",Bitrix:"Bitrix",BitrixDev:"BitrixDev"};var Cr={Incoming:"Incoming",Outgoing:"Outgoing"};var kr={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};var yr={all:"all",none:"none"};var Sr={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserMicrophoneState:"onUserMicrophoneState",onUserCameraState:"onUserCameraState",onCameraPublishing:"onCameraPublishing",onMicrophonePublishing:"onMicrophonePublishing",onUserVideoPaused:"onUserVideoPaused",onUserScreenState:"onUserScreenState",onUserRecordState:"onUserRecordState",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onUserFloorRequest:"onUserFloorRequest",onUserEmotion:"onUserEmotion",onUserStatsReceived:"onUserStatsReceived",onCustomMessage:"onCustomMessage",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onMicrophoneLevel:"onMicrophoneLevel",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onRemoteMediaReceived:"onRemoteMediaReceived",onRemoteMediaStopped:"onRemoteMediaStopped",onBadNetworkIndicator:"onBadNetworkIndicator",onConnectionQualityChanged:"onConnectionQualityChanged",onNetworkProblem:"onNetworkProblem",onReconnecting:"onReconnecting",onReconnected:"onReconnected",onJoin:"onJoin",onLeave:"onLeave",onJoinRoomOffer:"onJoinRoomOffer",onJoinRoom:"onJoinRoom",onLeaveRoom:"onLeaveRoom",onListRooms:"onListRooms",onUpdateRoom:"onUpdateRoom",onTransferRoomSpeakerRequest:"onTransferRoomSpeakerRequest",onTransferRoomSpeaker:"onTransferRoomSpeaker",onDestroy:"onDestroy",onGetUserMediaEnded:"onGetUserMediaEnded"};var wr={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var Ir=new WeakSet;var Mr=new WeakSet;var _r=new WeakSet;var Tr=new WeakSet;var Er=new WeakSet;var Rr=new WeakSet;var Pr=new WeakSet;var Br=new WeakSet;var Hr=function(){function e(){babelHelpers.classCallCheck(this,e);ur(this,Br);ur(this,Pr);ur(this,Rr);ur(this,Er);ur(this,Tr);ur(this,_r);ur(this,Mr);ur(this,Ir);babelHelpers.defineProperty(this,"handlers",{"Call::incoming":pr(this,Tr,Ar).bind(this)});this.debugFlag=false;this.calls={};this.userId=Number(BX.message("USER_ID"));this.siteId="";this.unknownCalls={};this.restClient=null;this.pullClient=null;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){BX.addCustomEvent("onPullEvent-im",pr(this,Mr,Lr).bind(this));BX.addCustomEvent("onPullClientEvent-im",pr(this,_r,xr).bind(this))}},{key:"getSiteId",value:function e(){return this.siteId||BX.message("SITE_ID")||""}},{key:"setSiteId",value:function e(t){this.siteId=t}},{key:"getCurrentUserId",value:function e(){return this.userId}},{key:"setCurrentUserId",value:function e(t){this.userId=Number(t)}},{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setPullClient",value:function e(t){this.pullClient=t}},{key:"getRestClient",value:function e(){return this.restClient||BX.rest}},{key:"getPullClient",value:function e(){return this.pullClient||BX.PULL}},{key:"getLogService",value:function e(){return BX.message("call_log_service")}},{key:"createCall",value:function e(t){var i=this;return new Promise((function(e,n){var s=t.type||gr.Instant;var a=t.provider||i.getDefaultProvider();if(t.joinExisting){for(var r in i.calls){if(i.calls.hasOwnProperty(r)){var o=i.calls[r];if(o.provider==t.provider&&o.associatedEntity.type==t.entityType&&o.associatedEntity.id==t.entityId){i.log(r,"Found existing call, attaching to it");BX.onCustomEvent(window,"CallEvents::callCreated",[{call:o}]);return e({call:o,isNew:false})}}}}var c={type:s,provider:a,entityType:t.entityType,entityId:t.entityId,joinExisting:!!t.joinExisting,userIds:l.Type.isArray(t.userIds)?t.userIds:[]};i.getRestClient().callMethod(wr.createCall,c).then((function(s){if(s.error()){var a=s.error().getError();return n({code:a.error,message:a.error_description})}var r=s.data();if(r.userData){Do.setUserData(r.userData)}if(r.publicChannels){i.getPullClient().setPublicIds(Object.values(r.publicChannels))}var o=r.call;if(i.calls[o["ID"]]){if(i.calls[o["ID"]]instanceof dr){i.calls[o["ID"]].destroy()}else{console.error("Call "+o["ID"]+" already exists");return e({call:i.calls[o["ID"]],isNew:false})}}var l=pr(i,Br,Fr).call(i,o["PROVIDER"]);var c=l.createCall({id:parseInt(o["ID"]),instanceId:Do.getUuidv4(),direction:Cr.Outgoing,users:r.users,userData:r.userData,videoEnabled:t.videoEnabled===true,enableMicAutoParameters:t.enableMicAutoParameters!==false,associatedEntity:o.ASSOCIATED_ENTITY,type:o.TYPE,startDate:o.START_DATE,events:{onDestroy:pr(i,Rr,Ur).bind(i)},debug:t.debug===true,logToken:r.logToken,connectionData:r.connectionData});i.calls[o["ID"]]=c;if(r.isNew){i.log(c.id,"Creating new call")}else{i.log(c.id,"Server returned existing call, attaching to it")}BX.onCustomEvent(window,"CallEvents::callCreated",[{call:c}]);e({call:c,isNew:r.isNew})}))["catch"]((function(e){if(l.Type.isFunction(e.error)){e=e.error().getError()}n({code:e.error,message:e.error_description})}))}))}},{key:"createChildCall",value:function e(t,i,n){var s=this;if(!this.calls[t]){return Promise.reject("Parent call is not found")}return new Promise((function(e){var a=s.calls[t];var r={parentId:t,newProvider:i,newUsers:n};s.getRestClient().callMethod(wr.createChildCall,r,(function(t){var i=t.data();var n=i.call;var r=pr(s,Br,Fr).call(s,n["PROVIDER"]);var o=r.createCall({id:parseInt(n["ID"]),instanceId:Do.getUuidv4(),parentId:n["PARENT_ID"],direction:Cr.Outgoing,users:i.users,userData:i.userData,videoEnabled:a.isVideoEnabled(),enableMicAutoParameters:a.enableMicAutoParameters!==false,associatedEntity:n.ASSOCIATED_ENTITY,type:n.TYPE,startDate:n.START_DATE,events:{onDestroy:pr(s,Rr,Ur).bind(s)},logToken:i.logToken,connectionData:i.connectionData});s.calls[n["ID"]]=o;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:o}]);e({call:o,isNew:i.isNew})}))}))}},{key:"getCallWithId",value:function e(t){var i=this;if(this.calls[t]){return Promise.resolve({call:this.calls[t],isNew:false})}return new Promise((function(e,n){i.getRestClient().callMethod(wr.getCall,{callId:t}).then((function(t){var n=t.data();e({call:pr(i,Ir,Dr).call(i,n.call,n.users,n.logToken,n.connectionData,n.userData),isNew:false})}))["catch"]((function(e){console.error(e);if(l.Type.isFunction(e.error)){e=e.error().getError()}n({code:e.error,message:e.error_description})}))}))}},{key:"getDefaultProvider",value:function e(){return br.Plain}},{key:"getConferencePageTag",value:function e(t){return"conference-open-"+t}},{key:"debug",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.debugFlag=!!t;return this.debugFlag}},{key:"log",value:function e(){var t=Do.getLogMessage.call(Do,arguments);if(a.DesktopApi.isDesktop()){a.DesktopApi.writeToLogFile(BX.message("USER_ID")+".video.log",t)}if(this.debugFlag){if(console){var i=["Call log ["+Do.getTimeForLog()+"]: "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}}}},{key:"getAllowedVideoQuality",value:function e(t){if(t<5){return kr.VeryHigh}else if(t<10){return kr.High}else if(t<16){return kr.Medium}else if(t<32){return kr.Low}else{return kr.VeryLow}}}]);return e}();function Dr(e,t,i,n,s){if(this.calls[e["ID"]]){console.error("Call "+e["ID"]+" already exists");return this.calls[e["ID"]]}var a=pr(this,Br,Fr).call(this,e["PROVIDER"]);var r=a.createCall({id:parseInt(e["ID"]),instanceId:Do.getUuidv4(),initiatorId:parseInt(e["INITIATOR_ID"]),parentId:e["PARENT_ID"],direction:e["INITIATOR_ID"]==this.userId?Cr.Outgoing:Cr.Incoming,users:t,userData:s,associatedEntity:e.ASSOCIATED_ENTITY,type:e.TYPE,startDate:e["START_DATE"],logToken:i,connectionData:n,events:{onDestroy:pr(this,Rr,Ur).bind(this)}});this.calls[e["ID"]]=r;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:r}]);return r}function Lr(e,t,i){var n=this;if(e.startsWith("Call::")){if(t.publicIds){this.getPullClient().setPublicIds(Object.values(t.publicIds))}if(t.userData){Do.setUserData(t.userData)}}if(this.handlers[e]){this.handlers[e].call(this,t,i)}else if(e.startsWith("Call::")&&(t["call"]||t["callId"])){var s=t["call"]?t["call"]["ID"]:t["callId"];if(this.calls[s]){this.calls[s].__onPullEvent(e,t,i)}else if(e==="Call::ping"){pr(this,Er,Nr).call(this,t,i).then((function(a){if(a&&n.calls[s]){n.calls[s].__onPullEvent(e,t,i)}}))}}}function xr(e,t,i){var n=this;if(e.startsWith("Call::")&&t["callId"]){var s=t["callId"];if(this.calls[s]){this.calls[s].__onPullEvent(e,t,i)}else if(e==="Call::ping"){pr(this,Er,Nr).call(this,t,i).then((function(a){if(a&&n.calls[s]){n.calls[s].__onPullEvent(e,t,i)}}))}}}function Ar(e,t){console.log("#onPullIncomingCall",location.href);if(t.server_time_ago>30){console.error("Call was started too long time ago");return}var i=e.call;var n=parseInt(i.ID);var s;if(e.publicIds){this.getPullClient().setPublicIds(Object.values(e.publicIds))}if(e.userData){Do.setUserData(e.userData)}if(this.calls[n]){s=this.calls[n]}else{var a=pr(this,Br,Fr).call(this,i.PROVIDER);s=a.createCall({id:n,instanceId:Do.getUuidv4(),parentId:i.PARENT_ID||null,callFromMobile:e.isLegacyMobile===true,direction:Cr.Incoming,users:e.users,userData:e.userData,initiatorId:e.senderId,associatedEntity:i.ASSOCIATED_ENTITY,type:i.TYPE,startDate:i.START_DATE,logToken:e.logToken,connectionData:e.connectionData,events:{onDestroy:pr(this,Rr,Ur).bind(this)}});this.calls[n]=s;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:s}])}if(s){s.addInvitedUsers(e.invitedUsers);BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:s,video:e.video===true,isLegacyMobile:e.isLegacyMobile===true}])}this.log(s.id,"Incoming call "+s.id)}function Nr(e,t){var i=this;var n=Number(e.callId);if(t.server_time_ago>10){this.log(n,"Error: Ping was sent too long time ago");return Promise.resolve(false)}if(!pr(this,Pr,Vr).call(this)){return Promise.resolve(false)}if(this.unknownCalls[n]){return Promise.resolve(false)}this.unknownCalls[n]=true;if(e.userData){Do.setUserData(e.userData)}return new Promise((function(e){i.getCallWithId(n).then((function(){i.unknownCalls[n]=false;e(true)}))["catch"]((function(t){i.unknownCalls[n]=false;i.log(n,"Error: Could not instantiate call",t);e(false)}))}))}function Ur(e){var t=this;var i=e.call.id;this.calls[i]=new dr({callId:i,onDelete:function e(){if(t.calls[i]){delete t.calls[i]}}});BX.onCustomEvent(window,"CallEvents::callDestroyed",[{callId:e.call.id}])}function Vr(){if("BXIM"in window&&"init"in window.BXIM){return BXIM.init}else if(BX.Messenger&&BX.Messenger.Application&&BX.Messenger.Application.conference){return BX.Messenger.Application.conference.inited}return true}function Fr(e){if(e==br.Plain){return Or}else if(e==br.Bitrix){return Xr}else if(e==br.Voximplant){return Wr}throw new Error("Unknown call provider type "+e)}var Or=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new Ci(t)}}]);return e}();var Xr=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new Rs(t)}}]);return e}();var Wr=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new Xa(t)}}]);return e}();var Gr=new Hr;var zr="/bitrix/js/im/images/blank.gif";var jr={};var qr={};function Kr(e,t){var i=[];for(var n=0;n<t.length;n++){if(jr.hasOwnProperty(t[n])){continue}i.push(t[n])}var s=new Promise((function(n,s){if(i.length===0){return n()}Gr.getRestClient().callMethod("im.call.getUsers",{callId:e,userIds:i}).then((function(e){var i=l.Type.isPlainObject(e.answer.result)?e.answer.result:{};t.forEach((function(e){if(i[e]){jr[e]=i[e]}delete qr[e]}));n()}))["catch"]((function(e){s(e.answer)}))}));for(var a=0;a<i.length;a++){qr[i[a]]=s}return s}function Jr(e){for(var t in e){e[t]=e[t]}}var Yr=function e(){var t=new Date;return t.getFullYear()+"-"+Zr(t.getMonth()+1,2,"0")+"-"+Zr(t.getDate(),2,"0")+" "+Zr(t.getHours(),2,"0")+":"+Zr(t.getMinutes(),2,"0")+":"+Zr(t.getSeconds(),2,"0")+"."+t.getMilliseconds()};var Qr=function e(){var t=new Date;return Zr(t.getHours(),2,"0")+":"+Zr(t.getMinutes(),2,"0")+":"+Zr(t.getSeconds(),2,"0")+"."+t.getMilliseconds()};function Zr(e,t,i){e=e.toString();i=i||" ";if(e.length>t){return e}var n="";for(var s=0;s<t-e.length;s++){n+=i}return n+e}function $r(e,t){return new Promise((function(i,n){if(jr.hasOwnProperty(t)){return i(jr[t])}else if(qr.hasOwnProperty(t)){qr[t].then((function(){return i(jr[t])}))}else{Kr(e,[t]).then((function(){return i(jr[t])}))}}))}function eo(e){return jr.hasOwnProperty(e)?jr[e]:null}function to(e,t){return new Promise((function(i,n){Kr(e,t).then((function(){var e={};t.forEach((function(t){return e[t]=jr[t]||{}}));return i(e)}))}))}function io(e,t){return new Promise((function(i,n){if(jr.hasOwnProperty(t)){return i(jr[t].name?jr[t].name:"")}else if(qr.hasOwnProperty(t)){qr[t].then((function(){return i(jr[t].name?jr[t].name:"")}))}else{Kr(e,[t]).then((function(){return i(jr[t].name?jr[t].name:"")}))}}))}function no(e,t){return new Promise((function(i,n){if(jr.hasOwnProperty(t)){return i(jr[t].avatar_hr&&!Po(jr[t].avatar_hr)?jr[t].avatar_hr:"")}else if(qr.hasOwnProperty(t)){qr[t].then((function(){return i(jr[t].avatar_hr&&!Po(jr[t].avatar_hr)?jr[t].avatar_hr:"")}))}else{Kr(e,[t]).then((function(){return i(jr[t].avatar_hr&&!Po(jr[t].avatar_hr)?jr[t].avatar_hr:"")}))}}))}function so(e,t){return new Promise((function(i,n){Kr(e,t).then((function(){var e={};t.forEach((function(t){e[t]=jr[t].avatar_hr&&!Po(jr[t].avatar_hr)?jr[t].avatar_hr:""}));return i(e)}))}))}function ao(e){return Po(e)}function ro(e,t){var i;if(!l.Type.isPlainObject(t)){t={}}if(t.gender&&BX.message.hasOwnProperty(e+"_"+t.gender)){i=BX.message(e+"_"+t.gender)}else{i=BX.message(e)}t=oo(t);return i.replace(/#.+?#/gm,(function(e){var i=e.substr(1,e.length-2);return t.hasOwnProperty(i)?t[i]:e}))}function oo(e){var t=BX.util.objectClone(e);for(var i in t){var n=i.toUpperCase();if(n!=i){t[n]=t[i];delete t[i]}}return t}function lo(e,t){t.forEach((function(t){return e.appendChild(t)}))}function co(e){if(!(e instanceof MediaStream)){return false}return e.getVideoTracks().length>0}function uo(e){if(!(e instanceof MediaStream)||e.getVideoTracks().length===0){return false}var t=e.getVideoTracks()[0];var i=t.getSettings();return i.width>=1280}function ho(e,t,i,n,s){n=n||0;s=s||0;var a=0;for(var r=1;r<=i;r++){var o=po(e,t,i,r);if(o.area>a&&o.elementWidth>n&&o.elementHeight>s){a=o.area;var l=o.elementWidth;var c=o.elementHeight}if(o.area<a){break}}if(a===0){l=n;c=s}return{width:l,height:c}}function po(e,t,i,n){var s=Math.ceil(i/n);var a=Math.floor(e/s);var r=Math.floor(t/n);var o=r/a;var l=9/16;var c;var d;if(o<l){c=r;d=Math.floor(a*(o/l))}else{d=a;c=Math.floor(r*(l/o))}var u=d*c*i;return{area:u,elementWidth:d,elementHeight:c}}var vo=function e(){return typeof webkitRTCPeerConnection!="undefined"||typeof mozRTCPeerConnection!="undefined"||typeof RTCPeerConnection!="undefined"};var mo=function e(){return BX.message("call_server_enabled")==="Y"};var fo=function e(){return BX.message("voximplant_call_server_enabled")==="Y"};var go=function e(){return BX.message("bitrix_call_server_enabled")==="Y"};var bo=function e(){return BX.message("call_allow_feedback")==="Y"};var Co=function e(){return BX.message("call_collect_stats")==="Y"};var ko=function e(){return BX.message("call_docs_status")!=="N"||BX.message("call_resumes_status")!=="N"};var yo=function e(){if(!BX.message("call_docs_status").startsWith("L")){return false}return BX.message("call_docs_status").substr(2)};var So=function e(){if(!BX.message("call_resumes_status").startsWith("L")){return false}return BX.message("call_resumes_status").substr(2)};var wo=function e(){if(mo()){return parseInt(BX.message("call_server_max_users"))}return parseInt(BX.message("turn_server_max_users"))};function Io(){var e=Yr();for(var t=0;t<arguments.length;t++){if(arguments[t]instanceof Error){e=arguments[t].message+"\n"+arguments[t].stack}else{try{e=e+" | "+(babelHelpers["typeof"](arguments[t])=="object"?JSON.stringify(arguments[t]):arguments[t])}catch(t){e=e+" | (circular structure)"}}}return e}var Mo=function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)}))};function _o(e,t){BX.ajax.runAction("im.call.reportConnection",{data:{callId:e,connectionResult:t}})}function To(e){var t=(document.location.protocol=="https:"?"https://":"http://")+"bitrix.info/bx_stat";var i=new XMLHttpRequest;i.open("POST",t,true);i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");i.withCredentials=true;e.op="call";e.d=document.location.host;var n=BX.util.buildQueryString(e);i.send(n)}var Eo=function e(){return typeof BXDesktopSystem!="undefined"||typeof BXDesktopWindow!="undefined"};var Ro=function e(){if(BX.browser.IsOpera()){return"opera"}if(BX.browser.IsChrome()){return"chrome"}if(BX.browser.IsFirefox()){return"firefox"}if(BX.browser.IsSafari()){return"safari"}return"other"};function Po(e){return typeof e!=="string"||e==""||e.endsWith(zr)}function Bo(e){if(!e instanceof MediaStream){return}e.getTracks().forEach((function(e){e.stop()}))}function Ho(){if(go()){return br.Bitrix}if(fo()){return br.Voximplant}return br.Plain}var Do={updateUserData:Kr,setUserData:Jr,getDateForLog:Yr,getTimeForLog:Qr,lpad:Zr,getUser:$r,getUserCached:eo,getUsers:to,getUserName:io,getUserAvatar:no,getUserAvatars:so,isAvatarBlank:ao,getCustomMessage:ro,convertKeysToUpper:oo,appendChildren:lo,containsVideoTrack:co,hasHdVideo:uo,findBestElementSize:ho,getFilledArea:po,isWebRTCSupported:vo,isCallServerAllowed:mo,isVoximplantCallServerAllowed:fo,isBitrixCallServerAllowed:go,isFeedbackAllowed:bo,shouldCollectStats:Co,shouldShowDocumentButton:ko,getDocumentsArticleCode:yo,getResumesArticleCode:So,getUserLimit:wo,getLogMessage:Io,getUuidv4:Mo,reportConnectionResult:_o,sendTelemetryEvent:To,isDesktop:Eo,getBrowserForStatistics:Ro,isBlank:Po,stopMediaStream:Bo,getConferenceProvider:Ho};function Lo(e,t){xo(e,t);t.add(e)}function xo(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Ao(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var No={onClose:"onClose",onDestroy:"onDestroy",onButtonClick:"onButtonClick"};var Uo={setHasCamera:"CallNotification::setHasCamera",contentReady:"CallNotification::contentReady",onButtonClick:"CallNotification::onButtonClick"};var Vo=new WeakSet;var Fo=new WeakSet;var Oo=new WeakSet;var Xo=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Lo(babelHelpers.assertThisInitialized(i),Oo);Lo(babelHelpers.assertThisInitialized(i),Fo);Lo(babelHelpers.assertThisInitialized(i),Vo);i.setEventNamespace("BX.Call.IncomingNotification");i.popup=null;i.window=null;i.callerAvatar=l.Type.isStringFilled(e.callerAvatar)?e.callerAvatar:"";if(Do.isAvatarBlank(i.callerAvatar)){i.callerAvatar=""}i.callerName=e.callerName;i.callerType=e.callerType;i.callerColor=e.callerColor;i.video=e.video;i.hasCamera=e.hasCamera===true;i.zIndex=e.zIndex;i.contentReady=false;i.postponedEvents=[];Ao(babelHelpers.assertThisInitialized(i),Vo,Wo).call(babelHelpers.assertThisInitialized(i),e);if(a.DesktopApi.isDesktop()){i.onButtonClickHandler=Ao(babelHelpers.assertThisInitialized(i),Fo,Go).bind(babelHelpers.assertThisInitialized(i));i.onContentReadyHandler=Ao(babelHelpers.assertThisInitialized(i),Oo,zo).bind(babelHelpers.assertThisInitialized(i));a.DesktopApi.subscribe(Uo.onButtonClick,i.onButtonClickHandler);a.DesktopApi.subscribe(Uo.contentReady,i.onContentReadyHandler)}return i}babelHelpers.createClass(t,[{key:"show",value:function e(){var t=this;console.log("incoming notification : SHOW");if(a.DesktopApi.isDesktop()){console.log("incoming notification : ISDESKTOP");var i={video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName,callerType:this.callerType,callerColor:this.callerColor};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{var n="\n\t\t\t\t\twindow.callNotification = new BX.Call.IncomingNotificationContent(".concat(JSON.stringify(i),");\n\t\t\t\t\twindow.callNotification.showInDesktop();\n\t\t\t\t");var s=a.DesktopApi.prepareHtml("",n);this.window=a.DesktopApi.createTopmostWindow(s)}}else{console.log("incoming notification : ISNOTDESKTOP");this.content=new Qo({video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName,callerType:this.callerType,callerColor:this.callerColor,onClose:function e(){return t.emit(No.onClose)},onDestroy:function e(){return t.emit(No.onDestroy)},onButtonClick:function e(i){return t.emit(No.onButtonClick,Object.assign({},i.data))}});this.createPopup(this.content.render());this.popup.show()}}},{key:"createPopup",value:function e(t){var i=this;this.popup=new o.Popup({id:"bx-messenger-call-notify",bindElement:null,targetContainer:document.body,content:t,closeIcon:false,noAllPaddings:true,zIndex:this.zIndex,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function e(){return i.emit(No.onClose)},onPopupDestroy:function e(){return i.popup=null}}})}},{key:"setHasCamera",value:function e(t){if(this.window){if(this.contentReady){a.DesktopApi.emit(Uo.setHasCamera,[t])}else{this.postponedEvents.push({name:Uo.setHasCamera,params:[t]})}}else if(this.content){this.content.setHasCamera(t)}}},{key:"sendPostponedEvents",value:function e(){this.postponedEvents.forEach((function(e){a.DesktopApi.emit(e.name,e.params)}));this.postponedEvents=[]}},{key:"close",value:function e(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.emit(No.onClose)}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(this.content){this.content.destroy();this.content=null}if(a.DesktopApi.isDesktop()){a.DesktopApi.unsubscribe(Uo.onButtonClick,this.onButtonClickHandler);a.DesktopApi.unsubscribe(Uo.contentReady,this.onContentReadyHandler)}this.emit(No.onDestroy);this.unsubscribeAll(No.onButtonClick);this.unsubscribeAll(No.onClick);this.unsubscribeAll(No.onDestroy)}}]);return t}(r.EventEmitter);function Wo(e){var t=Object.keys(No);for(var i=0,n=t;i<n.length;i++){var s=n[i];if(l.Type.isFunction(e[s])){this.subscribe(No[s],e[s])}}}function Go(e){this.emit(No.onButtonClick,e)}function zo(){this.contentReady=true;this.sendPostponedEvents()}babelHelpers.defineProperty(Xo,"Events",No);var jo=new WeakSet;var qo=new WeakSet;var Ko=new WeakSet;var Jo=new WeakSet;var Yo=new WeakSet;var Qo=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Lo(babelHelpers.assertThisInitialized(i),Yo);Lo(babelHelpers.assertThisInitialized(i),Jo);Lo(babelHelpers.assertThisInitialized(i),Ko);Lo(babelHelpers.assertThisInitialized(i),qo);Lo(babelHelpers.assertThisInitialized(i),jo);i.setEventNamespace("BX.Call.IncomingNotificationContent");i.video=!!e.video;i.hasCamera=!!e.hasCamera;i.callerAvatar=e.callerAvatar||"";i.callerName=e.callerName||BX.message("IM_M_CALL_VIDEO_HD");i.callerType=e.callerType||"chat";i.callerColor=e.callerColor||"";i.elements={root:null,avatar:null,buttons:{answerVideo:null}};Ao(babelHelpers.assertThisInitialized(i),jo,Zo).call(babelHelpers.assertThisInitialized(i),e);if(a.DesktopApi.isDesktop()){i.onHasCameraHandler=Ao(babelHelpers.assertThisInitialized(i),qo,$o).bind(babelHelpers.assertThisInitialized(i));a.DesktopApi.subscribe(Uo.setHasCamera,i.onHasCameraHandler);a.DesktopApi.emitToMainWindow(Uo.contentReady,[])}return i}babelHelpers.createClass(t,[{key:"render",value:function e(){var t=this.callerAvatar||"/bitrix/js/im/images/default-call-background.png";var i;if(this.video){if(this.callerType==="private"){i=BX.message("IM_M_VIDEO_CALL_FROM")}else{i=BX.message("IM_M_VIDEO_CALL_FROM_CHAT")}}else{if(this.callerType==="private"){i=BX.message("IM_M_CALL_FROM")}else{i=BX.message("IM_M_CALL_FROM_CHAT")}}var n="";var s="";var a;if(this.callerAvatar){a={backgroundImage:"url('"+this.callerAvatar+"')",backgroundColor:"#fff",backgroundSize:"cover"}}else{var r=this.callerType==="private"?"user":this.callerType;n="bx-messenger-panel-avatar-"+r;a={backgroundColor:this.callerColor||"#525252",backgroundSize:"40px",backgroundPosition:"center center"};s="bx-messenger-panel-avatar-img-default"}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-call-window"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-background"},style:{backgroundImage:"url('"+t+"')"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-background-blur"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-background-gradient"},style:{backgroundImage:"url('/bitrix/js/im/images/call-background-gradient.png')"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom-background"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-body"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-top"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-left "+n},children:[this.elements.avatar=l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-block "+s},style:a})]})]}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-title"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-title-block"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix"},text:i}),l.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller"},text:l.Text.decode(this.callerName)})]})]})]}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[this.elements.buttons.answerVideo=l.Dom.create("div",{props:{className:"bx-messenger-call-window-button"+(!this.hasCamera?" bx-messenger-call-window-button-disabled":"")},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-camera"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-text"},text:BX.message("IM_M_CALL_BTN_ANSWER_VIDEO")})],events:{click:Ao(this,Jo,tl).bind(this)}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-up"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-text"},text:BX.message("IM_M_CALL_BTN_ANSWER")})],events:{click:Ao(this,Ko,el).bind(this)}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button bx-messenger-call-window-button-danger"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-down"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-text"},text:BX.message("IM_M_CALL_BTN_DECLINE")})],events:{click:Ao(this,Yo,il).bind(this)}})]})]})]})]})]});return this.elements.root}},{key:"showInDesktop",value:function e(){var t;if((t=window.opener.BXIM)!==null&&t!==void 0&&t.callController&&!window.opener.BXIM.callController.callNotification){BXDesktopWindow.ExecuteCommand("close");return}this.render();document.body.appendChild(this.elements.root);a.DesktopApi.setWindowPosition({x:STP_CENTER,y:STP_VCENTER,width:351,height:510})}},{key:"setHasCamera",value:function e(t){this.hasCamera=!!t;if(this.elements.buttons.answerVideo){this.elements.buttons.answerVideo.classList.toggle("bx-messenger-call-window-button-disabled",!this.hasCamera)}}},{key:"destroy",value:function e(){if(a.DesktopApi.isDesktop()){a.DesktopApi.unsubscribe(Uo.setHasCamera,this.onHasCameraHandler)}this.unsubscribeAll(No.onButtonClick);this.unsubscribeAll(No.onClick);this.unsubscribeAll(No.onDestroy)}}]);return t}(r.EventEmitter);function Zo(e){var t=Object.keys(No);for(var i=0,n=t;i<n.length;i++){var s=n[i];if(l.Type.isFunction(e[s])){this.subscribe(No[s],e[s])}}}function $o(){}function el(){if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow();a.DesktopApi.emitToMainWindow(Uo.onButtonClick,[{button:"answer",video:false}])}else{this.emit(No.onButtonClick,{button:"answer",video:false})}}function tl(){if(!this.hasCamera){return}if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow();a.DesktopApi.emitToMainWindow(Uo.onButtonClick,[{button:"answer",video:true}])}else{this.emit(No.onButtonClick,{button:"answer",video:true})}}function il(){if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow();a.DesktopApi.emitToMainWindow(Uo.onButtonClick,[{button:"decline"}])}else{this.emit(No.onButtonClick,{button:"decline"})}}var nl={onButtonClick:"ConferenceNotification::onButtonClick"};var sl=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.window=null;this.callerAvatar=l.Type.isStringFilled(t.callerAvatar)?t.callerAvatar:"";this.zIndex=t.zIndex;if(Do.isAvatarBlank(this.callerAvatar)){this.callerAvatar=""}this.callerName=t.callerName;this.callerColor=t.callerColor;this.callbacks={onClose:l.Type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:l.Type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:l.Type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing};this._onContentButtonClickHandler=this._onContentButtonClick.bind(this);if(a.DesktopApi.isDesktop()){a.DesktopApi.subscribe(nl.onButtonClick,this._onContentButtonClickHandler)}}babelHelpers.createClass(e,[{key:"show",value:function e(){if(a.DesktopApi.isDesktop()){var t={callerAvatar:this.callerAvatar,callerName:this.callerName,callerColor:this.callerColor};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{var i="\n\t\t\t\t\twindow.conferenceNotification = new BX.Call.NotificationConferenceContent(".concat(JSON.stringify(t),");\n\t\t\t\t\twindow.conferenceNotification.showInDesktop();\n\t\t\t\t");var n=a.DesktopApi.prepareHtml("",i);this.window=a.DesktopApi.createTopmostWindow(n)}}else{this.content=new al({callerAvatar:this.callerAvatar,callerName:this.callerName,callerColor:this.callerColor,onClose:this.callbacks.onClose,onDestroy:this.callbacks.onDestroy,onButtonClick:this.callbacks.onButtonClick});this.createPopup(this.content.render());this.popup.show()}}},{key:"createPopup",value:function e(t){this.popup=new o.Popup({id:"bx-messenger-call-notify",targetContainer:document.body,content:t,closeIcon:false,noAllPaddings:true,zIndex:this.zIndex,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){this.callbacks.onClose()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)}})}},{key:"close",value:function e(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.callbacks.onClose()}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(a.DesktopApi.isDesktop()){a.DesktopApi.unsubscribe(nl.onButtonClick,this._onContentButtonClickHandler)}this.callbacks.onDestroy()}},{key:"_onContentButtonClick",value:function e(t){this.callbacks.onButtonClick(t)}}]);return e}();var al=function(){function e(t){babelHelpers.classCallCheck(this,e);this.callerAvatar=t.callerAvatar||"";this.callerName=t.callerName||BX.message("IM_CL_USER");this.callerColor=t.callerColor||"#525252";this.elements={root:null,avatar:null};this.callbacks={onClose:l.Type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:l.Type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:l.Type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this.callerAvatar||"/bitrix/js/im/images/default-call-background.png";var i;if(this.callerAvatar){i={backgroundImage:"url('"+this.callerAvatar+"')",backgroundColor:"#fff",backgroundSize:"cover"}}else{i={backgroundImage:"url('"+(this.callerAvatar||"/bitrix/js/im/images/default-avatar-videoconf-big.png")+"')",backgroundColor:this.callerColor,backgroundSize:"80px",backgroundRepeat:"no-repeat",backgroundPosition:"center center"}}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-call-window"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-background"},style:{backgroundImage:"url("+t+")"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-background-blur"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-background-gradient"},style:{backgroundImage:"url('/bitrix/js/im/images/call-background-gradient.png')"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom-background"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-body"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-top"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-left"},children:[this.elements.avatar=l.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-block"},style:i})]})]}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-title"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-title-block"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix"},text:BX.message("IM_M_VIDEO_CALL_FROM")}),l.Dom.create("div",{text:l.Text.encode(this.callerName),props:{className:"bx-messenger-call-overlay-title-caller"}})]})]})]}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-camera"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-text"},text:BX.message("IM_M_CALL_BTN_ANSWER_CONFERENCE")})],events:{click:this._onAnswerConferenceButtonClick.bind(this)}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button bx-messenger-call-window-button-danger"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-down"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-window-button-text"},text:BX.message("IM_M_CALL_BTN_SKIP_CONFERENCE")})],events:{click:this._onSkipConferenceButtonClick.bind(this)}})]})]})]})]})]});return this.elements.root}},{key:"showInDesktop",value:function e(){this.render();document.body.appendChild(this.elements.root);a.DesktopApi.setWindowPosition({x:STP_CENTER,y:STP_VCENTER,width:351,height:510})}},{key:"_onAnswerConferenceButtonClick",value:function e(t){if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow();a.DesktopApi.emitToMainWindow(nl.onButtonClick,[{button:"answerConference"}])}else{this.callbacks.onButtonClick({button:"answerConference"})}}},{key:"_onSkipConferenceButtonClick",value:function e(t){if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow();a.DesktopApi.emitToMainWindow(nl.onButtonClick,[{button:"skipConference"}])}else{this.callbacks.onButtonClick({button:"skipConference"})}}}]);return e}();var rl={onBackToCallClick:"FloatingScreenshare::onBackToCallClick",onStopSharingClick:"FloatingScreenshare::onStopSharingClick",onChangeScreenClick:"FloatingScreenshare::onChangeScreenClick"};var ol=291;var ll=81;var cl=80;var dl=80;var ul=function(){function e(t){babelHelpers.classCallCheck(this,e);if(babelHelpers["typeof"](t)!=="object"){t={}}this.darkMode=t.darkMode||false;this.window=null;this.sharedWindowX=null;this.sharedWindowY=null;this.sharedWindowHeight=null;this.sharedWindowWidth=null;this.title="";this.app="";this.screens=[];this.screenToUse=null;this.callbacks={onBackToCallClick:l.Type.isFunction(t.onBackToCallClick)?t.onBackToCallClick:BX.DoNothing,onStopSharingClick:l.Type.isFunction(t.onStopSharingClick)?t.onStopSharingClick:BX.DoNothing,onChangeScreenClick:l.Type.isFunction(t.onChangeScreenClick)?t.onChangeScreenClick:BX.DoNothing};this._onBackToCallClickHandler=this._onBackToCallClick.bind(this);this._onStopSharingClickHandler=this._onStopSharingClick.bind(this);this._onChangeScreenClickHandler=this._onChangeScreenClick.bind(this);this.bindEventHandlers()}babelHelpers.createClass(e,[{key:"bindEventHandlers",value:function e(){a.DesktopApi.subscribe(rl.onBackToCallClick,this._onBackToCallClickHandler);a.DesktopApi.subscribe(rl.onStopSharingClick,this._onStopSharingClickHandler);a.DesktopApi.subscribe(rl.onChangeScreenClick,this._onChangeScreenClickHandler)}},{key:"saveExistingScreens",value:function e(){var t=this;return new Promise((function(e,i){if(t.screens.length>0){return e()}BXDesktopSystem.ListScreenMedia((function(i){i.forEach((function(e){if(e.id.slice(0,6)==="screen"){t.screens.push({id:e.id,x:e.x,y:e.y,width:e.width,height:e.height})}}));return e()}))}))}},{key:"_onBackToCallClick",value:function e(){this.callbacks.onBackToCallClick()}},{key:"_onStopSharingClick",value:function e(){this.close();this.callbacks.onStopSharingClick()}},{key:"_onChangeScreenClick",value:function e(){this.callbacks.onChangeScreenClick()}},{key:"setSharingData",value:function e(t){var i=this;return this.saveExistingScreens().then((function(){i.sharedWindowX=t.x+10;i.sharedWindowY=t.y+10;i.sharedWindowWidth=t.width;i.sharedWindowHeight=t.height;i.title=t.title;i.app=t.app;for(var e=0;e<i.screens.length;e++){if(i.sharedWindowX>=i.screens[e].x&&i.sharedWindowX<=i.screens[e].x+i.screens[e].width&&i.sharedWindowY>=i.screens[e].y&&i.sharedWindowY<=i.screens[e].y+i.screens[e].height){i.screenToUse=i.screens[e];break}}if(!i.screenToUse&&i.screens.length>0){i.screenToUse=i.screens[0]}}))["catch"]((function(e){console.log("save existing screens error",e)}))}},{key:"show",value:function e(){if(!a.DesktopApi.isDesktop()||a.DesktopApi.getApiVersion()>74){return}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{var t={title:this.title,app:this.app,sharedWindowX:this.sharedWindowX,sharedWindowY:this.sharedWindowY,sharedWindowWidth:this.sharedWindowWidth,sharedWindowHeight:this.sharedWindowHeight,screenToUse:this.screenToUse,darkMode:this.darkMode};var i="window.FSSC = new BX.Call.FloatingScreenShareContent(".concat(JSON.stringify(t),");");var n=a.DesktopApi.prepareHtml("",i);this.window=a.DesktopApi.createTopmostWindow(n)}}},{key:"hide",value:function e(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("hide")}},{key:"close",value:function e(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null;this.visible=false}},{key:"destroy",value:function e(){if(this.window){a.DesktopApi.closeWindow();this.window=null}a.DesktopApi.unsubscribe(rl.onBackToCallClick,this._onBackToCallClickHandler);a.DesktopApi.unsubscribe(rl.onStopSharingClick,this._onStopSharingClickHandler);a.DesktopApi.unsubscribe(rl.onChangeScreenClick,this._onChangeScreenClickHandler)}}]);return e}();var hl=function(){function e(t){babelHelpers.classCallCheck(this,e);this.title=t.title||"";this.app=t.app||"";this.sharedWindowX=t.sharedWindowX||0;this.sharedWindowY=t.sharedWindowY||0;this.sharedWindowHeight=t.sharedWindowHeight||0;this.sharedWindowWidth=t.sharedWindowWidth||0;this.screenToUse=t.screenToUse||null;this.darkMode=t.darkMode||false;this.elements={container:null};this.render();this.adjustWindow(ol,ll)}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this.app?this.app+" - "+this.title:this.title;this.elements.container=l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-wrap"+(this.darkMode?" dark-mode":"")},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top-icon"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top-text",title:t},text:t})]}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-left"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-back-icon"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-back-text"},text:BX.message("IM_M_CALL_SCREENSHARE_BACK_TO_CALL")})],events:{click:this.onBackToCallClick.bind(this)}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-center"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-change-screen-icon"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-change-screen-text"},text:BX.message("IM_M_CALL_SCREENSHARE_CHANGE_SCREEN")})],events:{click:this.onChangeScreenClick.bind(this)}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-right"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-stop-icon"}}),l.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-stop-text"},text:BX.message("IM_M_CALL_SCREENSHARE_STOP")})],events:{click:this.onStopSharingClick.bind(this)}})]})]});document.body.appendChild(this.elements.container);document.body.classList.add("bx-messenger-call-floating-screenshare")}},{key:"onBackToCallClick",value:function e(){this.dispatchEvent(rl.onBackToCallClick,[])}},{key:"onChangeScreenClick",value:function e(){this.dispatchEvent(rl.onChangeScreenClick,[])}},{key:"onStopSharingClick",value:function e(){this.dispatchEvent(rl.onStopSharingClick,[])}},{key:"adjustWindow",value:function e(t,i){if(!this.screenToUse){return}var n=22;var s=22;var a=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-left").scrollWidth;var r=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-center").scrollWidth;var o=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-right").scrollWidth;var l=a+r+o+2*n+2*s;if(l>ol){t=l}this.elements.container.style.width=t+"px";this.elements.container.style.height=i+"px";BXDesktopWindow.SetProperty("minClientSize",{Width:t,Height:i});BXDesktopWindow.SetProperty("resizable",false);BXDesktopWindow.SetProperty("closable",false);BXDesktopWindow.SetProperty("title",BX.message("IM_M_CALL_SCREENSHARE_TITLE"));BXDesktopWindow.SetProperty("position",{X:this.screenToUse.x+this.screenToUse.width-t-cl,Y:this.screenToUse.y+dl,Width:t,Height:i,Mode:STP_FRONT})}},{key:"dispatchEvent",value:function e(t,i){var n={};for(var s=0;s<i.length;s++){n[s]=i[s]}var a=opener?opener:top;a.BXWindows.forEach((function(e){if(e&&e.name!==""&&e.BXDesktopWindow&&e.BXDesktopWindow.DispatchCustomEvent){e.BXDesktopWindow.DispatchCustomEvent(t,n)}}));a.BXDesktopWindow.DispatchCustomEvent(t,n)}}]);return e}();var pl=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.title=BX.prop.getString(t,"title",l.Text.encode(BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING")));this.icon=BX.prop.getString(t,"icon","mic");this.bindElement=BX.prop.getElementNode(t,"bindElement",null);this.targetContainer=BX.prop.getElementNode(t,"targetContainer",null);this.callFolded=BX.prop.getBoolean(t,"callFolded",false);this.autoCloseDelay=BX.prop.getInteger(t,"autoCloseDelay",5e3);this.buttonsLayout=BX.prop.getString(t,"buttonsLayout","right");this.buttons=BX.prop.getArray(t,"buttons",[]);this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing)};this.autoCloseTimeout=0}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;clearTimeout(this.autoCloseTimeout);if(this.autoCloseDelay>0){this.autoCloseTimeout=setTimeout((function(){return t.onAutoClose()}),this.autoCloseDelay)}if(this.popup){this.popup.show();return}this.popup=new o.Popup({bindElement:this.bindElement,targetContainer:this.targetContainer,content:this.render(),padding:0,contentPadding:14,className:"bx-call-view-popup-call-hint",contentBackground:"unset",maxWidth:600,angle:this.bindElement?{position:"bottom",offset:20}:null,events:{onClose:function e(){return t.popup.destroy()},onDestroy:function e(){return t.popup=null}}});this.popup.show()}},{key:"render",value:function e(){var t=this;return l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-body layout-"+this.buttonsLayout},children:[l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-icon "+this.icon}}),l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-middle-block"},children:[l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-text"},html:this.getPopupMessage()}),this.buttonsLayout=="bottom"?this.renderButtons():null]}),this.buttonsLayout=="right"?this.renderButtons():null,l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-close"},events:{click:function e(){t.callbacks.onClose();if(t.popup){t.popup.close()}}}})]})}},{key:"renderButtons",value:function e(){return l.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-buttons-container"},children:this.buttons.map((function(e){return e.render()}))})}},{key:"getPopupMessage",value:function e(){if(!Do.isDesktop()){return this.title}var t=BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING_HOTKEY");if(this.callFolded){var i=BX.browser.IsMac()?"Shift + &#8984; + A":"Ctrl + Shift + A";t=BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING_FOLDED_CALL_HOTKEY").replace("#HOTKEY#",i)}t='<span class="bx-call-view-popup-call-hint-text-hotkey">'+t+"</span>";return this.title+"<br>"+t}},{key:"getPopupHeight",value:function e(){return Do.isDesktop()?60:54}},{key:"close",value:function e(){if(this.popup){this.popup.close();this.callbacks.onClose()}}},{key:"onAutoClose",value:function e(){this.close()}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy()}clearTimeout(this.autoCloseTimeout)}}]);return e}();var vl={onActionClick:"onActionClick",onClose:"onClose"};var ml=function(){function e(t){babelHelpers.classCallCheck(this,e);t=l.Type.isPlainObject(t)?t:{};this.promoCode=l.Type.isStringFilled(t.promoCode)?t.promoCode:"";this.bindElement=t.bindElement;this.elements={root:null};this.popup=null;this.dontShowAgain=false;this.eventEmitter=new r.EventEmitter(this,"BX.Call.PromoPopup");if(t.events){this.subscribeToEvents(t.events)}}babelHelpers.createClass(e,[{key:"subscribeToEvents",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.eventEmitter.subscribe(i,t[i])}}}},{key:"render",value:function e(){this.elements.root=l.Dom.create("div",{props:{className:"bx-call-promo-container"},children:[l.Dom.create("div",{props:{className:"bx-call-promo-content"},children:[l.Dom.create("div",{props:{className:"bx-call-promo-icon-section"},children:[l.Dom.create("div",{props:{className:"bx-call-promo-icon"}})]}),l.Dom.create("div",{props:{className:"bx-call-promo-text-section"},children:[l.Dom.create("div",{props:{className:"bx-call-promo-title"},text:BX.message("IM_CALL_DOCUMENT_PROMO_TITLE")}),l.Dom.create("div",{props:{className:"bx-call-promo-text"},html:BX.message("IM_CALL_DOCUMENT_PROMO_TEXT")}),l.Dom.create("div",{props:{className:"bx-call-promo-refuse"},children:[l.Dom.create("input",{attrs:{type:"checkbox"},props:{className:"bx-call-promo-refuse-checkbox",id:"bx-call-promo-refuse-checkbox"},events:{change:this.onCheckboxChange.bind(this)}}),l.Dom.create("label",{attrs:{for:"bx-call-promo-refuse-checkbox"},props:{className:"bx-call-promo-refuse-text"},text:BX.message("IM_CALL_DOCUMENT_PROMO_DONT_SHOW_AGAIN")})]})]}),l.Dom.create("div",{props:{className:"bx-call-promo-button-section"},children:[l.Dom.create("button",{props:{className:"bx-call-promo-button bx-call-promo-button-action ui-btn ui-btn-round"},text:BX.message("IM_CALL_DOCUMENT_PROMO_ACTION"),events:{click:this.onActionClick.bind(this)}}),l.Dom.create("button",{props:{className:"bx-call-promo-button bx-call-promo-button-action-close ui-btn ui-btn-round"},text:BX.message("IM_CALL_DOCUMENT_PROMO_ACTION_CLOSE"),events:{click:this.close.bind(this)}})]})]})]})}},{key:"show",value:function e(){if(!this.elements.root){this.render()}this.createPopup();this.popup.show()}},{key:"close",value:function e(){if(!this.popup){return false}this.popup.close()}},{key:"createPopup",value:function e(){this.popup=new o.Popup({id:"bx-call-promo-popup",bindElement:this.bindElement,targetContainer:document.body,content:this.elements.root,cacheable:false,closeIcon:true,bindOptions:{position:"top"},angle:{position:"bottom",offset:49},className:"bx-call-promo-popup",contentBackground:"unset",events:{onPopupClose:this.onPopupClose.bind(this)}})}},{key:"onPopupClose",value:function e(){this.popup.destroy();this.destroy()}},{key:"onCheckboxChange",value:function e(t){this.dontShowAgain=t.currentTarget.checked}},{key:"onActionClick",value:function e(){this.eventEmitter.emit(vl.onActionClick)}},{key:"destroy",value:function e(){this.eventEmitter.emit(vl.onClose,{dontShowAgain:this.dontShowAgain});this.eventEmitter.unsubscribeAll(vl.onClose);this.eventEmitter=null;this.elements=null}}]);return e}();ml.Events=vl;var fl=function(){function e(t){babelHelpers.classCallCheck(this,e);t=l.Type.isPlainObject(t)?t:{};this.callView=t.callView;this.bindElement=t.bindElement;this.popup=null;t.events=l.Type.isPlainObject(t.events)?t.events:{};this.events={onActionClick:t.events.onActionClick?t.events.onActionClick:function(){},onClose:t.events.onClose?t.events.onClose:function(){}}}babelHelpers.createClass(e,[{key:"show",value:function e(){this.createPopup();this.popup.show();BX.bind(BX("promo-popup-3d-button"),"click",this.openWindow.bind(this))}},{key:"openWindow",value:function e(){var t=this;v.open({tab:"mask"});setTimeout((function(){return t.close()}),100)}},{key:"openLearningPopup",value:function e(){var t=this;var i=BX("bx-messenger-videocall-panel-item-with-arrow-camera");if(!i){return true}var n=BX.message("IM_PROMO_3DAVATAR_30112022_LEARNING_TITLE");var s=BX.message("IM_PROMO_3DAVATAR_30112022_LEARNING_TEXT");var a='\n\t\t\t<div class="promo-popup-3d-learning-content">\n\t\t\t\t<h4 class="ui-typography-heading-h4 promo-popup-3d-learning-content__title">'.concat(n,'</h4>\n\t\t\t\t<p class="promo-popup-3d-learning-content__description">').concat(s,"</p>\n\t\t\t</div>\n\t\t");this.popup=new o.Popup({id:"bx-call-promo-learning-popup",bindElement:i,targetContainer:document.body,content:a,cacheable:false,closeIcon:true,autoHide:true,closeByEsc:true,bindOptions:{position:"top",forceTop:-100,forceLeft:100,forceBindPosition:true},angle:{position:"top",offset:49},className:"bx-call-promo-popup-learn",contentBackground:"unset",events:{onPopupClose:function e(){t.events.onClose()}}});this.popup.show();this.callView.subscribe(Rt.Event.onDeviceSelectorShow,(function(){return t.popup?t.popup.close():""}))}},{key:"close",value:function e(){if(!this.popup){return false}this.popup.close()}},{key:"createPopup",value:function e(){var t=BX.message("IM_PROMO_3DAVATAR_30112022_TITLE");var i=BX.message("IM_PROMO_3DAVATAR_30112022_TEXT");var n=BX.message("IM_PROMO_3DAVATAR_30112022_BUTTON");var s='\n\t\t\t<div class="promo-popup-3d-content">\n\t\t\t\t<div class="promo-popup-3d-content__masks-container">\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --left-2 --bear"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --left-1 --pole-bear"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --center --fox"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --right-1 --santa"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --right-2 --owl"></div>\n\t\t\t\t</div>\n\t\t\t\t<h3 class="ui-typography-heading-h2 promo-popup-3d-content__title">'.concat(t,'</h3>\n\t\t\t\t<p class="promo-popup-3d-content__description">').concat(i,'</p>\n\t\t\t\t<div class="promo-popup-3d-content__actions-btn">\n\t\t\t\t\t<span class="ui-btn btn-primary ui-btn-lg ui-btn-round ui-btn-primary" id="promo-popup-3d-button">').concat(n,"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t");this.popup=new o.Popup({id:"bx-call-promo-popup-3d",bindElement:this.bindElement,targetContainer:document.body,content:s,cacheable:false,closeIcon:true,overlay:{backgroundColor:"#000",opacity:40},width:531,minHeight:481,bindOptions:{position:"top"},className:"bx-call-promo-popup-3d-masks",events:{onPopupClose:this.onPopupClose.bind(this)}})}},{key:"onPopupClose",value:function e(){this.popup.destroy();this.openLearningPopup()}}]);return e}();fl.Events=vl;var gl={onClose:"onClose",onDestroy:"onDestroy",onCloseClicked:"onCloseClicked"};var bl=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.setEventNamespace("BX.Call.SideBar");i.container=e.container;i.width=BX.prop.getInteger(e,"width",200);i.elements={root:null,close:null,contentContainer:null};if(e.events){for(var n in e.events){if(e.events.hasOwnProperty(n)){i.subscribe(n,e.events[n])}}}return i}babelHelpers.createClass(t,[{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}this.elements.root=l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-root"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-labels"},style:{top:"39px"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label"},style:{maxWidth:"40px"},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label-icon-box"},attrs:{title:BX.message("IM_M_CALL_BTN_CLOSE")},children:[l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label-icon bx-messenger-call-sidebar-label-icon-close"}})]})],events:{click:function e(){return t.emit(gl.onCloseClicked)}}})]}),this.elements.contentContainer=l.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-content-container"}})]});this.elements.root.style.setProperty("--sidebar-width",this.width+"px");return this.elements.root}},{key:"setWidth",value:function e(t){if(this.width==t){return}this.width=t;this.elements.root.style.setProperty("--sidebar-width",this.width+"px")}},{key:"open",value:function e(t){var i=this;t=t!==false;return new Promise((function(e){i.container.appendChild(i.render());if(t){i.elements.root.classList.add("opening");i.elements.root.addEventListener("animationend",(function(){i.elements.root.classList.remove("opening");e()}),{once:true})}else{e()}}))}},{key:"close",value:function e(t){var i=this;t=t!==false;return new Promise((function(e){if(t){i.elements.root.classList.add("closing");i.elements.root.addEventListener("animationend",(function(){i.container.removeChild(i.elements.root);i.emit(gl.onClose);e()}),{once:true})}else{i.container.removeChild(i.elements.root);i.emit(gl.onClose);e()}}))}},{key:"toggleHidden",value:function e(t){this.elements.root.classList.toggle("hidden",t)}},{key:"destroy",value:function e(){this.emit(gl.onDestroy);this.unsubscribeAll(gl.onClose);this.unsubscribeAll(gl.onDestroy);this.eventEmitter=null;this.elements=null;this.container=null}}]);return t}(r.EventEmitter);var Cl=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.options=t||{};this.callbacks={onClose:l.Type.isFunction(this.options.onClose)?this.options.onClose:BX.DoNothing,onStopSharingClick:l.Type.isFunction(this.options.onStopSharingClick)?this.options.onStopSharingClick:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;if(this.popup){this.popup.show();return}var i=400;this.popup=new o.Popup({bindElement:this.options.bindElement,targetContainer:this.options.targetContainer,content:this.render(),padding:0,contentPadding:0,height:38,width:i,offsetTop:-15,offsetLeft:this.options.bindElement.offsetWidth/2-i/2+this.options.bindElement.offsetWidth/2,className:"bx-call-view-popup-web-screenshare",contentBackground:"unset",angle:{position:"bottom",offset:i/2-10},cacheable:false,events:{onDestroy:function e(){return t.popup=null}}});this.popup.show()}},{key:"render",value:function e(){var t=this;return l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-body"},children:[l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-left"},children:[l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-icon-screen"}}),l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-text"},text:BX.message("IM_CALL_WEB_SCREENSHARE_STATUS")})]}),l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-right"},children:[l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-stop ui-btn ui-btn-primary ui-btn-xs ui-btn-round ui-btn-no-caps ui-btn-icon-stop"},text:BX.message("IM_CALL_WEB_SCREENSHARE_STOP"),events:{click:function e(){return t.callbacks.onStopSharingClick()}}}),l.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-close"},events:{click:function e(){t.popup.close();t.callbacks.onClose()}}})]})]})}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy()}}}]);return e}();var kl={AllowAll:"AllowAll",AllowNone:"AllowNone",OnlySpeaker:"OnlySpeaker",CurrentlyTalking:"CurrentlyTalking"};var yl=20;var Sl=function(){function e(t){babelHelpers.classCallCheck(this,e);this.call=t.call;this.callView=t.callView;this.strategyType=t.strategyType||kl.AllowAll;this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onCallViewSetCentralUserHandler=this.onCallViewSetCentralUser.bind(this);this.onCallViewLayoutChangeHandler=this.onCallViewLayoutChange.bind(this);this.users={};this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){if(this.strategyType===kl.AllowAll){this.call.allowVideoFrom(yr.all)}else if(this.strategyType===kl.AllowNone){this.call.allowVideoFrom(yr.none)}this.bindEvents()}},{key:"bindEvents",value:function e(){this.call.addEventListener(Sr.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.addEventListener(Sr.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.callView.subscribe(Rt.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.subscribe(Rt.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}},{key:"removeEvents",value:function e(){if(this.call){this.call.removeEventListener(Sr.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.removeEventListener(Sr.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler)}if(this.callView){this.callView.unsubscribe(Rt.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.unsubscribe(Rt.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}}},{key:"setType",value:function e(t){if(t==this.strategyType){return}this.strategyType=t;this.applyVideoLimit()}},{key:"applyVideoLimit",value:function e(){if(this.strategyType===kl.AllowAll){this.call.allowVideoFrom(yr.all)}else if(this.strategyType===kl.AllowNone){this.call.allowVideoFrom(yr.none)}else if(this.strategyType===kl.CurrentlyTalking){var t=this.getActiveUsers();if(t.length===0){this.call.allowVideoFrom(yr.none)}else{this.call.allowVideoFrom(this.getActiveUsers())}}}},{key:"getActiveUsers",value:function e(){var t=[];for(var i in this.users){var n=this.users[i];if(n.active){t.push(n.id)}}return t}},{key:"onUserActiveChanged",value:function e(){if(this.strategyType==kl.CurrentlyTalking){this.applyVideoLimit()}}},{key:"onCallUserVoiceStarted",value:function e(t){var i=t.userId;if(!this.users[i]){this.users[i]=new wl({id:i,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[i].setTalking(true)}},{key:"onCallUserVoiceStopped",value:function e(t){var i=t.userId;if(!this.users[i]){this.users[i]=new wl({id:i,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[i].setTalking(false)}},{key:"onCallViewSetCentralUser",value:function e(t){var i=t.data.userId;if(this.strategyType===kl.OnlySpeaker){this.call.allowVideoFrom([i])}}},{key:"onCallViewLayoutChange",value:function e(t){}},{key:"destroy",value:function e(){this.removeEvents();this.call=null;this.callView=null;for(var t in this.users){if(this.users.hasOwnProperty(t)){this.users[t].destroy()}}this.users={}}}]);return e}();babelHelpers.defineProperty(Sl,"Type",kl);var wl=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"talking",false);babelHelpers.defineProperty(this,"sharing",false);babelHelpers.defineProperty(this,"active",false);this.id=t.id;this.callbacks={onActiveChanged:l.Type.isFunction(t.onActiveChanged)?t.onActiveChanged:BX.DoNothing};this.turnOffVideoTimeout=null}babelHelpers.createClass(e,[{key:"setTalking",value:function e(t){if(this.talking==t){return}this.talking=t;if(this.talking){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}}},{key:"setSharing",value:function e(t){if(this.sharing==t){return}this.sharing=t;if(this.sharing){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}}},{key:"updateActive",value:function e(){var t=!!(this.sharing||this.talking||this.turnOffVideoTimeout);if(t!==this.active){this.active=t}this.callbacks.onActiveChanged({userId:this.id,active:this.active})}},{key:"scheduleTurnOffVideo",value:function e(){var t=this;clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=setTimeout((function(){t.turnOffVideoTimeout=null;t.updateActive()}),yl*1e3)}},{key:"cancelTurnOffVideo",value:function e(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=null}},{key:"destroy",value:function e(){this.callbacks.onActiveChanged=BX.DoNothing;clearTimeout(this.turnOffVideoTimeout)}}]);return e}();function Il(e,t){Ml(e,t);t.add(e)}function Ml(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _l(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Tl={onViewStateChanged:"onViewStateChanged",onOpenVideoConference:"onOpenVideoConference",onPromoViewed:"onPromoViewed",onCallJoined:"onCallJoined",onCallLeft:"onCallLeft",onCallDestroyed:"onCallDestroyed"};var El={Opened:"Opened",Closed:"Closed",Folded:"Folded"};var Rl={Resume:"resume",Blank:"blank"};var Pl={Enabled:"enabled",Disabled:"disabled",Limited:"limited"};var Bl=961;var Hl=328;var Dl="CallController::documentCreated";var Ll="im:call-document:16102021:web";var xl=5*60*1e3;var Al="docx";var Nl="xlsx";var Ul="pptx";var Vl="im:mask:06122022:desktop";var Fl=5*60*1e3;var Ol=new WeakSet;var Xl=new WeakSet;var Wl=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Il(babelHelpers.assertThisInitialized(i),Xl);Il(babelHelpers.assertThisInitialized(i),Ol);i.setEventNamespace("BX.Call.Controller");var n=BX.prop.getBoolean(e,"init",true);i.language=e.language||"en";i.incomingVideoStrategyType=e.incomingVideoStrategyType||Sl.Type.AllowAll;i.formatRecordDate=e.formatRecordDate||"d.m.Y";i.messengerFacade=e.messengerFacade;i.inited=false;i.container=null;i.docEditor=null;i.docEditorIframe=null;i.maxEditorWidth=Hl;i.docCreatedForCurrentCall=false;i.folded=false;i.childCall=null;i.invitePopup=null;i.videoStrategy=null;i.isHttps=window.location.protocol==="https:";i.callWithLegacyMobile=false;i.featureScreenSharing=Pl.Enabled;i.featureRecord=Pl.Enabled;i.callRecordState=Rt.RecordState.Stopped;i.callRecordType=Rt.RecordType.None;i.autoCloseCallView=true;i.talkingUsers={};i._callViewState=El.Closed;i.answeredOrDeclinedCalls=new Set;i._onCallUserInvitedHandler=i._onCallUserInvited.bind(babelHelpers.assertThisInitialized(i));i._onCallDestroyHandler=i._onCallDestroy.bind(babelHelpers.assertThisInitialized(i));i._onCallUserStateChangedHandler=i._onCallUserStateChanged.bind(babelHelpers.assertThisInitialized(i));i._onCallUserMicrophoneStateHandler=i._onCallUserMicrophoneState.bind(babelHelpers.assertThisInitialized(i));i._onCallUserCameraStateHandler=i._onCallUserCameraState.bind(babelHelpers.assertThisInitialized(i));i._onCameraPublishingHandler=i._onCameraPublishing.bind(babelHelpers.assertThisInitialized(i));i._onMicrophonePublishingdHandler=i._onMicrophonePublishingd.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVideoPausedHandler=i._onCallUserVideoPaused.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalMediaReceivedHandler=i._onCallLocalMediaReceived.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalMediaStoppedHandler=i._onCallLocalMediaStopped.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalCameraFlipHandler=i._onCallLocalCameraFlip.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalCameraFlipInDesktopHandler=i._onCallLocalCameraFlipInDesktop.bind(babelHelpers.assertThisInitialized(i));i._onCallRemoteMediaReceivedHandler=i._onCallRemoteMediaReceived.bind(babelHelpers.assertThisInitialized(i));i._onCallRemoteMediaStoppedHandler=i._onCallRemoteMediaStopped.bind(babelHelpers.assertThisInitialized(i));i._onCallBadNetworkIndicatorHandler=i._onCallBadNetworkIndicator.bind(babelHelpers.assertThisInitialized(i));i._onCallConnectionQualityChangedHandler=i._onCallConnectionQualityChanged.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVoiceStartedHandler=i._onCallUserVoiceStarted.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVoiceStoppedHandler=i._onCallUserVoiceStopped.bind(babelHelpers.assertThisInitialized(i));i._onUserStatsReceivedHandler=i._onUserStatsReceived.bind(babelHelpers.assertThisInitialized(i));i._onCallUserScreenStateHandler=i._onCallUserScreenState.bind(babelHelpers.assertThisInitialized(i));i._onCallUserRecordStateHandler=i._onCallUserRecordState.bind(babelHelpers.assertThisInitialized(i));i.onCallUserFloorRequestHandler=i._onCallUserFloorRequest.bind(babelHelpers.assertThisInitialized(i));i._onCallFailureHandler=i._onCallFailure.bind(babelHelpers.assertThisInitialized(i));i._onNetworkProblemHandler=i._onNetworkProblem.bind(babelHelpers.assertThisInitialized(i));i._onMicrophoneLevelHandler=i._onMicrophoneLevel.bind(babelHelpers.assertThisInitialized(i));i._onReconnectingHandler=i._onReconnecting.bind(babelHelpers.assertThisInitialized(i));i._onReconnectedHandler=i._onReconnected.bind(babelHelpers.assertThisInitialized(i));i._onCustomMessageHandler=i._onCustomMessage.bind(babelHelpers.assertThisInitialized(i));i._onJoinRoomOfferHandler=i._onJoinRoomOffer.bind(babelHelpers.assertThisInitialized(i));i._onJoinRoomHandler=i._onJoinRoom.bind(babelHelpers.assertThisInitialized(i));i._onLeaveRoomHandler=i._onLeaveRoom.bind(babelHelpers.assertThisInitialized(i));i._onTransferRoomSpeakerHandler=i._onTransferRoomSpeaker.bind(babelHelpers.assertThisInitialized(i));i._onCallLeaveHandler=i._onCallLeave.bind(babelHelpers.assertThisInitialized(i));i._onCallJoinHandler=i._onCallJoin.bind(babelHelpers.assertThisInitialized(i));i._onGetUserMediaEndedHandler=i._onGetUserMediaEnded.bind(babelHelpers.assertThisInitialized(i));i._onCallUserFromWebHandler=i._onCallUserFromWeb.bind(babelHelpers.assertThisInitialized(i));i._onBeforeUnloadHandler=i._onBeforeUnload.bind(babelHelpers.assertThisInitialized(i));i._onImTabChangeHandler=i._onImTabChange.bind(babelHelpers.assertThisInitialized(i));i._onUpdateChatCounterHandler=i._onUpdateChatCounter.bind(babelHelpers.assertThisInitialized(i));i._onChildCallFirstMediaHandler=i._onChildCallFirstMedia.bind(babelHelpers.assertThisInitialized(i));i._onWindowFocusHandler=i._onWindowFocus.bind(babelHelpers.assertThisInitialized(i));i._onWindowBlurHandler=i._onWindowBlur.bind(babelHelpers.assertThisInitialized(i));if(a.DesktopApi.isDesktop()&&false){i.floatingWindow=new FloatingVideo({onMainAreaClick:i._onFloatingVideoMainAreaClick.bind(babelHelpers.assertThisInitialized(i)),onButtonClick:i._onFloatingVideoButtonClick.bind(babelHelpers.assertThisInitialized(i))});i.floatingWindowUser=0}i.showFloatingWindowTimeout=0;i.hideIncomingCallTimeout=0;if(a.DesktopApi.isDesktop()){i.floatingScreenShareWindow=new ul({darkMode:i.messengerFacade.isThemeDark(),onBackToCallClick:i._onFloatingScreenShareBackToCallClick.bind(babelHelpers.assertThisInitialized(i)),onStopSharingClick:i._onFloatingScreenShareStopClick.bind(babelHelpers.assertThisInitialized(i)),onChangeScreenClick:i._onFloatingScreenShareChangeScreenClick.bind(babelHelpers.assertThisInitialized(i))})}i.showFloatingScreenShareWindowTimeout=0;i.mutePopup=null;i.allowMutePopup=true;i.webScreenSharePopup=null;i.feedbackPopup=null;i.resizeObserver=new BX.ResizeObserver(i._onResize.bind(babelHelpers.assertThisInitialized(i)));if(n){i.init();_l(babelHelpers.assertThisInitialized(i),Ol,Gl).call(babelHelpers.assertThisInitialized(i),e)}return i}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;BX.addCustomEvent(window,"CallEvents::incomingCall",this.onIncomingCall.bind(this));nt.subscribe(nt.Events.deviceChanged,this._onDeviceChange.bind(this));nt.subscribe(nt.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipHandler);if(a.DesktopApi.isDesktop()&&this.floatingWindow){window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);a.DesktopApi.subscribe("BXForegroundChanged",(function(e){if(e){t._onWindowFocus()}else{t._onWindowBlur()}}))}if(a.DesktopApi.isDesktop()&&this.floatingScreenShareWindow){a.DesktopApi.subscribe("BXScreenMediaSharing",(function(e,i,n,s,a,r,o){t.floatingScreenShareWindow.close();t.floatingScreenShareWindow.setSharingData({title:i,x:n,y:s,width:a,height:r,app:o}).then((function(){t.floatingScreenShareWindow.show()}))["catch"]((function(e){console.error("setSharingData error",e)}))}));window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);a.DesktopApi.subscribe("BXForegroundChanged",(function(e){if(e){t._onWindowFocus()}else{t._onWindowBlur()}}))}if(a.DesktopApi.isDesktop()){a.DesktopApi.subscribe(nt.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipInDesktopHandler)}if(window["VoxImplant"]){VoxImplant.getInstance().addEventListener(VoxImplant.Events.MicAccessResult,this.voxMicAccessResult.bind(this))}window.addEventListener("beforeunload",this._onBeforeUnloadHandler);BX.addCustomEvent("OnDesktopTabChange",this._onImTabChangeHandler);BX.addCustomEvent(window,"onImUpdateCounterMessage",this._onUpdateChatCounter.bind(this));BX.garbage(this.destroy,this);this.inited=true}},{key:"voxMicAccessResult",value:function e(t){if(t.stream&&t.stream.getAudioTracks().length>0&&this.callView){this.callView.microphoneId=t.stream.getAudioTracks()[0].getSettings().deviceId}}},{key:"getCallUsers",value:function e(t){var i=Object.keys(this.currentCall.getUsers());if(t){i.push(this.currentCall.userId)}return i}},{key:"getActiveCallUsers",value:function e(){var t=this.currentCall.getUsers();var i=[];for(var n in t){if(t.hasOwnProperty(n)){if(t[n]===mr.Connected||t[n]===mr.Connecting||t[n]===mr.Calling){i.push(n)}}}return i}},{key:"updateFloatingWindowContent",value:function e(){var t=this;if(!this.floatingWindow||!this.currentCall){return}this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);Do.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e)}))}},{key:"onIncomingCall",value:function e(t){var i=this;console.warn("incoming.call",t);var n=t.call;var s=this.currentCall&&(this.callView||this.callNotification);this.callWithLegacyMobile=t.isLegacyMobile===true;if(!s){if(this.callView||this.answeredOrDeclinedCalls.has(n.id)){return}this.checkDesktop().then((function(){nt.init();if(i.currentCall||n.state==vr.Finished){return}i.currentCall=n;i.bindCallEvents();i.updateFloatingWindowContent();if(i.currentCall.associatedEntity.type==="chat"&&i.currentCall.associatedEntity.advanced["chatType"]==="videoconf"){if(i.isConferencePageOpened(i.currentCall.associatedEntity.id)){i.removeCallEvents();i.currentCall=null}else{i.showIncomingConference()}}else{var e=t.video===true;i.showIncomingCall({video:e});nt.init().then((function(){if(!nt.hasCamera()){if(e){i.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"))}if(i.callNotification){i.callNotification.setHasCamera(false)}}}))}}),(function(e){if(i.currentCall){i.removeVideoStrategy();i.removeCallEvents();i.currentCall=null}console.error(e);i.log(e);if(!i.isHttps){i.showNotification(BX.message("IM_CALL_INCOMING_ERROR_HTTPS_REQUIRED"))}else{i.showNotification(BX.message("IM_CALL_INCOMING_UNSUPPORTED_BROWSER"))}}))}else{if(n.id==this.currentCall.id);else if(n.parentId==this.currentCall.id){if(!this.childCall){this.childCall=n;this.callView.removeScreenUsers();this.childCall.users.forEach((function(e){return i.callView.addUser(e,mr.Calling)}));this.updateCallViewUsers(n.id,this.childCall.users);this.answerChildCall()}}else{n.decline(486);return false}}}},{key:"bindCallEvents",value:function e(){this.currentCall.addEventListener(Sr.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.addEventListener(Sr.onDestroy,this._onCallDestroyHandler);this.currentCall.addEventListener(Sr.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.addEventListener(Sr.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.addEventListener(Sr.onUserCameraState,this._onCallUserCameraStateHandler);this.currentCall.addEventListener(Sr.onCameraPublishing,this._onCameraPublishingHandler);this.currentCall.addEventListener(Sr.onMicrophonePublishing,this._onMicrophonePublishingdHandler);this.currentCall.addEventListener(Sr.onUserVideoPaused,this._onCallUserVideoPausedHandler);this.currentCall.addEventListener(Sr.onUserScreenState,this._onCallUserScreenStateHandler);this.currentCall.addEventListener(Sr.onUserRecordState,this._onCallUserRecordStateHandler);this.currentCall.addEventListener(Sr.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.addEventListener(Sr.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(Sr.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.addEventListener(Sr.onRemoteMediaReceived,this._onCallRemoteMediaReceivedHandler);this.currentCall.addEventListener(Sr.onRemoteMediaStopped,this._onCallRemoteMediaStoppedHandler);this.currentCall.addEventListener(Sr.onBadNetworkIndicator,this._onCallBadNetworkIndicatorHandler);this.currentCall.addEventListener(Sr.onConnectionQualityChanged,this._onCallConnectionQualityChangedHandler);this.currentCall.addEventListener(Sr.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.addEventListener(Sr.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(Sr.onUserStatsReceived,this._onUserStatsReceivedHandler);this.currentCall.addEventListener(Sr.onCallFailure,this._onCallFailureHandler);this.currentCall.addEventListener(Sr.onNetworkProblem,this._onNetworkProblemHandler);this.currentCall.addEventListener(Sr.onMicrophoneLevel,this._onMicrophoneLevelHandler);this.currentCall.addEventListener(Sr.onReconnecting,this._onReconnectingHandler);this.currentCall.addEventListener(Sr.onReconnected,this._onReconnectedHandler);this.currentCall.addEventListener(Sr.onCustomMessage,this._onCustomMessageHandler);this.currentCall.addEventListener(Sr.onJoinRoomOffer,this._onJoinRoomOfferHandler);this.currentCall.addEventListener(Sr.onJoinRoom,this._onJoinRoomHandler);this.currentCall.addEventListener(Sr.onLeaveRoom,this._onLeaveRoomHandler);this.currentCall.addEventListener(Sr.onTransferRoomSpeaker,this._onTransferRoomSpeakerHandler);this.currentCall.addEventListener(Sr.onJoin,this._onCallJoinHandler);this.currentCall.addEventListener(Sr.onLeave,this._onCallLeaveHandler);this.currentCall.addEventListener(Sr.onGetUserMediaEnded,this._onGetUserMediaEndedHandler);this.currentCall.addEventListener("onUserFromWeb",this._onCallUserFromWebHandler)}},{key:"removeCallEvents",value:function e(){this.currentCall.removeEventListener(Sr.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.removeEventListener(Sr.onDestroy,this._onCallDestroyHandler);this.currentCall.removeEventListener(Sr.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.removeEventListener(Sr.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.removeEventListener(Sr.onUserCameraState,this._onCallUserCameraStateHandler);this.currentCall.removeEventListener(Sr.onCameraPublishing,this._onCameraPublishingHandler);this.currentCall.removeEventListener(Sr.onMicrophonePublishing,this._onMicrophonePublishingdHandler);this.currentCall.removeEventListener(Sr.onUserVideoPaused,this._onCallUserVideoPausedHandler);this.currentCall.removeEventListener(Sr.onUserScreenState,this._onCallUserScreenStateHandler);this.currentCall.removeEventListener(Sr.onUserRecordState,this._onCallUserRecordStateHandler);this.currentCall.removeEventListener(Sr.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.removeEventListener(Sr.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(Sr.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.removeEventListener(Sr.onRemoteMediaReceived,this._onCallRemoteMediaReceivedHandler);this.currentCall.removeEventListener(Sr.onRemoteMediaStopped,this._onCallRemoteMediaStoppedHandler);this.currentCall.removeEventListener(Sr.onBadNetworkIndicator,this._onCallBadNetworkIndicatorHandler);this.currentCall.removeEventListener(Sr.onConnectionQualityChanged,this._onCallConnectionQualityChangedHandler);this.currentCall.removeEventListener(Sr.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(Sr.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(Sr.onUserStatsReceived,this._onUserStatsReceivedHandler);this.currentCall.removeEventListener(Sr.onCallFailure,this._onCallFailureHandler);this.currentCall.removeEventListener(Sr.onNetworkProblem,this._onNetworkProblemHandler);this.currentCall.removeEventListener(Sr.onMicrophoneLevel,this._onMicrophoneLevelHandler);this.currentCall.removeEventListener(Sr.onReconnecting,this._onReconnectingHandler);this.currentCall.removeEventListener(Sr.onReconnected,this._onReconnectedHandler);this.currentCall.removeEventListener(Sr.onCustomMessage,this._onCustomMessageHandler);this.currentCall.removeEventListener(Sr.onJoin,this._onCallJoinHandler);this.currentCall.removeEventListener(Sr.onLeave,this._onCallLeaveHandler);this.currentCall.removeEventListener(Sr.onGetUserMediaEnded,this._onGetUserMediaEndedHandler)}},{key:"bindCallViewEvents",value:function e(){this.callView.setCallback(Rt.Event.onShow,this._onCallViewShow.bind(this));this.callView.setCallback(Rt.Event.onClose,this._onCallViewClose.bind(this));this.callView.setCallback(Rt.Event.onDestroy,this._onCallViewDestroy.bind(this));this.callView.setCallback(Rt.Event.onButtonClick,this._onCallViewButtonClick.bind(this));this.callView.setCallback(Rt.Event.onBodyClick,this._onCallViewBodyClick.bind(this));this.callView.setCallback(Rt.Event.onReplaceCamera,this._onCallViewReplaceCamera.bind(this));this.callView.setCallback(Rt.Event.onReplaceMicrophone,this._onCallViewReplaceMicrophone.bind(this));this.callView.setCallback(Rt.Event.onSetCentralUser,this._onCallViewSetCentralUser.bind(this));this.callView.setCallback(Rt.Event.onChangeHdVideo,this._onCallViewChangeHdVideo.bind(this));this.callView.setCallback(Rt.Event.onChangeMicAutoParams,this._onCallViewChangeMicAutoParams.bind(this));this.callView.setCallback(Rt.Event.onChangeFaceImprove,this._onCallViewChangeFaceImprove.bind(this));this.callView.setCallback(Rt.Event.onOpenAdvancedSettings,this._onCallViewOpenAdvancedSettings.bind(this));this.callView.setCallback(Rt.Event.onReplaceSpeaker,this._onCallViewReplaceSpeaker.bind(this));this.callView.setCallback(Rt.Event.onHasMainStream,this._onCallViewHasMainStream.bind(this))}},{key:"updateCallViewUsers",value:function e(t,i){var n=this;Do.getUsers(t,i).then((function(e){if(n.callView){n.callView.updateUserData(e)}}))}},{key:"createVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}var t=this.incomingVideoStrategyType;this.videoStrategy=new Sl({call:this.currentCall,callView:this.callView,strategyType:t})}},{key:"removeVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}this.videoStrategy=null}},{key:"setFeatureScreenSharing",value:function e(t){this.featureScreenSharing=t}},{key:"setFeatureRecord",value:function e(t){this.featureRecord=t}},{key:"setVideoStrategyType",value:function e(t){if(this.videoStrategy){this.videoStrategy.setType(t)}}},{key:"createContainer",value:function e(){this.container=BX.create("div",{props:{className:"bx-messenger-call-overlay"}});var t=this.messengerFacade.getContainer();t.insertBefore(this.container,t.firstChild);t.classList.add("bx-messenger-call")}},{key:"removeContainer",value:function e(){if(this.container){l.Dom.remove(this.container);this.container=null;this.messengerFacade.getContainer().classList.remove("bx-messenger-call")}}},{key:"answerChildCall",value:function e(){this.removeCallEvents();this.removeVideoStrategy();this.childCall.addEventListener(Sr.onRemoteMediaReceived,this._onChildCallFirstMediaHandler);this.childCall.addEventListener(Sr.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.answer({useVideo:this.currentCall.isVideoEnabled()})}},{key:"_onChildCallFirstMedia",value:function e(t){this.log("Finishing one-to-one call, switching to group call");var i=Rt.RecordType.None;if(this.isRecording()){i=this.callRecordType;BXDesktopSystem.CallRecordStop();this.callRecordState=Rt.RecordState.Stopped;this.callRecordType=Rt.RecordType.None;this.callView.setRecordState(this.callView.getDefaultRecordState());this.callView.setButtonActive("record",false)}this.callView.showButton("floorRequest");if(this.callView){if("track"in t){this.callView.setUserMedia(t.userId,t.kind,t.track)}if("mediaRenderer"in t&&t.mediaRenderer.kind==="audio"){this.callView.setUserMedia(t.userId,"audio",t.mediaRenderer.stream.getAudioTracks()[0])}if("mediaRenderer"in t&&(t.mediaRenderer.kind==="video"||t.mediaRenderer.kind==="sharing")){this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}this.childCall.removeEventListener(Sr.onRemoteMediaReceived,this._onChildCallFirstMediaHandler);this.removeCallEvents();var n=this.currentCall;n.hangup();this.currentCall=this.childCall;this.childCall=null;if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id)}if(n.muted){this.currentCall.setMuted(true)}this.bindCallEvents();this.createVideoStrategy();if(i!==Rt.RecordType.None){this._startRecordCall(i)}}},{key:"checkDesktop",value:function e(){if(l.Reflection.getClass("BX.Messenger.v2.Lib.DesktopManager")){return new Promise((function(e){var t=BX.Messenger.v2.Lib.DesktopManager.getInstance();t.checkStatusInDifferentContext().then((function(t){if(t===false){e()}}))}))}if(l.Reflection.getClass("BX.desktopUtils")){return new Promise((function(e){BX.desktopUtils.runningCheck((function(){}),(function(){return e()}))}))}return Promise.resolve()}},{key:"isMutedPopupAllowed",value:function e(){if(!this.allowMutePopup||!this.currentCall){return false}var t=this.currentCall.currentRoom&&this.currentCall.currentRoom();return!t||t.speaker==this.userId}},{key:"isConferencePageOpened",value:function e(t){var i=h.LocalStorage.get(Gr.getSiteId(),Gr.getCurrentUserId(),Gr.getConferencePageTag(t),"N");return i==="Y"}},{key:"showIncomingCall",value:function e(t){if(!l.Type.isPlainObject(t)){t={}}t.video=t.video===true;if(this.feedbackPopup){this.feedbackPopup.close()}var i=this.callWithLegacyMobile?t.video===true:true;this.callNotification=new Xo({callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,callerType:this.currentCall.associatedEntity.advanced.chatType,callerColor:this.currentCall.associatedEntity.avatarColor,video:t.video,hasCamera:i,zIndex:this.messengerFacade.getDefaultZIndex()+200,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallNotificationButtonClick.bind(this)});this.callNotification.show();this.scheduleCancelNotification();this.messengerFacade.repeatSound("ringtone",3500,true)}},{key:"showIncomingConference",value:function e(){this.callNotification=new sl({zIndex:this.messengerFacade.getDefaultZIndex()+200,callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,callerColor:this.currentCall.associatedEntity.avatarColor,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallConferenceNotificationButtonClick.bind(this)});this.callNotification.show();this.scheduleCancelNotification();this.messengerFacade.repeatSound("ringtone",3500,true)}},{key:"scheduleCancelNotification",value:function e(){var t=this;clearTimeout(this.hideIncomingCallTimeout);this.hideIncomingCallTimeout=setTimeout((function(){if(t.callNotification){t.callNotification.close()}if(t.currentCall){t.removeVideoStrategy();t.removeCallEvents();t.currentCall=null}}),30*1e3)}},{key:"showNotification",value:function e(t,i){if(!i){i=[]}BX.UI.Notification.Center.notify({content:l.Text.encode(t),position:"top-right",autoHideDelay:5e3,closeButton:true,actions:i})}},{key:"showNetworkProblemNotification",value:function e(t){BX.UI.Notification.Center.notify({content:l.Text.encode(t),position:"top-right",autoHideDelay:5e3,closeButton:true,actions:[{title:BX.message("IM_M_CALL_HELP"),events:{click:function e(t,i){top.BX.Helper.show("redirect=detail&code=12723718");i.close()}}}]})}},{key:"showUnsupportedNotification",value:function e(){var t;if(a.DesktopApi.isDesktop()){t=new n.MessageBox({message:BX.message("IM_CALL_DESKTOP_TOO_OLD"),buttons:n.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_M_CALL_BTN_UPDATE"),cancelCaption:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),onOk:function e(){var t=l.Browser.isMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe";window.open(t,"desktopApp");return true}})}else{t=new n.MessageBox({message:BX.message("IM_CALL_WEBRTC_USE_CHROME_OR_DESKTOP"),buttons:n.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_CALL_DETAILS"),cancelCaption:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),onOk:function e(){top.BX.Helper.show("redirect=detail&code=11387752");return true}})}t.show()}},{key:"isUserAgentSupported",value:function e(){if(a.DesktopApi.isDesktop()){return a.DesktopApi.getApiVersion()>48}if("VoxImplant"in window){return VoxImplant.getInstance().isRTCsupported()}return Do.isWebRTCSupported()}},{key:"getBlockedButtons",value:function e(){var t=["record"];if(!this.messengerFacade.showUserSelector){t.push("add")}return t}},{key:"startCall",value:function e(t,i){var n=this;if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}if(this.callView||this.currentCall){this.unfold();return}if(this.feedbackPopup){this.feedbackPopup.close()}var s=br.Plain;if(t.toString().startsWith("chat")){s=Do.getConferenceProvider()}var a=+new Date;this.messengerFacade.openMessenger(t).then((function(){return nt.init()})).then((function(){n.createContainer();var e=[];if(s===br.Plain){e.push("floorRequest")}if(!Do.shouldShowDocumentButton()){e.push("document")}n.callView=new Rt({container:n.container,baseZIndex:n.messengerFacade.getDefaultZIndex(),showChatButtons:true,userLimit:Do.getUserLimit(),language:n.language,layout:t.toString().startsWith("chat")?Rt.Layout.Grid:Rt.Layout.Centered,microphoneId:nt.defaultMicrophone,showShareButton:n.featureScreenSharing!==Pl.Disabled,showRecordButton:n.featureRecord!==Pl.Disabled,hiddenButtons:e,blockedButtons:n.getBlockedButtons()});n.bindCallViewEvents();if(i&&!nt.hasCamera()){n.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));i=false}return Gr.createCall({entityType:"chat",entityId:t,provider:s,videoEnabled:!!i,enableMicAutoParameters:nt.enableMicAutoParameters,joinExisting:true})})).then((function(e){var t=+new Date;n.currentCall=e.call;n.currentCallIsNew=e.isNew;n.log("Call creation time: "+(t-a)/1e3+" seconds");n.currentCall.useHdVideo(nt.preferHdQuality);if(nt.defaultMicrophone){n.currentCall.setMicrophoneId(nt.defaultMicrophone)}if(nt.defaultCamera){n.currentCall.setCameraId(nt.defaultCamera)}if(n.currentCall.associatedEntity&&n.currentCall.associatedEntity.id){if(n.messengerFacade.getCurrentDialogId()!=n.currentCall.associatedEntity.id){n.messengerFacade.openMessenger(n.currentCall.associatedEntity.id)}}n.autoCloseCallView=true;n.bindCallEvents();n.createVideoStrategy();n.callView.appendUsers(n.currentCall.getUsers());n.callView.show();n.updateCallViewUsers(n.currentCall.id,n.getCallUsers(true));n.showDocumentPromo();n.showMaskPromo();if(n.currentCallIsNew){n.log("Inviting users");n.currentCall.inviteUsers();n.messengerFacade.repeatSound("dialtone",5e3,true)}else{n.log("Joining existing call");n.currentCall.answer({useVideo:i})}}))["catch"]((function(e){console.error(e);var t;if(typeof e=="string"){t=e}else if(babelHelpers["typeof"](e)=="object"&&e.code){t=e.code=="access_denied"?"ACCESS_DENIED":e.code}else{t="UNKNOWN_ERROR"}n._onCallFailure({code:t,message:e.message||""})}))}},{key:"joinCall",value:function e(t,i,n){var s=this;var a=BX.prop.getBoolean(n,"joinAsViewer",false);if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}if(this.callView||this.currentCall){return}var r;this.log("Joining call "+t);Gr.getCallWithId(t).then((function(e){s.currentCall=e.call;r=s.currentCall.associatedEntity.id.toString().startsWith("chat");return s.messengerFacade.openMessenger()})).then((function(){return nt.init()})).then((function(){s.createContainer();var e=[];if(s.currentCall instanceof Ci){e.push("floorRequest")}if(!Do.shouldShowDocumentButton()){e.push("document")}s.callView=new Rt({container:s.container,baseZIndex:s.messengerFacade.getDefaultZIndex(),showChatButtons:true,userLimit:Do.getUserLimit(),language:s.language,layout:r?Rt.Layout.Grid:Rt.Layout.Centered,showRecordButton:s.featureRecord!==Pl.Disabled,microphoneId:nt.defaultMicrophone,hiddenButtons:e,blockedButtons:s.getBlockedButtons()});s.autoCloseCallView=true;s.bindCallViewEvents();s.callView.appendUsers(s.currentCall.getUsers());s.updateCallViewUsers(s.currentCall.id,s.getCallUsers(true));s.callView.show();s.showDocumentPromo();s.currentCall.useHdVideo(nt.preferHdQuality);if(nt.defaultMicrophone){s.currentCall.setMicrophoneId(nt.defaultMicrophone)}if(nt.defaultCamera){s.currentCall.setCameraId(nt.defaultCamera)}s.bindCallEvents();s.createVideoStrategy();if(i&&!nt.hasCamera()){s.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));i=false}if(s.getCallUsers(true).length>s.getMaxActiveMicrophonesCount()){s.currentCall.setMuted(true);s.callView.setMuted(true);s.showAutoMicMuteNotification()}s.currentCall.answer({useVideo:!!i,joinAsViewer:a})}))}},{key:"leaveCurrentCall",value:function e(){if(this.callView){this.callView.releaseLocalMedia()}if(this.currentCall){this.currentCall.hangup()}if(this.callView){this.callView.close()}}},{key:"hasActiveCall",value:function e(){return!!(this.currentCall&&this.currentCall.isAnyoneParticipating()||this.callView)}},{key:"hasVisibleCall",value:function e(){return!!(this.callView&&this.callView.visible&&this.callView.size==Rt.Size.Full)}},{key:"canRecord",value:function e(){return a.DesktopApi.isDesktop()&&a.DesktopApi.getApiVersion()>=54}},{key:"isRecording",value:function e(){return this.canRecord()&&this.callRecordState!=Rt.RecordState.Stopped}},{key:"useDevicesInCurrentCall",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.currentCall||!this.currentCall.ready){return}for(var n=0;n<t.length;n++){var s=t[n];switch(s.kind){case"audioinput":if(s.deviceId==="default"||i){var a=nt.getDefaultDeviceIdByGroupId(s.groupId,"audioinput");this.currentCall.setMicrophoneId(a);if(this.currentCall instanceof Rs){this.callView.setMicrophoneId(a)}}break;case"videoinput":if(s.deviceId==="default"||i){this.currentCall.setCameraId(s.deviceId)}break;case"audiooutput":if(this.callView&&s.deviceId==="default"||i){var r=nt.getDefaultDeviceIdByGroupId(s.groupId,"audiooutput");this.callView.setSpeakerId(r)}break}}}},{key:"removeDevicesFromCurrentCall",value:function e(t){if(!this.currentCall||!this.currentCall.ready){return}for(var i=0;i<t.length;i++){var n=t[i];switch(n.kind){case"audioinput":if(this.currentCall.microphoneId==n.deviceId){var s=Object.keys(nt.microphoneList);var a=void 0;if(s.includes("default")){var r=nt.getDeviceGroupIdByDeviceId("default","audioinput");a=nt.getDefaultDeviceIdByGroupId(r,"audioinput")}else{a=s.length>0?s[0]:""}this.currentCall.setMicrophoneId(a);if(this.currentCall instanceof Rs){this.callView.setMicrophoneId(a)}}break;case"videoinput":if(this.currentCall.cameraId==n.deviceId){var o=Object.keys(nt.cameraList);this.currentCall.setCameraId(o.length>0?o[0]:"")}break;case"audiooutput":if(this.callView&&this.callView.speakerId==n.deviceId){var l=Object.keys(nt.audioOutputList);if(l.includes("default")){var c=nt.getDeviceGroupIdByDeviceId("default","audiooutput");var d=nt.getDefaultDeviceIdByGroupId(c,"audiooutput");this.callView.setSpeakerId(d)}else{this.callView.setSpeakerId(l.length>0?l[0]:"")}}break}}}},{key:"showChat",value:function e(){var t=this;if(a.DesktopApi.isDesktop()&&this.floatingWindow){this.detached=true;this.callView.hide();this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);Do.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e);t.floatingWindow.show()}));this.container.style.width=0}else{this.fold(l.Text.decode(this.currentCall.associatedEntity.name))}}},{key:"fold",value:function e(t){if(this.folded||a.DesktopApi.isDesktop()&&this.floatingWindow){return}if(!t&&this.currentCall){t=l.Text.decode(this.currentCall.associatedEntity.name)}this.folded=true;if(this.resizeObserver){this.resizeObserver.unobserve(this.container)}this.container.classList.add("bx-messenger-call-overlay-folded");this.callView.setTitle(t);this.callView.setSize(Rt.Size.Folded);this.callViewState=El.Folded;if(this.sidebar){this.sidebar.toggleHidden(true)}this.closePromo();BX.onCustomEvent(this,"CallController::onFold",{})}},{key:"setCallEditorMaxWidth",value:function e(t){if(t!=this.maxEditorWidth){this.maxEditorWidth=t;this._onResize()}}},{key:"findCallEditorWidth",value:function e(){var t=this.container.clientWidth;var i=t<this.maxEditorWidth+Rt.MIN_WIDTH?t-Rt.MIN_WIDTH:this.maxEditorWidth;var n=t-i;return{callWidth:n,editorWidth:i}}},{key:"showDocumentsMenu",value:function e(){var t=this;var i=this.callView.buttons.document.elements.root.offsetWidth;var n=Do.getResumesArticleCode();var s=Do.getDocumentsArticleCode();var a=[{text:BX.message("IM_M_CALL_MENU_CREATE_RESUME"),onclick:function e(){t.documentsMenu.close();t.maybeShowDocumentEditor({type:Rl.Resume},n)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE"),items:[{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_DOC"),onclick:function e(){t.documentsMenu.close();t.maybeShowDocumentEditor({type:Rl.Blank,typeFile:Al},s)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_XLS"),onclick:function e(){t.documentsMenu.close();t.maybeShowDocumentEditor({type:Rl.Blank,typeFile:Nl},s)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_PPT"),onclick:function e(){t.documentsMenu.close();t.maybeShowDocumentEditor({type:Rl.Blank,typeFile:Ul},s)}}]}];if(!n){a.push({text:BX.message("IM_M_CALL_MENU_OPEN_LAST_RESUME"),cacheable:true,items:[{id:"loading",text:BX.message("IM_M_CALL_MENU_LOADING_RESUME_LIST")}],events:{onSubMenuShow:function e(i){return t.buildPreviousResumesSubmenu(i.target)}}})}this.documentsMenu=new BX.PopupMenuWindow({angle:false,bindElement:this.callView.buttons.document.elements.root,targetContainer:this.container,offsetTop:-15,bindOptions:{position:"top"},cacheable:false,subMenuOptions:{maxWidth:450},events:{onShow:function e(t){var n=t.getTarget();n.getPopupContainer().style.display="block";var s=i/2-n.getPopupContainer().offsetWidth/2;n.setOffset({offsetLeft:s+40});n.setAngle({offset:n.getPopupContainer().offsetWidth/2-17})},onDestroy:function e(){return t.documentsMenu=null}},items:a});this.documentsMenu.show()}},{key:"buildPreviousResumesSubmenu",value:function e(t){var i=this;BX.ajax.runAction("disk.api.integration.messengerCall.listResumesInChatByCall",{data:{callId:this.currentCall.id}}).then((function(e){var n=e.data.resumes;if(n.length>0){n.forEach((function(e){t.getSubMenu().addMenuItem({id:e.id,text:e.object.createDate+": "+e.object.name,onclick:function t(){i.documentsMenu.close();i.viewDocumentByLink(e.links.view)}})}))}else{t.getSubMenu().addMenuItem({id:"nothing",text:BX.message("IM_M_CALL_MENU_NO_RESUME"),disabled:true})}t.getSubMenu().removeMenuItem("loading");t.adjustSubMenu()}))}},{key:"maybeShowDocumentEditor",value:function e(t,i){if(i){if(i){BX.UI.InfoHelper.show(i);return}}this.showDocumentEditor(t)}},{key:"showDocumentEditor",value:function e(t){var i=this;t=t||{};var n=true;if(this.sidebar){if(t.force){this.sidebar.close(false);this.sidebar.destroy();this.sidebar=null;n=false}else{return}}if(this.callView){this.callView.setButtonActive("document",true)}clearTimeout(this.showPromoPopupTimeout);this._createAndOpenSidebarWithIframe("about:blank",n);BX.loadExt("disk.onlyoffice-im-integration").then((function(){var e=new BX.Disk.OnlyOfficeImIntegration.CreateDocument({dialog:{id:i.currentCall.associatedEntity.id},call:{id:i.currentCall.id},delegate:{setMaxWidth:i.setCallEditorMaxWidth.bind(i),onDocumentCreated:i._onDocumentCreated.bind(i)}});var n;if(t.type===Rl.Resume){n=e.getIframeUrlForTemplates()}else if(t.type===Rl.Blank){n=e.getIframeUrlForCreate({typeFile:t.typeFile})}else{n=e.getIframeUrl({viewerItem:t.viewerItem})}n.then((function(e){i.docEditorIframe.src=e}))["catch"]((function(e){console.error(e);i.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));i.docEditor=e}))["catch"]((function(e){console.error(e);i.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));if(this.resizeObserver){this.resizeObserver.observe(this.container)}}},{key:"closeDocumentEditor",value:function e(){var t=this;return new Promise((function(e){if(t.docEditor&&t.docEditorIframe){t.docEditor.onCloseIframe(t.docEditorIframe)}if(t.container&&t.resizeObserver){t.resizeObserver.unobserve(t.container)}if(t.callView){t.callView.setButtonActive("document",false);t.callView.removeMaxWidth()}if(!t.sidebar){return e()}var i=t.sidebar;t.sidebar=null;i.close().then((function(){t.docEditor=null;t.docEditorIframe=null;i.destroy();t.maxEditorWidth=t.docCreatedForCurrentCall?Bl:Hl;if(!t.callView){t.removeContainer();e()}}))}))}},{key:"viewDocumentByLink",value:function e(t){if(this.sidebar){return}if(this.callView){this.callView.setButtonActive("document",true)}this.maxEditorWidth=Bl;this._createAndOpenSidebarWithIframe(t)}},{key:"_createAndOpenSidebarWithIframe",value:function e(t,i){var n=this;i=i===true;var s=this.findCallEditorWidth();var a=s.callWidth;var r=s.editorWidth;this.callView.setMaxWidth(a);this.sidebar=new bl({container:this.container,width:r,events:{onCloseClicked:this.onSideBarCloseClicked.bind(this)}});this.sidebar.open(i);var o=new BX.Loader({target:this.sidebar.elements.contentContainer});o.show();var l=BX.create("iframe",{attrs:{src:t,frameborder:"0"},style:{display:"none",border:"0",margin:"0",width:"100%",height:"100%"}});l.addEventListener("load",(function(){o.destroy();l.style.display="block"}),{once:true});l.addEventListener("error",(function(e){console.error(e);n.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));this.sidebar.elements.contentContainer.appendChild(l);this.docEditorIframe=l}},{key:"_onDocumentCreated",value:function e(){this.docCreatedForCurrentCall=true;if(this.currentCall){this.currentCall.sendCustomMessage(Dl,true)}}},{key:"onSideBarCloseClicked",value:function e(){this.closeDocumentEditor()}},{key:"_ensureDocumentEditorClosed",value:function e(){var t=this;return new Promise((function(e,i){if(!t.sidebar){return e()}var s=new n.MessageBox({message:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_TO_ANSWER"),buttons:n.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_YES"),cancelCaption:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_NO"),onOk:function i(){t.closeDocumentEditor().then((function(){return e()}));return true},onCancel:function e(){i();return true}});s.show()}))}},{key:"onDocumentPromoActionClicked",value:function e(){this.closePromo();var t=Do.getResumesArticleCode();if(t){BX.UI.InfoHelper.show(t);return}this.showDocumentEditor({type:Rl.Resume})}},{key:"onDocumentPromoClosed",value:function e(t){var i=t.getData();if(i.dontShowAgain){this.emit(Tl.onPromoViewed,{code:Ll})}this.documentPromoPopup=null}},{key:"unfold",value:function e(){if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false;if(this.floatingWindow){this.floatingWindow.hide()}}if(this.folded){this.folded=false;this.container.classList.remove("bx-messenger-call-overlay-folded");this.callView.setSize(Rt.Size.Full);this.callViewState=El.Opened;if(this.sidebar){this.sidebar.toggleHidden(false);if(this.resizeObserver){this.resizeObserver.observe(this.container)}}}BX.onCustomEvent(this,"CallController::onUnfold",{})}},{key:"isFullScreen",value:function e(){if("webkitFullscreenElement"in document){return!!document.webkitFullscreenElement}else if("fullscreenElement"in document){return!!document.fullscreenElement}return false}},{key:"toggleFullScreen",value:function e(){if(this.isFullScreen()){this.exitFullScreen()}else{this.enterFullScreen()}}},{key:"enterFullScreen",value:function e(){if(this.messengerFacade.isSliderFocused()){BX.SidePanel.Instance.enterFullScreen()}else{if(l.Browser.isChrome()||l.Browser.isSafari()){document.body.webkitRequestFullScreen()}else if(l.Browser.isFirefox()){document.body.requestFullscreen()}}}},{key:"exitFullScreen",value:function e(){if(this.messengerFacade.isSliderFocused()){BX.SidePanel.Instance.exitFullScreen()}else{if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.exitFullscreen){document.exitFullscreen()}}}},{key:"showDocumentPromo",value:function e(){var t=this;if(!this.callView||!this.currentCall||!Do.shouldShowDocumentButton()){return false}if(!this.messengerFacade.isPromoRequired(Ll)){return false}var i=this.callView.buttons.document.elements.root;var n=i.querySelector(".bx-messenger-videocall-panel-icon");if(!n){return false}this.documentPromoPopup=new ml({bindElement:n,promoCode:Ll,events:{onActionClick:this.onDocumentPromoActionClicked.bind(this),onClose:this.onDocumentPromoClosed.bind(this)}});this.showPromoPopupTimeout=setTimeout((function(){if(t.folded){return false}t.documentPromoPopup.show()}),xl)}},{key:"showMaskPromo",value:function e(){var t=this;if(!this.callView||!this.currentCall||!v.isMaskAvailable()){return false}if(!this.messengerFacade.isPromoRequired(Vl)){return false}this.maskPromoPopup=new fl({callView:this.callView,events:{onClose:function e(i){t.emit(Tl.onPromoViewed,{code:Vl});t.maskPromoPopup=null}}});this.showPromoPopup3dTimeout=setTimeout((function(){if(!t.folded){t.maskPromoPopup.show()}}),Fl)}},{key:"closePromo",value:function e(){if(this.documentPromoPopup){this.documentPromoPopup.close()}if(this.maskPromoPopup){this.maskPromoPopup.close()}clearTimeout(this.showPromoPopupTimeout);clearTimeout(this.showPromoPopup3dTimeout)}},{key:"_startRecordCall",value:function e(t){this.callView.setButtonActive("record",true);this.callRecordType=t;this.currentCall.sendRecordState({action:Rt.RecordState.Started,date:new Date});this.callRecordState=Rt.RecordState.Started}},{key:"_onCallNotificationClose",value:function e(){clearTimeout(this.hideIncomingCallTimeout);this.messengerFacade.stopRepeatSound("ringtone");if(this.callNotification){this.callNotification.destroy()}}},{key:"_onCallNotificationDestroy",value:function e(){this.messengerFacade.stopRepeatSound("ringtone");this.callNotification=null}},{key:"_onCallNotificationButtonClick",value:function e(t){var i=t.data;clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(i.button){case"answer":if(this.currentCall){this.answeredOrDeclinedCalls.add(this.currentCall.id)}this._onAnswerButtonClick(i.video);break;case"decline":if(this.currentCall){this.answeredOrDeclinedCalls.add(this.currentCall.id);this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null}break}}},{key:"_onAnswerButtonClick",value:function e(t){var i=this;if(a.DesktopApi.isDesktop()){a.DesktopApi.activateWindow()}if(!this.isUserAgentSupported()){this.log("Error: unsupported user agent");this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null;this.showUnsupportedNotification();return}if(this.callView){this.callView.destroy()}var n=this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id?this.currentCall.associatedEntity.id:false;var s=n.toString().startsWith("chat");this._ensureDocumentEditorClosed().then((function(){return i.messengerFacade.openMessenger(n)})).then((function(){return nt.init()})).then((function(){i.createContainer();var e=[];if(i.currentCall instanceof Ci){e.push("floorRequest")}if(!Do.shouldShowDocumentButton()){e.push("document")}i.callView=new Rt({container:i.container,baseZIndex:i.messengerFacade.getDefaultZIndex(),users:i.currentCall.users,userStates:i.currentCall.getUsers(),showChatButtons:true,showRecordButton:i.featureRecord!==Pl.Disabled,userLimit:Do.getUserLimit(),layout:s?Rt.Layout.Grid:Rt.Layout.Centered,microphoneId:nt.defaultMicrophone,blockedButtons:i.getBlockedButtons(),hiddenButtons:e});i.autoCloseCallView=true;if(i.callWithLegacyMobile){i.callView.blockAddUser()}i.bindCallViewEvents();i.updateCallViewUsers(i.currentCall.id,i.getCallUsers(true));i.callView.show();i.showDocumentPromo();i.showMaskPromo();i.currentCall.useHdVideo(nt.preferHdQuality);if(nt.defaultMicrophone){i.currentCall.setMicrophoneId(nt.defaultMicrophone)}if(nt.defaultCamera){i.currentCall.setCameraId(nt.defaultCamera)}if(i.getCallUsers(true).length>i.getMaxActiveMicrophonesCount()){i.currentCall.setMuted(true);i.callView.setMuted(true);i.showAutoMicMuteNotification()}i.currentCall.answer({useVideo:t&&nt.hasCamera(),enableMicAutoParameters:nt.enableMicAutoParameters});i.createVideoStrategy()}))}},{key:"_onCallConferenceNotificationButtonClick",value:function e(t){clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(t.button){case"answerConference":if(this.currentCall&&"id"in this.currentCall.associatedEntity){this.answeredOrDeclinedCalls.add(this.currentCall.id);var i=this.currentCall.associatedEntity.id.toString();if(i.startsWith("chat")){i=i.substring(4)}this.emit(Tl.onOpenVideoConference,{dialogId:i})}break;case"skipConference":if(this.currentCall){this.answeredOrDeclinedCalls.add(this.currentCall.id);this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null}break}}},{key:"_onCallViewShow",value:function e(){this.callView.setButtonCounter("chat",this.messengerFacade.getMessageCount());this.callViewState=El.Opened}},{key:"_onCallViewClose",value:function e(){this.callView.destroy();this.callViewState=El.Closed;if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.documentsMenu){this.documentsMenu.close()}if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow(a.DesktopApi.findWindow("callBackground"))}this.closePromo();this._closeReconnectionBaloon()}},{key:"_onCallViewDestroy",value:function e(){this.callView=null;this.folded=false;this.autoCloseCallView=true;if(this.sidebar){BX.adjust(this.container,{style:{backgroundColor:"rgba(0, 0, 0, 0.5)",backdropFilter:"blur(5px)"}})}else{this.removeContainer();this.maxEditorWidth=Hl}}},{key:"_onCallViewBodyClick",value:function e(){if(this.folded){this.unfold()}}},{key:"_onCallViewButtonClick",value:function e(t){var i=t.buttonName;var n={hangup:this._onCallViewHangupButtonClick.bind(this),close:this._onCallViewCloseButtonClick.bind(this),inviteUser:this._onCallViewInviteUserButtonClick.bind(this),toggleMute:this._onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this._onCallViewToggleScreenSharingButtonClick.bind(this),record:this._onCallViewRecordButtonClick.bind(this),toggleVideo:this._onCallViewToggleVideoButtonClick.bind(this),toggleSpeaker:this._onCallViewToggleSpeakerButtonClick.bind(this),showChat:this._onCallViewShowChatButtonClick.bind(this),floorRequest:this._onCallViewFloorRequestButtonClick.bind(this),showHistory:this._onCallViewShowHistoryButtonClick.bind(this),fullscreen:this._onCallViewFullScreenButtonClick.bind(this),document:this._onCallViewDocumentButtonClick.bind(this),microphoneSideIcon:this._onCallViewMicrophoneSideIconClick.bind(this)};if(l.Type.isFunction(n[i])){n[i].call(this,t)}}},{key:"_onCallViewHangupButtonClick",value:function e(){this.leaveCurrentCall()}},{key:"_onCallViewCloseButtonClick",value:function e(){if(this.callView){this.callView.close()}}},{key:"_onCallViewShowChatButtonClick",value:function e(){this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id);this.showChat()}},{key:"_onCallViewFloorRequestButtonClick",value:function e(){var t=this;var i=this.callView.getUserFloorRequestState(Gr.getCurrentUserId());var n=this.callView.getUserTalking(Gr.getCurrentUserId());this.callView.setUserFloorRequestState(Gr.getCurrentUserId(),!i);if(this.currentCall){this.currentCall.requestFloor(!i)}clearTimeout(this.callViewFloorRequestTimeout);if(n&&!i){this.callViewFloorRequestTimeout=setTimeout((function(){if(t.currentCall){t.currentCall.requestFloor(false)}}),1500)}}},{key:"_getDisconnectedUsers",value:function e(){var t=[];var i=this.currentCall.getUsers();for(var n in i){if(i[n]!==mr.Connected){var s=Do.getUserCached(n);if(s){t.push(s)}}}return t}},{key:"_closeReconnectionBaloon",value:function e(){if(this.reconnectionBaloon){this.reconnectionBaloon.close();this.reconnectionBaloon=null}}},{key:"_onCallViewInviteUserButtonClick",value:function e(t){var i=this;if(!this.messengerFacade.showUserSelector){return}var n=this.currentCall?this.currentCall.getUsers():{};var s=this.currentCall?this._getDisconnectedUsers():[];this.messengerFacade.showUserSelector({viewElement:this.callView.container,bindElement:t.node,zIndex:this.messengerFacade.getDefaultZIndex()+200,darkMode:this.messengerFacade.isThemeDark(),idleUsers:s,allowNewUsers:Object.keys(n).length<Do.getUserLimit()-1,onDestroy:this._onInvitePopupDestroy.bind(this),onSelect:this._onInvitePopupSelect.bind(this)}).then((function(e){i.invitePopup=e;i.callView.setHotKeyTemporaryBlock(true)}))}},{key:"_onCallViewToggleMuteButtonClick",value:function e(t){var i=this.currentCall.currentRoom&&this.currentCall.currentRoom();if(i&&i.speaker!=this.userId&&!t.muted){this.currentCall.requestRoomSpeaker();return}this.currentCall.setMuted(t.muted);this.callView.setMuted(t.muted);if(this.floatingWindow){this.floatingWindow.setAudioMuted(t.muted)}if(this.mutePopup){this.mutePopup.close()}if(!t.muted){this.allowMutePopup=true}if(this.isRecording()){BXDesktopSystem.CallRecordMute(t.muted)}}},{key:"_onCallViewRecordButtonClick",value:function e(t){var i=this;if(t.recordState===Rt.RecordState.Started){if(this.featureRecord===Pl.Limited){this.messengerFacade.openHelpArticle("call_record");return}if(this.featureRecord===Pl.Disabled){return}if(this.canRecord()){var n=BX.prop.getBoolean(t,"forceRecord",Rt.RecordType.None);if(n!==Rt.RecordType.None){this._startRecordCall(n)}else if(a.DesktopApi.isDesktop()&&a.DesktopApi.getApiVersion()>55){if(!this.callRecordMenu){this.callRecordMenu=new BX.PopupMenuWindow({bindElement:t.node,targetContainer:this.callView.container,items:[{text:BX.message("IM_M_CALL_MENU_RECORD_VIDEO"),onclick:function e(t,n){i._startRecordCall(Rt.RecordType.Video);n.getMenuWindow().close()}},{text:BX.message("IM_M_CALL_MENU_RECORD_AUDIO"),onclick:function e(t,n){i._startRecordCall(Rt.RecordType.Audio);n.getMenuWindow().close()}}],autoHide:true,angle:{position:"top",offset:80},offsetTop:0,offsetLeft:-25,events:{onPopupClose:function e(){return i.callRecordMenu.destroy()},onPopupDestroy:function e(){return i.callRecordMenu=null}}})}this.callRecordMenu.toggle();return}this.callView.setButtonActive("record",true)}else{if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=12398134")}return}}else if(t.recordState===Rt.RecordState.Paused){if(this.canRecord()){BXDesktopSystem.CallRecordPause(true)}}else if(t.recordState===Rt.RecordState.Resumed){if(this.canRecord()){BXDesktopSystem.CallRecordPause(false)}}else if(t.recordState===Rt.RecordState.Stopped){this.callView.setButtonActive("record",false)}this.currentCall.sendRecordState({action:t.recordState,date:new Date});this.callRecordState=t.recordState}},{key:"_onCallViewToggleScreenSharingButtonClick",value:function e(){if(this.featureScreenSharing===Pl.Limited){this.messengerFacade.openHelpArticle("call_screen_sharing");return}if(this.featureScreenSharing===Pl.Disabled){return}if(this.currentCall.isScreenSharingStarted()){if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.documentPromoPopup){this.documentPromoPopup.close()}this.currentCall.stopScreenSharing();if(this.isRecording()){BXDesktopSystem.CallRecordStopSharing()}}else{this.currentCall.startScreenSharing();Gr.getRestClient().callMethod("im.call.onShareScreen",{callId:this.currentCall.id})}}},{key:"_onCallViewToggleVideoButtonClick",value:function e(t){if(!nt.initialized){return}if(t.video&&Object.values(nt.cameraList).length===0){return}if(!t.video){this.callView.releaseLocalMedia()}this.currentCall.setVideoEnabled(t.video)}},{key:"_onCallViewToggleSpeakerButtonClick",value:function e(t){var i=this.currentCall.currentRoom&&this.currentCall.currentRoom();if(i&&i.speaker!=this.userId){alert("only room speaker can turn on sound");return}this.callView.muteSpeaker(!t.speakerMuted);if(t.fromHotKey){BX.UI.Notification.Center.notify({content:BX.message(this.callView.speakerMuted?"IM_M_CALL_MUTE_SPEAKERS_OFF":"IM_M_CALL_MUTE_SPEAKERS_ON"),position:"top-right",autoHideDelay:3e3,closeButton:true})}}},{key:"_onCallViewMicrophoneSideIconClick",value:function e(){var t=this.currentCall.currentRoom&&this.currentCall.currentRoom();if(t){this.toggleRoomMenu(this.callView.buttons.microphone.elements.icon)}else{this.toggleRoomListMenu(this.callView.buttons.microphone.elements.icon)}}},{key:"_onCallViewShowHistoryButtonClick",value:function e(){this.messengerFacade.openHistory(this.currentCall.associatedEntity.id)}},{key:"_onCallViewFullScreenButtonClick",value:function e(){if(this.folded){this.unfold()}this.toggleFullScreen()}},{key:"_onCallViewDocumentButtonClick",value:function e(){this.sidebar?this.closeDocumentEditor():this.showDocumentsMenu()}},{key:"_onCallViewReplaceCamera",value:function e(t){if(this.currentCall){this.currentCall.setCameraId(t.deviceId)}nt.defaultCamera=t.deviceId}},{key:"_onCallViewReplaceMicrophone",value:function e(t){if(this.currentCall){this.currentCall.setMicrophoneId(t.deviceId)}if(this.currentCall instanceof Xa||this.currentCall instanceof Rs){this.callView.setMicrophoneId(t.deviceId)}nt.defaultMicrophone=t.deviceId}},{key:"_onCallViewReplaceSpeaker",value:function e(t){nt.defaultSpeaker=t.deviceId}},{key:"_onCallViewHasMainStream",value:function e(t){if(this.currentCall&&this.currentCall instanceof Rs){this.currentCall.setMainStream(t.userId)}}},{key:"_onCallViewChangeHdVideo",value:function e(t){nt.preferHdQuality=t.allowHdVideo}},{key:"_onCallViewChangeMicAutoParams",value:function e(t){nt.enableMicAutoParameters=t.allowMicAutoParams}},{key:"_onCallViewChangeFaceImprove",value:function e(t){if(!a.DesktopApi.isDesktop()){return}a.DesktopApi.setCameraSmoothingStatus(t.faceImproveEnabled)}},{key:"_onCallViewOpenAdvancedSettings",value:function e(){this.messengerFacade.openSettings({onlyPanel:"hardware"})}},{key:"_onCallViewSetCentralUser",value:function e(t){if(t.stream&&this.floatingWindow){this.floatingWindowUser=t.userId}}},{key:"_onCallUserInvited",value:function e(t){if(this.callView){this.updateCallViewUsers(this.currentCall.id,[t.userId]);this.callView.addUser(t.userId)}}},{key:"_onCallDestroy",value:function e(){var t;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();t=_l(this,Xl,zl).call(this,this.currentCall);this.currentCall=null}this.callWithLegacyMobile=false;if(this.callNotification){this.callNotification.close()}if(this.invitePopup){this.invitePopup.close()}if(this.isRecording()){BXDesktopSystem.CallRecordStop()}this.callRecordState=Rt.RecordState.Stopped;this.callRecordType=Rt.RecordType.None;if(this.callRecordMenu){this.callRecordMenu.close()}if(this.callView&&this.autoCloseCallView){this.callView.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.mutePopup){this.mutePopup.close()}if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow(a.DesktopApi.findWindow("callBackground"))}this.closePromo();this.allowMutePopup=true;this.docCreatedForCurrentCall=false;this._closeReconnectionBaloon();this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound("ringtone");this.emit(Tl.onCallDestroyed,{callDetails:t})}},{key:"_onCallUserStateChanged",value:function e(t){var i=this;setTimeout(this.updateFloatingWindowContent.bind(this),100);if(this.callView){this.callView.setUserState(t.userId,t.state);if(t.isLegacyMobile){this.callView.blockAddUser();this.callView.blockSwitchCamera();this.callView.blockScreenSharing();this.callView.disableMediaSelection();this.callView.updateButtons()}}if(t.state==mr.Connecting||t.state==mr.Connected){this.messengerFacade.stopRepeatSound("dialtone")}if(t.state==mr.Connected){if(!t.isLegacyMobile){this.callView.unblockButtons(["camera","floorRequest","screen"])}if(this.callRecordState===Rt.RecordState.Stopped){this.callView.unblockButtons(["record"])}}else if(t.state==mr.Idle&&t.previousState==mr.Connected);else if(t.state==mr.Failed){if(t.networkProblem){this.showNetworkProblemNotification(BX.message("IM_M_CALL_TURN_UNAVAILABLE"))}else{Do.getUser(this.currentCall.id,t.userId).then((function(e){i.showNotification(Do.getCustomMessage("IM_M_CALL_USER_FAILED",{gender:e.gender,name:e.name}))}))}}else if(t.state==mr.Declined){Do.getUser(this.currentCall.id,t.userId).then((function(e){i.showNotification(Do.getCustomMessage("IM_M_CALL_USER_DECLINED",{gender:e.gender,name:e.name}))}))}else if(t.state==mr.Busy){Do.getUser(this.currentCall.id,t.userId).then((function(e){i.showNotification(Do.getCustomMessage("IM_M_CALL_USER_BUSY",{gender:e.gender,name:e.name}))}))}}},{key:"_onCallUserMicrophoneState",value:function e(t){if(!this.callView){return}this.callView.setUserMicrophoneState(t.userId,t.microphoneState)}},{key:"_onCallUserCameraState",value:function e(t){if(!this.callView){return}this.callView.setUserCameraState(t.userId,t.cameraState)}},{key:"_onCameraPublishing",value:function e(t){if(!this.callView){return}if(t.publishing){this.callView.blockSwitchCamera();this.callView.updateButtons()}else{this.callView.unblockSwitchCamera();this.callView.updateButtons()}}},{key:"_onMicrophonePublishingd",value:function e(t){if(!this.callView){return}if(t.publishing){this.callView.blockSwitchMicrophone();this.callView.updateButtons()}else{this.callView.unblockSwitchMicrophone();this.callView.updateButtons()}}},{key:"_onCallUserVideoPaused",value:function e(t){if(!this.callView){return}this.callView.setUserVideoPaused(t.userId,t.videoPaused)}},{key:"_onCallLocalMediaReceived",value:function e(t){this.log("Received local media stream "+t.tag);if(this.callView){var i=t.tag=="main"||t.mediaRenderer?nt.enableMirroring:false;this.callView.setLocalStream(t);this.callView.flipLocalVideo(i);this.callView.setButtonActive("screen",this.currentCall.isScreenSharingStarted());if(this.currentCall.isScreenSharingStarted()){if(!a.DesktopApi.isDesktop()){this.showWebScreenSharePopup()}this.callView.blockSwitchCamera();this.callView.updateButtons()}else{if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.isRecording()){BXDesktopSystem.CallRecordStopSharing()}if(!this.currentCall.callFromMobile){this.callView.unblockSwitchCamera();this.callView.updateButtons()}}}if(this.currentCall&&this.currentCall.videoEnabled&&t.tag==="main"&&t.stream.getVideoTracks().length===0){this.showNotification(BX.message("IM_CALL_CAMERA_ERROR_FALLBACK_TO_MIC"));this.currentCall.setVideoEnabled(false)}}},{key:"_onCallLocalCameraFlip",value:function e(t){this._onCallLocalCameraFlipInDesktop(t.data.enableMirroring)}},{key:"_onCallLocalCameraFlipInDesktop",value:function e(t){console.error("FLIPPING LOCAL VIDEO");if(this.callView){this.callView.flipLocalVideo(t)}}},{key:"_onCallLocalMediaStopped",value:function e(t){}},{key:"_onCallRemoteMediaReceived",value:function e(t){if(this.callView){if("track"in t){this.callView.setUserMedia(t.userId,t.kind,t.track)}if("mediaRenderer"in t&&t.mediaRenderer.kind==="audio"){this.callView.setUserMedia(t.userId,"audio",t.mediaRenderer.stream.getAudioTracks()[0])}if("mediaRenderer"in t&&(t.mediaRenderer.kind==="video"||t.mediaRenderer.kind==="sharing")){this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}}},{key:"_onCallRemoteMediaStopped",value:function e(t){if(this.callView){if("mediaRenderer"in t){if(t.kind==="video"||t.kind==="sharing"){t.mediaRenderer.stream=null;this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}else{this.callView.setUserMedia(t.userId,t.kind,null)}}}},{key:"_onCallBadNetworkIndicator",value:function e(t){if(this.callView){this.callView.setBadNetworkIndicator(t.userId,t.badNetworkIndicator)}}},{key:"_onCallConnectionQualityChanged",value:function e(t){if(this.callView){this.callView.setUserHasConnectionProblem(t.userId,t.hasConnectionProblem)}}},{key:"_onCallUserVoiceStarted",value:function e(t){if(t.local){if(this.currentCall.muted&&this.isMutedPopupAllowed()){this.showMicMutedNotification()}return}this.talkingUsers[t.userId]=true;if(this.callView){this.callView.setUserTalking(t.userId,true);this.callView.setUserFloorRequestState(t.userId,false)}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map((function(e){return Number(e)})))}}},{key:"_onCallUserVoiceStopped",value:function e(t){if(t.local){return}if(this.talkingUsers[t.userId]){delete this.talkingUsers[t.userId]}if(this.callView){this.callView.setUserTalking(t.userId,false)}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map((function(e){return Number(e)})))}}},{key:"_onUserStatsReceived",value:function e(t){if(this.callView){this.callView.setUserStats(t.userId,t.report)}}},{key:"_onCallUserScreenState",value:function e(t){if(this.callView){this.callView.setUserScreenState(t.userId,t.screenState)}if(t.userId==Gr.getCurrentUserId()){this.callView.setButtonActive("screen",t.screenState);if(t.screenState){if(!a.DesktopApi.isDesktop()){this.showWebScreenSharePopup()}this.callView.blockSwitchCamera()}else{if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.isRecording()){BXDesktopSystem.CallRecordStopSharing()}if(!this.currentCall.callFromMobile){this.callView.unblockSwitchCamera();this.callView.updateButtons()}}this.callView.updateButtons()}}},{key:"_onCallUserRecordState",value:function e(t){this.callRecordState=t.recordState.state;this.callView.setRecordState(t.recordState);if(!this.canRecord()||t.userId!=BX.message["USER_ID"]){return true}if(t.recordState.state===Rt.RecordState.Started&&t.recordState.userId==BX.message["USER_ID"]){var i=Rt.RecordSource.Chat;var n=this.currentCall.associatedEntity.id;var s=this.currentCall.associatedEntity.name;var a=this.currentCall.id;var r=BX.date.format(this.formatRecordDate);var o=BX.message("IM_CALL_RECORD_NAME");if(o){o=o.replace("#CHAT_TITLE#",s).replace("#CALL_ID#",a).replace("#DATE#",r)}else{o="call_record_"+this.currentCall.id}Gr.getRestClient().callMethod("im.call.onStartRecord",{callId:this.currentCall.id});console.error("DIALOG ID",n);BXDesktopSystem.CallRecordStart({windowId:i,fileName:o,callId:a,callDate:r,dialogId:n,dialogName:s,video:this.callRecordType!==Rt.RecordType.Audio,muted:this.currentCall.isMuted(),cropTop:72,cropBottom:73,shareMethod:"im.disk.record.share"})}else if(t.recordState.state===Rt.RecordState.Stopped){BXDesktopSystem.CallRecordStop()}return true}},{key:"_onCallUserFloorRequest",value:function e(t){if(this.callView){this.callView.setUserFloorRequestState(t.userId,t.requestActive)}}},{key:"_onCallFailure",value:function e(t){var i=t.code||t.name||t.error;var n;if(t.name=="VoxConnectionError"||t.name=="AuthResult"){Do.reportConnectionResult(t.call.id,false)}if(t.name=="AuthResult"||i=="AUTHORIZE_ERROR"){n=BX.message("IM_CALL_ERROR_AUTHORIZATION")}else if(t.name=="Failed"&&i==403){n=BX.message("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")}else if(i=="ERROR_UNEXPECTED_ANSWER"){n=BX.message("IM_CALL_ERROR_UNEXPECTED_ANSWER")}else if(i=="BLANK_ANSWER_WITH_ERROR_CODE"){n=BX.message("IM_CALL_ERROR_BLANK_ANSWER")}else if(i=="BLANK_ANSWER"){n=BX.message("IM_CALL_ERROR_BLANK_ANSWER")}else if(i=="ACCESS_DENIED"){n=BX.message("IM_CALL_ERROR_ACCESS_DENIED")}else if(i=="NO_WEBRTC"){n=this.isHttps?BX.message("IM_CALL_NO_WEBRT"):BX.message("IM_CALL_ERROR_HTTPS_REQUIRED")}else if(i=="UNKNOWN_ERROR"){n=BX.message("IM_CALL_ERROR_UNKNOWN")}else if(i=="NETWORK_ERROR"){n=BX.message("IM_CALL_ERROR_NETWORK")}else if(i=="NotAllowedError"){n=BX.message("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")}else{n=BX.message("IM_CALL_ERROR_UNKNOWN_WITH_CODE").replace("#ERROR_CODE#",i)}if(this.callView){this.callView.showFatalError({text:n})}else{this.showNotification(n)}this.messengerFacade.stopRepeatSound("dialtone");this.autoCloseCallView=false;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();if(this.currentCallIsNew){Gr.getRestClient().callMethod("im.call.interrupt",{callId:this.currentCall.id})}this.currentCall.destroy();this.currentCall=null;this.currentCallIsNew=false}}},{key:"_onNetworkProblem",value:function e(){this.showNetworkProblemNotification(BX.message("IM_M_CALL_TURN_UNAVAILABLE"))}},{key:"_onMicrophoneLevel",value:function e(t){if(this.callView){this.callView.setMicrophoneLevel(t.level)}}},{key:"_onReconnecting",value:function e(){if(!(this.currentCall instanceof Rs||this.currentCall instanceof Ci)){return false}if(this.reconnectionBaloon){return}this.reconnectionBaloon=BX.UI.Notification.Center.notify({content:l.Text.encode(BX.message("IM_CALL_RECONNECTING")),autoHide:false,position:"top-right",closeButton:false})}},{key:"_onReconnected",value:function e(){if(!(this.currentCall instanceof Rs||this.currentCall instanceof Ci)){return false}this._closeReconnectionBaloon()}},{key:"_onCustomMessage",value:function e(t){if(t.message===Dl){this.docCreatedForCurrentCall=true;this.maxEditorWidth=Bl}}},{key:"_onJoinRoomOffer",value:function e(t){console.log("_onJoinRoomOffer",t);if(!t.initiator&&!this.currentCall.currentRoom()){this.currentCall.joinRoom(t.roomId);this.showRoomJoinedPopup(true,t.speaker==this.userId,t.users)}}},{key:"_onJoinRoom",value:function e(t){console.log("_onJoinRoom",t);if(t.speaker==this.userId){this.callView.setRoomState(Rt.RoomState.Speaker)}else{this.currentCall.setMuted(true);this.callView.setMuted(true);this.callView.muteSpeaker(true);this.callView.setRoomState(Rt.RoomState.NonSpeaker)}}},{key:"_onLeaveRoom",value:function e(){this.callView.setRoomState(Rt.RoomState.Speaker);this.callView.muteSpeaker(false)}},{key:"_onTransferRoomSpeaker",value:function e(t){console.log("_onTransferRoomSpeaker",t);if(t.speaker==this.userId){this.currentCall.setMuted(false);this.callView.setMuted(false);this.callView.setRoomState(Rt.RoomState.Speaker);if(t.initiator==this.userId){this.callView.muteSpeaker(false);this.showMicTakenFromPopup(t.previousSpeaker)}}else{this.currentCall.setMuted(true);this.callView.setMuted(true);this.callView.muteSpeaker(true);this.callView.setRoomState(Rt.RoomState.NonSpeaker);this.showMicTakenByPopup(t.speaker)}}},{key:"_onCallJoin",value:function e(t){if(t.local){if(this.currentCall&&this.currentCall instanceof Xa){Do.reportConnectionResult(this.currentCall.id,true)}return}if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}if(this.callView){this.callView.close()}if(this.callNotification){this.callNotification.close()}if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.mutePopup){this.mutePopup.close()}this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound("ringtone")}},{key:"_onCallLeave",value:function e(t){console.log("_onCallLeave",t);if(!t.local&&this.currentCall&&this.currentCall.ready){this.log(new Error("received remote leave with active call!"));return}if(this.isRecording()){BXDesktopSystem.CallRecordStop()}this.callRecordState=Rt.RecordState.Stopped;this.callRecordType=Rt.RecordType.None;this.docCreatedForCurrentCall=false;var i;if(this.currentCall&&this.currentCall.associatedEntity){this.removeVideoStrategy();this.removeCallEvents();i=_l(this,Xl,zl).call(this,this.currentCall);this.currentCall=null}if(this.callView){this.callView.close()}if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.callNotification){this.callNotification.close()}if(this.mutePopup){this.mutePopup.close()}this.allowMutePopup=true;if(a.DesktopApi.isDesktop()){a.DesktopApi.closeWindow(a.DesktopApi.findWindow("callBackground"))}this.closePromo();this._closeReconnectionBaloon();this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound("ringtone");this.emit(Tl.onCallLeft,{callDetails:i})}},{key:"_onGetUserMediaEnded",value:function e(){nt.getCurrentDeviceList()}},{key:"_onCallUserFromWeb",value:function e(t){if(this.callView){this.callView.addUser(t.userId,mr.Connected);this.callView.updateUserData(babelHelpers.defineProperty({},t.userId,{name:t.name}))}}},{key:"_onInvitePopupDestroy",value:function e(){this.invitePopup=null;this.callView.setHotKeyTemporaryBlock(false)}},{key:"_onInvitePopupSelect",value:function e(t){var i=this;this.invitePopup.close();if(!this.currentCall){return}var n=t.user.id;if(Do.isCallServerAllowed()&&this.currentCall instanceof Ci){this.removeVideoStrategy();this.removeCallEvents();Gr.createChildCall(this.currentCall.id,Do.getConferenceProvider(),[n]).then((function(e){i.childCall=e.call;i.childCall.addEventListener(Sr.onRemoteMediaReceived,i._onChildCallFirstMediaHandler);i.childCall.addEventListener(Sr.onLocalMediaReceived,i._onCallLocalMediaReceivedHandler);i.childCall.useHdVideo(nt.preferHdQuality);if(i.currentCall.microphoneId){i.childCall.setMicrophoneId(i.currentCall.microphoneId)}if(i.currentCall.cameraId){i.childCall.setCameraId(i.currentCall.cameraId)}i.childCall.inviteUsers({users:i.childCall.users})}));this.callView.removeScreenUsers();this.callView.addUser(n,mr.Calling);this.callView.updateUserData(babelHelpers.defineProperty({},n,t.user))}else{var s=this.currentCall.getUsers();if(Object.keys(s).length<Do.getUserLimit()-1||s.hasOwnProperty(n)){this.currentCall.inviteUsers({users:[n]})}}}},{key:"_onWindowFocus",value:function e(){if(!this.detached){clearTimeout(this.showFloatingWindowTimeout);clearTimeout(this.showFloatingScreenShareWindowTimeout);if(this.floatingWindow){this.floatingWindow.hide()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}}},{key:"_onWindowBlur",value:function e(){var t=this;clearTimeout(this.showFloatingWindowTimeout);clearTimeout(this.showFloatingScreenShareWindowTimeout);if(this.currentCall&&this.floatingWindow&&this.callView){this.showFloatingWindowTimeout=setTimeout((function(){if(t.currentCall&&t.floatingWindow&&t.callView){t.floatingWindow.setTitle(t.currentCall.associatedEntity.name);Do.getUserAvatars(t.currentCall.id,t.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e);t.floatingWindow.show()}))}}),300)}if(this.currentCall&&this.floatingScreenShareWindow&&this.callView&&this.currentCall.isScreenSharingStarted()){this.showFloatingScreenShareWindowTimeout=setTimeout((function(){if(t.currentCall&&t.floatingScreenShareWindow&&t.callView&&t.currentCall.isScreenSharingStarted()){t.floatingScreenShareWindow.show()}}),300)}}},{key:"_onBeforeUnload",value:function e(t){if(this.floatingWindow){this.floatingWindow.close()}if(this.callNotification){this.callNotification.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.hasActiveCall()){t.preventDefault();t.returnValue=""}}},{key:"_onImTabChange",value:function e(t){if(t==="notify"&&this.currentCall&&this.callView){this.fold(l.Text.decode(this.currentCall.associatedEntity.name))}}},{key:"_onUpdateChatCounter",value:function e(t){if(!this.currentCall||!this.currentCall.associatedEntity||!this.currentCall.associatedEntity.id||!this.callView){return}this.callView.setButtonCounter("chat",t)}},{key:"_onDeviceChange",value:function e(t){var i=this;if(!this.currentCall||!this.currentCall.ready){return}var n=t.data.added;var s=t.data.removed;var a=nt.removeDevicesByDefaultGroup(t.data.added);var r=nt.removeDevicesByDefaultGroup(t.data.removed);if(a.length>0){this.log("New devices: ",a);BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_FOUND")+"<br><ul>"+a.map((function(e){return"<li>"+e.label}))+"</ul>",position:"top-right",autoHideDelay:2e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_USE"),events:{click:function e(t,n){i.useDevicesInCurrentCall(a,true);n.close()}}},{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function e(t,i){return i.close()}}}]})}if(n){setTimeout((function(){return i.useDevicesInCurrentCall(n)}),500)}if(r.length>0){this.log("Removed devices: ",r);BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_DETACHED")+"<br><ul>"+r.map((function(e){return"<li>"+e.label}))+"</ul>",position:"top-right",autoHideDelay:1e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function e(t,i){i.close()}}}]})}if(s){setTimeout((function(){return i.removeDevicesFromCurrentCall(s)}),500)}}},{key:"_onFloatingVideoMainAreaClick",value:function e(){a.DesktopApi.activateWindow();a.DesktopApi.changeTab("im");if(!this.currentCall){return}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id)}else if(!this.messengerFacade.isMessengerOpen()){this.messengerFacade.openMessenger()}if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false}}},{key:"_onFloatingVideoButtonClick",value:function e(t){switch(t.buttonName){case"toggleMute":this._onCallViewToggleMuteButtonClick(t);break;case"hangup":this._onCallViewHangupButtonClick();break}}},{key:"_onFloatingScreenShareBackToCallClick",value:function e(){a.DesktopApi.activateWindow();a.DesktopApi.changeTab("im");if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}},{key:"_onFloatingScreenShareStopClick",value:function e(){a.DesktopApi.activateWindow();a.DesktopApi.changeTab("im");this.currentCall.stopScreenSharing();if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.isRecording()){BXDesktopSystem.CallRecordStopSharing()}}},{key:"_onFloatingScreenShareChangeScreenClick",value:function e(){if(this.currentCall){this.currentCall.startScreenSharing(true)}}},{key:"_onResize",value:function e(){if(this.sidebar&&this.callView){var t=this.findCallEditorWidth();var i=t.callWidth;var n=t.editorWidth;this.callView.setMaxWidth(i);this.sidebar.setWidth(n)}}},{key:"destroy",value:function e(){if(this.floatingWindow){this.floatingWindow.destroy();this.floatingWindow=null}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.destroy();this.floatingScreenShareWindow=null}if(this.resizeObserver){this.resizeObserver.disconnect();this.resizeObserver=null}nt.unsubscribe(nt.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipHandler)}},{key:"log",value:function e(){if(this.currentCall){var t=[this.currentCall.id];Gr.log.apply(Gr,t.concat(Array.prototype.slice.call(arguments)))}else{Gr.log.apply(Gr,arguments)}}},{key:"test",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[473,464];var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{width:320,height:180};var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;this.messengerFacade.openMessenger().then((function(){return n||s?nt.init():null})).then((function(){t.createContainer();var e=["floorRequest"];if(!Do.shouldShowDocumentButton()){e.push("document")}t.callView=new Rt({container:t.container,baseZIndex:t.messengerFacade.getDefaultZIndex(),showChatButtons:true,userLimit:48,language:t.language,layout:Rt.Layout.Grid,hiddenButtons:e,blockedButtons:t.getBlockedButtons()});t.lastUserId=1;t.callView.setCallback("onButtonClick",(function(e){return t._onTestCallViewButtonClick(e)}));t.callView.setCallback(Rt.Event.onUserClick,(function(e){if(!e.stream){t.callView.setUserState(e.userId,mr.Connected);t.callView.setUserMedia(e.userId,"video",t.stream2.getVideoTracks()[0])}}));t.callView.setUiState(Rt.UiState.Connected);t.callView.setCallback(Rt.Event.onBodyClick,t._onCallViewBodyClick.bind(t));t.callView.setCallback("onShow",t._onCallViewShow.bind(t));t.callView.setCallback("onClose",t._onCallViewClose.bind(t));t.callView.setCallback("onReplaceMicrophone",(function(e){console.log("onReplaceMicrophone",e)}));t.callView.setCallback("onReplaceCamera",(function(e){console.log("onReplaceCamera",e)}));t.callView.setCallback("onReplaceSpeaker",(function(e){console.log("onReplaceSpeaker",e)}));t.callView.setCallback(Rt.Event.onOpenAdvancedSettings,(function(e){console.log("onOpenAdvancedSettings",e);t._onCallViewOpenAdvancedSettings()}));t.callView.show();if(s||n){return navigator.mediaDevices.getUserMedia({audio:s,video:n})}else{return new MediaStream}})).then((function(e){t.stream=e;var a={stream:t.stream};t.callView.setLocalStream(a);i.forEach((function(e){return t.callView.addUser(e,mr.Connected)}));if(s!==false){t.vad=new Dt({mediaStream:t.stream});setInterval((function(){return t.callView.setMicrophoneLevel(t.vad.currentVolume)}),100)}if(n){return navigator.mediaDevices.getUserMedia({audio:false,video:{width:320,height:180}})}else{return new MediaStream}})).then((function(e){t.stream2=e;t.callView.setUserMedia(i[0],"video",t.stream2.getVideoTracks()[0]);BX.rest.callMethod("im.user.list.get",{ID:i.concat(t.userId),AVATAR_HR:"Y"}).then((function(e){return t.callView.updateUserData(e.data())}))}))}},{key:"_onTestCallViewButtonClick",value:function e(t){console.log(t.buttonName);switch(t.buttonName){case"hangup":case"close":this.callView.close();break;case"inviteUser":this._onCallViewInviteUserButtonClick(t);break;case"fullscreen":this.toggleFullScreen();break;case"record":this._onCallViewRecordButtonClick(t);break;case"floorRequest":this._onCallViewFloorRequestButtonClick(t);break;case"showChat":this.fold('asd "asd"');break;case"toggleScreenSharing":this.callView.setUserMedia(464,"screen",this.stream2.getVideoTracks()[0]);break;case"returnToCall":break;case"document":this._onCallViewDocumentButtonClick();break}}},{key:"testIncoming",value:function e(t){var i=this;this.callNotification=new Xo({callerName:"this.currentCall.associatedEntity.name",callerAvatar:"this.currentCall.associatedEntity.avatar",callerType:"this.currentCall.associatedEntity.advanced.chatType",callerColor:"",video:true,hasCamera:!!t,zIndex:this.messengerFacade.getDefaultZIndex()+200,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:function e(t){console.log("button pressed",t.data);i.callNotification.close()}});this.callNotification.show()}},{key:"getMaxActiveMicrophonesCount",value:function e(){return 4}},{key:"showMicMutedNotification",value:function e(){var t=this;if(this.mutePopup||!this.callView){return}this.mutePopup=new pl({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.messengerFacade.getContainer():this.callView.container,icon:"mic-off",buttons:[this.createUnmuteButton()],onClose:function e(){t.allowMutePopup=false;t.mutePopup.destroy();t.mutePopup=null}});this.mutePopup.show()}},{key:"showAutoMicMuteNotification",value:function e(){var t=this;if(this.mutePopup||!this.callView){return}this.mutePopup=new pl({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.messengerFacade.getContainer():this.callView.container,title:l.Text.encode(BX.message("IM_CALL_MIC_AUTO_MUTED")),icon:"mic-off",buttons:[this.createUnmuteButton()],onClose:function e(){t.mutePopup.destroy();t.mutePopup=null}});this.mutePopup.show()}},{key:"createUnmuteButton",value:function e(){var t=this;return new BX.UI.Button({baseClass:"ui-btn ui-btn-icon-mic",text:BX.message("IM_CALL_UNMUTE_MIC"),size:BX.UI.Button.Size.EXTRA_SMALL,color:BX.UI.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){t._onCallViewToggleMuteButtonClick({muted:false});if(t.mutePopup){t.mutePopup.destroy();t.mutePopup=null}}}})}},{key:"toggleRoomMenu",value:function e(t){var i=this;if(this.roomMenu){this.roomMenu.destroy();return}var n=this.currentCall.currentRoom().speaker;var s=this.callView.userRegistry.get(n);this.roomMenu=new o.Menu({targetContainer:this.container,bindElement:t,items:[{text:BX.message("IM_CALL_SOUND_PLAYS_VIA"),disabled:true},{html:'<div class="bx-messenger-videocall-room-menu-avatar" style="--avatar: url(\''.concat(l.Text.encode(s.avatar),"')\"></div>").concat(l.Text.encode(s.name))},{delimiter:true},{text:BX.message("IM_CALL_LEAVE_ROOM"),onclick:function e(){i.currentCall.leaveCurrentRoom();i.roomMenu.close()}},{delimiter:true},{text:BX.message("IM_CALL_HELP"),onclick:function e(){i.showRoomHelp();i.roomMenu.close()}}],events:{onDestroy:function e(){return i.roomMenu=null}}});this.roomMenu.show()}},{key:"toggleRoomListMenu",value:function e(t){var i=this;if(this.roomListMenu){this.roomListMenu.destroy();return}this.currentCall.listRooms().then((function(e){i.roomListMenu=new BX.PopupMenuWindow({targetContainer:i.container,bindElement:t,items:i.prepareRoomListMenuItems(e),events:{onDestroy:function e(){return i.roomListMenu=null}}});i.roomListMenu.show()}))}},{key:"prepareRoomListMenuItems",value:function e(t){var i,n=this;var s=[{text:BX.message("IM_CALL_JOIN_ROOM"),disabled:true},{delimiter:true}];s=(i=s).concat.apply(i,babelHelpers.toConsumableArray(t.map((function(e){return{text:n.getRoomDescription(e),onclick:function t(){if(n.currentCall&&n.currentCall.joinRoom){n.currentCall.joinRoom(e.id)}n.roomListMenu.destroy()}}}))));s.push({delimiter:true});s.push({text:BX.message("IM_CALL_HELP"),onclick:function e(){n.showRoomHelp();n.roomMenu.close()}});return s}},{key:"showRoomHelp",value:function e(){BX.loadExt("ui.dialogs.messagebox").then((function(){BX.UI.Dialogs.MessageBox.alert(BX.message("IM_CALL_HELP_TEXT"),BX.message("IM_CALL_HELP"))}))}},{key:"getRoomDescription",value:function e(t){var i=this;var n=t.userList.map((function(e){var t=i.callView.userRegistry.get(e);return t.name}));var s=BX.message("IM_CALL_ROOM_DESCRIPTION");s=s.replace("#ROOM_ID#",t.id);s=s.replace("#PARTICIPANTS_LIST#",n.join(", "));return s}},{key:"showRoomJoinedPopup",value:function e(t,i,n){var a=this;if(this.roomJoinedPopup||!this.callView){return}var r;if(!t){r=BX.message("IM_CALL_ROOM_JOINED_MANUALLY")+"<p>"+BX.message("IM_CALL_ROOM_JOINED_P2")+"</p>"}else{var o=n.filter((function(e){return e!=a.userId})).map((function(e){var t=a.callView.userRegistry.get(e);return t.name}));var l=o.join(", ");if(i){r=BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_AUTO_SPEAKER").replace("#PARTICIPANTS_LIST#",l))}else{r=BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_AUTO").replace("#PARTICIPANTS_LIST#",l));r+="<p>"+BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_P2"))+"</p>"}}this.roomJoinedPopup=new pl({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.messengerFacade.getContainer():this.callView.container,title:r,buttonsLayout:"bottom",autoCloseDelay:0,buttons:[new s.Button({baseClass:"ui-btn",text:BX.message("IM_CALL_ROOM_JOINED_UNDERSTOOD"),size:s.Button.Size.EXTRA_SMALL,color:s.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null}}}),new s.Button({text:BX.message("IM_CALL_ROOM_WRONG_ROOM"),size:s.Button.Size.EXTRA_SMALL,color:s.Button.Color.LINK,noCaps:true,round:true,events:{click:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null;a.currentCall.leaveCurrentRoom()}}})],onClose:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null}});this.roomJoinedPopup.show()}},{key:"showMicTakenFromPopup",value:function e(t){var i=this;if(this.micTakenFromPopup||!this.callView){return}var n=this.callView.userRegistry.get(t);var s=BX.message("IM_CALL_ROOM_MIC_TAKEN_FROM").replace("#USER_NAME#",n.name);this.micTakenFromPopup=new pl({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.messengerFacade.getContainer():this.callView.container,title:BX.Text.encode(s),buttonsLayout:"right",autoCloseDelay:5e3,buttons:[],onClose:function e(){i.micTakenFromPopup.destroy();i.micTakenFromPopup=null}});this.micTakenFromPopup.show()}},{key:"showMicTakenByPopup",value:function e(t){var i=this;if(this.micTakenByPopup||!this.callView){return}var n=this.callView.userRegistry.get(t);this.micTakenByPopup=new pl({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.messengerFacade.getContainer():this.callView.container,title:BX.Text.encode(BX.message("IM_CALL_ROOM_MIC_TAKEN_BY").replace("#USER_NAME#",n.name)),buttonsLayout:"right",autoCloseDelay:5e3,buttons:[],onClose:function e(){i.micTakenByPopup.destroy();i.micTakenByPopup=null}});this.micTakenByPopup.show()}},{key:"showWebScreenSharePopup",value:function e(){var t=this;if(this.webScreenSharePopup){this.webScreenSharePopup.show();return}this.webScreenSharePopup=new Cl({bindElement:this.callView.buttons.screen.elements.root,targetContainer:this.callView.container,onClose:function e(){t.webScreenSharePopup.destroy();t.webScreenSharePopup=null},onStopSharingClick:function e(){t._onCallViewToggleScreenSharingButtonClick();t.webScreenSharePopup.destroy();t.webScreenSharePopup=null}});this.webScreenSharePopup.show()}},{key:"showFeedbackPopup",value:function e(t){if(!t){if(this.lastCallDetails){t=this.lastCallDetails}else{console.error("Could not show feedback without call")}}BX.loadExt("ui.feedback.form").then((function(){BX.UI.Feedback.Form.open({id:"call_feedback_"+Math.random(),forms:[{zones:["ru"],id:406,sec:"9lhjhn",lang:"ru"}],presets:{call_id:t.id||0,call_amount:t.userCount||0}})}))}},{key:"showFeedbackPopup_",value:function e(t){var i=this;if(this.feedbackPopup){return}if(!t){t=this.lastCallDetails}var n=this.messengerFacade.isThemeDark();if(!l.Type.isPlainObject(t)){return}BX.loadExt("im.component.call-feedback").then((function(){var e;var s;i.feedbackPopup=new o.Popup((e={id:"im-call-feedback",content:"",titleBar:BX.message("IM_CALL_QUALITY_FEEDBACK"),closeIcon:true,noAllPaddings:true,cacheable:false,background:n?"#3A414B":null,darkMode:n,closeByEsc:true,autoHide:true},babelHelpers.defineProperty(e,"cacheable",false),babelHelpers.defineProperty(e,"events",{onPopupDestroy:function e(){if(s){s.$destroy()}i.feedbackPopup=null}}),e));var a="<bx-im-component-call-feedback "+'@feedbackSent="onFeedbackSent" '+':darkMode="darkMode" '+':callDetails="callDetails" />';s=BX.Vue.createApp({template:a,data:function e(){return{darkMode:n,callDetails:t}},methods:{onFeedbackSent:function e(){setTimeout((function(){if(i.feedbackPopup){i.feedbackPopup.close()}}),1500)}}});s.mount("#"+i.feedbackPopup.getContentContainer().id);i.feedbackPopup.show()}))}},{key:"userId",get:function e(){return Number(BX.message("USER_ID"))}},{key:"callViewState",get:function e(){return this._callViewState},set:function e(t){if(this.callViewState==t){return}this._callViewState=t;this.emit(Tl.onViewStateChanged,{callViewState:t})}}]);return t}(r.EventEmitter);function Gl(e){var t=Object.keys(Tl);for(var i=0,n=t;i<n.length;i++){var s=n[i];if(l.Type.isFunction(e.events[s])){this.subscribe(Tl[s],e.events[s])}}}function zl(e){return{id:e.id,provider:e.provider,chatId:e.associatedEntity.id,userCount:e.users.length,browser:Do.getBrowserForStatistics(),isMobile:l.Browser.isMobile(),isConference:false,wasConnected:e.wasConnected}}babelHelpers.defineProperty(Wl,"FeatureState",Pl);babelHelpers.defineProperty(Wl,"Events",Tl);babelHelpers.defineProperty(Wl,"ViewState",El);babelHelpers.defineProperty(Wl,"DocumentType",Rl);p();BX.CallEngine=Gr;e.BackgroundDialog=v;e.Controller=Wl;e.Engine=Gr;e.Event=Sr;e.Hint=pl;e.State=vr;e.EndpointDirection=fr;e.FloatingScreenShare=ul;e.FloatingScreenShareContent=hl;e.IncomingNotificationContent=Qo;e.NotificationConferenceContent=al;e.Hardware=nt;e.Provider=br;e.Type=gr;e.UserState=mr;e.Util=Do;e.VideoStrategy=Sl;e.View=Rt;e.WebScreenSharePopup=Cl})(this.BX.Call=this.BX.Call||{},BX.Messenger.Lib,BX.UI,BX.UI.Dialogs,BX.UI,BX.Messenger.v2.Lib,BX.Event,BX.Main,BX,BX,BX,BX,BX.Messenger.Lib);
//# sourceMappingURL=call.bundle.map.js