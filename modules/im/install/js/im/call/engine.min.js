(function(){BX.namespace("BX.Call");BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Calling:"Calling",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant",Janus:"Janus"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Event={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onDestroy:"onDestroy"};var e={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var l=false;BX.Call.Engine=function(){if(!l){throw new Error("Do not use this constructor directly, use BX.Call.Engine.getInstance instead")}this.calls={};this.userId=BX.message("USER_ID");this.init()};BX.Call.Engine.getInstance=function(){return BX.CallEngine};BX.Call.Engine.prototype.init=function(){BX.addCustomEvent("onPullEvent-im",this.__onPullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-im",this.__onPullClientEvent.bind(this))};BX.Call.Engine.prototype.getCurrentUserId=function(){return this.userId};BX.Call.Engine.prototype.createCall=function(l){var a=this;return new Promise(function(n,t){var i=l.type||BX.Call.Type.Instant;var r=l.provider||a.getDefaultProvider();var s={type:i,provider:r,entityType:l.entityType,entityId:l.entityId,userIds:BX.type.isArray(l.userIds)?l.userIds:[]};var o={callParams:[e.createCall,s],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(o,function(e){if(e.callParams.error()){var i=e.callParams.error().getError();return t({code:i.error,message:i.error_description})}var r=e.callParams.data();var s=r.call;var o=a.__getCallFabric(s["PROVIDER"]);var c=o.createCall({id:s["ID"],instanceId:a.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:r.users,videoEnabled:l.videoEnabled==true,enableMicAutoParameters:l.enableMicAutoParameters!==false,associatedEntity:s.ASSOCIATED_ENTITY,events:{onDestroy:a.__onCallDestroy.bind(a)},debug:l.debug===true});var u=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(u));a.calls[s["ID"]]=c;if(r.userData){BX.MessengerCommon.updateUserData(r.userData)}n({call:c,isNew:r.isNew})})})};BX.Call.Engine.prototype.createChildCall=function(l,a,n){var t=this;return new Promise(function(i,r){if(!t.calls[l]){return r("Parent call is not found")}var s=t.calls[l];var o={parentId:l,newProvider:a,newUsers:n};var c={callParams:[e.createChildCall,o],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(c,function(e){var l=e.callParams.data();var a=l.call;var n=t.__getCallFabric(a["PROVIDER"]);var r=n.createCall({id:a["ID"],instanceId:t.getUuidv4(),parentId:a["PARENT_ID"],direction:BX.Call.Direction.Outgoing,users:l.users,videoEnabled:s.isVideoEnabled(),enableMicAutoParameters:s.enableMicAutoParameters!==false,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:t.__onCallDestroy.bind(t)}});var o=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(o));t.calls[a["ID"]]=r;i({call:r,isNew:l.isNew})})})};BX.Call.Engine.prototype.getCall=function(e,l){var a=this.__getCallFabric(e["PROVIDER"]);var n=a.createCall({id:e["ID"],instanceId:this.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:l,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[e["ID"]]=n;return n};BX.Call.Engine.prototype.getCallWithId=function(l){var a=this;return new Promise(function(n,t){if(a.calls[l]){return n(a.calls[l])}BX.ajax.runAction(e.getCall,{data:{callId:l}}).then(function(e){if(e.state==="success"){var l=e.data.call;n({call:a.getCall(l),isNew:false})}else if(e.state==="error"){t(e.errors[0])}})})};BX.Call.Engine.prototype.getUuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var l=Math.random()*16|0,a=e=="x"?l:l&3|8;return a.toString(16)})};BX.Call.Engine.prototype.__onPullEvent=function(e,l,a){var n={"Call::incoming":this.__onPullIncomingCall.bind(this)};if(n[e]){n[e].call(this,l,a)}else if(e.substr(0,6)==="Call::"&&l["call"]){var t=l["call"];var i=t["ID"];if(this.calls[i]){this.calls[i].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullClientEvent=function(e,l,a){if(e.substr(0,6)==="Call::"&&l["callId"]){var n=l["callId"];if(this.calls[n]){this.calls[n].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullIncomingCall=function(e,l){if(l.server_time_ago>30){console.error("Call was started too long time ago");return}var a=e.call;var n=a.ID;var t;if(e.publicIds){BX.PULL.setPublicIds(Object.values(e.publicIds))}if(e.userData){BX.MessengerCommon.updateUserData(e.userData)}if(this.calls[n]){t=this.calls[n]}else{var i=this.__getCallFabric(a.PROVIDER);t=i.createCall({id:n,instanceId:this.getUuidv4(),parentId:a.PARENT_ID||null,direction:BX.Call.Direction.Incoming,users:e.users,initiatorId:e.senderId,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[n]=t}if(t){BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:t,video:e.video===true,isMobile:e.isMobile===true}])}};BX.Call.Engine.prototype.__onCallDestroy=function(e){if(this.calls[e.call.id]){delete this.calls[e.call.id]}};BX.Call.Engine.prototype.getDefaultProvider=function(){return BX.Call.Provider.Plain};BX.Call.Engine.prototype.__getCallFabric=function(e){if(e==BX.Call.Provider.Plain){return BX.Call.PlainCallFabric}else if(e==BX.Call.Provider.Voximplant){return BX.Call.VoximplantCallFabric}else if(e==BX.Call.Provider.Janus){return BX.Call.JanusCallFabric}throw new Error("Unknown call provider type "+e)};BX.Call.PlainCallFabric={createCall:function(e){return new BX.Call.PlainCall(e)}};BX.Call.VoximplantCallFabric={createCall:function(e){return new BX.Call.VoximplantCall(e)}};BX.Call.JanusCallFabric={createCall:function(e){return new BX.Call.JanusCall(e)}};l=true;BX.CallEngine=new BX.Call.Engine;l=false})();
//# sourceMappingURL=engine.map.js