this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,n,s,a,r,o,l){"use strict";var d=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"messagesToSend",[]);babelHelpers.defineProperty(this,"store",null);babelHelpers.defineProperty(this,"restClient",null);babelHelpers.defineProperty(this,"loc",null);this.controller=t.Data.get("controller");this.store=this.controller.store;this.restClient=t.RestClient.get();this.loc=t.Loc.messages;this.onSendMessageHandler=this.onSendMessage.bind(this);this.onClickOnMessageRetryHandler=this.onClickOnMessageRetry.bind(this);this.onClickOnCommandHandler=this.onClickOnCommand.bind(this);this.onClickOnKeyboardHandler=this.onClickOnKeyboard.bind(this);a.EventEmitter.subscribe(r.EventType.textarea.sendMessage,this.onSendMessageHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnMessageRetry,this.onClickOnMessageRetryHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnCommand,this.onClickOnCommandHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnKeyboardButton,this.onClickOnKeyboardHandler)}babelHelpers.createClass(e,[{key:"onSendMessage",value:function e(t){var i=t.data;if(!i.text&&!i.file){return false}this.sendMessage(i.text,i.file)}},{key:"sendMessage",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!i&&!n){return false}var s=this.store.getters["dialogues/getQuoteId"](this.getDialogId());if(s){var o=this.store.getters["messages/getMessage"](this.getChatId(),s);if(o){i=this.getMessageTextWithQuote(o,i);a.EventEmitter.emit(r.EventType.dialog.quotePanelClose)}}if(!this.controller.application.isUnreadMessagesLoaded()){this.sendMessageToServer({id:0,chatId:this.getChatId(),dialogId:this.getDialogId(),text:i,file:n});this.processQueue();return true}var l={};if(n){l.FILE_ID=[n.id]}this.addMessageToModel({text:i,params:l,sending:!n}).then((function(e){a.EventEmitter.emit(r.EventType.dialog.scrollToBottom,{chatId:t.getChatId(),cancelIfScrollChange:true});t.addMessageToQueue({messageId:e,text:i,file:n});t.processQueue()}))}},{key:"processQueue",value:function e(){var t=this;this.messagesToSend.filter((function(e){return!e.sending})).forEach((function(e){t.deleteFromQueue(e.id);e.sending=true;if(e.file){a.EventEmitter.emit(r.EventType.textarea.stopWriting);a.EventEmitter.emit(r.EventType.uploader.addMessageWithFile,e)}else{t.sendMessageToServer(e)}}))}},{key:"addMessageToModel",value:function e(t){var i=t.text,n=t.params,s=t.sending;return this.store.dispatch("messages/add",{chatId:this.getChatId(),authorId:this.getUserId(),text:i,params:n,sending:s})}},{key:"addMessageToQueue",value:function e(t){var i=t.messageId,n=t.text,s=t.file;this.messagesToSend.push({id:i,chatId:this.getChatId(),dialogId:this.getDialogId(),text:n,file:s,sending:false})}},{key:"sendMessageToServer",value:function e(t){var i=this;a.EventEmitter.emit(r.EventType.textarea.stopWriting);this.restClient.callMethod(r.RestMethod.imMessageAdd,{TEMPLATE_ID:t.id,DIALOG_ID:t.dialogId,MESSAGE:t.text},null,null).then((function(e){i.controller.executeRestAnswer(r.RestMethodHandler.imMessageAdd,e,t)}))["catch"]((function(e){i.controller.executeRestAnswer(r.RestMethodHandler.imMessageAdd,e,t);o.Logger.warn("SendMessageHandler: error during adding message",e)}))}},{key:"onClickOnMessageRetry",value:function e(t){var i=t.data;this.retrySendMessage(i.message)}},{key:"retrySendMessage",value:function e(t){this.addMessageToQueue({messageId:t.id,text:t.text,file:null});this.setSendingMessageFlag(t.id);this.processQueue()}},{key:"setSendingMessageFlag",value:function e(t){this.store.dispatch("messages/actionStart",{id:t,chatId:this.getChatId()})}},{key:"deleteFromQueue",value:function e(t){this.messagesToSend=this.messagesToSend.filter((function(e){return e.id!==t}))}},{key:"onClickOnCommand",value:function e(t){var i=t.data;if(i.type==="put"){this.handlePutAction(i.value)}else if(i.type==="send"){this.handleSendAction(i.value)}else{o.Logger.warn("SendMessageHandler: Unprocessed command",i)}}},{key:"onClickOnKeyboard",value:function e(t){var i=t.data;if(i.action==="ACTION"){var n=i.params,s=n.action,a=n.value;this.handleKeyboardAction(s,a)}if(i.action==="COMMAND"){var o=i.params,l=o.dialogId,d=o.messageId,u=o.botId,c=o.command,h=o.params;this.restClient.callMethod(r.RestMethod.imMessageCommand,{MESSAGE_ID:d,DIALOG_ID:l,BOT_ID:u,COMMAND:c,COMMAND_PARAMS:h})["catch"]((function(e){return console.error("SendMessageHandler: command processing error",e)}))}}},{key:"handleKeyboardAction",value:function e(i,n){switch(i){case"SEND":{this.handleSendAction(n);break}case"PUT":{this.handlePutAction(n);break}case"CALL":{break}case"COPY":{t.Clipboard.copy(n);BX.UI.Notification.Center.notify({content:this.loc["IM_DIALOG_CLIPBOARD_COPY_SUCCESS"],autoHideDelay:4e3});break}case"DIALOG":{break}default:{console.error("SendMessageHandler: unknown keyboard action")}}}},{key:"handlePutAction",value:function e(t){a.EventEmitter.emit(r.EventType.textarea.insertText,{text:"".concat(t," ")})}},{key:"handleSendAction",value:function e(t){var i=this;this.sendMessage(t);setTimeout((function(){a.EventEmitter.emit(r.EventType.dialog.scrollToBottom,{chatId:i.getChatId(),duration:300,cancelIfScrollChange:false})}),300)}},{key:"getMessageTextWithQuote",value:function e(t,i){var n=null;if(t.authorId){n=this.store.getters["users/get"](t.authorId)}var a=this.store.getters["files/getList"](this.getChatId());var r="-".repeat(54);var o=n&&n.name?n.name:this.loc["IM_QUOTE_PANEL_DEFAULT_TITLE"];var l=s.Utils.date.format(t.date,null,this.loc);var d=s.Utils.text.quote(t.text,t.params,a,this.loc);var u=[];u.push(r);u.push("".concat(o," [").concat(l,"]"));u.push(d);u.push(r);u.push(i);return u.join("\n")}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"getUserId",value:function e(){return this.store.state.application.common.userId}},{key:"destroy",value:function e(){a.EventEmitter.unsubscribe(r.EventType.textarea.sendMessage,this.onSendMessageHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnMessageRetry,this.onClickOnMessageRetryHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnCommand,this.onClickOnCommandHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnKeyboardButton,this.onClickOnKeyboardHandler)}}]);return e}();var u=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"messagesToRead",{});babelHelpers.defineProperty(this,"timer",null);babelHelpers.defineProperty(this,"store",null);babelHelpers.defineProperty(this,"restClient",null);this.store=t.Data.get("controller").store;this.restClient=t.RestClient.get();this.timer=new i.Timer;this.onReadMessageHandler=this.onReadMessage.bind(this);a.EventEmitter.subscribe(r.EventType.dialog.readMessage,this.onReadMessageHandler)}babelHelpers.createClass(e,[{key:"onReadMessage",value:function e(t){var i=t.data,n=i.id,s=n===void 0?null:n,a=i.skipTimer,r=a===void 0?false:a,o=i.skipAjax,l=o===void 0?false:o;return this.readMessage(s,r,l)}},{key:"readMessage",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var a=this.getChatId();if(t){if(!this.messagesToRead[a]){this.messagesToRead[a]=[]}this.messagesToRead[a].push(Number.parseInt(t,10))}this.timer.stop("readMessage",a,true);this.timer.stop("readMessageServer",a,true);if(n){return this.processMessagesToRead(a,s)}return new Promise((function(e,t){i.timer.start("readMessage",a,.1,(function(){i.processMessagesToRead(a,s).then((function(t){return e(t)}))["catch"](t)}))}))}},{key:"processMessagesToRead",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var s=this.getMaxMessageIdFromQueue(t);delete this.messagesToRead[t];if(s<=0){return Promise.resolve()}return new Promise((function(e,a){i.readMessageOnClient(t,s).then((function(e){return i.decreaseChatCounter(t,e.count)})).then((function(){if(n){return e({chatId:t,lastId:s})}i.timer.start("readMessageServer",t,.5,(function(){i.readMessageOnServer(t,s).then((function(){e({chatId:t,lastId:s})}))["catch"](a)}))}))["catch"]((function(e){o.Logger.error("Reading messages error",e);a()}))}))}},{key:"getMaxMessageIdFromQueue",value:function e(t){var i=0;if(!this.messagesToRead[t]){return i}this.messagesToRead[t].forEach((function(e){if(i<e){i=e}}));return i}},{key:"readMessageOnClient",value:function e(t,i){return this.store.dispatch("messages/readMessages",{chatId:t,readId:i})}},{key:"readMessageOnServer",value:function e(t,i){return this.restClient.callMethod(r.RestMethod.imDialogRead,{DIALOG_ID:this.getDialogIdByChatId(t),MESSAGE_ID:i})}},{key:"decreaseChatCounter",value:function e(t,i){return this.store.dispatch("dialogues/decreaseCounter",{dialogId:this.getDialogIdByChatId(t),count:i})}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getDialogIdByChatId",value:function e(t){var i=this.store.getters["dialogues/getByChatId"](t);if(!i){return 0}return i.dialogId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"destroy",value:function e(){a.EventEmitter.unsubscribe(r.EventType.dialog.readMessage,this.onReadMessageHandler)}}]);return e}();var c=function(){function e(t){babelHelpers.classCallCheck(this,e);this.store=t.Data.get("controller").store;this.restClient=t.RestClient.get();this.onSetMessageReactionHandler=this.onSetMessageReaction.bind(this);this.onOpenMessageReactionListHandler=this.onOpenMessageReactionList.bind(this);a.EventEmitter.subscribe(r.EventType.dialog.setMessageReaction,this.onSetMessageReactionHandler);a.EventEmitter.subscribe(r.EventType.dialog.openMessageReactionList,this.onOpenMessageReactionListHandler)}babelHelpers.createClass(e,[{key:"onSetMessageReaction",value:function e(t){var i=t.data;this.reactToMessage(i.message.id,i.reaction)}},{key:"onOpenMessageReactionList",value:function e(t){var i=t.data;this.openMessageReactionList(i.message.id,i.values)}},{key:"reactToMessage",value:function t(i,n){var s=n.action||e.actions.auto;if(s!==e.actions.auto){s=s===e.actions.set?e.actions.plus:e.actions.minus}this.restClient.callMethod(r.RestMethod.imMessageLike,{MESSAGE_ID:i,ACTION:s})}},{key:"openMessageReactionList",value:function e(t,i){o.Logger.warn("Message reaction list not implemented yet!",t,i)}},{key:"destroy",value:function e(){a.EventEmitter.unsubscribe(r.EventType.dialog.setMessageReaction,this.onSetMessageReactionHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.openMessageReactionList,this.onOpenMessageReactionListHandler)}}]);return e}();babelHelpers.defineProperty(c,"types",{none:"none",like:"like",kiss:"kiss",laugh:"laugh",wonder:"wonder",cry:"cry",angry:"angry"});babelHelpers.defineProperty(c,"actions",{auto:"auto",plus:"plus",minus:"minus",set:"set"});var h=function(){function e(t){babelHelpers.classCallCheck(this,e);this.store=t.Data.get("controller").store;this.onQuoteMessageHandler=this.onQuoteMessage.bind(this);this.onQuotePanelCloseHandler=this.onQuotePanelClose.bind(this);a.EventEmitter.subscribe(r.EventType.dialog.quoteMessage,this.onQuoteMessageHandler);a.EventEmitter.subscribe(r.EventType.dialog.quotePanelClose,this.onQuotePanelCloseHandler)}babelHelpers.createClass(e,[{key:"onQuoteMessage",value:function e(t){var i=t.data;this.quoteMessage(i.message.id)}},{key:"onQuotePanelClose",value:function e(){this.clearQuote()}},{key:"quoteMessage",value:function e(t){this.store.dispatch("dialogues/update",{dialogId:this.getDialogId(),fields:{quoteId:t}})}},{key:"clearQuote",value:function e(){this.store.dispatch("dialogues/update",{dialogId:this.getDialogId(),fields:{quoteId:0}})}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"destroy",value:function e(){a.EventEmitter.unsubscribe(r.EventType.dialog.quoteMessage,this.onQuoteMessageHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.quotePanelClose,this.onQuotePanelCloseHandler)}}]);return e}();var g=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"store",null);babelHelpers.defineProperty(this,"restClient",null);babelHelpers.defineProperty(this,"timer",null);this.store=t.Data.get("controller").store;this.restClient=t.RestClient.get();this.timer=new i.Timer;this.subscribeToEvents()}babelHelpers.createClass(e,[{key:"subscribeToEvents",value:function e(){this.onStartWritingHandler=this.onStartWriting.bind(this);this.onStopWritingHandler=this.onStopWriting.bind(this);this.onAppButtonClickHandler=this.onAppButtonClick.bind(this);this.onFocusHandler=this.onFocus.bind(this);this.onBlurHandler=this.onBlur.bind(this);this.onKeyUpHandler=this.onKeyUp.bind(this);this.onEditHandler=this.onEdit.bind(this);a.EventEmitter.subscribe(r.EventType.textarea.startWriting,this.onStartWritingHandler);a.EventEmitter.subscribe(r.EventType.textarea.stopWriting,this.onStopWritingHandler);a.EventEmitter.subscribe(r.EventType.textarea.appButtonClick,this.onAppButtonClickHandler);a.EventEmitter.subscribe(r.EventType.textarea.focus,this.onFocusHandler);a.EventEmitter.subscribe(r.EventType.textarea.blur,this.onBlurHandler);a.EventEmitter.subscribe(r.EventType.textarea.keyUp,this.onKeyUpHandler);a.EventEmitter.subscribe(r.EventType.textarea.edit,this.onEditHandler)}},{key:"onStartWriting",value:function e(){this.startWriting()}},{key:"onStopWriting",value:function e(){this.stopWriting()}},{key:"onAppButtonClick",value:function e(){}},{key:"onFocus",value:function e(){}},{key:"onBlur",value:function e(){}},{key:"onKeyUp",value:function e(){}},{key:"onEdit",value:function e(){}},{key:"startWriting",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();if(s.Utils.dialog.isEmptyDialogId(i)||this.timer.has("writes",i)){return false}this.timer.start("writes",i,28);this.timer.start("writesSend",i,5,(function(){t.restClient.callMethod(r.RestMethod.imDialogWriting,{DIALOG_ID:i})["catch"]((function(){t.timer.stop("writes",i)}))}))}},{key:"stopWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();this.timer.stop("writes",t,true);this.timer.stop("writesSend",t,true)}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"getUserId",value:function e(){return this.store.state.application.common.userId}},{key:"getDiskFolderId",value:function e(){return this.store.state.application.dialog.diskFolderId}},{key:"destroy",value:function e(){a.EventEmitter.unsubscribe(r.EventType.textarea.startWriting,this.onStartWritingHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.stopWriting,this.onStopWritingHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.appButtonClick,this.onAppButtonClickHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.focus,this.onFocusHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.blur,this.onBlurHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.keyUp,this.onKeyUpHandler);a.EventEmitter.unsubscribe(r.EventType.textarea.edit,this.onEditHandler)}}]);return e}();var p=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"controller",null);babelHelpers.defineProperty(this,"restClient",null);babelHelpers.defineProperty(this,"uploader",null);babelHelpers.defineProperty(this,"isRequestingDiskFolderId",false);this.controller=t.Data.get("controller");this.restClient=t.RestClient.get();this.initUploader();this.onTextareaFileSelectedHandler=this.onTextareaFileSelected.bind(this);this.addMessageWithFileHandler=this.addMessageWithFile.bind(this);this.onClickOnUploadCancelHandler=this.onClickOnUploadCancel.bind(this);a.EventEmitter.subscribe(r.EventType.textarea.fileSelected,this.onTextareaFileSelectedHandler);a.EventEmitter.subscribe(r.EventType.uploader.addMessageWithFile,this.addMessageWithFileHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnUploadCancel,this.onClickOnUploadCancelHandler)}babelHelpers.createClass(e,[{key:"initUploader",value:function e(){this.uploader=new n.Uploader({generatePreview:true,sender:this.getUploaderSenderOptions()});this.uploader.subscribe("onStartUpload",this.onStartUploadHandler.bind(this));this.uploader.subscribe("onProgress",this.onProgressHandler.bind(this));this.uploader.subscribe("onSelectFile",this.onSelectFileHandler.bind(this));this.uploader.subscribe("onComplete",this.onCompleteHandler.bind(this));this.uploader.subscribe("onUploadFileError",this.onUploadFileErrorHandler.bind(this));this.uploader.subscribe("onCreateFileError",this.onCreateFileErrorHandler.bind(this))}},{key:"commitFile",value:function e(t,i){var n=this;this.restClient.callMethod(r.RestMethod.imDiskFileCommit,{chat_id:t.chatId,upload_id:t.uploadId,message:t.messageText,template_id:t.messageId,file_template_id:t.fileId},null,null).then((function(e){n.controller.executeRestAnswer(r.RestMethodHandler.imDiskFileCommit,e,i)}))["catch"]((function(e){n.controller.executeRestAnswer(r.RestMethodHandler.imDiskFileCommit,e,i)}));return true}},{key:"setUploadError",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.controller.store.dispatch("files/update",{chatId:t,id:i,fields:{status:r.FileStatus.error,progress:0}});if(n){this.controller.store.dispatch("messages/actionError",{chatId:t,id:n,retry:false})}}},{key:"onTextareaFileSelected",value:function e(t){var i=t.data;var n=i&&i.fileChangeEvent&&i.fileChangeEvent.target.files.length>0?i.fileChangeEvent:"";if(!n){return false}this.uploadFile(n)}},{key:"addMessageWithFile",value:function e(t){var i=this;var n=t.getData();if(!this.getDiskFolderId()){this.requestDiskFolderId(n.chatId).then((function(){i.addMessageWithFile(t)}))["catch"]((function(e){o.Logger.error("addMessageWithFile error",e);return false}));return false}this.uploader.addTask({taskId:n.file.id,fileData:n.file.source.file,fileName:n.file.source.file.name,generateUniqueName:true,diskFolderId:this.getDiskFolderId(),previewBlob:n.file.previewBlob})}},{key:"uploadFile",value:function e(t){if(!t){return false}this.uploader.addFilesFromEvent(t)}},{key:"destroy",value:function e(){if(this.uploader){this.uploader.unsubscribeAll()}a.EventEmitter.unsubscribe(r.EventType.textarea.fileSelected,this.onTextareaFileSelectedHandler);a.EventEmitter.unsubscribe(r.EventType.uploader.addMessageWithFile,this.addMessageWithFileHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnUploadCancel,this.onClickOnUploadCancelHandler)}},{key:"getChatId",value:function e(){return this.controller.store.state.application.dialog.chatId}},{key:"getDialogId",value:function e(){return this.controller.store.state.application.dialog.dialogId}},{key:"getDiskFolderId",value:function e(){return this.controller.store.state.application.dialog.diskFolderId}},{key:"getCurrentUser",value:function e(){return this.controller.store.getters["users/get"](this.controller.store.state.application.common.userId,true)}},{key:"getMessageByFileId",value:function e(t,i){var n=this.controller.store.getters["messages/get"](this.getChatId());var s=n.find((function(e){var i;if(l.Type.isArray((i=e.params)===null||i===void 0?void 0:i.FILE_ID)){return e.params.FILE_ID.includes(t)}return false}));if(!s){return}return{id:s.id,chatId:s.chatId,dialogId:this.getDialogId(),text:s.text,file:{id:t,source:i,previewBlob:i.previewData},sending:true}}},{key:"requestDiskFolderId",value:function e(t){var i=this;return new Promise((function(e,n){if(i.isRequestingDiskFolderId||i.getDiskFolderId()){i.isRequestingDiskFolderId=false;e();return}i.isRequestingDiskFolderId=true;i.restClient.callMethod(r.RestMethod.imDiskFolderGet,{chat_id:t}).then((function(t){i.isRequestingDiskFolderId=false;i.controller.executeRestAnswer(r.RestMethodHandler.imDiskFolderGet,t);e()}))["catch"]((function(e){i.isRequestingDiskFolderId=false;i.controller.executeRestAnswer(r.RestMethodHandler.imDiskFolderGet,e);n(e)}))}))}},{key:"onStartUploadHandler",value:function e(t){var i=t.getData();o.Logger.log("Uploader: onStartUpload",i);this.controller.store.dispatch("files/update",{chatId:this.getChatId(),id:i.id,fields:{status:r.FileStatus.upload,progress:0}})}},{key:"onProgressHandler",value:function e(t){var i=t.getData();o.Logger.log("Uploader: onProgress",i);this.controller.store.dispatch("files/update",{chatId:this.getChatId(),id:i.id,fields:{status:r.FileStatus.upload,progress:i.progress===100?99:i.progress}})}},{key:"onSelectFileHandler",value:function e(t){var i=t.getData();var n=i.file;o.Logger.log("Uploader: onSelectFile",i);var s="file";if(n.type.toString().startsWith("image")){s="image"}else if(n.type.toString().startsWith("video")){s="video"}this.controller.store.dispatch("files/add",{chatId:this.getChatId(),authorId:this.getCurrentUser().id,name:n.name,type:s,extension:n.name.split(".").splice(-1)[0],size:n.size,image:!i.previewData?false:{width:i.previewDataWidth,height:i.previewDataHeight},status:r.FileStatus.progress,progress:0,authorName:this.getCurrentUser().name,urlPreview:i.previewData?URL.createObjectURL(i.previewData):""}).then((function(e){a.EventEmitter.emit(r.EventType.textarea.sendMessage,{text:"",file:{id:e,source:i,previewBlob:i.previewData}})}))}},{key:"onCompleteHandler",value:function e(t){var i=t.getData();o.Logger.log("Uploader: onComplete",i);this.controller.store.dispatch("files/update",{chatId:this.getChatId(),id:i.id,fields:{status:r.FileStatus.wait,progress:100}});var n=this.getMessageByFileId(i.id,i);var s=this.controller.store.getters["files/get"](this.getChatId(),n.file.id,true).type;this.commitFile({chatId:this.getChatId(),uploadId:i.result.data.file.id,messageText:n.text,messageId:n.id,fileId:n.file.id,fileType:s},n)}},{key:"onUploadFileErrorHandler",value:function e(t){var i=t.getData();o.Logger.log("Uploader: onUploadFileError",i);var n=this.getMessageByFileId(i.id,i);if(n){this.setUploadError(this.getChatId(),n.file.id,n.id)}}},{key:"onCreateFileErrorHandler",value:function e(t){var i=t.getData();o.Logger.log("Uploader: onCreateFileError",i);var n=this.getMessageByFileId(i.id,i);if(n){this.setUploadError(this.getChatId(),n.file.id,n.id)}}},{key:"onClickOnUploadCancel",value:function e(t){var i=this;var n=t.data;var s=n.file.id;var a=n.file;var r=this.getMessageByFileId(s,a);if(!r){return}this.uploader.deleteTask(s);this.controller.store.dispatch("messages/delete",{chatId:this.getChatId(),id:r.id}).then((function(){i.controller.store.dispatch("files/delete",{chatId:i.getChatId(),id:r.file.id})}))}},{key:"getActionCommitFile",value:function e(){return null}},{key:"getActionUploadChunk",value:function e(){return null}},{key:"getUploaderSenderOptions",value:function e(){return{actionUploadChunk:this.getActionUploadChunk(),actionCommitFile:this.getActionCommitFile()}}}]);return e}();var v=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"isDragging",false);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"minimumHeight",120);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"maximumHeight",400);i.setEventNamespace("BX.IM.TextareaDragHandler");i.subscribeToEvents(e);if(s.Utils.device.isMobile()){i.maximumHeight=200}return i}babelHelpers.createClass(t,[{key:"subscribeToEvents",value:function e(t){var i=this;var n=l.Type.isObject(t)?t:{};Object.entries(n).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],s=t[1];if(l.Type.isFunction(s)){i.subscribe(n,s)}}))}},{key:"onStartDrag",value:function e(t,i){if(this.isDragging){return}this.isDragging=true;t=t.changedTouches?t.changedTouches[0]:t;this.textareaDragCursorStartPoint=t.clientY;this.textareaDragHeightStartPoint=i;this.addTextareaDragEvents()}},{key:"onTextareaContinueDrag",value:function e(i){if(!this.isDragging){return}i=i.changedTouches?i.changedTouches[0]:i;this.textareaDragCursorControlPoint=i.clientY;var n=Math.min(this.textareaDragHeightStartPoint+this.textareaDragCursorStartPoint-this.textareaDragCursorControlPoint,this.maximumHeight);var s=Math.max(n,this.minimumHeight);this.emit(t.events.onHeightChange,{newHeight:s})}},{key:"onTextareaStopDrag",value:function e(){if(!this.isDragging){return}this.isDragging=false;this.removeTextareaDragEvents();this.emit(t.events.onStopDrag)}},{key:"addTextareaDragEvents",value:function e(){this.onContinueDragHandler=this.onTextareaContinueDrag.bind(this);this.onStopDragHandler=this.onTextareaStopDrag.bind(this);document.addEventListener("mousemove",this.onContinueDragHandler);document.addEventListener("touchmove",this.onContinueDragHandler);document.addEventListener("touchend",this.onStopDragHandler);document.addEventListener("mouseup",this.onStopDragHandler);document.addEventListener("mouseleave",this.onStopDragHandler)}},{key:"removeTextareaDragEvents",value:function e(){document.removeEventListener("mousemove",this.onContinueDragHandler);document.removeEventListener("touchmove",this.onContinueDragHandler);document.removeEventListener("touchend",this.onStopDragHandler);document.removeEventListener("mouseup",this.onStopDragHandler);document.removeEventListener("mouseleave",this.onStopDragHandler)}},{key:"destroy",value:function e(){this.removeTextareaDragEvents()}}]);return t}(a.EventEmitter);babelHelpers.defineProperty(v,"events",{onHeightChange:"onHeightChange",onStopDrag:"onStopDrag"});var f=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"restClient",null);this.restClient=t.RestClient.get();this.subscribeToEvents()}babelHelpers.createClass(e,[{key:"subscribeToEvents",value:function e(){this.clickOnMentionHandler=this.onClickOnMention.bind(this);this.clickOnUserNameHandler=this.onClickOnUserName.bind(this);this.clickOnMessageMenuHandler=this.onClickOnMessageMenu.bind(this);this.clickOnReadListHandler=this.onClickOnReadList.bind(this);this.clickOnChatTeaserHandler=this.onClickOnChatTeaser.bind(this);this.clickOnDialogHandler=this.onClickOnDialog.bind(this);a.EventEmitter.subscribe(r.EventType.dialog.clickOnMention,this.clickOnMentionHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnUserName,this.clickOnUserNameHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnMessageMenu,this.clickOnMessageMenuHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnReadList,this.clickOnReadListHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnChatTeaser,this.clickOnChatTeaserHandler);a.EventEmitter.subscribe(r.EventType.dialog.clickOnDialog,this.clickOnDialogHandler)}},{key:"onClickOnMention",value:function e(t){var i=t.data;if(i.type==="USER"){o.Logger.warn("DialogActionHandler: open user profile",i)}else if(i.type==="CHAT"){o.Logger.warn("DialogActionHandler: open dialog from mention click",i)}else if(i.type==="CALL"){o.Logger.warn("DialogActionHandler: open phone menu",i)}}},{key:"onClickOnUserName",value:function e(t){var i=t.data;a.EventEmitter.emit(r.EventType.textarea.insertText,{text:"".concat(i.user.name,", ")})}},{key:"onClickOnMessageMenu",value:function e(t){var i=t.data;o.Logger.warn("DialogActionHandler: open message menu",i)}},{key:"onClickOnReadList",value:function e(t){var i=t.data;o.Logger.warn("DialogActionHandler: open read list",i)}},{key:"onClickOnChatTeaser",value:function e(t){var i=t.data;this.joinParentChat(i.message.id,"chat".concat(i.message.params.CHAT_ID)).then((function(e){o.Logger.warn("DialogActionHandler: open dialog from teaser click",e)}))["catch"]((function(e){console.error("DialogActionHandler: error joining parent chat",e)}))}},{key:"onClickOnDialog",value:function e(){o.Logger.warn("DialogActionHandler: click on dialog")}},{key:"joinParentChat",value:function e(t,i){var n=this;return new Promise((function(e,s){if(!t||!i){return s()}if(typeof n.tempJoinChat==="undefined"){n.tempJoinChat={}}else if(n.tempJoinChat["wait"]){return s()}n.tempJoinChat["wait"]=true;n.restClient.callMethod(r.RestMethod.imChatParentJoin,{DIALOG_ID:i,MESSAGE_ID:t}).then((function(){n.tempJoinChat["wait"]=false;n.tempJoinChat[i]=true;return e(i)}))["catch"]((function(){n.tempJoinChat["wait"]=false;return s()}))}))}},{key:"unsubscribeEvents",value:function e(){a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnMention,this.clickOnMentionHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnUserName,this.clickOnUserNameHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnMessageMenu,this.clickOnMessageMenuHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnReadList,this.clickOnReadListHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnChatTeaser,this.clickOnChatTeaserHandler);a.EventEmitter.unsubscribe(r.EventType.dialog.clickOnDialog,this.clickOnDialogHandler)}},{key:"destroy",value:function e(){this.unsubscribeEvents()}}]);return e}();var m=l.Reflection.getClass("BX.Messenger");if(m){m.ReadingHandler=u;m.ReactionHandler=c;m.QuoteHandler=h}e.TextareaHandler=g;e.TextareaDragHandler=v;e.TextareaUploadHandler=p;e.SendMessageHandler=d;e.ReadingHandler=u;e.ReactionHandler=c;e.QuoteHandler=h;e.DialogActionHandler=f})(this.BX.Messenger.EventHandler=this.BX.Messenger.EventHandler||{},BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Event,BX.Messenger.Const,BX.Messenger.Lib,BX);
//# sourceMappingURL=event-handler.bundle.map.js