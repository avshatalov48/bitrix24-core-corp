this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.Provider=this.BX.Messenger.Provider||{};(function(e,t,s,a){"use strict";var i=function(){babelHelpers.createClass(e,null,[{key:"create",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new this(t)}}]);function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);if(babelHelpers.typeof(t.controller)==="object"&&t.controller){this.controller=t.controller}if(babelHelpers.typeof(t.store)==="object"&&t.store){this.store=t.store}this.option=babelHelpers.typeof(t.store)==="object"&&t.store?t.store:{};if(!(babelHelpers.typeof(this.option.handlingDialog)==="object"&&this.option.handlingDialog&&this.option.handlingDialog.chatId&&this.option.handlingDialog.dialogId)){this.option.handlingDialog=false}}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"im"}},{key:"getSubscriptionType",value:function e(){return t.PullClient.SubscriptionType.Server}},{key:"skipExecute",value:function e(t){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!s.optionImportant){if(this.option.skip){console.info("Pull: command skipped while loading messages",t);return true}if(!this.option.handlingDialog){return false}}if(typeof t.chatId!=="undefined"||typeof t.dialogId!=="undefined"){if(typeof t.chatId!=="undefined"&&parseInt(t.chatId)===parseInt(this.option.handlingDialog.chatId)){return false}if(typeof t.dialogId!=="undefined"&&t.dialogId.toString()===this.option.handlingDialog.dialogId.toString()){return false}return true}return false}},{key:"handleMessage",value:function e(t,s){this.handleMessageAdd(t,s)}},{key:"handleMessageChat",value:function e(t,s){this.handleMessageAdd(t,s)}},{key:"handleMessageAdd",value:function e(t,i){var n=this;if(this.skipExecute(t,i)){return false}if(t.chat&&t.chat[t.chatId]){this.store.dispatch("dialogues/update",{dialogId:t.dialogId,fields:t.chat[t.chatId]})}if(t.users){this.store.dispatch("users/set",s.VuexBuilderModel.convertToArray(t.users))}if(t.files){var l=s.VuexBuilderModel.convertToArray(t.files);l.forEach(function(e){e=n.controller.prepareFilesBeforeSave(e);if(l.length===1&&t.message.templateFileId&&n.store.state.files.index[t.chatId]&&n.store.state.files.index[t.chatId][t.message.templateFileId]){n.store.dispatch("files/update",{id:t.message.templateFileId,chatId:t.chatId,fields:e}).then(function(){n.controller.emit(a.EventType.dialog.scrollToBottom,{cancelIfScrollChange:true})})}else{n.store.dispatch("files/set",e)}})}var d=this.store.state.messages.collection[t.chatId];if(!d){d=[]}var o=false;if(t.message.templateId&&d.length>0){for(var r=d.length-1;r>=0;r--){if(d[r].id===t.message.templateId){o=true;break}}}if(o){this.store.dispatch("messages/update",{id:t.message.templateId,chatId:t.chatId,fields:babelHelpers.objectSpread({push:false},t.message,{sending:false,error:false})}).then(function(){n.controller.emit(a.EventType.dialog.scrollToBottom,{cancelIfScrollChange:t.message.senderId!==n.controller.getUserId()})})}else if(this.controller.isUnreadMessagesLoaded()){if(this.controller.getChatId()===t.chatId){this.store.commit("application/increaseDialogExtraCount")}this.store.dispatch("messages/setAfter",babelHelpers.objectSpread({push:false},t.message,{unread:true}))}this.controller.stopOpponentWriting({dialogId:t.dialogId,userId:t.message.senderId});if(t.message.senderId===this.controller.getUserId()){this.store.dispatch("messages/readMessages",{chatId:t.chatId}).then(function(e){n.store.dispatch("dialogues/update",{dialogId:t.dialogId,fields:{counter:0}})})}else{this.store.dispatch("dialogues/increaseCounter",{dialogId:t.dialogId,count:1})}}},{key:"handleMessageUpdate",value:function e(t,s,a){this.execMessageUpdateOrDelete(t,s,a)}},{key:"handleMessageDelete",value:function e(t,s,a){this.execMessageUpdateOrDelete(t,s,a)}},{key:"execMessageUpdateOrDelete",value:function e(t,s,i){var n=this;if(this.skipExecute(t,s)){return false}this.controller.stopOpponentWriting({dialogId:t.dialogId,userId:t.senderId});this.store.dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{text:i==="messageUpdate"?t.text:"",textOriginal:i==="messageUpdate"?t.textOriginal:"",params:t.params,blink:true}}).then(function(){n.controller.emit(a.EventType.dialog.scrollToBottom,{cancelIfScrollChange:true})})}},{key:"handleMessageDeleteComplete",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.store.dispatch("messages/delete",{id:t.id,chatId:t.chatId});this.controller.stopOpponentWriting({dialogId:t.dialogId,userId:t.senderId,action:false})}},{key:"handleMessageLike",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.store.dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{params:{LIKE:t.users}}})}},{key:"handleChatOwner",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.store.dispatch("dialogues/update",{dialogId:t.dialogId,fields:{ownerId:t.userId}})}},{key:"handleMessageParamsUpdate",value:function e(t,s){var i=this;if(this.skipExecute(t,s)){return false}this.store.dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{params:t.params}}).then(function(){i.controller.emit(a.EventType.dialog.scrollToBottom,{cancelIfScrollChange:true})})}},{key:"handleStartWriting",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.controller.startOpponentWriting(t)}},{key:"handleReadMessage",value:function e(t,s){var a=this;if(this.skipExecute(t,s)){return false}this.store.dispatch("messages/readMessages",{chatId:t.chatId,readId:t.lastId}).then(function(e){a.store.dispatch("dialogues/update",{dialogId:t.dialogId,fields:{counter:t.counter}})})}},{key:"handleReadMessageChat",value:function e(t,s){this.handleReadMessage(t,s)}},{key:"handleReadMessageOpponent",value:function e(t,s){this.execReadMessageOpponent(t,s)}},{key:"handleReadMessageChatOpponent",value:function e(t,s){this.execReadMessageOpponent(t,s)}},{key:"execReadMessageOpponent",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.store.dispatch("dialogues/updateReaded",{dialogId:t.dialogId,userId:t.userId,userName:t.userName,messageId:t.lastId,date:t.date,action:true})}},{key:"handleUnreadMessageOpponent",value:function e(t,s){this.execUnreadMessageOpponent(t,s)}},{key:"handleUnreadMessageChatOpponent",value:function e(t,s){this.execUnreadMessageOpponent(t,s)}},{key:"execUnreadMessageOpponent",value:function e(t,s){if(this.skipExecute(t,s)){return false}this.store.dispatch("dialogues/updateReaded",{dialogId:t.dialogId,userId:t.userId,action:false})}},{key:"handleFileUpload",value:function e(t,i){var n=this;if(this.skipExecute(t,i)){return false}this.store.dispatch("files/set",this.controller.prepareFilesBeforeSave(s.VuexBuilderModel.convertToArray({file:t.fileParams}))).then(function(){n.controller.emit(a.EventType.dialog.scrollToBottom,{cancelIfScrollChange:true})})}}]);return e}();e.ImPullCommandHandler=i})(this.BX.Messenger.Provider.Pull=this.BX.Messenger.Provider.Pull||{},BX,BX,BX.Messenger.Const);
//# sourceMappingURL=registry.bundle.map.js