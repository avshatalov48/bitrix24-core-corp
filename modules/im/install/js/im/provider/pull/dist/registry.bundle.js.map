{"version":3,"file":"registry.bundle.js","sources":["../src/im.command.handler.js","../src/registry.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * Im pull commands (Pull Command Handler)\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nimport {PullClient} from \"pull.client\";\nimport {VuexBuilderModel} from 'ui.vue.vuex';\n\nclass ImPullCommandHandler\n{\n\tstatic create(params = {})\n\t{\n\t\treturn new this(params);\n\t}\n\n\tconstructor(params = {})\n\t{\n\t\tif (typeof params.controller === 'object' && params.controller)\n\t\t{\n\t\t\tthis.controller = params.controller;\n\t\t}\n\t\tif (typeof params.store === 'object' && params.store)\n\t\t{\n\t\t\tthis.store = params.store;\n\t\t}\n\t}\n\n\tgetModuleId()\n\t{\n\t\treturn 'im';\n\t}\n\n\tgetSubscriptionType()\n\t{\n\t\treturn PullClient.SubscriptionType.Server;\n\t}\n\n\thandleMessageChat(params)\n\t{\n\t\tif (params.chat && params.chat[params.chatId])\n\t\t{\n\t\t\tthis.store.dispatch('dialogues/update', {\n\t\t\t\tdialogId: 'chat'+params.chatId,\n\t\t\t\tfields: params.chat[params.chatId]\n\t\t\t});\n\t\t}\n\n\t\tif (params.users)\n\t\t{\n\t\t\tthis.store.dispatch('users/set', VuexBuilderModel.convertToArray(params.users));\n\t\t}\n\n\t\tif (params.files)\n\t\t{\n\t\t\tthis.store.dispatch('files/set', this.controller.prepareFilesBeforeSave(\n\t\t\t\t VuexBuilderModel.convertToArray(params.files)\n\t\t\t));\n\t\t}\n\n\t\tlet collection = this.store.state.messages.collection[params.chatId];\n\t\tif (!collection)\n\t\t{\n\t\t\tcollection = [];\n\t\t}\n\n\t\tlet update = false;\n\t\tif (params.message.tempId && collection.length > 0)\n\t\t{\n\t\t\tfor (let index = collection.length-1; index >= 0; index--)\n\t\t\t{\n\t\t\t\tif (collection[index].id == params.message.tempId)\n\t\t\t\t{\n\t\t\t\t\tupdate = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (update)\n\t\t{\n\t\t\tthis.store.dispatch('messages/update', {\n\t\t\t\tid: params.message.tempId,\n\t\t\t\tchatId: params.message.chatId,\n\t\t\t\tfields: params.message\n\t\t\t});\n\t\t}\n\t\telse if (this.controller.isUnreadMessagesLoaded())\n\t\t{\n\t\t\tlet unreadCountInCollection = 0;\n\t\t\tif (collection.length > 0)\n\t\t\t{\n\t\t\t\tcollection.forEach(element => element.unread? unreadCountInCollection++: 0);\n\t\t\t}\n\n\t\t\tif (unreadCountInCollection > 0)\n\t\t\t{\n\t\t\t\tthis.store.commit('application/set', {dialog: {\n\t\t\t\t\tmessageLimit: this.controller.getRequestMessageLimit() + unreadCountInCollection\n\t\t\t\t}});\n\t\t\t}\n\t\t\telse if (this.controller.getMessageLimit() != this.controller.getRequestMessageLimit())\n\t\t\t{\n\t\t\t\tthis.store.commit('application/set', {dialog: {\n\t\t\t\t\tmessageLimit: this.controller.getRequestMessageLimit()\n\t\t\t\t}});\n\t\t\t}\n\n\t\t\tthis.store.dispatch('messages/set', {...params.message, unread: true});\n\t\t}\n\n\t\tthis.controller.stopOpponentWriting({\n\t\t\tdialogId: 'chat'+params.message.chatId,\n\t\t\tuserId: params.message.senderId\n\t\t});\n\n\t\tif (params.message.senderId == this.controller.getUserId())\n\t\t{\n\t\t\tthis.store.dispatch('messages/readMessages', {\n\t\t\t\tchatId: params.message.chatId\n\t\t\t}).then(result => {\n\t\t\t\tthis.store.dispatch('dialogues/update', {\n\t\t\t\t\tdialogId: 'chat'+params.message.chatId,\n\t\t\t\t\tfields: {\n\t\t\t\t\t\tcounter: 0,\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.store.dispatch('dialogues/increaseCounter', {\n\t\t\t\tdialogId: 'chat'+params.message.chatId,\n\t\t\t\tcount: 1,\n\t\t\t});\n\t\t}\n\t}\n\n\thandleMessageUpdate(params, extra, command)\n\t{\n\t\tthis.execMessageUpdateOrDelete(params, extra, command);\n\t}\n\n\thandleMessageDelete(params, extra, command)\n\t{\n\t\tthis.execMessageUpdateOrDelete(params, extra, command);\n\t}\n\n\thandleMessageDeleteComplete(params)\n\t{\n\t\tthis.store.dispatch('messages/delete', {\n\t\t\tid: params.id,\n\t\t\tchatId: params.chatId,\n\t\t});\n\n\t\tthis.controller.stopOpponentWriting({\n\t\t\tdialogId: params.dialogId,\n\t\t\tuserId: params.senderId,\n\t\t\taction: false\n\t\t});\n\t}\n\n\thandleMessageParamsUpdate(params)\n\t{\n\t\tthis.store.dispatch('messages/update', {\n\t\t\tid: params.id,\n\t\t\tchatId: params.chatId,\n\t\t\tfields: {params: params.params}\n\t\t});\n\t}\n\n\thandleStartWriting(params)\n\t{\n\t\tthis.controller.startOpponentWriting(params);\n\t}\n\n\thandleReadMessageChat(params)\n\t{\n\t\tthis.store.dispatch('messages/readMessages', {\n\t\t\tchatId: params.chatId,\n\t\t\treadId: params.lastId\n\t\t}).then(result => {\n\t\t\tthis.store.dispatch('dialogues/update', {\n\t\t\t\tdialogId: params.dialogId,\n\t\t\t\tfields: {\n\t\t\t\t\tcounter: params.counter,\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\texecMessageUpdateOrDelete(params, extra, command)\n\t{\n\t\tthis.store.dispatch('messages/update', {\n\t\t\tid: params.id,\n\t\t\tchatId: params.chatId,\n\t\t\tfields: {\n\t\t\t\ttext: command == \"messageUpdate\"? params.text: '',\n\t\t\t\ttextOriginal: command == \"messageUpdate\"? params.textOriginal: '',\n\t\t\t\tparams: params.params,\n\t\t\t\tblink: true\n\t\t\t}\n\t\t});\n\n\t\tthis.controller.stopOpponentWriting({\n\t\t\tdialogId: params.dialogId,\n\t\t\tuserId: params.senderId\n\t\t});\n\t}\n}\n\nexport {ImPullCommandHandler};","/**\n * Bitrix Messenger\n * Bundle pull command handlers\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nimport {ImPullCommandHandler} from \"./im.command.handler.js\";\n\nexport {\n\tImPullCommandHandler,\n}"],"names":["ImPullCommandHandler","params","controller","store","PullClient","SubscriptionType","Server","chat","chatId","dispatch","dialogId","fields","users","VuexBuilderModel","convertToArray","files","prepareFilesBeforeSave","collection","state","messages","update","message","tempId","length","index","id","isUnreadMessagesLoaded","unreadCountInCollection","forEach","element","unread","commit","dialog","messageLimit","getRequestMessageLimit","getMessageLimit","stopOpponentWriting","userId","senderId","getUserId","then","result","counter","count","extra","command","execMessageUpdateOrDelete","action","startOpponentWriting","readId","lastId","text","textOriginal","blink"],"mappings":"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"}