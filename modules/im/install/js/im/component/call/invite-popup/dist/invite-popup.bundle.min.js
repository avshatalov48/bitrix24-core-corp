this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,s){"use strict";function n(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function r(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?n(Object(s),!0).forEach((function(t){babelHelpers.defineProperty(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):n(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function i(e,t){a(e,t);t.add(e)}function a(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function o(e,t,s){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return s}var l=new WeakSet;var c=function(){function e(s){babelHelpers.classCallCheck(this,e);i(this,l);if(!t.Type.isPlainObject(s)){s={}}this.idleUsers=s.idleUsers||[];this.recentUsers=[];this.bindElement=s.bindElement;this.viewElement=s.viewElement||document.body;this.allowNewUsers=s.allowNewUsers;this.elements={root:null,inputBox:null,input:null,destinationContainer:null,contactList:null,moreButton:null};this.popup=null;this.zIndex=s.zIndex||0;this.darkMode=s.darkMode;this.searchPhrase="";this.searchNext=0;this.searchResult=[];this.searchTotalCount=0;this.searchTimeout=0;this.fetching=false;this.callbacks={onSelect:t.Type.isFunction(s.onSelect)?s.onSelect:BX.DoNothing,onClose:t.Type.isFunction(s.onClose)?s.onClose:BX.DoNothing,onDestroy:t.Type.isFunction(s.onDestroy)?s.onDestroy:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){if(!this.elements.root){this.render()}this.createPopup();this.popup.show();if(this.allowNewUsers){this.showLoader();this.getRecent().then(this.updateContactList.bind(this))}else{this.updateContactList()}}},{key:"close",value:function e(){if(this.popup){this.popup.close()}clearTimeout(this.searchTimeout)}},{key:"createPopup",value:function e(){var n=this;this.popup=new s.Popup({id:"bx-call-popup-invite",bindElement:this.bindElement,targetContainer:this.viewElement,zIndex:this.zIndex,lightShadow:true,darkMode:this.darkMode,autoHide:true,closeByEsc:true,content:this.elements.root,bindOptions:{position:"top"},angle:{position:"bottom",offset:49},cacheable:false,buttons:[new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_INVITE"),className:"popup-window-button-accept",events:{click:function e(){if(n.selectedUser){n.callbacks.onSelect({user:n.selectedUser})}}}}),new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_CANCEL"),events:{click:function e(){return n.popup.close()}}})],events:{onPopupDestroy:function e(){n.popup=null;n.elements.contactList=null;clearTimeout(n.searchTimeout);n.callbacks.onDestroy()}}});t.Dom.addClass(this.popup.popupContainer,"bx-messenger-mark")}},{key:"getRecent",value:function e(){var t=this;return new Promise((function(e){BX.rest.callMethod("im.recent.get",{SKIP_OPENLINES:"Y",SKIP_CHAT:"Y"}).then((function(s){var n=s.answer;t.recentUsers=Object.values(n.result).map((function(e){return e.user})).filter((function(e){return!e.bot&&!e.network}));e()}))}))}},{key:"search",value:function e(){var t=this;return new Promise((function(e){t.searchResult=t.recentUsers.filter((function(e){return e.name.toString().toLowerCase().includes(t.searchPhrase.toLowerCase())}));t.searchTotalCount=t.searchResult.length;t.searchNext=0;if(t.searchPhrase.length<3){e();return}BX.rest.callMethod("im.search.user.list",{FIND:t.searchPhrase}).then((function(s){var n=s.answer;t.searchTotalCount=n.total;t.searchNext=n.next;var r=t.searchResult.map((function(e){return parseInt(e.id)}));var i=Object.values(n.result).filter((function(e){if(e.bot||e.network){return false}return!r.includes(parseInt(e.id))}));t.searchResult=t.searchResult.concat(i);t.searchTotalCount=t.searchResult.length;e()}))}))}},{key:"fetchMoreSearchResults",value:function e(){var t=this;return new Promise((function(e){BX.rest.callMethod("im.search.user.list",{FIND:t.searchPhrase,OFFSET:t.searchNext}).then((function(s){var n=s.answer;t.searchTotalCount=n.total;t.searchNext=n.next;var r=t.searchResult.map((function(e){return parseInt(e.id)}));var i=Object.values(n.result).filter((function(e){if(e.bot||e.network){return false}return!r.includes(parseInt(e.id))}));t.searchResult=t.searchResult.concat(i);t.searchTotalCount=t.searchResult.length;e(i)}))}))}},{key:"render",value:function e(){this.elements.root=t.Dom.create("div",{props:{className:"bx-messenger-popup-newchat-wrap"},children:[t.Dom.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},text:BX.message("IM_CALL_INVITE_INVITE_USER")})]});this.elements.inputBox=t.Dom.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"},children:[this.elements.destinationContainer=t.Dom.create("span",{props:{className:"bx-messenger-dest-items"}}),this.elements.input=t.Dom.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:this.allowNewUsers?BX.message("IM_M_SEARCH_PLACEHOLDER"):BX.message("IM_M_CALL_REINVITE_PLACEHOLDER"),value:"",disabled:!this.allowNewUsers},events:{keyup:this._onInputKeyUp.bind(this)}})]});this.elements.root.appendChild(this.elements.inputBox);this.elements.contactList=t.Dom.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:[]});this.elements.root.appendChild(this.elements.contactList)}},{key:"updateDestination",value:function e(){if(!this.elements.inputBox){return}t.Dom.clean(this.elements.destinationContainer);if(this.selectedUser){this.elements.destinationContainer.appendChild(this.renderDestinationUser(this.selectedUser));this.elements.input.style.display="none"}else{this.elements.input.style.removeProperty("display");this.elements.input.focus()}}},{key:"updateContactList",value:function e(){t.Dom.clean(this.elements.contactList);if(this.elements.contactList){this.elements.contactList.appendChild(this.renderContactList())}}},{key:"showLoader",value:function e(){t.Dom.clean(this.elements.contactList);this.elements.contactList.appendChild(t.Dom.create("div",{props:{className:"bx-messenger-cl-item-load"},text:BX.message("IM_CL_LOAD")}))}},{key:"renderContactList",value:function e(){var s=document.createDocumentFragment();if(this.idleUsers.length>0){s.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_CALL_PARTICIPANTS")));for(var n=0;n<this.idleUsers.length;n++){s.appendChild(o(this,l,h).call(this,this.idleUsers[n]))}}if(t.Type.isStringFilled(this.searchPhrase)){if(this.searchResult.length>0){s.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_SEARCH_RESULTS")));for(var r=0;r<this.searchResult.length;r++){s.appendChild(o(this,l,h).call(this,this.searchResult[r]))}if(this.searchTotalCount>this.searchResult.length){this.elements.moreButton=this.renderMoreButton();s.appendChild(this.elements.moreButton)}}}else if(this.recentUsers.length>0){s.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_RECENT")));for(var i=0;i<this.recentUsers.length;i++){s.appendChild(o(this,l,h).call(this,this.recentUsers[i]))}}return s}},{key:"renderSeparator",value:function e(s){return t.Dom.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[t.Dom.create("span",{props:{className:"bx-messenger-chatlist-group-title"},text:s})]})}},{key:"renderDestinationUser",value:function e(s){return t.Dom.create("span",{props:{className:"bx-messenger-dest-block"},children:[t.Dom.create("span",{props:{className:"bx-messenger-dest-text"},text:t.Text.decode(s.name)}),t.Dom.create("span",{props:{className:"bx-messenger-dest-del"},events:{click:this.removeSelectedUser.bind(this)}})]})}},{key:"renderMoreButton",value:function e(){return t.Dom.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},events:{click:this._onMoreButtonClick.bind(this)},children:[t.Dom.create("span",{props:{className:"bx-messenger-chatlist-more"},text:BX.message("IM_CALL_INVITE_MORE")+" "+(this.searchTotalCount-this.searchResult.length)})]})}},{key:"setSelectedUser",value:function e(t){this.selectedUser=t;this.updateDestination()}},{key:"removeSelectedUser",value:function e(){this.selectedUser=null;this.updateDestination()}},{key:"escapeUserData",value:function e(s){return r(r({},s),{},{name:t.Text.encode(s.name),first_name:t.Text.encode(s.first_name),last_name:t.Text.encode(s.last_name),work_position:t.Text.encode(s.work_position),external_auth_id:t.Text.encode(s.external_auth_id),status:t.Text.encode(s.status)})}},{key:"_onMoreButtonClick",value:function e(){var t=this;if(this.fetching){return}this.fetching=true;this.fetchMoreSearchResults().then((function(e){var s=document.createDocumentFragment();var n=null;for(var r=0;r<e.length;r++){s.appendChild(o(t,l,h).call(t,e[r]))}if(t.searchTotalCount>t.searchResult.length){n=t.renderMoreButton();s.appendChild(n)}BX.replace(t.elements.moreButton,s);t.elements.moreButton=n;t.fetching=false}))}},{key:"_onInputKeyUp",value:function e(s){var n=this;if(s.keyCode==16||s.keyCode==17||s.keyCode==18||s.keyCode==20||s.keyCode==244||s.keyCode==224||s.keyCode==91){return false}if(s.keyCode==27&&this.elements.input.value!==""){this.elements.input.value="";s.stopPropagation()}if(this.searchTimeout){clearTimeout(this.searchTimeout)}this.searchTimeout=setTimeout((function(){n.searchPhrase=n.elements.input.value;if(!t.Type.isStringFilled(n.searchPhrase)){n.updateContactList()}else{n.search().then((function(){return n.updateContactList()}))}}),300)}}]);return e}();function h(e){var t=this;var s=BX.MessengerCommon.drawContactListElement({id:e.id,data:this.escapeUserData(e),showUserLastActivityDate:true,showLastMessage:false,showCounter:false});BX.bind(s,"click",(function(){return t.setSelectedUser(e)}));return s}e.InvitePopup=c})(this.BX.Messenger.Call=this.BX.Messenger.Call||{},BX,BX.Main);
//# sourceMappingURL=invite-popup.bundle.map.js