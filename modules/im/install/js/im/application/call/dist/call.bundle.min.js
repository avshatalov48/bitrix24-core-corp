this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,r,l,a,n,o,s,c,u,d,h,C,p,f,m,g,v,E,I,S){"use strict";var y=Object.freeze({guest:"guest"});var B=function(){function e(t){babelHelpers.classCallCheck(this,e);this.queryAuthRestore=false;this.setAuthId(y.guest);this.restClient=new d.RestClient({endpoint:t.endpoint,queryParams:this.queryParams,cors:true})}babelHelpers.createClass(e,[{key:"setAuthId",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(babelHelpers.typeof(this.queryParams)!=="object"){this.queryParams={}}if(t==y.guest||typeof t==="string"&&t.match(/^[a-f0-9]{32}$/)){this.queryParams.call_auth_id=t}else{console.error("%CallRestClient.setAuthId: auth is not correct (%c".concat(t,"%c)"),"color: black;","font-weight: bold; color: red","color: black");return false}if(t==y.guest&&typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){this.queryParams.call_custom_auth_id=i}return true}},{key:"setChatId",value:function e(t){if(babelHelpers.typeof(this.queryParams)!=="object"){this.queryParams={}}this.queryParams.call_chat_id=t}},{key:"callMethod",value:function e(t,i,r,l){var a=this;var n=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!n){n=h.Utils.getLogTrackingParams({name:t})}var o=new BX.Promise;this.restClient.callMethod(t,i,null,l,n).then(function(e){a.queryAuthRestore=false;o.fulfill(e)}).catch(function(e){var r=e.error();if(r.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){a.setAuthId(r.ex.hash);if(t===RestMethod.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(r.ex.error_description," (").concat(r.ex.error,")"));a.queryAuthRestore=false;o.reject(e);return false}if(!a.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");a.queryAuthRestore=true;a.restClient.callMethod(t,i,null,l,n).then(function(e){a.queryAuthRestore=false;o.fulfill(e)}).catch(function(e){a.queryAuthRestore=false;o.reject(e)});return false}}a.queryAuthRestore=false;o.reject(e)});return o}},{key:"callBatch",value:function e(t,i,r,l,a){var n=this;var o=function e(o){for(var s in t){if(!t.hasOwnProperty(s)){continue}var c=o[s].error();if(c&&c.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){n.setAuthId(c.ex.hash);if(s===RestMethod.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(c.ex.error_description," (").concat(c.ex.error,")"));n.queryAuthRestore=false;i(o);return false}if(!n.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");n.queryAuthRestore=true;n.restClient.callBatch(t,i,r,l,a);return false}}}n.queryAuthRestore=false;i(o);return true};return this.restClient.callBatch(t,o,r,l,a)}}]);return e}();C.Vue.component("bx-im-application-call",{data:function e(){return{downloadAppArticleCode:11387752}},props:{chatId:{default:0},dialogId:{default:"0"},startupErrorCode:{default:""}},methods:{redirectToAuthorize:function e(){location.href=location.origin+"/auth/?backurl="+location.pathname},continueAsGuest:function e(){v.Cookie.set(null,"VIDEOCONF_GUEST","",{path:"/"});location.reload(true)},getBxLink:function e(){return"bx://videoconf/code/".concat(this.$root.$bitrixApplication.getAlias())},getErrorFromCode:function e(){if(this.startupErrorCode){if(this.startupErrorCode===g.CallApplicationErrorCode.bitrix24only){return this.localize["BX_IM_COMPONENT_CALL_ERROR_MESSAGE_B24_ONLY"]}else if(this.startupErrorCode===g.CallApplicationErrorCode.detectIntranetUser){return this.localize["BX_IM_COMPONENT_CALL_ERROR_MESSAGE_PLEASE_LOG_IN"]}else if(this.startupErrorCode===g.CallApplicationErrorCode.userLimitReached){return this.localize["BX_IM_COMPONENT_CALL_ERROR_MESSAGE_USER_LIMIT"]}else if(this.startupErrorCode===g.CallApplicationErrorCode.kickedFromCall){return this.localize["BX_IM_COMPONENT_CALL_ERROR_MESSAGE_KICKED"]}}else if(this.callApplication.common.componentError){if(this.callApplication.common.componentError===g.CallApplicationErrorCode.kickedFromCall){return this.localize["BX_IM_COMPONENT_CALL_ERROR_MESSAGE_KICKED"]}else if(this.callApplication.common.componentError===g.CallApplicationErrorCode.unsupportedBrowser){return this.localize["BX_IM_COMPONENT_CALL_ERROR_UNSUPPORTED_BROWSER"]}else if(this.callApplication.common.componentError===g.CallApplicationErrorCode.missingMicrophone){return this.localize["BX_IM_COMPONENT_CALL_ERROR_NO_MIC"]}else if(this.callApplication.common.componentError===g.CallApplicationErrorCode.unsafeConnection){return this.localize["BX_IM_COMPONENT_CALL_ERROR_NO_HTTPS"]}}},openHelpArticle:function e(){if(BX.Helper){BX.Helper.show("redirect=detail&code="+this.downloadAppArticleCode)}}},computed:babelHelpers.objectSpread({authorizeButtonClasses:function e(){return["ui-btn","ui-btn-sm","ui-btn-success-dark","ui-btn-no-caps","bx-im-application-call-button-authorize"]},continueAsGuestButtonClasses:function e(){return["ui-btn","ui-btn-sm","ui-btn-no-caps","bx-im-application-call-button-as-guest"]},isIntranetUserError:function e(){return this.startupErrorCode===g.CallApplicationErrorCode.detectIntranetUser},isUnsupportedBrowserError:function e(){return this.callApplication.common.componentError===g.CallApplicationErrorCode.unsupportedBrowser},localize:function e(){return C.Vue.getFilteredPhrases("BX_IM_COMPONENT_CALL_",this.$root.$bitrixMessages)}},I.Vuex.mapState({callApplication:function e(t){return t.callApplication},application:function e(t){return t.application}})),template:'\n\t\t<div class="bx-im-application-call">\n\t\t\t<template v-if="startupErrorCode || callApplication.common.componentError">\n\t\t\t\t<template v-if="isIntranetUserError">\n\t\t\t\t\t<div class="bx-im-application-call-error-message">\n\t\t\t\t\t\t<div>{{ getErrorFromCode() }}</div>\n\t\t\t\t\t\t<div class="bx-im-application-call-error-message-buttons">\n\t\t\t\t\t\t\t<button @click="redirectToAuthorize" :class="authorizeButtonClasses">{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_AUTHORIZE\'] }}</button>\n\t\t\t\t\t\t\t<button @click="continueAsGuest" :class="continueAsGuestButtonClasses">{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_AS_GUEST\'] }}</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<template v-else-if="isUnsupportedBrowserError">\n\t\t\t\t\t<div class="bx-im-application-call-error-message">\n\t\t\t\t\t\t<div>{{ getErrorFromCode() }}</div>\n\t\t\t\t\t\t<div class="bx-im-application-call-error-message-links">\n\t\t\t\t\t\t\t<div class="bx-im-application-call-error-message-links-link">\n\t\t\t\t\t\t\t\t{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_OPEN_APP\'] }} \n\t\t\t\t\t\t\t\t<a :href="getBxLink()">{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_OPEN_APP_LINK\'] }}</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="bx-im-application-call-error-message-links-link">\n\t\t\t\t\t\t\t\t{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_DOWNLOAD_APP\'] }} -\n\t\t\t\t\t\t\t\t<a href="" @click.prevent="openHelpArticle" target="_blank">{{ this.localize[\'BX_IM_COMPONENT_CALL_BUTTON_DOWNLOAD_APP_LINK\'] }}</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<div class="bx-im-application-call-error-message">{{ getErrorFromCode() }}</div>\n\t\t\t\t</template>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<bx-pull-component-status/>\n\t\t\t\t<bx-im-component-call :chatId="chatId" dialogId="dialogId" />\n\t\t\t</template>\n\t\t</div>\n\t'});var k=function(){function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.inited=false;this.dialogInited=false;this.initPromise=new BX.Promise;this.params=i;this.params.userId=this.params.userId?parseInt(this.params.userId):0;this.params.siteId=this.params.siteId||"";this.params.chatId=this.params.chatId?parseInt(this.params.chatId):0;this.params.dialogId=this.params.chatId?"chat"+this.params.chatId.toString():"0";this.messagesQueue=[];this.template=null;this.rootNode=this.params.node||document.createElement("div");this.event=new C.VueVendorV2;this.callContainer=null;this.callView=null;this.preCall=null;this.currentCall=null;this.useVideo=true;this.localVideoStream=null;this.selectedCameraId="";this.selectedMicrophoneId="";this.localVideoTimeout=null;this.conferencePageTagInterval=null;this.onCallUserInvitedHandler=this.onCallUserInvited.bind(this);this.onCallUserStateChangedHandler=this.onCallUserStateChanged.bind(this);this.onCallUserMicrophoneStateHandler=this.onCallUserMicrophoneState.bind(this);this.onCallLocalMediaReceivedHandler=this.onCallLocalMediaReceived.bind(this);this.onCallUserStreamReceivedHandler=this.onCallUserStreamReceived.bind(this);this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onCallLeaveHandler=this.onCallLeave.bind(this);this.onCallDestroyHandler=this.onCallDestroy.bind(this);this.onPreCallDestroyHandler=this.onPreCallDestroy.bind(this);this.onPreCallUserStateChangedHandler=this.onPreCallUserStateChanged.bind(this);this.initRestClient().then(function(){return t.subscribePreCallChanges()}).then(function(){return t.initPullClient()}).then(function(){return t.initCore()}).then(function(){return t.initComponent()}).then(function(){return t.initUser()}).then(function(){return t.startPageTagInterval()}).then(function(){return t.tryJoinExistingCall()}).then(function(){return t.initCall()}).then(function(){return t.initPullHandlers()}).then(function(){return t.subscribeToStoreChanges()}).then(function(){return t.initComplete()})}babelHelpers.createClass(e,[{key:"initRestClient",value:function e(){console.log("1. initRestClient");this.restClient=new B({endpoint:this.getHost()+"/rest"});return new Promise(function(e,t){return e()})}},{key:"initPullClient",value:function e(){console.log("2. initPullClient");if(!this.params.isIntranetOrExtranet){this.pullClient=new u.PullClient({serverEnabled:true,userId:this.params.userId,siteId:this.params.siteId,restClient:this.restClient,skipStorageInit:true,configTimestamp:0,skipCheckRevision:true,getPublicListMethod:"im.call.channel.public.list"});return new Promise(function(e,t){return e()})}else{this.pullClient=BX.PULL;return this.pullClient.start().then(function(){return new Promise(function(e,t){return e()})})}}},{key:"initPullHandlers",value:function e(){this.pullClient.subscribe(new o.ImCallPullHandler({store:this.controller.getStore(),application:this,controller:this.controller}));return new Promise(function(e,t){return e()})}},{key:"initCore",value:function e(){var t=this;console.log("3. initCore");this.controller=new S.Controller({host:this.getHost(),siteId:this.params.siteId,userId:this.params.userId,languageId:this.params.language,pull:{client:this.pullClient},rest:{client:this.restClient},vuexBuilder:{database:!h.Utils.browser.isIe(),databaseName:"imol/call",databaseType:I.VuexBuilder.DatabaseType.localStorage,models:[E.CallApplicationModel.create()]}});return new Promise(function(e,i){t.controller.ready().then(function(){return e()})})}},{key:"initComponent",value:function e(){var t=this;console.log("4. initComponent");this.controller.getStore().commit("application/set",{dialog:{chatId:this.getChatId(),dialogId:this.getDialogId()}});return this.controller.createVue(this,{el:this.rootNode,data:function e(){return{chatId:t.getChatId(),dialogId:t.getDialogId(),startupErrorCode:t.getStartupErrorCode()}},template:'<bx-im-application-call :chatId="chatId" :dialogId="dialogId" :startupErrorCode="startupErrorCode"/>'}).then(function(e){t.template=e;return new Promise(function(e,t){return e()})})}},{key:"initUser",value:function e(){var i=this;var r=t.LocalStorage.get(this.controller.getSiteId(),0,"conf".concat(this.params.alias));if(r){this.params.startupErrorCode=g.CallApplicationErrorCode.kickedFromCall}return new Promise(function(e,t){if(i.getStartupErrorCode()){return e()}console.log("5. initUser");if(i.params.userId>0){i.controller.setUserId(i.params.userId);if(i.params.isIntranetOrExtranet){i.switchToSessAuth();i.controller.getStore().commit("callApplication/user",{id:i.params.userId})}else{var r=i.getUserHashCookie();if(r){i.restClient.setAuthId(r);i.restClient.setChatId(i.getChatId());i.controller.getStore().commit("callApplication/user",{id:i.params.userId,hash:r});i.pullClient.start()}}i.controller.getStore().commit("callApplication/common",{inited:true});return e()}else{i.restClient.setAuthId("guest");i.restClient.setChatId(i.getChatId());if(typeof BX.SidePanel!=="undefined"){BX.SidePanel.Instance.disableAnchorBinding()}return i.restClient.callMethod("im.call.user.register",{alias:i.params.alias,user_hash:i.getUserHashCookie()||""}).then(function(t){i.controller.getStore().commit("callApplication/user",{id:t.data().id,hash:t.data().hash});i.controller.setUserId(t.data().id);if(t.data().created){i.params.userCount++}i.controller.getStore().commit("callApplication/common",{inited:true});i.restClient.setAuthId(t.data().hash);i.pullClient.start();return e()})}})}},{key:"startPageTagInterval",value:function e(){var i=this;return new Promise(function(e){clearInterval(i.conferencePageTagInterval);i.conferencePageTagInterval=setInterval(function(){t.LocalStorage.set(i.params.siteId,i.params.userId,BX.CallEngine.getConferencePageTag(i.params.dialogId),"Y",2)},1e3);e()})}},{key:"tryJoinExistingCall",value:function e(){this.restClient.callMethod("im.call.tryJoinCall",{entityType:"chat",entityId:this.params.dialogId,provider:BX.Call.Provider.Voximplant,type:BX.Call.Type.Permanent})}},{key:"subscribePreCallChanges",value:function e(){BX.addCustomEvent(window,"CallEvents::callCreated",this.onCallCreated.bind(this))}},{key:"onCallCreated",value:function e(t){if(this.preCall||this.currentCall){return}var i=t.call;if(i.associatedEntity.type==="chat"&&i.associatedEntity.id===this.params.dialogId){this.preCall=t.call;this.updatePreCallCounter();this.preCall.addEventListener(BX.Call.Event.onUserStateChanged,this.onPreCallUserStateChangedHandler);this.preCall.addEventListener(BX.Call.Event.onDestroy,this.onPreCallDestroyHandler)}}},{key:"releasePreCall",value:function e(){if(this.preCall){this.preCall.removeEventListener(BX.Call.Event.onUserStateChanged,this.onPreCallUserStateChangedHandler);this.preCall.removeEventListener(BX.Call.Event.onDestroy,this.onPreCallDestroyHandler);this.preCall=null}}},{key:"onPreCallDestroy",value:function e(t){this.releasePreCall()}},{key:"onPreCallUserStateChanged",value:function e(t){this.updatePreCallCounter()}},{key:"updatePreCallCounter",value:function e(){if(this.preCall){this.controller.getStore().commit("callApplication/common",{userInCallCount:this.preCall.getParticipatingUsers().length})}else{this.controller.getStore().commit("callApplication/common",{userInCallCount:0})}}},{key:"initCall",value:function e(){var t=this;BX.CallEngine.setRestClient(this.restClient);BX.CallEngine.setPullClient(this.pullClient);BX.CallEngine.setCurrentUserId(this.controller.getUserId());this.callContainer=document.getElementById("bx-im-component-call-container");return new Promise(function(e,i){BX.Call.Hardware.init().then(function(){if(Object.values(BX.Call.Hardware.microphoneList).length===0){t.setComponentError(g.CallApplicationErrorCode.missingMicrophone)}t.callView=new BX.Call.View({container:t.callContainer,showChatButtons:true,showShareButton:true,userLimit:BX.Call.Util.getUserLimit(),language:t.params.language,uiState:BX.Call.View.UiState.Preparing});t.callView.setCallback("onButtonClick",t.onCallButtonClick.bind(t));t.callView.disableAddUser();t.callView.disableHistoryButton();t.callView.show();return t.getLocalVideo()}).catch(function(e){if(e==="NO_WEBRTC"&&t.isHttps()){t.setComponentError(g.CallApplicationErrorCode.unsupportedBrowser)}else if(e==="NO_WEBRTC"&&!t.isHttps()){t.setComponentError(g.CallApplicationErrorCode.unsafeConnection)}}).then(function(i){if(i){t.callView.setLocalStream(i,true)}e()})})}},{key:"subscribeToStoreChanges",value:function e(){var t=this;this.controller.getStore().subscribe(function(e,i){var r=e.payload,l=e.type;if(l==="users/update"&&r.fields.name){if(t.callView){t.callView.updateUserData(babelHelpers.defineProperty({},r.id,{name:r.fields.name}))}}else if(l==="dialogues/update"&&typeof r.fields.counter==="number"){if(t.callView){t.callView.setButtonCounter("chat",r.fields.counter)}}else if(l==="dialogues/update"&&r.fields.name){document.title=r.fields.name}})}},{key:"initComplete",value:function e(){this.controller.getStore().commit("callApplication/common",{userCount:this.params.userCount});this.inited=true;this.initPromise.resolve(this)}},{key:"ready",value:function e(){if(this.inited){var t=new BX.Promise;t.resolve(this);return t}return this.initPromise}},{key:"getLocalVideo",value:function e(){var t=this;return new Promise(function(e,i){if(t.localVideoStream){return e(t.localVideoStream)}navigator.mediaDevices.getUserMedia({video:{width:{ideal:BX.Call.Hardware.preferHdQuality?1280:640},height:{ideal:BX.Call.Hardware.preferHdQuality?720:360}}}).then(function(i){t.localVideoStream=i;clearTimeout(t.localVideoTimeout);t.controller.getStore().commit("callApplication/common",{callError:""});if(BX.Call.Util.hasHdVideo(t.localVideoStream)){BX.Call.Hardware.preferHdQuality=true}e(i)}).catch(function(e){clearTimeout(t.localVideoTimeout);if(e.name==="OverconstrainedError"){BX.Call.Hardware.preferHdQuality=false}console.error(typeof e==="string"?e:e.name);t.controller.getStore().commit("callApplication/common",{callError:typeof e==="string"?e:e.name});i(e)});t.localVideoTimeout=setTimeout(function(){BX.Call.Hardware.preferHdQuality=false;t.controller.getStore().commit("callApplication/common",{callError:g.CallErrorCode.noSignalFromCamera})},5e3)})}},{key:"stopLocalVideo",value:function e(){if(!this.localVideoStream){return}this.localVideoStream.getTracks().forEach(function(e){return e.stop()});this.localVideoStream=null}},{key:"restart",value:function e(){if(this.currentCall){this.removeCallEvents();this.currentCall=null}if(this.callView){this.callView.releaseLocalMedia();this.callView.close();this.callView.destroy();this.callView=null}this.initCall();this.controller.getStore().commit("callApplication/returnToPreparation")}},{key:"startCall",value:function e(){var t=this;var i=BX.Call.Provider.Voximplant;BX.Call.Engine.getInstance().createCall({type:BX.Call.Type.Permanent,entityType:"chat",entityId:this.getDialogId(),provider:i,videoEnabled:true,enableMicAutoParameters:BX.Call.Hardware.enableMicAutoParameters,joinExisting:true}).then(function(e){console.warn("call created",e);t.currentCall=e.call;t.currentCall.useHdVideo(BX.Call.Hardware.preferHdQuality);if(BX.Call.Hardware.defaultMicrophone){t.currentCall.setMicrophoneId(BX.Call.Hardware.defaultMicrophone)}if(BX.Call.Hardware.defaultCamera){t.currentCall.setCameraId(BX.Call.Hardware.defaultCamera)}t.callView.setUiState(BX.Call.View.UiState.Calling);t.callView.setLayout(BX.Call.View.Layout.Grid);t.callView.appendUsers(t.currentCall.getUsers());BX.Call.Util.getUsers(t.currentCall.id,t.getCallUsers(true)).then(function(e){t.callView.updateUserData(e)});t.bindCallEvents();if(e.isNew){t.currentCall.setVideoEnabled(t.useVideo);t.currentCall.inviteUsers()}else{t.currentCall.answer({useVideo:t.useVideo})}}).catch(function(e){console.warn("creating call error",e)});this.controller.getStore().commit("callApplication/startCall")}},{key:"endCall",value:function e(){if(this.currentCall){this.removeCallEvents();this.currentCall.hangup()}this.controller.getStore().commit("callApplication/endCall");this.restart();window.close()}},{key:"kickFromCall",value:function e(){this.setComponentError(g.CallApplicationErrorCode.kickedFromCall);this.pullClient.disconnect();this.endCall();t.LocalStorage.set(this.controller.getSiteId(),0,"conf".concat(this.params.alias),true)}},{key:"getCallUsers",value:function e(t){var i=Object.keys(this.currentCall.getUsers());if(t){i.push(this.currentCall.userId)}return i}},{key:"onCallButtonClick",value:function e(t){var i=t.buttonName;console.warn("Button clicked!",i);var r={hangup:this.onCallViewHangupButtonClick.bind(this),close:this.onCallViewCloseButtonClick.bind(this),toggleMute:this.onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this.onCallViewToggleScreenSharingButtonClick.bind(this),toggleVideo:this.onCallViewToggleVideoButtonClick.bind(this),showChat:this.onCallViewShowChatButtonClick.bind(this),share:this.onCallViewShareButtonClick.bind(this),fullscreen:this.onCallViewFullScreenButtonClick.bind(this)};if(r[i]){r[i](t)}else{console.error("Button handler not found!",i)}}},{key:"onCallViewHangupButtonClick",value:function e(t){this.endCall()}},{key:"onCallViewCloseButtonClick",value:function e(t){this.endCall()}},{key:"onCallViewToggleMuteButtonClick",value:function e(t){if(this.currentCall){this.currentCall.setMuted(t.muted)}this.callView.setMuted(t.muted)}},{key:"onCallViewToggleScreenSharingButtonClick",value:function e(){if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing()}else{this.callView.releaseLocalMedia();this.currentCall.startScreenSharing()}}},{key:"onCallViewToggleVideoButtonClick",value:function e(t){var i=this;this.useVideo=t.video;if(!this.useVideo){this.callView.releaseLocalMedia();this.stopLocalVideo()}if(this.currentCall){this.currentCall.setVideoEnabled(t.video)}else{if(this.useVideo){this.getLocalVideo().then(function(e){return i.callView.setLocalStream(e,true)})}else{this.callView.setLocalStream(new MediaStream)}}}},{key:"onCallViewShareButtonClick",value:function e(){BX.UI.Notification.Center.notify({content:s.Loc.getMessage("BX_IM_VIDEOCONF_LINK_COPY_DONE"),autoHideDelay:4e3});l.Clipboard.copy(this.getDialogData().public.link)}},{key:"onCallViewFullScreenButtonClick",value:function e(){this.callView.toggleFullScreen()}},{key:"onCallViewShowChatButtonClick",value:function e(){this.toggleChat()}},{key:"bindCallEvents",value:function e(){this.currentCall.addEventListener(BX.Call.Event.onUserInvited,this.onCallUserInvitedHandler);this.currentCall.addEventListener(BX.Call.Event.onDestroy,this.onCallDestroyHandler);this.currentCall.addEventListener(BX.Call.Event.onUserStateChanged,this.onCallUserStateChangedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserMicrophoneState,this.onCallUserMicrophoneStateHandler);this.currentCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this.onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onStreamReceived,this.onCallUserStreamReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(BX.Call.Event.onLeave,this.onCallLeaveHandler)}},{key:"removeCallEvents",value:function e(){this.currentCall.removeEventListener(BX.Call.Event.onUserInvited,this.onCallUserInvitedHandler);this.currentCall.removeEventListener(BX.Call.Event.onDestroy,this.onCallDestroyHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserStateChanged,this.onCallUserStateChangedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserMicrophoneState,this.onCallUserMicrophoneStateHandler);this.currentCall.removeEventListener(BX.Call.Event.onLocalMediaReceived,this.onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onStreamReceived,this.onCallUserStreamReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(BX.Call.Event.onLeave,this.onCallLeaveHandler)}},{key:"onCallUserInvited",value:function e(t){var i=this;this.callView.addUser(t.userId);BX.Call.Util.getUsers(this.currentCall.id,[t.userId]).then(function(e){i.callView.updateUserData(e)})}},{key:"onCallUserStateChanged",value:function e(t){this.callView.setUserState(t.userId,t.state)}},{key:"onCallUserMicrophoneState",value:function e(t){this.callView.setUserMicrophoneState(t.userId,t.microphoneState)}},{key:"onCallLocalMediaReceived",value:function e(t){this.callView.setLocalStream(t.stream,t.tag=="main");this.callView.setButtonActive("screen",t.tag=="screen");if(t.tag=="screen"){this.callView.disableSwitchCamera();this.callView.updateButtons()}else{if(!this.currentCall.callFromMobile){this.callView.enableSwitchCamera();this.callView.updateButtons()}}}},{key:"onCallUserStreamReceived",value:function e(t){this.callView.setStream(t.userId,t.stream)}},{key:"onCallUserVoiceStarted",value:function e(t){this.callView.setUserTalking(t.userId,true)}},{key:"onCallUserVoiceStopped",value:function e(t){this.callView.setUserTalking(t.userId,false)}},{key:"onCallLeave",value:function e(t){this.restart()}},{key:"onCallDestroy",value:function e(t){this.currentCall=null;this.restart()}},{key:"onCheckDevicesSave",value:function e(t){if(t["camera"]){BX.Call.Hardware.defaultCamera=t["camera"]}if(t["microphone"]){BX.Call.Hardware.defaultMicrophone=t["microphone"]}if(t["audioOutput"]){BX.Call.Hardware.defaultSpeaker=t["audioOutput"]}if(t["preferHDQuality"]){BX.Call.Hardware.preferHdQuality=t["preferHDQuality"]}if(t["enableMicAutoParameters"]){BX.Call.Hardware.enableMicAutoParameters=t["enableMicAutoParameters"]}}},{key:"setCallError",value:function e(t){this.controller.getStore().commit("callApplication/setCallError",{errorCode:t})}},{key:"setComponentError",value:function e(t){this.controller.getStore().commit("callApplication/setComponentError",{errorCode:t})}},{key:"isChatShow",value:function e(){return this.controller.getStore().state.callApplication.common.showChat}},{key:"toggleChat",value:function e(){var t=!this.isChatShow();this.controller.getStore().state.callApplication.common.showChat=t;this.callView.setButtonActive("chat",t)}},{key:"setUserName",value:function e(t){var i=this;this.restClient.callMethod("im.call.user.update",{name:t,chat_id:this.getChatId()}).then(function(){i.template.isSettingNewName=false})}},{key:"setDialogInited",value:function e(){this.dialogInited=true;var t=this.getDialogData();document.title=t.name}},{key:"changeVideoconfUrl",value:function e(t){window.history.pushState("","",t)}},{key:"sendNewMessageNotify",value:function e(t){var i=this;var r=40;var l=4e3;t=t.replace(/<br \/>/gi," ");t=t.replace(/\[USER=([0-9]+)](.*?)\[\/USER]/gi,function(e,t,i){return i});t=t.replace(/\[CHAT=(imol\|)?([0-9]+)](.*?)\[\/CHAT]/gi,function(e,t,i,r){return r});t=t.replace(/\[PCH=([0-9]+)](.*?)\[\/PCH]/gi,function(e,t,i){return i});t=t.replace(/\[SEND(?:=(.+?))?](.+?)?\[\/SEND]/gi,function(e,t,i){return i?i:t});t=t.replace(/\[PUT(?:=(.+?))?](.+?)?\[\/PUT]/gi,function(e,t,i){return i?i:t});t=t.replace(/\[CALL(?:=(.+?))?](.+?)?\[\/CALL]/gi,function(e,t,i){return i?i:t});t=t.replace(/\[ATTACH=([0-9]+)]/gi,function(e,t,i){return""});if(t.length>r){t=t.substring(0,r-1)+"..."}var a=BX.create("div",{props:{className:"bx-im-application-call-notify-new-message"},html:t});var n=BX.UI.Notification.Center.notify({content:a,autoHideDelay:l});a.addEventListener("click",function(e){n.close();i.toggleChat()})}},{key:"insertText",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.template.$emit(g.EventType.textarea.insertText,t)}},{key:"addMessage",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!i&&!r){return false}if(!this.controller.application.isUnreadMessagesLoaded()){this.sendMessage({id:0,text:i,file:r});this.processSendMessages();return true}var l={};if(r){l.FILE_ID=[r.id]}this.controller.getStore().commit("application/increaseDialogExtraCount");this.controller.getStore().dispatch("messages/add",{chatId:this.getChatId(),authorId:this.controller.getUserId(),text:i,params:l,sending:!r}).then(function(e){t.messagesQueue.push({id:e,text:i,file:r,sending:false});t.processSendMessages()});return true}},{key:"processSendMessages",value:function e(){var t=this;this.messagesQueue.filter(function(e){return!e.sending}).forEach(function(e){e.sending=true;if(e.file){t.sendMessageWithFile(e)}else{t.sendMessage(e)}});return true}},{key:"sendMessage",value:function e(t){var i=this;this.controller.application.stopWriting();t.chatId=this.getChatId();this.controller.restClient.callMethod(g.RestMethod.imMessageAdd,{TEMPLATE_ID:t.id,CHAT_ID:t.chatId,MESSAGE:t.text},null,null).then(function(e){i.controller.getStore().dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{id:e.data(),sending:false,error:false}}).then(function(){i.controller.getStore().dispatch("messages/actionFinish",{id:e.data(),chatId:t.chatId})})}).catch(function(e){});return true}},{key:"sendMessageWithFile",value:function e(t){var i=this;this.controller.application.stopWriting();var r=this.controller.getStore().getters["files/get"](this.getChatId(),t.file.id,true).type;var l=this.getDiskFolderId();var a={};if(l){a[g.RestMethod.imDiskFileUpload]=[g.RestMethod.imDiskFileUpload,{id:l,data:{NAME:t.file.source.files[0].name},fileContent:t.file.source,generateUniqueName:true}]}else{a[g.RestMethod.imDiskFolderGet]=[g.RestMethod.imDiskFolderGet,{chat_id:this.getChatId()}];a[g.RestMethod.imDiskFileUpload]=[g.RestMethod.imDiskFileUpload,{id:"$result["+g.RestMethod.imDiskFolderGet+"][ID]",data:{NAME:t.file.source.files[0].name},fileContent:t.file.source,generateUniqueName:true}]}this.controller.restClient.callBatch(a,function(e){if(!e){i.requestDataSend=false;console.warn("EMPTY_RESPONSE","Server returned an empty response. [1]");i.fileError(i.getChatId,t.file.id,t.id);return false}if(!l){var a=e[g.RestMethodHandler.imDiskFolderGet];if(a&&a.error()){console.warn(a.error().ex.error,a.error().ex.error_description);i.fileError(i.getChatId(),t.file.id,t.id);return false}i.controller.getStore().commit("application/set",{dialog:{diskFolderId:a.ID}})}var n=0;var o=e[g.RestMethod.imDiskFileUpload];if(o){var s=o.data();if(o.error()){console.warn(o.error().ex.error,o.error().ex.error_description);i.fileError(i.getChatId(),t.file.id,t.id);return false}else if(!s){console.warn("EMPTY_RESPONSE","Server returned an empty response. [2]");i.fileError(i.getChatId(),t.file.id,t.id);return false}n=s.ID}else{console.warn("EMPTY_RESPONSE","Server returned an empty response. [3]");i.fileError(i.getChatId(),t.file.id,t.id);return false}t.chatId=i.getChatId();i.controller.getStore().dispatch("files/update",{chatId:t.chatId,id:t.file.id,fields:{status:g.FileStatus.wait,progress:95}});i.fileCommit({chatId:t.chatId,uploadId:n,messageText:t.text,messageId:t.id,fileId:t.file.id,fileType:r},t)},false,function(e){t.xhr=e})}},{key:"uploadFile",value:function e(t){var i=this;if(!t){return false}console.warn("addFile",t.files[0].name,t.files[0].size,t.files[0]);var r=t.files[0];var l="file";if(r.type.toString().startsWith("image")){l="image"}this.controller.getStore().dispatch("files/add",{chatId:this.getChatId(),authorId:this.controller.getUserId(),name:r.name,type:l,extension:r.name.split(".").splice(-1)[0],size:r.size,image:false,status:g.FileStatus.upload,progress:0,authorName:this.controller.application.getCurrentUser().name,urlPreview:""}).then(function(e){return i.addMessage("",{id:e,source:t})});return true}},{key:"fileError",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.controller.getStore().dispatch("files/update",{chatId:t,id:i,fields:{status:g.FileStatus.error,progress:0}});if(r){this.controller.getStore().dispatch("messages/actionError",{chatId:t,id:r,retry:false})}}},{key:"fileCommit",value:function e(t,i){var r=this;this.controller.restClient.callMethod(g.RestMethod.imDiskFileCommit,{chat_id:t.chatId,upload_id:t.uploadId,message:t.messageText,template_id:t.messageId,file_template_id:t.fileId},null,null).then(function(e){r.controller.getStore().dispatch("messages/update",{id:i.id,chatId:i.chatId,fields:{id:e["MESSAGE_ID"],sending:false,error:false}}).then(function(){r.controller.getStore().dispatch("messages/actionFinish",{id:e["MESSAGE_ID"],chatId:i.chatId})})}).catch(function(e){});return true}},{key:"addLocalize",value:function e(t){return this.controller.addLocalize(t)}},{key:"getLocalize",value:function e(t){return this.controller.getLocalize(t)}},{key:"isUserRegistered",value:function e(){return!!this.getUserHash()}},{key:"getChatId",value:function e(){return parseInt(this.params.chatId)}},{key:"getDialogId",value:function e(){return this.params.dialogId}},{key:"getDialogData",value:function e(){if(!this.dialogInited){return false}return this.controller.getStore().getters["dialogues/get"](this.getDialogId())}},{key:"getHost",value:function e(){return location.origin||""}},{key:"getStartupErrorCode",value:function e(){return this.params.startupErrorCode?this.params.startupErrorCode:""}},{key:"getDiskFolderId",value:function e(){return this.controller.getStore().state.application.dialog.diskFolderId}},{key:"isHttps",value:function e(){return location.protocol==="https:"}},{key:"getUserHash",value:function e(){return this.controller.getStore().state.callApplication.user.hash}},{key:"getUserHashCookie",value:function e(){var t="";var i=v.Cookie.get(null,"BITRIX_CALL_HASH");if(typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){t=i}return t}},{key:"getAlias",value:function e(){return this.params.alias?this.params.alias:""}},{key:"switchToSessAuth",value:function e(){this.restClient.restClient.queryParams=undefined;return true}}]);return e}();e.CallApplication=k})(this.BX.Messenger.Application=this.BX.Messenger.Application||{},BX.Messenger.Lib,BX,BX,BX.Messenger.Lib,BX,BX.UI,BX.Messenger.Provider.Pull,BX,BX,BX,BX,BX.Messenger.Lib,BX,BX.Messenger,BX.Messenger,window,BX.Messenger.Const,BX.Messenger.Lib,BX.Messenger.Model,BX,BX.Messenger);
//# sourceMappingURL=call.bundle.map.js