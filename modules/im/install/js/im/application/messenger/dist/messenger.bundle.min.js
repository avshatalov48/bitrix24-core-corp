this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(t,e,i,n,r,a,s,o,l,c,d,u,h,p,g){"use strict";function f(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function v(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?f(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):f(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var b=function(){function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);if(babelHelpers["typeof"](i.store)==="object"&&i.store){this.store=i.store}this.dialog=new BX.UI.EntitySelector.Dialog({targetNode:i.targetNode,enableSearch:true,context:"IM_CHAT_SEARCH",multiple:false,entities:[{id:"user",filters:[{id:"im.userDataFilter"}]},{id:"department"},{id:"im-chat",options:{searchableChatTypes:["C","L","O"]}},{id:"im-bot",options:{searchableBotTypes:["H","B","S","N"]}}],events:{"Item:onSelect":function t(i){return e.onItemSelect(i)},onLoad:function t(i){return e.fillStore(i)}}})}babelHelpers.createClass(t,[{key:"onItemSelect",value:function t(e){this.dialog.deselectAll();var i=e.getData().item;var n=this.getDialogIdByItem(i);if(!n){return}u.EventEmitter.emit(p.EventType.dialog.open,{id:n,$event:e})}},{key:"fillStore",value:function t(e){var i=e.getTarget();var n=i.getItems();var r=[];var a=[];n.forEach((function(t){var e=t.getCustomData();var i=t.getEntityId();if(i==="user"||i==="im-bot"){var n=e.get("imUser")["ID"];if(!n){return}r.push(v({dialogId:n},e.get("imUser")))}else if(i==="im-chat"){var s="chat"+e.get("imChat")["ID"];if(!s){return}a.push(v({dialogId:s},e.get("imChat")))}}));this.store.dispatch("users/set",r);this.store.dispatch("dialogues/set",a)}},{key:"getDialogIdByItem",value:function t(e){switch(e.getEntityId()){case"user":case"im-bot":return e.getCustomData().get("imUser")["ID"];case"im-chat":return"chat"+e.getCustomData().get("imChat")["ID"]}return null}},{key:"open",value:function t(){this.dialog.show()}}]);return t}();function m(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function y(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?m(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):m(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}r.BitrixVue.component("bx-im-application-messenger",{props:{userId:{type:Number,default:0}},data:function t(){return{selectedDialogId:0,notificationsSelected:false,textareaHeight:120}},computed:y({DeviceType:function t(){return p.DeviceType},textareaHeightStyle:function t(){return{flex:"0 0 ".concat(this.textareaHeight,"px")}},isDialog:function t(){return s.Utils.dialog.isChatId(this.selectedDialogId)},chatId:function t(){if(this.application){return this.application.dialog.chatId}return 0},dialogId:function t(){if(this.application){return this.application.dialog.dialogId}return 0},localize:function t(){return r.BitrixVue.getFilteredPhrases(["IM_DIALOG_","IM_UTILS_","IM_MESSENGER_DIALOG_","IM_QUOTE_"],this)}},a.Vuex.mapState({application:function t(e){return e.application}})),created:function t(){this.initEventHandlers();this.searchPopup=null;this.subscribeToEvents()},beforeDestroy:function t(){this.unsubscribeEvents();this.destroyHandlers()},methods:{initEventHandlers:function t(){this.textareaDragHandler=this.getTextareaDragHandler();this.readingHandler=new g.ReadingHandler(this.$Bitrix);this.reactionHandler=new g.ReactionHandler(this.$Bitrix);this.quoteHandler=new g.QuoteHandler(this.$Bitrix);this.textareaHandler=new g.TextareaHandler(this.$Bitrix);this.sendMessageHandler=new g.SendMessageHandler(this.$Bitrix);this.textareaUploadHandler=new g.TextareaUploadHandler(this.$Bitrix);this.dialogActionHandler=new g.DialogActionHandler(this.$Bitrix)},destroyHandlers:function t(){this.textareaDragHandler.destroy();this.readingHandler.destroy();this.reactionHandler.destroy();this.quoteHandler.destroy();this.textareaHandler.destroy();this.textareaUploadHandler.destroy();this.dialogActionHandler.destroy()},getTextareaDragHandler:function t(){var e=this,i;return new g.TextareaDragHandler((i={},babelHelpers.defineProperty(i,g.TextareaDragHandler.events.onHeightChange,(function(t){var i=t.data;var n=i.newHeight;if(e.textareaHeight!==n){e.textareaHeight=n}})),babelHelpers.defineProperty(i,g.TextareaDragHandler.events.onStopDrag,(function(){u.EventEmitter.emit(p.EventType.dialog.scrollToBottom,{chatId:e.chatId,force:true})})),i))},openSearch:function t(){if(!this.searchPopup){this.searchPopup=new b({targetNode:document.querySelector("#bx-im-next-layout-recent-search-input"),store:this.$store})}this.searchPopup.open()},openMessenger:function t(e){e=e.toString();if(e==="notify"){this.selectedDialogId=0;this.notificationsSelected=true}else{this.selectedDialogId=e;this.notificationsSelected=false}},subscribeToEvents:function t(){u.EventEmitter.subscribe(p.EventType.dialog.open,this.onOpenMessenger)},unsubscribeEvents:function t(){u.EventEmitter.unsubscribe(p.EventType.dialog.open,this.onOpenMessenger)},onOpenMessenger:function t(e){var i=e.data;this.openMessenger(i.id)},onTextareaStartDrag:function t(e){this.textareaDragHandler.onStartDrag(e,this.textareaHeight);u.EventEmitter.emit(p.EventType.textarea.setBlur,true)}},template:'\n\t  \t<div class="bx-im-next-layout">\n\t\t\t<div class="bx-im-next-layout-recent">\n\t\t\t\t<div class="bx-im-next-layout-recent-search">\n\t\t\t\t\t<div class="bx-im-next-layout-recent-search-input" id="bx-im-next-layout-recent-search-input" @click="openSearch">Search</div>  \n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-next-layout-recent-list">\n\t\t\t\t\t<bx-im-component-recent/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-next-layout-dialog" v-if="selectedDialogId">\n\t\t\t\t<div class="bx-im-next-layout-dialog-header">\n\t\t\t\t\t<div class="bx-im-header-title">Dialog: {{selectedDialogId}}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-next-layout-dialog-messages">\n\t\t\t\t  \t<bx-pull-component-status/>\n\t\t\t\t\t<bx-im-component-dialog\n\t\t\t\t\t\t:userId="userId" \n\t\t\t\t\t\t:dialogId="selectedDialogId"\n\t\t\t\t\t\t:showMessageUserName="isDialog"\n\t\t\t\t\t\t:showMessageAvatar="isDialog"\n\t\t\t\t\t />\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-next-layout-dialog-textarea" :style="textareaHeightStyle" ref="textarea">\n\t\t\t\t  \t<div class="bx-im-next-layout-dialog-textarea-handle" @mousedown="onTextareaStartDrag" @touchstart="onTextareaStartDrag"></div>\n\t\t\t\t\t<bx-im-component-textarea\n\t\t\t\t\t\t:siteId="application.common.siteId"\n\t\t\t\t\t\t:userId="userId"\n\t\t\t\t\t\t:dialogId="selectedDialogId"\n\t\t\t\t\t\t:writesEventLetter="3"\n\t\t\t\t\t\t:enableEdit="true"\n\t\t\t\t\t\t:enableCommand="false"\n\t\t\t\t\t\t:enableMention="false"\n\t\t\t\t\t\t:enableFile="true"\n\t\t\t\t\t\t:autoFocus="application.device.type !== DeviceType.mobile"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-next-layout-notify" v-else-if="notificationsSelected">\n\t\t\t\t<bx-im-component-notifications :darkTheme="false"/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-next-layout-notify" v-else>\n\t\t\t\t<div class="bx-messenger-box-hello-wrap">\n\t\t\t\t  <div class="bx-messenger-box-hello">{{ $Bitrix.Loc.getMessage(\'IM_M_EMPTY\') }}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'});
/**
	 * Bitrix Im
	 * Messenger application
	 *
	 * @package bitrix
	 * @subpackage im
	 * @copyright 2001-2020 Bitrix
	 */var x=function(){function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"inited",false);babelHelpers.defineProperty(this,"initPromise",null);babelHelpers.defineProperty(this,"initPromiseResolver",null);babelHelpers.defineProperty(this,"vueInstance",null);babelHelpers.defineProperty(this,"controller",null);babelHelpers.defineProperty(this,"rootNode",null);this.initPromise=new Promise((function(t){e.initPromiseResolver=t}));this.params=i;this.rootNode=this.params.node||document.createElement("div");this.initCore().then((function(){return e.initComponent()})).then((function(){return e.initComplete()}))}babelHelpers.createClass(t,[{key:"initCore",value:function t(){var i=this;return new Promise((function(t){e.Core.ready().then((function(e){i.controller=e;t()}))}))}},{key:"initComponent",value:function t(){var e=this;this.setInitialApplicationInfo();this.setDialogRestHandler();this.setApplicationDialogInfo();return this.controller.createVue(this,{el:this.rootNode,data:function t(){return{userId:e.getUserId()}},template:'<bx-im-application-messenger :userId="userId" />'}).then((function(t){e.vueInstance=t;return Promise.resolve()}))}},{key:"initComplete",value:function t(){this.inited=true;this.initPromiseResolver(this)}},{key:"ready",value:function t(){if(this.inited){return Promise.resolve(this)}return this.initPromise}},{key:"setInitialApplicationInfo",value:function t(){this.controller.getStore().commit("application/set",{dialog:{dialogId:this.getDialogId()},options:{quoteEnable:true,autoplayVideo:true,darkBackground:false}})}},{key:"setApplicationDialogInfo",value:function t(){var e=this.controller.getStore().getters["dialogues/get"](this.getDialogId());if(!e){return false}this.controller.getStore().commit("application/set",{dialog:{chatId:e.chatId,diskFolderId:e.diskFolderId||0}})}},{key:"setDialogRestHandler",value:function t(){this.controller.addRestAnswerHandler(n.DialogRestHandler.create({store:this.controller.getStore(),controller:this.controller,context:this}))}},{key:"getUserId",value:function t(){var e=this.params.userId||this.getLocalize("USER_ID");return e?Number.parseInt(e,10):0}},{key:"getDialogId",value:function t(){return this.params.dialogId?this.params.dialogId.toString():"0"}},{key:"getHost",value:function t(){return location.origin||""}},{key:"getSiteId",value:function t(){return"s1"}},{key:"addLocalize",value:function t(e){return this.controller.addLocalize(e)}},{key:"getLocalize",value:function t(e){return this.controller.getLocalize(e)}}]);return t}();t.MessengerApplication=x})(this.BX.Messenger.Application=this.BX.Messenger.Application||{},BX.Messenger.Application,BX.Messenger,BX.Messenger.Provider.Rest,BX,BX,BX.Messenger.Lib,BX.Messenger,BX.Messenger,window,window,BX.Event,BX.UI.EntitySelector,BX.Messenger.Const,BX.Messenger.EventHandler);
//# sourceMappingURL=messenger.bundle.map.js