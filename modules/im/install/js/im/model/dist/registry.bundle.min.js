this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,n,a,r,o,s){"use strict";var l=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"application"}},{key:"getState",value:function e(){return{common:{host:this.getVariable("common.host",location.protocol+"//"+location.host),siteId:this.getVariable("common.siteId","default"),userId:this.getVariable("common.userId",0),languageId:this.getVariable("common.languageId","en")},dialog:{dialogId:this.getVariable("dialog.dialogId","0"),chatId:this.getVariable("dialog.chatId",0),diskFolderId:this.getVariable("dialog.diskFolderId",0),messageLimit:this.getVariable("dialog.messageLimit",20),enableReadMessages:this.getVariable("dialog.enableReadMessages",true),messageExtraCount:0},disk:{enabled:false,maxFileSize:5242880},call:{serverEnabled:false,maxParticipants:24},mobile:{keyboardShow:false},device:{type:this.getVariable("device.type",n.DeviceType.desktop),orientation:this.getVariable("device.orientation",n.DeviceOrientation.portrait)},options:{quoteEnable:this.getVariable("options.quoteEnable",true),quoteFromRight:this.getVariable("options.quoteFromRight",true),autoplayVideo:this.getVariable("options.autoplayVideo",true),darkBackground:this.getVariable("options.darkBackground",false),showSmiles:false},error:{active:false,code:"",description:""}}}},{key:"getStateSaveException",value:function e(){return Object.assign({common:this.getVariable("saveException.common",null),dialog:this.getVariable("saveException.dialog",null),mobile:this.getVariable("saveException.mobile",null),device:this.getVariable("saveException.device",null),error:this.getVariable("saveException.error",null)})}},{key:"getActions",value:function e(){var t=this;return{set:function e(i,n){i.commit("set",t.validate(n))},showSmiles:function e(t,i){t.commit("showSmiles")},hideSmiles:function e(t,i){t.commit("hideSmiles")}}}},{key:"getMutations",value:function e(){var t=this;return{set:function e(i,n){var a=false;for(var r in n){if(!n.hasOwnProperty(r)){continue}for(var o in n[r]){if(!n[r].hasOwnProperty(o)){continue}i[r][o]=n[r][o];a=true}}if(a&&t.isSaveNeeded(n)){t.saveState(i)}},increaseDialogExtraCount:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.count,a=n===void 0?1:n;t.dialog.messageExtraCount+=a},decreaseDialogExtraCount:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.count,a=n===void 0?1:n;var r=t.dialog.messageExtraCount-a;if(r<=0){r=0}t.dialog.messageExtraCount=r},clearDialogExtraCount:function e(t){t.dialog.messageExtraCount=0},showSmiles:function e(t){t.options.showSmiles=true},hideSmiles:function e(t){t.options.showSmiles=false}}}},{key:"validate",value:function e(t){var i={};if(babelHelpers.typeof(t.common)==="object"&&t.common){i.common={};if(typeof t.common.userId==="number"){i.common.userId=t.common.userId}if(typeof t.common.languageId==="string"){i.common.languageId=t.common.languageId}}if(babelHelpers.typeof(t.dialog)==="object"&&t.dialog){i.dialog={};if(typeof t.dialog.dialogId==="number"){i.dialog.dialogId=t.dialog.dialogId.toString();i.dialog.chatId=0}else if(typeof t.dialog.dialogId==="string"){i.dialog.dialogId=t.dialog.dialogId;if(typeof t.dialog.chatId!=="number"){var a=t.dialog.dialogId;if(a.startsWith("chat")){a=t.dialog.dialogId.substr(4)}a=parseInt(a);i.dialog.chatId=!isNaN(a)?a:0;t.dialog.chatId=i.dialog.chatId}}if(typeof t.dialog.chatId==="number"){i.dialog.chatId=t.dialog.chatId}if(typeof t.dialog.diskFolderId==="number"){i.dialog.diskFolderId=t.dialog.diskFolderId}if(typeof t.dialog.messageLimit==="number"){i.dialog.messageLimit=t.dialog.messageLimit}if(typeof t.dialog.messageExtraCount==="number"){i.dialog.messageExtraCount=t.dialog.messageExtraCount}if(typeof t.dialog.enableReadMessages==="boolean"){i.dialog.enableReadMessages=t.dialog.enableReadMessages}}if(babelHelpers.typeof(t.disk)==="object"&&t.disk){i.disk={};if(typeof t.disk.enabled==="boolean"){i.disk.enabled=t.disk.enabled}if(typeof t.disk.maxFileSize==="number"){i.disk.maxFileSize=t.disk.maxFileSize}}if(babelHelpers.typeof(t.call)==="object"&&t.call){i.call={};if(typeof t.call.serverEnabled==="boolean"){i.call.serverEnabled=t.call.serverEnabled}if(typeof t.call.maxParticipants==="number"){i.call.maxParticipants=t.call.maxParticipants}}if(babelHelpers.typeof(t.mobile)==="object"&&t.mobile){i.mobile={};if(typeof t.mobile.keyboardShow==="boolean"){i.mobile.keyboardShow=t.mobile.keyboardShow}}if(babelHelpers.typeof(t.device)==="object"&&t.device){i.device={};if(typeof t.device.type==="string"&&typeof n.DeviceType[t.device.type]!=="undefined"){i.device.type=t.device.type}if(typeof t.device.orientation==="string"&&typeof n.DeviceOrientation[t.device.orientation]!=="undefined"){i.device.orientation=t.device.orientation}}if(babelHelpers.typeof(t.error)==="object"&&t.error){if(typeof t.error.active==="boolean"){i.error={active:t.error.active,code:t.error.code.toString()||"",description:t.error.description.toString()||""}}}return i}}]);return t}(r.VuexBuilderModel);var c=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"conference"}},{key:"getState",value:function e(){return{common:{inited:false,passChecked:true,showChat:false,userCount:0,messageCount:0,userInCallCount:0,state:n.ConferenceStateType.preparation,callEnded:false,showSmiles:false,error:"",conferenceTitle:"",alias:"",permissionsRequested:false,conferenceStarted:null,conferenceStartDate:null,joinWithVideo:null,userReadyToJoin:false,isBroadcast:false,users:[],usersInCall:[],presenters:[],rightPanelMode:n.ConferenceRightPanelMode.hidden},user:{id:-1,hash:""}}}},{key:"getActions",value:function e(){return{showChat:function e(t,i){if(typeof i.newState!=="boolean"){return false}t.commit("showChat",i)},changeRightPanelMode:function e(t,i){if(!n.ConferenceRightPanelMode[i.mode]){return false}t.commit("changeRightPanelMode",i)},setPermissionsRequested:function e(t,i){t.commit("setPermissionsRequested",i)},setPresenters:function e(t,i){if(!Array.isArray(i.presenters)){i.presenters=[i.presenters]}t.commit("setPresenters",i)},setUsers:function e(t,i){if(!Array.isArray(i.users)){i.users=[i.users]}t.commit("setUsers",i)},removeUsers:function e(t,i){if(!Array.isArray(i.users)){i.users=[i.users]}t.commit("removeUsers",i)},setUsersInCall:function e(t,i){if(!Array.isArray(i.users)){i.users=[i.users]}t.commit("setUsersInCall",i)},removeUsersInCall:function e(t,i){if(!Array.isArray(i.users)){i.users=[i.users]}t.commit("removeUsersInCall",i)},setConferenceTitle:function e(t,i){if(typeof i.conferenceTitle!=="string"){return false}t.commit("setConferenceTitle",i)},setBroadcastMode:function e(t,i){if(typeof i.broadcastMode!=="boolean"){return false}t.commit("setBroadcastMode",i)}}}},{key:"getMutations",value:function e(){var t=this;return{common:function e(t,i){if(typeof i.inited==="boolean"){t.common.inited=i.inited}if(typeof i.passChecked==="boolean"){t.common.passChecked=i.passChecked}if(typeof i.userCount==="number"||typeof i.userCount==="string"){t.common.userCount=parseInt(i.userCount)}if(typeof i.messageCount==="number"||typeof i.messageCount==="string"){t.common.messageCount=parseInt(i.messageCount)}if(typeof i.userInCallCount==="number"||typeof i.userInCallCount==="string"){t.common.userInCallCount=parseInt(i.userInCallCount)}if(typeof i.componentError==="string"){t.common.componentError=i.componentError}if(typeof i.isBroadcast==="boolean"){t.common.isBroadcast=i.isBroadcast}if(Array.isArray(i.presenters)){t.common.presenters=i.presenters}},user:function e(i,n){if(typeof n.id==="number"){i.user.id=n.id}if(typeof n.hash==="string"&&n.hash!==i.user.hash){i.user.hash=n.hash}if(t.isSaveNeeded({user:n})){t.saveState(i)}},showChat:function e(t,i){var n=i.newState;t.common.showChat=n},changeRightPanelMode:function e(t,i){var n=i.mode;t.common.rightPanelMode=n},setPermissionsRequested:function e(t,i){t.common.permissionsRequested=true},startCall:function e(t,i){t.common.state=n.ConferenceStateType.call;t.common.callEnded=false},endCall:function e(t,i){t.common.state=n.ConferenceStateType.preparation;t.common.callEnded=true},returnToPreparation:function e(t,i){t.common.state=n.ConferenceStateType.preparation},toggleSmiles:function e(t,i){t.common.showSmiles=!t.common.showSmiles},setError:function e(t,i){if(typeof i.errorCode==="string"){t.common.error=i.errorCode}},setConferenceTitle:function e(t,i){t.common.conferenceTitle=i.conferenceTitle},setBroadcastMode:function e(t,i){t.common.isBroadcast=i.broadcastMode},setAlias:function e(t,i){if(typeof i.alias==="string"){t.common.alias=i.alias}},setJoinType:function e(t,i){if(typeof i.joinWithVideo==="boolean"){t.common.joinWithVideo=i.joinWithVideo}},setConferenceStatus:function e(t,i){if(typeof i.conferenceStarted==="boolean"){t.common.conferenceStarted=i.conferenceStarted}},setConferenceStartDate:function e(t,i){if(i.conferenceStartDate instanceof Date){t.common.conferenceStartDate=i.conferenceStartDate}},setUserReadyToJoin:function e(t,i){t.common.userReadyToJoin=true},setPresenters:function e(t,i){if(i.replace){t.common.presenters=i.presenters}else{i.presenters.forEach(function(e){e=parseInt(e);if(!t.common.presenters.includes(e)){t.common.presenters.push(e)}})}},setUsers:function e(t,i){i.users.forEach(function(e){e=parseInt(e);if(!t.common.users.includes(e)){t.common.users.push(e)}})},removeUsers:function e(t,i){t.common.users=t.common.users.filter(function(e){return!i.users.includes(parseInt(e))})},setUsersInCall:function e(t,i){i.users.forEach(function(e){e=parseInt(e);if(!t.common.usersInCall.includes(e)){t.common.usersInCall.push(e)}})},removeUsersInCall:function e(t,i){t.common.usersInCall=t.common.usersInCall.filter(function(e){return!i.users.includes(parseInt(e))})}}}},{key:"getStateSaveException",value:function e(){return{common:{inited:null,state:null,showSmiles:null,userCount:null,messageCount:null,userInCallCount:null,error:null,conferenceTitle:null,alias:null,conferenceStarted:null,conferenceStartDate:null,joinWithVideo:null,userReadyToJoin:null,rightPanelMode:null,presenters:null,users:null}}}}]);return t}(r.VuexBuilderModel);function d(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=u(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,o=false,s;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(o)throw s}}}}function u(e,t){if(!e)return;if(typeof e==="string")return f(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return f(e,t)}function f(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var p={empty:"empty",equal:"equal",none:"none",found:"found",foundReverse:"foundReverse"};var m=function(e){babelHelpers.inherits(r,e);function r(){babelHelpers.classCallCheck(this,r);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(r).apply(this,arguments))}babelHelpers.createClass(r,[{key:"getName",value:function e(){return"messages"}},{key:"getState",value:function e(){return{created:0,collection:{},mutationType:{},saveMessageList:{},saveFileList:{},saveUserList:{},host:this.getVariable("host",location.protocol+"//"+location.host)}}},{key:"getElementState",value:function e(){return{templateId:0,templateType:"message",placeholderType:0,id:0,chatId:0,authorId:0,date:new Date,text:"",textConverted:"",params:{TYPE:"default",COMPONENT_ID:"bx-im-view-message"},push:false,unread:false,sending:false,error:false,retry:false,blink:false}}},{key:"getGetters",value:function e(){var t=this;return{getMutationType:function e(t){return function(e){if(!t.mutationType[e]){return{initialType:n.MutationType.none,appliedType:n.MutationType.none}}return t.mutationType[e]}},getLastId:function e(t){return function(e){if(!t.collection[e]||t.collection[e].length<=0){return null}var i=0;for(var n=0;n<t.collection[e].length;n++){var a=t.collection[e][n];if(a.push||a.sending||a.id.toString().startsWith("temporary")){continue}if(i<a.id){i=a.id}}return i?i:null}},getMessage:function e(t){return function(e,i){if(!t.collection[e]||t.collection[e].length<=0){return null}for(var n=t.collection[e].length-1;n>=0;n--){if(t.collection[e][n].id===i){return t.collection[e][n]}}return null}},get:function e(t){return function(e){if(!t.collection[e]||t.collection[e].length<=0){return[]}return t.collection[e]}},getBlank:function e(i){return function(e){return t.getElementState()}},getSaveFileList:function e(t){return function(e){return t.saveFileList}},getSaveUserList:function e(t){return function(e){return t.saveUserList}}}}},{key:"getActions",value:function e(){var t=this;return{add:function e(i,n){var a=t.validate(Object.assign({},n));a.params=Object.assign({},t.getElementState().params,a.params);a.id="temporary"+(new Date).getTime()+i.state.created;a.templateId=a.id;a.unread=false;i.commit("add",Object.assign({},t.getElementState(),a));if(n.sending!==false){i.dispatch("actionStart",{id:a.id,chatId:a.chatId})}return a.id},actionStart:function e(t,i){if(/^\d+$/.test(i.id)){i.id=parseInt(i.id)}i.chatId=parseInt(i.chatId);a.Vue.nextTick(function(){t.commit("update",{id:i.id,chatId:i.chatId,fields:{sending:true}})})},actionError:function e(t,i){if(/^\d+$/.test(i.id)){i.id=parseInt(i.id)}i.chatId=parseInt(i.chatId);a.Vue.nextTick(function(){t.commit("update",{id:i.id,chatId:i.chatId,fields:{sending:false,error:true,retry:i.retry!==false}})})},actionFinish:function e(t,i){if(/^\d+$/.test(i.id)){i.id=parseInt(i.id)}i.chatId=parseInt(i.chatId);a.Vue.nextTick(function(){t.commit("update",{id:i.id,chatId:i.chatId,fields:{sending:false,error:false,retry:false}})})},set:function e(i,a){if(a instanceof Array){a=a.map(function(e){return t.prepareMessage(e,{host:i.state.host})})}else{var r=t.prepareMessage(a,{host:i.state.host});(a=[]).push(r)}i.commit("set",{insertType:n.MutationType.set,data:a});return"set is done"},addPlaceholders:function e(i,a){if(a.placeholders instanceof Array){a.placeholders=a.placeholders.map(function(e){return t.prepareMessage(e,{host:i.state.host})})}else{return false}var r=a.requestMode==="history"?n.MutationType.setBefore:n.MutationType.setAfter;if(r===n.MutationType.setBefore){a.placeholders=a.placeholders.reverse()}i.commit("set",{insertType:r,data:a.placeholders});return a.placeholders[0].id},clearPlaceholders:function e(t,i){t.commit("clearPlaceholders",i)},updatePlaceholders:function e(i,n){if(n.data instanceof Array){n.data=n.data.map(function(e){return t.prepareMessage(e,{host:i.state.host})})}else{return false}i.commit("updatePlaceholders",n);return true},setAfter:function e(i,a){if(a instanceof Array){a=a.map(function(e){return t.prepareMessage(e)})}else{var r=t.prepareMessage(a);(a=[]).push(r)}i.commit("set",{insertType:n.MutationType.setAfter,data:a})},setBefore:function e(i,a){if(a instanceof Array){a=a.map(function(e){return t.prepareMessage(e)})}else{var r=t.prepareMessage(a);(a=[]).push(r)}i.commit("set",{insertType:n.MutationType.setBefore,data:a})},update:function e(i,n){if(/^\d+$/.test(n.id)){n.id=parseInt(n.id)}if(/^\d+$/.test(n.chatId)){n.chatId=parseInt(n.chatId)}i.commit("initCollection",{chatId:n.chatId});if(!i.state.collection[n.chatId]){return false}var a=i.state.collection[n.chatId].findIndex(function(e){return e.id===n.id});if(a<0){return false}var r=t.validate(Object.assign({},n.fields));if(r.params){r.params=Object.assign({},t.getElementState().params,i.state.collection[n.chatId][a].params,r.params)}i.commit("update",{id:n.id,chatId:n.chatId,index:a,fields:r});if(n.fields.blink){setTimeout(function(){i.commit("update",{id:n.id,chatId:n.chatId,fields:{blink:false}})},1e3)}return true},delete:function e(t,i){if(!(i.id instanceof Array)){i.id=[i.id]}i.id=i.id.map(function(e){if(/^\d+$/.test(e)){e=parseInt(e)}return e});t.commit("delete",{chatId:i.chatId,elements:i.id});return true},clear:function e(t,i){i.chatId=parseInt(i.chatId);if(i.keepPlaceholders){t.commit("clearMessages",{chatId:i.chatId})}else{t.commit("clear",{chatId:i.chatId})}return true},applyMutationType:function e(t,i){i.chatId=parseInt(i.chatId);t.commit("applyMutationType",{chatId:i.chatId});return true},readMessages:function e(t,i){i.readId=parseInt(i.readId)||0;i.chatId=parseInt(i.chatId);if(typeof t.state.collection[i.chatId]==="undefined"){return{count:0}}var n=0;for(var a=t.state.collection[i.chatId].length-1;a>=0;a--){var r=t.state.collection[i.chatId][a];if(!r.unread)continue;if(i.readId===0||r.id<=i.readId){n++}}t.commit("readMessages",{chatId:i.chatId,readId:i.readId});return{count:n}},unreadMessages:function e(t,i){i.unreadId=parseInt(i.unreadId)||0;i.chatId=parseInt(i.chatId);if(typeof t.state.collection[i.chatId]==="undefined"||!i.unreadId){return{count:0}}var n=0;for(var a=t.state.collection[i.chatId].length-1;a>=0;a--){var r=t.state.collection[i.chatId][a];if(r.unread)continue;if(r.id>=i.unreadId){n++}}t.commit("unreadMessages",{chatId:i.chatId,unreadId:i.unreadId});return{count:n}}}}},{key:"getMutations",value:function e(){var r=this;return{initCollection:function e(t,i){return r.initCollection(t,i)},add:function e(i,n){r.initCollection(i,{chatId:n.chatId});i.collection[n.chatId].push(n);i.saveMessageList[n.chatId].push(n.id);i.created+=1;i.collection[n.chatId].sort(function(e,t){return e.id-t.id});r.saveState(i,n.chatId);t.Logger.warn("Messages model: saving state after add")},clearPlaceholders:function e(t,i){if(!t.collection[i.chatId]){return false}t.collection[i.chatId]=t.collection[i.chatId].filter(function(e){return!e.id.toString().startsWith("placeholder")})},updatePlaceholders:function e(i,n){var a="placeholder".concat(n.firstMessage);var o=i.collection[n.chatId].findIndex(function(e){return e.id===a});if(o>=0){var s;i.collection[n.chatId].splice(o,n.amount);(s=i.collection[n.chatId]).splice.apply(s,[o,0].concat(babelHelpers.toConsumableArray(n.data)))}i.collection[n.chatId].sort(function(e,t){return e.id-t.id});t.Logger.warn("Messages model: saving state after updating placeholders");r.saveState(i,n.chatId)},set:function e(a,o){t.Logger.warn("Messages model: set mutation",o);var s=[];var l=[];var c=false;var u=o.insertType;if(o.insertType===n.MutationType.set){(function(){o.insertType=n.MutationType.setAfter;var e={};o.data.forEach(function(t){if(!e[t.chatId]){e[t.chatId]=[]}e[t.chatId].push(t.id)});var i=function i(s){if(!e.hasOwnProperty(s))return"continue";r.initCollection(a,{chatId:s});t.Logger.warn("Messages model: messages before adding from request - ",a.collection[s].length);if(a.saveMessageList[s].length>e[s].length||e[s].length<n.StorageLimit.messages){a.collection[s]=a.collection[s].filter(function(t){return e[s].includes(t.id)});a.saveMessageList[s]=a.saveMessageList[s].filter(function(t){return e[s].includes(t)})}t.Logger.warn("Messages model: cache length",a.saveMessageList[s].length);var l=r.manageCacheBeforeSet(babelHelpers.toConsumableArray(a.saveMessageList[s].reverse()),e[s]);t.Logger.warn("Messages model: set intersection with cache",l);if(l.type===p.none){if(l.foundElements.length>0){a.collection[s]=a.collection[s].filter(function(e){return!l.foundElements.includes(e.id)});a.saveMessageList[s]=a.saveMessageList[s].filter(function(e){return!l.foundElements.includes(e)})}t.Logger.warn("Messages model: no intersection - removing cache");r.removeIntersectionCacheElements=a.collection[s].map(function(e){return e.id});a.collection[s]=a.collection[s].filter(function(e){return!r.removeIntersectionCacheElements.includes(e.id)});a.saveMessageList[s]=a.saveMessageList[s].filter(function(e){return!r.removeIntersectionCacheElements.includes(e)});r.removeIntersectionCacheElements=[]}else if(l.type===p.foundReverse){t.Logger.warn("Messages model: found reverse intersection");o.insertType=n.MutationType.setBefore;o.data=o.data.reverse()}};for(var s in e){var l=i(s);if(l==="continue")continue}})()}t.Logger.warn("Messages model: adding messages to model",o.data);var f=d(o.data),m;try{var h=function e(){var t=m.value;r.initCollection(a,{chatId:t.chatId});var i=a.collection[t.chatId].findIndex(function(e){return e.id===t.id});if(i>-1){delete t.templateId;a.collection[t.chatId][i]=Object.assign(a.collection[t.chatId][i],t)}else if(o.insertType===n.MutationType.setBefore){a.collection[t.chatId].unshift(t)}else if(o.insertType===n.MutationType.setAfter){a.collection[t.chatId].push(t)}s.push(t.chatId);if(r.store.getters["dialogues/canSaveChat"]&&r.store.getters["dialogues/canSaveChat"](t.chatId)){l.push(t.chatId)}};for(f.s();!(m=f.n()).done;){h()}}catch(e){f.e(e)}finally{f.f()}s=babelHelpers.toConsumableArray(new Set(s));l=babelHelpers.toConsumableArray(new Set(l));c=o.data.every(function(e){return e.push===true});t.Logger.warn("Is it fake push message?",c);s.forEach(function(e){a.collection[e].sort(function(e,t){return e.id-t.id});if(!c){t.Logger.warn("setting messagesSet = true for chatId = ",e);setTimeout(function(){i.EventEmitter.emit(n.EventType.dialog.messagesSet,{chatId:e});i.EventEmitter.emit(n.EventType.dialog.readVisibleMessages,{chatId:e})},100)}});if(u!==n.MutationType.setBefore){l.forEach(function(e){t.Logger.warn("Messages model: saving state after set");r.saveState(a,e)})}},update:function e(i,n){r.initCollection(i,{chatId:n.chatId});var a=-1;if(typeof n.index!=="undefined"&&i.collection[n.chatId][n.index]){a=n.index}else{a=i.collection[n.chatId].findIndex(function(e){return e.id===n.id})}if(a>=0){var o=i.saveMessageList[n.chatId].includes(i.collection[n.chatId][a].id)||n.fields.id&&!n.fields.id.toString().startsWith("temporary")&&i.collection[n.chatId][a].id.toString().startsWith("temporary");delete n.fields.templateId;i.collection[n.chatId][a]=Object.assign(i.collection[n.chatId][a],n.fields);if(o){t.Logger.warn("Messages model: saving state after update");r.saveState(i,n.chatId)}}},delete:function e(i,n){r.initCollection(i,{chatId:n.chatId});i.collection[n.chatId]=i.collection[n.chatId].filter(function(e){return!n.elements.includes(e.id)});if(i.saveMessageList[n.chatId].length>0){var a=d(n.elements),o;try{for(a.s();!(o=a.n()).done;){var s=o.value;if(i.saveMessageList[n.chatId].includes(s)){t.Logger.warn("Messages model: saving state after delete");r.saveState(i,n.chatId);break}}}catch(e){a.e(e)}finally{a.f()}}},clear:function e(t,i){r.initCollection(t,{chatId:i.chatId});t.collection[i.chatId]=[];t.saveMessageList[i.chatId]=[]},clearMessages:function e(t,i){r.initCollection(t,{chatId:i.chatId});t.collection[i.chatId]=t.collection[i.chatId].filter(function(e){return e.id.toString().startsWith("placeholder")});t.saveMessageList[i.chatId]=[]},applyMutationType:function e(t,i){if(typeof t.mutationType[i.chatId]==="undefined"){a.Vue.set(t.mutationType,i.chatId,{applied:false,initialType:n.MutationType.none,appliedType:n.MutationType.none,scrollStickToTop:0,scrollMessageId:0})}t.mutationType[i.chatId].applied=true},readMessages:function e(i,n){r.initCollection(i,{chatId:n.chatId});var a=false;for(var o=i.collection[n.chatId].length-1;o>=0;o--){var s=i.collection[n.chatId][o];if(!s.unread)continue;if(n.readId===0||s.id<=n.readId){i.collection[n.chatId][o]=Object.assign(i.collection[n.chatId][o],{unread:false});a=true}}if(a){t.Logger.warn("Messages model: saving state after reading");r.saveState(i,n.chatId)}},unreadMessages:function e(i,n){r.initCollection(i,{chatId:n.chatId});var a=false;for(var o=i.collection[n.chatId].length-1;o>=0;o--){var s=i.collection[n.chatId][o];if(s.unread)continue;if(s.id>=n.unreadId){i.collection[n.chatId][o]=Object.assign(i.collection[n.chatId][o],{unread:true});a=true}}if(a){t.Logger.warn("Messages model: saving state after unreading");r.saveState(i,n.chatId);r.updateSubordinateStates()}}}}},{key:"initCollection",value:function e(t,i){if(typeof i.chatId==="undefined"){return false}if(typeof i.chatId==="undefined"||typeof t.collection[i.chatId]!=="undefined"){return true}a.Vue.set(t.collection,i.chatId,i.messages?[].concat(i.messages):[]);a.Vue.set(t.saveMessageList,i.chatId,[]);a.Vue.set(t.saveFileList,i.chatId,[]);a.Vue.set(t.saveUserList,i.chatId,[]);return true}},{key:"prepareMessage",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=this.validate(Object.assign({},t),i);n.params=Object.assign({},this.getElementState().params,n.params);n.templateId=n.id;return Object.assign({},this.getElementState(),n)}},{key:"manageCacheBeforeSet",value:function e(i,n){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;t.Logger.warn("manageCacheBeforeSet",i,n);var r={type:p.empty,foundElements:[],noneElements:[]};if(!i||i.length<=0){return r}var o=d(n),s;try{for(o.s();!(s=o.n()).done;){var l=s.value;if(i.includes(l)){if(r.type===p.empty){r.type=p.found}r.foundElements.push(l)}else{if(r.type===p.empty){r.type=p.none}r.noneElements.push(l)}}}catch(e){o.e(e)}finally{o.f()}if(r.type===p.found&&i.length===n.length&&r.foundElements.length===n.length){r.type=p.equal}else if(r.type===p.none&&!a&&r.foundElements.length>0){var c=this.manageCacheBeforeSet(i.reverse(),n.reverse(),true);if(c.type===p.found){c.type=p.foundReverse;return c}}return r}},{key:"updateSaveLists",value:function e(t,i){if(!this.isSaveAvailable()){return true}if(!i||!this.store.getters["dialogues/canSaveChat"]||!this.store.getters["dialogues/canSaveChat"](i)){return false}this.initCollection(t,{chatId:i});var a=0;var r=[];var o=[];var s=[];var l=this.store.getters["dialogues/getByChatId"](i);if(l&&l.type==="private"){s.push(parseInt(l.dialogId))}var c=0;for(var d=t.collection[i].length-1;d>=0;d--){if(t.collection[i][d].id.toString().startsWith("temporary")){continue}if(!t.collection[i][d].unread){c++}if(a>=n.StorageLimit.messages&&c===50){break}r.unshift(t.collection[i][d].id);a++}r=r.slice(0,n.StorageLimit.messages);t.collection[i].filter(function(e){return r.includes(e.id)}).forEach(function(e){if(e.authorId>0){s.push(e.authorId)}if(e.params.FILE_ID instanceof Array){o=e.params.FILE_ID.concat(o)}});t.saveMessageList[i]=r;t.saveFileList[i]=babelHelpers.toConsumableArray(new Set(o));t.saveUserList[i]=babelHelpers.toConsumableArray(new Set(s));return true}},{key:"getSaveTimeout",value:function e(){return 150}},{key:"saveState",value:function e(i,n){if(!this.updateSaveLists(i,n)){return false}babelHelpers.get(babelHelpers.getPrototypeOf(r.prototype),"saveState",this).call(this,function(){var e={collection:{},saveMessageList:{},saveUserList:{},saveFileList:{}};var n=function n(a){if(!i.saveMessageList.hasOwnProperty(a)){return"continue"}if(!i.collection[a]){return"continue"}if(!e.collection[a]){e.collection[a]=[]}i.collection[a].filter(function(e){return i.saveMessageList[a].includes(e.id)}).forEach(function(t){if(t.templateType!=="placeholder"){e.collection[a].push(t)}});t.Logger.warn("Cache after updating",e.collection[a]);e.saveMessageList[a]=i.saveMessageList[a];e.saveFileList[a]=i.saveFileList[a];e.saveUserList[a]=i.saveUserList[a]};for(var a in i.saveMessageList){var r=n(a);if(r==="continue")continue}return e})}},{key:"updateSubordinateStates",value:function e(){this.store.dispatch("users/saveState");this.store.dispatch("files/saveState")}},{key:"validate",value:function e(t,i){var n={};if(typeof t.id==="number"){n.id=t.id}else if(typeof t.id==="string"){if(t.id.startsWith("temporary")||t.id.startsWith("placeholder")){n.id=t.id}else{n.id=parseInt(t.id)}}if(typeof t.templateId==="number"){n.templateId=t.templateId}else if(typeof t.templateId==="string"){if(t.templateId.startsWith("temporary")){n.templateId=t.templateId}else{n.templateId=parseInt(t.templateId)}}if(typeof t.templateType==="string"){n.templateType=t.templateType}if(typeof t.placeholderType==="number"){n.placeholderType=t.placeholderType}if(typeof t.chat_id!=="undefined"){t.chatId=t.chat_id}if(typeof t.chatId==="number"||typeof t.chatId==="string"){n.chatId=parseInt(t.chatId)}if(typeof t.date!=="undefined"){n.date=o.Utils.date.cast(t.date)}if(typeof t.textOriginal==="string"||typeof t.textOriginal==="number"){n.text=t.textOriginal.toString();if(typeof t.text==="string"||typeof t.text==="number"){n.textConverted=this.convertToHtml({text:t.text.toString(),isConverted:true})}}else{if(typeof t.text_converted!=="undefined"){t.textConverted=t.text_converted}if(typeof t.textConverted==="string"||typeof t.textConverted==="number"){n.textConverted=t.textConverted.toString()}if(typeof t.text==="string"||typeof t.text==="number"){n.text=t.text.toString();var a=typeof n.textConverted!=="undefined";n.textConverted=this.convertToHtml({text:a?n.textConverted:n.text,isConverted:a})}}if(typeof t.senderId!=="undefined"){t.authorId=t.senderId}else if(typeof t.author_id!=="undefined"){t.authorId=t.author_id}if(typeof t.authorId==="number"||typeof t.authorId==="string"){if(t.system===true||t.system==="Y"){n.authorId=0}else{n.authorId=parseInt(t.authorId)}}if(babelHelpers.typeof(t.params)==="object"&&t.params!==null){var r=this.validateParams(t.params,i);if(r){n.params=r}}if(typeof t.push==="boolean"){n.push=t.push}if(typeof t.sending==="boolean"){n.sending=t.sending}if(typeof t.unread==="boolean"){n.unread=t.unread}if(typeof t.blink==="boolean"){n.blink=t.blink}if(typeof t.error==="boolean"||typeof t.error==="string"){n.error=t.error}if(typeof t.retry==="boolean"){n.retry=t.retry}return n}},{key:"validateParams",value:function e(t,i){var n={};try{for(var a in t){if(!t.hasOwnProperty(a)){continue}if(a==="COMPONENT_ID"){if(typeof t[a]==="string"&&BX.Vue.isComponent(t[a])){n[a]=t[a]}}else if(a==="LIKE"){if(t[a]instanceof Array){n["REACTION"]={like:t[a].map(function(e){return parseInt(e)})}}}else if(a==="CHAT_LAST_DATE"){n[a]=o.Utils.date.cast(t[a])}else if(a==="AVATAR"){if(t[a]){n[a]=t[a].startsWith("http")?t[a]:i.host+t[a]}}else if(a==="NAME"){if(t[a]){n[a]=t[a]}}else if(a==="ATTACH"){n[a]=this.decodeAttach(t[a])}else{n[a]=t[a]}}}catch(e){}var r=false;for(var s in n){if(!n.hasOwnProperty(s)){continue}r=true;break}return r?n:null}},{key:"convertToHtml",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.quote,n=i===void 0?true:i,a=t.image,r=a===void 0?true:a,o=t.text,s=o===void 0?"":o,l=t.highlightText,c=l===void 0?"":l,d=t.isConverted,u=d===void 0?false:d,f=t.enableBigSmile,p=f===void 0?true:f;s=s.trim();if(!u){s=s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}if(s.startsWith("/me")){s="<i>".concat(s.substr(4),"</i>")}else if(s.startsWith("/loud")){s="<b>".concat(s.substr(6),"</b>")}var m="&gt;&gt;";if(n&&s.indexOf(m)>=0){var h=s.split(u?"<br />":"\n");for(var g=0;g<h.length;g++){if(h[g].startsWith(m)){h[g]=h[g].replace(m,'<div class="bx-im-message-content-quote"><div class="bx-im-message-content-quote-wrap">');while(++g<h.length&&h[g].startsWith(m)){h[g]=h[g].replace(m,"")}h[g-1]+="</div></div><br>"}}s=h.join("<br />")}s=s.replace(/\n/gi,"<br />");s=s.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");s=this.decodeBbCode(s,false,p);if(n){s=s.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,t,i,n,a,r){return(r>0?"<br>":"")+'<div class="bx-im-message-content-quote"><div class="bx-im-message-content-quote-wrap"><div class="bx-im-message-content-quote-name"><span class="bx-im-message-content-quote-name-text">'+t+'</span><span class="bx-im-message-content-quote-name-time">'+i+"</span></div>"+n+"</div></div><br />"});s=s.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,t,i,n,a){return(a>0?"<br>":"")+'<div class="bx-im-message-content-quote"><div class="bx-im-message-content-quote-wrap">'+t+"</div></div><br />"})}if(r){var y=false;s=s.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,i,n){if(!i.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||i.indexOf("/docs/pub/")>0||i.indexOf("logout=yes")>0){return e}else{y=true;return(n>0?"<br />":"")+"<a"+t+' target="_blank" class="bx-im-element-file-image"><img src="'+i+'" class="bx-im-element-file-image-source-text" onerror="BX.Messenger.Model.MessagesModel.hideErrorImage(this)"></a></span>'}});if(y){s=s.replace(/<\/span>(\n?)<br(\s\/?)>/gi,"</span>").replace(/<br(\s\/?)>(\n?)<br(\s\/?)>(\n?)<span/gi,"<br /><span")}}if(c){s=s.replace(new RegExp("("+c.replace(/[\-\[\]\/{}()*+?.\\^$|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(p){s=s.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,function e(t,i,n,a,r,o){return i+parseInt(n,10)*1.7+a+parseInt(r,10)*1.7+o})}if(s.substr(-6)=="<br />"){s=s.substr(0,s.length-6)}s=s.replace(/<br><br \/>/gi,"<br />");s=s.replace(/<br \/><br>/gi,"<br />");return s}},{key:"decodeBbCode",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;return r.decodeBbCode({text:t,textOnly:i,enableBigSmile:n})}},{key:"decodeAttach",value:function e(t){var i=this;if(Array.isArray(t)){t.forEach(function(e){e=i.decodeAttach(e)})}else if(babelHelpers.typeof(t)==="object"&&t!==null){for(var n in t){if(t.hasOwnProperty(n)){t[n]=this.decodeAttach(t[n])}}}else{if(typeof t==="string"){t=o.Utils.text.htmlspecialcharsback(t)}}return t}}],[{key:"decodeBbCode",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.text,n=t.textOnly,a=n===void 0?false:n,r=t.enableBigSmile,s=r===void 0?true:r;var l=[];i=i.replace(/\[CODE\]\n?([\s\S]*?)\[\/CODE\]/gi,function(e,t){var i=l.length;l.push(t);return"####REPLACEMENT_MARK_"+i+"####"});i=i.replace(/\[url=([^\]]+)\](.*?)\[\/url\]/gi,function(e,t,i){var n=document.createElement("a");n.href=o.Utils.text.htmlspecialcharsback(t);n.target="_blank";n.text=o.Utils.text.htmlspecialcharsback(i);var a=["http:","https:","ftp:","file:","tel:","callto:","mailto:","skype:","viber:"];if(a.indexOf(n.protocol)<=-1){return e}return n.outerHTML});i=i.replace(/\[url\]([^\]]+)\[\/url\]/gi,function(e,t){t=o.Utils.text.htmlspecialcharsback(t);var i=document.createElement("a");i.href=t;i.target="_blank";i.text=t;var n=["http:","https:","ftp:","file:","tel:","callto:","mailto:","skype:","viber:"];if(n.indexOf(i.protocol)<=-1){return e}return i.outerHTML});i=i.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like"></span>');i=i.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike"></span>');i=i.replace(/\[BR\]/gi,"<br/>");i=i.replace(/\[([buis])\](.*?)\[(\/[buis])\]/gi,function(e,t,i,n){return"<"+t+">"+i+"<"+n+">"});i=i.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,i,n){return t?n:'<span class="bx-im-mention" data-type="CHAT" data-value="chat'+i+'">'+n+"</span>"});i=i.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,t,i){return'<span class="bx-im-mention" data-type="CALL" data-value="'+o.Utils.text.htmlspecialchars(t)+'">'+i+"</span>"});i=i.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,i){return i});i=i.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,t,i){var n="";i=i?i:t;t=(t?t:i).replace("<br />","\n");if(!a&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);n='<span class="bx-im-message-command-wrap">'+'<span class="bx-im-message-command" data-entity="send">'+i+"</span>"+'<span class="bx-im-message-command-data">'+t+"</span>"+"</span>"}else{n=i}return n});i=i.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,t,i){var n="";i=i?i:t;t=(t?t:i).replace("<br />","\n");if(!a&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);n='<span class="bx-im-message-command" data-entity="put">'+i+"</span>";n+='<span class="bx-im-message-command-data">'+t+"</span>"}else{n=i}return n});var c=0;if(s){c=i.replace(/\[icon\=([^\]]*)\]/gi,"").trim().length}i=i.replace(/\[icon\=([^\]]*)\]/gi,function(e){var t=e.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(t&&t[1]){t=t[1]}else{return""}var i={src:t,border:0};var n=e.match(/size\=(\d+)/i);if(n&&n[1]){i["width"]=n[1];i["height"]=n[1]}else{var a=e.match(/width\=(\d+)/i);if(a&&a[1]){i["width"]=a[1]}var r=e.match(/height\=(\d+)/i);if(r&&r[1]){i["height"]=r[1]}if(i["width"]&&!i["height"]){i["height"]=i["width"]}else if(i["height"]&&!i["width"]){i["width"]=i["height"]}else if(i["height"]&&i["width"]);else{i["width"]=20;i["height"]=20}}i["width"]=i["width"]>100?100:i["width"];i["height"]=i["height"]>100?100:i["height"];if(s&&c===0&&i["width"]===i["height"]&&i["width"]===20){i["width"]=40;i["height"]=40}var l=e.match(/title\=(.*[^\s\]])/i);if(l&&l[1]){l=l[1];if(l.indexOf("width=")>-1){l=l.substr(0,l.indexOf("width="))}if(l.indexOf("height=")>-1){l=l.substr(0,l.indexOf("height="))}if(l.indexOf("size=")>-1){l=l.substr(0,l.indexOf("size="))}if(l){i["title"]=o.Utils.text.htmlspecialchars(l).trim();i["alt"]=i["title"]}}var d="";for(var u in i){if(i.hasOwnProperty(u)){d+=u+'="'+i[u]+'" '}}return'<img class="bx-smile bx-icon" '+d+">"});l.forEach(function(e,t){i=i.replace("####REPLACEMENT_MARK_"+t+"####",!a?'<div class="bx-im-message-content-code">'+e+"</div>":e)});return i}},{key:"hideErrorImage",value:function e(t){if(t.parentNode&&t.parentNode){t.parentNode.innerHTML='<a href="'+t.src+'" target="_blank">'+t.src+"</a>"}return true}}]);return r}(r.VuexBuilderModel);function h(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=g(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,o=false,s;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(o)throw s}}}}function g(e,t){if(!e)return;if(typeof e==="string")return y(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return y(e,t)}function y(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var v=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"dialogues"}},{key:"getState",value:function e(){return{host:this.getVariable("host",location.protocol+"//"+location.host),collection:{},saveDialogList:[],saveChatList:[]}}},{key:"getStateSaveException",value:function e(){return{host:null}}},{key:"getElementStateSaveException",value:function e(){return{writingList:null,quoteId:null}}},{key:"getElementState",value:function e(){return{dialogId:"0",chatId:0,counter:0,userCounter:0,messageCount:0,unreadId:0,lastMessageId:0,managerList:[],readedList:[],writingList:[],muteList:[],textareaMessage:"",quoteId:0,editId:0,init:false,name:"",owner:0,extranet:false,avatar:"",color:"#17A3EA",type:"chat",entityType:"",entityId:"",entityData1:"",entityData2:"",entityData3:"",dateCreate:new Date,restrictions:{avatar:true,extend:true,leave:true,leaveOwner:true,rename:true},public:{code:"",link:""}}}},{key:"getGetters",value:function e(){var t=this;return{get:function e(t){return function(e){if(!t.collection[e]){return null}return t.collection[e]}},getByChatId:function e(t){return function(e){e=parseInt(e);for(var i in t.collection){if(!t.collection.hasOwnProperty(i)){continue}if(t.collection[i].chatId===e){return t.collection[i]}}return null}},getBlank:function e(i){return function(e){return t.getElementState()}},getQuoteId:function e(t){return function(e){if(!t.collection[e]){return 0}return t.collection[e].quoteId}},getEditId:function e(t){return function(e){if(!t.collection[e]){return 0}return t.collection[e].editId}},canSaveChat:function e(t){return function(e){if(/^\d+$/.test(e)){e=parseInt(e)}return t.saveChatList.includes(parseInt(e))}},canSaveDialog:function e(t){return function(e){return t.saveDialogList.includes(e.toString())}},isPrivateDialog:function e(t){return function(e){e=e.toString();return t.collection[e.toString()]&&t.collection[e].type==="private"}}}}},{key:"getActions",value:function e(){var t=this;return{set:function e(i,n){if(n instanceof Array){n=n.map(function(e){return Object.assign({},t.validate(Object.assign({},e),{host:i.state.host}),{init:true})})}else{var a=[];a.push(Object.assign({},t.validate(Object.assign({},n),{host:i.state.host}),{init:true}));n=a}i.commit("set",n)},update:function e(i,n){if(typeof i.state.collection[n.dialogId]==="undefined"||i.state.collection[n.dialogId].init===false){return true}i.commit("update",{dialogId:n.dialogId,fields:t.validate(Object.assign({},n.fields),{host:i.state.host})});return true},delete:function e(t,i){t.commit("delete",i.dialogId);return true},updateWriting:function e(i,n){if(typeof i.state.collection[n.dialogId]==="undefined"||i.state.collection[n.dialogId].init===false){return true}var a=i.state.collection[n.dialogId].writingList.findIndex(function(e){return e.userId===n.userId});if(n.action){if(a>=0){return true}else{var r=[].concat(i.state.collection[n.dialogId].writingList);r.unshift({userId:n.userId,userName:n.userName});i.commit("update",{actionName:"updateWriting/1",dialogId:n.dialogId,fields:t.validate({writingList:r},{host:i.state.host})})}}else{if(a>=0){var o=i.state.collection[n.dialogId].writingList.filter(function(e){return e.userId!==n.userId});i.commit("update",{actionName:"updateWriting/2",dialogId:n.dialogId,fields:t.validate({writingList:o},{host:i.state.host})});return true}else{return true}}return false},updateReaded:function e(i,n){if(typeof i.state.collection[n.dialogId]==="undefined"||i.state.collection[n.dialogId].init===false){return true}var a=i.state.collection[n.dialogId].readedList.filter(function(e){return e.userId!==n.userId});if(n.action){a.push({userId:n.userId,userName:n.userName||"",messageId:n.messageId,date:n.date||new Date})}i.commit("update",{actionName:"updateReaded",dialogId:n.dialogId,fields:t.validate({readedList:a},{host:i.state.host})});return false},increaseCounter:function e(t,i){var n;if(typeof t.state.collection[i.dialogId]==="undefined"||t.state.collection[i.dialogId].init===false){return true}var a=t.state.collection[i.dialogId].counter;if(a===100){return true}var r=a+i.count;if(r>100){r=100}var o=(n=t.rootState.application)===null||n===void 0?void 0:n.common.userId;var s=o&&t.state.collection[i.dialogId].muteList.includes(o);t.commit("update",{actionName:"increaseCounter",dialogId:i.dialogId,dialogMuted:s,fields:{counter:r,previousCounter:a}});return false},decreaseCounter:function e(t,i){if(typeof t.state.collection[i.dialogId]==="undefined"||t.state.collection[i.dialogId].init===false){return true}var n=t.state.collection[i.dialogId].counter;if(n===100){return true}var a=n-i.count;if(a<0){a=0}var r=i.unreadId>t.state.collection[i.dialogId].unreadId?i.unreadId:t.state.collection[i.dialogId].unreadId;if(t.state.collection[i.dialogId].unreadId!==r||t.state.collection[i.dialogId].counter!==a){var o;var s=t.state.collection[i.dialogId].counter;if(a===0){r=0}var l=(o=t.rootState.application)===null||o===void 0?void 0:o.common.userId;var c=l&&t.state.collection[i.dialogId].muteList.includes(l);t.commit("update",{actionName:"decreaseCounter",dialogId:i.dialogId,dialogMuted:c,fields:{counter:a,previousCounter:s,unreadId:r}})}return false},increaseMessageCounter:function e(t,i){if(typeof t.state.collection[i.dialogId]==="undefined"||t.state.collection[i.dialogId].init===false){return true}var n=t.state.collection[i.dialogId].messageCount;t.commit("update",{actionName:"increaseMessageCount",dialogId:i.dialogId,fields:{messageCount:n+i.count}})},saveDialog:function e(t,i){if(typeof t.state.collection[i.dialogId]==="undefined"||t.state.collection[i.dialogId].init===false){return true}t.commit("saveDialog",{dialogId:i.dialogId,chatId:i.chatId});return false}}}},{key:"getMutations",value:function e(){var t=this;return{initCollection:function e(i,n){t.initCollection(i,n)},saveDialog:function e(i,a){if(!(a.chatId>0&&a.dialogId.length>0)){return false}var r=i.saveDialogList.filter(function(e){return e!==a.dialogId});r.unshift(a.dialogId);r=r.slice(0,n.StorageLimit.dialogues);if(i.saveDialogList.join(",")===r.join(",")){return true}i.saveDialogList=r;var o=i.saveChatList.filter(function(e){return e!==a.chatId});o.unshift(a.chatId);i.saveChatList=o.slice(0,n.StorageLimit.dialogues);t.saveState(i)},set:function e(i,n){var a=h(n),r;try{for(a.s();!(r=a.n()).done;){var o=r.value;t.initCollection(i,{dialogId:o.dialogId});i.collection[o.dialogId]=Object.assign(t.getElementState(),i.collection[o.dialogId],o)}}catch(e){a.e(e)}finally{a.f()}t.saveState(i)},update:function e(i,n){t.initCollection(i,n);i.collection[n.dialogId]=Object.assign(i.collection[n.dialogId],n.fields);t.saveState(i)},delete:function e(i,n){delete i.collection[n.dialogId];t.saveState(i)}}}},{key:"initCollection",value:function e(t,i){if(typeof t.collection[i.dialogId]!=="undefined"){return true}a.Vue.set(t.collection,i.dialogId,this.getElementState());if(i.fields){t.collection[i.dialogId]=Object.assign(t.collection[i.dialogId],this.validate(Object.assign({},i.fields),{host:t.host}))}return true}},{key:"getSaveTimeout",value:function e(){return 100}},{key:"saveState",value:function e(){var i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.isSaveAvailable()){return true}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",this).call(this,function(){var e={collection:{},saveDialogList:[].concat(n.saveDialogList),saveChatList:[].concat(n.saveChatList)};n.saveDialogList.forEach(function(t){if(!n.collection[t])return false;e.collection[t]=Object.assign(i.getElementState(),i.cloneState(n.collection[t],i.getElementStateSaveException()))});return e})}},{key:"validate",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n={};i.host=i.host||this.getState().host;if(typeof t.dialog_id!=="undefined"){t.dialogId=t.dialog_id}if(typeof t.dialogId==="number"||typeof t.dialogId==="string"){n.dialogId=t.dialogId.toString()}if(typeof t.chat_id!=="undefined"){t.chatId=t.chat_id}else if(typeof t.id!=="undefined"){t.chatId=t.id}if(typeof t.chatId==="number"||typeof t.chatId==="string"){n.chatId=parseInt(t.chatId)}if(typeof t.quoteId==="number"){n.quoteId=parseInt(t.quoteId)}if(typeof t.editId==="number"){n.editId=parseInt(t.editId)}if(typeof t.counter==="number"||typeof t.counter==="string"){n.counter=parseInt(t.counter)}if(typeof t.user_counter==="number"||typeof t.user_counter==="string"){n.userCounter=parseInt(t.user_counter)}if(typeof t.userCounter==="number"||typeof t.userCounter==="string"){n.userCounter=parseInt(t.userCounter)}if(typeof t.message_count==="number"||typeof t.message_count==="string"){n.messageCount=parseInt(t.message_count)}if(typeof t.messageCount==="number"||typeof t.messageCount==="string"){n.messageCount=parseInt(t.messageCount)}if(typeof t.unread_id!=="undefined"){t.unreadId=t.unread_id}if(typeof t.unreadId==="number"||typeof t.unreadId==="string"){n.unreadId=parseInt(t.unreadId)}if(typeof t.last_message_id!=="undefined"){t.lastMessageId=t.last_message_id}if(typeof t.lastMessageId==="number"||typeof t.lastMessageId==="string"){n.lastMessageId=parseInt(t.lastMessageId)}if(typeof t.readed_list!=="undefined"){t.readedList=t.readed_list}if(typeof t.readedList!=="undefined"){n.readedList=[];if(t.readedList instanceof Array){t.readedList.forEach(function(e){var t={};if(typeof e.user_id!=="undefined"){e.userId=e.user_id}if(typeof e.user_name!=="undefined"){e.userName=e.user_name}if(typeof e.message_id!=="undefined"){e.messageId=e.message_id}if(!e.userId||!e.userName||!e.messageId){return false}t.userId=parseInt(e.userId);t.userName=e.userName.toString();t.messageId=parseInt(e.messageId);t.date=o.Utils.date.cast(e.date);n.readedList.push(t)})}}if(typeof t.writing_list!=="undefined"){t.writingList=t.writing_list}if(typeof t.writingList!=="undefined"){n.writingList=[];if(t.writingList instanceof Array){t.writingList.forEach(function(e){var t={};if(!e.userId){return false}t.userId=parseInt(e.userId);t.userName=o.Utils.text.htmlspecialcharsback(e.userName);n.writingList.push(t)})}}if(typeof t.manager_list!=="undefined"){t.managerList=t.manager_list}if(typeof t.managerList!=="undefined"){n.managerList=[];if(t.managerList instanceof Array){t.managerList.forEach(function(e){e=parseInt(e);if(e>0){n.managerList.push(e)}})}}if(typeof t.mute_list!=="undefined"){t.muteList=t.mute_list}if(typeof t.muteList!=="undefined"){n.muteList=[];if(t.muteList instanceof Array){t.muteList.forEach(function(e){e=parseInt(e);if(e>0){n.muteList.push(e)}})}else if(babelHelpers.typeof(t.muteList)==="object"){Object.entries(t.muteList).forEach(function(e){if(e[1]===true){var t=parseInt(e[0]);if(t>0){n.muteList.push(t)}}})}}if(typeof t.textareaMessage!=="undefined"){n.textareaMessage=t.textareaMessage.toString()}if(typeof t.title!=="undefined"){t.name=t.title}if(typeof t.name==="string"||typeof t.name==="number"){n.name=o.Utils.text.htmlspecialcharsback(t.name.toString())}if(typeof t.owner!=="undefined"){t.ownerId=t.owner}if(typeof t.ownerId==="number"||typeof t.ownerId==="string"){n.ownerId=parseInt(t.ownerId)}if(typeof t.extranet==="boolean"){n.extranet=t.extranet}if(typeof t.avatar==="string"){var a;if(!t.avatar||t.avatar.endsWith("/js/im/images/blank.gif")){a=""}else if(t.avatar.startsWith("http")){a=t.avatar}else{a=i.host+t.avatar}if(a){n.avatar=encodeURI(a)}}if(typeof t.color==="string"){n.color=t.color.toString()}if(typeof t.type==="string"){n.type=t.type.toString()}if(typeof t.entity_type!=="undefined"){t.entityType=t.entity_type}if(typeof t.entityType==="string"){n.entityType=t.entityType.toString()}if(typeof t.entity_id!=="undefined"){t.entityId=t.entity_id}if(typeof t.entityId==="string"||typeof t.entityId==="number"){n.entityId=t.entityId.toString()}if(typeof t.entity_data_1!=="undefined"){t.entityData1=t.entity_data_1}if(typeof t.entityData1==="string"){n.entityData1=t.entityData1.toString()}if(typeof t.entity_data_2!=="undefined"){t.entityData2=t.entity_data_2}if(typeof t.entityData2==="string"){n.entityData2=t.entityData2.toString()}if(typeof t.entity_data_3!=="undefined"){t.entityData3=t.entity_data_3}if(typeof t.entityData3==="string"){n.entityData3=t.entityData3.toString()}if(typeof t.date_create!=="undefined"){t.dateCreate=t.date_create}if(typeof t.dateCreate!=="undefined"){n.dateCreate=o.Utils.date.cast(t.dateCreate)}if(typeof t.dateLastOpen!=="undefined"){n.dateLastOpen=o.Utils.date.cast(t.dateLastOpen)}if(babelHelpers.typeof(t.restrictions)==="object"&&t.restrictions){n.restrictions={};if(typeof t.restrictions.AVATAR==="boolean"){n.restrictions.avatar=t.restrictions.AVATAR}if(typeof t.restrictions.EXTEND==="boolean"){n.restrictions.extend=t.restrictions.EXTEND}if(typeof t.restrictions.LEAVE==="boolean"){n.restrictions.leave=t.restrictions.LEAVE}if(typeof t.restrictions.LEAVE_OWNER==="boolean"){n.restrictions.leaveOwner=t.restrictions.LEAVE_OWNER}if(typeof t.restrictions.RENAME==="boolean"){n.restrictions.rename=t.restrictions.RENAME}}if(babelHelpers.typeof(t.public)==="object"&&t.public){n.public={};if(typeof t.public.code==="string"){n.public.code=t.public.code}if(typeof t.public.link==="string"){n.public.link=t.public.link}}return n}}]);return t}(r.VuexBuilderModel);function b(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=I(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,o=false,s;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(o)throw s}}}}function I(e,t){if(!e)return;if(typeof e==="string")return S(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return S(e,t)}function S(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var x=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"users"}},{key:"getState",value:function e(){this.startOnlineCheckInterval();return{host:this.getVariable("host",location.protocol+"//"+location.host),collection:{},onlineList:[],mobileOnlineList:[],absentList:[]}}},{key:"getElementState",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.id,n=i===void 0?0:i,a=t.name,r=a===void 0?this.getVariable("default.name",""):a,o=t.firstName,s=o===void 0?this.getVariable("default.name",""):o,l=t.lastName,c=l===void 0?"":l;return{id:n,name:r,firstName:s,lastName:c,workPosition:"",color:"#048bd0",avatar:"",gender:"M",birthday:false,isBirthday:false,extranet:false,network:false,bot:false,connector:false,externalAuthId:"default",status:"online",idle:false,lastActivityDate:false,mobileLastDate:false,isOnline:false,isMobileOnline:false,absent:false,isAbsent:false,departments:[],phones:{workPhone:"",personalMobile:"",personalPhone:"",innerPhone:""},init:false}}},{key:"getGetters",value:function e(){var t=this;return{get:function e(i){return function(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;e=parseInt(e);if(e<=0){if(n){e=0}else{return null}}if(!n&&(!i.collection[e]||!i.collection[e].init)){return null}if(!i.collection[e]){return t.getElementState({id:e})}return i.collection[e]}},getBlank:function e(i){return function(e){return t.getElementState(e)}},getList:function e(i){return function(e){var n=[];if(!Array.isArray(e)){return null}e.forEach(function(e){if(i.collection[e]){n.push(i.collection[e])}else{n.push(t.getElementState({id:e}))}});return n}}}}},{key:"getActions",value:function e(){var t=this;return{set:function e(i,n){if(n instanceof Array){n=n.map(function(e){return Object.assign({},t.getElementState(),t.validate(Object.assign({},e),{host:i.state.host}),{init:true})})}else{var a=[];a.push(Object.assign({},t.getElementState(),t.validate(Object.assign({},n),{host:i.state.host}),{init:true}));n=a}i.commit("set",n)},update:function e(i,n){n.id=parseInt(n.id);if(typeof i.state.collection[n.id]==="undefined"||i.state.collection[n.id].init===false){return true}i.commit("update",{id:n.id,fields:t.validate(Object.assign({},n.fields),{host:i.state.host})});return true},delete:function e(t,i){t.commit("delete",i.id);return true},saveState:function e(t,i){t.commit("saveState",{});return true}}}},{key:"getMutations",value:function e(){var t=this;return{set:function e(i,n){var a=b(n),r;try{var s=function e(){var n=r.value;t.initCollection(i,{id:n.id});i.collection[n.id]=Object.assign(i.collection[n.id],n);var a=o.Utils.user.getOnlineStatus(n);if(a.isOnline){i.collection[n.id].isOnline=true;t.addToOnlineList(i,n.id)}var s=o.Utils.user.isMobileActive(n);if(s){i.collection[n.id].isMobileOnline=true;t.addToMobileOnlineList(i,n.id)}if(n.birthday){var l=o.Utils.date.format(new Date,"d-m");if(n.birthday===l){i.collection[n.id].isBirthday=true;var c=t.getTimeToNextMidnight();setTimeout(function(){i.collection[n.id].isBirthday=false},c)}}if(n.absent){n.isAbsent=true;if(!i.absentList.includes(n.id)){t.addToAbsentList(i,n.id);var d=t.getTimeToNextMidnight();var u=1e3*60*60*24;setTimeout(function(){setInterval(function(){return t.startAbsentCheckInterval(i)},u)},d)}}t.saveState(i)};for(a.s();!(r=a.n()).done;){s()}}catch(e){a.e(e)}finally{a.f()}},update:function e(i,n){t.initCollection(i,n);if(typeof n.fields.lastActivityDate!=="undefined"&&i.collection[n.id].lastActivityDate){var a=i.collection[n.id].lastActivityDate.getTime();var r=n.fields.lastActivityDate.getTime();if(r>a){var s=o.Utils.user.getOnlineStatus(n.fields);if(s.isOnline){i.collection[n.id].isOnline=true;t.addToOnlineList(i,n.fields.id)}}}if(typeof n.fields.mobileLastDate!=="undefined"&&i.collection[n.id].mobileLastDate!==n.fields.mobileLastDate){var l=o.Utils.user.isMobileActive(n.fields);if(l){i.collection[n.id].isMobileOnline=true;t.addToMobileOnlineList(i,n.fields.id)}}i.collection[n.id]=Object.assign(i.collection[n.id],n.fields);t.saveState(i)},delete:function e(i,n){delete i.collection[n.id];t.saveState(i)},saveState:function e(i,n){t.saveState(i)}}}},{key:"initCollection",value:function e(t,i){if(typeof t.collection[i.id]!=="undefined"){return true}a.Vue.set(t.collection,i.id,this.getElementState());return true}},{key:"getSaveUserList",value:function e(){if(!this.db){return[]}if(!this.store.getters["messages/getSaveUserList"]){return[]}var t=this.store.getters["messages/getSaveUserList"]();if(!t){return[]}return t}},{key:"getSaveTimeout",value:function e(){return 250}},{key:"saveState",value:function e(i){var n=this;if(!this.isSaveAvailable()){return false}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",this).call(this,function(){var e=n.getSaveUserList();if(!e){return false}var t={collection:{}};var a={absent:true,idle:true,mobileLastDate:true,lastActivityDate:true};for(var r in e){if(!e.hasOwnProperty(r)){continue}e[r].forEach(function(e){if(!i.collection[e]){return false}t.collection[e]=n.cloneState(i.collection[e],a)})}return t})}},{key:"validate",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n={};i.host=i.host||this.getState().host;if(typeof t.id==="number"||typeof t.id==="string"){n.id=parseInt(t.id)}if(typeof t.first_name!=="undefined"){t.firstName=o.Utils.text.htmlspecialcharsback(t.first_name)}if(typeof t.last_name!=="undefined"){t.lastName=o.Utils.text.htmlspecialcharsback(t.last_name)}if(typeof t.name==="string"||typeof t.name==="number"){t.name=o.Utils.text.htmlspecialcharsback(t.name.toString());n.name=t.name;if(typeof t.firstName==="undefined"||typeof t.firstName!=="undefined"&&!t.firstName){var a=t.name.split(" ");if(a.length>1){delete a[a.length-1];t.firstName=a.join(" ").trim()}else{t.firstName=n.name}}if(typeof t.lastName==="undefined"||typeof t.lastName!=="undefined"&&!t.lastName){var r=t.name.split(" ");if(r.length>1){t.lastName=r[r.length-1]}else{t.lastName=""}}}if(typeof t.firstName==="string"||typeof t.firstName==="number"){n.firstName=o.Utils.text.htmlspecialcharsback(t.firstName.toString())}if(typeof t.lastName==="string"||typeof t.lastName==="number"){n.lastName=o.Utils.text.htmlspecialcharsback(t.lastName.toString())}if(typeof t.work_position!=="undefined"){t.workPosition=t.work_position}if(typeof t.workPosition==="string"||typeof t.workPosition==="number"){n.workPosition=t.workPosition.toString()}if(typeof t.color==="string"){n.color=t.color}if(typeof t.avatar==="string"){var s;if(!t.avatar||t.avatar.endsWith("/js/im/images/blank.gif")){s=""}else if(t.avatar.startsWith("http")){s=t.avatar}else{s=i.host+t.avatar}if(s){n.avatar=encodeURI(s)}}if(typeof t.gender!=="undefined"){n.gender=t.gender==="F"?"F":"M"}if(typeof t.birthday==="string"){n.birthday=t.birthday}if(typeof t.extranet==="boolean"){n.extranet=t.extranet}if(typeof t.network==="boolean"){n.network=t.network}if(typeof t.bot==="boolean"){n.bot=t.bot}if(typeof t.connector==="boolean"){n.connector=t.connector}if(typeof t.external_auth_id!=="undefined"){t.externalAuthId=t.external_auth_id}if(typeof t.externalAuthId==="string"&&t.externalAuthId){n.externalAuthId=t.externalAuthId}if(typeof t.status==="string"){n.status=t.status}if(typeof t.idle!=="undefined"){n.idle=o.Utils.date.cast(t.idle,false)}if(typeof t.last_activity_date!=="undefined"){t.lastActivityDate=t.last_activity_date}if(typeof t.lastActivityDate!=="undefined"){n.lastActivityDate=o.Utils.date.cast(t.lastActivityDate,false)}if(typeof t.mobile_last_date!=="undefined"){t.mobileLastDate=t.mobile_last_date}if(typeof t.mobileLastDate!=="undefined"){n.mobileLastDate=o.Utils.date.cast(t.mobileLastDate,false)}if(typeof t.absent!=="undefined"){n.absent=o.Utils.date.cast(t.absent,false)}if(typeof t.departments!=="undefined"){n.departments=[];if(t.departments instanceof Array){t.departments.forEach(function(e){e=parseInt(e);if(e>0){n.departments.push(e)}})}}if(babelHelpers.typeof(t.phones)==="object"&&t.phones){n.phones={};if(typeof t.phones.work_phone!=="undefined"){t.phones.workPhone=t.phones.work_phone}if(typeof t.phones.workPhone==="string"||typeof t.phones.workPhone==="number"){n.phones.workPhone=t.phones.workPhone.toString()}if(typeof t.phones.personal_mobile!=="undefined"){t.phones.personalMobile=t.phones.personal_mobile}if(typeof t.phones.personalMobile==="string"||typeof t.phones.personalMobile==="number"){n.phones.personalMobile=t.phones.personalMobile.toString()}if(typeof t.phones.personal_phone!=="undefined"){t.phones.personalPhone=t.phones.personal_phone}if(typeof t.phones.personalPhone==="string"||typeof t.phones.personalPhone==="number"){n.phones.personalPhone=t.phones.personalPhone.toString()}if(typeof t.phones.inner_phone!=="undefined"){t.phones.innerPhone=t.phones.inner_phone}if(typeof t.phones.innerPhone==="string"||typeof t.phones.innerPhone==="number"){n.phones.innerPhone=t.phones.innerPhone.toString()}}return n}},{key:"addToOnlineList",value:function e(t,i){if(!t.onlineList.includes(i)){t.onlineList.push(i)}}},{key:"addToMobileOnlineList",value:function e(t,i){if(!t.mobileOnlineList.includes(i)){t.mobileOnlineList.push(i)}}},{key:"addToAbsentList",value:function e(t,i){if(!t.absentList.includes(i)){t.absentList.push(i)}}},{key:"getTimeToNextMidnight",value:function e(){var t=new Date((new Date).setHours(24,0,0)).getTime();return t-new Date}},{key:"startAbsentCheckInterval",value:function e(t){var i=b(t.absentList),n;try{var a=function e(){var i=n.value;var a=t.collection[i];if(!a){return"continue"}var r=(new Date).getTime();var o=new Date(t.collection[i].absent).getTime();if(o<=r){t.absentList=t.absentList.filter(function(e){return e!==i});a.isAbsent=false}};for(i.s();!(n=i.n()).done;){var r=a();if(r==="continue")continue}}catch(e){i.e(e)}finally{i.f()}}},{key:"startOnlineCheckInterval",value:function e(){var t=this;var i=6e4;setInterval(function(){var e=b(t.store.state.users.onlineList),i;try{var n=function e(){var n=i.value;var a=t.store.state.users.collection[n];if(!a){return"continue"}var r=o.Utils.user.getOnlineStatus(a);if(r.isOnline){a.isOnline=true}else{a.isOnline=false;t.store.state.users.onlineList=t.store.state.users.onlineList.filter(function(e){return e!==n})}};for(e.s();!(i=e.n()).done;){var a=n();if(a==="continue")continue}}catch(t){e.e(t)}finally{e.f()}var r=b(t.store.state.users.mobileOnlineList),s;try{var l=function e(){var i=s.value;var n=t.store.state.users.collection[i];if(!n){return"continue"}var a=o.Utils.user.isMobileActive(n);if(a){n.isMobileOnline=true}else{n.isMobileOnline=false;t.store.state.users.mobileOnlineList=t.store.state.users.mobileOnlineList.filter(function(e){return e!==i})}};for(r.s();!(s=r.n()).done;){var c=l();if(c==="continue")continue}}catch(e){r.e(e)}finally{r.f()}},i)}}]);return t}(r.VuexBuilderModel);function C(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=T(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,o=false,s;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(o)throw s}}}}function T(e,t){if(!e)return;if(typeof e==="string")return k(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return k(e,t)}function k(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var w=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"files"}},{key:"getState",value:function e(){return{created:0,host:this.getVariable("host",location.protocol+"//"+location.host),collection:{},index:{}}}},{key:"getElementState",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.id,a=i===void 0?0:i,r=t.chatId,o=r===void 0?0:r,s=t.name,l=s===void 0?this.getVariable("default.name",""):s;return{id:a,chatId:o,name:l,templateId:a,date:new Date,type:"file",extension:"",icon:"empty",size:0,image:false,status:n.FileStatus.done,progress:100,authorId:0,authorName:"",urlPreview:"",urlShow:"",urlDownload:"",init:false,viewerAttrs:{}}}},{key:"getGetters",value:function e(){var t=this;return{get:function e(t){return function(e,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!e||!i){return null}if(!t.index[e]||!t.index[e][i]){return null}if(!n&&!t.index[e][i].init){return null}return t.index[e][i]}},getList:function e(t){return function(e){if(!t.index[e]){return null}return t.index[e]}},getBlank:function e(i){return function(e){return t.getElementState(e)}}}}},{key:"getActions",value:function e(){var t=this;return{add:function e(i,n){var a=t.validate(Object.assign({},n),{host:i.state.host});a.id="temporary"+(new Date).getTime()+i.state.created;a.templateId=a.id;a.init=true;i.commit("add",Object.assign({},t.getElementState(),a));return a.id},set:function e(i,a){if(a instanceof Array){a=a.map(function(e){var n=t.validate(Object.assign({},e),{host:i.state.host});n.templateId=n.id;return Object.assign({},t.getElementState(),n,{init:true})})}else{var r=t.validate(Object.assign({},a),{host:i.state.host});r.templateId=r.id;a=[];a.push(Object.assign({},t.getElementState(),r,{init:true}))}i.commit("set",{insertType:n.MutationType.setAfter,data:a})},setBefore:function e(i,a){if(a instanceof Array){a=a.map(function(e){var n=t.validate(Object.assign({},e),{host:i.state.host});n.templateId=n.id;return Object.assign({},t.getElementState(),n,{init:true})})}else{var r=t.validate(Object.assign({},a),{host:i.state.host});r.templateId=r.id;a=[];a.push(Object.assign({},t.getElementState(),r,{init:true}))}i.commit("set",{actionName:"setBefore",insertType:n.MutationType.setBefore,data:a})},update:function e(i,n){var a=t.validate(Object.assign({},n.fields),{host:i.state.host});i.commit("initCollection",{chatId:n.chatId});var r=i.state.collection[n.chatId].findIndex(function(e){return e.id===n.id});if(r<0){return false}i.commit("update",{id:n.id,chatId:n.chatId,index:r,fields:a});if(n.fields.blink){setTimeout(function(){i.commit("update",{id:n.id,chatId:n.chatId,fields:{blink:false}})},1e3)}return true},delete:function e(t,i){t.commit("delete",{id:i.id,chatId:i.chatId});return true},saveState:function e(t,i){t.commit("saveState",{});return true}}}},{key:"getMutations",value:function e(){var t=this;return{initCollection:function e(i,n){t.initCollection(i,n)},add:function e(i,n){t.initCollection(i,n);i.collection[n.chatId].push(n);i.index[n.chatId][n.id]=n;i.created+=1;t.saveState(i)},set:function e(i,a){var r=C(a.data),o;try{var s=function e(){var r=o.value;t.initCollection(i,{chatId:r.chatId});var s=i.collection[r.chatId].findIndex(function(e){return e.id===r.id});if(s>-1){delete r.templateId;i.collection[r.chatId][s]=Object.assign(i.collection[r.chatId][s],r)}else if(a.insertType===n.MutationType.setBefore){i.collection[r.chatId].unshift(r)}else{i.collection[r.chatId].push(r)}i.index[r.chatId][r.id]=r;t.saveState(i)};for(r.s();!(o=r.n()).done;){s()}}catch(e){r.e(e)}finally{r.f()}},update:function e(i,n){t.initCollection(i,n);var a=-1;if(typeof n.index!=="undefined"&&i.collection[n.chatId][n.index]){a=n.index}else{a=i.collection[n.chatId].findIndex(function(e){return e.id===n.id})}if(a>=0){delete n.fields.templateId;var r=Object.assign(i.collection[n.chatId][a],n.fields);i.collection[n.chatId][a]=r;i.index[n.chatId][r.id]=r;t.saveState(i)}},delete:function e(i,n){t.initCollection(i,n);i.collection[n.chatId]=i.collection[n.chatId].filter(function(e){return e.id!==n.id});delete i.index[n.chatId][n.id];t.saveState(i)},saveState:function e(i,n){t.saveState(i)}}}},{key:"initCollection",value:function e(t,i){if(typeof t.collection[i.chatId]!=="undefined"){return true}a.Vue.set(t.collection,i.chatId,[]);a.Vue.set(t.index,i.chatId,{});return true}},{key:"getLoadedState",value:function e(t){if(!t||babelHelpers.typeof(t)!=="object"){return t}if(babelHelpers.typeof(t.collection)!=="object"){return t}t.index={};var i=function e(i){if(!t.collection.hasOwnProperty(i)){return"continue"}t.index[i]={};t.collection[i].filter(function(e){return e!=null}).forEach(function(e){t.index[i][e.id]=e})};for(var n in t.collection){var a=i(n);if(a==="continue")continue}return t}},{key:"getSaveFileList",value:function e(){if(!this.db){return[]}if(!this.store.getters["messages/getSaveFileList"]){return[]}var t=this.store.getters["messages/getSaveFileList"]();if(!t){return[]}return t}},{key:"getSaveTimeout",value:function e(){return 250}},{key:"saveState",value:function e(i){var n=this;if(!this.isSaveAvailable()){return false}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",this).call(this,function(){var e=n.getSaveFileList();if(!e){return false}var t={collection:{}};var a=function n(a){if(!e.hasOwnProperty(a)){return"continue"}e[a].forEach(function(e){if(!i.index[a]){return false}if(!i.index[a][e]){return false}if(!t.collection[a]){t.collection[a]=[]}t.collection[a].push(i.index[a][e])})};for(var r in e){var o=a(r);if(o==="continue")continue}return t})}},{key:"validate",value:function e(i){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var r={};a.host=a.host||this.getState().host;if(typeof i.id==="number"){r.id=i.id}else if(typeof i.id==="string"){if(i.id.startsWith("temporary")){r.id=i.id}else{r.id=parseInt(i.id)}}if(typeof i.templateId==="number"){r.templateId=i.templateId}else if(typeof i.templateId==="string"){if(i.templateId.startsWith("temporary")){r.templateId=i.templateId}else{r.templateId=parseInt(i.templateId)}}if(typeof i.chatId==="number"||typeof i.chatId==="string"){r.chatId=parseInt(i.chatId)}if(typeof i.date!=="undefined"){r.date=o.Utils.date.cast(i.date)}if(typeof i.type==="string"){r.type=i.type}if(typeof i.extension==="string"){r.extension=i.extension.toString();if(r.type==="image"){r.icon="img"}else if(r.type==="video"){r.icon="mov"}else{r.icon=t.getIconType(r.extension)}}if(typeof i.name==="string"||typeof i.name==="number"){r.name=i.name.toString()}if(typeof i.size==="number"||typeof i.size==="string"){r.size=parseInt(i.size)}if(typeof i.image==="boolean"){r.image=false}else if(babelHelpers.typeof(i.image)==="object"&&i.image){r.image={width:0,height:0};if(typeof i.image.width==="string"||typeof i.image.width==="number"){r.image.width=parseInt(i.image.width)}if(typeof i.image.height==="string"||typeof i.image.height==="number"){r.image.height=parseInt(i.image.height)}if(r.image.width<=0||r.image.height<=0){r.image=false}}if(typeof i.status==="string"&&typeof n.FileStatus[i.status]!=="undefined"){r.status=i.status}if(typeof i.progress==="number"||typeof i.progress==="string"){r.progress=parseInt(i.progress)}if(typeof i.authorId==="number"||typeof i.authorId==="string"){r.authorId=parseInt(i.authorId)}if(typeof i.authorName==="string"||typeof i.authorName==="number"){r.authorName=i.authorName.toString()}if(typeof i.urlPreview==="string"){if(!i.urlPreview||i.urlPreview.startsWith("http")||i.urlPreview.startsWith("bx")||i.urlPreview.startsWith("file")||i.urlPreview.startsWith("blob")){r.urlPreview=i.urlPreview}else{r.urlPreview=a.host+i.urlPreview}}if(typeof i.urlDownload==="string"){if(!i.urlDownload||i.urlDownload.startsWith("http")||i.urlDownload.startsWith("bx")||i.urlPreview.startsWith("file")){r.urlDownload=i.urlDownload}else{r.urlDownload=a.host+i.urlDownload}}if(typeof i.urlShow==="string"){if(!i.urlShow||i.urlShow.startsWith("http")||i.urlShow.startsWith("bx")||i.urlShow.startsWith("file")){r.urlShow=i.urlShow}else{r.urlShow=a.host+i.urlShow}}if(babelHelpers.typeof(i.viewerAttrs)==="object"){if(r.type==="image"&&!o.Utils.platform.isBitrixMobile()){r.viewerAttrs=i.viewerAttrs}if(r.type==="video"&&!o.Utils.platform.isBitrixMobile()&&r.size>t.maxDiskFileSize){r.viewerAttrs=i.viewerAttrs}}return r}}],[{key:"getType",value:function e(t){t=t.toString().toLowerCase().split(".").splice(-1)[0];switch(t){case"png":case"jpe":case"jpg":case"jpeg":case"gif":case"heic":case"bmp":case"webp":return n.FileType.image;case"mp4":case"mkv":case"webm":case"mpeg":case"hevc":case"avi":case"3gp":case"flv":case"m4v":case"ogg":case"wmv":case"mov":return n.FileType.video;case"mp3":return n.FileType.audio}return n.FileType.file}},{key:"getIconType",value:function e(t){var i="empty";switch(t.toString()){case"png":case"jpe":case"jpg":case"jpeg":case"gif":case"heic":case"bmp":case"webp":i="img";break;case"mp4":case"mkv":case"webm":case"mpeg":case"hevc":case"avi":case"3gp":case"flv":case"m4v":case"ogg":case"wmv":case"mov":i="mov";break;case"txt":i="txt";break;case"doc":case"docx":i="doc";break;case"xls":case"xlsx":i="xls";break;case"php":i="php";break;case"pdf":i="pdf";break;case"ppt":case"pptx":i="ppt";break;case"rar":i="rar";break;case"zip":case"7z":case"tar":case"gz":case"gzip":i="zip";break;case"set":i="set";break;case"conf":case"ini":case"plist":i="set";break}return i}}]);return t}(r.VuexBuilderModel);babelHelpers.defineProperty(w,"maxDiskFileSize",5242880);var L=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"recent"}},{key:"getState",value:function e(){return{host:this.getVariable("host",location.protocol+"//"+location.host),collection:[]}}},{key:"getElementState",value:function e(){return{id:0,templateId:"",template:n.TemplateTypes.item,chatType:n.ChatTypes.chat,sectionCode:n.RecentSection.general,avatar:"",color:"#048bd0",title:"",lines:{id:0,status:0},message:{id:0,text:"",date:new Date,senderId:0,status:n.MessageStatus.received},counter:0,pinned:false,chatId:0,userId:0}}},{key:"getGetters",value:function e(){var t=this;return{get:function e(i){return function(e){if(s.Type.isNumber(e)){e=e.toString()}var i=t.findItem(e);if(i){return i}return false}}}}},{key:"getActions",value:function e(){var t=this;return{set:function e(i,n){var a=[];if(n instanceof Array){a=n.map(function(e){return t.prepareItem(e,{host:i.state.host})})}if(a.length===0){return false}a.forEach(function(e){var n=t.findItem(e.id);if(n){i.commit("update",{index:n.index,fields:e})}else{i.commit("add",{fields:e})}});i.state.collection.sort(t.sortListByMessageDate)},addPlaceholders:function e(t,i){i.forEach(function(e){t.commit("addPlaceholder",{fields:e})})},updatePlaceholders:function e(i,n){n.items=n.items.map(function(e){return t.prepareItem(e)});n.items.forEach(function(e,a){var r="placeholder"+(n.firstMessage+a);var o=t.findItem(r,"templateId");var s=t.findItem(e.id);if(s){i.commit("update",{index:s.index,fields:e});i.commit("delete",{index:o.index})}else{i.commit("update",{index:o.index,fields:e})}})},update:function e(i,n){if(typeof n.id==="string"&&!n.id.startsWith("chat")&&n.id!=="notify"){n.id=parseInt(n.id)}var a=t.findItem(n.id);if(!a){return false}i.commit("update",{index:a.index,fields:n.fields});i.state.collection.sort(t.sortListByMessageDate)},pin:function e(i,n){if(typeof n.id==="string"&&!n.id.startsWith("chat")&&n.id!=="notify"){n.id=parseInt(n.id)}var a=t.findItem(n.id);if(!a){return false}i.commit("update",{index:a.index,fields:Object.assign({},a.element,{pinned:n.action})});i.state.collection.sort(t.sortListByMessageDate)},clearPlaceholders:function e(t){t.commit("clearPlaceholders")},delete:function e(i,n){if(typeof n.id==="string"&&!n.id.startsWith("chat")&&n.id!=="notify"){n.id=parseInt(n.id)}var a=t.findItem(n.id);if(!a){return false}i.commit("delete",{index:a.index});i.state.collection.sort(t.sortListByMessageDate)}}}},{key:"getMutations",value:function e(){var t=this;return{add:function e(i,n){i.collection.push(Object.assign({},t.getElementState(),n.fields))},update:function e(t,i){t.collection.splice(i.index,1,Object.assign({},t.collection[i.index],i.fields))},delete:function e(t,i){t.collection.splice(i.index,1)},addPlaceholder:function e(i,n){i.collection.push(Object.assign({},t.getElementState(),n.fields))},clearPlaceholders:function e(t){t.collection=t.collection.filter(function(e){return!e.id.toString().startsWith("placeholder")})}}}},{key:"validate",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a={};if(s.Type.isNumber(t.id)){a.id=t.id.toString()}if(s.Type.isStringFilled(t.id)){a.id=t.id}if(s.Type.isString(t.templateId)){a.templateId=t.templateId}if(s.Type.isString(t.template)){a.template=t.template}if(s.Type.isString(t.type)){if(t.type===n.ChatTypes.chat){if(t.chat.type===n.ChatTypes.open){a.chatType=n.ChatTypes.open}else if(t.chat.type===n.ChatTypes.chat){a.chatType=n.ChatTypes.chat}}else if(t.type===n.ChatTypes.user){a.chatType=n.ChatTypes.user}else if(t.type===n.ChatTypes.notification){a.chatType=n.ChatTypes.notification;t.title="Notifications"}else{a.chatType=n.ChatTypes.chat}}if(s.Type.isString(t.avatar)){var r;if(!t.avatar||t.avatar.endsWith("/js/im/images/blank.gif")){r=""}else if(t.avatar.startsWith("http")){r=t.avatar}else{r=i.host+t.avatar}if(r){a.avatar=encodeURI(r)}}if(s.Type.isString(t.color)){a.color=t.color}if(s.Type.isString(t.title)){a.title=t.title}if(s.Type.isPlainObject(t.message)){var o={};if(s.Type.isNumber(t.message.id)){o.id=t.message.id}if(s.Type.isString(t.message.text)){o.text=t.message.text}if(s.Type.isDate(t.message.date)||s.Type.isString(t.message.date)){o.date=t.message.date}if(s.Type.isNumber(t.message.author_id)){o.senderId=t.message.author_id}if(s.Type.isNumber(t.message.senderId)){o.senderId=t.message.senderId}if(s.Type.isStringFilled(t.message.status)){o.status=t.message.status}a.message=o}if(s.Type.isNumber(t.counter)){a.counter=t.counter}if(s.Type.isBoolean(t.pinned)){a.pinned=t.pinned}if(s.Type.isNumber(t.chatId)){a.chatId=t.chatId}if(s.Type.isNumber(t.userId)){a.userId=t.userId}return a}},{key:"sortListByMessageDate",value:function e(t,i){if(t.message&&i.message){var n=new Date(t.message.date).getTime();var a=new Date(i.message.date).getTime();return a-n}}},{key:"prepareItem",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=this.validate(Object.assign({},t));return Object.assign({},this.getElementState(),n,i)}},{key:"findItem",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"id";var n={};if(i==="id"&&s.Type.isNumber(t)){t=t.toString()}var a=this.store.state.recent.collection.findIndex(function(e,n){return e[i]===t});if(a!==-1){n.index=a;n.element=this.store.state.recent.collection[a];return n}return false}}]);return t}(r.VuexBuilderModel);function M(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=A(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,o=false,s;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(o)throw s}}}}function A(e,t){if(!e)return;if(typeof e==="string")return E(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return E(e,t)}function E(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var O=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"notifications"}},{key:"getState",value:function e(){return{collection:[],searchCollection:[],chat_id:0,total:0,host:this.getVariable("host",location.protocol+"//"+location.host),unreadCounter:0,schema:[]}}},{key:"getElementState",value:function e(){return{id:0,authorId:0,date:new Date,text:"",sectionCode:"notification",textConverted:"",unread:false,template:"item",templateId:0,display:true,settingName:"im|default",type:0}}},{key:"getGetters",value:function e(){var t=this;return{get:function e(t){return function(){return t.collection}},getById:function e(i){return function(e){if(s.Type.isString(e)){e=parseInt(e)}var n=t.findItemInArr(i.collection,e);if(!n.element){return false}return n.element}},getSearchItemById:function e(i){return function(e){if(s.Type.isString(e)){e=parseInt(e)}var n=t.findItemInArr(i.searchCollection,e);if(!n.element){return false}return n.element}},getBlank:function e(i){return function(e){return t.getElementState()}}}}},{key:"getActions",value:function e(){var t=this;return{set:function e(i,n){var a={notification:[]};if(n.notification instanceof Array){a.notification=n.notification.map(function(e){return t.prepareNotification(e,{host:i.state.host})})}if(s.Type.isNumber(n.total)||s.Type.isString(n.total)){a.total=parseInt(n.total)}i.commit("set",a)},setSearchResults:function e(i,n){var a={notification:[]};if(!(n.notification instanceof Array)){return false}if(n.type==="local"){a.notification=n.notification}else{a.notification=n.notification.map(function(e){return t.prepareNotification(e,{host:i.state.host})})}i.commit("setSearchResults",{data:a})},deleteSearchResults:function e(t,i){t.commit("deleteSearchResults")},setCounter:function e(t,i){if(s.Type.isNumber(i.unreadTotal)||s.Type.isString(i.unreadTotal)){var n=parseInt(i.unreadTotal);t.commit("setCounter",n)}},setTotal:function e(t,i){if(s.Type.isNumber(i.total)||s.Type.isString(i.total)){t.commit("setTotal",i.total)}},add:function e(i,n){var a=t.prepareNotification(n.data,{host:i.state.host});a.unread=true;var r=t.findItemInArr(i.state.collection,a.id);if(!r.element){i.commit("add",{data:a});i.commit("setTotal",i.state.total+1)}else{i.commit("update",{index:r.index,fields:Object.assign({},n.fields)})}},updatePlaceholders:function e(i,n){if(n.items instanceof Array){n.items=n.items.map(function(e){return t.prepareNotification(e)})}else{return false}i.commit("updatePlaceholders",n);return true},clearPlaceholders:function e(t,i){t.commit("clearPlaceholders",i)},update:function e(i,n){var a=t.findItemInArr(i.state.collection,n.id);if(a.element){i.commit("update",{index:a.index,fields:Object.assign({},n.fields)})}if(n.searchMode){var r=t.findItemInArr(i.state.searchCollection,n.id);if(r.element){i.commit("update",{searchCollection:true,index:r.index,fields:Object.assign({},n.fields)})}}},read:function e(i,n){var a=M(n.ids),r;try{for(a.s();!(r=a.n()).done;){var o=r.value;var s=t.findItemInArr(i.state.collection,o);if(!s.element){return false}i.commit("read",{index:s.index,action:!n.action})}}catch(e){a.e(e)}finally{a.f()}},readAll:function e(t,i){t.commit("readAll")},delete:function e(i,n){var a=t.findItemInArr(i.state.collection,n.id);if(a.element){i.commit("delete",{searchCollection:false,index:a.index});i.commit("setTotal",i.state.total-1)}if(n.searchMode){var r=t.findItemInArr(i.state.searchCollection,n.id);if(r.element){i.commit("delete",{searchCollection:true,index:r.index})}}},deleteAll:function e(t,i){t.commit("deleteAll")},setSchema:function e(t,i){t.commit("setSchema",{data:i.data})}}}},{key:"getMutations",value:function e(){var t=this;return{set:function e(i,n){i.total=n.hasOwnProperty("total")?n.total:i.total;if(!n.hasOwnProperty("notification")||!s.Type.isArray(n.notification)){return}var a=M(n.notification),r;try{for(a.s();!(r=a.n()).done;){var o=r.value;var l=t.findItemInArr(i.collection,o.id);if(!l.element){i.collection.push(o)}else{i.collection[l.index]=Object.assign(i.collection[l.index],o)}}}catch(e){a.e(e)}finally{a.f()}i.collection.sort(t.sortByType)},setSearchResults:function e(i,n){var a=M(n.data.notification),r;try{for(a.s();!(r=a.n()).done;){var o=r.value;var s=t.findItemInArr(i.searchCollection,o.id);if(!s.element){i.searchCollection.push(o)}else{i.searchCollection[s.index]=Object.assign(i.searchCollection[s.index],o)}}}catch(e){a.e(e)}finally{a.f()}},deleteAll:function e(t,i){t.collection=[]},deleteSearchResults:function e(t,i){t.searchCollection=[]},add:function e(t,i){var n=null;if(i.data.sectionCode==="confirm"){t.collection.unshift(i.data)}else{for(var a=0;t.collection.length>a;a++){if(t.collection[a].sectionCode==="notification"){n=a;break}}if(n===null){t.collection.push(i.data)}else{t.collection.splice(n,0,i.data)}}},update:function e(t,i){var n=i.searchCollection?"searchCollection":"collection";a.Vue.set(t[n],i.index,Object.assign({},t[n][i.index],i.fields))},delete:function e(t,i){var n=i.searchCollection?"searchCollection":"collection";t[n].splice(i.index,1)},read:function e(t,i){t.collection[i.index].unread=i.action},readAll:function e(t,i){for(var n=0;t.collection.length>n;n++){if(t.collection[n].sectionCode==="notification"){t.collection[n].unread=false}}},updatePlaceholders:function e(t,i){var n=i.searchCollection?"searchCollection":"collection";i.items.forEach(function(e,a){var r="placeholder".concat(i.firstItem+a);var o=t[n].findIndex(function(e){return e.id===r});var s=t[n].findIndex(function(t){return t.id===e.id});if(s>=0){t[n][s]=Object.assign(t[n][s],e);t[n].splice(o,1)}else{t[n].splice(o,1,Object.assign({},e))}})},clearPlaceholders:function e(t,i){t.collection=t.collection.filter(function(e){return!e.id.toString().startsWith("placeholder")});t.searchCollection=t.searchCollection.filter(function(e){return!e.id.toString().startsWith("placeholder")})},setCounter:function e(t,i){t.unreadCounter=i},setTotal:function e(t,i){t.total=i},setSchema:function e(t,i){t.schema=i.data}}}},{key:"validate",value:function e(t,i){var n={};if(s.Type.isString(t.id)||s.Type.isNumber(t.id)){n.id=t.id}if(!s.Type.isNil(t.date)){n.date=o.Utils.date.cast(t.date)}if(s.Type.isString(t.textOriginal)||s.Type.isNumber(t.textOriginal)){n.text=t.textOriginal.toString();if(s.Type.isString(t.text)||s.Type.isNumber(t.text)){n.textConverted=this.convertToHtml({text:t.text.toString()})}}else{if(!s.Type.isNil(t.text_converted)){t.textConverted=t.text_converted}if(s.Type.isString(t.textConverted)||s.Type.isNumber(t.textConverted)){n.textConverted=t.textConverted.toString()}if(s.Type.isString(t.text)||s.Type.isNumber(t.text)){n.text=t.text.toString();var a=!s.Type.isNil(n.textConverted);n.textConverted=this.convertToHtml({text:a?n.textConverted:n.text})}}if(s.Type.isNumber(t.author_id)){if(t.system===true||t.system==="Y"){n.authorId=0}else{n.authorId=t.author_id}}if(s.Type.isNumber(t.userId)){n.authorId=t.userId}if(s.Type.isObjectLike(t.params)){var r=this.validateParams(t.params);if(r){n.params=r}}if(!s.Type.isNil(t.notify_buttons)){n.notifyButtons=JSON.parse(t.notify_buttons)}if(!s.Type.isNil(t.buttons)){n.notifyButtons=t.buttons.map(function(e){return{COMMAND:"notifyConfirm",COMMAND_PARAMS:"".concat(n.id,"|").concat(e.VALUE),TEXT:"".concat(e.TITLE),TYPE:"BUTTON",DISPLAY:"LINE",BG_COLOR:e.VALUE==="Y"?"#8bc84b":"#ef4b57",TEXT_COLOR:"#fff"}})}if(t.notify_type===1||t.type===1){n.sectionCode="confirm"}if(s.Type.isNumber(t.notify_type)){n.type=t.notify_type}if(!s.Type.isNil(t.notify_read)){n.unread=t.notify_read==="N"}if(!s.Type.isNil(t.read)){n.unread=t.read==="N"}if(s.Type.isString(t.templateId)){n.templateId=t.templateId}if(s.Type.isString(t.template)){n.template=t.template}if(s.Type.isString(t.setting_name)){n.settingName=t.setting_name}return n}},{key:"validateParams",value:function e(t){var i={};try{for(var n in t){if(!t.hasOwnProperty(n)){continue}if(n==="COMPONENT_ID"){if(s.Type.isString(t[n])&&BX.Vue.isComponent(t[n])){i[n]=t[n]}}else if(n==="LIKE"){if(t[n]instanceof Array){i["REACTION"]={like:t[n].map(function(e){return parseInt(e)})}}}else if(n==="CHAT_LAST_DATE"){i[n]=o.Utils.date.cast(t[n])}else if(n==="AVATAR"){if(t[n]){i[n]=t[n].startsWith("http")?t[n]:options.host+t[n]}}else if(n==="NAME"){if(t[n]){i[n]=t[n]}}else{i[n]=t[n]}}}catch(e){}var a=false;for(var r in i){if(!i.hasOwnProperty(r)){continue}a=true;break}return a?i:null}},{key:"prepareNotification",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=this.validate(Object.assign({},t));return Object.assign({},this.getElementState(),n,i)}},{key:"findItemInArr",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"id";var a={};var r=t.findIndex(function(e,t){return e[n]===i});if(r!==-1){a.index=r;a.element=t[r]}return a}},{key:"sortByType",value:function e(t,i){if(t.sectionCode==="confirm"&&i.sectionCode!=="confirm"){return-1}else if(t.sectionCode!=="confirm"&&i.sectionCode==="confirm"){return 1}else{return 0}}},{key:"convertToHtml",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.text,a=n===void 0?"":n;a=a.trim();a=a.replace(/\n/gi,"<br />");a=a.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");a=t.decodeBbCode({text:a});if(o.Utils.platform.isBitrixDesktop()){a=a.replace(/<a(.*?)>(.*?)<\/a>/gi,function(e,t,i){return"<a"+t.replace('target="_self"','target="_blank"')+' class="bx-im-notifications-item-link">'+i+"</a>"})}return a}}],[{key:"decodeBbCode",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.text;i=i.replace(/\[url=([^\]]+)\](.*?)\[\/url\]/gi,function(e,t,i){var n=document.createElement("a");n.href=o.Utils.text.htmlspecialcharsback(t);n.target="_blank";n.text=o.Utils.text.htmlspecialcharsback(i);var a=["http:","https:","ftp:","file:","tel:","callto:","mailto:","skype:","viber:"];if(a.indexOf(n.protocol)<=-1){return e}return n.outerHTML});i=i.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like"></span>');i=i.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike"></span>');i=i.replace(/\[RATING\=([1-5]{1})\]/gi,function(e,t){return BX.MessengerCommon.linesVoteHeadNodes(0,t,false).outerHTML});i=i.replace(/\[BR\]/gi,"<br/>");i=i.replace(/\[([buis])\](.*?)\[(\/[buis])\]/gi,function(e,t,i,n){return"<"+t+">"+i+"<"+n+">"});i=i.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,i,n){i=parseInt(i);if(i<=0){return n}if(t){return'<span class="bx-im-mention" data-type="OPENLINES" data-value="'+i+'">'+n+"</span>"}else{return'<span class="bx-im-mention" data-type="CHAT" data-value="'+i+'">'+n+"</span>"}});i=i.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,i){var n="";t=parseInt(t);if(t>0&&typeof BXIM!="undefined"){n='<span class="bx-im-mention '.concat(t===+BXIM.userId?"bx-messenger-ajax-self":"",'" data-type="USER" data-value="').concat(t,'">').concat(i,"</span>")}else{n=i}return n});i=i.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,i){return i});return i}}]);return t}(r.VuexBuilderModel);e.ApplicationModel=l;e.ConferenceModel=c;e.MessagesModel=m;e.DialoguesModel=v;e.UsersModel=x;e.FilesModel=w;e.RecentModel=L;e.NotificationsModel=O})(this.BX.Messenger.Model=this.BX.Messenger.Model||{},BX.Messenger.Lib,BX.Event,BX.Messenger.Const,BX,BX,BX.Messenger.Lib,BX);
//# sourceMappingURL=registry.bundle.map.js