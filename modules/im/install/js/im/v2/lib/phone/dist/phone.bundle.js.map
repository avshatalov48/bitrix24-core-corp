{"version":3,"file":"phone.bundle.js","sources":["../src/phone.js"],"sourcesContent":["import 'voximplant';\nimport { PhoneCallsController } from 'voximplant.phone-calls';\nimport { Type, Runtime } from 'main.core';\nimport { BaseEvent } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { Logger } from 'im.v2.lib.logger';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\nimport { CallManager } from 'im.v2.lib.call';\nimport { SoundNotificationManager } from 'im.v2.lib.sound-notification';\n\nimport type { ImModelUser } from 'im.v2.model';\n\ntype PhoneSettings = {\n\tphoneEnabled: boolean,\n\tdeviceActive: boolean,\n\tcanInterceptCall: boolean,\n\tcanPerformCallsByUser: boolean,\n\tcanPerformCallsByLimits: boolean,\n\tcanCallUserNumber: boolean,\n\tdefaultLineId: string,\n\tavailableLines: string[],\n\trestApps: Array<{id: number, name: string}>\n};\n\ntype KeyPadParams = {\n\tbindElement: HTMLElement,\n\toffsetTop: number,\n\toffsetLeft: number,\n\tanglePosition: 'left' | 'top',\n\tangleOffset: number\n};\n\ntype CallConnectedEvent = {\n\tcall: Object<string, any>,\n\tisIncoming: boolean,\n\tisDeviceCall: boolean,\n};\n\ntype StartCallParams = {\n\tLINE_ID?: string,\n};\n\nexport class PhoneManager\n{\n\tstatic #instance: PhoneManager;\n\n\t#controller: PhoneCallsController;\n\t#settings: PhoneSettings;\n\n\tstatic getInstance(): PhoneManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tPhoneManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tconst { phoneSettings } = Core.getApplicationData();\n\t\tLogger.warn('PhoneManager: phoneSettings', phoneSettings);\n\t\tthis.#init(phoneSettings);\n\t}\n\n\tcanCall(): boolean\n\t{\n\t\treturn this.#settings.phoneEnabled && this.#settings.canPerformCallsByUser;\n\t}\n\n\topenKeyPad(params: KeyPadParams)\n\t{\n\t\tthis.#controller?.openKeyPad(params);\n\t}\n\n\tcloseKeyPad()\n\t{\n\t\tthis.#controller?.closeKeyPad();\n\t}\n\n\tasync startCall(number: string, rawParams: StartCallParams = {})\n\t{\n\t\tif (!this.#settings.canPerformCallsByLimits)\n\t\t{\n\t\t\tvoid this.#showCallLimitSlider();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#controller)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet params = rawParams;\n\t\tif (Type.isStringFilled(params))\n\t\t{\n\t\t\tparams = this.#parseStartCallParams(params);\n\t\t}\n\n\t\tawait this.#controller.loadPhoneLines();\n\n\t\tconst lineId = params.LINE_ID ?? this.#controller.defaultLineId;\n\t\tif (this.#controller.isRestLine(lineId))\n\t\t{\n\t\t\tthis.#controller.startCallViaRestApp(number, lineId, params);\n\t\t}\n\n\t\tthis.closeKeyPad();\n\t\tthis.#controller.phoneCall(number, params);\n\t}\n\n\tstartCallList(rawCallListId: string | number, params: Object<string, any>)\n\t{\n\t\tif (!this.#controller)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst callListId = Number.parseInt(rawCallListId, 10);\n\t\tif (callListId === 0 || Number.isNaN(callListId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller.startCallList(callListId, params);\n\t}\n\n\t#init(phoneSettings: PhoneSettings)\n\t{\n\t\tthis.#settings = phoneSettings;\n\t\tif (!this.canCall())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller = this.#getController(phoneSettings);\n\t}\n\n\t#getController(phoneSettings: PhoneSettings): PhoneCallsController\n\t{\n\t\tconst soundManager = SoundNotificationManager.getInstance();\n\n\t\treturn new PhoneCallsController({\n\t\t\tphoneEnabled: phoneSettings.phoneEnabled,\n\n\t\t\tuserId: Core.getUserId(),\n\t\t\tisAdmin: this.#getCurrentUser().isAdmin,\n\n\t\t\trestApps: phoneSettings.restApps,\n\t\t\tcanInterceptCall: phoneSettings.canInterceptCall,\n\t\t\tdeviceActive: phoneSettings.deviceActive,\n\t\t\tdefaultLineId: phoneSettings.defaultLineId,\n\t\t\tavailableLines: phoneSettings.availableLines,\n\n\t\t\tmessengerFacade: {\n\t\t\t\tisThemeDark: () => false,\n\t\t\t\tisDesktop: () => DesktopApi.isDesktop(),\n\t\t\t\thasActiveCall: () => CallManager.getInstance().hasCurrentCall(),\n\t\t\t\trepeatSound: (melodyName, time, force) => soundManager.playLoop(melodyName, time, force),\n\t\t\t\tstopRepeatSound: (melodyName) => soundManager.stop(melodyName),\n\t\t\t\tplaySound: (melodyName, force) => soundManager.playOnce(melodyName, force),\n\n\t\t\t\tsetLocalConfig: () => {},\n\t\t\t\tgetLocalConfig: () => {},\n\n\t\t\t\tgetAvatar: (userId) => this.#getUserAvatar(userId),\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\t// [PhoneCallsController.Events.onCallCreated]: () => this.#onCallCreated(),\n\t\t\t\t[PhoneCallsController.Events.onCallConnected]: (event) => this.#onCallConnected(event),\n\t\t\t\t// [PhoneCallsController.Events.onCallDestroyed]: () => this.#onCallDestroyed(),\n\t\t\t\t[PhoneCallsController.Events.onDeviceCallStarted]: () => this.#onDeviceCallStarted(),\n\t\t\t},\n\t\t});\n\t}\n\n\t#onDeviceCallStarted()\n\t{\n\t\tif (!DesktopApi.isDesktop())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst target = DesktopApi.findWindow('callWindow') ?? window;\n\t\tDesktopApi.activateWindow(target);\n\t\t// close desktop topmost window?\n\t}\n\n\t#onCallConnected(event: BaseEvent<CallConnectedEvent>)\n\t{\n\t\tconst { isIncoming, isDeviceCall } = event.getData();\n\t\tif (!DesktopApi.isDesktop() || isIncoming || isDeviceCall)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst target = DesktopApi.findWindow('callWindow') ?? window;\n\t\tDesktopApi.activateWindow(target);\n\t}\n\n\t#getCurrentUser(): ImModelUser\n\t{\n\t\tconst userId = Core.getUserId();\n\n\t\treturn Core.getStore().getters['users/get'](userId);\n\t}\n\n\t#getUserAvatar(userId: number): string\n\t{\n\t\tconst user: ImModelUser = Core.getStore().getters['users/get'](userId, true);\n\n\t\treturn user.avatar;\n\t}\n\n\t#parseStartCallParams(jsonParams: string): StartCallParams\n\t{\n\t\tlet params = jsonParams;\n\t\ttry\n\t\t{\n\t\t\tparams = JSON.parse(params);\n\t\t}\n\t\tcatch\n\t\t{\n\t\t\tparams = {};\n\t\t}\n\n\t\treturn params;\n\t}\n\n\tasync #showCallLimitSlider()\n\t{\n\t\tconst SLIDER_EXTENSION = 'voximplant.common';\n\n\t\tawait Runtime.loadExtension(SLIDER_EXTENSION);\n\t\tBX.Voximplant.openLimitSlider();\n\t}\n}\n"],"names":["PhoneManager","getInstance","init","constructor","phoneSettings","Core","getApplicationData","Logger","warn","canCall","phoneEnabled","canPerformCallsByUser","openKeyPad","params","closeKeyPad","startCall","number","rawParams","canPerformCallsByLimits","Type","isStringFilled","loadPhoneLines","lineId","LINE_ID","defaultLineId","isRestLine","startCallViaRestApp","phoneCall","startCallList","rawCallListId","callListId","Number","parseInt","isNaN","soundManager","SoundNotificationManager","PhoneCallsController","userId","getUserId","isAdmin","restApps","canInterceptCall","deviceActive","availableLines","messengerFacade","isThemeDark","isDesktop","DesktopApi","hasActiveCall","CallManager","hasCurrentCall","repeatSound","melodyName","time","force","playLoop","stopRepeatSound","stop","playSound","playOnce","setLocalConfig","getLocalConfig","getAvatar","events","Events","onCallConnected","event","onDeviceCallStarted","target","findWindow","window","activateWindow","isIncoming","isDeviceCall","getData","getStore","getters","user","avatar","jsonParams","JSON","parse","SLIDER_EXTENSION","Runtime","loadExtension","BX","Voximplant","openLimitSlider"],"mappings":"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"}