{"version":3,"file":"shared-worker.bundle.js","sources":["../src/shared-worker.js"],"sourcesContent":["let updateRequestStarted = false;\nlet csrfToken = '';\nlet sessionTime = 0;\nlet setIntervalId = null;\nconst browserInstances = [];\n\nconst BASE_ENDPOINT = '/bitrix/services/main/ajax.php?action=';\nconst UPDATE_STATE_ACTION = 'im.v2.UpdateState.getStateData';\n\nconst requestDebounced = debounce(requestUpdate, 5000);\n\n// eslint-disable-next-line no-undef\nonconnect = (event: MessageEvent) => {\n\tconst port: MessagePort = event.ports[0];\n\tbrowserInstances.push(port);\n\n\tport.onmessage = onMessage;\n\tport.onmessageerror = onError;\n};\n\nfunction startUpdateInterval(data: { csrfToken: string, sessionTime: number, force: boolean })\n{\n\tupdateRequestStarted = true;\n\tsetCsrfToken(data.csrfToken);\n\tsetSessionTime(data.sessionTime);\n\n\tif (data.force)\n\t{\n\t\trequestDebounced();\n\t}\n\n\tsetIntervalId = setInterval(async () => {\n\t\tawait requestUpdate();\n\t}, sessionTime);\n}\n\nasync function requestUpdate(): Promise<?Response>\n{\n\ttry\n\t{\n\t\tconst response = await fetch(getUpdateUrl(), getRequestOptions());\n\n\t\tconst handledResponse = await handleResponse(response);\n\t\tif (handledResponse)\n\t\t{\n\t\t\tbrowserInstances.forEach((instance) => {\n\t\t\t\tinstance.postMessage({ response: handledResponse.data, csrfToken: getCsrfToken() });\n\t\t\t});\n\t\t}\n\t}\n\tcatch (error)\n\t{\n\t\tconsole.error('updateState: request error', error);\n\t}\n\n\treturn null;\n}\n\nasync function handleResponse(response: Response): ?Response\n{\n\ttry\n\t{\n\t\tconst responseJson = await response.json();\n\t\tif (responseJson.errors && responseJson.errors.length > 0)\n\t\t{\n\t\t\tconst csrfTokenFromError = getCsrfTokenFromError(responseJson);\n\t\t\tsetCsrfToken(csrfTokenFromError || getCsrfToken());\n\t\t}\n\n\t\treturn responseJson;\n\t}\n\tcatch (jsonError)\n\t{\n\t\tconsole.error('updateState: json error', jsonError);\n\t}\n\n\treturn null;\n}\n\nfunction getCsrfTokenFromError(responseJson: Response): ?string\n{\n\tlet newCsrfToken = null;\n\tresponseJson.errors.forEach((error) => {\n\t\tif (!error.customData?.csrf || error.customData?.csrf.length === 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tnewCsrfToken = error.customData.csrf;\n\t});\n\n\treturn newCsrfToken;\n}\n\nfunction getUpdateUrl(): string\n{\n\treturn `${BASE_ENDPOINT}${UPDATE_STATE_ACTION}`;\n}\n\nfunction getRequestOptions(): Object\n{\n\treturn {\n\t\tmethod: 'POST',\n\t\tcredentials: 'same-origin',\n\t\theaders: {\n\t\t\t'X-Bitrix-Csrf-Token': getCsrfToken(),\n\t\t},\n\t};\n}\n\nfunction setCsrfToken(token: string)\n{\n\tcsrfToken = token;\n}\n\nfunction getCsrfToken(): string\n{\n\treturn csrfToken;\n}\n\nfunction setSessionTime(time: number)\n{\n\tsessionTime = time;\n}\n\nfunction debounce(func: Function, wait: number = 0): Function\n{\n\tlet timeoutId = null;\n\n\treturn function debounced(...args)\n\t{\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-typeof\n\t\tif (typeof timeoutId !== 'undefined' && timeoutId !== null)\n\t\t{\n\t\t\tclearTimeout(timeoutId);\n\t\t}\n\n\t\ttimeoutId = setTimeout(() => {\n\t\t\tfunc(...args);\n\t\t}, wait);\n\t};\n}\n\nfunction onMessage({ data })\n{\n\tif (updateRequestStarted)\n\t{\n\t\tclearInterval(setIntervalId);\n\t}\n\n\tstartUpdateInterval(data);\n}\n\nfunction onError(error: MessageEvent)\n{\n\tconsole.error('shared worker: messageerror', error);\n}\n"],"names":["updateRequestStarted","csrfToken","sessionTime","setIntervalId","browserInstances","BASE_ENDPOINT","UPDATE_STATE_ACTION","requestDebounced","debounce","requestUpdate","onconnect","event","port","ports","push","onmessage","onMessage","onmessageerror","onError","startUpdateInterval","data","setCsrfToken","setSessionTime","force","setInterval","response","fetch","getUpdateUrl","getRequestOptions","handledResponse","handleResponse","forEach","instance","postMessage","getCsrfToken","error","console","responseJson","json","errors","length","csrfTokenFromError","getCsrfTokenFromError","jsonError","newCsrfToken","customData","csrf","method","credentials","headers","token","time","func","wait","timeoutId","debounced","args","clearTimeout","setTimeout","clearInterval"],"mappings":"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"}