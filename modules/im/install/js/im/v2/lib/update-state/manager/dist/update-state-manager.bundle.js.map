{"version":3,"file":"update-state-manager.bundle.js","sources":["../src/update-state-manager.js"],"sourcesContent":["import { Loc, Type, Event } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nimport { EventType } from 'im.v2.const';\nimport { Core } from 'im.v2.application.core';\n\nimport type { JsonObject } from 'main.core';\n\nconst WORKER_PATH = '/bitrix/js/im/v2/lib/update-state/shared-worker/dist/shared-worker.bundle.js';\nconst WORKER_NAME = 'Bitrix24 UpdateState';\nconst CSRF_TOKEN_NAME = 'bitrix_sessid';\n\nexport class UpdateStateManager\n{\n\tworker: SharedWorker;\n\n\tstatic init(): UpdateStateManager\n\t{\n\t\treturn new UpdateStateManager();\n\t}\n\n\tconstructor()\n\t{\n\t\tif (!('SharedWorker' in window))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.registerSharedWorker();\n\t\tthis.subscribeToEvents();\n\t}\n\n\tregisterSharedWorker()\n\t{\n\t\tthis.worker = new SharedWorker(WORKER_PATH, WORKER_NAME);\n\t\tthis.handleMessageFromWorker();\n\t\tthis.startUpdateState();\n\t\tthis.worker.port.start();\n\t}\n\n\tsetCsrfToken(token: string)\n\t{\n\t\tif (!Type.isStringFilled(token))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLoc.setMessage({ CSRF_TOKEN_NAME: token });\n\t}\n\n\tgetCsrfToken(): string\n\t{\n\t\treturn Loc.getMessage(CSRF_TOKEN_NAME);\n\t}\n\n\tgetSessionTimeInMilliseconds(): number\n\t{\n\t\tconst { sessionTime } = Core.getApplicationData();\n\n\t\treturn sessionTime * 1000;\n\t}\n\n\tsubscribeToEvents()\n\t{\n\t\tEvent.bind(window, 'online', () => {\n\t\t\tthis.worker.port.postMessage({\n\t\t\t\tforce: true,\n\t\t\t\tsessionTime: this.getSessionTimeInMilliseconds(),\n\t\t\t\tcsrfToken: this.getCsrfToken(),\n\t\t\t});\n\t\t});\n\t}\n\n\thandleMessageFromWorker()\n\t{\n\t\tEvent.bind(this.worker.port, 'message', (event: MessageEvent) => {\n\t\t\tconst { csrfToken, response } = event.data;\n\t\t\tthis.setCsrfToken(csrfToken);\n\t\t\tthis.fireCountersEvent(response);\n\t\t});\n\t}\n\n\tstartUpdateState()\n\t{\n\t\tthis.worker.port.postMessage({\n\t\t\tforce: false,\n\t\t\tsessionTime: this.getSessionTimeInMilliseconds(),\n\t\t\tcsrfToken: this.getCsrfToken(),\n\t\t});\n\t}\n\n\tfireCountersEvent(response: ?JsonObject)\n\t{\n\t\tif (!response?.counters)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tEventEmitter.emit(window, EventType.counter.onImUpdateCounter, [response.counters]);\n\t}\n}\n"],"names":["WORKER_PATH","WORKER_NAME","CSRF_TOKEN_NAME","UpdateStateManager","init","constructor","window","registerSharedWorker","subscribeToEvents","worker","SharedWorker","handleMessageFromWorker","startUpdateState","port","start","setCsrfToken","token","Type","isStringFilled","Loc","setMessage","getCsrfToken","getMessage","getSessionTimeInMilliseconds","sessionTime","Core","getApplicationData","Event","bind","postMessage","force","csrfToken","event","response","data","fireCountersEvent","counters","EventEmitter","emit","EventType","counter","onImUpdateCounter"],"mappings":";;;;;;;CAQA,MAAMA,WAAW,GAAG,8EAA8E;CAClG,MAAMC,WAAW,GAAG,sBAAsB;CAC1C,MAAMC,eAAe,GAAG,eAAe;AAEvC,CAAO,MAAMC,kBAAkB,CAC/B;GAGC,OAAOC,IAAI,GACX;KACC,OAAO,IAAID,kBAAkB,EAAE;;GAGhCE,WAAW,GACX;KACC,IAAI,EAAE,cAAc,IAAIC,MAAM,CAAC,EAC/B;OACC;;KAGD,IAAI,CAACC,oBAAoB,EAAE;KAC3B,IAAI,CAACC,iBAAiB,EAAE;;GAGzBD,oBAAoB,GACpB;KACC,IAAI,CAACE,MAAM,GAAG,IAAIC,YAAY,CAACV,WAAW,EAAEC,WAAW,CAAC;KACxD,IAAI,CAACU,uBAAuB,EAAE;KAC9B,IAAI,CAACC,gBAAgB,EAAE;KACvB,IAAI,CAACH,MAAM,CAACI,IAAI,CAACC,KAAK,EAAE;;GAGzBC,YAAY,CAACC,KAAa,EAC1B;KACC,IAAI,CAACC,cAAI,CAACC,cAAc,CAACF,KAAK,CAAC,EAC/B;OACC;;KAGDG,aAAG,CAACC,UAAU,CAAC;OAAElB,eAAe,EAAEc;MAAO,CAAC;;GAG3CK,YAAY,GACZ;KACC,OAAOF,aAAG,CAACG,UAAU,CAACpB,eAAe,CAAC;;GAGvCqB,4BAA4B,GAC5B;KACC,MAAM;OAAEC;MAAa,GAAGC,2BAAI,CAACC,kBAAkB,EAAE;KAEjD,OAAOF,WAAW,GAAG,IAAI;;GAG1BhB,iBAAiB,GACjB;KACCmB,eAAK,CAACC,IAAI,CAACtB,MAAM,EAAE,QAAQ,EAAE,MAAM;OAClC,IAAI,CAACG,MAAM,CAACI,IAAI,CAACgB,WAAW,CAAC;SAC5BC,KAAK,EAAE,IAAI;SACXN,WAAW,EAAE,IAAI,CAACD,4BAA4B,EAAE;SAChDQ,SAAS,EAAE,IAAI,CAACV,YAAY;QAC5B,CAAC;MACF,CAAC;;GAGHV,uBAAuB,GACvB;KACCgB,eAAK,CAACC,IAAI,CAAC,IAAI,CAACnB,MAAM,CAACI,IAAI,EAAE,SAAS,EAAGmB,KAAmB,IAAK;OAChE,MAAM;SAAED,SAAS;SAAEE;QAAU,GAAGD,KAAK,CAACE,IAAI;OAC1C,IAAI,CAACnB,YAAY,CAACgB,SAAS,CAAC;OAC5B,IAAI,CAACI,iBAAiB,CAACF,QAAQ,CAAC;MAChC,CAAC;;GAGHrB,gBAAgB,GAChB;KACC,IAAI,CAACH,MAAM,CAACI,IAAI,CAACgB,WAAW,CAAC;OAC5BC,KAAK,EAAE,KAAK;OACZN,WAAW,EAAE,IAAI,CAACD,4BAA4B,EAAE;OAChDQ,SAAS,EAAE,IAAI,CAACV,YAAY;MAC5B,CAAC;;GAGHc,iBAAiB,CAACF,QAAqB,EACvC;KACC,IAAI,EAACA,QAAQ,YAARA,QAAQ,CAAEG,QAAQ,GACvB;OACC;;KAGDC,6BAAY,CAACC,IAAI,CAAChC,MAAM,EAAEiC,qBAAS,CAACC,OAAO,CAACC,iBAAiB,EAAE,CAACR,QAAQ,CAACG,QAAQ,CAAC,CAAC;;CAErF;;;;;;;;"}