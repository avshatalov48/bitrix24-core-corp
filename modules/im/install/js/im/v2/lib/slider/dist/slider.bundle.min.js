this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,n,i,s,r,a,o){"use strict";const l="im:slider";const d=1200;const c="bx-im-messenger__slider";const h="/bitrix/js/im/v2/lib/slider/src/images/loader-chats.svg?v2";class g{static init(){if(this.instance){return}this.instance=new this}static getInstance(){this.init();return this.instance}constructor(){this.instances={};this.sidePanelManager=BX.SidePanel.Instance;this.v2enabled=false;s.Logger.warn("Slider: class created");this.initSettings();this.bindEvents()}openChat(e="",s=""){if(t.Type.isNumber(e)){e=e.toString()}return this.openSlider().then((()=>{this.store.dispatch("application/setLayout",{layoutName:i.Layout.chat.name,entityId:e}).then((()=>{n.EventEmitter.emit(i.EventType.layout.onOpenChat,{dialogId:e})}))}))}openLines(){return new Promise(((e,n)=>{BX.UI.Notification.Center.notify({content:t.Loc.getMessage("IM_LIB_SLIDER_LINES_NOT_IMPLEMENTED"),position:"top-right",autoHideDelay:1e4});n("Messenger: lines is not implemented yet")}))}openNotifications(){return this.openSlider().then((()=>{this.store.dispatch("application/setLayout",{layoutName:i.Layout.notification.name}).then((()=>{n.EventEmitter.emit(i.EventType.layout.onOpenNotifications)}))}))}openRecentSearch(){return this.openSlider().then((()=>{this.store.dispatch("application/setLayout",{layoutName:i.Layout.chat.name})})).then((()=>{n.EventEmitter.emit(i.EventType.recent.openSearch)}))}openSettings(e="",n=""){s.Logger.warn("Slider: onOpenSettings",e,n);return new Promise(((e,n)=>{BX.UI.Notification.Center.notify({content:t.Loc.getMessage("IM_LIB_SLIDER_SETTINGS_NOT_IMPLEMENTED"),position:"top-right",autoHideDelay:1e4});n("Messenger: settings is not implemented yet")}))}startVideoCall(e="",t=true){s.Logger.warn("Slider: onStartVideoCall",e,t);if(!o.Utils.dialog.isDialogId(e)){s.Logger.error("Slider: onStartVideoCall - dialogId is not correct",e);return false}return new Promise((n=>{a.CallManager.getInstance().startCall(e,t);n()}))}bindEvents(){if(!this.v2enabled){s.Logger.warn("Slider: v2 is not enabled");return false}n.EventEmitter.subscribe("SidePanel.Slider:onCloseByEsc",this.onCloseByEsc.bind(this));n.EventEmitter.subscribe("SidePanel.Slider:onClose",this.onClose.bind(this));n.EventEmitter.subscribe("SidePanel.Slider:onDestroy",this.onDestroy.bind(this));t.Event.ready(this.initZIndex.bind(this));return true}initSettings(){const e=t.Extension.getSettings("im.v2.lib.slider");this.v2enabled=e.get("v2enabled",false)}openSlider(){this.launchMessengerApplication();return new Promise((e=>{if(this.isFocused()){return e()}const t=this.getNextId();this.sidePanelManager.open(`${l}:${t}`,{data:{rightBoundary:0},cacheable:false,animationDuration:100,hideControls:true,customLeftBoundary:0,customRightBoundary:0,loader:h,contentCallback:()=>`<div class="${c}"></div>`,events:{onLoad:e=>{e.slider.showLoader()},onOpenComplete:t=>{this.initMessengerComponent().then((()=>{t.slider.closeLoader();return e()}))}}});this.instances[t]=this.sidePanelManager.getSlider(`${l}:${t}`)}))}launchMessengerApplication(){if(this.applicationPromise){return this.applicationPromise}this.applicationPromise=t.Runtime.loadExtension("im.v2.application.messenger").then((()=>r.Launch("messenger"))).then((e=>{s.Logger.warn("Slider: Messenger application launched",e);return e}));return this.applicationPromise}initMessengerComponent(){return this.applicationPromise.then((e=>{this.application=e;this.store=this.application.controller.store;this.store.dispatch("application/setLayout",{layoutName:i.Layout.chat.name,entityId:""});return e.initComponent(`.${c}`)}))}onDialogOpen(e){s.Logger.warn("Slider: onDialogOpen",e.data.dialogId)}onClose({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(l)){return}if(!this.canClose()){e.denyAction();return}const n=this.getIdFromSliderId(t);delete this.instances[n];this.openChat()}onCloseByEsc({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(l)){return false}if(!this.canCloseByEsc()){e.denyAction()}}onDestroy({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(l)){return false}const n=this.getIdFromSliderId(t);delete this.instances[n]}initZIndex(){if(!t.ZIndexManager){return}const e=t.ZIndexManager.getOrAddStack(document.body);e.baseIndex=d;e.sort()}getZIndex(){return d}isOpened(){return Object.keys(this.instances).length>0}isFocused(){if(!this.isOpened()){return false}const e=this.sidePanelManager.getTopSlider();if(!e){return false}return!!e.getUrl().toString().startsWith(l)}canClose(){return true}canCloseByEsc(){return false}getCurrent(){return this.instances[this.getCurrentId()]}getCurrentId(){return Object.keys(this.instances).length}getNextId(){return this.getCurrentId()+1}getIdFromSliderId(e){return Number.parseInt(e.slice(l.length+1),10)}}g.instance=null;e.MessengerSlider=g})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX,BX.Event,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=slider.bundle.map.js