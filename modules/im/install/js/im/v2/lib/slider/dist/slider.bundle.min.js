this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,n,i,s,r,o,a,l,d){"use strict";const c="im:slider";const g=1200;const h="bx-im-messenger__slider";const u="/bitrix/js/im/v2/lib/slider/src/images/loader-chats.svg?v2";class p{static init(){if(this.instance){return}this.instance=new this}static getInstance(){this.init();return this.instance}constructor(){this.instances={};this.sidePanelManager=BX.SidePanel.Instance;this.v2enabled=false;r.Logger.warn("Slider: class created");this.initSettings();this.bindEvents();this.store=i.Core.getStore()}openChat(e="",i=""){let r=e.toString();if(l.Utils.dialog.isLinesExternalId(r)){return this.openLines()}if(t.Type.isNumber(r)){r=r.toString()}return this.openSlider().then((()=>this.store.dispatch("application/setLayout",{layoutName:s.Layout.chat.name,entityId:r}))).then((()=>{n.EventEmitter.emit(s.EventType.layout.onOpenChat,{dialogId:r})}))}openLines(){return new Promise(((e,n)=>{BX.UI.Notification.Center.notify({content:t.Loc.getMessage("IM_LIB_SLIDER_LINES_NOT_IMPLEMENTED_2"),position:"top-right",autoHideDelay:1e4});n(new Error("Messenger: lines are not implemented yet"))}))}openNotifications(){return this.openSlider().then((()=>this.store.dispatch("application/setLayout",{layoutName:s.Layout.notification.name}))).then((()=>{n.EventEmitter.emit(s.EventType.layout.onOpenNotifications)}))}openRecentSearch(){return this.openSlider().then((()=>{this.store.dispatch("application/setLayout",{layoutName:s.Layout.chat.name})})).then((()=>{n.EventEmitter.emit(s.EventType.recent.openSearch)}))}openSettings(e="",n=""){r.Logger.warn("Slider: onOpenSettings",e,n);return new Promise(((e,n)=>{BX.UI.Notification.Center.notify({content:t.Loc.getMessage("IM_LIB_SLIDER_SETTINGS_NOT_IMPLEMENTED"),position:"top-right",autoHideDelay:1e4});n(new Error("Messenger: settings are not implemented yet"))}))}startVideoCall(e="",t=true){r.Logger.warn("Slider: onStartVideoCall",e,t);if(!l.Utils.dialog.isDialogId(e)){r.Logger.error("Slider: onStartVideoCall - dialogId is not correct",e);return false}a.CallManager.getInstance().startCall(e,t);return Promise.resolve()}bindEvents(){if(!this.v2enabled){r.Logger.warn("Slider: v2 is not enabled");return false}n.EventEmitter.subscribe("SidePanel.Slider:onCloseByEsc",this.onCloseByEsc.bind(this));n.EventEmitter.subscribe("SidePanel.Slider:onClose",this.onClose.bind(this));n.EventEmitter.subscribe("SidePanel.Slider:onDestroy",this.onDestroy.bind(this));t.Event.ready(this.initZIndex.bind(this));return true}initSettings(){const e=t.Extension.getSettings("im.v2.lib.slider");this.v2enabled=e.get("v2enabled",false)}openSlider(){if(d.DesktopManager.isDesktop()){return Promise.resolve()}this.launchMessengerApplication();return new Promise((e=>{if(this.isFocused()){e();return}const t=this.getNextId();this.sidePanelManager.open(`${c}:${t}`,{data:{rightBoundary:0},cacheable:false,animationDuration:100,hideControls:true,customLeftBoundary:0,customRightBoundary:0,loader:u,contentCallback:()=>`<div class="${h}"></div>`,events:{onLoad:e=>{e.slider.showLoader()},onOpenComplete:t=>{this.initMessengerComponent().then((()=>{t.slider.closeLoader();return e()}))}}});this.instances[t]=this.sidePanelManager.getSlider(`${c}:${t}`)}))}launchMessengerApplication(){if(this.applicationPromise){return this.applicationPromise}this.applicationPromise=t.Runtime.loadExtension("im.v2.application.messenger").then((()=>o.Launch("messenger"))).then((e=>{r.Logger.warn("Slider: Messenger application launched",e);return e}));return this.applicationPromise}initMessengerComponent(){return this.applicationPromise.then((e=>{this.store.dispatch("application/setLayout",{layoutName:s.Layout.chat.name,entityId:""});return e.initComponent(`.${h}`)}))}onDialogOpen(e){r.Logger.warn("Slider: onDialogOpen",e.data.dialogId)}onClose({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(c)){return}if(!this.canClose()){e.denyAction();return}const n=this.getIdFromSliderId(t);delete this.instances[n];this.openChat()}onCloseByEsc({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(c)){return}if(!this.canCloseByEsc()){e.denyAction()}}onDestroy({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(c)){return}const n=this.getIdFromSliderId(t);delete this.instances[n]}initZIndex(){if(!t.ZIndexManager){return}const e=t.ZIndexManager.getOrAddStack(document.body);e.baseIndex=g;e.sort()}getZIndex(){return g}isOpened(){return Object.keys(this.instances).length>0}isFocused(){if(!this.isOpened()){return false}const e=this.sidePanelManager.getTopSlider();if(!e){return false}return e.getUrl().toString().startsWith(c)}canClose(){return true}canCloseByEsc(){return false}getCurrent(){return this.instances[this.getCurrentId()]}getCurrentId(){return Object.keys(this.instances).length}getNextId(){return this.getCurrentId()+1}getIdFromSliderId(e){return Number.parseInt(e.slice(c.length+1),10)}}p.instance=null;e.MessengerSlider=p})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX,BX.Event,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=slider.bundle.map.js