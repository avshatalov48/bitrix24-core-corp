{"version":3,"file":"desktop.bundle.js","sources":["../src/classes/api.js","../src/classes/checker.js","../src/desktop.js"],"sourcesContent":["import {DesktopFeature} from 'im.v2.const';\nimport {Type} from 'main.core';\n\nexport const DesktopApi = {\n\tisApiAvailable(): boolean\n\t{\n\t\treturn Type.isObject(window.BXDesktopSystem);\n\t},\n\tgetApiVersion(): number\n\t{\n\t\tif (!this.isApiAvailable())\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst [majorVersion, minorVersion, buildVersion, apiVersion] = window.BXDesktopSystem.GetProperty('versionParts');\n\n\t\treturn apiVersion;\n\t},\n\tisFeatureEnabled(code: $Keys<typeof DesktopFeature>): boolean\n\t{\n\t\treturn !!window.BXDesktopSystem?.FeatureEnabled(code);\n\t},\n};","import {Dom} from 'main.core';\n\nconst IMAGE_CHECK_URL = 'http://127.0.0.1:20141';\nconst IMAGE_CHECK_TIMEOUT = 500;\nconst IMAGE_CLASS = 'bx-im-messenger__out-of-view';\n\nconst checkTimeoutList = {};\n\nexport const Checker = {\n\ttestImageUpload(successCallback, failureCallback)\n\t{\n\t\tconst dateCheck = Date.now();\n\t\tlet failureCallbackCalled = false;\n\n\t\tconst imageForCheck = Dom.create({\n\t\t\ttag: 'img',\n\t\t\tattrs: {\n\t\t\t\tsrc: `${IMAGE_CHECK_URL}/icon.png?${dateCheck}`,\n\t\t\t\t'data-id': dateCheck,\n\t\t\t},\n\t\t\tprops: {\n\t\t\t\tclassName: IMAGE_CLASS,\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\terror: function() {\n\t\t\t\t\tif (failureCallbackCalled)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst checkId = this.dataset.id;\n\t\t\t\t\tfailureCallback(false, checkId);\n\n\t\t\t\t\tclearTimeout(checkTimeoutList[checkId]);\n\t\t\t\t\tDom.remove(this);\n\t\t\t\t},\n\t\t\t\tload: function() {\n\t\t\t\t\tconst checkId = this.dataset.id;\n\t\t\t\t\tsuccessCallback(true, checkId);\n\n\t\t\t\t\tclearTimeout(checkTimeoutList[checkId]);\n\t\t\t\t\tDom.remove(this);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tdocument.body.append(imageForCheck);\n\n\t\tcheckTimeoutList[dateCheck] = setTimeout(() => {\n\t\t\tfailureCallbackCalled = true;\n\n\t\t\tfailureCallback(false, dateCheck);\n\t\t\tDom.remove(imageForCheck);\n\t\t}, IMAGE_CHECK_TIMEOUT);\n\t}\n};","import {Extension} from 'main.core';\nimport {EventEmitter, BaseEvent} from 'main.core.events';\n\nimport {DesktopFeature} from 'im.v2.const';\nimport {Logger} from 'im.v2.lib.logger';\n\nimport {DesktopApi} from './classes/api';\nimport {Checker} from './classes/checker';\n\nconst DESKTOP_PROTOCOL_VERSION = 2;\nconst LOCATION_RESET_TIMEOUT = 1000;\n\nexport class DesktopManager\n{\n\tstatic instance: DesktopManager;\n\n\t#desktopIsActive: boolean;\n\t#locationChangedToBx = false;\n\n\tstatic getInstance(): DesktopManager\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tDesktopManager.getInstance();\n\t}\n\n\tstatic isDesktop(): boolean\n\t{\n\t\treturn DesktopApi.isApiAvailable();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#initDesktopStatus();\n\t\t// init real desktop\n\t}\n\n\tisDesktopActive(): boolean\n\t{\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.#desktopIsActive;\n\t}\n\n\tsetDesktopActive(flag: boolean)\n\t{\n\t\tthis.#desktopIsActive = flag;\n\t}\n\n\tgetDesktopVersion(): number\n\t{\n\t\treturn DesktopApi.getApiVersion();\n\t}\n\n\tisFeatureEnabled(code: $Keys<typeof DesktopFeature>): boolean\n\t{\n\t\treturn DesktopApi.isFeatureEnabled(code);\n\t}\n\n\tisLocationChangedToBx(): boolean\n\t{\n\t\treturn this.#locationChangedToBx;\n\t}\n\n\tstartVideoCall(dialogId: string = '', withVideo: boolean = true): Promise\n\t{\n\t\tLogger.warn('Desktop: startVideoCall', dialogId, withVideo);\n\t\tconst callType = withVideo? 'video': 'audio';\n\t\t// TODO: enum for commands\n\t\tthis.#goToBx(`bx://callto/${callType}/${dialogId}`);\n\n\t\treturn Promise.resolve();\n\t}\n\n\tcheckStatusInDifferentContext(): Promise\n\t{\n\t\tif (!this.#desktopIsActive)\n\t\t{\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\t// TODO: check two-windowed mode\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tChecker.testImageUpload(\n\t\t\t\t() => { resolve(true); },\n\t\t\t\t() => { resolve(false); }\n\t\t\t);\n\t\t});\n\t}\n\n\t#goToBx(url: string)\n\t{\n\t\tthis.#prepareBxUrl(url);\n\n\t\tthis.#locationChangedToBx = true;\n\t\tsetTimeout(() => {\n\t\t\tconst event = new BaseEvent({compatData: []});\n\t\t\tEventEmitter.emit(window, 'BXLinkOpened', event);\n\t\t\tthis.#locationChangedToBx = false;\n\t\t}, LOCATION_RESET_TIMEOUT);\n\n\t\tlocation.href = url;\n\t}\n\n\t#prepareBxUrl(url: string): string\n\t{\n\t\tif (/^bx:\\/\\/v(\\d)\\//.test(url))\n\t\t{\n\t\t\treturn url;\n\t\t}\n\n\t\treturn url.replace('bx://', `bx://v${DESKTOP_PROTOCOL_VERSION}/${location.hostname}/`);\n\t}\n\n\t#initDesktopStatus()\n\t{\n\t\tconst settings = Extension.getSettings('im.v2.lib.desktop');\n\t\tthis.setDesktopActive(settings.get('desktopIsActive'));\n\t}\n}"],"names":["DesktopApi","isApiAvailable","Type","isObject","window","BXDesktopSystem","getApiVersion","majorVersion","minorVersion","buildVersion","apiVersion","GetProperty","isFeatureEnabled","code","FeatureEnabled","IMAGE_CHECK_URL","IMAGE_CHECK_TIMEOUT","IMAGE_CLASS","checkTimeoutList","Checker","testImageUpload","successCallback","failureCallback","dateCheck","Date","now","failureCallbackCalled","imageForCheck","Dom","create","tag","attrs","src","props","className","events","error","checkId","dataset","id","clearTimeout","remove","load","document","body","append","setTimeout","DESKTOP_PROTOCOL_VERSION","LOCATION_RESET_TIMEOUT","DesktopManager","getInstance","instance","init","isDesktop","constructor","isDesktopActive","setDesktopActive","flag","getDesktopVersion","isLocationChangedToBx","startVideoCall","dialogId","withVideo","Logger","warn","callType","Promise","resolve","checkStatusInDifferentContext","url","event","BaseEvent","compatData","EventEmitter","emit","location","href","test","replace","hostname","settings","Extension","getSettings","get"],"mappings":"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"}