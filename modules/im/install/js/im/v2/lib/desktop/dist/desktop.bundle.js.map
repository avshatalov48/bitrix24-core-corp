{"version":3,"file":"desktop.bundle.js","sources":["../src/desktop-api.js","../src/desktop-utils.js","../src/desktop.js"],"sourcesContent":["import {DesktopFeature} from 'im.v2.const';\nimport {Type} from 'main.core';\n\nexport const DesktopApi = {\n\n\tgetApiVersion()\n\t{\n\t\tif (!this.isApiAvailable())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst [,,, version] = window.BXDesktopSystem.GetProperty('versionParts');\n\t\treturn version;\n\t},\n\tisApiAvailable()\n\t{\n\t\treturn Type.isObject(window.BXDesktopSystem);\n\t},\n\tisFeatureEnabled(code: $Values<typeof DesktopFeature>): boolean\n\t{\n\t\treturn !!window.BXDesktopSystem?.FeatureEnabled(code);\n\t},\n};","import {DesktopApi} from './desktop-api';\nimport {DesktopManager} from './desktop';\nimport {Dom, Type} from 'main.core';\n\nlet locationChangedToBx = false;\nconst checkTimeoutList = {};\nconst CHECK_IMAGE_URL = 'http://127.0.0.1:20141';\nconst DESKTOP_PROTOCOL_VERSION = 2;\n\nexport const DesktopUtils = {\n\n\tcheckRunStatus(successCallback, failureCallback)\n\t{\n\t\tif (!Type.isFunction(failureCallback))\n\t\t{\n\t\t\tfailureCallback = () => {};\n\t\t}\n\n\t\t// this.settings.openDesktopFromPanel -> false\n\n\t\tif (!Type.isFunction(successCallback))\n\t\t{\n\t\t\tfailureCallback();\n\t\t\treturn false;\n\t\t}\n\n\t\tconst dateCheck = Date.now();\n\t\tconst Desktop = DesktopManager.getInstance();\n\n\t\tif (!Desktop.isDesktopActive())\n\t\t{\n\t\t\tfailureCallback(false, dateCheck);\n\t\t\treturn true;\n\t\t}\n\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\tfailureCallback(false, dateCheck);\n\t\t\treturn false;\n\t\t}\n\n\t\tlet alreadyExecuteFailureCallback = false;\n\n\t\tconst imageForCheck = Dom.create({\n\t\t\ttag: 'img',\n\t\t\tattrs: {\n\t\t\t\tsrc: `${CHECK_IMAGE_URL}/icon.png?${dateCheck}`,\n\t\t\t\t'data-id': dateCheck,\n\t\t\t},\n\t\t\tprops: {\n\t\t\t\tclassName: 'bx-im-messenger__out-of-view',\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\terror: function() {\n\t\t\t\t\tif (alreadyExecuteFailureCallback)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst checkId = this.dataset.id;\n\t\t\t\t\tfailureCallback(false, checkId);\n\n\t\t\t\t\tclearTimeout(checkTimeoutList[checkId]);\n\t\t\t\t\tDom.remove(this);\n\t\t\t\t},\n\t\t\t\tload: function() {\n\t\t\t\t\tconst checkId = this.dataset.id;\n\t\t\t\t\tsuccessCallback(true, checkId);\n\n\t\t\t\t\tclearTimeout(checkTimeoutList[checkId]);\n\t\t\t\t\tDom.remove(this);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tdocument.body.append(imageForCheck);\n\n\t\tcheckTimeoutList[dateCheck] = setTimeout(() => {\n\t\t\talreadyExecuteFailureCallback = true;\n\n\t\t\tfailureCallback(false, dateCheck);\n\t\t\tDom.remove(imageForCheck);\n\t\t}, 500);\n\n\t\treturn true;\n\t},\n\n\tgoToBx(url)\n\t{\n\t\tif (!/^bx:\\/\\/v(\\d)\\//.test(url))\n\t\t{\n\t\t\turl = url.replace('bx://', `bx://v${DESKTOP_PROTOCOL_VERSION}/${location.hostname}/`);\n\t\t}\n\n\t\tlocationChangedToBx = true;\n\t\tsetTimeout(() => {\n\t\t\t// eslint-disable-next-line bitrix-rules/no-bx\n\t\t\tBX.onCustomEvent('BXLinkOpened', []);\n\t\t\tlocationChangedToBx = false;\n\t\t}, 1000);\n\n\t\tlocation.href = url;\n\t},\n\n\tisLocationChangedToBx()\n\t{\n\t\treturn locationChangedToBx;\n\t},\n\n\tencodeParams(params)\n\t{\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\tlet stringParams = '';\n\t\tlet first = true;\n\n\t\tfor (const i in params)\n\t\t{\n\t\t\tstringParams = stringParams + (first? '': '!!') + i + '!!' + params[i];\n\t\t\tfirst = false;\n\t\t}\n\n\t\treturn stringParams;\n\t},\n\n\tdecodeParams(encodedParams)\n\t{\n\t\tconst result = {};\n\t\tif (!Type.isStringFilled(encodedParams))\n\t\t{\n\t\t\treturn result;\n\t\t}\n\n\t\tconst chunks = encodedParams.split('!!');\n\t\tfor (let i = 0; i < chunks.length; i += 2)\n\t\t{\n\t\t\tresult[chunks[i]] = chunks[i+1];\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tencodeParamsJson(params)\n\t{\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\treturn '{}';\n\t\t}\n\n\t\tlet result;\n\t\ttry\n\t\t{\n\t\t\tresult = encodeURIComponent(JSON.stringify(params));\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('DesktopUtils: could not encode params.', error);\n\t\t\tresult = '{}';\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tdecodeParamsJson(encodedParams)\n\t{\n\t\tlet result = {};\n\t\tif (!Type.isStringFilled(encodedParams))\n\t\t{\n\t\t\treturn result;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tresult = JSON.parse(decodeURIComponent(encodedParams));\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('DesktopUtils: could not decode encoded params.', error);\n\t\t}\n\n\t\treturn result;\n\t}\n};","import {Extension} from 'main.core';\nimport {DesktopFeature} from 'im.v2.const';\nimport {DesktopApi} from './desktop-api';\nimport {Logger} from 'im.v2.lib.logger';\nimport {DesktopUtils} from './desktop-utils';\n\nexport class DesktopManager\n{\n\tstatic instance: DesktopManager;\n\n\t#desktopIsActive: boolean;\n\t#desktopVersion: number = 0;\n\n\tstatic getInstance(): DesktopManager\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tDesktopManager.getInstance();\n\t}\n\n\tstatic isDesktop(): boolean\n\t{\n\t\treturn DesktopApi.isApiAvailable();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#initDesktopStatus();\n\t}\n\n\tisDesktopActive(): boolean\n\t{\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.#desktopIsActive;\n\t}\n\n\tsetDesktopActive(flag: boolean)\n\t{\n\t\tthis.#desktopIsActive = flag;\n\t}\n\n\tgetDesktopVersion(): number\n\t{\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn DesktopApi.getApiVersion();\n\t\t}\n\n\t\treturn this.#desktopVersion;\n\t}\n\n\tsetDesktopVersion(version: number)\n\t{\n\t\tif (DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn DesktopApi.getApiVersion();\n\t\t}\n\n\t\tthis.#desktopVersion = version;\n\t}\n\n\tisDesktopFeatureEnabled(code: $Values<typeof DesktopFeature>): boolean\n\t{\n\t\tif (!DesktopApi.isApiAvailable())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn DesktopApi.isFeatureEnabled(code);\n\t}\n\n\t#initDesktopStatus()\n\t{\n\t\tconst settings = Extension.getSettings('im.v2.lib.desktop');\n\t\tthis.setDesktopActive(settings.get('desktopIsActive'));\n\t\tthis.setDesktopVersion(settings.get('desktopVersion'));\n\t}\n\n\tstartVideoCall(dialogId: string = '', withVideo: boolean = true): Promise\n\t{\n\t\tLogger.warn('Desktop: onStartVideoCall', dialogId, withVideo);\n\n\t\tconst callType = withVideo? 'video': 'audio';\n\t\tDesktopUtils.goToBx(`bx://callto/${callType}/${dialogId}`);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tcheckRunStatus()\n\t{\n\t\treturn new Promise((resolve, failure) => {\n\t\t\tDesktopUtils.checkRunStatus(resolve, failure);\n\t\t});\n\t}\n}"],"names":["DesktopApi","getApiVersion","isApiAvailable","version","window","BXDesktopSystem","GetProperty","Type","isObject","isFeatureEnabled","code","FeatureEnabled","locationChangedToBx","checkTimeoutList","CHECK_IMAGE_URL","DESKTOP_PROTOCOL_VERSION","DesktopUtils","checkRunStatus","successCallback","failureCallback","isFunction","dateCheck","Date","now","Desktop","DesktopManager","getInstance","isDesktopActive","alreadyExecuteFailureCallback","imageForCheck","Dom","create","tag","attrs","src","props","className","events","error","checkId","dataset","id","clearTimeout","remove","load","document","body","append","setTimeout","goToBx","url","test","replace","location","hostname","BX","onCustomEvent","href","isLocationChangedToBx","encodeParams","params","isPlainObject","stringParams","first","i","decodeParams","encodedParams","result","isStringFilled","chunks","split","length","encodeParamsJson","encodeURIComponent","JSON","stringify","console","decodeParamsJson","parse","decodeURIComponent","instance","init","isDesktop","constructor","setDesktopActive","flag","getDesktopVersion","setDesktopVersion","isDesktopFeatureEnabled","startVideoCall","dialogId","withVideo","Logger","warn","callType","Promise","resolve","failure","settings","Extension","getSettings","get"],"mappings":"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"}