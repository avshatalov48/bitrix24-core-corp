this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,s,i,o,r,n,a,l,c){"use strict";const d="http://127.0.0.1:20141";const p=500;const b="bx-im-messenger__out-of-view";const v="//www.bitrixsoft.com/200.ok";const u={};const h={testImageUpload(e,t){const s=Date.now();let o=false;const r=i.Dom.create({tag:"img",attrs:{src:`${d}/icon.png?${s}`,"data-id":s},props:{className:b},events:{error:function(){if(o){return}const e=this.dataset.id;t(false,e);clearTimeout(u[e]);i.Dom.remove(this)},load:function(){const t=this.dataset.id;e(true,t);clearTimeout(u[t]);i.Dom.remove(this)}}});document.body.append(r);u[s]=setTimeout((()=>{o=true;t(false,s);i.Dom.remove(r)}),p)},testInternetConnection(){const e=Date.now();return new Promise((t=>{fetch(`${v}.${e}`).then((e=>{if(e.status===200){return t(true)}t(false)})).catch((()=>{t(false)}))}))}};let f=[];let g=0;const L={openConference(e){if(!o.Utils.conference.isValidCode(e)){return false}if(!r.DesktopApi.isDesktop()){return false}let t=null;const s=[{width:2560,height:1440},{width:2048,height:1152},{width:1920,height:1080},{width:1600,height:900},{width:1366,height:768},{width:1024,height:576}];for(const e of s){t=e;if(screen.width>e.width&&screen.height>e.height){break}}f=f.filter((e=>Boolean(r.DesktopApi.findWindow(e))));f.push(o.Utils.conference.getWindowNameByCode(e));r.DesktopApi.createWindow(o.Utils.conference.getWindowNameByCode(e),(s=>{s.SetProperty("title",i.Loc.getMessage("IM_LIB_DESKTOP_CONFERENCE_TITLE"));s.SetProperty("clientSize",{Width:t.width,Height:t.height});s.SetProperty("minClientSize",{Width:940,Height:400});s.SetProperty("backgroundColor","#2B3038");s.ExecuteCommand("html.load",`<script>location.href="/desktop_app/router.php?alias=${e}&videoconf";<\/script>`);s.ExecuteCommand("show")}));return true},toggleConference(){if(g>f.length-1){g=0;const e=i.Reflection.getClass("BX.Messenger.v2.Lib.CallManager");if(e&&e.getInstance().hasCurrentCall()){e.getInstance().foldCurrentCall()}r.DesktopApi.showWindow();return true}f=f.filter((e=>Boolean(r.DesktopApi.findWindow(e))));for(let e=g;e<f.length;e++){g++;const t=r.DesktopApi.findWindow(f[e]);if(t){r.DesktopApi.activateWindow(t);break}}return true}};const P="!!";const k={encodeParams(e){if(!i.Type.isPlainObject(e)){return""}let t="";Object.entries(e).forEach((([e,s])=>{const i="";t+=`${i}${e}${P}${s}`}));return t},decodeParams(e){const t={};if(!i.Type.isStringFilled(e)){return t}const s=e.split(P);for(let e=0;e<s.length;e+=2){const i=s[e];const o=s[e+1];t[i]=o}return t},encodeParamsJson(e){if(!i.Type.isPlainObject(e)){return"{}"}let t="";try{t=encodeURIComponent(JSON.stringify(e))}catch(e){console.error("DesktopUtils: could not encode params.",e);t="{}"}return t},decodeParamsJson(e){let t={};if(!i.Type.isStringFilled(e)){return t}try{t=JSON.parse(decodeURIComponent(e))}catch(e){console.error("DesktopUtils: could not decode encoded params.",e)}return t}};var B=babelHelpers.classPrivateFieldLooseKey("subscribeToBxProtocolEvent");var y=babelHelpers.classPrivateFieldLooseKey("subscribeToLegacyBxProtocolEvent");class D{static init(){return new D}constructor(){Object.defineProperty(this,y,{value:m});Object.defineProperty(this,B,{value:C});babelHelpers.classPrivateFieldLooseBase(this,B)[B]();babelHelpers.classPrivateFieldLooseBase(this,y)[y]()}}function C(){r.DesktopApi.subscribe(c.EventType.desktop.onBxLink,((e,s)=>{const i=s!=null?s:{};Object.entries(i).forEach((([e,t])=>{i[e]=decodeURIComponent(t)}));r.DesktopApi.activateWindow();if(e===c.DesktopBxLink.chat){void t.Messenger.openChat(i.dialogId)}else if(e===c.DesktopBxLink.lines){void t.Messenger.openLines(i.dialogId)}else if(e===c.DesktopBxLink.conference){void Me.getInstance().openConference(i.code)}else if(e===c.DesktopBxLink.call){const e=i.withVideo!=="N";void t.Messenger.startVideoCall(i.dialogId,e)}else if(e===c.DesktopBxLink.phone){const e=k.decodeParamsJson(i.phoneParams);void t.Messenger.startPhoneCall(i.number,e)}else if(e===c.DesktopBxLink.callList){const e=k.decodeParamsJson(i.callListParams);void t.Messenger.startCallList(i.callListId,e)}else if(e===c.DesktopBxLink.notifications){void t.Messenger.openNotifications()}else if(e===c.DesktopBxLink.recentSearch){void t.Messenger.openRecentSearch()}else if(e===c.DesktopBxLink.timeManager){var o,n;(o=BX.Timeman)==null?void 0:(n=o.Monitor)==null?void 0:n.openReport()}}))}function m(){r.DesktopApi.subscribe(c.EventType.desktop.onBxLink,((e,s)=>{const i=s!=null?s:{};Object.entries(i).forEach((([e,t])=>{i[e]=decodeURIComponent(t)}));r.DesktopApi.activateWindow();if(e===c.LegacyDesktopBxLink.messenger){if(i.dialog){void t.Messenger.openChat(i.dialog)}else if(i.chat){void t.Messenger.openChat(`chat${i.chat}`)}else{void t.Messenger.openChat()}}else if(e===c.LegacyDesktopBxLink.chat&&i.id){void t.Messenger.openChat(`chat${i.id}`)}else if(e===c.LegacyDesktopBxLink.notify){void t.Messenger.openNotifications()}else if(e===c.LegacyDesktopBxLink.callTo){if(i.video){void t.Messenger.startVideoCall(i.video)}else if(i.audio){void t.Messenger.startVideoCall(i.audio,false)}else if(i.phone){void t.Messenger.startPhoneCall(i.phone)}}else if(e===c.LegacyDesktopBxLink.callList){void t.Messenger.openRecentSearch()}}))}var w=babelHelpers.classPrivateFieldLooseKey("subscribeToLogoutEvent");var F=babelHelpers.classPrivateFieldLooseKey("onExit");class H{static init(){return new H}constructor(){Object.defineProperty(this,F,{value:T});Object.defineProperty(this,w,{value:x});babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}}function x(){r.DesktopApi.subscribe(c.EventType.desktop.onExit,babelHelpers.classPrivateFieldLooseBase(this,F)[F].bind(this))}function T(){l.runAction(c.RestMethod.imV2DesktopLogout).finally((()=>{r.DesktopApi.shutdown()}))}var E=babelHelpers.classPrivateFieldLooseKey("initDate");var O=babelHelpers.classPrivateFieldLooseKey("subscribeToWakeUpEvent");var I=babelHelpers.classPrivateFieldLooseKey("onWakeUp");var A=babelHelpers.classPrivateFieldLooseKey("subscribeToIconClickEvent");var S=babelHelpers.classPrivateFieldLooseKey("onIconClick");var M=babelHelpers.classPrivateFieldLooseKey("subscribeToAwayEvent");var j=babelHelpers.classPrivateFieldLooseKey("onUserAway");var K=babelHelpers.classPrivateFieldLooseKey("subscribeToFocusEvent");var $=babelHelpers.classPrivateFieldLooseKey("subscribeToBlurEvent");var R=babelHelpers.classPrivateFieldLooseKey("removeNativeNotifications");var U=babelHelpers.classPrivateFieldLooseKey("setInitialStatus");var W=babelHelpers.classPrivateFieldLooseKey("subscribeToStatusChange");class N{static init(){return new N}constructor(){Object.defineProperty(this,W,{value:ee});Object.defineProperty(this,U,{value:Z});Object.defineProperty(this,R,{value:Q});Object.defineProperty(this,$,{value:G});Object.defineProperty(this,K,{value:Y});Object.defineProperty(this,j,{value:z});Object.defineProperty(this,M,{value:q});Object.defineProperty(this,S,{value:_});Object.defineProperty(this,A,{value:J});Object.defineProperty(this,I,{value:V});Object.defineProperty(this,O,{value:X});Object.defineProperty(this,E,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,E)[E]=new Date;babelHelpers.classPrivateFieldLooseBase(this,O)[O]();babelHelpers.classPrivateFieldLooseBase(this,M)[M]();babelHelpers.classPrivateFieldLooseBase(this,K)[K]();babelHelpers.classPrivateFieldLooseBase(this,$)[$]();babelHelpers.classPrivateFieldLooseBase(this,A)[A]();babelHelpers.classPrivateFieldLooseBase(this,U)[U]();babelHelpers.classPrivateFieldLooseBase(this,W)[W]()}}function X(){r.DesktopApi.subscribe(c.EventType.desktop.onWakeUp,babelHelpers.classPrivateFieldLooseBase(this,I)[I].bind(this))}async function V(){const e=await h.testInternetConnection();if(!e){console.error("NO INTERNET CONNECTION!");return}if(o.Utils.date.isSameDay(new Date,babelHelpers.classPrivateFieldLooseBase(this,E)[E])){n.Core.getPullClient().restart()}else{r.DesktopApi.reloadWindow()}}function J(){r.DesktopApi.subscribe(c.EventType.desktop.onIconClick,babelHelpers.classPrivateFieldLooseBase(this,S)[S].bind(this))}function _(){Me.getInstance().toggleConference()}function q(){r.DesktopApi.subscribe(c.EventType.desktop.onUserAway,babelHelpers.classPrivateFieldLooseBase(this,j)[j].bind(this))}function z(e){const t=e?c.RestMethod.imUserStatusIdleStart:c.RestMethod.imUserStatusIdleEnd;n.Core.getRestClient().callMethod(t).catch((e=>{console.error(`Desktop: error in ${t}  - ${e}`)}))}function Y(){i.Event.bind(window,"focus",babelHelpers.classPrivateFieldLooseBase(this,R)[R].bind(this))}function G(){i.Event.bind(window,"blur",babelHelpers.classPrivateFieldLooseBase(this,R)[R].bind(this))}function Q(){if(!i.Browser.isWin()||!r.DesktopApi.isChatWindow()){return}r.DesktopApi.removeNativeNotifications()}function Z(){const e=n.Core.getUserId();const t=n.Core.getStore().getters["users/get"](e);if(!t){return}r.DesktopApi.setIconStatus(t.status)}function ee(){const e=(e,t)=>{const s=n.Core.getUserId();const i=t["users/get"](s);return i==null?void 0:i.status};n.Core.getStore().watch(e,(e=>{r.DesktopApi.setIconStatus(e)}))}var te=babelHelpers.classPrivateFieldLooseKey("store");var se=babelHelpers.classPrivateFieldLooseKey("subscribeToCountersChange");var ie=babelHelpers.classPrivateFieldLooseKey("onCounterChange");class oe{static init(){return new oe}constructor(){Object.defineProperty(this,ie,{value:ne});Object.defineProperty(this,se,{value:re});Object.defineProperty(this,te,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,te)[te]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,se)[se]()}}function re(){s.EventEmitter.subscribe(c.EventType.counter.onNotificationCounterChange,babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].bind(this));s.EventEmitter.subscribe(c.EventType.counter.onChatCounterChange,babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].bind(this))}function ne(){const e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["recent/getTotalChatCounter"];const t=babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["notifications/getCounter"];const s=e>0;r.DesktopApi.setCounter(e+t,s)}var ae=babelHelpers.classPrivateFieldLooseKey("bindHotkeys");class le{static init(){return new le}constructor(){Object.defineProperty(this,ae,{value:ce});babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]()}}function ce(){i.Event.bind(window,"keydown",(e=>{const t=o.Utils.key.isCombination(e,"Ctrl+R");if(t){r.DesktopApi.reloadWindow()}}))}var de=babelHelpers.classPrivateFieldLooseKey("sessionTime");var pe=babelHelpers.classPrivateFieldLooseKey("startUpdateInterval");var be=babelHelpers.classPrivateFieldLooseKey("requestUpdate");class ve{static init(){return new ve}constructor(){Object.defineProperty(this,be,{value:he});Object.defineProperty(this,pe,{value:ue});Object.defineProperty(this,de,{writable:true,value:void 0});const{sessionTime:e}=n.Core.getApplicationData();babelHelpers.classPrivateFieldLooseBase(this,de)[de]=e*1e3;babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()}}function ue(){setInterval((()=>{babelHelpers.classPrivateFieldLooseBase(this,be)[be]()}),babelHelpers.classPrivateFieldLooseBase(this,de)[de])}function he(){a.Logger.warn("Desktop: updateStateManager: requesting update");l.runAction(c.RestMethod.imV2UpdateState).catch((e=>{console.error("Desktop: updateStateManager: error updating state",e)}))}var fe=babelHelpers.classPrivateFieldLooseKey("minWidth");var ge=babelHelpers.classPrivateFieldLooseKey("minHeight");var Le=babelHelpers.classPrivateFieldLooseKey("setDefaults");var Pe=babelHelpers.classPrivateFieldLooseKey("sendInitEvent");var ke=babelHelpers.classPrivateFieldLooseKey("initSliderBindings");var Be=babelHelpers.classPrivateFieldLooseKey("getSliderBindingsStatus");var ye=babelHelpers.classPrivateFieldLooseKey("initComplete");class De{static init(){return new De}constructor(){Object.defineProperty(this,ye,{value:He});Object.defineProperty(this,Be,{value:Fe});Object.defineProperty(this,ke,{value:we});Object.defineProperty(this,Pe,{value:me});Object.defineProperty(this,Le,{value:Ce});Object.defineProperty(this,fe,{writable:true,value:1280});Object.defineProperty(this,ge,{writable:true,value:720});N.init();H.init();D.init();oe.init();le.init();ve.init();babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]();babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]();babelHelpers.classPrivateFieldLooseBase(this,ke)[ke]();babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]()}}function Ce(){}function me(){const{currentUser:e}=n.Core.getApplicationData();r.DesktopApi.emit(c.EventType.desktop.onInit,[{userInfo:e!=null?e:{}}])}function we(){const e=babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]();if(e){BX.SidePanel.Instance.enableAnchorBinding();return}BX.SidePanel.Instance.disableAnchorBinding()}function Fe(){const e=r.DesktopApi.getCustomSetting(r.DesktopSettingsKey.sliderBindingsStatus,"1");return e==="1"}function He(){BXDesktopSystem.LogInfo=function(...e){a.Logger.desktop(...e)};r.DesktopApi.printWelcomePrompt();window.BX.debugEnable(true)}const xe=2;const Te=1e3;var Ee=babelHelpers.classPrivateFieldLooseKey("desktopIsActive");var Oe=babelHelpers.classPrivateFieldLooseKey("locationChangedToBx");var Ie=babelHelpers.classPrivateFieldLooseKey("enableRedirectCounter");var Ae=babelHelpers.classPrivateFieldLooseKey("prepareBxUrl");var Se=babelHelpers.classPrivateFieldLooseKey("initDesktopStatus");class Me{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}static init(){Me.getInstance()}static isDesktop(){return r.DesktopApi.isDesktop()}static isChatWindow(){return r.DesktopApi.isChatWindow()}constructor(){Object.defineProperty(this,Se,{value:Ke});Object.defineProperty(this,Ae,{value:je});Object.defineProperty(this,Ee,{writable:true,value:void 0});Object.defineProperty(this,Oe,{writable:true,value:false});Object.defineProperty(this,Ie,{writable:true,value:1});babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]();if(Me.isDesktop()&&r.DesktopApi.isChatWindow()){De.init()}}isDesktopActive(){if(Me.isDesktop()){return true}return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]}setDesktopActive(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]=e}isLocationChangedToBx(){return babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]}redirectToChat(e=""){a.Logger.warn("Desktop: redirectToChat",e);this.openBxLink(`bx://${c.DesktopBxLink.chat}/dialogId/${e}`);return Promise.resolve()}redirectToLines(e=""){a.Logger.warn("Desktop: redirectToLines",e);this.openBxLink(`bx://${c.DesktopBxLink.lines}/dialogId/${e}`);return Promise.resolve()}redirectToNotifications(){a.Logger.warn("Desktop: redirectToNotifications");this.openBxLink(`bx://${c.DesktopBxLink.notifications}`);return Promise.resolve()}redirectToRecentSearch(){a.Logger.warn("Desktop: redirectToRecentSearch");this.openBxLink(`bx://${c.DesktopBxLink.recentSearch}`);return Promise.resolve()}redirectToConference(e){a.Logger.warn("Desktop: redirectToConference",e);this.openBxLink(`bx://${c.DesktopBxLink.conference}/code/${e}`);return Promise.resolve()}openConference(e){a.Logger.warn("Desktop: openConference",e);const t=L.openConference(e);if(!t){return Promise.resolve(false)}return Promise.resolve(true)}toggleConference(){a.Logger.warn("Desktop: toggleConference");L.toggleConference()}redirectToVideoCall(e="",t=true){a.Logger.warn("Desktop: redirectToVideoCall",e,t);const s=t?"Y":"N";this.openBxLink(`bx://${c.DesktopBxLink.call}/dialogId/${e}/withVideo/${s}`);return Promise.resolve()}redirectToPhoneCall(e,t){a.Logger.warn("Desktop: redirectToPhoneCall",e,t);const s=k.encodeParamsJson(t);this.openBxLink(`bx://${c.DesktopBxLink.phone}/number/${e}/phoneParams/${s}`);return Promise.resolve()}redirectToCallList(e,t){a.Logger.warn("Desktop: redirectToCallList",e,t);const s=k.encodeParamsJson(t);this.openBxLink(`bx://${c.DesktopBxLink.callList}/callListId/${e}/callListParams/${s}`);return Promise.resolve()}checkStatusInDifferentContext(){if(!babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]){return Promise.resolve(false)}if(r.DesktopApi.isChatWindow()){return Promise.resolve(false)}return new Promise((e=>{h.testImageUpload((()=>{e(true)}),(()=>{e(false)}))}))}checkForRedirect(){if(!this.isRedirectEnabled()||!this.isRedirectOptionEnabled()){return Promise.resolve(false)}return this.checkStatusInDifferentContext()}isRedirectEnabled(){return babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]>0}enableRedirect(){babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]++}disableRedirect(){babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]--}isRedirectOptionEnabled(){if(r.DesktopApi.isDesktop()&&!r.DesktopApi.isChatWindow()){return true}return n.Core.getStore().getters["application/settings/get"](c.Settings.desktop.enableRedirect)}openBxLink(e){const t=babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae](e);babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=true;setTimeout((()=>{const e=new s.BaseEvent({compatData:[]});s.EventEmitter.emit(window,"BXLinkOpened",e);babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=false}),Te);location.href=t}}function je(e){if(/^bx:\/\/v(\d)\//.test(e)){return e}return e.replace("bx://",`bx://v${xe}/${location.hostname}/`)}function Ke(){const e=i.Extension.getSettings("im.v2.lib.desktop");this.setDesktopActive(e.get("desktopIsActive"))}e.DesktopManager=Me})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const);
//# sourceMappingURL=desktop-manager.bundle.map.js