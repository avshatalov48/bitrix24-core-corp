this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,s,i,o,r,n,a,l,c,d){"use strict";const p="http://127.0.0.1:20141";const b=500;const v="bx-im-messenger__out-of-view";const u="//www.bitrixsoft.com/200.ok";const h={};const f={testImageLoad(e,t){const s=Date.now();let i=false;const o=a.Dom.create({tag:"img",attrs:{src:`${p}/icon.png?${s}`,"data-id":s},props:{className:v},events:{error:function(){if(i){return}const e=this.dataset.id;t(false,e);clearTimeout(h[e]);a.Dom.remove(this)},load:function(){const t=this.dataset.id;e(true,t);clearTimeout(h[t]);a.Dom.remove(this)}}});document.body.append(o);h[s]=setTimeout((()=>{i=true;t(false,s);a.Dom.remove(o)}),b)},testInternetConnection(){const e=Date.now();return new Promise((t=>{fetch(`${u}.${e}`).then((e=>{if(e.status===200){return t(true)}t(false)})).catch((()=>{t(false)}))}))}};let g=[];let L=0;const k={openConference(e){if(!c.Utils.conference.isValidCode(e)){return false}if(!d.DesktopApi.isDesktop()){return false}let t=null;const s=[{width:2560,height:1440},{width:2048,height:1152},{width:1920,height:1080},{width:1600,height:900},{width:1366,height:768},{width:1024,height:576}];for(const e of s){t=e;if(screen.width>e.width&&screen.height>e.height){break}}g=g.filter((e=>Boolean(d.DesktopApi.findWindow(e))));g.push(c.Utils.conference.getWindowNameByCode(e));d.DesktopApi.createWindow(c.Utils.conference.getWindowNameByCode(e),(s=>{s.SetProperty("title",a.Loc.getMessage("IM_LIB_DESKTOP_CONFERENCE_TITLE"));s.SetProperty("clientSize",{Width:t.width,Height:t.height});s.ExecuteCommand("center");s.SetProperty("minClientSize",{Width:940,Height:400});s.SetProperty("backgroundColor","#2B3038");s.ExecuteCommand("html.load",`<script>location.href="/desktop_app/router.php?alias=${e}&videoconf";<\/script>`);s.ExecuteCommand("show");s.ExecuteCommand("center")}));return true},toggleConference(){if(L>g.length-1){L=0;d.DesktopApi.showWindow();return true}g=g.filter((e=>Boolean(d.DesktopApi.findWindow(e))));for(let e=L;e<g.length;e++){L++;const t=d.DesktopApi.findWindow(g[e]);if(t){d.DesktopApi.activateWindow(t);break}}return true}};const P=60*60*1e3;var B=babelHelpers.classPrivateFieldLooseKey("initDate");var y=babelHelpers.classPrivateFieldLooseKey("sidePanelManager");var D=babelHelpers.classPrivateFieldLooseKey("startReloadCheck");var C=babelHelpers.classPrivateFieldLooseKey("isReloadNeeded");var m=babelHelpers.classPrivateFieldLooseKey("reloadWindow");class w{static init(){return new w}constructor(){Object.defineProperty(this,m,{value:x});Object.defineProperty(this,C,{value:H});Object.defineProperty(this,D,{value:F});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:BX.SidePanel.Instance});babelHelpers.classPrivateFieldLooseBase(this,B)[B]=new Date;babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}}function F(){setInterval((async()=>{const e=await babelHelpers.classPrivateFieldLooseBase(this,C)[C]();if(e){babelHelpers.classPrivateFieldLooseBase(this,m)[m]()}}),P)}async function H(){if(c.Utils.date.isSameDay(new Date,babelHelpers.classPrivateFieldLooseBase(this,B)[B])){return false}if(babelHelpers.classPrivateFieldLooseBase(this,y)[y].opened){l.Logger.desktop("Checker: checkDayForReload, slider is open - delay reload");return false}if(i.CallManager.getInstance().hasCurrentCall()){l.Logger.desktop("Checker: checkDayForReload, call is active - delay reload");return false}return f.testInternetConnection()}function x(){l.Logger.desktop("Checker: checkDayForReload, new day - reload window");d.DesktopApi.reloadWindow()}const T="!!";const E={encodeParams(e){if(!a.Type.isPlainObject(e)){return""}let t="";Object.entries(e).forEach((([e,s])=>{const i="";t+=`${i}${e}${T}${s}`}));return t},decodeParams(e){const t={};if(!a.Type.isStringFilled(e)){return t}const s=e.split(T);for(let e=0;e<s.length;e+=2){const i=s[e];const o=s[e+1];t[i]=o}return t},encodeParamsJson(e){if(!a.Type.isPlainObject(e)){return"{}"}let t="";try{t=encodeURIComponent(JSON.stringify(e))}catch(e){console.error("DesktopUtils: could not encode params.",e);t="{}"}return t},decodeParamsJson(e){let t={};if(!a.Type.isStringFilled(e)){return t}try{t=JSON.parse(decodeURIComponent(e))}catch(e){console.error("DesktopUtils: could not decode encoded params.",e)}return t}};var S=babelHelpers.classPrivateFieldLooseKey("subscribeToBxProtocolEvent");var A=babelHelpers.classPrivateFieldLooseKey("subscribeToLegacyBxProtocolEvent");class O{static init(){return new O}constructor(){Object.defineProperty(this,A,{value:M});Object.defineProperty(this,S,{value:I});babelHelpers.classPrivateFieldLooseBase(this,S)[S]();babelHelpers.classPrivateFieldLooseBase(this,A)[A]()}}function I(){d.DesktopApi.subscribe(r.EventType.desktop.onBxLink,((e,s)=>{const i=s!=null?s:{};Object.entries(i).forEach((([e,t])=>{i[e]=decodeURIComponent(t)}));d.DesktopApi.activateWindow();if(e===r.DesktopBxLink.chat){void t.Messenger.openChat(i.dialogId)}else if(e===r.DesktopBxLink.lines){void t.Messenger.openLines(i.dialogId)}else if(e===r.DesktopBxLink.conference){void Re.getInstance().openConference(i.code)}else if(e===r.DesktopBxLink.call){const e=i.withVideo!=="N";void t.Messenger.startVideoCall(i.dialogId,e)}else if(e===r.DesktopBxLink.phone){const e=E.decodeParamsJson(i.phoneParams);void t.Messenger.startPhoneCall(i.number,e)}else if(e===r.DesktopBxLink.callList){const e=E.decodeParamsJson(i.callListParams);void t.Messenger.startCallList(i.callListId,e)}else if(e===r.DesktopBxLink.notifications){void t.Messenger.openNotifications()}else if(e===r.DesktopBxLink.recentSearch){void t.Messenger.openRecentSearch()}else if(e===r.DesktopBxLink.copilot){void t.Messenger.openCopilot(i.dialogId)}else if(e===r.DesktopBxLink.settings){void t.Messenger.openSettings({onlyPanel:i.section})}else if(e===r.DesktopBxLink.timeManager){var o,n;(o=BX.Timeman)==null?void 0:(n=o.Monitor)==null?void 0:n.openReport()}else if(e===r.DesktopBxLink.openTab){d.DesktopApi.setActiveTab()}}))}function M(){d.DesktopApi.subscribe(r.EventType.desktop.onBxLink,((e,s)=>{const i=s!=null?s:{};Object.entries(i).forEach((([e,t])=>{i[e]=decodeURIComponent(t)}));d.DesktopApi.activateWindow();if(e===r.LegacyDesktopBxLink.messenger){if(i.dialog){void t.Messenger.openChat(i.dialog)}else if(i.chat){void t.Messenger.openChat(`chat${i.chat}`)}else{void t.Messenger.openChat()}}else if(e===r.LegacyDesktopBxLink.chat&&i.id){void t.Messenger.openChat(`chat${i.id}`)}else if(e===r.LegacyDesktopBxLink.notify){void t.Messenger.openNotifications()}else if(e===r.LegacyDesktopBxLink.callTo){if(i.video){void t.Messenger.startVideoCall(i.video)}else if(i.audio){void t.Messenger.startVideoCall(i.audio,false)}else if(i.phone){void t.Messenger.startPhoneCall(i.phone)}}else if(e===r.LegacyDesktopBxLink.callList){void t.Messenger.openRecentSearch()}}))}var j=babelHelpers.classPrivateFieldLooseKey("subscribeToLogoutEvent");var K=babelHelpers.classPrivateFieldLooseKey("onExit");class ${static init(){return new $}constructor(){Object.defineProperty(this,K,{value:W});Object.defineProperty(this,j,{value:U});babelHelpers.classPrivateFieldLooseBase(this,j)[j]()}}function U(){d.DesktopApi.subscribe(r.EventType.desktop.onExit,babelHelpers.classPrivateFieldLooseBase(this,K)[K].bind(this))}function W(){s.runAction(r.RestMethod.imV2DesktopLogout).finally((()=>{d.DesktopApi.shutdown()}))}var R=babelHelpers.classPrivateFieldLooseKey("initDate");var X=babelHelpers.classPrivateFieldLooseKey("wakeUpTimer");var N=babelHelpers.classPrivateFieldLooseKey("subscribeToWakeUpEvent");var V=babelHelpers.classPrivateFieldLooseKey("onWakeUp");var J=babelHelpers.classPrivateFieldLooseKey("subscribeToIconClickEvent");var _=babelHelpers.classPrivateFieldLooseKey("onIconClick");var z=babelHelpers.classPrivateFieldLooseKey("subscribeToAwayEvent");var q=babelHelpers.classPrivateFieldLooseKey("onUserAway");var Y=babelHelpers.classPrivateFieldLooseKey("subscribeToFocusEvent");var G=babelHelpers.classPrivateFieldLooseKey("subscribeToBlurEvent");var Q=babelHelpers.classPrivateFieldLooseKey("removeNativeNotifications");var Z=babelHelpers.classPrivateFieldLooseKey("setInitialStatus");var ee=babelHelpers.classPrivateFieldLooseKey("subscribeToStatusChange");class te{static init(){return new te}constructor(){Object.defineProperty(this,ee,{value:be});Object.defineProperty(this,Z,{value:pe});Object.defineProperty(this,Q,{value:de});Object.defineProperty(this,G,{value:ce});Object.defineProperty(this,Y,{value:le});Object.defineProperty(this,q,{value:ae});Object.defineProperty(this,z,{value:ne});Object.defineProperty(this,_,{value:re});Object.defineProperty(this,J,{value:oe});Object.defineProperty(this,V,{value:ie});Object.defineProperty(this,N,{value:se});Object.defineProperty(this,R,{writable:true,value:void 0});Object.defineProperty(this,X,{writable:true,value:null});this.sidePanelManager=BX.SidePanel.Instance;babelHelpers.classPrivateFieldLooseBase(this,R)[R]=new Date;babelHelpers.classPrivateFieldLooseBase(this,N)[N]();babelHelpers.classPrivateFieldLooseBase(this,z)[z]();babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]();babelHelpers.classPrivateFieldLooseBase(this,G)[G]();babelHelpers.classPrivateFieldLooseBase(this,J)[J]();babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]();babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]()}}function se(){d.DesktopApi.subscribe(r.EventType.desktop.onWakeUp,babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this))}async function ie(){const e=await f.testInternetConnection();if(!e){l.Logger.desktop("StatusHandler: onWakeUp event, no internet connection, delay 60 sec");clearTimeout(babelHelpers.classPrivateFieldLooseBase(this,X)[X]);babelHelpers.classPrivateFieldLooseBase(this,X)[X]=setTimeout(babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this),60*1e3);return}if(c.Utils.date.isSameHour(new Date,babelHelpers.classPrivateFieldLooseBase(this,R)[R])){l.Logger.desktop("StatusHandler: onWakeUp event, same hour - restart pull client");o.Core.getPullClient().restart()}else{if(this.sidePanelManager.opened){clearTimeout(babelHelpers.classPrivateFieldLooseBase(this,X)[X]);babelHelpers.classPrivateFieldLooseBase(this,X)[X]=setTimeout(babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this),60*1e3);l.Logger.desktop("StatusHandler: onWakeUp event, slider is open, delay 60 sec");return}l.Logger.desktop("StatusHandler: onWakeUp event, reload window");d.DesktopApi.reloadWindow()}}function oe(){d.DesktopApi.subscribe(r.EventType.desktop.onIconClick,babelHelpers.classPrivateFieldLooseBase(this,_)[_].bind(this))}function re(){Re.getInstance().toggleConference()}function ne(){d.DesktopApi.subscribe(r.EventType.desktop.onUserAway,babelHelpers.classPrivateFieldLooseBase(this,q)[q].bind(this))}function ae(e){const t=e?r.RestMethod.imUserStatusIdleStart:r.RestMethod.imUserStatusIdleEnd;o.Core.getRestClient().callMethod(t).catch((e=>{console.error(`Desktop: error in ${t}  - ${e}`)}))}function le(){a.Event.bind(window,"focus",babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].bind(this))}function ce(){a.Event.bind(window,"blur",babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].bind(this))}function de(){if(!a.Browser.isWin()||!d.DesktopApi.isChatWindow()){return}d.DesktopApi.removeNativeNotifications()}function pe(){const e=o.Core.getStore().getters["application/settings/get"](r.Settings.user.status);d.DesktopApi.setIconStatus(e)}function be(){const e=(e,t)=>t["application/settings/get"](r.Settings.user.status);o.Core.getStore().watch(e,(e=>{d.DesktopApi.setIconStatus(e)}))}var ve=babelHelpers.classPrivateFieldLooseKey("store");var ue=babelHelpers.classPrivateFieldLooseKey("subscribeToCountersChange");var he=babelHelpers.classPrivateFieldLooseKey("onCounterChange");class fe{static init(){return new fe}constructor(){Object.defineProperty(this,he,{value:Le});Object.defineProperty(this,ue,{value:ge});Object.defineProperty(this,ve,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]=o.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]()}}function ge(){n.EventEmitter.subscribe(r.EventType.counter.onNotificationCounterChange,babelHelpers.classPrivateFieldLooseBase(this,he)[he].bind(this));n.EventEmitter.subscribe(r.EventType.counter.onChatCounterChange,babelHelpers.classPrivateFieldLooseBase(this,he)[he].bind(this))}function Le(){const e=babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].getters["counters/getTotalChatCounter"];const t=babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].getters["notifications/getCounter"];const s=e>0;d.DesktopApi.setCounter(e+t,s)}var ke=babelHelpers.classPrivateFieldLooseKey("bindHotkeys");class Pe{static init(){return new Pe}constructor(){Object.defineProperty(this,ke,{value:Be});babelHelpers.classPrivateFieldLooseBase(this,ke)[ke]()}}function Be(){a.Event.bind(window,"keydown",(e=>{const t=c.Utils.key.isCombination(e,"Ctrl+R");if(t){d.DesktopApi.reloadWindow();l.Logger.desktop("NOTICE: User reload window (hotkey)");return}const s=c.Utils.key.isCombination(e,"Ctrl+Shift+L");if(s){d.DesktopApi.openLogsFolder();l.Logger.desktop("NOTICE: User open log folder (hotkey)");return}const i=c.Utils.key.isCombination(e,"Ctrl+Shift+D");if(i){d.DesktopApi.openDeveloperTools();l.Logger.desktop("NOTICE: User open developer tools (hotkey)")}}))}var ye=babelHelpers.classPrivateFieldLooseKey("sendInitEvent");var De=babelHelpers.classPrivateFieldLooseKey("initSliderBindings");var Ce=babelHelpers.classPrivateFieldLooseKey("getSliderBindingsStatus");var me=babelHelpers.classPrivateFieldLooseKey("initComplete");var we=babelHelpers.classPrivateFieldLooseKey("subscribeOnErrorEvent");var Fe=babelHelpers.classPrivateFieldLooseKey("handleInvalidAuthError");class He{static init(){return new He}constructor(){Object.defineProperty(this,Fe,{value:Oe});Object.defineProperty(this,we,{value:Ae});Object.defineProperty(this,me,{value:Se});Object.defineProperty(this,Ce,{value:Ee});Object.defineProperty(this,De,{value:Te});Object.defineProperty(this,ye,{value:xe});w.init();te.init();$.init();O.init();fe.init();Pe.init();babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]();babelHelpers.classPrivateFieldLooseBase(this,we)[we]();babelHelpers.classPrivateFieldLooseBase(this,De)[De]();babelHelpers.classPrivateFieldLooseBase(this,me)[me]()}}function xe(){const{currentUser:e}=o.Core.getApplicationData();d.DesktopApi.emit(r.EventType.desktop.onInit,[{userInfo:e!=null?e:{}}])}function Te(){const e=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]();if(e){BX.SidePanel.Instance.enableAnchorBinding();return}BX.SidePanel.Instance.disableAnchorBinding()}function Ee(){const e=d.DesktopApi.getCustomSetting(d.DesktopSettingsKey.sliderBindingsStatus,"1");return e==="1"}function Se(){d.DesktopApi.setLogInfo=function(...e){l.Logger.desktop(...e)};window.BX.debugEnable(true);d.DesktopApi.printWelcomePrompt()}function Ae(){n.EventEmitter.subscribe(r.EventType.request.onAuthError,(()=>babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]()))}function Oe(){return d.DesktopApi.login()}const Ie=2;const Me=1e3;var je=babelHelpers.classPrivateFieldLooseKey("desktopIsActive");var Ke=babelHelpers.classPrivateFieldLooseKey("locationChangedToBx");var $e=babelHelpers.classPrivateFieldLooseKey("enableRedirectCounter");var Ue=babelHelpers.classPrivateFieldLooseKey("prepareBxUrl");var We=babelHelpers.classPrivateFieldLooseKey("initDesktopStatus");class Re{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}static init(){Re.getInstance()}static isDesktop(){return d.DesktopApi.isDesktop()}static isChatWindow(){return d.DesktopApi.isChatWindow()}constructor(){Object.defineProperty(this,We,{value:Ne});Object.defineProperty(this,Ue,{value:Xe});Object.defineProperty(this,je,{writable:true,value:void 0});Object.defineProperty(this,Ke,{writable:true,value:false});Object.defineProperty(this,$e,{writable:true,value:1});babelHelpers.classPrivateFieldLooseBase(this,We)[We]();if(Re.isDesktop()&&d.DesktopApi.isChatWindow()){He.init()}}isDesktopActive(){if(Re.isDesktop()){return true}return babelHelpers.classPrivateFieldLooseBase(this,je)[je]}setDesktopActive(e){babelHelpers.classPrivateFieldLooseBase(this,je)[je]=e}isLocationChangedToBx(){return babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]}redirectToChat(e=""){l.Logger.warn("Desktop: redirectToChat",e);this.openBxLink(`bx://${r.DesktopBxLink.chat}/dialogId/${e}`);return Promise.resolve()}redirectToLines(e=""){l.Logger.warn("Desktop: redirectToLines",e);this.openBxLink(`bx://${r.DesktopBxLink.lines}/dialogId/${e}`);return Promise.resolve()}redirectToCopilot(e=""){l.Logger.warn("Desktop: redirectToCopilot",e);this.openBxLink(`bx://${r.DesktopBxLink.copilot}/dialogId/${e}`);return Promise.resolve()}redirectToNotifications(){l.Logger.warn("Desktop: redirectToNotifications");this.openBxLink(`bx://${r.DesktopBxLink.notifications}`);return Promise.resolve()}redirectToRecentSearch(){l.Logger.warn("Desktop: redirectToRecentSearch");this.openBxLink(`bx://${r.DesktopBxLink.recentSearch}`);return Promise.resolve()}redirectToConference(e){l.Logger.warn("Desktop: redirectToConference",e);this.openBxLink(`bx://${r.DesktopBxLink.conference}/code/${e}`);return Promise.resolve()}redirectToSettings(e){l.Logger.warn("Desktop: redirectToSettings",e);this.openBxLink(`bx://${r.DesktopBxLink.settings}/section/${e}`);return Promise.resolve()}openConference(e){l.Logger.warn("Desktop: openConference",e);const t=k.openConference(e);if(!t){return Promise.resolve(false)}return Promise.resolve(true)}toggleConference(){l.Logger.warn("Desktop: toggleConference");k.toggleConference()}redirectToVideoCall(e="",t=true){l.Logger.warn("Desktop: redirectToVideoCall",e,t);const s=t?"Y":"N";this.openBxLink(`bx://${r.DesktopBxLink.call}/dialogId/${e}/withVideo/${s}`);return Promise.resolve()}redirectToPhoneCall(e,t){l.Logger.warn("Desktop: redirectToPhoneCall",e,t);const s=E.encodeParamsJson(t);this.openBxLink(`bx://${r.DesktopBxLink.phone}/number/${e}/phoneParams/${s}`);return Promise.resolve()}redirectToCallList(e,t){l.Logger.warn("Desktop: redirectToCallList",e,t);const s=E.encodeParamsJson(t);this.openBxLink(`bx://${r.DesktopBxLink.callList}/callListId/${e}/callListParams/${s}`);return Promise.resolve()}openAccountTab(e){this.openBxLink(`bx://v2/${e}/openTab`)}checkStatusInDifferentContext(){if(!babelHelpers.classPrivateFieldLooseBase(this,je)[je]){return Promise.resolve(false)}if(d.DesktopApi.isChatWindow()){return Promise.resolve(false)}return new Promise((e=>{f.testImageLoad((()=>{e(true)}),(()=>{e(false)}))}))}checkForRedirect(){if(!this.isRedirectEnabled()||!this.isRedirectOptionEnabled()){return Promise.resolve(false)}return this.checkStatusInDifferentContext()}isRedirectEnabled(){return babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]>0}enableRedirect(){babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]++}disableRedirect(){babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]--}isRedirectOptionEnabled(){if(d.DesktopApi.isDesktop()&&!d.DesktopApi.isChatWindow()){return true}return o.Core.getStore().getters["application/settings/get"](r.Settings.desktop.enableRedirect)}openBxLink(e){const t=babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue](e);babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=true;setTimeout((()=>{const e=new n.BaseEvent({compatData:[]});n.EventEmitter.emit(window,"BXLinkOpened",e);babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=false}),Me);location.href=t}}function Xe(e){if(/^bx:\/\/v(\d)\//.test(e)){return e}return e.replace("bx://",`bx://v${Ie}/${location.hostname}/`)}function Ne(){const e=a.Extension.getSettings("im.v2.lib.desktop");this.setDesktopActive(e.get("desktopIsActive"))}e.DesktopManager=Re})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Event,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=desktop-manager.bundle.map.js