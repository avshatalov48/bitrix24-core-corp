this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,i,o,r,a,n,l,c,b){"use strict";const p="http://127.0.0.1:20141";const d=500;const v="bx-im-messenger__out-of-view";const u="//www.bitrixsoft.com/200.ok";const h={};const f={testImageUpload(e,s){const t=Date.now();let i=false;const o=l.Dom.create({tag:"img",attrs:{src:`${p}/icon.png?${t}`,"data-id":t},props:{className:v},events:{error:function(){if(i){return}const e=this.dataset.id;s(false,e);clearTimeout(h[e]);l.Dom.remove(this)},load:function(){const s=this.dataset.id;e(true,s);clearTimeout(h[s]);l.Dom.remove(this)}}});document.body.append(o);h[t]=setTimeout((()=>{i=true;s(false,t);l.Dom.remove(o)}),d)},testInternetConnection(){const e=Date.now();return new Promise((s=>{fetch(`${u}.${e}`).then((e=>{if(e.status===200){return s(true)}s(false)})).catch((()=>{s(false)}))}))}};var P=babelHelpers.classPrivateFieldLooseKey("subscribeToBxProtocolEvent");class L{static init(){return new L}constructor(){Object.defineProperty(this,P,{value:k});babelHelpers.classPrivateFieldLooseBase(this,P)[P]()}}function k(){b.DesktopApi.subscribe(a.EventType.desktop.onBxLink,((e,s)=>{const o=s!=null?s:{};Object.entries(o).forEach((([e,s])=>{o[e]=decodeURIComponent(s)}));b.DesktopApi.showWindow();if(e===a.DesktopBxLink.chat){i.Messenger.openChat(o.dialogId)}else if(e===a.DesktopBxLink.call){i.Messenger.startVideoCall(o.dialogId)}else if(e===a.DesktopBxLink.notifications){i.Messenger.openNotifications()}else if(e===a.DesktopBxLink.recentSearch){i.Messenger.openRecentSearch()}else if(e===a.DesktopBxLink.timeManager){b.DesktopApi.showWindow();t.Monitor==null?void 0:t.Monitor.openReport()}}))}var g=babelHelpers.classPrivateFieldLooseKey("subscribeToLogoutEvent");var B=babelHelpers.classPrivateFieldLooseKey("onExit");class y{static init(){return new y}constructor(){Object.defineProperty(this,B,{value:H});Object.defineProperty(this,g,{value:D});babelHelpers.classPrivateFieldLooseBase(this,g)[g]()}}function D(){b.DesktopApi.subscribe(a.EventType.desktop.onExit,babelHelpers.classPrivateFieldLooseBase(this,B)[B].bind(this))}function H(){o.runAction(a.RestMethod.imV2DesktopLogout).finally((()=>{b.DesktopApi.exit()}))}var F=babelHelpers.classPrivateFieldLooseKey("initDate");var w=babelHelpers.classPrivateFieldLooseKey("subscribeToWakeUpEvent");var m=babelHelpers.classPrivateFieldLooseKey("onWakeUp");var C=babelHelpers.classPrivateFieldLooseKey("subscribeToAwayEvent");var x=babelHelpers.classPrivateFieldLooseKey("onUserAway");var E=babelHelpers.classPrivateFieldLooseKey("setInitialStatus");var A=babelHelpers.classPrivateFieldLooseKey("subscribeToStatusChange");class I{static init(){return new I}constructor(){Object.defineProperty(this,A,{value:S});Object.defineProperty(this,E,{value:K});Object.defineProperty(this,x,{value:j});Object.defineProperty(this,C,{value:T});Object.defineProperty(this,m,{value:O});Object.defineProperty(this,w,{value:M});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=new Date;babelHelpers.classPrivateFieldLooseBase(this,w)[w]();babelHelpers.classPrivateFieldLooseBase(this,C)[C]();babelHelpers.classPrivateFieldLooseBase(this,E)[E]();babelHelpers.classPrivateFieldLooseBase(this,A)[A]()}}function M(){b.DesktopApi.subscribe(a.EventType.desktop.onWakeUp,babelHelpers.classPrivateFieldLooseBase(this,m)[m].bind(this))}async function O(){const e=await f.testInternetConnection();if(!e){console.error("NO INTERNET CONNECTION!");return}if(c.Utils.date.isSameDay(new Date,babelHelpers.classPrivateFieldLooseBase(this,F)[F])){r.Core.getPullClient().restart()}else{b.DesktopApi.reloadWindow()}}function T(){b.DesktopApi.subscribe(a.EventType.desktop.onUserAway,babelHelpers.classPrivateFieldLooseBase(this,x)[x].bind(this))}function j(e){const s=e?a.RestMethod.imUserStatusIdleStart:a.RestMethod.imUserStatusIdleEnd;r.Core.getRestClient().callMethod(s).catch((e=>{console.error(`Desktop: error in ${s}  - ${e}`)}))}function K(){const e=r.Core.getUserId();const s=r.Core.getStore().getters["users/get"](e);if(!s){return}b.DesktopApi.setIconStatus(s.status)}function S(){const e=(e,s)=>{const t=r.Core.getUserId();const i=s["users/get"](t);return i==null?void 0:i.status};r.Core.getStore().watch(e,(e=>{b.DesktopApi.setIconStatus(e)}))}var X=babelHelpers.classPrivateFieldLooseKey("store");var U=babelHelpers.classPrivateFieldLooseKey("subscribeToCountersChange");var $=babelHelpers.classPrivateFieldLooseKey("onCounterChange");class N{static init(){return new N}constructor(){Object.defineProperty(this,$,{value:W});Object.defineProperty(this,U,{value:R});Object.defineProperty(this,X,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,X)[X]=r.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,U)[U]()}}function R(){n.EventEmitter.subscribe(a.EventType.counter.onNotificationCounterChange,babelHelpers.classPrivateFieldLooseBase(this,$)[$].bind(this));n.EventEmitter.subscribe(a.EventType.counter.onChatCounterChange,babelHelpers.classPrivateFieldLooseBase(this,$)[$].bind(this))}function W(){const e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].getters["recent/getTotalCounter"];const s=babelHelpers.classPrivateFieldLooseBase(this,X)[X].getters["notifications/getCounter"];const t=e>0;b.DesktopApi.setCounter(e+s,t)}var V=babelHelpers.classPrivateFieldLooseKey("bindHotkeys");class _{static init(){return new _}constructor(){Object.defineProperty(this,V,{value:q});babelHelpers.classPrivateFieldLooseBase(this,V)[V]()}}function q(){l.Event.bind(window,"keydown",(e=>{const s=c.Utils.key.isCombination(e,"Ctrl+R");if(s){b.DesktopApi.reloadWindow()}}))}var z=babelHelpers.classPrivateFieldLooseKey("sendInitEvent");class G{static init(){return new G}constructor(){Object.defineProperty(this,z,{value:J});I.init();y.init();L.init();N.init();_.init();babelHelpers.classPrivateFieldLooseBase(this,z)[z]()}}function J(){const{currentUser:e}=r.Core.getApplicationData();b.DesktopApi.emit(a.EventType.desktop.onInit,[{userInfo:e!=null?e:{}}])}const Q=2;const Y=1e3;var Z=babelHelpers.classPrivateFieldLooseKey("desktopIsActive");var ee=babelHelpers.classPrivateFieldLooseKey("locationChangedToBx");var se=babelHelpers.classPrivateFieldLooseKey("goToBx");var te=babelHelpers.classPrivateFieldLooseKey("prepareBxUrl");var ie=babelHelpers.classPrivateFieldLooseKey("initDesktopStatus");class oe{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}static init(){oe.getInstance()}static isDesktop(){return b.DesktopApi.isDesktop()}static isChatWindow(){return b.DesktopApi.isChatWindow()}constructor(){Object.defineProperty(this,ie,{value:ne});Object.defineProperty(this,te,{value:ae});Object.defineProperty(this,se,{value:re});Object.defineProperty(this,Z,{writable:true,value:void 0});Object.defineProperty(this,ee,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]();if(oe.isDesktop()&&b.DesktopApi.isChatWindow()){G.init()}}isDesktopActive(){if(oe.isDesktop()){return true}return babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]}setDesktopActive(e){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=e}isLocationChangedToBx(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]}openChat(e=""){s.Logger.warn("Desktop: openChat",e);babelHelpers.classPrivateFieldLooseBase(this,se)[se](`bx://${a.DesktopBxLink.chat}/dialogId/${e}`);return Promise.resolve()}openNotifications(){s.Logger.warn("Desktop: openNotifications");babelHelpers.classPrivateFieldLooseBase(this,se)[se](`bx://${a.DesktopBxLink.notifications}`);return Promise.resolve()}openRecentSearch(){s.Logger.warn("Desktop: openRecentSearch");babelHelpers.classPrivateFieldLooseBase(this,se)[se](`bx://${a.DesktopBxLink.recentSearch}`);return Promise.resolve()}startVideoCall(e="",t=true){s.Logger.warn("Desktop: startVideoCall",e,t);babelHelpers.classPrivateFieldLooseBase(this,se)[se](`bx://${a.DesktopBxLink.call}/dialogId/${e}`);return Promise.resolve()}checkStatusInDifferentContext(){if(!babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]){return Promise.resolve(false)}if(oe.isDesktop()&&b.DesktopApi.isChatWindow()){return Promise.resolve(false)}return new Promise((e=>{f.testImageUpload((()=>{e(true)}),(()=>{e(false)}))}))}}function re(e){const s=babelHelpers.classPrivateFieldLooseBase(this,te)[te](e);babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=true;setTimeout((()=>{const e=new n.BaseEvent({compatData:[]});n.EventEmitter.emit(window,"BXLinkOpened",e);babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=false}),Y);location.href=s}function ae(e){if(/^bx:\/\/v(\d)\//.test(e)){return e}return e.replace("bx://",`bx://v${Q}/${location.hostname}/`)}function ne(){const e=l.Extension.getSettings("im.v2.lib.desktop");this.setDesktopActive(e.get("desktopIsActive"))}e.DesktopManager=oe})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Timeman,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Event,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=desktop-manager.bundle.map.js