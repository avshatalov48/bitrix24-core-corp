{"version":3,"file":"entity-creator.bundle.js","sources":["../src/entity-creator.js"],"sourcesContent":["import { ajax as Ajax } from \"main.core\";\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Picker } from 'ai.picker';\nimport 'calendar.sliderloader';\n\nimport { runAction } from 'im.v2.lib.rest';\nimport { Core } from 'im.v2.application.core';\nimport { EventType, RestMethod } from 'im.v2.const';\n\nimport type { RestClient } from 'rest.client';\n\nconst CALENDAR_ON_ENTRY_SAVE_EVENT = 'BX.Calendar:onEntrySave';\n\nexport class EntityCreator\n{\n\t#chatId: number = 0;\n\t#restClient: RestClient;\n\n\t#onCalendarEntrySaveHandler: ?Function;\n\n\tconstructor(chatId: number)\n\t{\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#chatId = chatId;\n\t}\n\n\tcreateAiTextForChat(startMessage): void\n\t{\n\t\tthis.#createAiText(startMessage);\n\t}\n\n\tcreateTaskForChat(): Promise\n\t{\n\t\treturn this.#createTask();\n\t}\n\n\tcreateTaskForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createTask(messageId);\n\t}\n\n\tcreateMeetingForChat(): Promise\n\t{\n\t\treturn this.#createMeeting();\n\t}\n\n\tcreateMeetingForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createMeeting(messageId);\n\t}\n\n\t#createMeeting(messageId?: number): Promise\n\t{\n\t\tconst queryParams = { CHAT_ID: this.#chatId };\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams.MESSAGE_ID = messageId;\n\t\t}\n\n\t\treturn this.#requestPreparedParams(RestMethod.imChatCalendarPrepare, queryParams).then((sliderParams) => {\n\t\t\tconst { params } = sliderParams;\n\n\t\t\tthis.#onCalendarEntrySaveHandler = this.#onCalendarEntrySave.bind(this, params.sliderId, messageId);\n\t\t\tEventEmitter.subscribeOnce(CALENDAR_ON_ENTRY_SAVE_EVENT, this.#onCalendarEntrySaveHandler);\n\n\t\t\treturn this.#openCalendarSlider(params);\n\t\t});\n\t}\n\n\t#createAiText(startMessage: ''): Promise\n\t{\n\t\tconst picker = new Picker({\n\t\t\tstartMessage,\n\t\t\tmoduleId: 'im',\n\t\t\tcontextId: 'im_menu_plus',\n\t\t\thistory: true,\n\t\t\tonSelect: (item) => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.insertText, {\n\t\t\t\t\ttext: item.data,\n\t\t\t\t\treplace: true,\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t\tpicker\n\t\t\t.setLangSpace(Picker.LangSpace.text)\n\t\t\t.text()\n\t\t;\n\t}\n\n\t#createTask(messageId?: number): Promise\n\t{\n\t\tconst config = {\n\t\t\tdata: { chatId: this.#chatId },\n\t\t};\n\t\tif (messageId)\n\t\t{\n\t\t\tconfig.data.messageId = messageId;\n\t\t}\n\n\t\treturn runAction(RestMethod.imV2ChatTaskPrepare, config).then((sliderParams) => {\n\t\t\tconst { link, params } = sliderParams;\n\n\t\t\treturn this.#openTaskSlider(link, params);\n\t\t});\n\t}\n\n\t#requestPreparedParams(requestMethod: string, query: Object): Promise\n\t{\n\t\treturn this.#restClient.callMethod(requestMethod, query).then((result) => {\n\t\t\treturn result.data();\n\t\t}).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n\n\t#openTaskSlider(sliderUri: string, sliderParams: Object)\n\t{\n\t\tBX.SidePanel.Instance.open(sliderUri, {\n\t\t\trequestMethod: 'post',\n\t\t\trequestParams: sliderParams,\n\t\t\tcacheable: false,\n\t\t});\n\t}\n\n\t#openCalendarSlider(sliderParams: Object)\n\t{\n\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(0, sliderParams).show();\n\t}\n\n\t#onCalendarEntrySave(sliderId: string, messageId: ?number, event: BaseEvent)\n\t{\n\t\tconst eventData = event.getData();\n\t\tif (eventData.sliderId !== sliderId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst queryParams = {\n\t\t\tCALENDAR_ID: eventData.responseData.entryId,\n\t\t\tCHAT_ID: this.#chatId,\n\t\t};\n\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams.MESSAGE_ID = messageId;\n\t\t}\n\n\t\treturn this.#restClient.callMethod(RestMethod.imChatCalendarAdd, queryParams).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n}\n"],"names":["CALENDAR_ON_ENTRY_SAVE_EVENT","EntityCreator","constructor","chatId","Core","getRestClient","createAiTextForChat","startMessage","createTaskForChat","createTaskForMessage","messageId","createMeetingForChat","createMeetingForMessage","queryParams","CHAT_ID","MESSAGE_ID","RestMethod","imChatCalendarPrepare","then","sliderParams","params","bind","sliderId","EventEmitter","subscribeOnce","picker","Picker","moduleId","contextId","history","onSelect","item","emit","EventType","textarea","insertText","text","data","replace","setLangSpace","LangSpace","config","runAction","imV2ChatTaskPrepare","link","requestMethod","query","callMethod","result","catch","error","console","sliderUri","BX","SidePanel","Instance","open","requestParams","cacheable","window","top","Calendar","SliderLoader","show","event","eventData","getData","CALENDAR_ID","responseData","entryId","imChatCalendarAdd"],"mappings":";;;;;;;CAWA,MAAMA,4BAA4B,GAAG,yBAAyB;CAAC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAE/D,CAAO,MAAMC,aAAa,CAC1B;GAMCC,WAAW,CAACC,MAAc,EAC1B;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA,OANkB;;KAAC;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAOlB,4CAAI,8BAAeC,2BAAI,CAACC,aAAa,EAAE;KACvC,4CAAI,sBAAWF,MAAM;;GAGtBG,mBAAmB,CAACC,YAAY,EAChC;KACC,4CAAI,gCAAeA,YAAY;;GAGhCC,iBAAiB,GACjB;KACC,+CAAO,IAAI;;GAGZC,oBAAoB,CAACC,SAAiB,EACtC;KACC,+CAAO,IAAI,4BAAaA,SAAS;;GAGlCC,oBAAoB,GACpB;KACC,+CAAO,IAAI;;GAGZC,uBAAuB,CAACF,SAAiB,EACzC;KACC,+CAAO,IAAI,kCAAgBA,SAAS;;CAuGtC;CAAC,yBApGeA,SAAkB,EACjC;GACC,MAAMG,WAAW,GAAG;KAAEC,OAAO,0CAAE,IAAI;IAAU;GAC7C,IAAIJ,SAAS,EACb;KACCG,WAAW,CAACE,UAAU,GAAGL,SAAS;;GAGnC,OAAO,4CAAI,kDAAwBM,sBAAU,CAACC,qBAAqB,EAAEJ,WAAW,EAAEK,IAAI,CAAEC,YAAY,IAAK;KACxG,MAAM;OAAEC;MAAQ,GAAGD,YAAY;KAE/B,4CAAI,8DAA+B,4CAAI,8CAAsBE,IAAI,CAAC,IAAI,EAAED,MAAM,CAACE,QAAQ,EAAEZ,SAAS,CAAC;KACnGa,6BAAY,CAACC,aAAa,CAACxB,4BAA4B,0CAAE,IAAI,4DAA6B;KAE1F,+CAAO,IAAI,4CAAqBoB,MAAM;IACtC,CAAC;CACH;CAAC,wBAEab,YAAgB,EAC9B;GACC,MAAMkB,MAAM,GAAG,IAAIC,gBAAM,CAAC;KACzBnB,YAAY;KACZoB,QAAQ,EAAE,IAAI;KACdC,SAAS,EAAE,cAAc;KACzBC,OAAO,EAAE,IAAI;KACbC,QAAQ,EAAGC,IAAI,IAAK;OACnBR,6BAAY,CAACS,IAAI,CAACC,qBAAS,CAACC,QAAQ,CAACC,UAAU,EAAE;SAChDC,IAAI,EAAEL,IAAI,CAACM,IAAI;SACfC,OAAO,EAAE;QACT,CAAC;;IAEH,CAAC;GACFb,MAAM,CACJc,YAAY,CAACb,gBAAM,CAACc,SAAS,CAACJ,IAAI,CAAC,CACnCA,IAAI,EAAE;CAET;CAAC,sBAEW1B,SAAkB,EAC9B;GACC,MAAM+B,MAAM,GAAG;KACdJ,IAAI,EAAE;OAAElC,MAAM,0CAAE,IAAI;;IACpB;GACD,IAAIO,SAAS,EACb;KACC+B,MAAM,CAACJ,IAAI,CAAC3B,SAAS,GAAGA,SAAS;;GAGlC,OAAOgC,wBAAS,CAAC1B,sBAAU,CAAC2B,mBAAmB,EAAEF,MAAM,CAAC,CAACvB,IAAI,CAAEC,YAAY,IAAK;KAC/E,MAAM;OAAEyB,IAAI;OAAExB;MAAQ,GAAGD,YAAY;KAErC,+CAAO,IAAI,oCAAiByB,IAAI,EAAExB,MAAM;IACxC,CAAC;CACH;CAAC,iCAEsByB,aAAqB,EAAEC,KAAa,EAC3D;GACC,OAAO,4CAAI,4BAAaC,UAAU,CAACF,aAAa,EAAEC,KAAK,CAAC,CAAC5B,IAAI,CAAE8B,MAAM,IAAK;KACzE,OAAOA,MAAM,CAACX,IAAI,EAAE;IACpB,CAAC,CAACY,KAAK,CAAEC,KAAK,IAAK;KACnBC,OAAO,CAACD,KAAK,CAACA,KAAK,CAAC;IACpB,CAAC;CACH;CAAC,0BAEeE,SAAiB,EAAEjC,YAAoB,EACvD;GACCkC,EAAE,CAACC,SAAS,CAACC,QAAQ,CAACC,IAAI,CAACJ,SAAS,EAAE;KACrCP,aAAa,EAAE,MAAM;KACrBY,aAAa,EAAEtC,YAAY;KAC3BuC,SAAS,EAAE;IACX,CAAC;CACH;CAAC,8BAEmBvC,YAAoB,EACxC;GACC,IAAI,CAACwC,MAAM,CAACC,GAAG,CAACP,EAAE,IAAIM,MAAM,CAACN,EAAE,EAAEQ,QAAQ,CAACC,YAAY,CAAC,CAAC,EAAE3C,YAAY,CAAC,CAAC4C,IAAI,EAAE;CAC/E;CAAC,+BAEoBzC,QAAgB,EAAEZ,SAAkB,EAAEsD,KAAgB,EAC3E;GACC,MAAMC,SAAS,GAAGD,KAAK,CAACE,OAAO,EAAE;GACjC,IAAID,SAAS,CAAC3C,QAAQ,KAAKA,QAAQ,EACnC;KACC;;GAGD,MAAMT,WAAW,GAAG;KACnBsD,WAAW,EAAEF,SAAS,CAACG,YAAY,CAACC,OAAO;KAC3CvD,OAAO,0CAAE,IAAI;IACb;GAED,IAAIJ,SAAS,EACb;KACCG,WAAW,CAACE,UAAU,GAAGL,SAAS;;GAGnC,OAAO,4CAAI,4BAAaqC,UAAU,CAAC/B,sBAAU,CAACsD,iBAAiB,EAAEzD,WAAW,CAAC,CAACoC,KAAK,CAAEC,KAAK,IAAK;KAC9FC,OAAO,CAACD,KAAK,CAACA,KAAK,CAAC;IACpB,CAAC;CACH;;;;;;;;"}