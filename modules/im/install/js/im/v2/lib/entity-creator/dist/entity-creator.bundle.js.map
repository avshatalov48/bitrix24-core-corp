{"version":3,"file":"entity-creator.bundle.js","sources":["../src/entity-creator.js"],"sourcesContent":["import {BaseEvent, EventEmitter} from 'main.core.events';\nimport {RestClient} from 'rest.client';\n\nimport {Core} from 'im.v2.application.core';\nimport {RestMethod} from 'im.v2.const';\n\nconst REQUEST_METHODS = Object.freeze({\n\ttask: RestMethod.imChatTaskPrepare,\n\tmeeting: RestMethod.imChatCalendarPrepare,\n});\n\nconst CALENDAR_ON_ENTRY_SAVE_EVENT = 'BX.Calendar:onEntrySave';\n\nexport class EntityCreator\n{\n\t#chatId: number = 0;\n\t#restClient: RestClient;\n\n\t#onCalendarEntrySaveHandler: ?Function;\n\t#calendarSliderId: ?number = null;\n\n\tconstructor(chatId: number)\n\t{\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#chatId = chatId;\n\t}\n\n\tcreateTaskForChat(): Promise\n\t{\n\t\treturn this.#createTask();\n\t}\n\n\tcreateTaskForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createTask(messageId);\n\t}\n\n\tcreateMeetingForChat(): Promise\n\t{\n\t\treturn this.#createMeeting();\n\t}\n\n\tcreateMeetingForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createMeeting(messageId);\n\t}\n\n\t#createMeeting(messageId?: number): Promise\n\t{\n\t\tconst queryParams = {CHAT_ID: this.#chatId};\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams['MESSAGE_ID'] = messageId;\n\t\t}\n\n\t\treturn this.#requestPreparedParams(REQUEST_METHODS.meeting, queryParams).then(sliderParams => {\n\t\t\tconst {params} = sliderParams;\n\n\t\t\tthis.#onCalendarEntrySaveHandler = this.#onCalendarEntrySave.bind(this, params.sliderId, messageId);\n\t\t\tEventEmitter.subscribeOnce(CALENDAR_ON_ENTRY_SAVE_EVENT, this.#onCalendarEntrySaveHandler);\n\n\t\t\treturn this.#openCalendarSlider(params);\n\t\t});\n\t}\n\n\t#createTask(messageId?: number): Promise\n\t{\n\t\tconst queryParams = {CHAT_ID: this.#chatId};\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams['MESSAGE_ID'] = messageId;\n\t\t}\n\n\t\treturn this.#requestPreparedParams(REQUEST_METHODS.task, queryParams).then(sliderParams => {\n\t\t\tconst {link, params} = sliderParams;\n\n\t\t\treturn this.#openTaskSlider(link, params);\n\t\t});\n\t}\n\n\t#requestPreparedParams(requestMethod: string, query: Object): Promise\n\t{\n\t\treturn this.#restClient.callMethod(requestMethod, query).then(result => {\n\t\t\treturn result.data();\n\t\t}).catch(error => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n\n\t#openTaskSlider(sliderUri: string, sliderParams: Object)\n\t{\n\t\tBX.SidePanel.Instance.open(sliderUri, {\n\t\t\trequestMethod: 'post',\n\t\t\trequestParams: sliderParams,\n\t\t\tcacheable: false,\n\t\t});\n\t}\n\n\t#openCalendarSlider(sliderParams: Object)\n\t{\n\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(0, sliderParams).show();\n\t}\n\n\t#onCalendarEntrySave(sliderId: string, messageId: ?number, event: BaseEvent)\n\t{\n\t\tconst eventData = event.getData();\n\t\tif (eventData.sliderId !== sliderId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst queryParams = {\n\t\t\tCALENDAR_ID: eventData.responseData.entryId,\n\t\t\tCHAT_ID: this.#chatId\n\t\t};\n\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams['MESSAGE_ID'] = messageId;\n\t\t}\n\n\t\treturn this.#restClient.callMethod(RestMethod.imChatCalendarAdd, queryParams).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n}"],"names":["REQUEST_METHODS","Object","freeze","task","RestMethod","imChatTaskPrepare","meeting","imChatCalendarPrepare","CALENDAR_ON_ENTRY_SAVE_EVENT","EntityCreator","constructor","chatId","Core","getRestClient","createTaskForChat","createTaskForMessage","messageId","createMeetingForChat","createMeetingForMessage","queryParams","CHAT_ID","then","sliderParams","params","bind","sliderId","EventEmitter","subscribeOnce","link","requestMethod","query","callMethod","result","data","catch","error","console","sliderUri","BX","SidePanel","Instance","open","requestParams","cacheable","window","top","Calendar","SliderLoader","show","event","eventData","getData","CALENDAR_ID","responseData","entryId","imChatCalendarAdd"],"mappings":";;;;;;CAMA,MAAMA,eAAe,GAAGC,MAAM,CAACC,MAAM,CAAC;GACrCC,IAAI,EAAEC,sBAAU,CAACC,iBAAiB;GAClCC,OAAO,EAAEF,sBAAU,CAACG;CACrB,CAAC,CAAC;CAEF,MAAMC,4BAA4B,GAAG,yBAAyB;CAAC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAE/D,CAAO,MAAMC,aAAa,CAC1B;GAOCC,WAAW,CAACC,MAAc,EAC1B;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA,OAPkB;;KAAC;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA,OAIU;;KAI5B,4CAAI,8BAAeC,2BAAI,CAACC,aAAa,EAAE;KACvC,4CAAI,sBAAWF,MAAM;;GAGtBG,iBAAiB,GACjB;KACC,+CAAO,IAAI;;GAGZC,oBAAoB,CAACC,SAAiB,EACtC;KACC,+CAAO,IAAI,4BAAaA,SAAS;;GAGlCC,oBAAoB,GACpB;KACC,+CAAO,IAAI;;GAGZC,uBAAuB,CAACF,SAAiB,EACzC;KACC,+CAAO,IAAI,kCAAgBA,SAAS;;CAiFtC;CAAC,yBA9EeA,SAAkB,EACjC;GACC,MAAMG,WAAW,GAAG;KAACC,OAAO,0CAAE,IAAI;IAAS;GAC3C,IAAIJ,SAAS,EACb;KACCG,WAAW,CAAC,YAAY,CAAC,GAAGH,SAAS;;GAGtC,OAAO,4CAAI,kDAAwBhB,eAAe,CAACM,OAAO,EAAEa,WAAW,EAAEE,IAAI,CAACC,YAAY,IAAI;KAC7F,MAAM;OAACC;MAAO,GAAGD,YAAY;KAE7B,4CAAI,8DAA+B,4CAAI,8CAAsBE,IAAI,CAAC,IAAI,EAAED,MAAM,CAACE,QAAQ,EAAET,SAAS,CAAC;KACnGU,6BAAY,CAACC,aAAa,CAACnB,4BAA4B,0CAAE,IAAI,4DAA6B;KAE1F,+CAAO,IAAI,4CAAqBe,MAAM;IACtC,CAAC;CACH;CAAC,sBAEWP,SAAkB,EAC9B;GACC,MAAMG,WAAW,GAAG;KAACC,OAAO,0CAAE,IAAI;IAAS;GAC3C,IAAIJ,SAAS,EACb;KACCG,WAAW,CAAC,YAAY,CAAC,GAAGH,SAAS;;GAGtC,OAAO,4CAAI,kDAAwBhB,eAAe,CAACG,IAAI,EAAEgB,WAAW,EAAEE,IAAI,CAACC,YAAY,IAAI;KAC1F,MAAM;OAACM,IAAI;OAAEL;MAAO,GAAGD,YAAY;KAEnC,+CAAO,IAAI,oCAAiBM,IAAI,EAAEL,MAAM;IACxC,CAAC;CACH;CAAC,iCAEsBM,aAAqB,EAAEC,KAAa,EAC3D;GACC,OAAO,4CAAI,4BAAaC,UAAU,CAACF,aAAa,EAAEC,KAAK,CAAC,CAACT,IAAI,CAACW,MAAM,IAAI;KACvE,OAAOA,MAAM,CAACC,IAAI,EAAE;IACpB,CAAC,CAACC,KAAK,CAACC,KAAK,IAAI;KACjBC,OAAO,CAACD,KAAK,CAACA,KAAK,CAAC;IACpB,CAAC;CACH;CAAC,0BAEeE,SAAiB,EAAEf,YAAoB,EACvD;GACCgB,EAAE,CAACC,SAAS,CAACC,QAAQ,CAACC,IAAI,CAACJ,SAAS,EAAE;KACrCR,aAAa,EAAE,MAAM;KACrBa,aAAa,EAAEpB,YAAY;KAC3BqB,SAAS,EAAE;IACX,CAAC;CACH;CAAC,8BAEmBrB,YAAoB,EACxC;GACC,IAAI,CAACsB,MAAM,CAACC,GAAG,CAACP,EAAE,IAAIM,MAAM,CAACN,EAAE,EAAEQ,QAAQ,CAACC,YAAY,CAAC,CAAC,EAAEzB,YAAY,CAAC,CAAC0B,IAAI,EAAE;CAC/E;CAAC,+BAEoBvB,QAAgB,EAAET,SAAkB,EAAEiC,KAAgB,EAC3E;GACC,MAAMC,SAAS,GAAGD,KAAK,CAACE,OAAO,EAAE;GACjC,IAAID,SAAS,CAACzB,QAAQ,KAAKA,QAAQ,EACnC;KACC;;GAGD,MAAMN,WAAW,GAAG;KACnBiC,WAAW,EAAEF,SAAS,CAACG,YAAY,CAACC,OAAO;KAC3ClC,OAAO,0CAAE,IAAI;IACb;GAED,IAAIJ,SAAS,EACb;KACCG,WAAW,CAAC,YAAY,CAAC,GAAGH,SAAS;;GAGtC,OAAO,4CAAI,4BAAae,UAAU,CAAC3B,sBAAU,CAACmD,iBAAiB,EAAEpC,WAAW,CAAC,CAACe,KAAK,CAAEC,KAAK,IAAK;KAC9FC,OAAO,CAACD,KAAK,CAACA,KAAK,CAAC;IACpB,CAAC;CACH;;;;;;;;"}