{"version":3,"file":"user-status.bundle.js","sources":["../src/user-status.js"],"sourcesContent":["import { Type } from 'main.core';\n\nimport { Core } from 'im.v2.application.core';\nimport { Utils } from 'im.v2.lib.utils';\nimport { RecentService } from 'im.v2.provider.service';\n\nimport type { ImModelUser } from 'im.v2.model';\n\ntype UserId = number;\n\nconst DAY = 1000 * 60 * 60 * 24;\n\nexport class UserStatusManager\n{\n\tstatic #instance: UserStatusManager;\n\n\t#absentList: Set<UserId> = new Set();\n\t#absentCheckInterval: number | null = null;\n\t#birthdayLoadInterval: number | null = null;\n\n\tstatic getInstance(): UserStatusManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tonUserUpdate(user: ImModelUser): void\n\t{\n\t\tthis.#startBirthdayLoadInterval();\n\n\t\tif (user.birthday && Utils.user.isBirthdayToday(user.birthday))\n\t\t{\n\t\t\tthis.#setUserBirthdayFlag(user.id, true);\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.#setUserBirthdayFlag(user.id, false);\n\t\t\t}, Utils.date.getTimeToNextMidnight());\n\t\t}\n\n\t\tif (Type.isDate(user.absent))\n\t\t{\n\t\t\tthis.#setUserAbsentFlag(user.id, true);\n\t\t\tthis.#startAbsentCheckInterval(user.id);\n\t\t}\n\t\telse if (user.absent === false && this.#absentList.has(user.id))\n\t\t{\n\t\t\tthis.#setUserAbsentFlag(user.id, false);\n\t\t\tthis.#stopAbsentCheckInterval(user.id);\n\t\t}\n\t}\n\n\tclear(): void\n\t{\n\t\tthis.#absentList = new Set();\n\t\tclearTimeout(this.#absentCheckInterval);\n\t\tthis.#absentCheckInterval = null;\n\t\tclearTimeout(this.#birthdayLoadInterval);\n\t\tthis.#birthdayLoadInterval = null;\n\t}\n\n\t#setUserBirthdayFlag(userId: number, flag: boolean): void\n\t{\n\t\tCore.getStore().dispatch('users/update', {\n\t\t\tid: userId,\n\t\t\tfields: { isBirthday: flag },\n\t\t});\n\t}\n\n\t#setUserAbsentFlag(userId: number, flag: boolean): void\n\t{\n\t\tCore.getStore().dispatch('users/update', {\n\t\t\tid: userId,\n\t\t\tfields: { isAbsent: flag },\n\t\t});\n\t}\n\n\t#startAbsentCheckInterval(userId: number): void\n\t{\n\t\tthis.#absentList.add(userId);\n\t\tif (this.#absentCheckInterval)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#absentCheckInterval = setTimeout(() => {\n\t\t\tthis.#checkAbsentList();\n\t\t\tsetInterval(() => {\n\t\t\t\tthis.#checkAbsentList();\n\t\t\t}, DAY);\n\t\t}, Utils.date.getTimeToNextMidnight());\n\t}\n\n\t#stopAbsentCheckInterval(userId: number): void\n\t{\n\t\tthis.#absentList.delete(userId);\n\t}\n\n\t#checkAbsentList()\n\t{\n\t\tfor (const userId of this.#absentList)\n\t\t{\n\t\t\tconst user: ImModelUser = Core.getStore().getters['users/get'](userId);\n\t\t\tif (!user || !Type.isDate(user.absent))\n\t\t\t{\n\t\t\t\tthis.#stopAbsentCheckInterval(userId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst absentEnd: Date = user.absent.getTime();\n\t\t\tif (absentEnd <= Date.now())\n\t\t\t{\n\t\t\t\tthis.#setUserAbsentFlag(user.id, false);\n\t\t\t\tthis.#stopAbsentCheckInterval(user.id);\n\t\t\t}\n\t\t}\n\t}\n\n\t#startBirthdayLoadInterval()\n\t{\n\t\tif (this.#birthdayLoadInterval)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#birthdayLoadInterval = setTimeout(() => {\n\t\t\tRecentService.getInstance().loadFirstPage();\n\t\t\tsetInterval(() => {\n\t\t\t\tRecentService.getInstance().loadFirstPage();\n\t\t\t}, DAY);\n\t\t}, Utils.date.getTimeToNextMidnight());\n\t}\n}\n"],"names":["DAY","UserStatusManager","Set","getInstance","onUserUpdate","user","birthday","Utils","isBirthdayToday","id","setTimeout","date","getTimeToNextMidnight","Type","isDate","absent","has","clear","clearTimeout","userId","flag","Core","getStore","dispatch","fields","isBirthday","isAbsent","add","setInterval","delete","getters","absentEnd","getTime","Date","now","RecentService","loadFirstPage"],"mappings":"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"}