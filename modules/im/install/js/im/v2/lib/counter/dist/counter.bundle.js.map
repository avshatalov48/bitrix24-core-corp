{"version":3,"file":"counter.bundle.js","sources":["../src/counter.js"],"sourcesContent":["import { Type } from 'main.core';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\nimport { Store } from 'ui.vue3.vuex';\n\nimport { Core } from 'im.v2.application.core';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { Logger } from 'im.v2.lib.logger';\nimport { EventType } from 'im.v2.const';\n\ntype InitialCounters = {\n\tCHAT: {[chatId: string]: number},\n\tLINES: {[chatId: string]: number},\n\tCHAT_MUTED: number[],\n\tCHAT_UNREAD: number[],\n\tTYPE: {\n\t\t'ALL': number,\n\t\t'NOTIFY': number,\n\t\t'LINES': number,\n\t}\n};\n\nexport class CounterManager\n{\n\tstatic #instance: CounterManager;\n\n\t#store: Store;\n\n\tstatic getInstance(): CounterManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tCounterManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tconst { counters } = Core.getApplicationData();\n\t\tLogger.warn('CounterManager: counters', counters);\n\t\tthis.#init(counters);\n\t}\n\n\tremoveBrowserTitleCounter()\n\t{\n\t\tconst regexp = /^(?<counterWithWhitespace>\\(\\d+\\)\\s).*/;\n\t\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\t\tif (!matchResult?.groups.counterWithWhitespace)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst counterPrefixLength = matchResult.groups.counterWithWhitespace;\n\t\tdocument.title = document.title.slice(counterPrefixLength);\n\t}\n\n\t#init(counters: InitialCounters)\n\t{\n\t\tthis.#store.dispatch('recent/setUnloadedChatCounters', this.#prepareChatCounters(counters));\n\t\tthis.#store.dispatch('recent/setUnloadedLinesCounters', counters.LINES);\n\t\tthis.#store.dispatch('notifications/setCounter', counters.TYPE.NOTIFY);\n\n\t\tthis.#subscribeToCountersChange();\n\t\tthis.#sendNotificationCounterChangeEvent(counters.TYPE.NOTIFY);\n\t\tthis.#sendLinesCounterChangeEvent(counters.TYPE.LINES);\n\t}\n\n\t#prepareChatCounters(counters: InitialCounters): {[chatId: string]: number}\n\t{\n\t\tconst chatCounters = Type.isArray(counters.CHAT) ? {} : counters.CHAT;\n\t\tconst markedChats = counters.CHAT_UNREAD;\n\t\tmarkedChats.forEach((markedChatId) => {\n\t\t\tconst unreadChatHasCounter = Boolean(chatCounters[markedChatId]);\n\t\t\tif (unreadChatHasCounter)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tchatCounters[markedChatId] = 1;\n\t\t});\n\n\t\treturn chatCounters;\n\t}\n\n\t#subscribeToCountersChange()\n\t{\n\t\tthis.#store.watch(notificationCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendNotificationCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(chatCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendChatCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(linesCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendLinesCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\t}\n\n\t#sendNotificationCounterChangeEvent(notificationsCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [notificationsCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onNotificationCounterChange, event);\n\t}\n\n\t#sendChatCounterChangeEvent(chatCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [chatCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onChatCounterChange, event);\n\t}\n\n\t#sendLinesCounterChangeEvent(linesCounter: number)\n\t{\n\t\tconst LINES_TYPE = 'LINES';\n\t\tconst event = new BaseEvent({ compatData: [linesCounter, LINES_TYPE] });\n\t\tEventEmitter.emit(window, EventType.counter.onLinesCounterChange, event);\n\t}\n\n\t#onTotalCounterChange()\n\t{\n\t\tconst notificationCounter = this.#store.getters['notifications/getCounter'];\n\t\tconst chatCounter = this.#store.getters['recent/getTotalChatCounter'];\n\t\tconst linesCounter = this.#store.getters['recent/getTotalLinesCounter'];\n\t\tconst totalCounter = notificationCounter + chatCounter + linesCounter;\n\n\t\tif (DesktopManager.getInstance().isDesktopActive())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#updateBrowserTitleCounter(totalCounter);\n\t}\n\n\t#updateBrowserTitleCounter(newCounter: number)\n\t{\n\t\tconst regexp = /^\\((?<currentCounter>\\d+)\\)\\s(?<text>.*)+/;\n\t\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\t\tif (matchResult?.groups.currentCounter)\n\t\t{\n\t\t\tconst currentCounter = Number.parseInt(matchResult.groups.currentCounter, 10);\n\t\t\tif (newCounter !== currentCounter)\n\t\t\t{\n\t\t\t\tconst counterPrefix = newCounter > 0 ? `(${newCounter}) ` : '';\n\t\t\t\tdocument.title = `${counterPrefix}${matchResult.groups.text}`;\n\t\t\t}\n\t\t}\n\t\telse if (newCounter > 0)\n\t\t{\n\t\t\tdocument.title = `(${newCounter}) ${document.title}`;\n\t\t}\n\t}\n}\n\nconst notificationCounterWatch = (state, getters) => {\n\treturn getters['notifications/getCounter'];\n};\n\nconst chatCounterWatch = (state, getters) => {\n\treturn getters['recent/getTotalChatCounter'];\n};\n\nconst linesCounterWatch = (state, getters) => {\n\treturn getters['recent/getTotalLinesCounter'];\n};\n"],"names":["CounterManager","getInstance","init","constructor","Core","getStore","counters","getApplicationData","Logger","warn","removeBrowserTitleCounter","regexp","matchResult","document","title","match","groups","counterWithWhitespace","counterPrefixLength","slice","dispatch","LINES","TYPE","NOTIFY","chatCounters","Type","isArray","CHAT","markedChats","CHAT_UNREAD","forEach","markedChatId","unreadChatHasCounter","Boolean","watch","notificationCounterWatch","newValue","chatCounterWatch","linesCounterWatch","notificationsCounter","event","BaseEvent","compatData","EventEmitter","emit","window","EventType","counter","onNotificationCounterChange","chatCounter","onChatCounterChange","linesCounter","LINES_TYPE","onLinesCounterChange","notificationCounter","getters","totalCounter","DesktopManager","isDesktopActive","newCounter","currentCounter","Number","parseInt","counterPrefix","text","state"],"mappings":"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"}