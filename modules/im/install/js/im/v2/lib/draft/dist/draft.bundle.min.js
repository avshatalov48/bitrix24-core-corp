this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(t,e,s,r,a,i,n){"use strict";const o=1e3;const f=1500;class h{static getInstance(){if(!h.instance){h.instance=new h}return h.instance}constructor(){this.inited=false;this.drafts={};this.initPromise=new Promise((t=>{this.initPromiseResolver=t}));s.EventEmitter.subscribe(n.EventType.layout.onLayoutChange,this.onLayoutChange.bind(this))}initDraftHistory(){if(this.inited){return}this.inited=true;const t=a.LocalStorageManager.getInstance().get(this.getLocalStorageKey(),{});this.fillDraftsFromStorage(t);i.Logger.warn("DraftManager: initDrafts:",this.drafts);this.initPromiseResolver();this.setRecentListDraftText()}ready(){return this.initPromise}fillDraftsFromStorage(t){if(!e.Type.isPlainObject(t)){return}Object.entries(t).forEach((([t,s])=>{if(!e.Type.isPlainObject(s)){return}this.drafts[t]=s}))}setDraftText(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].text=e.trim();this.refreshSaveTimeout()}setDraftPanel(t,e,s){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].panelType=e;this.drafts[t].panelMessageId=s;this.refreshSaveTimeout()}setDraftMentions(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].mentions=e;this.refreshSaveTimeout()}async getDraft(t){var e;await this.initPromise;const s=(e=this.drafts[t])!=null?e:{};return Promise.resolve(s)}clearDraft(t){delete this.drafts[t];this.setRecentItemDraftText(t,"")}setRecentListDraftText(){Object.entries(this.drafts).forEach((([t,e])=>{var s;this.setRecentItemDraftText(t,(s=e.text)!=null?s:"")}))}setRecentItemDraftText(t,e){r.Core.getStore().dispatch(this.getDraftMethodName(),{id:t,text:e})}onLayoutChange(t){const{from:e}=t.getData();if(e.name!==this.getLayoutName()||e.entityId===""){return}const s=e.entityId;setTimeout((async()=>{const{text:t=""}=await this.getDraft(s);this.setRecentItemDraftText(s,t)}),f)}refreshSaveTimeout(){clearTimeout(this.writeToStorageTimeout);this.writeToStorageTimeout=setTimeout((()=>{this.saveToLocalStorage()}),o)}saveToLocalStorage(){a.LocalStorageManager.getInstance().set(this.getLocalStorageKey(),this.prepareDrafts())}prepareDrafts(){const t={};Object.entries(this.drafts).forEach((([e,s])=>{if(!s.text&&!s.panelType){return}if(s.panelType===n.TextareaPanelType.edit){return}t[e]={text:s.text,mentions:s.mentions}}));return t}getLayoutName(){return n.Layout.chat.name}getLocalStorageKey(){return n.LocalStorageKey.recentDraft}getDraftMethodName(){return"recent/setRecentDraft"}}h.instance=null;class c extends h{static getInstance(){if(!c.instance){c.instance=new c}return c.instance}getLayoutName(){return n.Layout.copilot.name}getLocalStorageKey(){return n.LocalStorageKey.copilotDraft}getDraftMethodName(){return"recent/setCopilotDraft"}}c.instance=null;t.DraftManager=h;t.CopilotDraftManager=c})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX,BX.Event,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const);
//# sourceMappingURL=draft.bundle.map.js