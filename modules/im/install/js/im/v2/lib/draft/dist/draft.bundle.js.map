{"version":3,"file":"draft.bundle.js","sources":["../src/draft.js","../src/copilot-draft.js"],"sourcesContent":["import { Type } from 'main.core';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { LocalStorageManager } from 'im.v2.lib.local-storage';\nimport { Logger } from 'im.v2.lib.logger';\nimport { LocalStorageKey, EventType, Layout, TextareaPanelType } from 'im.v2.const';\n\nimport type { JsonObject } from 'main.core';\nimport type { OnLayoutChangeEvent } from 'im.v2.const';\ntype TextareaPanelTypeItem = $Values<typeof TextareaPanelType>;\ntype Draft = {\n\ttext?: string,\n\tpanelType?: TextareaPanelTypeItem,\n\tpanelMessageId?: number,\n\tmentions?: JsonObject\n};\n\nconst WRITE_TO_STORAGE_TIMEOUT = 1000;\nconst SHOW_DRAFT_IN_RECENT_TIMEOUT = 1500;\n\nexport class DraftManager\n{\n\tstatic instance: DraftManager = null;\n\n\tinited: boolean = false;\n\tinitPromise: Promise;\n\tinitPromiseResolver: () => void;\n\tdrafts: { [dialogId: string]: Draft } = {};\n\n\tstatic getInstance(): DraftManager\n\t{\n\t\tif (!DraftManager.instance)\n\t\t{\n\t\t\tDraftManager.instance = new DraftManager();\n\t\t}\n\n\t\treturn DraftManager.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.initPromiseResolver = resolve;\n\t\t});\n\t\tEventEmitter.subscribe(EventType.layout.onLayoutChange, this.onLayoutChange.bind(this));\n\t}\n\n\tinitDraftHistory()\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inited = true;\n\t\tconst draftHistory = LocalStorageManager.getInstance().get(this.getLocalStorageKey(), {});\n\t\tthis.fillDraftsFromStorage(draftHistory);\n\n\t\tLogger.warn('DraftManager: initDrafts:', this.drafts);\n\t\tthis.initPromiseResolver();\n\t\tthis.setRecentListDraftText();\n\t}\n\n\tready(): Promise\n\t{\n\t\treturn this.initPromise;\n\t}\n\n\tfillDraftsFromStorage(draftHistory: { [dialogId: string]: Draft }): void\n\t{\n\t\tif (!Type.isPlainObject(draftHistory))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tObject.entries(draftHistory).forEach(([dialogId, draft]) => {\n\t\t\tif (!Type.isPlainObject(draft))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.drafts[dialogId] = draft;\n\t\t});\n\t}\n\n\tsetDraftText(dialogId: number, text: string): void\n\t{\n\t\tif (!this.drafts[dialogId])\n\t\t{\n\t\t\tthis.drafts[dialogId] = {};\n\t\t}\n\t\tthis.drafts[dialogId].text = text.trim();\n\n\t\tthis.refreshSaveTimeout();\n\t}\n\n\tsetDraftPanel(dialogId: number, panelType: TextareaPanelTypeItem, messageId: number): void\n\t{\n\t\tif (!this.drafts[dialogId])\n\t\t{\n\t\t\tthis.drafts[dialogId] = {};\n\t\t}\n\t\tthis.drafts[dialogId].panelType = panelType;\n\t\tthis.drafts[dialogId].panelMessageId = messageId;\n\n\t\tthis.refreshSaveTimeout();\n\t}\n\n\tsetDraftMentions(dialogId: number, mentions: JsonObject): void\n\t{\n\t\tif (!this.drafts[dialogId])\n\t\t{\n\t\t\tthis.drafts[dialogId] = {};\n\t\t}\n\t\tthis.drafts[dialogId].mentions = mentions;\n\n\t\tthis.refreshSaveTimeout();\n\t}\n\n\tasync getDraft(dialogId: number): Promise<Draft>\n\t{\n\t\tawait this.initPromise;\n\t\tconst draft = this.drafts[dialogId] ?? {};\n\n\t\treturn Promise.resolve(draft);\n\t}\n\n\tclearDraft(dialogId: number)\n\t{\n\t\tdelete this.drafts[dialogId];\n\t\tthis.setRecentItemDraftText(dialogId, '');\n\t}\n\n\tsetRecentListDraftText()\n\t{\n\t\tObject.entries(this.drafts).forEach(([dialogId, draft]) => {\n\t\t\tthis.setRecentItemDraftText(dialogId, draft.text ?? '');\n\t\t});\n\t}\n\n\tsetRecentItemDraftText(dialogId: number, text: string)\n\t{\n\t\tCore.getStore().dispatch(this.getDraftMethodName(), {\n\t\t\tid: dialogId,\n\t\t\ttext,\n\t\t});\n\t}\n\n\tonLayoutChange(event: BaseEvent<OnLayoutChangeEvent>)\n\t{\n\t\tconst { from } = event.getData();\n\t\tif (from.name !== this.getLayoutName() || from.entityId === '')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst dialogId = from.entityId;\n\t\tsetTimeout(async () => {\n\t\t\tconst { text = '' } = await this.getDraft(dialogId);\n\t\t\tthis.setRecentItemDraftText(dialogId, text);\n\t\t}, SHOW_DRAFT_IN_RECENT_TIMEOUT);\n\t}\n\n\trefreshSaveTimeout()\n\t{\n\t\tclearTimeout(this.writeToStorageTimeout);\n\t\tthis.writeToStorageTimeout = setTimeout(() => {\n\t\t\tthis.saveToLocalStorage();\n\t\t}, WRITE_TO_STORAGE_TIMEOUT);\n\t}\n\n\tsaveToLocalStorage()\n\t{\n\t\tLocalStorageManager.getInstance().set(this.getLocalStorageKey(), this.prepareDrafts());\n\t}\n\n\tprepareDrafts(): { [dialogId: string]: Draft }\n\t{\n\t\tconst result = {};\n\t\tObject.entries(this.drafts).forEach(([dialogId, draft]) => {\n\t\t\tif (!draft.text && !draft.panelType)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (draft.panelType === TextareaPanelType.edit)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresult[dialogId] = {\n\t\t\t\ttext: draft.text,\n\t\t\t\tmentions: draft.mentions,\n\t\t\t};\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tgetLayoutName(): string\n\t{\n\t\treturn Layout.chat.name;\n\t}\n\n\tgetLocalStorageKey(): string\n\t{\n\t\treturn LocalStorageKey.recentDraft;\n\t}\n\n\tgetDraftMethodName(): string\n\t{\n\t\treturn 'recent/setRecentDraft';\n\t}\n}\n","import { Layout, LocalStorageKey } from 'im.v2.const';\nimport { DraftManager } from './draft';\n\nexport class CopilotDraftManager extends DraftManager\n{\n\tstatic instance: CopilotDraftManager = null;\n\n\tstatic getInstance(): CopilotDraftManager\n\t{\n\t\tif (!CopilotDraftManager.instance)\n\t\t{\n\t\t\tCopilotDraftManager.instance = new CopilotDraftManager();\n\t\t}\n\n\t\treturn CopilotDraftManager.instance;\n\t}\n\n\tgetLayoutName(): string\n\t{\n\t\treturn Layout.copilot.name;\n\t}\n\n\tgetLocalStorageKey(): string\n\t{\n\t\treturn LocalStorageKey.copilotDraft;\n\t}\n\n\tgetDraftMethodName(): string\n\t{\n\t\treturn 'recent/setCopilotDraft';\n\t}\n}\n"],"names":["WRITE_TO_STORAGE_TIMEOUT","SHOW_DRAFT_IN_RECENT_TIMEOUT","DraftManager","getInstance","instance","constructor","inited","drafts","initPromise","Promise","resolve","initPromiseResolver","EventEmitter","subscribe","EventType","layout","onLayoutChange","bind","initDraftHistory","draftHistory","LocalStorageManager","get","getLocalStorageKey","fillDraftsFromStorage","Logger","warn","setRecentListDraftText","ready","Type","isPlainObject","Object","entries","forEach","dialogId","draft","setDraftText","text","trim","refreshSaveTimeout","setDraftPanel","panelType","messageId","panelMessageId","setDraftMentions","mentions","getDraft","clearDraft","setRecentItemDraftText","Core","getStore","dispatch","getDraftMethodName","id","event","from","getData","name","getLayoutName","entityId","setTimeout","clearTimeout","writeToStorageTimeout","saveToLocalStorage","set","prepareDrafts","result","TextareaPanelType","edit","Layout","chat","LocalStorageKey","recentDraft","CopilotDraftManager","copilot","copilotDraft"],"mappings":";;;;;;;CAkBA,MAAMA,wBAAwB,GAAG,IAAI;CACrC,MAAMC,4BAA4B,GAAG,IAAI;AAEzC,CAAO,MAAMC,YAAY,CACzB;GAQC,OAAOC,WAAW,GAClB;KACC,IAAI,CAACD,YAAY,CAACE,QAAQ,EAC1B;OACCF,YAAY,CAACE,QAAQ,GAAG,IAAIF,YAAY,EAAE;;KAG3C,OAAOA,YAAY,CAACE,QAAQ;;GAG7BC,WAAW,GACX;KAAA,KAhBAC,MAAM,GAAY,KAAK;KAAA,KAGvBC,MAAM,GAAkC,EAAE;KAczC,IAAI,CAACC,WAAW,GAAG,IAAIC,OAAO,CAAEC,OAAO,IAAK;OAC3C,IAAI,CAACC,mBAAmB,GAAGD,OAAO;MAClC,CAAC;KACFE,6BAAY,CAACC,SAAS,CAACC,qBAAS,CAACC,MAAM,CAACC,cAAc,EAAE,IAAI,CAACA,cAAc,CAACC,IAAI,CAAC,IAAI,CAAC,CAAC;;GAGxFC,gBAAgB,GAChB;KACC,IAAI,IAAI,CAACZ,MAAM,EACf;OACC;;KAGD,IAAI,CAACA,MAAM,GAAG,IAAI;KAClB,MAAMa,YAAY,GAAGC,0CAAmB,CAACjB,WAAW,EAAE,CAACkB,GAAG,CAAC,IAAI,CAACC,kBAAkB,EAAE,EAAE,EAAE,CAAC;KACzF,IAAI,CAACC,qBAAqB,CAACJ,YAAY,CAAC;KAExCK,uBAAM,CAACC,IAAI,CAAC,2BAA2B,EAAE,IAAI,CAAClB,MAAM,CAAC;KACrD,IAAI,CAACI,mBAAmB,EAAE;KAC1B,IAAI,CAACe,sBAAsB,EAAE;;GAG9BC,KAAK,GACL;KACC,OAAO,IAAI,CAACnB,WAAW;;GAGxBe,qBAAqB,CAACJ,YAA2C,EACjE;KACC,IAAI,CAACS,cAAI,CAACC,aAAa,CAACV,YAAY,CAAC,EACrC;OACC;;KAGDW,MAAM,CAACC,OAAO,CAACZ,YAAY,CAAC,CAACa,OAAO,CAAC,CAAC,CAACC,QAAQ,EAAEC,KAAK,CAAC,KAAK;OAC3D,IAAI,CAACN,cAAI,CAACC,aAAa,CAACK,KAAK,CAAC,EAC9B;SACC;;OAGD,IAAI,CAAC3B,MAAM,CAAC0B,QAAQ,CAAC,GAAGC,KAAK;MAC7B,CAAC;;GAGHC,YAAY,CAACF,QAAgB,EAAEG,IAAY,EAC3C;KACC,IAAI,CAAC,IAAI,CAAC7B,MAAM,CAAC0B,QAAQ,CAAC,EAC1B;OACC,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,GAAG,EAAE;;KAE3B,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,CAACG,IAAI,GAAGA,IAAI,CAACC,IAAI,EAAE;KAExC,IAAI,CAACC,kBAAkB,EAAE;;GAG1BC,aAAa,CAACN,QAAgB,EAAEO,SAAgC,EAAEC,SAAiB,EACnF;KACC,IAAI,CAAC,IAAI,CAAClC,MAAM,CAAC0B,QAAQ,CAAC,EAC1B;OACC,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,GAAG,EAAE;;KAE3B,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,CAACO,SAAS,GAAGA,SAAS;KAC3C,IAAI,CAACjC,MAAM,CAAC0B,QAAQ,CAAC,CAACS,cAAc,GAAGD,SAAS;KAEhD,IAAI,CAACH,kBAAkB,EAAE;;GAG1BK,gBAAgB,CAACV,QAAgB,EAAEW,QAAoB,EACvD;KACC,IAAI,CAAC,IAAI,CAACrC,MAAM,CAAC0B,QAAQ,CAAC,EAC1B;OACC,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,GAAG,EAAE;;KAE3B,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC,CAACW,QAAQ,GAAGA,QAAQ;KAEzC,IAAI,CAACN,kBAAkB,EAAE;;GAG1B,MAAMO,QAAQ,CAACZ,QAAgB,EAC/B;KAAA;KACC,MAAM,IAAI,CAACzB,WAAW;KACtB,MAAM0B,KAAK,4BAAG,IAAI,CAAC3B,MAAM,CAAC0B,QAAQ,CAAC,oCAAI,EAAE;KAEzC,OAAOxB,OAAO,CAACC,OAAO,CAACwB,KAAK,CAAC;;GAG9BY,UAAU,CAACb,QAAgB,EAC3B;KACC,OAAO,IAAI,CAAC1B,MAAM,CAAC0B,QAAQ,CAAC;KAC5B,IAAI,CAACc,sBAAsB,CAACd,QAAQ,EAAE,EAAE,CAAC;;GAG1CP,sBAAsB,GACtB;KACCI,MAAM,CAACC,OAAO,CAAC,IAAI,CAACxB,MAAM,CAAC,CAACyB,OAAO,CAAC,CAAC,CAACC,QAAQ,EAAEC,KAAK,CAAC,KAAK;OAAA;OAC1D,IAAI,CAACa,sBAAsB,CAACd,QAAQ,iBAAEC,KAAK,CAACE,IAAI,0BAAI,EAAE,CAAC;MACvD,CAAC;;GAGHW,sBAAsB,CAACd,QAAgB,EAAEG,IAAY,EACrD;KACCY,2BAAI,CAACC,QAAQ,EAAE,CAACC,QAAQ,CAAC,IAAI,CAACC,kBAAkB,EAAE,EAAE;OACnDC,EAAE,EAAEnB,QAAQ;OACZG;MACA,CAAC;;GAGHpB,cAAc,CAACqC,KAAqC,EACpD;KACC,MAAM;OAAEC;MAAM,GAAGD,KAAK,CAACE,OAAO,EAAE;KAChC,IAAID,IAAI,CAACE,IAAI,KAAK,IAAI,CAACC,aAAa,EAAE,IAAIH,IAAI,CAACI,QAAQ,KAAK,EAAE,EAC9D;OACC;;KAGD,MAAMzB,QAAQ,GAAGqB,IAAI,CAACI,QAAQ;KAC9BC,UAAU,CAAC,YAAY;OACtB,MAAM;SAAEvB,IAAI,GAAG;QAAI,GAAG,MAAM,IAAI,CAACS,QAAQ,CAACZ,QAAQ,CAAC;OACnD,IAAI,CAACc,sBAAsB,CAACd,QAAQ,EAAEG,IAAI,CAAC;MAC3C,EAAEnC,4BAA4B,CAAC;;GAGjCqC,kBAAkB,GAClB;KACCsB,YAAY,CAAC,IAAI,CAACC,qBAAqB,CAAC;KACxC,IAAI,CAACA,qBAAqB,GAAGF,UAAU,CAAC,MAAM;OAC7C,IAAI,CAACG,kBAAkB,EAAE;MACzB,EAAE9D,wBAAwB,CAAC;;GAG7B8D,kBAAkB,GAClB;KACC1C,0CAAmB,CAACjB,WAAW,EAAE,CAAC4D,GAAG,CAAC,IAAI,CAACzC,kBAAkB,EAAE,EAAE,IAAI,CAAC0C,aAAa,EAAE,CAAC;;GAGvFA,aAAa,GACb;KACC,MAAMC,MAAM,GAAG,EAAE;KACjBnC,MAAM,CAACC,OAAO,CAAC,IAAI,CAACxB,MAAM,CAAC,CAACyB,OAAO,CAAC,CAAC,CAACC,QAAQ,EAAEC,KAAK,CAAC,KAAK;OAC1D,IAAI,CAACA,KAAK,CAACE,IAAI,IAAI,CAACF,KAAK,CAACM,SAAS,EACnC;SACC;;OAGD,IAAIN,KAAK,CAACM,SAAS,KAAK0B,6BAAiB,CAACC,IAAI,EAC9C;SACC;;OAGDF,MAAM,CAAChC,QAAQ,CAAC,GAAG;SAClBG,IAAI,EAAEF,KAAK,CAACE,IAAI;SAChBQ,QAAQ,EAAEV,KAAK,CAACU;QAChB;MACD,CAAC;KAEF,OAAOqB,MAAM;;GAGdR,aAAa,GACb;KACC,OAAOW,kBAAM,CAACC,IAAI,CAACb,IAAI;;GAGxBlC,kBAAkB,GAClB;KACC,OAAOgD,2BAAe,CAACC,WAAW;;GAGnCpB,kBAAkB,GAClB;KACC,OAAO,uBAAuB;;CAEhC;CAjMajD,YAAY,CAEjBE,QAAQ,GAAiB,IAAI;;CCpB9B,MAAMoE,mBAAmB,SAAStE,YAAY,CACrD;GAGC,OAAOC,WAAW,GAClB;KACC,IAAI,CAACqE,mBAAmB,CAACpE,QAAQ,EACjC;OACCoE,mBAAmB,CAACpE,QAAQ,GAAG,IAAIoE,mBAAmB,EAAE;;KAGzD,OAAOA,mBAAmB,CAACpE,QAAQ;;GAGpCqD,aAAa,GACb;KACC,OAAOW,kBAAM,CAACK,OAAO,CAACjB,IAAI;;GAG3BlC,kBAAkB,GAClB;KACC,OAAOgD,2BAAe,CAACI,YAAY;;GAGpCvB,kBAAkB,GAClB;KACC,OAAO,wBAAwB;;CAEjC;CA5BaqB,mBAAmB,CAExBpE,QAAQ,GAAwB,IAAI;;;;;;;;;"}