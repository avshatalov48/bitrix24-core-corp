{"version":3,"file":"draft.bundle.js","sources":["../src/draft.js","../src/copilot-draft.js"],"sourcesContent":["import { EventEmitter, BaseEvent } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { LocalStorageManager } from 'im.v2.lib.local-storage';\nimport { Logger } from 'im.v2.lib.logger';\nimport { LocalStorageKey, EventType, Layout } from 'im.v2.const';\n\nimport type { OnLayoutChangeEvent } from 'im.v2.const';\n\nconst WRITE_TO_STORAGE_TIMEOUT = 1000;\nconst SHOW_DRAFT_IN_RECENT_TIMEOUT = 1500;\n\nexport class DraftManager\n{\n\tstatic instance: DraftManager = null;\n\n\tinited: boolean = false;\n\tdrafts: {[string]: string} = {};\n\n\tstatic getInstance(): DraftManager\n\t{\n\t\tif (!DraftManager.instance)\n\t\t{\n\t\t\tDraftManager.instance = new DraftManager();\n\t\t}\n\n\t\treturn DraftManager.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tEventEmitter.subscribe(EventType.layout.onLayoutChange, this.onLayoutChange.bind(this));\n\t}\n\n\tinitDraftHistory()\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.drafts = LocalStorageManager.getInstance().get(this.getLocalStorageKey(), {});\n\t\tLogger.warn('DraftManager: initDrafts:', this.drafts);\n\t\tthis.setDraftsInRecentList();\n\t\tthis.inited = true;\n\t}\n\n\tsetDraft(dialogId: number, text: string)\n\t{\n\t\tconst preparedText = text.trim();\n\t\tif (preparedText === '')\n\t\t{\n\t\t\tdelete this.drafts[dialogId];\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.drafts[dialogId] = preparedText;\n\t\t}\n\n\t\tclearTimeout(this.writeToStorageTimeout);\n\t\tthis.writeToStorageTimeout = setTimeout(() => {\n\t\t\tLocalStorageManager.getInstance().set(this.getLocalStorageKey(), this.drafts);\n\t\t}, WRITE_TO_STORAGE_TIMEOUT);\n\t}\n\n\tgetDraft(dialogId: number): string\n\t{\n\t\treturn this.drafts[dialogId] ?? '';\n\t}\n\n\tclearDraftInRecentList(dialogId: number)\n\t{\n\t\tthis.setDraftInRecentList(dialogId, '');\n\t}\n\n\tsetDraftsInRecentList()\n\t{\n\t\tObject.entries(this.drafts).forEach(([dialogId, text]) => {\n\t\t\tthis.setDraftInRecentList(dialogId, text);\n\t\t});\n\t}\n\n\tsetDraftInRecentList(dialogId: number, text: string)\n\t{\n\t\tCore.getStore().dispatch(this.getDraftMethodName(), {\n\t\t\tid: dialogId,\n\t\t\ttext,\n\t\t});\n\t}\n\n\tonLayoutChange(event: BaseEvent<OnLayoutChangeEvent>)\n\t{\n\t\tconst { from } = event.getData();\n\t\tif (from.name !== this.getLayoutName() || from.entityId === '')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst dialogId = from.entityId;\n\t\tsetTimeout(() => {\n\t\t\tthis.setDraftInRecentList(dialogId, this.getDraft(dialogId));\n\t\t}, SHOW_DRAFT_IN_RECENT_TIMEOUT);\n\t}\n\n\tgetLayoutName(): string\n\t{\n\t\treturn Layout.chat.name;\n\t}\n\n\tgetLocalStorageKey(): string\n\t{\n\t\treturn LocalStorageKey.recentDraft;\n\t}\n\n\tgetDraftMethodName(): string\n\t{\n\t\treturn 'recent/setRecentDraft';\n\t}\n}\n","import { Layout, LocalStorageKey } from 'im.v2.const';\nimport { DraftManager } from './draft';\n\nexport class CopilotDraftManager extends DraftManager\n{\n\tstatic instance: CopilotDraftManager = null;\n\n\tstatic getInstance(): CopilotDraftManager\n\t{\n\t\tif (!CopilotDraftManager.instance)\n\t\t{\n\t\t\tCopilotDraftManager.instance = new CopilotDraftManager();\n\t\t}\n\n\t\treturn CopilotDraftManager.instance;\n\t}\n\n\tgetLayoutName(): string\n\t{\n\t\treturn Layout.copilot.name;\n\t}\n\n\tgetLocalStorageKey(): string\n\t{\n\t\treturn LocalStorageKey.copilotDraft;\n\t}\n\n\tgetDraftMethodName(): string\n\t{\n\t\treturn 'recent/setCopilotDraft';\n\t}\n}\n"],"names":["WRITE_TO_STORAGE_TIMEOUT","SHOW_DRAFT_IN_RECENT_TIMEOUT","DraftManager","getInstance","instance","constructor","inited","drafts","EventEmitter","subscribe","EventType","layout","onLayoutChange","bind","initDraftHistory","LocalStorageManager","get","getLocalStorageKey","Logger","warn","setDraftsInRecentList","setDraft","dialogId","text","preparedText","trim","clearTimeout","writeToStorageTimeout","setTimeout","set","getDraft","clearDraftInRecentList","setDraftInRecentList","Object","entries","forEach","Core","getStore","dispatch","getDraftMethodName","id","event","from","getData","name","getLayoutName","entityId","Layout","chat","LocalStorageKey","recentDraft","CopilotDraftManager","copilot","copilotDraft"],"mappings":"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"}