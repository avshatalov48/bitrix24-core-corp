{"version":3,"file":"writing.bundle.js","sources":["../src/writing.js"],"sourcesContent":["import { Core } from 'im.v2.application.core';\nimport { ChatType } from 'im.v2.const';\n\nimport type { ImModelChat } from 'im.v2.model';\n\ntype WritingListItem = {\n\tuserId: number,\n\tuserName: string\n};\n\nconst writingTimeByChatType = {\n\t[ChatType.copilot]: 180_000,\n\tdefault: 35000,\n};\n\nexport class WritingManager\n{\n\tstatic #instance: WritingManager;\n\n\t#writingTimers: {[timerId: string]: number} = {};\n\n\tstatic getInstance(): WritingManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstartWriting(payload: {dialogId: string, userId: number, userName: string}): void\n\t{\n\t\tconst { dialogId, userId, userName } = payload;\n\n\t\tconst chat: ImModelChat = this.#getChat(dialogId);\n\t\tif (!chat)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst timerId = this.#buildTimerId(dialogId, userId);\n\n\t\tif (this.#alreadyWriting(chat, userId))\n\t\t{\n\t\t\tthis.#clearTimer(timerId);\n\t\t\tthis.#writingTimers[timerId] = this.#setTimer(dialogId, userId);\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst newWritingList = [{ userId, userName }, ...chat.writingList];\n\t\tthis.#updateChatWritingList(dialogId, newWritingList);\n\n\t\tthis.#writingTimers[timerId] = this.#setTimer(dialogId, userId);\n\t}\n\n\tstopWriting(payload: {dialogId: string, userId: number}): void\n\t{\n\t\tconst { dialogId, userId } = payload;\n\n\t\tconst chat = this.#getChat(dialogId);\n\t\tif (!chat)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst timerId = this.#buildTimerId(dialogId, userId);\n\n\t\tif (!this.#alreadyWriting(chat, userId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst newWritingList = chat.writingList.filter((item) => item.userId !== userId);\n\t\tthis.#updateChatWritingList(dialogId, newWritingList);\n\n\t\tthis.#clearTimer(timerId);\n\t}\n\n\t#alreadyWriting(chat: ImModelChat, userId: number): boolean\n\t{\n\t\treturn chat.writingList.some((el) => el.userId === userId);\n\t}\n\n\t#buildTimerId(dialogId: string, userId: number): string\n\t{\n\t\treturn `${dialogId}|${userId}`;\n\t}\n\n\t#setTimer(dialogId: string, userId: number): number\n\t{\n\t\tconst writingStatusTime = this.#getWritingTime(dialogId);\n\n\t\treturn setTimeout(() => {\n\t\t\tthis.stopWriting({ dialogId, userId });\n\t\t}, writingStatusTime);\n\t}\n\n\t#clearTimer(timerId: string): void\n\t{\n\t\tclearTimeout(this.#writingTimers[timerId]);\n\t\tdelete this.#writingTimers[timerId];\n\t}\n\n\t#updateChatWritingList(dialogId: string, writingList: WritingListItem[]): void\n\t{\n\t\tCore.getStore().dispatch('chats/update', {\n\t\t\tdialogId,\n\t\t\tfields: { writingList },\n\t\t});\n\t}\n\n\t#getWritingTime(dialogId: string): number\n\t{\n\t\tconst chat = this.#getChat(dialogId);\n\n\t\treturn writingTimeByChatType[chat.type] ?? writingTimeByChatType.default;\n\t}\n\n\t#getChat(dialogId: string): ImModelChat | null\n\t{\n\t\treturn Core.getStore().getters['chats/get'](dialogId);\n\t}\n}\n"],"names":["writingTimeByChatType","ChatType","copilot","default","WritingManager","getInstance","startWriting","payload","dialogId","userId","userName","chat","timerId","newWritingList","writingList","stopWriting","filter","item","some","el","writingStatusTime","setTimeout","clearTimeout","Core","getStore","dispatch","fields","type","getters"],"mappings":"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"}