this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r,s){"use strict";const i={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const a={_tagsReplacement:[],_putReplacement:[],_sendReplacement:[],_codeReplacement:[],clean(){this._tagsReplacement=[];this._putReplacement=[];this._sendReplacement=[];this._codeReplacement=[]},cutTags(e){e=e.replaceAll(/\[(.+?)](.*?)\[\/(.+?)]/gi,(e=>{const t=this._tagsReplacement.length;this._tagsReplacement.push(e);return"####REPLACEMENT_TAG_"+t+"####"}));return e},recoverTags(e){this._tagsReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_TAG_"+r+"####",t)}));return e},cutPutTag(e){e=e.replace(/\[PUT(?:=(.+?))?](.+?)?\[\/PUT]/gi,(e=>{const t=this._putReplacement.length;this._putReplacement.push(e);return"####REPLACEMENT_PUT_"+t+"####"}));return e},recoverPutTag(e){this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}));return e},cutSendTag(e){e=e.replace(/\[SEND(?:=(.+?))?](.+?)?\[\/SEND]/gi,(e=>{const t=this._sendReplacement.length;this._sendReplacement.push(e);return"####REPLACEMENT_SEND_"+t+"####"}));return e},recoverSendTag(e){this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}));return e},cutCodeTag(e){e=e.replace(/\[CODE](<br \/>)?(.*?)\[\/CODE]/gis,(e=>{const t=this._codeReplacement.length;this._codeReplacement.push(e);return"####REPLACEMENT_CODE_"+t+"####"}));return e},recoverCodeTag(e){this._codeReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_CODE_"+r+"####",t)}));if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}return e},recoverRecursionTag(e){if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this._putReplacement.length>0){do{this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const n=s.Extension.getSettings("im.v2.lib.parser");const c=n.get("v2");const o=()=>c?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const l=()=>c?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const g=()=>c?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const d=()=>c?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const u=()=>c?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const p=()=>{if(c){const e=BX.Messenger.v2.Const.Settings.message.bigSmiles;return o().getStore().getters["application/settings/get"](e)}return o().getStore().getters["application/getOption"]("bigSmileEnable")};const m=10;const h={recursiveReplace(e,t,r){if(!s.Type.isStringFilled(e)){return e}let i=0;let a=true;do{a=false;i++;e=e.replace(t,((...e)=>{a=true;return r(...e)}))}while(a&&i<=m);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,a]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(o().getUserId()===s){return`${i}/${a}}`}if(o().getUserId()===i){return`${s}/${a}}`}return""}};const{FileType:f,FileIconType:T,AttachDescription:E}=d();const x={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:r,files:i}=e;if(s.Type.isArrayFilled(i)||i===true){t=this.getTextForFile(t,i)}else if(r===true||s.Type.isArrayFilled(r)||s.Type.isStringFilled(r)){t=this.getTextForAttach(t,r)}return t.trim()},getQuoteBlock(){const e=this.getIcon(T.quote);if(e){return e}return`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(T.code);if(e){return e}return`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(T.image);if(e){return e}return`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(T.file);if(e){return e}return`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let r=e;if(s.Type.isArray(t)&&t.length>0){const[s]=t;r=this.getIconTextForFile(e,s)}else if(t===true){r=this.getIconTextForFileType(e,T.file)}return r},getTextForAttach(e,t){let r="";if(s.Type.isArray(t)&&t.length>0){const[e]=t;if(s.Type.isStringFilled(e.description)){r=e.description}}else if(s.Type.isStringFilled(t)){r=t}if(s.Type.isStringFilled(r)){if(r===E.skipMessage){r=""}else{r=J.purifyText(r,{showPhraseMessageWasDeleted:false})}}else{const e=this.getIcon(T.attach);if(e){r=`${e} ${s.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{r=`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${r}`.trim()},getIconTextForFileType(e,t=T.file){let r=e;const i=this.getIcon(t);const a=s.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(i){const t=e.replace(/(\s|\n)/gi,"").length>0;const s=t?e:a;r=`${i} ${s}`}else{r=`[${a}] ${e}`}return r.trim()},getIconTextForFile(e,t){const r=e.replace(/(\s|\n)/gi,"").length>0;if(!t||!t.type){return e}if(t.type===f.image){return this.getIconTextForFileType(e,T.image)}else if(t.type===f.audio){return this.getIconTextForFileType(e,T.audio)}else if(t.type===f.video){return this.getIconTextForFileType(e,T.video)}else{const i=this.getIcon(T.file);if(i){const s=r?e:"";e=`${i} ${t.name} ${s}`}else{e=`${s.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${t.name} ${e}`}return e.trim()}}};let b=e=>e,_,y;const{EventType:R}=d();const M="&gt;&gt;";const I={decodeArrowQuote(e){if(!e.includes(M)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(M)){continue}const s=e;const i='<div class="bx-im-message-quote --inline">';const a='<div class="bx-im-message-quote__wrap">';const n="</div>";r[s]=r[s].replace(M,`${i}${a}`);while(++e<r.length&&r[e].startsWith(M)){r[e]=r[e].replace(M,"")}const c=e-1;r[c]+=`${n}${n}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${M}(.*))`,"gim"),x.getQuoteBlock()+t);return e},decodeQuote(e){e=a.cutTags(e);e=e.replace(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,t,r,i,a,n)=>{const c=!r||!i;if(c&&!n){n=`${i}`}let o="";if(!c){o=s.Tag.render(_||(_=b`
						<div class='bx-im-message-quote__name'>
							<div class="bx-im-message-quote__name-text">${0}</div>
							<div class="bx-im-message-quote__name-time">${0}</div>
						</div>
					`),r,i)}let l="bx-im-message-quote";if(a){a=a.trim().slice(1);a=h.getFinalContextTag(a)}if(a){l+=" --with-context"}else{a="none"}const g=s.Tag.render(y||(y=b`
					<div class='${0}' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),l,a,o,n);return g.outerHTML}));e=a.recoverTags(e);return e},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,x.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,r)=>s.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:r}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,x.getCodeBlock()+t)},executeClickEvent(e){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const r=l().dom.recursiveBackwardNodeSearch(e.target,"--with-context");if(!r||r.dataset.context==="none"){return}const[s,i]=r.dataset.context.split("/");t.EventEmitter.emit(R.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const S={decodeLink(e){return e.replaceAll(/>((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+[^<])?)<\/a>/gi,((e,t)=>{const r=s.Text.decode(t);if(!/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i.test(r)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}if(!l().text.checkUrl(r)){return e}const i=s.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[s.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:r},events:{error(){S.hideErrorImage(this)}}})]}).outerHTML;return`>${i}</a>`}))},purifyLink(e){e=e.replace(/(.)?((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+)?)/gi,(function(e,t,r){if(t&&![">","]"," "].includes(t)||!r.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else{return(t?t:"")+x.getImageBlock()}}));return e},decodeIcon(e){let t=0;const r=p();if(r){t=e.replaceAll(/\[icon=([^\]]*)]/gi,"").trim().length}return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let i=e.match(/icon=(\S+[^\s!"'),.;>?\]])/i);if(i&&i[1]){i=i[1]}else{return""}if(!l().text.checkUrl(i)){return e}const a={src:i,border:0};const n=e.match(/size=(\d+)/i);if(n&&n[1]){a.width=n[1];a.height=n[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){a.width=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){a.height=r[1]}if(a.width&&!a.height){a.height=a.width}else if(a.height&&!a.width){a.width=a.height}else if(a.height&&a.width);else{a.width=20;a.height=20}}a.width=a.width>100?100:a.width;a.height=a.height>100?100:a.height;if(r&&t===0&&a.width===a.height&&a.width===20){a.width=40;a.height=40}let c=e.match(/title=(.*[^\s\]])/i);if(c&&c[1]){c=c[1];if(c.includes("width=")){c=c.slice(0,Math.max(0,c.indexOf("width=")))}if(c.includes("height=")){c=c.slice(0,Math.max(0,c.indexOf("height=")))}if(c.includes("size=")){c=c.slice(0,Math.max(0,c.indexOf("size=")))}if(c){a.title=s.Text.decode(c).trim();a.alt=a.title}}return s.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...a}}).outerHTML}))},purifyIcon(e){return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.includes("width=")){t=t.slice(0,Math.max(0,t.indexOf("width=")))}if(t.includes("height=")){t=t.slice(0,Math.max(0,t.indexOf("height=")))}if(t.includes("size=")){t=t.slice(0,Math.max(0,t.indexOf("size=")))}if(t){t=`(${t.trim()})`}}else{t=`(${s.Loc.getMessage("IM_PARSER_IMAGE_ICON")})`}return t}))},hideErrorImage(e){const t=e;if(t&&t.parentNode){t.parentNode.innerHTML=`<a href="${encodeURI(e.src)}" target="_blank">${e.src}</a>`}}};let L=e=>e,N;const A=Object.freeze({Default:1,Big:1.6});const v=(e,t,r=A)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const a=new RegExp(`(?:(?:${t})\\s*){4,}`);if(i&&!a.test(e)){return r.Big}return r.Default};const C=e=>{const t=e.reduce(((e,t)=>{const{image:r,typing:i,definition:a,name:n,width:c,height:o}=t;const l=s.Tag.render(N||(N=L`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
				draggable="false"
			/>
		`),r,i,a,n!=null?n:i,i,c,o);return{...e,[i]:l}}),{});return t};const P=function(e,t,r){const s=e.slice(0,r+t.length);const i=l().text.escapeRegex(t);const a=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(a)};const $={typings:null,pattern:"",loadSmilePatterns(){var e,t;const r=u().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];if(s.length===0){return}const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>l().text.escapeRegex(e.typing))).join("|");this.typings=C(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let r;if(s.Type.isBoolean(t.enableBigSmile)){r=t.enableBigSmile}else{r=p()}const i=s.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:A;const a=r?v(e,this.pattern,i):i.Default;const n=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const c=new RegExp(n,"g");const o=e.replaceAll(c,((t,r)=>{const i=P.call(this,e,t,r);if(!i){return t}const n=this.typings[t].cloneNode();const{width:c,height:o}=n.style;s.Dom.style(n,"width",`${Number.parseInt(c,10)*a}px`);s.Dom.style(n,"height",`${Number.parseInt(o,10)*a}px`);return n.outerHTML}));return o}};const w={decode(e,t={}){const{urlTarget:r="_blank",removeLinks:i=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,i)=>{const a=s.Text.decode(t||i);if(!l().text.checkUrl(a)){return i}return s.Dom.create({tag:"a",attrs:{href:a,target:r},html:i}).outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,i)=>{let a=s.Text.decode(t||i);if(!l().text.checkUrl(a)){return i}if(!a.slice(a.lastIndexOf("[")).includes("]")){if(i.startsWith("]")){a=`${a}]`;i=i.slice(1)}else if(i.startsWith("=")){const e=s.Text.decode(i.slice(1,i.lastIndexOf("]")));a=`${a}]=${e}`;i=i.slice(i.lastIndexOf("]")+1)}}return s.Dom.create({tag:"a",attrs:{href:a,target:r},html:i}).outerHTML}));if(i){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e}};const F={decode(e){e=h.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=h.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=h.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=h.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return s.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:r}).outerHTML}));e=h.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>s.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));return e},purify(e,t=true){if(t){e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=h.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=h.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};let D=e=>e,B;const k={decode(e){let t=e;t=t.replaceAll(/\[like]/gi,`<span class="bx-im-lines-vote-like" title="${s.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}"></span>`);t=t.replaceAll(/\[dislike]/gi,`<span class="bx-im-lines-vote-dislike" title="${s.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}"></span>`);t=t.replaceAll(/\[rating=([1-5])]/gi,((e,t)=>{const r=s.Tag.render(B||(B=D`
				<span class="bx-im-lines-rating" title="${0} - ${0}">
					<span class="bx-im-lines-rating-selected" style="width: ${0}%"></span>
				</span>
			`),s.Loc.getMessage("IM_PARSER_LINES_RATING"),t,t*20);return r.outerHTML}));return t},purify(e){let t=e;t=t.replaceAll(/\[like]/gi,s.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));t=t.replaceAll(/\[dislike]/gi,s.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));t=t.replaceAll(/\[rating=([1-5])]/gi,(()=>`[${s.Loc.getMessage("IM_PARSER_LINES_RATING")}] `));return t}};const{EventType:O}=d();const U="\\d{4}-\\d{2}-\\d{2}T[0-2]\\d:[0-5]\\d:[0-5]\\d[+-][0-2]\\d:[0-5]\\d";const j={put:"put",send:"send"};const H={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=s.Text.decode(r);t=s.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("put",r,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=s.Text.decode(r);t=s.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",r,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},decodeDate(e){e=e.replace(RegExp("\\[DATE=("+U+")](.+?)\\[\\/DATE]","ig"),((e,t,r)=>{r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("date",r,t)}));return e},purifyDate(e){const t=l().date.atomRegexpString;e=e.replace(RegExp("[DATE=("+t+")](.+?)[/DATE]","ig"),((e,t,r)=>r));return e},_getHtmlForAction(e,t,r){return s.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[s.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),s.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:r})]}).outerHTML},executeClickEvent(e){if(!s.Dom.hasClass(e.target,"bx-im-message-command")){return}const r=e.target;if(r.dataset.entity===j.put){const{innerText:e=""}=r.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}t.EventEmitter.emit(O.textarea.insertText,{text:e})}else if(r.dataset.entity===j.send){const{innerText:e=""}=r.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}t.EventEmitter.emit(O.textarea.sendMessage,{text:e})}}};const{MessageMentionType:X}=d();const q={decode(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>{if(!r){return e}let i="";if(t){i=t}else if(l.call.isNumber(r)){i=r}else{return e}return s.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":X.call,"data-destination":i},text:s.Text.decode(r)}).outerHTML}));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>""));return t},purify(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>r||t));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>r));return t}};const{EventType:Q,MessageMentionType:z}=d();const W={decode(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,i)=>{t=Number.parseInt(t,10);if(!s.Type.isNumber(t)||t===0){return i}if(r||!i){const e=o().getStore().getters["users/get"](t);if(e){i=e.name}}else{i=s.Text.decode(i)}if(!i){i=`User ${t}`}let a="bx-im-mention";if(o().getUserId()===t){a+=" --highlight"}return s.Dom.create({tag:"span",attrs:{className:a,"data-type":z.user,"data-value":t},text:i}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,r,i)=>{if(r===0){return i}let a=i;if(a){a=s.Text.decode(a)}else{const e=o().store.getters["chats/get"](`chat${r}`);a=e?e.name:`Chat ${r}`}return s.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":t?z.lines:z.chat,"data-value":t?`imol|${r}`:`chat${r}`},text:a}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,r,i)=>{if(!i){return""}i=s.Text.decode(i);t=h.getFinalContextTag(t);if(!t){return i}const a=t.split("/")[0];let n="";r=Number.parseInt(r,10);if(s.Type.isNumber(r)&&r>0){const e=o().store.getters["messages/getById"](r);if(e){n=J.purifyMessage(e);const t=o().store.getters["users/get"](e.authorId);if(t){n=`${t.name}: ${n}`}}}if(!s.Type.isStringFilled(n)){n=s.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return s.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":z.context,"data-dialog-id":a,"data-message-id":r,title:n},text:i}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,i)=>{t=Number.parseInt(t,10);if(!s.Type.isNumber(t)||t===0){return i}if(r||!i){const e=o().getStore().getters["users/get"](t);if(e){i=e.name}}else{i=s.Text.decode(i)}if(!i){i=`User ${t}`}return i}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=o().store.getters["chats/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=o().store.getters["chats/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e){if(!s.Dom.hasClass(e.target,"bx-im-mention")){return}if(e.target.dataset.type===z.user||e.target.dataset.type===z.chat){void r.Messenger.openChat(e.target.dataset.value)}else if(e.target.dataset.type===z.lines){const t=e.target.dataset.value;if(l().dialog.isLinesHistoryId(t)){void r.Messenger.openLinesHistory(t)}else if(l().dialog.isLinesExternalId(t)){void r.Messenger.openLines(t)}}else if(e.target.dataset.type===z.context){t.EventEmitter.emit(Q.dialog.goToMessageContext,{messageId:Number.parseInt(e.target.dataset.messageId,10),dialogId:e.target.dataset.dialogId.toString()})}else if(e.target.dataset.type===z.call){if(l().call.isNumber(e.target.dataset.destination)){void r.Messenger.startPhoneCall(e.target.dataset.destination)}}}};const G={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const{FileIconType:Y}=d();const K={decode(e){const t=x.getIcon(Y.file);let r;if(t){r=`${t} ${s.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}`}else{r=`[${s.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`}e=e.replace(/\[disk=\d+]/gi,r);return e},purify(e){return this.decode(e)}};const J={decodeMessage(e){const t=o().store.getters["messages/getMessageFiles"](e.id);return this.decode({text:e.text,attach:e.attach,files:t,replaces:e.replaces,showIconIfEmptyText:false})},decodeNotification(e){var t;return this.decode({text:e.text,attach:(t=e.params.attach)!=null?t:false,replaces:e.replaces,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmile(e,t){return $.decodeSmile(e,t)},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return $.decodeSmile(e,r)},decode(e){if(!s.Type.isPlainObject(e)){g().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:r=false,files:n=false,removeLinks:c=false,showIconIfEmptyText:o=true,showImageFromLink:l=true,urlTarget:d="_blank"}=e;if(!s.Type.isString(t)){if(s.Type.isNumber(t)){return t.toString()}return""}if(!t){if(o){t=x.addIconToShortText({text:t,attach:r,files:n})}return t.trim()}t=s.Text.encode(t.trim());t=G.decodeNewLine(t);t=G.decodeTabulation(t);t=a.cutPutTag(t);t=a.cutSendTag(t);t=a.cutCodeTag(t);t=$.decodeSmile(t);t=i.decode(t);t=w.decode(t,{urlTarget:d,removeLinks:c});t=F.decode(t);t=k.decode(t);t=W.decode(t);t=q.decode(t);t=S.decodeIcon(t);if(l){t=S.decodeLink(t)}t=K.decode(t);t=H.decodeDate(t);t=I.decodeArrowQuote(t);t=I.decodeQuote(t);t=a.recoverSendTag(t);t=H.decodeSend(t);t=a.recoverPutTag(t);t=H.decodePut(t);t=a.recoverCodeTag(t);t=I.decodeCode(t);t=a.recoverRecursionTag(t);t=G.removeDuplicateTags(t);a.clean();return t},purifyMessage(e){const t=o().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:e.attach,files:t})},purifyNotification(e){var t;const r=o().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.attach)!=null?t:false,files:r})},purifyRecent(e){const{files:t,attach:r}=this.prepareConfigForRecent(e);return this.purify({text:e.message.text,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})},purifyText(e){return this.purify({text:e})},purify(e){if(!s.Type.isPlainObject(e)){g().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:r=false,files:a=false,showPhraseMessageWasDeleted:n=true}=e;if(!s.Type.isString(t)){t=s.Type.isNumber(t)?t.toString():""}if(!t){t=x.addIconToShortText({text:t,attach:r,files:a});return t.trim()}t=s.Text.encode(t.trim());t=G.purifyNewLine(t,"\n");t=i.purify(t);t=I.purifyArrowQuote(t);t=I.purifyQuote(t);t=I.purifyCode(t);t=H.purifyPut(t);t=H.purifySend(t);t=W.purify(t);t=F.purify(t);t=k.purify(t);t=q.purify(t);t=w.purify(t);t=S.purifyLink(t);t=S.purifyIcon(t);t=K.purify(t);t=G.purifyNewLine(t);t=x.addIconToShortText({text:t,attach:r,files:a});if(t.length>0){t=s.Text.decode(t)}else if(n){t=s.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e,t=""){const{id:r,attach:i}=e;let a=t===""?e.text:t;const n=o().store.getters["messages/getMessageFiles"](r);a=s.Text.encode(a.trim());a=W.purify(a);a=q.purify(a);a=k.purify(a);a=G.purifyBreakLine(a,"\n");a=G.purifyNbsp(a);a=w.removeSimpleUrlTag(a);a=I.purifyCode(a," ");a=I.purifyQuote(a," ");a=I.purifyArrowQuote(a," ");if(t===""){a=x.addIconToShortText({text:a,attach:i,files:n})}a=a.length>0?s.Text.decode(a):s.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return a.trim()},prepareEdit(e){let{text:t}=e;t=w.removeSimpleUrlTag(t);return t.trim()},prepareCopy(e){let{text:t}=e;t=w.removeSimpleUrlTag(t);return t.trim()},prepareCopyFile(e){const{id:t}=e;const r=o().store.getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));return r.join("\n").trim()},prepareConfigForRecent(e){let t=false;const r=e.message.params.withFile;if(s.Type.isBoolean(r)){t=r}else if(s.Type.isPlainObject(r)){t=[r]}let i=false;const a=e.message.params.withAttach;if(s.Type.isBoolean(a)||s.Type.isStringFilled(a)||s.Type.isArray(a)){i=a}else if(s.Type.isPlainObject(a)){i=[a]}return{files:t,attach:i}},executeClickEvent(e){W.executeClickEvent(e);I.executeClickEvent(e);H.executeClickEvent(e)},getContextCodeFromForwardId(e){return h.getFinalContextTag(e)}};e.Parser=J})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=parser.bundle.map.js