this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r){"use strict";const s={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const i=r.Extension.getSettings("im.v2.lib.parser");const a=i.get("v2");const n=()=>a?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const c=()=>a?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const o=()=>a?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const l=()=>a?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const g=()=>a?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const u=()=>{if(a){const e=BX.Messenger.v2.Const.Settings.dialog.bigSmiles;return n().getStore().getters["application/settings/get"](e)}return n().getStore().getters["application/getOption"]("bigSmileEnable")};const d=10;const p={recursiveReplace(e,t,s){if(!r.Type.isStringFilled(e)){return e}let i=0;let a=true;do{a=false;i++;e=e.replace(t,((...e)=>{a=true;return s(...e)}))}while(a&&i<=d);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,a]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(n().getUserId()===s){return`${i}/${a}}`}if(n().getUserId()===i){return`${s}/${a}}`}return""}};const{FileType:f,FileIconType:m,AttachDescription:h}=l();const T={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:s,files:i}=e;if(r.Type.isArrayFilled(i)||i===true){t=this.getTextForFile(t,i)}else if(s===true||r.Type.isArrayFilled(s)||r.Type.isStringFilled(s)){t=this.getTextForAttach(t,s)}return t.trim()},getQuoteBlock(){const e=this.getIcon(m.quote);if(e){return e}return`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(m.code);if(e){return e}return`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(m.image);if(e){return e}return`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(m.file);if(e){return e}return`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let s=e;if(r.Type.isArray(t)&&t.length>0){const[r]=t;s=this.getIconTextForFile(e,r)}else if(t===true){s=this.getIconTextForFileType(e,m.file)}return s},getTextForAttach(e,t){let s="";if(r.Type.isArray(t)&&t.length>0){const[e]=t;if(r.Type.isStringFilled(e.DESCRIPTION)){s=e.DESCRIPTION}}else if(r.Type.isStringFilled(t)){s=t}if(r.Type.isStringFilled(s)){if(s===h.SKIP_MESSAGE){s=""}else{s=W.purifyText(s,{showPhraseMessageWasDeleted:false})}}else{const e=this.getIcon(m.attach);if(e){s=`${e} ${r.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{s=`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${s}`.trim()},getIconTextForFileType(e,t=m.file){let s=e;const i=this.getIcon(t);const a=r.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(i){const t=e.replace(/(\s|\n)/gi,"").length>0;const r=t?e:a;s=`${i} ${r}`}else{s=`[${a}] ${e}`}return s.trim()},getIconTextForFile(e,t){const s=e.replace(/(\s|\n)/gi,"").length>0;if(!t||!t.type){return e}if(t.type===f.image){return this.getIconTextForFileType(e,m.image)}else if(t.type===f.audio){return this.getIconTextForFileType(e,m.audio)}else if(t.type===f.video){return this.getIconTextForFileType(e,m.video)}else{const i=this.getIcon(m.file);if(i){const r=s?e:"";e=`${i} ${t.name} ${r}`}else{e=`${r.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${t.name} ${e}`}return e.trim()}}};let E=e=>e,x,b;const{EventType:_}=l();const I="&gt;&gt;";const y={decodeArrowQuote(e){if(!e.includes(I)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(I)){continue}const s=e;const i='<div class="bx-im-message-quote --inline">';const a='<div class="bx-im-message-quote__wrap">';const n="</div>";r[s]=r[s].replace(I,`${i}${a}`);while(++e<r.length&&r[e].startsWith(I)){r[e]=r[e].replace(I,"")}const c=e-1;r[c]+=`${n}${n}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${I}(.*))`,"gim"),T.getQuoteBlock()+t);return e},decodeQuote(e){e=e.replace(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,t,s,i,a,n)=>{const c=!s||!i;if(c&&!n){n=`${i}`}let o="";if(!c){o=r.Tag.render(x||(x=E`
						<div class='bx-im-message-quote__name'>
							<div class="bx-im-message-quote__name-text">${0}</div>
							<div class="bx-im-message-quote__name-time">${0}</div>
						</div>
					`),s,i)}let l="bx-im-message-quote";if(a){a=a.trim().slice(1);a=p.getFinalContextTag(a)}if(a){l+=" --with-context"}else{a="none"}const g=r.Tag.render(b||(b=E`
					<div class='${0}' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),l,a,o,n);return g.outerHTML}));return e},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,T.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,s)=>r.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:s}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,T.getCodeBlock()+t)},executeClickEvent(e){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const r=c().dom.recursiveBackwardNodeSearch(e.target,"--with-context");if(!r||r.dataset.context==="none"){return}const[s,i]=r.dataset.context.split("/");t.EventEmitter.emit(_.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const R={decodeLink(e){e=e.replace(/(.)?((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+)?)/gi,(function(e,t,s){s=r.Text.decode(s);if(t&&![">","]"].includes(t)||!s.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||s.toLowerCase().indexOf("/docs/pub/")>0||s.toLowerCase().indexOf("logout=yes")>0){return e}if(!c().text.checkUrl(s)){return e}return(t?t:"")+r.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[r.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:s},events:{error:()=>{R._hideErrorImage(this)}}})]}).outerHTML}));return e},purifyLink(e){e=e.replace(/(.)?((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+)?)/gi,(function(e,t,r){if(t&&![">","]"," "].includes(t)||!r.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else{return(t?t:"")+T.getImageBlock()}}));return e},decodeIcon(e){let t=0;const s=u();if(s){t=e.replace(/\[icon=([^\]]*)]/gi,"").trim().length}e=e.replace(/\[icon=([^\]]*)]/gi,(e=>{let i=e.match(/icon=(\S+[^\s.,> )\];'"!?])/i);if(i&&i[1]){i=i[1]}else{return""}if(!c().text.checkUrl(i)){return e}const a={src:i,border:0};const n=e.match(/size=(\d+)/i);if(n&&n[1]){a["width"]=n[1];a["height"]=n[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){a["width"]=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){a["height"]=r[1]}if(a["width"]&&!a["height"]){a["height"]=a["width"]}else if(a["height"]&&!a["width"]){a["width"]=a["height"]}else if(a["height"]&&a["width"]);else{a["width"]=20;a["height"]=20}}a["width"]=a["width"]>100?100:a["width"];a["height"]=a["height"]>100?100:a["height"];if(s&&t===0&&a["width"]===a["height"]&&a["width"]===20){a["width"]=40;a["height"]=40}let o=e.match(/title=(.*[^\s\]])/i);if(o&&o[1]){o=o[1];if(o.indexOf("width=")>-1){o=o.substr(0,o.indexOf("width="))}if(o.indexOf("height=")>-1){o=o.substr(0,o.indexOf("height="))}if(o.indexOf("size=")>-1){o=o.substr(0,o.indexOf("size="))}if(o){a["title"]=r.Text.decode(o).trim();a["alt"]=a["title"]}}return r.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...a}}).outerHTML}));return e},purifyIcon(e){e=e.replace(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.indexOf("width=")>-1){t=t.substr(0,t.indexOf("width="))}if(t.indexOf("height=")>-1){t=t.substr(0,t.indexOf("height="))}if(t.indexOf("size=")>-1){t=t.substr(0,t.indexOf("size="))}if(t){t="("+t.trim()+")"}}else{t="("+r.Loc.getMessage("IM_PARSER_IMAGE_ICON")+")"}return t}));return e},_hideErrorImage(e){if(e.parentNode){e.parentNode.innerHTML='<a href="'+encodeURI(e.src)+'" target="_blank">'+e.src+"</a>"}}};let S=e=>e,L;const M=Object.freeze({Default:1,Big:1.6});const N=(e,t,r=M)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const a=new RegExp(`(?:(?:${t})\\s*){3,}`);if(i&&!a.test(e)){return r.Big}return r.Default};const A=e=>{const t=e.reduce(((e,t)=>{const{image:s,typing:i,definition:a,name:n,width:c,height:o}=t;const l=r.Tag.render(L||(L=S`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
			/>
		`),s,i,a,n!=null?n:i,i,c,o);return{...e,[i]:l}}),{});return t};const C=function(e,t,r){const s=e.slice(0,r+t.length);const i=c().text.escapeRegex(t);const a=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(a)};const P={typings:null,pattern:"",loadSmilePatterns(){var e,t;const r=g().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>c().text.escapeRegex(e.typing))).join("|");this.typings=A(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let s;if(r.Type.isBoolean(t.enableBigSmile)){s=t.enableBigSmile}else{s=u()}const i=r.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:M;const a=s?N(e,this.pattern,i):i.Default;const n=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const c=new RegExp(n,"g");const o=e.replaceAll(c,((t,s)=>{const i=C.call(this,e,t,s);if(!i){return t}const n=this.typings[t].cloneNode();const{width:c,height:o}=n.style;r.Dom.style(n,"width",`${Number.parseInt(c,10)*a}px`);r.Dom.style(n,"height",`${Number.parseInt(o,10)*a}px`);return n.outerHTML}));return o}};const v={decode(e,t={}){const{urlTarget:s="_blank",removeLinks:i=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,i)=>{const a=r.Text.decode(t||i);if(!c().text.checkUrl(a)){return i}return r.Dom.create({tag:"a",attrs:{href:a,target:s},html:i}).outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,i)=>{let a=r.Text.decode(t||i);if(!c().text.checkUrl(a)){return i}if(!a.slice(a.lastIndexOf("[")).includes("]")){if(i.startsWith("]")){a=`${a}]`;i=i.slice(1)}else if(i.startsWith("=")){const e=r.Text.decode(i.slice(1,i.lastIndexOf("]")));a=`${a}]=${e}`;i=i.slice(i.lastIndexOf("]")+1)}}return r.Dom.create({tag:"a",attrs:{href:a,target:s},html:i}).outerHTML}));if(i){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e}};const $={decode(e){e=p.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=p.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=p.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=p.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=p.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,s)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return r.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:s}).outerHTML}));e=p.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,s)=>r.Dom.create({tag:"span",style:{color:"#"+t},html:s}).outerHTML));return e},purify(e,t=true){if(t){e=p.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=p.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=p.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=p.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=p.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=p.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=p.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};const w={decode(e){e=e.replace(/\[LIKE]/gi,`<span style="color: #004d00">${r.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}</span>`);e=e.replace(/\[DISLIKE]/gi,`<span style="color: #cc0000">${r.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}</span>`);e=e.replace(/\[RATING=([1-5])]/gi,((e,t)=>{e=parseInt(t);return`<span class="bx-smile bx-im-smile-rating bx-im-smile-rating-'+rating+'">${r.Loc.getMessage("IM_PARSER_LINES_RATING")} - ${e}</span>`}));return e},purify(e){e=e.replace(/\[LIKE]/gi,r.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));e=e.replace(/\[DISLIKE]/gi,r.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));e=e.replace(/\[RATING=([1-5])]/gi,(()=>"["+r.Loc.getMessage("IM_PARSER_LINES_RATING")+"] "));return e}};const D="\\d{4}-\\d{2}-\\d{2}T[0-2]\\d:[0-5]\\d:[0-5]\\d[+-][0-2]\\d:[0-5]\\d";const F={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,s)=>{s=s?s:t;t=t?t:s;s=r.Text.decode(s);t=r.Text.decode(t).replace("<br />","\n");if(!s.trim()){return""}s=s.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",s);s=s.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",s);return this._getHtmlForAction("put",s,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,s)=>{s=s?s:t;t=t?t:s;s=r.Text.decode(s);t=r.Text.decode(t).replace("<br />","\n");if(!s.trim()){return""}s=s.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",s);s=s.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",s);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",s,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},decodeDate(e){e=e.replace(RegExp("\\[DATE=("+D+")](.+?)\\[\\/DATE]","ig"),((e,t,r)=>{r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("date",r,t)}));return e},purifyDate(e){const t=c().date.atomRegexpString;e=e.replace(RegExp("[DATE=("+t+")](.+?)[/DATE]","ig"),((e,t,r)=>r));return e},_getHtmlForAction(e,t,s){return r.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[r.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),r.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:s})]}).outerHTML}};const O={decode(e){e=e.replace(/\[CALL(?:=([-+\d()./# ]+))?](.+?)\[\/CALL]/gi,((e,t,s)=>{if(!s){return e}if(!t){if(s.match(/^([-+\d()./# ]+)$/)){t=s}else{return e}}s=r.Text.decode(s);return r.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":"CALL","data-value":t},text:s}).outerHTML}));e=e.replace(/\[PCH=([0-9]+)](.*?)\[\/PCH]/gi,((e,t,r)=>r));return e},purify(e){e=e.replace(/\[CALL(?:=([-+\d()./# ]+))?](.+?)\[\/CALL]/gi,((e,t,r)=>r?r:t));e=e.replace(/\[PCH=([0-9]+)](.*?)\[\/PCH]/gi,((e,t,r)=>r));return e}};const{EventType:B,MessageMentionType:U}=l();const k={decode(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,s,i)=>{t=Number.parseInt(t,10);if(!r.Type.isNumber(t)||t===0){return i}if(s||!i){const e=n().getStore().getters["users/get"](t);if(e){i=e.name}}else{i=r.Text.decode(i)}if(!i){i=`User ${t}`}return r.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":"USER","data-value":t},text:i}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,s,i)=>{s=Number.parseInt(s,10);if(!r.Type.isNumber(s)||s===0||t){return i}if(i){i=r.Text.decode(i)}else{const e=n().store.getters["dialogues/get"]("chat"+s);i=e?e.name:"Chat "+s}return r.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":"CHAT","data-value":"chat"+s},text:i}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,s,i)=>{if(!i){return""}i=r.Text.decode(i);t=p.getFinalContextTag(t);if(!t){return i}const a=t.split("/")[0];let c="";s=Number.parseInt(s,10);if(r.Type.isNumber(s)&&s>0){const e=n().store.getters["messages/getById"](s);if(e){c=W.purifyMessage(e);const t=n().store.getters["users/get"](e.authorId);if(t){c=`${t.name}: ${c}`}}}if(!r.Type.isStringFilled(c)){c=r.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return r.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":"CONTEXT","data-dialog-id":a,"data-message-id":s,title:c},text:i}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,s,i)=>{t=Number.parseInt(t,10);if(!r.Type.isNumber(t)||t===0){return i}if(s||!i){const e=n().getStore().getters["users/get"](t);if(e){i=e.name}}else{i=r.Text.decode(i)}if(!i){i=`User ${t}`}return i}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=n().store.getters["dialogues/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=n().store.getters["dialogues/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e){if(!r.Dom.hasClass(e.target,"bx-im-mention")){return}if(e.target.dataset.type===U.user||e.target.dataset.type===U.chat){t.EventEmitter.emit(B.mention.openChatInfo,{event:e,dialogId:e.target.dataset.value})}else if(e.target.dataset.type===U.context){t.EventEmitter.emit(B.dialog.goToMessageContext,{messageId:Number.parseInt(e.target.dataset.messageId,10),dialogId:e.target.dataset.dialogId.toString()})}}};const H={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const j={_startTagReplacement:[],_putReplacement:[],_sendReplacement:[],_codeReplacement:[],clean(){this._startTagReplacement=[];this._putReplacement=[];this._sendReplacement=[];this._codeReplacement=[]},cutStartTag(e){e=e.replace(/\[(.+?)]/gi,(e=>{if(e.startsWith("/")){return e}const t=this._startTagReplacement.length;this._startTagReplacement.push(e);return"####REPLACEMENT_TAG_"+t+"####"}));return e},recoverStartTag(e){this._startTagReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_TAG_"+r+"####",t)}));return e},cutPutTag(e){e=e.replace(/\[PUT(?:=(.+?))?](.+?)?\[\/PUT]/gi,(e=>{const t=this._putReplacement.length;this._putReplacement.push(e);return"####REPLACEMENT_PUT_"+t+"####"}));return e},recoverPutTag(e){this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}));return e},cutSendTag(e){e=e.replace(/\[SEND(?:=(.+?))?](.+?)?\[\/SEND]/gi,(e=>{const t=this._sendReplacement.length;this._sendReplacement.push(e);return"####REPLACEMENT_SEND_"+t+"####"}));return e},recoverSendTag(e){this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}));return e},cutCodeTag(e){e=e.replace(/\[CODE](<br \/>)?(.*?)\[\/CODE]/gis,(e=>{const t=this._codeReplacement.length;this._codeReplacement.push(e);return"####REPLACEMENT_CODE_"+t+"####"}));return e},recoverCodeTag(e){this._codeReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_CODE_"+r+"####",t)}));if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}return e},recoverRecursionTag(e){if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this._putReplacement.length>0){do{this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const X={decode(e,t=[]){if(t.length===0){return e}const r=t.reduce(((e,t)=>this.replaceDate(e,t)),e);return r},replaceDate(e,t){const r=e.substring(t.start,t.end);if(r!==t.text){return e}const s=e.substring(0,t.start);const i=e.substring(t.end);return s+"[DATE="+t.value+"]"+r+"[/DATE]"+i}};const{FileIconType:G}=l();const Q={decode(e){const t=T.getIcon(G.file);let s;if(t){s=`${t} ${r.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}`}else{s=`[${r.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`}e=e.replace(/\[disk=\d+]/gi,s);return e},purify(e){return this.decode(e)}};const W={decodeMessage(e){const t=n().store.getters["messages/getMessageFiles"](e.id);return this.decode({text:e.text,attach:e.attach,files:t,replaces:e.replaces,showIconIfEmptyText:false})},decodeNotification(e){var t;return this.decode({text:e.text,attach:(t=e.params.ATTACH)!=null?t:false,replaces:e.replaces,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return P.decodeSmile(e,r)},decode(e){if(!r.Type.isPlainObject(e)){o().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:i=false,files:a=false,replaces:n=[],removeLinks:c=false,showIconIfEmptyText:l=true,showImageFromLink:g=true,urlTarget:u="_blank"}=e;if(!r.Type.isString(t)){if(r.Type.isNumber(t)){return t.toString()}return""}if(!t){if(l){t=T.addIconToShortText({text:t,attach:i,files:a})}return t.trim()}t=X.decode(t,n);t=r.Text.encode(t.trim());t=H.decodeNewLine(t);t=H.decodeTabulation(t);t=j.cutPutTag(t);t=j.cutSendTag(t);t=j.cutCodeTag(t);t=P.decodeSmile(t);t=s.decode(t);t=y.decodeArrowQuote(t);t=y.decodeQuote(t);t=v.decode(t,{urlTarget:u,removeLinks:c});t=$.decode(t);t=w.decode(t);t=k.decode(t);t=O.decode(t);t=R.decodeIcon(t);if(g){t=R.decodeLink(t)}t=Q.decode(t);t=F.decodeDate(t);t=j.cutStartTag(t);t=j.recoverStartTag(t);t=j.recoverSendTag(t);t=F.decodeSend(t);t=j.recoverPutTag(t);t=F.decodePut(t);t=j.recoverCodeTag(t);t=y.decodeCode(t);t=j.recoverRecursionTag(t);t=H.removeDuplicateTags(t);j.clean();return t},purifyMessage(e){const t=n().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:e.attach,files:t})},purifyNotification(e){var t;const r=n().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.ATTACH)!=null?t:false,files:r})},purifyRecent(e){const{files:t,attach:r}=this.prepareConfigForRecent(e);return this.purify({text:e.message.text,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})},purifyText(e){return this.purify({text:e})},purify(e){if(!r.Type.isPlainObject(e)){o().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:i=false,files:a=false,showPhraseMessageWasDeleted:n=true}=e;if(!r.Type.isString(t)){t=r.Type.isNumber(t)?t.toString():""}if(!t){t=T.addIconToShortText({text:t,attach:i,files:a});return t.trim()}t=r.Text.encode(t.trim());t=H.purifyNewLine(t,"\n");t=s.purify(t);t=y.purifyArrowQuote(t);t=y.purifyQuote(t);t=y.purifyCode(t);t=F.purifyPut(t);t=F.purifySend(t);t=k.purify(t);t=$.purify(t);t=w.purify(t);t=O.purify(t);t=R.purifyLink(t);t=R.purifyIcon(t);t=v.purify(t);t=Q.purify(t);t=H.purifyNewLine(t);t=T.addIconToShortText({text:t,attach:i,files:a});if(t.length>0){t=r.Text.decode(t)}else if(n){t=r.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e){const{id:t,attach:s}=e;let{text:i}=e;const a=n().store.getters["messages/getMessageFiles"](t);i=r.Text.encode(i.trim());i=k.purify(i);i=O.purify(i);i=w.purify(i);i=H.purifyBreakLine(i,"\n");i=H.purifyNbsp(i);i=v.removeSimpleUrlTag(i);i=y.purifyCode(i," ");i=y.purifyQuote(i," ");i=y.purifyArrowQuote(i," ");i=T.addIconToShortText({text:i,attach:s,files:a});i=i.length>0?r.Text.decode(i):r.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return i.trim()},prepareEdit(e){let{text:t}=e;t=v.removeSimpleUrlTag(t);return t.trim()},prepareCopy(e){const{id:t}=e;let{text:r}=e;const s=n().store.getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));r=s.join("\n")+r;return r.trim()},prepareConfigForRecent(e){let t=false;const s=e.message.params.withFile;if(r.Type.isBoolean(s)){t=s}else if(r.Type.isPlainObject(s)){t=[s]}let i=false;const a=e.message.params.withAttach;if(r.Type.isBoolean(a)||r.Type.isStringFilled(a)||r.Type.isArray(a)){i=a}else if(r.Type.isPlainObject(a)){i=[a]}return{files:t,attach:i}},executeClickEvent(e){k.executeClickEvent(e);y.executeClickEvent(e)}};e.Parser=W})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX);
//# sourceMappingURL=parser.bundle.map.js