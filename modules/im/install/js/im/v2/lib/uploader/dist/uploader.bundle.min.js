this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,a){"use strict";const l={PENDING:0,PROGRESS:1,DONE:2,CANCELLED:3,FAILED:4};var t=babelHelpers.classPrivateFieldLooseKey("uploaderTask");var i=babelHelpers.classPrivateFieldLooseKey("status");var r=babelHelpers.classPrivateFieldLooseKey("listener");var o=babelHelpers.classPrivateFieldLooseKey("requestToDelete");var b=babelHelpers.classPrivateFieldLooseKey("token");var n=babelHelpers.classPrivateFieldLooseKey("nextDataChunkToSend");var d=babelHelpers.classPrivateFieldLooseKey("readOffset");var c=babelHelpers.classPrivateFieldLooseKey("init");var p=babelHelpers.classPrivateFieldLooseKey("createFileFromUploadedChunks");var v=babelHelpers.classPrivateFieldLooseKey("updateProgress");var h=babelHelpers.classPrivateFieldLooseKey("readNext");var P=babelHelpers.classPrivateFieldLooseKey("isEndOfFile");var L=babelHelpers.classPrivateFieldLooseKey("getUploadContentEndpoint");var F=babelHelpers.classPrivateFieldLooseKey("getCreateFileEndpoint");var u=babelHelpers.classPrivateFieldLooseKey("getDeleteContentEndpoint");var H=babelHelpers.classPrivateFieldLooseKey("getBaseEndpoint");var B=babelHelpers.classPrivateFieldLooseKey("getFileName");var f=babelHelpers.classPrivateFieldLooseKey("sendPostRequest");var E=babelHelpers.classPrivateFieldLooseKey("getContentRangeHeader");var y=babelHelpers.classPrivateFieldLooseKey("getBitrixSessid");class g{constructor(e){Object.defineProperty(this,y,{value:_});Object.defineProperty(this,E,{value:S});Object.defineProperty(this,f,{value:K});Object.defineProperty(this,B,{value:w});Object.defineProperty(this,H,{value:T});Object.defineProperty(this,u,{value:I});Object.defineProperty(this,F,{value:D});Object.defineProperty(this,L,{value:U});Object.defineProperty(this,P,{value:N});Object.defineProperty(this,h,{value:k});Object.defineProperty(this,v,{value:C});Object.defineProperty(this,p,{value:O});Object.defineProperty(this,c,{value:m});Object.defineProperty(this,t,{writable:true,value:void 0});Object.defineProperty(this,i,{writable:true,value:l.PENDING});Object.defineProperty(this,r,{writable:true,value:void 0});Object.defineProperty(this,o,{writable:true,value:false});Object.defineProperty(this,b,{writable:true,value:null});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:0});babelHelpers.classPrivateFieldLooseBase(this,t)[t]=e;babelHelpers.classPrivateFieldLooseBase(this,r)[r]=e.listener;this.abortController=new AbortController;babelHelpers.classPrivateFieldLooseBase(this,c)[c]()}uploadContent(){if(babelHelpers.classPrivateFieldLooseBase(this,i)[i]===l.CANCELLED){return}babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.PROGRESS;babelHelpers.classPrivateFieldLooseBase(this,h)[h]();babelHelpers.classPrivateFieldLooseBase(this,v)[v]();const e=babelHelpers.classPrivateFieldLooseBase(this,L)[L]();const s={"Content-Type":babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.type,"Content-Range":babelHelpers.classPrivateFieldLooseBase(this,E)[E](),"X-Bitrix-Csrf-Token":babelHelpers.classPrivateFieldLooseBase(this,y)[y]()};const a={url:e,headers:s,body:babelHelpers.classPrivateFieldLooseBase(this,n)[n],signal:this.abortController.signal};babelHelpers.classPrivateFieldLooseBase(this,f)[f](a).then((e=>{if(e.errors.length>0){babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.FAILED;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.uploadFileError,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t],result:e});console.error(e.errors[0].message)}else if(e.data.token){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=e.data.token;babelHelpers.classPrivateFieldLooseBase(this,d)[d]+=babelHelpers.classPrivateFieldLooseBase(this,t)[t].chunkSize;if(!babelHelpers.classPrivateFieldLooseBase(this,P)[P]()){this.uploadContent()}else{babelHelpers.classPrivateFieldLooseBase(this,p)[p]()}}})).catch((e=>{console.warn("error",e);babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.FAILED;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.uploadFileError,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t],result:e})}))}deleteContent(){this.abortController.abort();babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.CANCELLED;babelHelpers.classPrivateFieldLooseBase(this,o)[o]=true;if(!babelHelpers.classPrivateFieldLooseBase(this,b)[b]){console.error("Empty token.");return}const e=babelHelpers.classPrivateFieldLooseBase(this,u)[u]();const s={"X-Bitrix-Csrf-Token":babelHelpers.classPrivateFieldLooseBase(this,y)[y]()};babelHelpers.classPrivateFieldLooseBase(this,f)[f]({url:e,headers:s}).catch((e=>console.error(e)))}isPending(){return babelHelpers.classPrivateFieldLooseBase(this,i)[i]===l.PENDING}getTaskId(){return babelHelpers.classPrivateFieldLooseBase(this,t)[t].taskId}}function m(){babelHelpers.classPrivateFieldLooseBase(this,t)[t].progress=0;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.startUpload,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t]})}function O(){if(!babelHelpers.classPrivateFieldLooseBase(this,b)[b]){console.error("Empty token.");return}if(babelHelpers.classPrivateFieldLooseBase(this,o)[o]){return}const e=babelHelpers.classPrivateFieldLooseBase(this,F)[F]();const s={"X-Upload-Content-Type":babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.type,"X-Bitrix-Csrf-Token":babelHelpers.classPrivateFieldLooseBase(this,y)[y]()};const a=new FormData;if(babelHelpers.classPrivateFieldLooseBase(this,t)[t].previewBlob){a.append("previewFile",babelHelpers.classPrivateFieldLooseBase(this,t)[t].previewBlob,`preview_${babelHelpers.classPrivateFieldLooseBase(this,B)[B]()}.jpg`)}babelHelpers.classPrivateFieldLooseBase(this,f)[f]({url:e,headers:s,body:a}).then((e=>{if(e.errors.length>0){babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.FAILED;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.createFileError,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t],result:e});console.error(e.errors[0].message)}else{babelHelpers.classPrivateFieldLooseBase(this,v)[v]();babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.DONE;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.complete,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t],result:e})}})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,i)[i]=l.FAILED;babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.createFileError,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t],result:e})}))}function C(){babelHelpers.classPrivateFieldLooseBase(this,t)[t].progress=Math.round(babelHelpers.classPrivateFieldLooseBase(this,d)[d]*100/babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.size);babelHelpers.classPrivateFieldLooseBase(this,r)[r](G.EVENTS.progressUpdate,{task:babelHelpers.classPrivateFieldLooseBase(this,t)[t]})}function k(){if(babelHelpers.classPrivateFieldLooseBase(this,d)[d]+babelHelpers.classPrivateFieldLooseBase(this,t)[t].chunkSize>babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.size){babelHelpers.classPrivateFieldLooseBase(this,t)[t].chunkSize=babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.size-babelHelpers.classPrivateFieldLooseBase(this,d)[d]}babelHelpers.classPrivateFieldLooseBase(this,n)[n]=babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.slice(babelHelpers.classPrivateFieldLooseBase(this,d)[d],babelHelpers.classPrivateFieldLooseBase(this,d)[d]+babelHelpers.classPrivateFieldLooseBase(this,t)[t].chunkSize)}function N(){return babelHelpers.classPrivateFieldLooseBase(this,d)[d]>=babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.size}function U(){const e=babelHelpers.classPrivateFieldLooseBase(this,b)[b]?`&token=${babelHelpers.classPrivateFieldLooseBase(this,b)[b]}`:"";return`\n\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.UPLOAD_CHUNK_DEFAULT_ACTION)}\n\t\t\t&filename=${babelHelpers.classPrivateFieldLooseBase(this,B)[B]()}\n\t\t\t${e}\n\t\t`}function D(){const e=babelHelpers.classPrivateFieldLooseBase(this,t)[t].generateUniqueName?"&generateUniqueName=true":"";return`\n\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.COMMIT_FILE_DEFAULT_ACTION)}\n\t\t\t&filename=${babelHelpers.classPrivateFieldLooseBase(this,B)[B]()}\n\t\t\t&folderId=${babelHelpers.classPrivateFieldLooseBase(this,t)[t].diskFolderId}\n\t\t\t&contentId=${babelHelpers.classPrivateFieldLooseBase(this,b)[b]}\n\t\t\t${e}\n\t\t`}function I(){return`${babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.ROLLBACK_UPLOAD_DEFAULT_ACTION)}&token=${babelHelpers.classPrivateFieldLooseBase(this,b)[b]}`}function T(e){return`/bitrix/services/main/ajax.php?action=${e}`}function w(){return encodeURIComponent(babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileName||babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.name)}function K(e){const{url:s,headers:a,body:l,signal:t}=e;const i={method:"POST",credentials:"include",headers:a};if(t){i.signal=this.abortController.signal}if(l){i.body=l}return new Promise(((e,a)=>{fetch(s,i).then((s=>e(s.json()))).catch((e=>a(e)))}))}function S(){const e=babelHelpers.classPrivateFieldLooseBase(this,d)[d]+babelHelpers.classPrivateFieldLooseBase(this,t)[t].chunkSize-1;return`bytes ${babelHelpers.classPrivateFieldLooseBase(this,d)[d]}-${e}/${babelHelpers.classPrivateFieldLooseBase(this,t)[t].fileData.size}`}function _(){return BX.bitrix_sessid()}g.UPLOAD_CHUNK_DEFAULT_ACTION="disk.api.content.upload";g.COMMIT_FILE_DEFAULT_ACTION="disk.api.file.createByContent";g.ROLLBACK_UPLOAD_DEFAULT_ACTION="disk.api.content.rollbackUpload";const j={get(e){return new Promise(((s,a)=>{if(e instanceof File){if(e.type.startsWith("video")){j.getVideoPreviewBlob(e).then((e=>j.getImageDimensions(e))).then((e=>s(e))).catch((e=>a(e)))}else if(e.type.startsWith("image")){const l=new Blob([e],{type:e.type});j.getImageDimensions(l).then((e=>s(e))).catch((e=>a(e)))}else{s({})}}else{a(new Error('Parameter "file" is not instance of "File"'))}}))},getImageDimensions(e){return new Promise(((s,l)=>{if(!e){l(new Error("getImageDimensions: fileBlob can't be empty"))}const t=new Image;a.Event.bind(t,"load",(()=>{s({blob:e,width:t.width,height:t.height})}));a.Event.bind(t,"error",(()=>{l()}));t.src=URL.createObjectURL(e)}))},getVideoPreviewBlob(e,s=10){return new Promise(((l,t)=>{const i=document.createElement("video");i.setAttribute("src",URL.createObjectURL(e));i.load();a.Event.bind(i,"error",(e=>{t(new Error(`Error while loading video file: ${e}`))}));a.Event.bind(i,"loadedmetadata",(()=>{if(i.duration<s){s=0}i.currentTime=s;a.Event.bind(i,"seeked",(()=>{const e=document.createElement("canvas");e.width=i.videoWidth;e.height=i.videoHeight;const s=e.getContext("2d");s.drawImage(i,0,0,e.width,e.height);s.canvas.toBlob((e=>l(e)),"image/jpeg",1)}))}))}))}};var A=babelHelpers.classPrivateFieldLooseKey("queue");var M=babelHelpers.classPrivateFieldLooseKey("inputNode");var x=babelHelpers.classPrivateFieldLooseKey("dropNode");var z=babelHelpers.classPrivateFieldLooseKey("fileMaxSize");var X=babelHelpers.classPrivateFieldLooseKey("isCloud");var $=babelHelpers.classPrivateFieldLooseKey("phpUploadMaxFilesize");var R=babelHelpers.classPrivateFieldLooseKey("phpPostMaxSize");var V=babelHelpers.classPrivateFieldLooseKey("calculateChunkSize");var q=babelHelpers.classPrivateFieldLooseKey("handleUploaderOptions");var Z=babelHelpers.classPrivateFieldLooseKey("initSettings");class G extends s.EventEmitter{constructor(e={}){super();Object.defineProperty(this,Z,{value:J});Object.defineProperty(this,q,{value:W});Object.defineProperty(this,V,{value:Q});Object.defineProperty(this,A,{writable:true,value:[]});Object.defineProperty(this,M,{writable:true,value:void 0});Object.defineProperty(this,x,{writable:true,value:void 0});Object.defineProperty(this,z,{writable:true,value:0});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,$,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});this.setEventNamespace("BX.Messenger.V2.Lib.Uploader");babelHelpers.classPrivateFieldLooseBase(this,q)[q](e);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]()}addTask(e){if(!this.checkTaskParams(e)){return}e.chunkSize=babelHelpers.classPrivateFieldLooseBase(this,V)[V](e.chunkSize);e.listener=(e,s)=>this.onUploadEvent(e,s);babelHelpers.classPrivateFieldLooseBase(this,A)[A].push(new g(e));this.checkUploadQueue()}deleteTask(e){if(!e){return}babelHelpers.classPrivateFieldLooseBase(this,A)[A]=babelHelpers.classPrivateFieldLooseBase(this,A)[A].filter((s=>{if(s.getTaskId()===e){s.deleteContent();return false}return true}))}getTask(e){const s=this.queue.find((s=>s.taskId===e));return s||null}checkUploadQueue(){if(babelHelpers.classPrivateFieldLooseBase(this,A)[A].length===0){return}const e=babelHelpers.classPrivateFieldLooseBase(this,A)[A].filter((e=>e.isPending()));if(e.length>0){e[0].uploadContent()}}onUploadEvent(e,s){this.emit(e,s);this.checkUploadQueue()}checkTaskParams(e){if(!e.taskId){console.error("Empty TaskId.");return false}if(!e.fileData){console.error("Empty file data.");return false}if(!e.diskFolderId){console.error("Empty disk folder id.");return false}if(babelHelpers.classPrivateFieldLooseBase(this,z)[z]&&babelHelpers.classPrivateFieldLooseBase(this,z)[z]<e.fileData.size){this.emit(G.EVENTS.fileMaxSizeExceeded,{maxFileSizeLimit:babelHelpers.classPrivateFieldLooseBase(this,z)[z],task:e});return false}return true}}function Q(e=0){const s=Math.min(babelHelpers.classPrivateFieldLooseBase(this,R)[R],babelHelpers.classPrivateFieldLooseBase(this,$)[$]);const a=babelHelpers.classPrivateFieldLooseBase(this,X)[X]?G.CLOUD_MIN_CHUNK_SIZE:G.BOX_MIN_CHUNK_SIZE;const l=babelHelpers.classPrivateFieldLooseBase(this,X)[X]?G.CLOUD_MAX_CHUNK_SIZE:s;return Math.min(Math.max(e,a),l)}function W(e){if(e.inputNode instanceof HTMLInputElement||a.Type.isArrayFilled(e.inputNode)){babelHelpers.classPrivateFieldLooseBase(this,M)[M]=e.inputNode}if(e.dropNode instanceof HTMLElement||a.Type.isArrayFilled(e.dropNode)){babelHelpers.classPrivateFieldLooseBase(this,x)[x]=e.dropNode}}function J(){const e=a.Extension.getSettings("im.v2.lib.uploader");babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e.get("isCloud");babelHelpers.classPrivateFieldLooseBase(this,$)[$]=e.get("phpUploadMaxFilesize");babelHelpers.classPrivateFieldLooseBase(this,R)[R]=e.get("phpPostMaxSize")}G.EVENTS={startUpload:"startUpload",progressUpdate:"progressUpdate",complete:"complete",fileMaxSizeExceeded:"fileMaxSizeExceeded",createFileError:"createFileError",uploadFileError:"uploadFileError"};G.BOX_MIN_CHUNK_SIZE=1024*1024;G.CLOUD_MIN_CHUNK_SIZE=1024*1024*5;G.CLOUD_MAX_CHUNK_SIZE=1024*1024*100;e.Uploader=G;e.PreviewManager=j})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX);
//# sourceMappingURL=uploader.bundle.map.js