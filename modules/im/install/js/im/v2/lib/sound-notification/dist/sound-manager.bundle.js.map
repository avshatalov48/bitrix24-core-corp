{"version":3,"file":"sound-manager.bundle.js","sources":["../src/classes/sound-player.js","../src/sound-manager.js"],"sourcesContent":["const SoundType = {\n\treminder: '/bitrix/js/im/audio/reminder.mp3',\n\tnewMessage1: '/bitrix/js/im/audio/new-message-1.mp3',\n\tnewMessage2: '/bitrix/js/im/audio/new-message-2.mp3',\n\tsend: '/bitrix/js/im/audio/send.mp3',\n\tdialtone: '/bitrix/js/im/audio/video-dialtone.mp3',\n\tringtone: '/bitrix/js/im/audio/video-ringtone.mp3',\n\tstart: '/bitrix/js/im/audio/video-start.mp3',\n\tstop: '/bitrix/js/im/audio/video-stop.mp3',\n\terror: '/bitrix/js/im/audio/video-error.mp3',\n};\n\nexport class SoundPlayer\n{\n\tstatic syncEvent = 'im-sound-stop';\n\n\t#isPlayingLoop: boolean = false;\n\t#currentPlayingSound: ?HTMLAudioElement;\n\t#loopTimers: {[type: string]: number} = {};\n\n\tconstructor()\n\t{\n\t\t// eslint-disable-next-line bitrix-rules/no-bx\n\t\tBX.addCustomEvent(window, 'onLocalStorageSet', (params) => {\n\t\t\tif (params.key !== SoundPlayer.syncEvent)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.stop(params.value.soundType, true);\n\t\t});\n\t}\n\n\tplaySingle(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (this.#isPlayingLoop)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#currentPlayingSound)\n\t\t{\n\t\t\tthis.stop(type);\n\t\t}\n\n\t\tthis.#notifyOtherTabs(type);\n\n\t\tthis.#currentPlayingSound = new Audio(SoundType[type]);\n\t\tthis.#currentPlayingSound.play().catch(() => {\n\t\t\tthis.#currentPlayingSound = null;\n\t\t});\n\t}\n\n\tplayLoop(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (this.#currentPlayingSound)\n\t\t{\n\t\t\tthis.stop(type);\n\t\t}\n\n\t\tthis.#isPlayingLoop = false;\n\t\tthis.playSingle(type);\n\n\t\tthis.#isPlayingLoop = true;\n\t\tthis.#loopTimers[type] = setTimeout(() => {\n\t\t\tthis.playLoop(type);\n\t\t}, 5000);\n\t}\n\n\tstop(type, skip = false)\n\t{\n\t\tif (!skip)\n\t\t{\n\t\t\tthis.#notifyOtherTabs(type);\n\t\t}\n\n\t\tif (this.#loopTimers[type])\n\t\t{\n\t\t\tclearTimeout(this.#loopTimers[type]);\n\t\t}\n\n\t\tif (!this.#currentPlayingSound)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#currentPlayingSound.pause();\n\t\tthis.#currentPlayingSound.currentTime = 0;\n\t\tthis.#currentPlayingSound = null;\n\t}\n\n\t#notifyOtherTabs(soundType: $Keys<typeof SoundType>)\n\t{\n\t\tconst localStorageTtl = 1;\n\n\t\tBX.localStorage.set(SoundPlayer.syncEvent, {soundType}, localStorageTtl);\n\t}\n}","import {Store} from 'ui.vue3.vuex';\n\nimport {Core} from 'im.v2.application.core';\nimport {UserStatus, SoundType} from 'im.v2.const';\nimport {DesktopManager} from 'im.v2.lib.desktop';\nimport {CallManager} from 'im.v2.lib.call';\n\nimport {SoundPlayer} from './classes/sound-player';\n\nexport class SoundManager\n{\n\t#store: Store;\n\t#desktopManager: DesktopManager;\n\t#soundPlayer: SoundPlayer;\n\n\tstatic instance = null;\n\n\tstatic getInstance()\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tthis.#desktopManager = new DesktopManager();\n\t\tthis.#soundPlayer = new SoundPlayer();\n\t}\n\n\tplayOnce(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (this.#hasActiveCall() || !this.#canPlayInContext())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#canPlayForUser(type))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#soundPlayer.playSingle(type);\n\t}\n\n\tplayLoop(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (!this.#canPlayInContext())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#soundPlayer.playLoop(type);\n\t}\n\n\tstop(type)\n\t{\n\t\tthis.#soundPlayer.stop(type);\n\t}\n\n\t#canPlayInContext(): boolean\n\t{\n\t\treturn DesktopManager.isDesktop() || !this.#desktopManager.isDesktopActive();\n\t}\n\n\t#canPlayForUser(type): boolean\n\t{\n\t\tif (this.#isPrioritySoundType(type))\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tif (this.#checkSettings())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst status = this.#store.getters['users/getStatus'](Core.getUserId());\n\n\t\treturn status !== UserStatus.dnd;\n\t}\n\n\t#isPrioritySoundType(type: $Keys<typeof SoundType>): boolean\n\t{\n\t\treturn [SoundType.start, SoundType.dialtone, SoundType.ringtone].includes(type);\n\t}\n\n\t#hasActiveCall(): boolean\n\t{\n\t\treturn CallManager.getInstance().hasCurrentCall();\n\t}\n\n\t#checkSettings(): boolean\n\t{\n\t\treturn true; //todo\n\t}\n}"],"names":["SoundType","reminder","newMessage1","newMessage2","send","dialtone","ringtone","start","stop","error","SoundPlayer","constructor","BX","addCustomEvent","window","params","key","syncEvent","value","soundType","playSingle","type","Audio","play","catch","playLoop","setTimeout","skip","clearTimeout","pause","currentTime","localStorageTtl","localStorage","set","SoundManager","getInstance","instance","Core","getStore","DesktopManager","playOnce","isDesktop","isDesktopActive","status","getters","getUserId","UserStatus","dnd","includes","CallManager","hasCurrentCall"],"mappings":";;;;;;CAAA,MAAMA,SAAS,GAAG;GACjBC,QAAQ,EAAE,kCAAkC;GAC5CC,WAAW,EAAE,uCAAuC;GACpDC,WAAW,EAAE,uCAAuC;GACpDC,IAAI,EAAE,8BAA8B;GACpCC,QAAQ,EAAE,wCAAwC;GAClDC,QAAQ,EAAE,wCAAwC;GAClDC,KAAK,EAAE,qCAAqC;GAC5CC,IAAI,EAAE,oCAAoC;GAC1CC,KAAK,EAAE;CACR,CAAC;CAAC;CAAA;CAAA;CAAA;AAEF,CAAO,MAAMC,WAAW,CACxB;GAOCC,WAAW,GACX;KAAA;OAAA;;KAAA;OAAA;OAAA,OAL0B;;KAAK;OAAA;OAAA;;KAAA;OAAA;OAAA,OAES;;;KAKvCC,EAAE,CAACC,cAAc,CAACC,MAAM,EAAE,mBAAmB,EAAGC,MAAM,IAAK;OAC1D,IAAIA,MAAM,CAACC,GAAG,KAAKN,WAAW,CAACO,SAAS,EACxC;SACC;;OAGD,IAAI,CAACT,IAAI,CAACO,MAAM,CAACG,KAAK,CAACC,SAAS,EAAE,IAAI,CAAC;MACvC,CAAC;;GAGHC,UAAU,CAACC,IAA6B,EACxC;KACC,4CAAI,IAAI,mCACR;OACC;;KAGD,4CAAI,IAAI,+CACR;OACC,IAAI,CAACb,IAAI,CAACa,IAAI,CAAC;;KAGhB,4CAAI,sCAAkBA,IAAI;KAE1B,4CAAI,gDAAwB,IAAIC,KAAK,CAACtB,SAAS,CAACqB,IAAI,CAAC,CAAC;KACtD,4CAAI,8CAAsBE,IAAI,EAAE,CAACC,KAAK,CAAC,MAAM;OAC5C,4CAAI,gDAAwB,IAAI;MAChC,CAAC;;GAGHC,QAAQ,CAACJ,IAA6B,EACtC;KACC,4CAAI,IAAI,+CACR;OACC,IAAI,CAACb,IAAI,CAACa,IAAI,CAAC;;KAGhB,4CAAI,oCAAkB,KAAK;KAC3B,IAAI,CAACD,UAAU,CAACC,IAAI,CAAC;KAErB,4CAAI,oCAAkB,IAAI;KAC1B,4CAAI,4BAAaA,IAAI,CAAC,GAAGK,UAAU,CAAC,MAAM;OACzC,IAAI,CAACD,QAAQ,CAACJ,IAAI,CAAC;MACnB,EAAE,IAAI,CAAC;;GAGTb,IAAI,CAACa,IAAI,EAAEM,IAAI,GAAG,KAAK,EACvB;KACC,IAAI,CAACA,IAAI,EACT;OACC,4CAAI,sCAAkBN,IAAI;;KAG3B,IAAI,4CAAI,4BAAaA,IAAI,CAAC,EAC1B;OACCO,YAAY,CAAC,4CAAI,4BAAaP,IAAI,CAAC,CAAC;;KAGrC,IAAI,yCAAC,IAAI,6CAAqB,EAC9B;OACC;;KAGD,4CAAI,8CAAsBQ,KAAK,EAAE;KACjC,4CAAI,8CAAsBC,WAAW,GAAG,CAAC;KACzC,4CAAI,gDAAwB,IAAI;;CASlC;CAAC,2BANiBX,SAAkC,EACnD;GACC,MAAMY,eAAe,GAAG,CAAC;GAEzBnB,EAAE,CAACoB,YAAY,CAACC,GAAG,CAACvB,WAAW,CAACO,SAAS,EAAE;KAACE;IAAU,EAAEY,eAAe,CAAC;CACzE;CApFYrB,WAAW,CAEhBO,SAAS,GAAG,eAAe;;CCPgB;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAEnD,CAAO,MAAMiB,YAAY,CACzB;GAOC,OAAOC,WAAW,GAClB;KACC,IAAI,CAAC,IAAI,CAACC,QAAQ,EAClB;OACC,IAAI,CAACA,QAAQ,GAAG,IAAI,IAAI,EAAE;;KAG3B,OAAO,IAAI,CAACA,QAAQ;;GAGrBzB,WAAW,GACX;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KACC,4CAAI,oBAAU0B,2BAAI,CAACC,QAAQ,EAAE;KAC7B,4CAAI,sCAAmB,IAAIC,gCAAc,EAAE;KAC3C,4CAAI,gCAAgB,IAAI7B,WAAW,EAAE;;GAGtC8B,QAAQ,CAACnB,IAA6B,EACtC;KACC,IAAI,4CAAI,uCAAqB,yCAAC,IAAI,yCAAoB,EACtD;OACC;;KAGD,IAAI,yCAAC,IAAI,oCAAiBA,IAAI,CAAC,EAC/B;OACC;;KAGD,4CAAI,8BAAcD,UAAU,CAACC,IAAI,CAAC;;GAGnCI,QAAQ,CAACJ,IAA6B,EACtC;KACC,IAAI,yCAAC,IAAI,yCAAoB,EAC7B;OACC;;KAGD,4CAAI,8BAAcI,QAAQ,CAACJ,IAAI,CAAC;;GAGjCb,IAAI,CAACa,IAAI,EACT;KACC,4CAAI,8BAAcb,IAAI,CAACa,IAAI,CAAC;;CAuC9B;CAAC,8BAnCA;GACC,OAAOkB,gCAAc,CAACE,SAAS,EAAE,IAAI,CAAC,4CAAI,oCAAiBC,eAAe,EAAE;CAC7E;CAAC,0BAEerB,IAAI,EACpB;GACC,4CAAI,IAAI,8CAAsBA,IAAI,GAClC;KACC,OAAO,IAAI;;GAGZ,4CAAI,IAAI,qCACR;KACC,OAAO,IAAI;;GAGZ,MAAMsB,MAAM,GAAG,4CAAI,kBAAQC,OAAO,CAAC,iBAAiB,CAAC,CAACP,2BAAI,CAACQ,SAAS,EAAE,CAAC;GAEvE,OAAOF,MAAM,KAAKG,sBAAU,CAACC,GAAG;CACjC;CAAC,+BAEoB1B,IAA6B,EAClD;GACC,OAAO,CAACrB,qBAAS,CAACO,KAAK,EAAEP,qBAAS,CAACK,QAAQ,EAAEL,qBAAS,CAACM,QAAQ,CAAC,CAAC0C,QAAQ,CAAC3B,IAAI,CAAC;CAChF;CAAC,2BAGD;GACC,OAAO4B,0BAAW,CAACd,WAAW,EAAE,CAACe,cAAc,EAAE;CAClD;CAAC,2BAGD;GACC,OAAO,IAAI,CAAC;CACb;CA1FYhB,YAAY,CAMjBE,QAAQ,GAAG,IAAI;;;;;;;;"}