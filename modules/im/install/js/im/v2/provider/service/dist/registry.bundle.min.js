this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,i,r,l,o,d,c,n,h,b,p,v,g){"use strict";class u{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.store=null;this.restClient=null;this.dataIsPreloaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null;this.store=n.Core.getStore();this.restClient=n.Core.getRestClient();this.onUpdateStateHandler=this.onUpdateState.bind(this);p.EventEmitter.subscribe(g.EventType.recent.updateState,this.onUpdateStateHandler)}getCollection(){return this.store.getters["recent/getRecentCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){b.Logger.warn(`Im.RecentList: first page was preloaded`);return Promise.resolve()}this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){b.Logger.warn(`Im.RecentList: setting preloaded data`,e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){b.Logger.warn(`Im.RecentList: hide chat`,e);const s=this.store.getters["recent/get"](e);if(!s){return false}this.store.dispatch("recent/delete",{id:e});const a=this.store.getters["application/isChatOpen"](e);if(a){t.Messenger.openChat()}this.restClient.callMethod(g.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);return this.restClient.callMethod(this.getQueryMethod(),s).then((s=>{this.pagesLoaded++;b.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,s.data());const{items:a,hasMore:t}=s.data();this.lastMessageDate=this.getLastMessageDate(a);if(!t){this.hasMoreItemsToLoad=false}return this.updateModels(s.data()).then((()=>{this.isLoading=false}))})).catch((e=>{console.error("Im.RecentList: page request error",e)}))}getQueryMethod(){return g.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y"}}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const i=this.store.dispatch("users/set",s);if(e.botList){this.store.dispatch("users/setBotList",e.botList)}const r=this.store.dispatch("dialogues/set",a);const l=this.store.dispatch("recent/setRecent",t);return Promise.all([i,r,l])}onUpdateState({data:e}){b.Logger.warn(`Im.RecentList: setting UpdateState data`,e);this.updateModels(e)}prepareDataForModels({items:e,birthdayList:s=[]}){const a={users:[],dialogues:[],recent:[]};e.forEach((e=>{if(e.user&&e.user.id&&!this.isAddedAlready(a,"users",e.user.id)){a.users.push(e.user)}if(e.chat){a.dialogues.push(this.prepareGroupChat(e));if(e.user.id&&!this.isAddedAlready(a,"dialogues",e.user.id)){a.dialogues.push(this.prepareChatForAdditionalUser(e.user))}}else if(e.user.id){const s=this.store.getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){a.dialogues.push(this.prepareChatForUser(e))}}a.recent.push({...e})}));s.forEach((e=>{if(!this.isAddedAlready(a,"users",e.id)){a.users.push(e);a.dialogues.push(this.prepareChatForAdditionalUser(e))}if(!this.isAddedAlready(a,"recent",e.id)){a.recent.push(this.getBirthdayPlaceholder(e))}}));b.Logger.warn(`Im.RecentList: prepared data for models`,a);return a}isAddedAlready(e,s,a){if(s==="users"){return e.users.some((e=>e.id===a))}else if(s==="dialogues"){return e.dialogues.some((e=>e.dialogId===a))}else if(s==="recent"){return e.recent.some((e=>e.id===a))}return false}prepareGroupChat(e){return{...e.chat,counter:e.counter,dialogId:e.id}}prepareChatForUser(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:g.DialogType.user,counter:e.counter}}prepareChatForAdditionalUser(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:g.DialogType.user}}getBirthdayPlaceholder(e){return{id:e.id,options:{birthdayPlaceholder:true}}}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}}u.instance=null;var P=babelHelpers.classPrivateFieldLooseKey("restResult");class F{constructor(e){Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,P)[P]=e}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.id}isOpenlinesChat(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.type===g.DialogType.lines}getChats(){const e={...babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat,hasPrevPage:babelHelpers.classPrivateFieldLooseBase(this,P)[P].hasPrevPage,hasNextPage:babelHelpers.classPrivateFieldLooseBase(this,P)[P].hasNextPage};const s={[babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.dialogId]:e};babelHelpers.classPrivateFieldLooseBase(this,P)[P].users.forEach((e=>{if(s[e.id]){s[e.id]={...s[e.id],...o.UserManager.getDialogForUser(e)}}else{s[e.id]=o.UserManager.getDialogForUser(e)}}));return Object.values(s)}getFiles(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].files)!=null?e:[]}getUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].users)!=null?e:[]}getAdditionalUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].usersShort)!=null?e:[]}getMessages(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].messages)!=null?e:[]}getMessagesToStore(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].additionalMessages)!=null?e:[]}getPinnedMessageIds(){var e;const s=[];const a=(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].pins)!=null?e:[];a.forEach((e=>{s.push(e.messageId)}));return s}getReactions(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].reactions)!=null?e:[]}}var L=babelHelpers.classPrivateFieldLooseKey("store");var H=babelHelpers.classPrivateFieldLooseKey("requestChat");var f=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoading");var B=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoaded");var m=babelHelpers.classPrivateFieldLooseKey("updateModels");class I{constructor(){Object.defineProperty(this,m,{value:S});Object.defineProperty(this,B,{value:C});Object.defineProperty(this,f,{value:y});Object.defineProperty(this,H,{value:M});Object.defineProperty(this,L,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,L)[L]=n.Core.getStore()}loadChat(e){const s={dialogId:e};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.RestMethod.imV2ChatShallowLoad,s)}loadChatWithMessages(e){const a={dialogId:e,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.RestMethod.imV2ChatLoad,a)}loadChatWithContext(e,a){const t={dialogId:e,messageId:a,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](g.RestMethod.imV2ChatLoadInContext,t)}prepareDialogId(e){if(!h.Utils.dialog.isExternalId(e)){return Promise.resolve(e)}return c.runAction(g.RestMethod.imV2ChatGetDialogId,{data:{externalId:e}}).then((e=>e.dialogId)).catch((e=>{console.error("ChatService: Load: error preparing external id",e)}))}}function M(e,s){const{dialogId:a}=s;babelHelpers.classPrivateFieldLooseBase(this,f)[f](a);return c.runAction(e,{data:s}).then((e=>babelHelpers.classPrivateFieldLooseBase(this,m)[m](e))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,B)[B](a)})).catch((e=>{console.error("ChatService: Load: error loading chat",e);throw e}))}function y(e){babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{loading:true}})}function C(e){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{inited:true,loading:false}})}function S(e){const s=new F(e);if(s.isOpenlinesChat()){return Promise.reject(new Error("OL chats are not supported"))}const a=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/set",s.getChats());const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/set",s.getFiles());const i=new o.UserManager;const r=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("users/set",s.getUsers()),i.addUsersToModel(s.getAdditionalUsers())]);const l=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessageIds()}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/reactions/set",s.getReactions())]);return Promise.all([a,t,r,l])}const w="CHAT";const O="OPEN";var U=babelHelpers.classPrivateFieldLooseKey("restClient");var R=babelHelpers.classPrivateFieldLooseKey("store");var D=babelHelpers.classPrivateFieldLooseKey("addChatToModel");class E{constructor(){Object.defineProperty(this,D,{value:T});Object.defineProperty(this,U,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,U)[U]=n.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,R)[R]=n.Core.getStore()}createChat(e){b.Logger.warn("ChatService: createChat",e);return babelHelpers.classPrivateFieldLooseBase(this,U)[U].callMethod(g.RestMethod.imV2ChatAdd,{fields:{title:e.title,description:e.description,users:e.members,ownerId:e.ownerId,searchable:e.isAvailableInSearch?"Y":"N"}}).then((s=>{const{chatId:a}=s.data();b.Logger.warn("ChatService: createChat result",a);const t=`chat${a}`;babelHelpers.classPrivateFieldLooseBase(this,D)[D](t,e);return t})).catch((e=>{console.error("ChatService: createChat error:",e);throw new Error(e)}))}}function T(e,s){const a=s.isAvailableInSearch?O:w;babelHelpers.classPrivateFieldLooseBase(this,R)[R].dispatch("dialogues/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.members.length})}var j=babelHelpers.classPrivateFieldLooseKey("store");var K=babelHelpers.classPrivateFieldLooseKey("restClient");var A=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class _{constructor(){Object.defineProperty(this,A,{value:x});Object.defineProperty(this,j,{writable:true,value:void 0});Object.defineProperty(this,K,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,j)[j]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,K)[K]=n.Core.getRestClient()}renameChat(e,s){b.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,j)[j].getters["dialogues/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,A)[A](e,s);return babelHelpers.classPrivateFieldLooseBase(this,K)[K].callMethod(g.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).then((e=>{b.Logger.warn("ChatService: renameChat result",e.data());return Promise.resolve()})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,A)[A](e,t);throw new Error("Chat rename error")}))}}function x(e,s){babelHelpers.classPrivateFieldLooseBase(this,j)[j].dispatch("dialogues/update",{dialogId:e,fields:{name:s}})}var k=babelHelpers.classPrivateFieldLooseKey("store");var N=babelHelpers.classPrivateFieldLooseKey("restClient");var V=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var G=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class X{constructor(){Object.defineProperty(this,G,{value:q});Object.defineProperty(this,k,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,V,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,k)[k]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,N)[N]=n.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,V)[V]=l.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,G)[G],Ie.DEBOUNCE_TIME)}muteChat(e){b.Logger.warn("ChatService: muteChat",e);babelHelpers.classPrivateFieldLooseBase(this,k)[k].dispatch("dialogues/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,V)[V](s)}unmuteChat(e){b.Logger.warn("ChatService: unmuteChat",e);babelHelpers.classPrivateFieldLooseBase(this,k)[k].dispatch("dialogues/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,V)[V](s)}}function q(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,N)[N].callMethod(g.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e);const i=a==="Y"?"dialogues/unmute":"dialogues/mute";babelHelpers.classPrivateFieldLooseBase(this,k)[k].dispatch(i,{dialogId:s})}))}var W=babelHelpers.classPrivateFieldLooseKey("store");var Y=babelHelpers.classPrivateFieldLooseKey("restClient");class z{constructor(){Object.defineProperty(this,W,{writable:true,value:void 0});Object.defineProperty(this,Y,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,W)[W]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=n.Core.getRestClient()}pinChat(e){b.Logger.warn("PinService: pinChat",e);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("recent/pin",{id:e,action:true});const s={DIALOG_ID:e,ACTION:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].callMethod(g.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error pinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){b.Logger.warn("PinService: unpinChat",e);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("recent/pin",{id:e,action:false});const s={DIALOG_ID:e,ACTION:"N"};babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].callMethod(g.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error unpinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("recent/pin",{id:e,action:true})}))}}const Q=300;var $=babelHelpers.classPrivateFieldLooseKey("store");var J=babelHelpers.classPrivateFieldLooseKey("restClient");var Z=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var ee=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var se=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var ae=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var te=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var ie=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var re=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class le{constructor(){Object.defineProperty(this,re,{value:be});Object.defineProperty(this,ie,{value:he});Object.defineProperty(this,te,{value:ne});Object.defineProperty(this,ae,{value:ce});Object.defineProperty(this,se,{value:de});Object.defineProperty(this,ee,{value:oe});Object.defineProperty(this,$,{writable:true,value:void 0});Object.defineProperty(this,J,{writable:true,value:void 0});Object.defineProperty(this,Z,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,$)[$]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,J)[J]=n.Core.getRestClient()}readAll(){b.Logger.warn("ReadService: readAll");babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/clearCounters");babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,J)[J].callMethod(g.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e)}))}readDialog(e){b.Logger.warn("ReadService: readDialog",e);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,J)[J].callMethod(g.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e)}))}unreadDialog(e){b.Logger.warn("ReadService: unreadDialog",e);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/unread",{id:e,action:true});babelHelpers.classPrivateFieldLooseBase(this,J)[J].callMethod(g.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,Z)[Z][e]){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,Z)[Z][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]).forEach((([e,s])=>{e=+e;b.Logger.warn("ReadService: readMessages",s);if(s.size===0){return}const a=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,Z)[Z][e];babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e,a).then((s=>{b.Logger.warn("ReadService: readMessage, need to reduce counter by",s);return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e,s)})).then((()=>babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](e,a))).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,te)[te](e)})).catch((e=>{console.error("ReadService: error reading message",e)}))}))}),Q)}clearDialogMark(e){b.Logger.warn("ReadService: clear dialog mark",e);const s=babelHelpers.classPrivateFieldLooseBase(this,$)[$].getters["dialogues/get"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,$)[$].getters["recent/get"](e);if(s.markedId===0&&a&&!a.unread){return}babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,J)[J].callMethod(g.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:true}).catch((e=>{console.error("ReadService: error clearing dialog mark",e)}))}}function oe(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,re)[re](e);if(a>t.lastReadId){babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function de(e,s){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/decreaseCounter",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e),count:s})}function ce(e,s){b.Logger.warn("ReadService: readMessages on server",s);return c.runAction(g.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:s,actionUuid:a.UuidManager.getInstance().getActionUuid()}})}function ne(e){const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,re)[re](s);if(t.counter>a){b.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("dialogues/update",{dialogId:t.dialogId,fields:{counter:a}})}}function he(e){const s=babelHelpers.classPrivateFieldLooseBase(this,$)[$].getters["dialogues/getByChatId"](e);if(!s){return 0}return s.dialogId}function be(e){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].getters["dialogues/getByChatId"](e)}var pe=babelHelpers.classPrivateFieldLooseKey("store");var ve=babelHelpers.classPrivateFieldLooseKey("restClient");class ge{constructor(){Object.defineProperty(this,pe,{writable:true,value:void 0});Object.defineProperty(this,ve,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]=n.Core.getRestClient()}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].callMethod(g.RestMethod.imChatUserAdd,s)}kickUserFromChat(e,s){b.Logger.warn(`UserService: kick user ${s} from chat ${e}`);const a=e.slice(4);const t={user_id:s,chat_id:a};babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].callMethod(g.RestMethod.imChatUserDelete,t).catch((e=>{console.error("Im.Lib.Menu: error kicking user from chat",e)}))}leaveChat(e){this.kickUserFromChat(e,n.Core.getUserId());babelHelpers.classPrivateFieldLooseBase(this,pe)[pe].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,pe)[pe].getters["application/isChatOpen"](e);if(s){t.Messenger.openChat()}}}var ue=babelHelpers.classPrivateFieldLooseKey("loadService");var Pe=babelHelpers.classPrivateFieldLooseKey("createService");var Fe=babelHelpers.classPrivateFieldLooseKey("renameService");var Le=babelHelpers.classPrivateFieldLooseKey("muteService");var He=babelHelpers.classPrivateFieldLooseKey("pinService");var fe=babelHelpers.classPrivateFieldLooseKey("readService");var Be=babelHelpers.classPrivateFieldLooseKey("userService");var me=babelHelpers.classPrivateFieldLooseKey("initServices");class Ie{constructor(){Object.defineProperty(this,me,{value:Me});Object.defineProperty(this,ue,{writable:true,value:void 0});Object.defineProperty(this,Pe,{writable:true,value:void 0});Object.defineProperty(this,Fe,{writable:true,value:void 0});Object.defineProperty(this,Le,{writable:true,value:void 0});Object.defineProperty(this,He,{writable:true,value:void 0});Object.defineProperty(this,fe,{writable:true,value:void 0});Object.defineProperty(this,Be,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,me)[me]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue].loadChat(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue].loadChatWithContext(e,s)}prepareDialogId(e){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue].prepareDialogId(e)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].createChat(e)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,He)[He].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,He)[He].unpinChat(e)}readAll(){return babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].readMessage(e,s)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].leaveChat(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].kickUserFromChat(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].addToChat(e)}}function Me(){babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]=new I;babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]=new E;babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]=new _;babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]=new X;babelHelpers.classPrivateFieldLooseBase(this,He)[He]=new z;babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=new le;babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]=new ge}Ie.DEBOUNCE_TIME=500;var ye=babelHelpers.classPrivateFieldLooseKey("store");var Ce=babelHelpers.classPrivateFieldLooseKey("restClient");var Se=babelHelpers.classPrivateFieldLooseKey("chatId");var we=babelHelpers.classPrivateFieldLooseKey("userManager");var Oe=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var Ue=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var Re=babelHelpers.classPrivateFieldLooseKey("isLoading");var De=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var Ee=babelHelpers.classPrivateFieldLooseKey("updateModels");var Te=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var je=babelHelpers.classPrivateFieldLooseKey("getDialog");class Ke{constructor(e){Object.defineProperty(this,je,{value:ke});Object.defineProperty(this,Te,{value:xe});Object.defineProperty(this,Ee,{value:_e});Object.defineProperty(this,De,{value:Ae});Object.defineProperty(this,ye,{writable:true,value:void 0});Object.defineProperty(this,Ce,{writable:true,value:void 0});Object.defineProperty(this,Se,{writable:true,value:void 0});Object.defineProperty(this,we,{writable:true,value:void 0});Object.defineProperty(this,Oe,{writable:true,value:[]});Object.defineProperty(this,Ue,{writable:true,value:[]});Object.defineProperty(this,Re,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]=n.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,we)[we]=new o.UserManager;babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]=e}loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]||!babelHelpers.classPrivateFieldLooseBase(this,je)[je]().hasNextPage){return Promise.resolve(false)}b.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]);if(!e){b.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Se)[Se],filter:{lastId:e},order:{id:"ASC"},limit:Ke.MESSAGE_REQUEST_LIMIT};return c.runAction(g.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{b.Logger.warn("MessageService: loadUnread result",e);babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=e.messages;return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false;return true})).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false}))}loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]||!babelHelpers.classPrivateFieldLooseBase(this,je)[je]().hasPrevPage){return Promise.resolve(false)}b.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]);if(!e){b.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Se)[Se],filter:{lastId:e},order:{id:"DESC"},limit:Ke.MESSAGE_REQUEST_LIMIT};return c.runAction(g.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{b.Logger.warn("MessageService: loadHistory result",e);babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=e.messages;const s=e.hasNextPage;const a={...e,hasPrevPage:s,hasNextPage:null};return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](a)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false;return true})).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false}))}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=[];return true}))}loadContext(e){const s={[g.RestMethod.imV2ChatMessageGetContext]:{id:e,range:Ke.MESSAGE_REQUEST_LIMIT},[g.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Se)[Se],ids:[e]}};b.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=true;return c.callBatch(s).then((e=>{b.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,De)[De](e[g.RestMethod.imV2ChatMessageGetContext])})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false}))}reloadMessageList(){b.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,je)[je]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,je)[je]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,je)[je]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,je)[je]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,je)[je]().inited;babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](false);if(e){return this.loadContext(e).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](true,s)}))}return this.loadInitialMessages().then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](true,s)}))}loadInitialMessages(){b.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]);babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=true;return babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].callMethod(g.RestMethod.imV2ChatMessageList,{chatId:babelHelpers.classPrivateFieldLooseBase(this,Se)[Se],limit:Ke.MESSAGE_REQUEST_LIMIT}).then((e=>{b.Logger.warn("MessageService: loadInitialMessages result",e.data());return babelHelpers.classPrivateFieldLooseBase(this,De)[De](e.data())})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false;return true})).catch((e=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=false}))}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]}}function Ae(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e);return Promise.all([a,t])}function _e(e){const{files:s,users:a,usersShort:t,reactions:i,hasPrevPage:r,hasNextPage:l}=e;const o=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,je)[je]().dialogId,fields:{hasPrevPage:r,hasNextPage:l}});const d=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,we)[we].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,we)[we].addUsersToModel(t)]);const c=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("files/set",s);const n=babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("messages/reactions/set",i);return Promise.all([o,c,d,n])}function xe(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,je)[je]().dialogId,fields:a})}function ke(){return babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Se)[Se])}Ke.MESSAGE_REQUEST_LIMIT=25;var Ne=babelHelpers.classPrivateFieldLooseKey("store");var Ve=babelHelpers.classPrivateFieldLooseKey("restClient");class Ge{constructor(){Object.defineProperty(this,Ne,{writable:true,value:void 0});Object.defineProperty(this,Ve,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]=n.Core.getRestClient()}pinMessage(e,s){b.Logger.warn(`Dialog: PinManager: pin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dispatch("messages/pin/add",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].callMethod(g.RestMethod.imV2ChatMessagePin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error pinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dispatch("messages/pin/delete",{chatId:e,messageId:s})}))}unpinMessage(e,s){b.Logger.warn(`Dialog: PinManager: unpin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dispatch("messages/pin/delete",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].callMethod(g.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error unpinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dispatch("messages/pin/add",{chatId:e,messageId:s})}))}}var Xe=babelHelpers.classPrivateFieldLooseKey("store");var qe=babelHelpers.classPrivateFieldLooseKey("restClient");var We=babelHelpers.classPrivateFieldLooseKey("chatId");class Ye{constructor(e){Object.defineProperty(this,Xe,{writable:true,value:void 0});Object.defineProperty(this,qe,{writable:true,value:void 0});Object.defineProperty(this,We,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,We)[We]=e;babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]=n.Core.getRestClient()}editMessageText(e,s){b.Logger.warn("MessageService: editMessageText",e,s);babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].dispatch("messages/update",{id:e,fields:{text:s,isEdited:true}});const a=babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,We)[We]);if(e===a.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].dispatch("recent/update",{id:a.dialogId,fields:{message:{text:s}}})}babelHelpers.classPrivateFieldLooseBase(this,qe)[qe].callMethod(g.RestMethod.imMessageUpdate,{ID:e,MESSAGE:s}).catch((e=>{b.Logger.error("MessageService: editMessageText error:",e)}))}}var ze=babelHelpers.classPrivateFieldLooseKey("store");var Qe=babelHelpers.classPrivateFieldLooseKey("chatId");var $e=babelHelpers.classPrivateFieldLooseKey("shallowMessageDelete");var Je=babelHelpers.classPrivateFieldLooseKey("completeMessageDelete");var Ze=babelHelpers.classPrivateFieldLooseKey("deleteMessageOnServer");class es{constructor(e){Object.defineProperty(this,Ze,{value:ts});Object.defineProperty(this,Je,{value:as});Object.defineProperty(this,$e,{value:ss});Object.defineProperty(this,ze,{writable:true,value:void 0});Object.defineProperty(this,Qe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]=e;babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]=n.Core.getStore()}deleteMessage(e){b.Logger.warn("MessageService: deleteMessage",e);const s=babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].getters["messages/getById"](e);if(s.viewedByOthers){babelHelpers.classPrivateFieldLooseBase(this,$e)[$e](s)}else{babelHelpers.classPrivateFieldLooseBase(this,Je)[Je](s)}}}function ss(e){babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("messages/update",{id:e.id,fields:{text:"",params:{IS_DELETED:"Y",FILE_ID:[]}}});const s=babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]);if(e.id===s.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("recent/update",{id:s.dialogId,fields:{message:{text:""}}})}babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze](e.id)}function as(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]);const a=babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].getters["messages/getPreviousMessage"]({messageId:e.id,chatId:s.chatId});if(e.id===s.lastMessageId){let e={text:""};if(a){e=a}babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("recent/update",{id:s.dialogId,fields:{message:e}});const t=a?a.id:0;babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("dialogues/update",{dialogId:s.dialogId,fields:{lastMessageId:t,lastId:t}});babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("dialogues/clearLastMessageViews",{dialogId:s.dialogId})}babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("messages/delete",{id:e.id});babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze](e.id)}function ts(e){c.runAction(g.RestMethod.imV2ChatMessageDelete,{data:{id:e}}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}var is=babelHelpers.classPrivateFieldLooseKey("chatId");var rs=babelHelpers.classPrivateFieldLooseKey("store");var ls=babelHelpers.classPrivateFieldLooseKey("restClient");class os{constructor(e){Object.defineProperty(this,is,{writable:true,value:void 0});Object.defineProperty(this,rs,{writable:true,value:void 0});Object.defineProperty(this,ls,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,is)[is]=e;babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]=n.Core.getRestClient()}markMessage(e){b.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,is)[is]);babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/unread",{id:s,action:true});babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("dialogues/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].callMethod(g.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e)}))}}var ds=babelHelpers.classPrivateFieldLooseKey("chatId");var cs=babelHelpers.classPrivateFieldLooseKey("store");var ns=babelHelpers.classPrivateFieldLooseKey("restClient");class hs{constructor(e){Object.defineProperty(this,ds,{writable:true,value:void 0});Object.defineProperty(this,cs,{writable:true,value:void 0});Object.defineProperty(this,ns,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]=e;babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]=n.Core.getRestClient()}addMessageToFavorite(e){b.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].callMethod(g.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e)}));BX.UI.Notification.Center.notify({content:l.Loc.getMessage("IM_MESSAGE_SERVICE_ADD_MESSAGE_TO_FAVORITE_SUCCESS")})}removeMessageFromFavorite(e){b.Logger.warn("MessageService: removeMessageFromFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,cs)[cs].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,ds)[ds],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].callMethod(g.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e)}))}}var bs=babelHelpers.classPrivateFieldLooseKey("loadService");var ps=babelHelpers.classPrivateFieldLooseKey("pinService");var vs=babelHelpers.classPrivateFieldLooseKey("editService");var gs=babelHelpers.classPrivateFieldLooseKey("deleteService");var us=babelHelpers.classPrivateFieldLooseKey("markService");var Ps=babelHelpers.classPrivateFieldLooseKey("favoriteService");var Fs=babelHelpers.classPrivateFieldLooseKey("initServices");class Ls{static getMessageRequestLimit(){return Ke.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,Fs,{value:Hs});Object.defineProperty(this,bs,{writable:true,value:void 0});Object.defineProperty(this,ps,{writable:true,value:void 0});Object.defineProperty(this,vs,{writable:true,value:void 0});Object.defineProperty(this,gs,{writable:true,value:void 0});Object.defineProperty(this,us,{writable:true,value:void 0});Object.defineProperty(this,Ps,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].loadContext(e)}reloadMessageList(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,us)[us].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].editMessageText(e,s)}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,gs)[gs].deleteMessage(e)}}function Hs(e){babelHelpers.classPrivateFieldLooseBase(this,bs)[bs]=new Ke(e);babelHelpers.classPrivateFieldLooseBase(this,vs)[vs]=new Ye(e);babelHelpers.classPrivateFieldLooseBase(this,gs)[gs]=new es(e);babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=new Ge;babelHelpers.classPrivateFieldLooseBase(this,us)[us]=new os(e);babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps]=new hs(e)}var fs=babelHelpers.classPrivateFieldLooseKey("store");var Bs=babelHelpers.classPrivateFieldLooseKey("uploadingService");var ms=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Is=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var Ms=babelHelpers.classPrivateFieldLooseKey("handlePagination");var ys=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var Cs=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var Ss=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var ws=babelHelpers.classPrivateFieldLooseKey("updateModels");var Os=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var Us=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var Rs=babelHelpers.classPrivateFieldLooseKey("getDialog");class Ds{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Rs,{value:Vs});Object.defineProperty(this,Us,{value:Ns});Object.defineProperty(this,Os,{value:ks});Object.defineProperty(this,ws,{value:xs});Object.defineProperty(this,Ss,{value:_s});Object.defineProperty(this,Cs,{value:As});Object.defineProperty(this,ys,{value:Ks});Object.defineProperty(this,Ms,{value:js});Object.defineProperty(this,Is,{value:Ts});Object.defineProperty(this,ms,{value:Es});Object.defineProperty(this,fs,{writable:true,value:void 0});Object.defineProperty(this,Bs,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs]=Ma.getInstance()}sendMessage(e){const{text:s="",fileId:a="",tempMessageId:t,dialogId:i}=e;if(!l.Type.isStringFilled(s)&&!l.Type.isStringFilled(a)){return Promise.resolve()}b.Logger.warn("SendingService: sendMessage",e);const r=babelHelpers.classPrivateFieldLooseBase(this,Is)[Is]({text:s,fileId:a,tempMessageId:t,dialogId:i});return babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms](i).then((()=>babelHelpers.classPrivateFieldLooseBase(this,ys)[ys](r))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Us)[Us]({force:true,dialogId:i});return babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss](r)})).then((e=>{if(r.withFile){return}b.Logger.warn("SendingService: sendMessage result -",e.data());babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]({oldId:r.temporaryId,newId:e.data(),dialogId:r.dialogId})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Os)[Os](r.temporaryId);console.error("SendingService: sendMessage error -",e)}))}sendFilesFromInput(e,s){if(e.length===0){return}babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].uploadFiles({files:e,dialogId:s,autoUpload:true}).then((({files:e})=>{e.forEach((e=>{this.sendMessage({fileId:e.getId(),tempMessageId:e.getCustomData("tempMessageId"),dialogId:e.getCustomData("dialogId")})}))})).catch((e=>{b.Logger.error("SendingService: sendFilesFromInput error",e)}))}sendFilesFromClipboard(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].uploadFiles({files:e,dialogId:s,autoUpload:false})}sendFilesFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,ms)[ms](e,s);babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].uploadFileFromDisk(a).then((()=>this.sendMessage({tempMessageId:a.tempMessageId,fileId:a.tempFileId,dialogId:a.dialogId}))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}sendMessagesWithFiles(e){const{groupFiles:s,text:a,uploaderId:t,dialogId:i,sendAsFile:r}=e;if(s){return}const l=[];const o=babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].getFiles(t);const d=a.length>0;if(o.length>1&&d){l.push({dialogId:i,text:a})}o.forEach((e=>{var s;if(e.getError()){return}const t=h.Utils.text.getUuidV4();e.setCustomData("messageId",t);if(o.length===1&&d){e.setCustomData("messageText",a)}if(r){e.setCustomData("sendAsFile",true)}l.push({fileId:e.getId(),tempMessageId:e.getCustomData("tempMessageId"),dialogId:e.getCustomData("dialogId"),text:(s=e.getCustomData("messageText"))!=null?s:""})}));l.forEach((e=>{this.sendMessage(e)}));babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].start(t)}destroy(){babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].destroy()}}function Es(e,s){const a=h.Utils.text.getUuidV4();const t=e.id.slice(1);const i=`${a}|${t}`;return{tempMessageId:a,tempFileId:i,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](s).chatId}}function Ts(e){const{text:s,fileId:a,tempMessageId:t,dialogId:i}=e;const r={};if(a){r.FILE_ID=[a]}const l=t||h.Utils.text.getUuidV4();return{temporaryId:l,chatId:babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](i).chatId,dialogId:i,authorId:n.Core.getUserId(),text:s,params:r,withFile:Boolean(a),unread:false,sending:true}}function js(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e).hasNextPage){return Promise.resolve()}b.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new Ls({chatId:babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e).chatId});return s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e).lastMessageId).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Us)[Us]({dialogId:e})})).catch((e=>{console.error("SendingService: loadContext error",e)}))}function Ks(e){babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs](e);babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("dialogues/clearLastMessageViews",{dialogId:e.dialogId});return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("messages/add",e)}function As(e){const s=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].getters["recent/get"](e.dialogId);if(!s||e.text===""){return}babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("recent/update",{id:e.dialogId,fields:{message:{id:e.temporaryId,text:e.text,authorId:e.authorId,status:g.MessageStatus.received,sending:true,params:{withFile:false,withAttach:false}}}})}function _s(e){if(e.withFile){return Promise.resolve()}const s={template_id:e.temporaryId,dialog_id:e.dialogId};if(e.text){s.message=e.text}return n.Core.getRestClient().callMethod(g.RestMethod.imMessageAdd,s)}function xs(e){const{oldId:s,newId:a,dialogId:t}=e;babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("messages/updateWithId",{id:s,fields:{id:a}});babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("dialogues/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}});babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("recent/update",{id:t,fields:{message:{sending:false}}})}function ks(e){babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].dispatch("messages/update",{id:e,fields:{error:true}})}function Ns(e={}){const{force:s=false,dialogId:a}=e;p.EventEmitter.emit(g.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](a).chatId,threshold:s?g.DialogScrollThreshold.none:g.DialogScrollThreshold.halfScreenUp})}function Vs(e){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].getters["dialogues/get"](e,true)}Ds.instance=null;class Gs{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=n.Core.getStore();this.restClient=n.Core.getRestClient();this.deleteWithDebounce=l.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new o.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).then((e=>{b.Logger.warn(`NotificationService: sendConfirmAction: success`,e)})).catch((e=>{console.error(e)}))}sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=(()=>{}),callbackError:i=(()=>{})}=e;this.restClient.callMethod(g.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a}).then((e=>{t(e)})).catch((e=>{console.error(e);i()}))}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).then((s=>{b.Logger.warn(`NotificationService: deleteRequest: success for ids: ${e}`,s)})).catch((e=>{console.error(e)}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[g.RestMethodHandler.imNotifyGet]:[g.RestMethod.imNotifyGet,s]};if(!e){s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}else{a[g.RestMethodHandler.imNotifySchemaGet]=[g.RestMethod.imNotifySchemaGet,{}]}return new Promise((e=>{this.restClient.callBatch(a,(s=>{b.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[g.RestMethodHandler.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){b.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[g.RestMethodHandler.imNotifySchemaGet]){return e[g.RestMethodHandler.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===g.NotificationTypesCodes.confirm?g.NotificationTypesCodes.confirm:g.NotificationTypesCodes.simple}isLastPage(e){if(!l.Type.isArrayFilled(e)||e.length<this.limitPerPage){return true}return false}destroy(){b.Logger.warn("Notification service destroyed")}}var Xs=babelHelpers.classPrivateFieldLooseKey("restClient");class qs{constructor(){Object.defineProperty(this,Xs,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs]=n.Core.getRestClient()}delete({chatId:e,fileId:s}){const a={chat_id:e,file_id:s};return babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].callMethod(g.RestMethod.imDiskFileDelete,a).catch((e=>{console.error("DiskService: error deleting file",e)}))}save(e){const s={file_id:e};return babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].callMethod(g.RestMethod.imDiskFileSave,s).catch((e=>{console.error("DiskService: error saving file on disk",e)}))}}class Ws extends u{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return this.store.getters["recent/getUnreadCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){this.isLoading=true;return this.requestItems({firstPage:true})}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const i=this.store.dispatch("users/set",s);const r=this.store.dispatch("dialogues/set",a);const l=this.getFakeData(t);const o=this.store.dispatch("recent/setUnread",l);return Promise.all([i,r,o])}getFakeData(e){e=e.slice(-4);e.forEach((e=>{this.store.dispatch("dialogues/update",{dialogId:e.id,fields:{counter:7}})}));return e}onUpdateState({data:e}){}}Ws.instance=null;var Ys=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var zs=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var Qs=babelHelpers.classPrivateFieldLooseKey("addFile");var $s=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var Js=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class Zs extends p.EventEmitter{constructor(){super();Object.defineProperty(this,Js,{value:aa});Object.defineProperty(this,$s,{value:sa});Object.defineProperty(this,Qs,{value:ea});Object.defineProperty(this,Ys,{writable:true,value:{}});Object.defineProperty(this,zs,{writable:true,value:void 0});this.setEventNamespace(Zs.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,zs)[zs]=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s].bind(this);p.EventEmitter.subscribe(g.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,zs)[zs])}createUploader(e){const{diskFolderId:s,uploaderId:a,autoUpload:t}=e;babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][a]=new v.Uploader({autoUpload:t,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile"),imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:400,imagePreviewWidth:400,events:{[v.UploaderEvent.FILE_ADD_START]:e=>{this.emit(Zs.events.onFileAddStart,e)},[v.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(Zs.events.onFileUploadStart,e)},[v.UploaderEvent.FILE_ADD]:e=>{this.emit(Zs.events.onFileAdd,e)},[v.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(Zs.events.onFileUploadProgress,e)},[v.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{this.emit(Zs.events.onFileUploadComplete,e)},[v.UploaderEvent.ERROR]:e=>{this.emit(Zs.events.onFileUploadError,e)},[v.UploaderEvent.FILE_ERROR]:e=>{this.emit(Zs.events.onFileUploadError,e)},[v.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(Zs.events.onMaxFileCountExceeded,e)},[v.UploaderEvent.UPLOAD_COMPLETE]:()=>{babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][a].destroy({removeFilesFromServer:false})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][e].start()}addFiles(e){const s=[];e.forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Qs)[Qs](e);if(a){s.push(a)}}));return s}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][e].getFiles()}destroy(){p.EventEmitter.unsubscribe(g.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,zs)[zs])}}function ea(e){return babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId}})}function sa(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,Js)[Js](s);this.emit(Zs.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function aa(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}Zs.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";Zs.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded"};var ta=babelHelpers.classPrivateFieldLooseKey("store");var ia=babelHelpers.classPrivateFieldLooseKey("restClient");var ra=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var la=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var oa=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var da=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var ca=babelHelpers.classPrivateFieldLooseKey("initUploader");var na=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var ha=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var ba=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFile");var pa=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var va=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var ga=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var ua=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var Pa=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var Fa=babelHelpers.classPrivateFieldLooseKey("preparePreview");var La=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var Ha=babelHelpers.classPrivateFieldLooseKey("getFileType");var fa=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var Ba=babelHelpers.classPrivateFieldLooseKey("getDialog");var ma=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var Ia=babelHelpers.classPrivateFieldLooseKey("getChatId");class Ma{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Ia,{value:Na});Object.defineProperty(this,ma,{value:ka});Object.defineProperty(this,Ba,{value:xa});Object.defineProperty(this,fa,{value:_a});Object.defineProperty(this,Ha,{value:Aa});Object.defineProperty(this,La,{value:Ka});Object.defineProperty(this,Fa,{value:ja});Object.defineProperty(this,Pa,{value:Ta});Object.defineProperty(this,ua,{value:Ea});Object.defineProperty(this,ga,{value:Da});Object.defineProperty(this,va,{value:Ra});Object.defineProperty(this,pa,{value:Ua});Object.defineProperty(this,ba,{value:Oa});Object.defineProperty(this,ha,{value:wa});Object.defineProperty(this,na,{value:Sa});Object.defineProperty(this,ca,{value:Ca});Object.defineProperty(this,da,{value:ya});Object.defineProperty(this,ta,{writable:true,value:void 0});Object.defineProperty(this,ia,{writable:true,value:void 0});Object.defineProperty(this,ra,{writable:true,value:false});Object.defineProperty(this,la,{writable:true,value:{}});Object.defineProperty(this,oa,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ta)[ta]=n.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ia)[ia]=n.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]()}uploadFiles(e){const{files:s,dialogId:a,autoUpload:t}=e;const i=h.Utils.text.getUuidV4();return this.checkDiskFolderId(a).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].createUploader({diskFolderId:e,uploaderId:i,autoUpload:t});const r=[];s.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,ba)[ba](e,a,i);r.push(s)}));const l=babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].addFiles(r);return{files:l,uploaderId:i}}))}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].start(e)}uploadFileFromDisk(e){return babelHelpers.classPrivateFieldLooseBase(this,da)[da](e)}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,La)[La](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,La)[La](e))}if(babelHelpers.classPrivateFieldLooseBase(this,ra)[ra]){return babelHelpers.classPrivateFieldLooseBase(this,la)[la][e]}babelHelpers.classPrivateFieldLooseBase(this,la)[la][e]=babelHelpers.classPrivateFieldLooseBase(this,na)[na](e);return babelHelpers.classPrivateFieldLooseBase(this,la)[la][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:i,fromDisk:r,messageText:l="",sendAsFile:o=false}=e;const d={};if(r){d.disk_id=i}else{d.upload_id=i.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,ia)[ia].callMethod(g.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:a,file_template_id:s,as_file:o?"Y":"N",...d}).catch((e=>{b.Logger.error("commitFile error",e)}))}destroy(){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].destroy()}}function ya(e){return babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:n.Core.getUserId(),name:e.file.name,type:h.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:g.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,ma)[ma]().name})}function Ca(){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]=new Zs;babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ga)[ga](s)}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileAdd,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ua)[ua](s)}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Pa)[Pa](s)}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,pa)[pa](s.getId(),s.getProgress(),g.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileUploadComplete,(e=>{var s;const{file:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,pa)[pa](a.getId(),a.getProgress(),g.FileStatus.wait);babelHelpers.classPrivateFieldLooseBase(this,ha)[ha](a);this.commitFile({realFileId:a.getServerFileId(),temporaryFileId:a.getId(),chatId:a.getCustomData("chatId"),tempMessageId:a.getCustomData("tempMessageId"),messageText:(s=a.getCustomData("messageText"))!=null?s:"",sendAsFile:a.getCustomData("sendAsFile"),fromDisk:false})}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileUploadError,(e=>{const{file:s,error:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,pa)[pa](s.getId(),0,g.FileStatus.error);b.Logger.error("FilesService: upload error",a)}));babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].subscribe(Zs.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,va)[va](s,a)}))}function Sa(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,ra)[ra]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia](e);babelHelpers.classPrivateFieldLooseBase(this,ia)[ia].callMethod(g.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,ra)[ra]=false;babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].commit("dialogues/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ra)[ra]=false;a(e)}))}))}function wa(e){const s=e.getServerFileId().toString().slice(1);const a=e.getClientPreview();if(!a){return}const t=new FormData;t.append("id",s);t.append("previewFile",a,`preview_${e.getName()}.jpg`);c.runAction(g.RestMethod.imDiskFilePreviewUpload,{data:t}).catch((e=>{b.Logger.error("imDiskFilePreviewUpload request error",e)}))}function Oa(e,s,a){const t=h.Utils.text.getUuidV4();const i=h.Utils.text.getUuidV4();const r=babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia](s);return{tempMessageId:t,tempFileId:i,file:e,dialogId:s,chatId:r,uploaderId:a}}function Ua(e,s,a){babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function Ra(e,s){babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("messages/delete",{id:e});babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/delete",{id:s})}function Da(e){const s=e.getId();const a=e.getBinary();const t=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa](e);babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:n.Core.getUserId(),name:a.name,type:babelHelpers.classPrivateFieldLooseBase(this,Ha)[Ha](a),extension:babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](a),status:e.isFailed()?g.FileStatus.error:g.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,ma)[ma]().name,...t})}function Ea(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa](e);babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/update",{id:e.getId(),fields:{...s}})}function Ta(e){babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function ja(e){const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}return a}function Ka(e){return babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e).diskFolderId}function Aa(e){let s=g.FileType.file;if(e.type.startsWith("image")){s=g.FileType.image}else if(e.type.startsWith("video")){s=g.FileType.video}return s}function _a(e){return e.name.split(".").splice(-1)[0]}function xa(e){return babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].getters["dialogues/get"](e)}function ka(){const e=n.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].getters["users/get"](e)}function Na(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e))==null?void 0:s.chatId}Ma.instance=null;e.RecentService=u;e.ChatService=Ie;e.MessageService=Ls;e.SendingService=Ds;e.NotificationService=Gs;e.DiskService=qs;e.UnreadRecentService=Ws;e.UploadingService=Ma})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Vue3.Vuex,BX,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Event,BX.UI.Uploader,BX.Messenger.v2.Const);
//# sourceMappingURL=registry.bundle.map.js