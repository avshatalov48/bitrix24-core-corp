this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,r,i,l,o,d,c,n,b,h,p,v,u){"use strict";class g{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.store=null;this.restClient=null;this.dataIsPreloaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null;this.store=p.Core.getStore();this.restClient=p.Core.getRestClient()}getCollection(){return this.store.getters["recent/getRecentCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){n.Logger.warn(`Im.RecentList: first page was preloaded`);return Promise.resolve()}this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){n.Logger.warn(`Im.RecentList: setting preloaded data`,e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){n.Logger.warn(`Im.RecentList: hide chat`,e);const s=this.store.getters["recent/get"](e);if(!s){return false}this.store.dispatch("recent/delete",{id:e});const a=this.store.getters["application/isChatOpen"](e);if(a){t.Messenger.openChat()}this.restClient.callMethod(v.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);return this.restClient.callMethod(this.getQueryMethod(),s).then((s=>{this.pagesLoaded++;n.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,s.data());const{items:a,hasMore:t}=s.data();this.lastMessageDate=this.getLastMessageDate(a);if(!t){this.hasMoreItemsToLoad=false}return this.updateModels(s.data()).then((()=>{this.isLoading=false}))})).catch((e=>{console.error("Im.RecentList: page request error",e)}))}getQueryMethod(){return v.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y"}}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const r=this.store.dispatch("users/set",s);if(e.botList){this.store.dispatch("users/setBotList",e.botList)}const i=this.store.dispatch("dialogues/set",a);const l=this.store.dispatch("recent/setRecent",t);return Promise.all([r,i,l])}prepareDataForModels({items:e,birthdayList:s=[]}){const a={users:[],dialogues:[],recent:[]};e.forEach((e=>{if(e.user&&e.user.id&&!this.isAddedAlready(a,"users",e.user.id)){a.users.push(e.user)}if(e.chat){a.dialogues.push(this.prepareGroupChat(e));if(e.user.id&&!this.isAddedAlready(a,"dialogues",e.user.id)){a.dialogues.push(this.prepareChatForAdditionalUser(e.user))}}else if(e.user.id){const s=this.store.getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){a.dialogues.push(this.prepareChatForUser(e))}}a.recent.push({...e})}));s.forEach((e=>{if(!this.isAddedAlready(a,"users",e.id)){a.users.push(e);a.dialogues.push(this.prepareChatForAdditionalUser(e))}if(!this.isAddedAlready(a,"recent",e.id)){a.recent.push(this.getBirthdayPlaceholder(e))}}));n.Logger.warn(`Im.RecentList: prepared data for models`,a);return a}isAddedAlready(e,s,a){if(s==="users"){return e.users.some((e=>e.id===a))}else if(s==="dialogues"){return e.dialogues.some((e=>e.dialogId===a))}else if(s==="recent"){return e.recent.some((e=>e.id===a))}return false}prepareGroupChat(e){return{...e.chat,counter:e.counter,dialogId:e.id}}prepareChatForUser(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:v.DialogType.user,counter:e.counter,role:v.UserRole.member}}prepareChatForAdditionalUser(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:v.DialogType.user,role:v.UserRole.member}}getBirthdayPlaceholder(e){return{id:e.id,options:{birthdayPlaceholder:true}}}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}}g.instance=null;var P=babelHelpers.classPrivateFieldLooseKey("restResult");class F{constructor(e){Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,P)[P]=e}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.id}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.dialogId}isOpenlinesChat(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.type===v.DialogType.lines}getChats(){const e={...babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat,hasPrevPage:babelHelpers.classPrivateFieldLooseBase(this,P)[P].hasPrevPage,hasNextPage:babelHelpers.classPrivateFieldLooseBase(this,P)[P].hasNextPage};const s={[babelHelpers.classPrivateFieldLooseBase(this,P)[P].chat.dialogId]:e};babelHelpers.classPrivateFieldLooseBase(this,P)[P].users.forEach((e=>{if(s[e.id]){s[e.id]={...s[e.id],...u.UserManager.getDialogForUser(e)}}else{s[e.id]=u.UserManager.getDialogForUser(e)}}));return Object.values(s)}getFiles(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].files)!=null?e:[]}getUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].users)!=null?e:[]}getAdditionalUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].usersShort)!=null?e:[]}getMessages(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].messages)!=null?e:[]}getMessagesToStore(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].additionalMessages)!=null?e:[]}getPinnedMessageIds(){var e;const s=[];const a=(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].pins)!=null?e:[];a.forEach((e=>{s.push(e.messageId)}));return s}getReactions(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].reactions)!=null?e:[]}}var L=babelHelpers.classPrivateFieldLooseKey("store");var H=babelHelpers.classPrivateFieldLooseKey("requestChat");var f=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoading");var B=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoaded");var m=babelHelpers.classPrivateFieldLooseKey("isDialogLoadedMarkNeeded");var y=babelHelpers.classPrivateFieldLooseKey("updateModels");class I{constructor(){Object.defineProperty(this,y,{value:U});Object.defineProperty(this,m,{value:w});Object.defineProperty(this,B,{value:S});Object.defineProperty(this,f,{value:C});Object.defineProperty(this,H,{value:M});Object.defineProperty(this,L,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,L)[L]=p.Core.getStore()}loadChat(e){const s={dialogId:e};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](v.RestMethod.imV2ChatShallowLoad,s)}loadChatWithMessages(e){const a={dialogId:e,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](v.RestMethod.imV2ChatLoad,a)}loadChatWithContext(e,a){const t={dialogId:e,messageId:a,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,H)[H](v.RestMethod.imV2ChatLoadInContext,t)}prepareDialogId(e){if(!b.Utils.dialog.isExternalId(e)){return Promise.resolve(e)}return o.runAction(v.RestMethod.imV2ChatGetDialogId,{data:{externalId:e}}).then((e=>e.dialogId)).catch((e=>{console.error("ChatService: Load: error preparing external id",e)}))}}function M(e,s){const{dialogId:a}=s;babelHelpers.classPrivateFieldLooseBase(this,f)[f](a);return o.runAction(e,{data:s}).then((e=>babelHelpers.classPrivateFieldLooseBase(this,y)[y](e))).then((s=>{if(c.Type.isStringFilled(s==null?void 0:s.linesDialogId)){t.Messenger.openLines(s.linesDialogId);return}if(babelHelpers.classPrivateFieldLooseBase(this,m)[m](e)){babelHelpers.classPrivateFieldLooseBase(this,B)[B](a)}})).catch((e=>{console.error("ChatService: Load: error loading chat",e);throw e}))}function C(e){babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{loading:true}})}function S(e){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{inited:true,loading:false}})}function w(e){return e!==v.RestMethod.imV2ChatShallowLoad}function U(e){const s=new F(e);if(s.isOpenlinesChat()){return Promise.resolve({linesDialogId:s.getDialogId()})}const a=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/set",s.getChats());const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/set",s.getFiles());const r=new u.UserManager;const i=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("users/set",s.getUsers()),r.addUsersToModel(s.getAdditionalUsers())]);const l=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessageIds()}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/reactions/set",s.getReactions())]);return Promise.all([a,t,i,l])}const O="CHAT";const R="OPEN";var D=babelHelpers.classPrivateFieldLooseKey("restClient");var j=babelHelpers.classPrivateFieldLooseKey("store");var K=babelHelpers.classPrivateFieldLooseKey("prepareFields");var E=babelHelpers.classPrivateFieldLooseKey("addChatToModel");class T{constructor(){Object.defineProperty(this,E,{value:x});Object.defineProperty(this,K,{value:A});Object.defineProperty(this,D,{writable:true,value:void 0});Object.defineProperty(this,j,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,D)[D]=p.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,j)[j]=p.Core.getStore()}async createChat(e){n.Logger.warn("ChatService: createChat",e);const s=await babelHelpers.classPrivateFieldLooseBase(this,K)[K](e);const a=await babelHelpers.classPrivateFieldLooseBase(this,D)[D].callMethod(v.RestMethod.imV2ChatAdd,{fields:s}).catch((e=>{console.error("ChatService: createChat error:",e);throw new Error(e)}));const{chatId:t}=a.data();n.Logger.warn("ChatService: createChat result",t);const r=`chat${t}`;babelHelpers.classPrivateFieldLooseBase(this,E)[E](r,s);return r}}async function A(e){var s,a,t,r;const i={...e};if(i.avatar){i.avatar=await b.Utils.file.getBase64(e.avatar)}i.managers=(s=i.managers)!=null?s:[];const l=[...i.members,...i.managers,i.ownerId];i.members=[...new Set(l)];return{entityType:(a=(t=i.type)==null?void 0:t.toUpperCase())!=null?a:null,title:i.title,avatar:i.avatar,description:i.description,users:i.members,managers:i.managers,ownerId:i.ownerId,searchable:i.isAvailableInSearch?"Y":"N",manageUsers:i.manageUsers,manageUi:i.manageUi,manageSettings:i.manageSettings,canPost:i.canPost,conferencePassword:(r=i.conferencePassword)!=null?r:null}}function x(e,s){let a=s.searchable==="Y"?R:O;if(c.Type.isStringFilled(s.entityType)){a=s.entityType.toLowerCase()}babelHelpers.classPrivateFieldLooseBase(this,j)[j].dispatch("dialogues/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.users.length,role:v.UserRole.owner,canPost:s.canPost})}const _=180;class k{async prepareAvatar(e){if(!l.isResizableImage(e)){return Promise.reject(new Error("UpdateService: prepareAvatar: incorrect image"))}const{preview:s}=await l.resizeImage(e,{width:_,height:_});return s}async changeAvatar(e,s){n.Logger.warn("ChatService: changeAvatar",e,s);const a=await b.Utils.file.getBase64(s);return o.runAction(v.RestMethod.imV2ChatUpdate,{data:{id:e,fields:{avatar:a}}}).catch((e=>{console.error("ChatService: changeAvatar error:",e);throw new Error(e)}))}}var N=babelHelpers.classPrivateFieldLooseKey("store");var V=babelHelpers.classPrivateFieldLooseKey("restClient");var G=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class X{constructor(){Object.defineProperty(this,G,{value:q});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,V,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,N)[N]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,V)[V]=p.Core.getRestClient()}renameChat(e,s){n.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,N)[N].getters["dialogues/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,G)[G](e,s);return babelHelpers.classPrivateFieldLooseBase(this,V)[V].callMethod(v.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).then((e=>{n.Logger.warn("ChatService: renameChat result",e.data());return Promise.resolve()})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,G)[G](e,t);throw new Error("Chat rename error")}))}}function q(e,s){babelHelpers.classPrivateFieldLooseBase(this,N)[N].dispatch("dialogues/update",{dialogId:e,fields:{name:s}})}var W=babelHelpers.classPrivateFieldLooseKey("store");var z=babelHelpers.classPrivateFieldLooseKey("restClient");var Q=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var Y=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class ${constructor(){Object.defineProperty(this,Y,{value:J});Object.defineProperty(this,W,{writable:true,value:void 0});Object.defineProperty(this,z,{writable:true,value:void 0});Object.defineProperty(this,Q,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,W)[W]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,z)[z]=p.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]=c.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,Y)[Y],Oe.DEBOUNCE_TIME)}muteChat(e){n.Logger.warn("ChatService: muteChat",e);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("dialogues/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](s)}unmuteChat(e){n.Logger.warn("ChatService: unmuteChat",e);babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch("dialogues/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](s)}}function J(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,z)[z].callMethod(v.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e);const r=a==="Y"?"dialogues/unmute":"dialogues/mute";babelHelpers.classPrivateFieldLooseBase(this,W)[W].dispatch(r,{dialogId:s})}))}var Z=babelHelpers.classPrivateFieldLooseKey("store");var ee=babelHelpers.classPrivateFieldLooseKey("restClient");class se{constructor(){Object.defineProperty(this,Z,{writable:true,value:void 0});Object.defineProperty(this,ee,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=p.Core.getRestClient()}pinChat(e){n.Logger.warn("PinService: pinChat",e);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("recent/pin",{id:e,action:true,dateUpdate:new Date});const s={DIALOG_ID:e,ACTION:"Y"};babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].callMethod(v.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error pinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){n.Logger.warn("PinService: unpinChat",e);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("recent/pin",{id:e,action:false,dateUpdate:new Date});const s={DIALOG_ID:e,ACTION:"N"};babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].callMethod(v.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error unpinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("recent/pin",{id:e,action:true})}))}}const ae=300;var te=babelHelpers.classPrivateFieldLooseKey("store");var re=babelHelpers.classPrivateFieldLooseKey("restClient");var ie=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var le=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var oe=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var de=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var ce=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var ne=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var be=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class he{constructor(){Object.defineProperty(this,be,{value:Fe});Object.defineProperty(this,ne,{value:Pe});Object.defineProperty(this,ce,{value:ge});Object.defineProperty(this,de,{value:ue});Object.defineProperty(this,oe,{value:ve});Object.defineProperty(this,le,{value:pe});Object.defineProperty(this,te,{writable:true,value:void 0});Object.defineProperty(this,re,{writable:true,value:void 0});Object.defineProperty(this,ie,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,te)[te]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,re)[re]=p.Core.getRestClient()}readAll(){n.Logger.warn("ReadService: readAll");babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/clearCounters");babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,re)[re].callMethod(v.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e)}))}readDialog(e){n.Logger.warn("ReadService: readDialog",e);babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("recent/unread",{id:e,action:false,dateUpdate:new Date});babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,re)[re].callMethod(v.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e)}))}unreadDialog(e){n.Logger.warn("ReadService: unreadDialog",e);babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("recent/unread",{id:e,action:true,dateUpdate:new Date});babelHelpers.classPrivateFieldLooseBase(this,re)[re].callMethod(v.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s);babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,ie)[ie][e]){babelHelpers.classPrivateFieldLooseBase(this,ie)[ie][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,ie)[ie][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]).forEach((([e,s])=>{e=+e;n.Logger.warn("ReadService: readMessages",s);if(s.size===0){return}const a=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,ie)[ie][e];babelHelpers.classPrivateFieldLooseBase(this,le)[le](e,a).then((s=>{n.Logger.warn("ReadService: readMessage, need to reduce counter by",s);return babelHelpers.classPrivateFieldLooseBase(this,oe)[oe](e,s)})).then((()=>babelHelpers.classPrivateFieldLooseBase(this,de)[de](e,a))).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](e)})).catch((e=>{console.error("ReadService: error reading message",e)}))}))}),ae)}clearDialogMark(e){n.Logger.warn("ReadService: clear dialog mark",e);const s=babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["dialogues/get"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["recent/get"](e);if(s.markedId===0&&!(a!=null&&a.unread)){return}babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("recent/unread",{id:e,action:false,dateUpdate:new Date});babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,re)[re].callMethod(v.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:"Y"}).catch((e=>{console.error("ReadService: error clearing dialog mark",e)}))}}function pe(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,be)[be](e);if(a>t.lastReadId){babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function ve(e,s){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/decreaseCounter",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e),count:s})}function ue(e,s){n.Logger.warn("ReadService: readMessages on server",s);return o.runAction(v.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:s,actionUuid:a.UuidManager.getInstance().getActionUuid()}})}function ge(e){const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,be)[be](s);if(t.counter>a){n.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);babelHelpers.classPrivateFieldLooseBase(this,te)[te].dispatch("dialogues/update",{dialogId:t.dialogId,fields:{counter:a}})}}function Pe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["dialogues/getByChatId"](e);if(!s){return 0}return s.dialogId}function Fe(e){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].getters["dialogues/getByChatId"](e)}var Le=babelHelpers.classPrivateFieldLooseKey("store");var He=babelHelpers.classPrivateFieldLooseKey("restClient");class fe{constructor(){Object.defineProperty(this,Le,{writable:true,value:void 0});Object.defineProperty(this,He,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,He)[He]=p.Core.getRestClient()}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,He)[He].callMethod(v.RestMethod.imChatUserAdd,s)}kickUserFromChat(e,s){n.Logger.warn(`UserService: kick user ${s} from chat ${e}`);const a={dialogId:e,userId:s};babelHelpers.classPrivateFieldLooseBase(this,He)[He].callMethod(v.RestMethod.imV2ChatDeleteUser,a).catch((e=>{console.error("UserService: error kicking user from chat",e)}))}leaveChat(e){this.kickUserFromChat(e,p.Core.getUserId());babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].dispatch("dialogues/update",{dialogId:e,fields:{inited:false}});babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].getters["application/isChatOpen"](e);if(s){t.Messenger.openChat()}}joinChat(e){n.Logger.warn(`UserService: join chat ${e}`);babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].dispatch("dialogues/update",{dialogId:e,fields:{role:v.UserRole.member}});babelHelpers.classPrivateFieldLooseBase(this,He)[He].callMethod(v.RestMethod.imV2ChatJoin,{dialogId:e}).catch((e=>{console.error("UserService: error joining chat",e)}))}}var Be=babelHelpers.classPrivateFieldLooseKey("loadService");var me=babelHelpers.classPrivateFieldLooseKey("createService");var ye=babelHelpers.classPrivateFieldLooseKey("updateService");var Ie=babelHelpers.classPrivateFieldLooseKey("renameService");var Me=babelHelpers.classPrivateFieldLooseKey("muteService");var Ce=babelHelpers.classPrivateFieldLooseKey("pinService");var Se=babelHelpers.classPrivateFieldLooseKey("readService");var we=babelHelpers.classPrivateFieldLooseKey("userService");var Ue=babelHelpers.classPrivateFieldLooseKey("initServices");class Oe{constructor(){Object.defineProperty(this,Ue,{value:Re});Object.defineProperty(this,Be,{writable:true,value:void 0});Object.defineProperty(this,me,{writable:true,value:void 0});Object.defineProperty(this,ye,{writable:true,value:void 0});Object.defineProperty(this,Ie,{writable:true,value:void 0});Object.defineProperty(this,Me,{writable:true,value:void 0});Object.defineProperty(this,Ce,{writable:true,value:void 0});Object.defineProperty(this,Se,{writable:true,value:void 0});Object.defineProperty(this,we,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].loadChat(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].loadChatWithContext(e,s)}prepareDialogId(e){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].prepareDialogId(e)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,me)[me].createChat(e)}prepareAvatar(e){return babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].prepareAvatar(e)}changeAvatar(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ye)[ye].changeAvatar(e,s)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,Me)[Me].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,Me)[Me].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].unpinChat(e)}readAll(){return babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].readMessage(e,s)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,we)[we].leaveChat(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,we)[we].kickUserFromChat(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,we)[we].addToChat(e)}joinChat(e){babelHelpers.classPrivateFieldLooseBase(this,we)[we].joinChat(e)}}function Re(){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]=new I;babelHelpers.classPrivateFieldLooseBase(this,me)[me]=new T;babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]=new k;babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]=new X;babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]=new $;babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]=new se;babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]=new he;babelHelpers.classPrivateFieldLooseBase(this,we)[we]=new fe}Oe.DEBOUNCE_TIME=500;var De=babelHelpers.classPrivateFieldLooseKey("store");var je=babelHelpers.classPrivateFieldLooseKey("restClient");var Ke=babelHelpers.classPrivateFieldLooseKey("chatId");var Ee=babelHelpers.classPrivateFieldLooseKey("userManager");var Te=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var Ae=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var xe=babelHelpers.classPrivateFieldLooseKey("isLoading");var _e=babelHelpers.classPrivateFieldLooseKey("prepareInitialMessages");var ke=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var Ne=babelHelpers.classPrivateFieldLooseKey("updateModels");var Ve=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var Ge=babelHelpers.classPrivateFieldLooseKey("getDialog");class Xe{constructor(e){Object.defineProperty(this,Ge,{value:Ye});Object.defineProperty(this,Ve,{value:Qe});Object.defineProperty(this,Ne,{value:ze});Object.defineProperty(this,ke,{value:We});Object.defineProperty(this,_e,{value:qe});Object.defineProperty(this,De,{writable:true,value:void 0});Object.defineProperty(this,je,{writable:true,value:void 0});Object.defineProperty(this,Ke,{writable:true,value:void 0});Object.defineProperty(this,Ee,{writable:true,value:void 0});Object.defineProperty(this,Te,{writable:true,value:[]});Object.defineProperty(this,Ae,{writable:true,value:[]});Object.defineProperty(this,xe,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,De)[De]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,je)[je]=p.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]=new u.UserManager;babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=e}loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]||!babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().hasNextPage){return Promise.resolve(false)}n.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,De)[De].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]);if(!e){n.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke],filter:{lastId:e},order:{id:"ASC"},limit:Xe.MESSAGE_REQUEST_LIMIT};return o.runAction(v.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{n.Logger.warn("MessageService: loadUnread result",e);babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae]=e.messages;return babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne](e)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false;return true})).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false}))}loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]||!babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().hasPrevPage){return Promise.resolve(false)}n.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,De)[De].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]);if(!e){n.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke],filter:{lastId:e},order:{id:"DESC"},limit:Xe.MESSAGE_REQUEST_LIMIT};return o.runAction(v.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{n.Logger.warn("MessageService: loadHistory result",e);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=e.messages;const s=e.hasNextPage;const a={...e,hasPrevPage:s,hasNextPage:null};return babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne](a)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false;return true})).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false}))}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae]=[];return true}))}loadContext(e){const s={[v.RestMethod.imV2ChatMessageGetContext]:{id:e,range:Xe.MESSAGE_REQUEST_LIMIT},[v.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke],ids:[e]}};n.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=true;return o.callBatch(s).then((e=>{n.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](e[v.RestMethod.imV2ChatMessageGetContext])})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false}))}reloadMessageList(){n.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().chatId<=0){return Promise.resolve()}if(babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().inited;babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve](false);if(e){return this.loadContext(e).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve](true,s)}))}return this.loadInitialMessages().then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve](true,s)}))}loadInitialMessages(){n.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]);babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=true;return babelHelpers.classPrivateFieldLooseBase(this,je)[je].callMethod(v.RestMethod.imV2ChatMessageList,{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke],limit:Xe.MESSAGE_REQUEST_LIMIT}).then((e=>{n.Logger.warn("MessageService: loadInitialMessages result",e.data());const s=e.data();s.messages=babelHelpers.classPrivateFieldLooseBase(this,_e)[_e](s.messages);return babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](e.data())})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false;return true})).catch((e=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=false}))}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]}}function qe(e){if(e.length===0){return e}const s=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().lastMessageId;const a=Math.max(...e.map((e=>e.id)));if(a>=s){return e}const t=babelHelpers.classPrivateFieldLooseBase(this,De)[De].getters["messages/get"](babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]);const r=t.filter((e=>e.id>a));n.Logger.warn("MessageService: loadInitialMessages: local id is higher than server one",r);return[...e,...r]}function We(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne](e);return Promise.all([a,t])}function ze(e){const{files:s,users:a,usersShort:t,reactions:r,hasPrevPage:i,hasNextPage:l,additionalMessages:o}=e;const d=babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().dialogId,fields:{hasPrevPage:i,hasNextPage:l}});const c=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].addUsersToModel(t)]);const n=babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("files/set",s);const b=babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("messages/reactions/set",r);const h=babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("messages/store",o);return Promise.all([d,n,c,b,h])}function Qe(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]().dialogId,fields:a})}function Ye(){return babelHelpers.classPrivateFieldLooseBase(this,De)[De].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke])}Xe.MESSAGE_REQUEST_LIMIT=25;var $e=babelHelpers.classPrivateFieldLooseKey("store");var Je=babelHelpers.classPrivateFieldLooseKey("restClient");class Ze{constructor(){Object.defineProperty(this,$e,{writable:true,value:void 0});Object.defineProperty(this,Je,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]=p.Core.getRestClient()}pinMessage(e,s){n.Logger.warn(`Dialog: PinManager: pin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].dispatch("messages/pin/add",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].callMethod(v.RestMethod.imV2ChatMessagePin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error pinning message",a);babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].dispatch("messages/pin/delete",{chatId:e,messageId:s})}))}unpinMessage(e,s){n.Logger.warn(`Dialog: PinManager: unpin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].dispatch("messages/pin/delete",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].callMethod(v.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error unpinning message",a);babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].dispatch("messages/pin/add",{chatId:e,messageId:s})}))}}var es=babelHelpers.classPrivateFieldLooseKey("store");var ss=babelHelpers.classPrivateFieldLooseKey("restClient");var as=babelHelpers.classPrivateFieldLooseKey("chatId");class ts{constructor(e){Object.defineProperty(this,es,{writable:true,value:void 0});Object.defineProperty(this,ss,{writable:true,value:void 0});Object.defineProperty(this,as,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,as)[as]=e;babelHelpers.classPrivateFieldLooseBase(this,es)[es]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]=p.Core.getRestClient()}editMessageText(e,s){n.Logger.warn("MessageService: editMessageText",e,s);babelHelpers.classPrivateFieldLooseBase(this,es)[es].dispatch("messages/update",{id:e,fields:{text:s,isEdited:true}});const a=babelHelpers.classPrivateFieldLooseBase(this,es)[es].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,as)[as]);if(e===a.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,es)[es].dispatch("recent/update",{id:a.dialogId,fields:{message:{text:s},dateUpdate:new Date}})}babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].callMethod(v.RestMethod.imMessageUpdate,{ID:e,MESSAGE:s}).catch((e=>{n.Logger.error("MessageService: editMessageText error:",e)}))}}var rs=babelHelpers.classPrivateFieldLooseKey("store");var is=babelHelpers.classPrivateFieldLooseKey("chatId");var ls=babelHelpers.classPrivateFieldLooseKey("shallowMessageDelete");var os=babelHelpers.classPrivateFieldLooseKey("completeMessageDelete");var ds=babelHelpers.classPrivateFieldLooseKey("deleteMessageOnServer");class cs{constructor(e){Object.defineProperty(this,ds,{value:hs});Object.defineProperty(this,os,{value:bs});Object.defineProperty(this,ls,{value:ns});Object.defineProperty(this,rs,{writable:true,value:void 0});Object.defineProperty(this,is,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,is)[is]=e;babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]=p.Core.getStore()}deleteMessage(e){n.Logger.warn("MessageService: deleteMessage",e);const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["messages/getById"](e);if(s.viewedByOthers){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](s)}else{babelHelpers.classPrivateFieldLooseBase(this,os)[os](s)}}}function ns(e){babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("messages/update",{id:e.id,fields:{text:"",isDeleted:true,files:[],attach:[],replyId:0}});const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,is)[is]);if(e.id===s.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/update",{id:s.dialogId,fields:{message:{text:""}}})}babelHelpers.classPrivateFieldLooseBase(this,ds)[ds](e.id)}function bs(e){const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,is)[is]);const a=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["messages/getPreviousMessage"]({messageId:e.id,chatId:s.chatId});if(e.id===s.lastMessageId){let e={text:""};if(a){e=a}babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/update",{id:s.dialogId,fields:{message:e,dateUpdate:new Date}});const t=a?a.id:0;babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("dialogues/update",{dialogId:s.dialogId,fields:{lastMessageId:t,lastId:t}});babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("dialogues/clearLastMessageViews",{dialogId:s.dialogId})}babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("messages/delete",{id:e.id});babelHelpers.classPrivateFieldLooseBase(this,ds)[ds](e.id)}function hs(e){o.runAction(v.RestMethod.imV2ChatMessageDelete,{data:{id:e}}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}var ps=babelHelpers.classPrivateFieldLooseKey("chatId");var vs=babelHelpers.classPrivateFieldLooseKey("store");var us=babelHelpers.classPrivateFieldLooseKey("restClient");class gs{constructor(e){Object.defineProperty(this,ps,{writable:true,value:void 0});Object.defineProperty(this,vs,{writable:true,value:void 0});Object.defineProperty(this,us,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=e;babelHelpers.classPrivateFieldLooseBase(this,vs)[vs]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,us)[us]=p.Core.getRestClient()}markMessage(e){n.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]);babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].dispatch("recent/unread",{id:s,action:true,dateUpdate:new Date});babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].dispatch("dialogues/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,us)[us].callMethod(v.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e)}))}}var Ps=babelHelpers.classPrivateFieldLooseKey("chatId");var Fs=babelHelpers.classPrivateFieldLooseKey("store");var Ls=babelHelpers.classPrivateFieldLooseKey("restClient");class Hs{constructor(e){Object.defineProperty(this,Ps,{writable:true,value:void 0});Object.defineProperty(this,Fs,{writable:true,value:void 0});Object.defineProperty(this,Ls,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps]=e;babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls]=p.Core.getRestClient()}addMessageToFavorite(e){n.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls].callMethod(v.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e)}));BX.UI.Notification.Center.notify({content:c.Loc.getMessage("IM_MESSAGE_SERVICE_ADD_MESSAGE_TO_FAVORITE_SUCCESS")})}removeMessageFromFavorite(e){n.Logger.warn("MessageService: removeMessageFromFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls].callMethod(v.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e)}))}}var fs=babelHelpers.classPrivateFieldLooseKey("loadService");var Bs=babelHelpers.classPrivateFieldLooseKey("pinService");var ms=babelHelpers.classPrivateFieldLooseKey("editService");var ys=babelHelpers.classPrivateFieldLooseKey("deleteService");var Is=babelHelpers.classPrivateFieldLooseKey("markService");var Ms=babelHelpers.classPrivateFieldLooseKey("favoriteService");var Cs=babelHelpers.classPrivateFieldLooseKey("initServices");class Ss{static getMessageRequestLimit(){return Xe.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,Cs,{value:ws});Object.defineProperty(this,fs,{writable:true,value:void 0});Object.defineProperty(this,Bs,{writable:true,value:void 0});Object.defineProperty(this,ms,{writable:true,value:void 0});Object.defineProperty(this,ys,{writable:true,value:void 0});Object.defineProperty(this,Is,{writable:true,value:void 0});Object.defineProperty(this,Ms,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].loadContext(e)}reloadMessageList(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,ms)[ms].editMessageText(e,s)}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].deleteMessage(e)}}function ws(e){babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]=new Xe(e);babelHelpers.classPrivateFieldLooseBase(this,ms)[ms]=new ts(e);babelHelpers.classPrivateFieldLooseBase(this,ys)[ys]=new cs(e);babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs]=new Ze;babelHelpers.classPrivateFieldLooseBase(this,Is)[Is]=new gs(e);babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms]=new Hs(e)}var Us=babelHelpers.classPrivateFieldLooseKey("store");var Os=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var Rs=babelHelpers.classPrivateFieldLooseKey("handlePagination");var Ds=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var js=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var Ks=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var Es=babelHelpers.classPrivateFieldLooseKey("updateModels");var Ts=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var As=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var xs=babelHelpers.classPrivateFieldLooseKey("getDialog");class _s{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,xs,{value:Qs});Object.defineProperty(this,As,{value:zs});Object.defineProperty(this,Ts,{value:Ws});Object.defineProperty(this,Es,{value:qs});Object.defineProperty(this,Ks,{value:Xs});Object.defineProperty(this,js,{value:Gs});Object.defineProperty(this,Ds,{value:Vs});Object.defineProperty(this,Rs,{value:Ns});Object.defineProperty(this,Os,{value:ks});Object.defineProperty(this,Us,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Us)[Us]=p.Core.getStore()}sendMessage(e){const{text:s="",fileId:a="",tempMessageId:t,dialogId:r,replyId:i}=e;if(!c.Type.isStringFilled(s)&&!c.Type.isStringFilled(a)){return Promise.resolve()}n.Logger.warn("SendingService: sendMessage",e);const l=babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]({text:s,fileId:a,tempMessageId:t,dialogId:r,replyId:i});return babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](r).then((()=>babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds](l))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,As)[As]({force:true,dialogId:r});return babelHelpers.classPrivateFieldLooseBase(this,Ks)[Ks](l)})).then((e=>{if(l.withFile){return}n.Logger.warn("SendingService: sendMessage result -",e.data());babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]({oldId:l.temporaryId,newId:e.data(),dialogId:l.dialogId})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts](l.temporaryId);console.error("SendingService: sendMessage error -",e)}))}}function ks(e){const{text:s,fileId:a,tempMessageId:t,dialogId:r,replyId:i}=e;const l={};if(a){l.FILE_ID=[a]}const o=t||b.Utils.text.getUuidV4();return{temporaryId:o,chatId:babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](r).chatId,dialogId:r,replyId:i,authorId:p.Core.getUserId(),text:s,params:l,withFile:Boolean(a),unread:false,sending:true}}function Ns(e){if(!babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](e).hasNextPage){return Promise.resolve()}n.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new Ss({chatId:babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](e).chatId});return s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](e).lastMessageId).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,As)[As]({dialogId:e})})).catch((e=>{console.error("SendingService: loadContext error",e)}))}function Vs(e){babelHelpers.classPrivateFieldLooseBase(this,js)[js](e);babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("dialogues/clearLastMessageViews",{dialogId:e.dialogId});return babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("messages/add",e)}function Gs(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].getters["recent/get"](e.dialogId);if(!s||e.text===""){return}babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("recent/update",{id:e.dialogId,fields:{message:{id:e.temporaryId,text:e.text,authorId:e.authorId,replyId:e.replyId,status:v.MessageStatus.received,sending:true,params:{withFile:false,withAttach:false}},dateUpdate:new Date}})}function Xs(e){if(e.withFile){return Promise.resolve()}const s={template_id:e.temporaryId,dialog_id:e.dialogId};if(e.replyId!==0){s.reply_id=e.replyId}if(e.text){s.message=e.text}return p.Core.getRestClient().callMethod(v.RestMethod.imMessageAdd,s)}function qs(e){const{oldId:s,newId:a,dialogId:t,replyId:r}=e;babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("messages/updateWithId",{id:s,fields:{id:a}});babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("messages/update",{id:a,fields:{replyId:r}});babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("dialogues/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}});babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("recent/update",{id:t,fields:{message:{sending:false}}})}function Ws(e){babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].dispatch("messages/update",{id:e,fields:{error:true}})}function zs(e={}){const{force:s=false,dialogId:a}=e;i.EventEmitter.emit(v.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](a).chatId,threshold:s?v.DialogScrollThreshold.none:v.DialogScrollThreshold.halfScreenUp})}function Qs(e){return babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].getters["dialogues/get"](e,true)}_s.instance=null;class Ys{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=p.Core.getStore();this.restClient=p.Core.getRestClient();this.deleteWithDebounce=c.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new u.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).then((e=>{n.Logger.warn(`NotificationService: sendConfirmAction: success`,e)})).catch((e=>{console.error(e)}))}sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=(()=>{}),callbackError:r=(()=>{})}=e;this.restClient.callMethod(v.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a}).then((e=>{t(e)})).catch((e=>{console.error(e);r()}))}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).then((s=>{n.Logger.warn(`NotificationService: deleteRequest: success for ids: ${e}`,s)})).catch((e=>{console.error(e)}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[v.RestMethod.imNotifyGet]:[v.RestMethod.imNotifyGet,s]};if(!e){s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}else{a[v.RestMethod.imNotifySchemaGet]=[v.RestMethod.imNotifySchemaGet,{}]}return new Promise((e=>{this.restClient.callBatch(a,(s=>{n.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[v.RestMethod.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){n.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[v.RestMethod.imNotifySchemaGet]){return e[v.RestMethod.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===v.NotificationTypesCodes.confirm?v.NotificationTypesCodes.confirm:v.NotificationTypesCodes.simple}isLastPage(e){if(!c.Type.isArrayFilled(e)||e.length<this.limitPerPage){return true}return false}destroy(){n.Logger.warn("Notification service destroyed")}}var $s=babelHelpers.classPrivateFieldLooseKey("restClient");class Js{constructor(){Object.defineProperty(this,$s,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]=p.Core.getRestClient()}delete({chatId:e,fileId:s}){const a={chat_id:e,file_id:s};return babelHelpers.classPrivateFieldLooseBase(this,$s)[$s].callMethod(v.RestMethod.imDiskFileDelete,a).catch((e=>{console.error("DiskService: error deleting file",e)}))}save(e){const s={file_id:e};return babelHelpers.classPrivateFieldLooseBase(this,$s)[$s].callMethod(v.RestMethod.imDiskFileSave,s).catch((e=>{console.error("DiskService: error saving file on disk",e)}))}}class Zs extends g{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return this.store.getters["recent/getUnreadCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){this.isLoading=true;return this.requestItems({firstPage:true})}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const r=this.store.dispatch("users/set",s);const i=this.store.dispatch("dialogues/set",a);const l=this.getFakeData(t);const o=this.store.dispatch("recent/setUnread",l);return Promise.all([r,i,o])}getFakeData(e){e=e.slice(-4);e.forEach((e=>{this.store.dispatch("dialogues/update",{dialogId:e.id,fields:{counter:7}})}));return e}onUpdateState({data:e}){}}Zs.instance=null;var ea=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var sa=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var aa=babelHelpers.classPrivateFieldLooseKey("addFile");var ta=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var ra=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class ia extends i.EventEmitter{constructor(){super();Object.defineProperty(this,ra,{value:da});Object.defineProperty(this,ta,{value:oa});Object.defineProperty(this,aa,{value:la});Object.defineProperty(this,ea,{writable:true,value:{}});Object.defineProperty(this,sa,{writable:true,value:void 0});this.setEventNamespace(ia.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]=babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].bind(this);i.EventEmitter.subscribe(v.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,sa)[sa])}createUploader(e){const{diskFolderId:s,uploaderId:a,autoUpload:t}=e;babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][a]=new l.Uploader({autoUpload:t,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&e.getExtension()!=="gif",imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,events:{[l.UploaderEvent.FILE_ADD_START]:e=>{this.emit(ia.events.onFileAddStart,e)},[l.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(ia.events.onFileUploadStart,e)},[l.UploaderEvent.FILE_ADD]:e=>{const{file:s}=e.getData();this.emit(ia.events.onFileAdd,{file:s,uploaderId:a})},[l.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(ia.events.onFileUploadProgress,e)},[l.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{this.emit(ia.events.onFileUploadComplete,e)},[l.UploaderEvent.ERROR]:e=>{this.emit(ia.events.onFileUploadError,e)},[l.UploaderEvent.FILE_ERROR]:e=>{this.emit(ia.events.onFileUploadError,e)},[l.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(ia.events.onMaxFileCountExceeded,e)},[l.UploaderEvent.UPLOAD_COMPLETE]:()=>{babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][a].destroy({removeFilesFromServer:false})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][e].start()}addFiles(e){const s=[];e.forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,aa)[aa](e);if(a){s.push(a)}}));return s}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][e].getFiles()}destroy(){i.EventEmitter.unsubscribe(v.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,sa)[sa])}}function la(e){return babelHelpers.classPrivateFieldLooseBase(this,ea)[ea][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId,sendAsFile:e.sendAsFile}})}function oa(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](s);this.emit(ia.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function da(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}ia.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";ia.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded"};var ca=babelHelpers.classPrivateFieldLooseKey("store");var na=babelHelpers.classPrivateFieldLooseKey("restClient");var ba=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var ha=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var pa=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var va=babelHelpers.classPrivateFieldLooseKey("sendingService");var ua=babelHelpers.classPrivateFieldLooseKey("uploaderFilesRegistry");var ga=babelHelpers.classPrivateFieldLooseKey("createUploader");var Pa=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var Fa=babelHelpers.classPrivateFieldLooseKey("initUploader");var La=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var Ha=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var fa=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFile");var Ba=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var ma=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var ya=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var Ia=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var Ma=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var Ca=babelHelpers.classPrivateFieldLooseKey("preparePreview");var Sa=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var wa=babelHelpers.classPrivateFieldLooseKey("getFileType");var Ua=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var Oa=babelHelpers.classPrivateFieldLooseKey("getDialog");var Ra=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var Da=babelHelpers.classPrivateFieldLooseKey("getChatId");var ja=babelHelpers.classPrivateFieldLooseKey("registerFiles");var Ka=babelHelpers.classPrivateFieldLooseKey("setReadyFilePreview");var Ea=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var Ta=babelHelpers.classPrivateFieldLooseKey("setAutoUpload");var Aa=babelHelpers.classPrivateFieldLooseKey("createMessagesFromFiles");var xa=babelHelpers.classPrivateFieldLooseKey("readyToAddMessages");var _a=babelHelpers.classPrivateFieldLooseKey("tryToSendMessages");var ka=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Na=babelHelpers.classPrivateFieldLooseKey("showError");class Va{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Na,{value:gt});Object.defineProperty(this,ka,{value:ut});Object.defineProperty(this,_a,{value:vt});Object.defineProperty(this,xa,{value:pt});Object.defineProperty(this,Aa,{value:ht});Object.defineProperty(this,Ta,{value:bt});Object.defineProperty(this,Ea,{value:nt});Object.defineProperty(this,Ka,{value:ct});Object.defineProperty(this,ja,{value:dt});Object.defineProperty(this,Da,{value:ot});Object.defineProperty(this,Ra,{value:lt});Object.defineProperty(this,Oa,{value:it});Object.defineProperty(this,Ua,{value:rt});Object.defineProperty(this,wa,{value:tt});Object.defineProperty(this,Sa,{value:at});Object.defineProperty(this,Ca,{value:st});Object.defineProperty(this,Ma,{value:et});Object.defineProperty(this,Ia,{value:Za});Object.defineProperty(this,ya,{value:Ja});Object.defineProperty(this,ma,{value:$a});Object.defineProperty(this,Ba,{value:Ya});Object.defineProperty(this,fa,{value:Qa});Object.defineProperty(this,Ha,{value:za});Object.defineProperty(this,La,{value:Wa});Object.defineProperty(this,Fa,{value:qa});Object.defineProperty(this,Pa,{value:Xa});Object.defineProperty(this,ga,{value:Ga});Object.defineProperty(this,ca,{writable:true,value:void 0});Object.defineProperty(this,na,{writable:true,value:void 0});Object.defineProperty(this,ba,{writable:true,value:false});Object.defineProperty(this,ha,{writable:true,value:{}});Object.defineProperty(this,pa,{writable:true,value:void 0});Object.defineProperty(this,va,{writable:true,value:void 0});Object.defineProperty(this,ua,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,na)[na]=p.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,va)[va]=_s.getInstance();babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]()}addFilesFromClipboard(e,s){return l.getFilesFromDataTransfer(e).then((e=>{const a=e.filter((e=>b.Utils.file.isImage(e.name)));if(a.length===0){return{files:[],uploaderId:""}}return this.addFiles({files:a,dialogId:s,autoUpload:false})}))}addFilesFromInput(e,s,a){if(e.length===0){return}this.addFiles({files:e,dialogId:s,autoUpload:true,sendAsFile:a}).then((({uploaderId:e})=>{babelHelpers.classPrivateFieldLooseBase(this,_a)[_a](e)})).catch((e=>{n.Logger.error("SendingService: sendFilesFromInput error",e)}))}addFiles(e){const{files:s,dialogId:a,autoUpload:t,sendAsFile:r=false}=e;return babelHelpers.classPrivateFieldLooseBase(this,ga)[ga]({dialogId:a,autoUpload:t}).then((e=>{const i=[];s.forEach((s=>{const t=babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](s,a,e,r);i.push(t)}));const l=babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].addFiles(i);babelHelpers.classPrivateFieldLooseBase(this,ja)[ja](e,l,a,t);return{files:l,uploaderId:e}}))}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].autoUpload=true;babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].start(e)}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,ka)[ka](e,s);babelHelpers.classPrivateFieldLooseBase(this,Pa)[Pa](a).then((()=>{const e={tempMessageId:a.tempMessageId,fileId:a.tempFileId,dialogId:a.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,va)[va].sendMessage(e)})).then((()=>{this.commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,Sa)[Sa](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Sa)[Sa](e))}if(babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]){return babelHelpers.classPrivateFieldLooseBase(this,ha)[ha][e]}babelHelpers.classPrivateFieldLooseBase(this,ha)[ha][e]=babelHelpers.classPrivateFieldLooseBase(this,La)[La](e);return babelHelpers.classPrivateFieldLooseBase(this,ha)[ha][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:r,fromDisk:i,messageText:l="",sendAsFile:o=false}=e;const d={};if(i){d.disk_id=r}else{d.upload_id=r.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,na)[na].callMethod(v.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:a,file_template_id:s,as_file:o?"Y":"N",...d}).catch((e=>{n.Logger.error("commitFile error",e)}))}sendSeparateMessagesWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea](s,a);babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta](s,true);babelHelpers.classPrivateFieldLooseBase(this,_a)[_a](s)}destroy(){babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].destroy()}}function Ga(e){const{dialogId:s,autoUpload:a}=e;const t=b.Utils.text.getUuidV4();return this.checkDiskFolderId(s).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].createUploader({diskFolderId:e,uploaderId:t,autoUpload:a});return t}))}function Xa(e){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:p.Core.getUserId(),name:e.file.name,type:b.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:v.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Ra)[Ra]().name})}function qa(){babelHelpers.classPrivateFieldLooseBase(this,pa)[pa]=new ia;babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ya)[ya](s)}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileAdd,(e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia](s);babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka](a,s.getId());babelHelpers.classPrivateFieldLooseBase(this,_a)[_a](a)}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma](s)}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](s.getId(),s.getProgress(),v.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileUploadComplete,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](s.getId(),s.getProgress(),v.FileStatus.wait);babelHelpers.classPrivateFieldLooseBase(this,Ha)[Ha](s).then((()=>{var e;this.commitFile({realFileId:s.getServerFileId(),temporaryFileId:s.getId(),chatId:s.getCustomData("chatId"),tempMessageId:s.getCustomData("tempMessageId"),messageText:(e=s.getCustomData("messageText"))!=null?e:"",sendAsFile:s.getCustomData("sendAsFile"),fromDisk:false})})).catch((e=>{n.Logger.warn("UploadingService: upload preview error",e)}))}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileUploadError,(e=>{const{file:s,error:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](s.getId(),0,v.FileStatus.error);babelHelpers.classPrivateFieldLooseBase(this,Na)[Na](a);n.Logger.error("UploadingService: upload error",a)}));babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].subscribe(ia.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ma)[ma](s,a)}))}function Wa(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,Da)[Da](e);babelHelpers.classPrivateFieldLooseBase(this,na)[na].callMethod(v.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]=false;babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].commit("dialogues/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]=false;a(e)}))}))}function za(e){if(babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e.getBinary())===v.FileType.file||e.getExtension()==="gif"){return Promise.resolve()}const s=e.getServerFileId().toString().slice(1);const a=e.getClientPreview();if(!a){e.setCustomData("sendAsFile",true);return Promise.resolve()}const t=new FormData;t.append("id",s);t.append("previewFile",a,`preview_${e.getName()}.jpg`);return o.runAction(v.RestMethod.imDiskFilePreviewUpload,{data:t}).catch((e=>{n.Logger.error("imDiskFilePreviewUpload request error",e)}))}function Qa(e,s,a,t){const r=b.Utils.text.getUuidV4();const i=b.Utils.text.getUuidV4();const l=babelHelpers.classPrivateFieldLooseBase(this,Da)[Da](s);return{tempMessageId:r,tempFileId:i,file:e,dialogId:s,chatId:l,uploaderId:a,sendAsFile:t&&babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e)!==v.FileType.file}}function Ya(e,s,a){babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function $a(e,s){babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("messages/delete",{id:e});babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/delete",{id:s})}function Ja(e){const s=e.getId();const a=e.getBinary();const t=babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca](e);babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:p.Core.getUserId(),name:a.name,type:babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](a),extension:babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua](a),status:e.isFailed()?v.FileStatus.error:v.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Ra)[Ra]().name,...t})}function Za(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca](e);babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/update",{id:e.getId(),fields:{...s}})}function et(e){babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function st(e){if(e.getCustomData("sendAsFile")){return{}}const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}if(e.getClientPreview()){a.urlShow=URL.createObjectURL(e.getBinary())}return a}function at(e){return babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa](e).diskFolderId}function tt(e){let s=v.FileType.file;if(e.type.startsWith("image")){s=v.FileType.image}else if(e.type.startsWith("video")){s=v.FileType.video}return s}function rt(e){return e.name.split(".").splice(-1)[0]}function it(e){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].getters["dialogues/get"](e)}function lt(){const e=p.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].getters["users/get"](e)}function ot(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa](e))==null?void 0:s.chatId}function dt(e,s,a,t){if(!babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e]){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e]={filesPreviewStatus:{},dialogId:a,text:"",autoUpload:t}}s.forEach((s=>{const a=s.getId();if(!babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].filesPreviewStatus){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].filesPreviewStatus={}}babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].filesPreviewStatus[a]=false}))}function ct(e,s){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].filesPreviewStatus[s]=true}function nt(e,s){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].text=s}function bt(e,s){babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].autoUpload=s}function ht(e){const s=[];const a=this.getFiles(e);const t=babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].text;const r=babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].dialogId;const i=t.length>0;if(a.length>1&&i){s.push({dialogId:r,text:t})}a.forEach((e=>{var l;if(e.getError()){return}const o=b.Utils.text.getUuidV4();e.setCustomData("messageId",o);if(a.length===1&&i){e.setCustomData("messageText",t)}s.push({fileId:e.getId(),tempMessageId:e.getCustomData("tempMessageId"),dialogId:r,text:(l=e.getCustomData("messageText"))!=null?l:""})}));return s}function pt(e){if(!babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e]||!babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].autoUpload||babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].wasSent){return false}const{filesPreviewStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e];return Object.values(s).every((e=>e===true))}function vt(e){if(!babelHelpers.classPrivateFieldLooseBase(this,xa)[xa](e)){return}babelHelpers.classPrivateFieldLooseBase(this,ua)[ua][e].wasSent=true;const s=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa](e);s.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,va)[va].sendMessage(e)}));this.start(e)}function ut(e,s){const a=b.Utils.text.getUuidV4();const t=e.id.slice(1);const r=`${a}|${t}`;return{tempMessageId:a,tempFileId:r,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa](s).chatId}}function gt(e){if(e.getCode()==="MAX_FILE_SIZE_EXCEEDED"){BX.UI.Notification.Center.notify({content:`${e.getMessage()}<br>${e.getDescription()}`})}}Va.instance=null;class Pt{changeSetting(e,s){n.Logger.warn("SettingsService: changeSetting",e,s);p.Core.getStore().dispatch("application/settings/set",{[e]:s});let a=s;if(c.Type.isBoolean(a)){a=a===true?"Y":"N"}return o.runAction(v.RestMethod.imV2SettingsGeneralUpdate,{data:{userId:p.Core.getUserId(),name:e,value:a}}).catch((e=>{console.error("SettingsService: changeSetting error",e)}))}}class Ft{getDialogIdByUserCode(e){return p.Core.getRestClient().callMethod(v.RestMethod.linesDialogGet,{USER_CODE:e}).then((e=>{const{dialog_id:s}=e.data();return s})).catch((e=>{console.error("LinesService: error getting dialog id",e)}))}}const Lt=new Intl.Collator(undefined,{sensitivity:"base"});var Ht=babelHelpers.classPrivateFieldLooseKey("store");var ft=babelHelpers.classPrivateFieldLooseKey("getItemsFromRecentListByQuery");var Bt=babelHelpers.classPrivateFieldLooseKey("getFromStore");var mt=babelHelpers.classPrivateFieldLooseKey("getRecentListItems");var yt=babelHelpers.classPrivateFieldLooseKey("getSearchSessionListItems");var It=babelHelpers.classPrivateFieldLooseKey("prepareRecentItem");var Mt=babelHelpers.classPrivateFieldLooseKey("searchByQueryWords");var Ct=babelHelpers.classPrivateFieldLooseKey("searchByDialogFields");var St=babelHelpers.classPrivateFieldLooseKey("searchByUserFields");var wt=babelHelpers.classPrivateFieldLooseKey("doesItemMatchQuery");var Ut=babelHelpers.classPrivateFieldLooseKey("getDialogIds");var Ot=babelHelpers.classPrivateFieldLooseKey("getAllRecentItems");class Rt{constructor(){Object.defineProperty(this,Ot,{value:Vt});Object.defineProperty(this,Ut,{value:Nt});Object.defineProperty(this,wt,{value:kt});Object.defineProperty(this,St,{value:_t});Object.defineProperty(this,Ct,{value:xt});Object.defineProperty(this,Mt,{value:At});Object.defineProperty(this,It,{value:Tt});Object.defineProperty(this,yt,{value:Et});Object.defineProperty(this,mt,{value:Kt});Object.defineProperty(this,Bt,{value:jt});Object.defineProperty(this,ft,{value:Dt});Object.defineProperty(this,Ht,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht]=p.Core.getStore()}search(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ft)[ft](e);return babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut](s)}}function Dt(e){const s=b.Utils.text.getWordsFromString(e);return babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](s)}function jt(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot]();const a=new Map;s.forEach((s=>{if(babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt](s,e)){a.set(s.dialogId,s)}}));return a}function Kt(){return babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].getters["recent/getRecentCollection"].map((e=>babelHelpers.classPrivateFieldLooseBase(this,It)[It](e)))}function Et(){return babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].getters["recent/search/getCollection"].map((e=>babelHelpers.classPrivateFieldLooseBase(this,It)[It](e)))}function Tt(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].getters["dialogues/get"](e.dialogId,true);const a=s.type===v.DialogType.user;const t={dialogId:e.dialogId,dialog:s,dateUpdate:e.dateUpdate};if(a){t.user=babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].getters["users/get"](e.dialogId,true)}return t}function At(e,s){if(e.user){return babelHelpers.classPrivateFieldLooseBase(this,St)[St](e,s)}return babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct](e,s)}function xt(e,s){const a=[];if(e.dialog.name){const s=b.Utils.text.getWordsFromString(e.dialog.name.toLowerCase());a.push(...s)}return babelHelpers.classPrivateFieldLooseBase(this,wt)[wt](a,s)}function _t(e,s){const a=[];if(e.user.name){const s=b.Utils.text.getWordsFromString(e.user.name.toLowerCase());a.push(...s)}if(e.user.workPosition){const s=b.Utils.text.getWordsFromString(e.user.workPosition.toLowerCase());a.push(...s)}return babelHelpers.classPrivateFieldLooseBase(this,wt)[wt](a,s)}function kt(e,s){let a=0;s.forEach((s=>{let t=0;e.forEach((e=>{const a=e.slice(0,s.length);if(Lt.compare(s,a)===0){t++}}));if(t>0){a++}}));return a>=s.length}function Nt(e){return[...e.values()].map((e=>e.dialogId))}function Vt(){const e=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]();const s=babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]();const a=new Map;const t=[...e,...s];for(const e of t){if(!a.has(e.dialogId)){a.set(e.dialogId,e)}}return[...a.values()]}var Gt=babelHelpers.classPrivateFieldLooseKey("itemOptions");class Xt{constructor(e){Object.defineProperty(this,Gt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt]=e}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].id}getEntityId(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].entityId}getEntityType(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].entityType}getTitle(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].title}getAvatar(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].avatar}isUser(){return this.getEntityType()===v.SearchEntityIdTypes.imUser}isChat(){return this.getEntityType()===v.SearchEntityIdTypes.chat}getCustomData(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].customData}getDateUpdate(){return babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt].customData.dateUpdate}}const qt="im-recent-v2";const Wt="IM_CHAT_SEARCH";const zt="search-experimental";const Qt=()=>({dialog:{entities:[{id:qt,dynamicLoad:true,dynamicSearch:true}],preselectedItems:[],clearUnavailableItems:false,context:Wt,id:zt}});var Yt=babelHelpers.classPrivateFieldLooseKey("store");var $t=babelHelpers.classPrivateFieldLooseKey("userManager");var Jt=babelHelpers.classPrivateFieldLooseKey("setRecentItems");var Zt=babelHelpers.classPrivateFieldLooseKey("setRecentSearchItems");var er=babelHelpers.classPrivateFieldLooseKey("setDialoguesToModel");var sr=babelHelpers.classPrivateFieldLooseKey("prepareDataForModels");class ar{constructor(){Object.defineProperty(this,sr,{value:lr});Object.defineProperty(this,er,{value:ir});Object.defineProperty(this,Zt,{value:rr});Object.defineProperty(this,Jt,{value:tr});Object.defineProperty(this,Yt,{writable:true,value:void 0});Object.defineProperty(this,$t,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,$t)[$t]=new u.UserManager}update(e){const{users:s,dialogues:a,recentItems:t}=babelHelpers.classPrivateFieldLooseBase(this,sr)[sr](e);return Promise.all([babelHelpers.classPrivateFieldLooseBase(this,$t)[$t].setUsersToModel(s),babelHelpers.classPrivateFieldLooseBase(this,er)[er](a),babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt](t)])}updateSearchSession(e){const{recentItems:s}=babelHelpers.classPrivateFieldLooseBase(this,sr)[sr](e);return babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](s)}clearSessionSearch(){return babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt].dispatch("recent/search/clear")}}function tr(e){return babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt].dispatch("recent/store",e)}function rr(e){return babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt].dispatch("recent/search/set",e)}function ir(e){return babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt].dispatch("dialogues/set",e)}function lr(e){const s={users:[],dialogues:[],recentItems:[]};[...e.values()].forEach((e=>{const a=e.getCustomData();s.recentItems.push({dialogId:e.getDialogId(),date_update:e.getDateUpdate()});if(e.isUser()){s.users.push(a)}if(e.isChat()){s.dialogues.push({...a,dialogId:e.getDialogId()})}}));return s}const or="ui.entityselector.doSearch";const dr="ui.entityselector.load";const cr="ui.entityselector.saveRecentItems";var nr=babelHelpers.classPrivateFieldLooseKey("storeUpdater");var br=babelHelpers.classPrivateFieldLooseKey("processLatestSearchResponse");var hr=babelHelpers.classPrivateFieldLooseKey("processSearchResponse");var pr=babelHelpers.classPrivateFieldLooseKey("getDialogIds");var vr=babelHelpers.classPrivateFieldLooseKey("getItemsFromRecentItems");var ur=babelHelpers.classPrivateFieldLooseKey("createItemMap");class gr{constructor(){Object.defineProperty(this,ur,{value:fr});Object.defineProperty(this,vr,{value:Hr});Object.defineProperty(this,pr,{value:Lr});Object.defineProperty(this,hr,{value:Fr});Object.defineProperty(this,br,{value:Pr});Object.defineProperty(this,nr,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,nr)[nr]=new ar}search(e){return this.searchRequest(e).then((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,ur)[ur](e);return babelHelpers.classPrivateFieldLooseBase(this,hr)[hr](s)})).then((e=>babelHelpers.classPrivateFieldLooseBase(this,pr)[pr](e)))}searchRequest(e){const s={json:Qt()};s.json.searchQuery={queryWords:b.Utils.text.getWordsFromString(e),query:e};return new Promise(((e,a)=>{c.ajax.runAction(or,s).then((s=>{n.Logger.warn("Im.SearchLight: Search request result",s);e(s.data.dialog.items)})).catch((e=>a(e)))}))}loadLatestResults(){return this.loadLatestResultsRequest().then((e=>{const{items:s,recentItems:a}=e;if(s.length===0||a.length===0){return new Map}const t=babelHelpers.classPrivateFieldLooseBase(this,ur)[ur](s);const r=babelHelpers.classPrivateFieldLooseBase(this,vr)[vr](a,t);return babelHelpers.classPrivateFieldLooseBase(this,br)[br](r)})).then((e=>babelHelpers.classPrivateFieldLooseBase(this,pr)[pr](e)))}loadLatestResultsRequest(){const e={json:Qt()};return new Promise(((s,a)=>{c.ajax.runAction(dr,e).then((e=>{n.Logger.warn("Im.SearchLight: Recent search request result",e);s(e.data.dialog)})).catch((e=>a(e)))}))}addItemsToRecentSearchResults(e){const s=[{id:e,entityId:qt}];const a={json:{...Qt(),recentItems:s}};return new Promise(((e,s)=>{c.ajax.runAction(cr,a).then((()=>{e()})).catch((e=>s(e)))}))}clearSessionSearch(){void babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].clearSessionSearch()}}function Pr(e){return babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].update(e).then((()=>e))}function Fr(e){return babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].update(e).then((()=>babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].updateSearchSession(e))).then((()=>e))}function Lr(e){return[...e.values()].map((e=>e.getDialogId()))}function Hr(e,s){const a=new Map;e.forEach((e=>{const[,t]=e;const r=s.get(t.toString());if(r){a.set(r.getDialogId(),r)}}));return a}function fr(e){const s=new Map;e.forEach((e=>{const a=new Xt(e);s.set(a.getDialogId(),a)}));return s}var Br=babelHelpers.classPrivateFieldLooseKey("restClient");var mr=babelHelpers.classPrivateFieldLooseKey("userManager");class yr{constructor(){Object.defineProperty(this,Br,{writable:true,value:void 0});Object.defineProperty(this,mr,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Br)[Br]=p.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,mr)[mr]=new u.UserManager}load(e){return babelHelpers.classPrivateFieldLooseBase(this,Br)[Br].callMethod(v.RestMethod.imDialogUsersList,{DIALOG_ID:e}).then((e=>{const s=e.data();babelHelpers.classPrivateFieldLooseBase(this,mr)[mr].setUsersToModel(s);return s.map((e=>e.id.toString()))})).catch((e=>{console.error("MentionService: error",e)}))}}var Ir=babelHelpers.classPrivateFieldLooseKey("store");var Mr=babelHelpers.classPrivateFieldLooseKey("recentStateSearch");var Cr=babelHelpers.classPrivateFieldLooseKey("baseServerSearch");var Sr=babelHelpers.classPrivateFieldLooseKey("chatParticipants");var wr=babelHelpers.classPrivateFieldLooseKey("isExtranet");var Ur=babelHelpers.classPrivateFieldLooseKey("isSelfDialogId");class Or{constructor(){Object.defineProperty(this,Ur,{value:Dr});Object.defineProperty(this,wr,{value:Rr});Object.defineProperty(this,Ir,{writable:true,value:void 0});Object.defineProperty(this,Mr,{writable:true,value:void 0});Object.defineProperty(this,Cr,{writable:true,value:void 0});Object.defineProperty(this,Sr,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr]=new Rt;babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr]=new gr;babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]=new yr;babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]=p.Core.getStore()}loadLatestResults(){return babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr].loadLatestResults()}loadChatParticipants(e){return babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr].load(e).then((s=>{if(babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur](e)){return s}return s.filter((e=>!babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur](e)))}))}searchLocal(e){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr].search(e))}searchOnServer(e){return babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr].search(e)}addItemToRecent(e){return babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr].addItemsToRecentSearchResults(e)}clearSessionResult(){babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr].clearSessionSearch()}sortByDate(e){e.sort(((e,s)=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir].getters["recent/get"](e).dateUpdate;const t=babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir].getters["recent/get"](s).dateUpdate;if(!a||!t){if(!a&&!t){if(babelHelpers.classPrivateFieldLooseBase(this,wr)[wr](e)){return 1}if(babelHelpers.classPrivateFieldLooseBase(this,wr)[wr](s)){return-1}return 0}return a?-1:1}return t-a}));return e}}function Rr(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir].getters["dialogues/get"](e);if(!s){return false}if(s.type===v.DialogType.user){const s=babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir].getters["users/get"](e);return s&&s.extranet}return s.extranet}function Dr(e){return e===p.Core.getUserId().toString()}e.RecentService=g;e.ChatService=Oe;e.MessageService=Ss;e.SendingService=_s;e.NotificationService=Ys;e.DiskService=Js;e.UnreadRecentService=Zs;e.UploadingService=Va;e.SettingsService=Pt;e.LinesService=Ft;e.SearchService=Or})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Event,BX.UI.Uploader,BX.Messenger.v2.Lib,BX.Vue3.Vuex,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js