this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,t,s,r){"use strict";class a{static getInstance(e){if(!this.instance){this.instance=new this(e)}return this.instance}constructor(e){this.store=null;this.restClient=null;this.dataIsPreloaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null;this.controller=e.Data.get("controller");this.store=e.Data.get("controller").store;this.restClient=e.RestClient.get();this.onUpdateStateHandler=this.onUpdateState.bind(this);this.onUserRequestHandler=this.onUserRequest.bind(this);t.EventEmitter.subscribe(s.EventType.recent.updateState,this.onUpdateStateHandler);t.EventEmitter.subscribe(s.EventType.recent.requestUser,this.onUserRequestHandler)}loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){r.Logger.warn(`Im.RecentList: first page was preloaded`);return Promise.resolve()}this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){r.Logger.warn(`Im.RecentList: setting preloaded data`,e);const{items:t,hasMore:s}=e;this.lastMessageDate=this.getLastMessageDate(t);if(!s){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}requestItems({firstPage:e=false}={}){const t={SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y"};return this.restClient.callMethod(s.RestMethod.imRecentList,t).then((e=>{this.pagesLoaded++;r.Logger.warn(`Im.RecentList: ${this.pagesLoaded} page request result`,e.data());const{items:t,hasMore:s}=e.data();this.lastMessageDate=this.getLastMessageDate(t);if(!s){this.hasMoreItemsToLoad=false}return this.updateModels(e.data()).then((()=>{this.isLoading=false}))})).catch((e=>{console.error("Im.RecentList: page request error",e)}))}updateModels(e){const{users:t,dialogues:s,recent:r}=this.prepareDataForModels(e);const a=this.store.dispatch("users/set",t);if(e.botList){this.store.dispatch("users/setBotList",e.botList)}const i=this.store.dispatch("dialogues/set",s);const o=this.store.dispatch("recent/set",r);return Promise.all([a,i,o])}onUpdateState({data:e}){r.Logger.warn(`Im.RecentList: setting UpdateState data`,e);this.updateModels(e)}onUserRequest({data:{userId:e}}){this.restClient.callMethod(s.RestMethod.imUserGet,{id:e}).then((e=>{r.Logger.warn(`Im.RecentList: addition user request result`,e.data());this.store.dispatch("users/set",e.data())})).catch((e=>{console.error("Im.RecentList: user request error",e)}))}prepareDataForModels({items:e,birthdayList:t=[]}){const s={users:[],dialogues:[],recent:[]};e.forEach((e=>{if(e.user&&e.user.id&&!this.isAddedAlready(s,"users",e.user.id)){s.users.push(e.user)}if(e.chat){s.dialogues.push(this.prepareGroupChat(e));if(e.user.id&&!this.isAddedAlready(s,"dialogues",e.user.id)){s.dialogues.push(this.prepareChatForAdditionalUser(e.user))}}else if(e.user.id){const t=this.store.getters["recent/get"](e.user.id);if(!t||!e.options.default_user_record){s.dialogues.push(this.prepareChatForUser(e))}}s.recent.push({...e})}));t.forEach((e=>{if(!this.isAddedAlready(s,"users",e.id)){s.users.push(e);s.dialogues.push(this.prepareChatForAdditionalUser(e))}if(!this.isAddedAlready(s,"recent",e.id)){s.recent.push(this.getBirthdayPlaceholder(e))}}));r.Logger.warn(`Im.RecentList: prepared data for models`,s);return s}isAddedAlready(e,t,s){if(t==="users"){return e.users.some((e=>e.id===s))}else if(t==="dialogues"){return e.dialogues.some((e=>e.dialogId===s))}else if(t==="recent"){return e.recent.some((e=>e.id===s))}return false}prepareGroupChat(e){return{...e.chat,counter:e.counter,dialogId:e.id}}prepareChatForUser(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:s.ChatTypes.user,counter:e.counter}}prepareChatForAdditionalUser(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:s.ChatTypes.user}}getBirthdayPlaceholder(e){return{id:e.id,options:{birthdayPlaceholder:true}}}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}}a.instance=null;e.RecentService=a})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Event,BX.Messenger.v2.Const,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js