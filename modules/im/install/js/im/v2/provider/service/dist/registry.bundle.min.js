this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,i,r,l,o,d,c,n,h,b,p,v,g){"use strict";class u{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.store=null;this.restClient=null;this.dataIsPreloaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null;this.store=b.Core.getStore();this.restClient=b.Core.getRestClient();this.onUpdateStateHandler=this.onUpdateState.bind(this);c.EventEmitter.subscribe(v.EventType.recent.updateState,this.onUpdateStateHandler)}getCollection(){return this.store.getters["recent/getRecentCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){p.Logger.warn(`Im.RecentList: first page was preloaded`);return Promise.resolve()}this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){p.Logger.warn(`Im.RecentList: setting preloaded data`,e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){p.Logger.warn(`Im.RecentList: hide chat`,e);const s=this.store.getters["recent/get"](e);if(!s){return false}this.store.dispatch("recent/delete",{id:e});const t=this.store.getters["application/isChatOpen"](e);if(t){a.Messenger.openChat()}this.restClient.callMethod(v.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);return this.restClient.callMethod(this.getQueryMethod(),s).then((s=>{this.pagesLoaded++;p.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,s.data());const{items:a,hasMore:t}=s.data();this.lastMessageDate=this.getLastMessageDate(a);if(!t){this.hasMoreItemsToLoad=false}return this.updateModels(s.data()).then((()=>{this.isLoading=false}))})).catch((e=>{console.error("Im.RecentList: page request error",e)}))}getQueryMethod(){return v.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y"}}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const i=this.store.dispatch("users/set",s);if(e.botList){this.store.dispatch("users/setBotList",e.botList)}const r=this.store.dispatch("dialogues/set",a);const l=this.store.dispatch("recent/setRecent",t);return Promise.all([i,r,l])}onUpdateState({data:e}){p.Logger.warn(`Im.RecentList: setting UpdateState data`,e);this.updateModels(e)}prepareDataForModels({items:e,birthdayList:s=[]}){const a={users:[],dialogues:[],recent:[]};e.forEach((e=>{if(e.user&&e.user.id&&!this.isAddedAlready(a,"users",e.user.id)){a.users.push(e.user)}if(e.chat){a.dialogues.push(this.prepareGroupChat(e));if(e.user.id&&!this.isAddedAlready(a,"dialogues",e.user.id)){a.dialogues.push(this.prepareChatForAdditionalUser(e.user))}}else if(e.user.id){const s=this.store.getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){a.dialogues.push(this.prepareChatForUser(e))}}a.recent.push({...e})}));s.forEach((e=>{if(!this.isAddedAlready(a,"users",e.id)){a.users.push(e);a.dialogues.push(this.prepareChatForAdditionalUser(e))}if(!this.isAddedAlready(a,"recent",e.id)){a.recent.push(this.getBirthdayPlaceholder(e))}}));p.Logger.warn(`Im.RecentList: prepared data for models`,a);return a}isAddedAlready(e,s,a){if(s==="users"){return e.users.some((e=>e.id===a))}else if(s==="dialogues"){return e.dialogues.some((e=>e.dialogId===a))}else if(s==="recent"){return e.recent.some((e=>e.id===a))}return false}prepareGroupChat(e){return{...e.chat,counter:e.counter,dialogId:e.id}}prepareChatForUser(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:v.DialogType.user,counter:e.counter}}prepareChatForAdditionalUser(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:v.DialogType.user}}getBirthdayPlaceholder(e){return{id:e.id,options:{birthdayPlaceholder:true}}}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}}u.instance=null;class P{constructor(e){this.response={};this.chatId=0;this.dialogId="";this.rawUsers=[];this.users={};this.dialogues={};this.files={};this.messages={};this.reactions=[];this.additionalUsers=[];this.messagesToStore={};this.pinnedMessageIds=[];this.response=e}extractData(){this.extractChatResult();this.extractUserResult();this.extractMessageListResult();this.extractContextResult();this.extractPinnedMessagesResult();this.fillChatsForUsers()}isOpenlinesChat(){const e=this.dialogues[this.dialogId];if(!e){return false}return e.type===v.DialogType.lines}getChatId(){return this.chatId}getUsers(){return this.rawUsers}getDialogues(){return Object.values(this.dialogues)}getMessages(){return Object.values(this.messages)}getMessagesToStore(){return Object.values(this.messagesToStore)}getFiles(){return Object.values(this.files)}getPinnedMessages(){return this.pinnedMessageIds}getReactions(){return this.reactions}getAdditionalUsers(){return this.additionalUsers}extractChatResult(){const e=this.response[v.RestMethod.imChatGet];this.chatId=e.id;this.dialogId=e.dialog_id;if(!this.dialogues[e.dialog_id]){this.dialogues[e.dialog_id]=e}}extractUserResult(){const e=this.response[v.RestMethod.imUserGet];if(e){this.rawUsers=[e];return}const s=this.response[v.RestMethod.imUserListGet];if(s){this.rawUsers=Object.values(s)}}extractMessageListResult(){const e=this.response[v.RestMethod.imV2ChatMessageList];if(!e){return}this.extractPaginationFlags(e);this.extractMessages(e);this.extractReactions(e);this.extractAdditionalUsers(e)}extractPaginationFlags(e){const{hasPrevPage:s,hasNextPage:a}=e;this.dialogues[this.dialogId]={...this.dialogues[this.dialogId],hasPrevPage:s,hasNextPage:a}}extractContextResult(){const e=this.response[v.RestMethod.imV2ChatMessageGetContext];if(!e){return}this.extractPaginationFlags(e);this.extractMessages(e);this.extractReactions(e);this.extractAdditionalUsers(e)}extractReactions(e){const{reactions:s}=e;this.reactions=s}extractAdditionalUsers(e){const{usersShort:s}=e;this.additionalUsers=s}extractPinnedMessagesResult(){const e=this.response[v.RestMethod.imV2ChatPinTail];if(!e){return}const{list:s=[],users:a=[],files:t=[]}=e;this.rawUsers=[...this.rawUsers,...a];t.forEach((e=>{this.files[e.id]=e}));s.forEach((e=>{this.pinnedMessageIds.push(e.messageId);this.messagesToStore[e.message.id]=e.message}))}extractMessages(e){const{messages:s,users:a,files:t}=e;t.forEach((e=>{this.files[e.id]=e}));s.forEach((e=>{this.messages[e.id]=e}));this.rawUsers=[...this.rawUsers,...a]}fillChatsForUsers(){this.rawUsers.forEach((e=>{if(!this.dialogues[e.id]){this.dialogues[e.id]=g.UserManager.getDialogForUser(e)}else{this.dialogues[e.id]={...this.dialogues[e.id],...g.UserManager.getDialogForUser(e)}}}))}}var L=babelHelpers.classPrivateFieldLooseKey("store");var F=babelHelpers.classPrivateFieldLooseKey("loadChatRequest");var H=babelHelpers.classPrivateFieldLooseKey("updateModels");var f=babelHelpers.classPrivateFieldLooseKey("prepareLoadChatQuery");var B=babelHelpers.classPrivateFieldLooseKey("prepareLoadChatWithMessagesQuery");var m=babelHelpers.classPrivateFieldLooseKey("prepareLoadChatWithContextQuery");class M{constructor(){Object.defineProperty(this,m,{value:w});Object.defineProperty(this,B,{value:S});Object.defineProperty(this,f,{value:C});Object.defineProperty(this,H,{value:I});Object.defineProperty(this,F,{value:y});Object.defineProperty(this,L,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,L)[L]=b.Core.getStore()}loadChat(e){if(!h.Type.isStringFilled(e)){return Promise.reject(new Error("ChatService: loadChat: dialogId is not provided"))}const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);return babelHelpers.classPrivateFieldLooseBase(this,F)[F](e,s)}loadChatWithMessages(e){if(!h.Type.isStringFilled(e)){return Promise.reject(new Error("ChatService: loadChatWithMessages: dialogId is not provided"))}const s=babelHelpers.classPrivateFieldLooseBase(this,B)[B](e);return babelHelpers.classPrivateFieldLooseBase(this,F)[F](e,s)}loadChatWithContext(e,s){if(!h.Type.isStringFilled(e)){return Promise.reject(new Error("ChatService: loadChatWithContext: dialogId is not provided"))}if(!s||!h.Type.isNumber(s)){return Promise.reject(new Error("ChatService: loadChatWithContext: messageId is not provided"))}const a=babelHelpers.classPrivateFieldLooseBase(this,m)[m](e,s);return babelHelpers.classPrivateFieldLooseBase(this,F)[F](e,a)}}function y(e,s){babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{loading:true}});return l.callBatch(s).then((e=>babelHelpers.classPrivateFieldLooseBase(this,H)[H](e))).then((()=>babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/update",{dialogId:e,fields:{inited:true,loading:false}})))}function I(e){const s=new P(e);s.extractData();if(s.isOpenlinesChat()){return Promise.reject("OL chats are not supported")}const a=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("dialogues/set",s.getDialogues());const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/set",s.getFiles());const i=new g.UserManager;const r=[babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("users/set",s.getUsers()),i.addUsersToModel(s.getAdditionalUsers())];const l=[babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessages()}),babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/reactions/set",s.getReactions())];return Promise.all([a,t,Promise.all(r),Promise.all(l)])}function C(e){const s={[v.RestMethod.imChatGet]:{dialog_id:e}};const a=e.toString().startsWith("chat");if(a){s[v.RestMethod.imUserGet]={}}else{s[v.RestMethod.imUserListGet]={id:[b.Core.getUserId(),e]}}return s}function S(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);s[v.RestMethod.imV2ChatMessageList]={dialogId:e,limit:o.MessageService.getMessageRequestLimit()};s[v.RestMethod.imV2ChatPinTail]={chatId:`$result[${v.RestMethod.imChatGet}][id]`};return s}function w(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);a[v.RestMethod.imV2ChatMessageGetContext]={id:s,range:o.MessageService.getMessageRequestLimit()};a[v.RestMethod.imV2ChatMessageRead]={dialogId:e,ids:[s]};return a}const R="CHAT";const U="OPEN";var O=babelHelpers.classPrivateFieldLooseKey("restClient");var T=babelHelpers.classPrivateFieldLooseKey("store");var j=babelHelpers.classPrivateFieldLooseKey("addChatToModel");class E{constructor(){Object.defineProperty(this,j,{value:K});Object.defineProperty(this,O,{writable:true,value:void 0});Object.defineProperty(this,T,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,O)[O]=b.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,T)[T]=b.Core.getStore()}createChat(e){p.Logger.warn("ChatService: createChat",e);return babelHelpers.classPrivateFieldLooseBase(this,O)[O].callMethod(v.RestMethod.imV2ChatAdd,{fields:{title:e.title,description:e.description,users:e.members,ownerId:e.ownerId,searchable:e.isAvailableInSearch?"Y":"N"}}).then((s=>{const{chatId:a}=s.data();p.Logger.warn("ChatService: createChat result",a);const t=`chat${a}`;babelHelpers.classPrivateFieldLooseBase(this,j)[j](t,e);return t})).catch((e=>{console.error("ChatService: createChat error:",e);throw new Error(e)}))}}function K(e,s){const a=s.isAvailableInSearch?U:R;babelHelpers.classPrivateFieldLooseBase(this,T)[T].dispatch("dialogues/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.members.length})}var D=babelHelpers.classPrivateFieldLooseKey("store");var x=babelHelpers.classPrivateFieldLooseKey("restClient");var k=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class A{constructor(){Object.defineProperty(this,k,{value:_});Object.defineProperty(this,D,{writable:true,value:void 0});Object.defineProperty(this,x,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,D)[D]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,x)[x]=b.Core.getRestClient()}renameChat(e,s){p.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,D)[D].getters["dialogues/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,k)[k](e,s);return babelHelpers.classPrivateFieldLooseBase(this,x)[x].callMethod(v.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).then((e=>{p.Logger.warn("ChatService: renameChat result",e.data());return Promise.resolve()})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,k)[k](e,t);throw new Error("Chat rename error")}))}}function _(e,s){babelHelpers.classPrivateFieldLooseBase(this,D)[D].dispatch("dialogues/update",{dialogId:e,fields:{name:s}})}var N=babelHelpers.classPrivateFieldLooseKey("store");var V=babelHelpers.classPrivateFieldLooseKey("restClient");var G=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var X=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class W{constructor(){Object.defineProperty(this,X,{value:q});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,V,{writable:true,value:void 0});Object.defineProperty(this,G,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,N)[N]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,V)[V]=b.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,G)[G]=h.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,X)[X],ye.DEBOUNCE_TIME)}muteChat(e){p.Logger.warn("ChatService: muteChat",e);babelHelpers.classPrivateFieldLooseBase(this,N)[N].dispatch("dialogues/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,G)[G](s)}unmuteChat(e){p.Logger.warn("ChatService: unmuteChat",e);babelHelpers.classPrivateFieldLooseBase(this,N)[N].dispatch("dialogues/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,G)[G](s)}}function q(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,V)[V].callMethod(v.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e);const i=a==="Y"?"dialogues/unmute":"dialogues/mute";babelHelpers.classPrivateFieldLooseBase(this,N)[N].dispatch(i,{dialogId:s})}))}var $=babelHelpers.classPrivateFieldLooseKey("store");var Q=babelHelpers.classPrivateFieldLooseKey("restClient");class Y{constructor(){Object.defineProperty(this,$,{writable:true,value:void 0});Object.defineProperty(this,Q,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$)[$]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]=b.Core.getRestClient()}pinChat(e){p.Logger.warn("PinService: pinChat",e);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/pin",{id:e,action:true});const s={DIALOG_ID:e,ACTION:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].callMethod(v.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error pinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){p.Logger.warn("PinService: unpinChat",e);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/pin",{id:e,action:false});const s={DIALOG_ID:e,ACTION:"N"};babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].callMethod(v.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error unpinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("recent/pin",{id:e,action:true})}))}}const z=300;var J=babelHelpers.classPrivateFieldLooseKey("store");var Z=babelHelpers.classPrivateFieldLooseKey("restClient");var ee=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var se=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var ae=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var te=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var ie=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var re=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var le=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class oe{constructor(){Object.defineProperty(this,le,{value:pe});Object.defineProperty(this,re,{value:be});Object.defineProperty(this,ie,{value:he});Object.defineProperty(this,te,{value:ne});Object.defineProperty(this,ae,{value:ce});Object.defineProperty(this,se,{value:de});Object.defineProperty(this,J,{writable:true,value:void 0});Object.defineProperty(this,Z,{writable:true,value:void 0});Object.defineProperty(this,ee,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,J)[J]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=b.Core.getRestClient()}readAll(){p.Logger.warn("ReadService: readAll");babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/clearCounters");babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].callMethod(v.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e)}))}readDialog(e){p.Logger.warn("ReadService: readDialog",e);babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].callMethod(v.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e)}))}unreadDialog(e){p.Logger.warn("ReadService: unreadDialog",e);babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("recent/unread",{id:e,action:true});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].callMethod(v.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s);babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,ee)[ee][e]){babelHelpers.classPrivateFieldLooseBase(this,ee)[ee][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,ee)[ee][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]).forEach((([e,s])=>{e=+e;p.Logger.warn("ReadService: readMessages",s);if(s.size===0){return}const a=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,ee)[ee][e];babelHelpers.classPrivateFieldLooseBase(this,se)[se](e,a).then((s=>{p.Logger.warn("ReadService: readMessage, need to reduce counter by",s);return babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](e,s)})).then((()=>babelHelpers.classPrivateFieldLooseBase(this,te)[te](e,a))).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e)})).catch((e=>{console.error("ReadService: error reading message",e)}))}))}),z)}clearDialogMark(e){p.Logger.warn("ReadService: clear dialog mark",e);babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].callMethod(v.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:true}).catch((e=>{console.error("ReadService: error clearing dialog mark",e)}))}}function de(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,le)[le](e);if(a>t.lastReadId){babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,re)[re](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function ce(e,s){return babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/decreaseCounter",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,re)[re](e),count:s})}function ne(e,a){p.Logger.warn("ReadService: readMessages on server",a);return l.runAction(v.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:a,actionUuid:s.UuidManager.getInstance().getActionUuid()}})}function he(e){const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,le)[le](s);if(t.counter>a){p.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);babelHelpers.classPrivateFieldLooseBase(this,J)[J].dispatch("dialogues/update",{dialogId:t.dialogId,fields:{counter:a}})}}function be(e){const s=babelHelpers.classPrivateFieldLooseBase(this,J)[J].getters["dialogues/getByChatId"](e);if(!s){return 0}return s.dialogId}function pe(e){return babelHelpers.classPrivateFieldLooseBase(this,J)[J].getters["dialogues/getByChatId"](e)}var ve=babelHelpers.classPrivateFieldLooseKey("store");var ge=babelHelpers.classPrivateFieldLooseKey("restClient");class ue{constructor(){Object.defineProperty(this,ve,{writable:true,value:void 0});Object.defineProperty(this,ge,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ge)[ge]=b.Core.getRestClient()}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].callMethod(v.RestMethod.imChatUserAdd,s)}kickUserFromChat(e,s){p.Logger.warn(`UserService: kick user ${s} from chat ${e}`);const a=e.slice(4);const t={user_id:s,chat_id:a};babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].callMethod(v.RestMethod.imChatUserDelete,t).catch((e=>{console.error("Im.Lib.Menu: error kicking user from chat",e)}))}leaveChat(e){this.kickUserFromChat(e,b.Core.getUserId());babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].getters["application/isChatOpen"](e);if(s){a.Messenger.openChat()}}}var Pe=babelHelpers.classPrivateFieldLooseKey("loadService");var Le=babelHelpers.classPrivateFieldLooseKey("createService");var Fe=babelHelpers.classPrivateFieldLooseKey("renameService");var He=babelHelpers.classPrivateFieldLooseKey("muteService");var fe=babelHelpers.classPrivateFieldLooseKey("pinService");var Be=babelHelpers.classPrivateFieldLooseKey("readService");var me=babelHelpers.classPrivateFieldLooseKey("userService");var Me=babelHelpers.classPrivateFieldLooseKey("initServices");class ye{constructor(){Object.defineProperty(this,Me,{value:Ie});Object.defineProperty(this,Pe,{writable:true,value:void 0});Object.defineProperty(this,Le,{writable:true,value:void 0});Object.defineProperty(this,Fe,{writable:true,value:void 0});Object.defineProperty(this,He,{writable:true,value:void 0});Object.defineProperty(this,fe,{writable:true,value:void 0});Object.defineProperty(this,Be,{writable:true,value:void 0});Object.defineProperty(this,me,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].loadChat(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].loadChatWithContext(e,s)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].createChat(e)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,He)[He].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,He)[He].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].unpinChat(e)}readAll(){return babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].readMessage(e,s)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,me)[me].leaveChat(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,me)[me].kickUserFromChat(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,me)[me].addToChat(e)}}function Ie(){babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]=new M;babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]=new E;babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]=new A;babelHelpers.classPrivateFieldLooseBase(this,He)[He]=new W;babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=new Y;babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]=new oe;babelHelpers.classPrivateFieldLooseBase(this,me)[me]=new ue}ye.DEBOUNCE_TIME=500;var Ce=babelHelpers.classPrivateFieldLooseKey("store");var Se=babelHelpers.classPrivateFieldLooseKey("restClient");var we=babelHelpers.classPrivateFieldLooseKey("chatId");var Re=babelHelpers.classPrivateFieldLooseKey("userManager");var Ue=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var Oe=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var Te=babelHelpers.classPrivateFieldLooseKey("isLoading");var je=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var Ee=babelHelpers.classPrivateFieldLooseKey("updateModels");var Ke=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var De=babelHelpers.classPrivateFieldLooseKey("getDialog");class xe{constructor(e){Object.defineProperty(this,De,{value:Ne});Object.defineProperty(this,Ke,{value:_e});Object.defineProperty(this,Ee,{value:Ae});Object.defineProperty(this,je,{value:ke});Object.defineProperty(this,Ce,{writable:true,value:void 0});Object.defineProperty(this,Se,{writable:true,value:void 0});Object.defineProperty(this,we,{writable:true,value:void 0});Object.defineProperty(this,Re,{writable:true,value:void 0});Object.defineProperty(this,Ue,{writable:true,value:[]});Object.defineProperty(this,Oe,{writable:true,value:[]});Object.defineProperty(this,Te,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]=b.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=new g.UserManager;babelHelpers.classPrivateFieldLooseBase(this,we)[we]=e}loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]||!babelHelpers.classPrivateFieldLooseBase(this,De)[De]().hasNextPage){return Promise.resolve(false)}p.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,we)[we]);if(!e){p.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,we)[we],filter:{lastId:e},order:{id:"ASC"}};return l.runAction(v.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{p.Logger.warn("MessageService: loadUnread result",e);babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=e.messages;return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false;return true})).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false}))}loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]||!babelHelpers.classPrivateFieldLooseBase(this,De)[De]().hasPrevPage){return Promise.resolve(false)}p.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,we)[we]);if(!e){p.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,we)[we],filter:{lastId:e},order:{id:"DESC"}};return l.runAction(v.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{p.Logger.warn("MessageService: loadHistory result",e);babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=e.messages;const s=e.hasNextPage;const a={...e,hasPrevPage:s,hasNextPage:null};return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](a)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false;return true})).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false}))}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=[];return true}))}loadContext(e){const s={[v.RestMethod.imV2ChatMessageGetContext]:{id:e,range:xe.MESSAGE_REQUEST_LIMIT},[v.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,we)[we],ids:[e]}};p.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=true;return l.callBatch(s).then((e=>{p.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,je)[je](e[v.RestMethod.imV2ChatMessageGetContext])})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false}))}reloadMessageList(){p.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,we)[we]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,De)[De]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,De)[De]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,De)[De]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,De)[De]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,De)[De]().inited;babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke](false);if(e){return this.loadContext(e).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke](true,s)}))}return this.loadInitialMessages().then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke](true,s)}))}loadInitialMessages(){p.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,we)[we]);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=true;return babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].callMethod(v.RestMethod.imV2ChatMessageList,{chatId:babelHelpers.classPrivateFieldLooseBase(this,we)[we],limit:xe.MESSAGE_REQUEST_LIMIT}).then((e=>{p.Logger.warn("MessageService: loadInitialMessages result",e.data());return babelHelpers.classPrivateFieldLooseBase(this,je)[je](e.data())})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false;return true})).catch((e=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=false}))}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]}}function ke(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e);return Promise.all([a,t])}function Ae(e){const{files:s,users:a,usersShort:t,reactions:i,hasPrevPage:r,hasNextPage:l}=e;const o=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,De)[De]().dialogId,fields:{hasPrevPage:r,hasNextPage:l}});const d=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].addUsersToModel(t)]);const c=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("files/set",s);const n=babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("messages/reactions/set",i);return Promise.all([o,c,d,n])}function _e(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("dialogues/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,De)[De]().dialogId,fields:a})}function Ne(){return babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,we)[we])}xe.MESSAGE_REQUEST_LIMIT=25;var Ve=babelHelpers.classPrivateFieldLooseKey("store");var Ge=babelHelpers.classPrivateFieldLooseKey("restClient");class Xe{constructor(){Object.defineProperty(this,Ve,{writable:true,value:void 0});Object.defineProperty(this,Ge,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]=b.Core.getRestClient()}pinMessage(e,s){p.Logger.warn(`Dialog: PinManager: pin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].dispatch("messages/pin/add",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].callMethod(v.RestMethod.imV2ChatMessagePin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error pinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].dispatch("messages/pin/delete",{chatId:e,messageId:s})}))}unpinMessage(e,s){p.Logger.warn(`Dialog: PinManager: unpin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].dispatch("messages/pin/delete",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].callMethod(v.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error unpinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].dispatch("messages/pin/add",{chatId:e,messageId:s})}))}}var We=babelHelpers.classPrivateFieldLooseKey("store");var qe=babelHelpers.classPrivateFieldLooseKey("restClient");var $e=babelHelpers.classPrivateFieldLooseKey("chatId");class Qe{constructor(e){Object.defineProperty(this,We,{writable:true,value:void 0});Object.defineProperty(this,qe,{writable:true,value:void 0});Object.defineProperty(this,$e,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]=e;babelHelpers.classPrivateFieldLooseBase(this,We)[We]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]=b.Core.getRestClient()}editMessageText(e,s){p.Logger.warn("MessageService: editMessageText",e,s);babelHelpers.classPrivateFieldLooseBase(this,We)[We].dispatch("messages/update",{id:e,fields:{text:s,isEdited:true}});const a=babelHelpers.classPrivateFieldLooseBase(this,We)[We].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]);if(e===a.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,We)[We].dispatch("recent/update",{id:a.dialogId,fields:{message:{text:s}}})}babelHelpers.classPrivateFieldLooseBase(this,qe)[qe].callMethod(v.RestMethod.imMessageUpdate,{ID:e,MESSAGE:s}).catch((e=>{console.error("MessageService: editMessageText error:",e)}))}}var Ye=babelHelpers.classPrivateFieldLooseKey("store");var ze=babelHelpers.classPrivateFieldLooseKey("restClient");var Je=babelHelpers.classPrivateFieldLooseKey("chatId");class Ze{constructor(e){Object.defineProperty(this,Ye,{writable:true,value:void 0});Object.defineProperty(this,ze,{writable:true,value:void 0});Object.defineProperty(this,Je,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]=e;babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]=b.Core.getRestClient()}deleteMessage(e){p.Logger.warn("MessageService: deleteMessage",e);babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].dispatch("messages/update",{id:e,fields:{text:"",params:{IS_DELETED:"Y",FILE_ID:[]}}});const s=babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]);if(e===s.lastMessageId){babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].dispatch("recent/update",{id:s.dialogId,fields:{message:{text:""}}})}babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].callMethod(v.RestMethod.imMessageDelete,{ID:e}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}}var es=babelHelpers.classPrivateFieldLooseKey("chatId");var ss=babelHelpers.classPrivateFieldLooseKey("store");var as=babelHelpers.classPrivateFieldLooseKey("restClient");class ts{constructor(e){Object.defineProperty(this,es,{writable:true,value:void 0});Object.defineProperty(this,ss,{writable:true,value:void 0});Object.defineProperty(this,as,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,es)[es]=e;babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,as)[as]=b.Core.getRestClient()}markMessage(e){p.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].getters["dialogues/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,es)[es]);babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("recent/unread",{id:s,action:true});babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("dialogues/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,as)[as].callMethod(v.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e)}))}}var is=babelHelpers.classPrivateFieldLooseKey("chatId");var rs=babelHelpers.classPrivateFieldLooseKey("store");var ls=babelHelpers.classPrivateFieldLooseKey("restClient");class os{constructor(e){Object.defineProperty(this,is,{writable:true,value:void 0});Object.defineProperty(this,rs,{writable:true,value:void 0});Object.defineProperty(this,ls,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,is)[is]=e;babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]=b.Core.getRestClient()}addMessageToFavorite(e){p.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].callMethod(v.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e)}));BX.UI.Notification.Center.notify({content:h.Loc.getMessage("IM_MESSAGE_SERVICE_SAVE_MESSAGE_SUCCESS")})}removeMessageFromFavorite(e){p.Logger.warn("MessageService: removeMessageFromFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,is)[is],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].callMethod(v.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e)}))}}var ds=babelHelpers.classPrivateFieldLooseKey("loadService");var cs=babelHelpers.classPrivateFieldLooseKey("pinService");var ns=babelHelpers.classPrivateFieldLooseKey("editService");var hs=babelHelpers.classPrivateFieldLooseKey("deleteService");var bs=babelHelpers.classPrivateFieldLooseKey("markService");var ps=babelHelpers.classPrivateFieldLooseKey("favoriteService");var vs=babelHelpers.classPrivateFieldLooseKey("initServices");class gs{static getMessageRequestLimit(){return xe.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,vs,{value:us});Object.defineProperty(this,ds,{writable:true,value:void 0});Object.defineProperty(this,cs,{writable:true,value:void 0});Object.defineProperty(this,ns,{writable:true,value:void 0});Object.defineProperty(this,hs,{writable:true,value:void 0});Object.defineProperty(this,bs,{writable:true,value:void 0});Object.defineProperty(this,ps,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,vs)[vs](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].loadContext(e)}reloadMessageList(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,cs)[cs].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,cs)[cs].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,bs)[bs].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].editMessageText(e,s)}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].deleteMessage(e)}}function us(e){babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]=new xe(e);babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]=new Qe(e);babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]=new Ze(e);babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]=new Xe;babelHelpers.classPrivateFieldLooseBase(this,bs)[bs]=new ts(e);babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=new os(e)}var Ps=babelHelpers.classPrivateFieldLooseKey("uploader");var Ls=babelHelpers.classPrivateFieldLooseKey("store");var Fs=babelHelpers.classPrivateFieldLooseKey("restClient");var Hs=babelHelpers.classPrivateFieldLooseKey("getFilePreview");var fs=babelHelpers.classPrivateFieldLooseKey("onStartUpload");var Bs=babelHelpers.classPrivateFieldLooseKey("onProgress");var ms=babelHelpers.classPrivateFieldLooseKey("onComplete");var Ms=babelHelpers.classPrivateFieldLooseKey("onUploadError");var ys=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");class Is extends c.EventEmitter{constructor(){super();Object.defineProperty(this,ys,{value:Os});Object.defineProperty(this,Ms,{value:Us});Object.defineProperty(this,ms,{value:Rs});Object.defineProperty(this,Bs,{value:ws});Object.defineProperty(this,fs,{value:Ss});Object.defineProperty(this,Hs,{value:Cs});Object.defineProperty(this,Ps,{writable:true,value:void 0});Object.defineProperty(this,Ls,{writable:true,value:void 0});Object.defineProperty(this,Fs,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs]=b.Core.getRestClient();this.setEventNamespace(Is.eventNamespace);this.onUploadCancelHandler=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].bind(this);c.EventEmitter.subscribe(v.EventType.uploader.cancel,this.onUploadCancelHandler);this.initUploader()}initUploader(){babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps]=new n.Uploader;babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.startUpload,babelHelpers.classPrivateFieldLooseBase(this,fs)[fs].bind(this));babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.progressUpdate,babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].bind(this));babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.complete,babelHelpers.classPrivateFieldLooseBase(this,ms)[ms].bind(this));babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.fileMaxSizeExceeded,babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].bind(this));babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.uploadFileError,babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].bind(this));babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].subscribe(n.Uploader.EVENTS.createFileError,babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].bind(this))}addUploadTask(e,s,a){return babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs](s).then((({preview:t})=>{const i=t?{previewBlob:t.blob}:{};babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].addTask({taskId:e,fileData:s,fileName:s.name,diskFolderId:a,generateUniqueName:true,...i});return{taskId:e,file:s,preview:t}}))}cancel(e){babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps].deleteTask(e)}destroy(){c.EventEmitter.unsubscribe(v.EventType.uploader.cancel,this.onUploadCancelHandler)}}function Cs(e){return n.PreviewManager.get(e).then((e=>({preview:e}))).catch((s=>{console.warn(`Couldn't get preview for file ${e.name}. Error: ${s}`);return{}}))}function Ss(e){this.emit(Is.events.onFileUploadProgress,e)}function ws(e){this.emit(Is.events.onFileUploadProgress,e)}function Rs(e){this.emit(Is.events.onFileUploadComplete,e)}function Us(e){this.emit(Is.events.onFileUploadError,e)}function Os(e){this.emit(Is.events.onFileUploadCancel,e)}Is.eventNamespace="BX.Messenger.v2.Textarea.UploadManager";Is.events={onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel"};var Ts=babelHelpers.classPrivateFieldLooseKey("store");var js=babelHelpers.classPrivateFieldLooseKey("restClient");var Es=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var Ks=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var Ds=babelHelpers.classPrivateFieldLooseKey("uploadManager");var xs=babelHelpers.classPrivateFieldLooseKey("uploadRegistry");var ks=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var As=babelHelpers.classPrivateFieldLooseKey("initUploadManager");var _s=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var Ns=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var Vs=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var Gs=babelHelpers.classPrivateFieldLooseKey("addFileToModel");var Xs=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var Ws=babelHelpers.classPrivateFieldLooseKey("getFileType");var qs=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var $s=babelHelpers.classPrivateFieldLooseKey("getDialog");var Qs=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var Ys=babelHelpers.classPrivateFieldLooseKey("addFileToUploadRegistry");var zs=babelHelpers.classPrivateFieldLooseKey("getChatId");class Js extends c.EventEmitter{constructor(){super();Object.defineProperty(this,zs,{value:ha});Object.defineProperty(this,Ys,{value:na});Object.defineProperty(this,Qs,{value:ca});Object.defineProperty(this,$s,{value:da});Object.defineProperty(this,qs,{value:oa});Object.defineProperty(this,Ws,{value:la});Object.defineProperty(this,Xs,{value:ra});Object.defineProperty(this,Gs,{value:ia});Object.defineProperty(this,Vs,{value:ta});Object.defineProperty(this,Ns,{value:aa});Object.defineProperty(this,_s,{value:sa});Object.defineProperty(this,As,{value:ea});Object.defineProperty(this,ks,{value:Zs});Object.defineProperty(this,Ts,{writable:true,value:void 0});Object.defineProperty(this,js,{writable:true,value:void 0});Object.defineProperty(this,Es,{writable:true,value:false});Object.defineProperty(this,Ks,{writable:true,value:{}});Object.defineProperty(this,Ds,{writable:true,value:void 0});Object.defineProperty(this,xs,{writable:true,value:{}});this.setEventNamespace(Js.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,js)[js]=b.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]=new Is;babelHelpers.classPrivateFieldLooseBase(this,As)[As]()}uploadFile(e){const{temporaryFileId:s,rawFile:a,diskFolderId:t}=e;babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys](s,e);return babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].addUploadTask(s,a,t).then((e=>babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs](e)))}uploadFileFromDisk(e){const{temporaryFileId:s,rawFile:a}=e;babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys](s,e);return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks](s,a)}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e))}if(babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]){return babelHelpers.classPrivateFieldLooseBase(this,Ks)[Ks][e]}babelHelpers.classPrivateFieldLooseBase(this,Ks)[Ks][e]=babelHelpers.classPrivateFieldLooseBase(this,_s)[_s](e);return babelHelpers.classPrivateFieldLooseBase(this,Ks)[Ks][e]}commitFile(e){const{temporaryFileId:s,realFileId:a,fromDisk:t}=e;const i=this.getMessageWithFile(s);const r={};if(t){r.disk_id=a}else{r.upload_id=a}babelHelpers.classPrivateFieldLooseBase(this,js)[js].callMethod(v.RestMethod.imDiskFileCommit,{chat_id:i.chatId,message:"",template_id:i.temporaryMessageId,file_template_id:s,...r}).catch((e=>{console.error("fileCommit error",e)}))}getMessageWithFile(e){return babelHelpers.classPrivateFieldLooseBase(this,xs)[xs][e]}destroy(){babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].destroy()}}function Zs(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("files/add",{id:e,chatId:this.getMessageWithFile(e).chatId,authorId:b.Core.getUserId(),name:s.name,type:d.Utils.file.getFileTypeByExtension(s.ext),extension:s.ext,size:s.sizeInt,status:v.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Qs)[Qs]().name})}function ea(){babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]=new Is;babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].subscribe(Is.events.onFileUploadProgress,(e=>{const{task:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](s.taskId,s.progress,v.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].subscribe(Is.events.onFileUploadComplete,(e=>{const{task:s,result:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](s.taskId,s.progress,v.FileStatus.wait);this.commitFile({temporaryFileId:s.taskId,realFileId:a.data.file.id,fromDisk:false})}));babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].subscribe(Is.events.onFileUploadError,(e=>{const{task:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](s.taskId,0,v.FileStatus.error)}));babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].subscribe(Is.events.onFileUploadCancel,(e=>{const{taskId:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](s)}))}function sa(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]=true;babelHelpers.classPrivateFieldLooseBase(this,js)[js].callMethod(v.RestMethod.imDiskFolderGet,{chat_id:babelHelpers.classPrivateFieldLooseBase(this,zs)[zs](e)}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]=false;babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].commit("dialogues/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]=false;a(e)}))}))}function aa(e,s,a){babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function ta(e){const s=this.getMessageWithFile(e).temporaryMessageId;babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/delete",{id:s});babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].cancel(e)}function ia(e){const{taskId:s,file:a,preview:t}=e;const i={};if(t.blob){i.image={width:t.width,height:t.height};i.urlPreview=URL.createObjectURL(t.blob)}return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("files/add",{id:s,chatId:this.getMessageWithFile(s).chatId,authorId:b.Core.getUserId(),name:a.name,type:babelHelpers.classPrivateFieldLooseBase(this,Ws)[Ws](a),extension:babelHelpers.classPrivateFieldLooseBase(this,qs)[qs](a),size:a.size,status:v.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Qs)[Qs]().name,...i})}function ra(e){return babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e).diskFolderId}function la(e){let s=v.FileType.file;if(e.type.startsWith("image")){s=v.FileType.image}else if(e.type.startsWith("video")){s=v.FileType.video}return s}function oa(e){return e.name.split(".").splice(-1)[0]}function da(e){return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["dialogues/get"](e)}function ca(){const e=b.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["users/get"](e)}function na(e,s){babelHelpers.classPrivateFieldLooseBase(this,xs)[xs][e]={chatId:babelHelpers.classPrivateFieldLooseBase(this,zs)[zs](s.dialogId),...s}}function ha(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e))==null?void 0:s.chatId}Js.eventNamespace="BX.Messenger.v2.Textarea.UploadingService";Js.events={sendMessageWithFile:"sendMessageWithFile"};var ba=babelHelpers.classPrivateFieldLooseKey("store");var pa=babelHelpers.classPrivateFieldLooseKey("fileService");var va=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var ga=babelHelpers.classPrivateFieldLooseKey("handlePagination");var ua=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var Pa=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var La=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var Fa=babelHelpers.classPrivateFieldLooseKey("updateMessageId");var Ha=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var fa=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var Ba=babelHelpers.classPrivateFieldLooseKey("getDialog");class ma{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Ba,{value:Oa});Object.defineProperty(this,fa,{value:Ua});Object.defineProperty(this,Ha,{value:Ra});Object.defineProperty(this,Fa,{value:wa});Object.defineProperty(this,La,{value:Sa});Object.defineProperty(this,Pa,{value:Ca});Object.defineProperty(this,ua,{value:Ia});Object.defineProperty(this,ga,{value:ya});Object.defineProperty(this,va,{value:Ma});Object.defineProperty(this,ba,{writable:true,value:void 0});Object.defineProperty(this,pa,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]=b.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,pa)[pa]=new Js}sendMessage(e){const{text:s="",fileId:a="",temporaryMessageId:t,dialogId:i}=e;if(!h.Type.isStringFilled(s)&&!h.Type.isStringFilled(a)){return}p.Logger.warn(`SendingService: sendMessage`,e);const r=babelHelpers.classPrivateFieldLooseBase(this,va)[va]({text:s,fileId:a,temporaryMessageId:t,dialogId:i});return babelHelpers.classPrivateFieldLooseBase(this,ga)[ga](i).then((()=>babelHelpers.classPrivateFieldLooseBase(this,ua)[ua](r))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,fa)[fa]({force:true,dialogId:i});babelHelpers.classPrivateFieldLooseBase(this,La)[La](r)}))}sendFilesFromInput(e,s){if(e.length===0){return}babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].checkDiskFolderId(s).then((a=>{e.forEach((e=>{const t=d.Utils.text.getUuidV4();const i=d.Utils.text.getUuidV4();const r={temporaryMessageId:t,temporaryFileId:i,rawFile:e,diskFolderId:a,dialogId:s};babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].uploadFile(r).then((()=>{this.sendMessage({temporaryMessageId:t,fileId:i,dialogId:s})}))}))}))}sendFilesFromDisk(e,s){Object.values(e).forEach((e=>{const a=d.Utils.text.getUuidV4();const t=e.id.slice(1);const i=`${a}|${t}`;babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].uploadFileFromDisk({temporaryMessageId:a,temporaryFileId:i,dialogId:s,rawFile:e}).then((()=>this.sendMessage({temporaryMessageId:a,fileId:i,dialogId:s}))).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].commitFile({temporaryFileId:i,realFileId:t,fromDisk:true})}))}))}destroy(){babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].destroy()}}function Ma(e){const{text:s,fileId:a,temporaryMessageId:t,dialogId:i}=e;const r={};if(a){r.FILE_ID=[a]}const l=t||d.Utils.text.getUuidV4();return{temporaryId:l,chatId:babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](i).chatId,dialogId:i,authorId:b.Core.getUserId(),text:s,params:r,withFile:!!a,unread:false,sending:true}}function ya(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e).hasNextPage){return Promise.resolve()}p.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new o.MessageService({chatId:babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e).chatId});return s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e).lastMessageId).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,fa)[fa]({dialogId:e})})).catch((e=>{console.error("SendingService: loadContext error",e)}))}function Ia(e){babelHelpers.classPrivateFieldLooseBase(this,Pa)[Pa](e);babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("dialogues/clearLastMessageViews",{dialogId:e.dialogId});return babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("messages/add",e)}function Ca(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].getters["recent/get"](e.dialogId);if(!s||e.text===""){return false}babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("recent/update",{id:e.dialogId,fields:{message:{id:e.temporaryId,text:e.text,authorId:e.authorId,status:v.MessageStatus.received,sending:true,params:{withFile:false,withAttach:false}}}})}function Sa(e){if(e.withFile){return}const s={[v.RestMethod.imMessageAdd]:{template_id:e.temporaryId,dialog_id:e.dialogId},[v.RestMethod.imV2ChatRead]:{dialogId:e.dialogId,onlyRecent:true}};if(e.text){s[v.RestMethod.imMessageAdd].message=e.text}l.callBatch(s).then((s=>{p.Logger.warn("SendingService: sendMessage result -",s[v.RestMethod.imMessageAdd]);babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]({oldId:e.temporaryId,newId:s[v.RestMethod.imMessageAdd],dialogId:e.dialogId})})).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,Ha)[Ha](e.temporaryId);console.error("SendingService: sendMessage error -",s)}))}function wa(e){const{oldId:s,newId:a,dialogId:t}=e;babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("messages/updateWithId",{id:s,fields:{id:a}});babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("dialogues/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}})}function Ra(e){babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].dispatch("messages/update",{id:e,fields:{error:true}})}function Ua(e={}){const{force:s=false,dialogId:a}=e;c.EventEmitter.emit(v.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](a).chatId,threshold:s?v.DialogScrollThreshold.none:v.DialogScrollThreshold.halfScreenUp})}function Oa(e){return babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].getters["dialogues/get"](e)}ma.instance=null;class Ta{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=b.Core.getStore();this.restClient=b.Core.getRestClient();this.deleteWithDebounce=h.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new g.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).then((e=>{p.Logger.warn(`NotificationService: sendConfirmAction: success`,e)})).catch((e=>{console.error(e)}))}sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=(()=>{}),callbackError:i=(()=>{})}=e;this.restClient.callMethod(v.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a}).then((e=>{t(e)})).catch((e=>{console.error(e);i()}))}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).then((s=>{p.Logger.warn(`NotificationService: deleteRequest: success for ids: ${e}`,s)})).catch((e=>{console.error(e)}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[v.RestMethodHandler.imNotifyGet]:[v.RestMethod.imNotifyGet,s]};if(!e){s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}else{a[v.RestMethodHandler.imNotifySchemaGet]=[v.RestMethod.imNotifySchemaGet,{}]}return new Promise((e=>{this.restClient.callBatch(a,(s=>{p.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[v.RestMethodHandler.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){p.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[v.RestMethodHandler.imNotifySchemaGet]){return e[v.RestMethodHandler.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===v.NotificationTypesCodes.confirm?v.NotificationTypesCodes.confirm:v.NotificationTypesCodes.simple}isLastPage(e){if(!h.Type.isArrayFilled(e)||e.length<this.limitPerPage){return true}return false}destroy(){p.Logger.warn("Notification service destroyed")}}class ja extends u{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return this.store.getters["recent/getUnreadCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){this.isLoading=true;return this.requestItems({firstPage:true})}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const i=this.store.dispatch("users/set",s);const r=this.store.dispatch("dialogues/set",a);const l=this.getFakeData(t);const o=this.store.dispatch("recent/setUnread",l);return Promise.all([i,r,o])}getFakeData(e){e=e.slice(-4);e.forEach((e=>{this.store.dispatch("dialogues/update",{dialogId:e.id,fields:{counter:7}})}));return e}onUpdateState({data:e}){}}ja.instance=null;e.RecentService=u;e.ChatService=ye;e.MessageService=gs;e.SendingService=ma;e.NotificationService=Ta;e.UnreadRecentService=ja})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX,BX.Vue3.Vuex,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js