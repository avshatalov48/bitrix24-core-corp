{"version":3,"file":"core.bundle.js","sources":["../src/core.js"],"sourcesContent":["import {Extension, Loc} from 'main.core';\nimport {BitrixVue} from 'ui.vue3';\nimport {Builder, Store} from 'ui.vue3.vuex';\n\nimport {PullClient, PULL as Pull} from 'pull.client';\nimport {RestClient, rest as Rest} from 'rest.client';\n\nimport 'im.v2.application.launch';\n\nimport {\n\tApplicationModel,\n\tMessagesModel,\n\tDialoguesModel,\n\tUsersModel,\n\tFilesModel,\n\tRecentModel,\n\tNotificationsModel,\n\tSidebarModel,\n\tMarketModel\n} from 'im.v2.model';\nimport {\n\tBasePullHandler,\n\tRecentPullHandler,\n\tNotificationPullHandler,\n\tNotifierPullHandler\n} from 'im.v2.provider.pull';\nimport {Logger} from 'im.v2.lib.logger';\n\nclass CoreApplication\n{\n\thost: string;\n\tuserId: number;\n\tsiteId: string;\n\tsiteDir: string;\n\tlanguageId: string;\n\tapplicationData: {[key]: any} = {};\n\n\t/* region 01. Initialize and store data */\n\tconstructor()\n\t{\n\t\tthis.inited = false;\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.initPromiseResolver = resolve;\n\t\t});\n\n\t\tthis.offline = false;\n\n\t\tthis.vuexAdditionalModel = [];\n\n\t\tthis.store = null;\n\t\tthis.storeBuilder = null;\n\n\t\tthis.prepareVariables();\n\n\t\tthis.initStorage()\n\t\t\t.then(() => this.initPullClient())\n\t\t\t.then(() => this.initComplete())\n\t\t\t.catch(error => {\n\t\t\t\tLogger.error('Error initializing core controller', error);\n\t\t\t})\n\t\t;\n\t}\n\n\tprepareVariables()\n\t{\n\t\tthis.localize = BX ? {...BX.message} : {};\n\n\t\tthis.host = location.origin;\n\t\tthis.userId = Number.parseInt(Loc.getMessage('USER_ID'), 10) ?? 0;\n\t\tthis.siteId = Loc.getMessage('SITE_ID') ?? 's1';\n\t\tthis.siteDir = Loc.getMessage('SITE_DIR') ?? 's1';\n\t\tthis.languageId = Loc.getMessage('LANGUAGE_ID') ?? 'en';\n\n\t\tthis.initPull();\n\t\tthis.initRest();\n\t}\n\n\tinitStorage()\n\t{\n\t\tconst builder = Builder.init()\n\t\t\t.addModel(ApplicationModel.create())\n\t\t\t.addModel(MessagesModel.create())\n\t\t\t.addModel(DialoguesModel.create())\n\t\t\t.addModel(FilesModel.create())\n\t\t\t.addModel(UsersModel.create())\n\t\t\t.addModel(RecentModel.create())\n\t\t\t.addModel(NotificationsModel.create())\n\t\t\t.addModel(SidebarModel.create())\n\t\t\t.addModel(MarketModel.create())\n\t\t;\n\n\t\treturn builder.build().then(result => {\n\t\t\tthis.store = result.store;\n\t\t\tthis.storeBuilder = result.builder;\n\n\t\t\treturn Promise.resolve();\n\t\t});\n\t}\n\n\tinitPullClient()\n\t{\n\t\tif (!this.pullClient)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.pullClient.subscribe(new BasePullHandler());\n\t\tthis.pullClient.subscribe(new RecentPullHandler());\n\t\tthis.pullClient.subscribe(new NotificationPullHandler());\n\t\tthis.pullClient.subscribe(new NotifierPullHandler());\n\n\t\tthis.pullClient.subscribe({\n\t\t\ttype: this.pullInstance.SubscriptionType.Status,\n\t\t\tcallback: this.onPullStatusChange.bind(this)\n\t\t});\n\n\t\tthis.pullClient.subscribe({\n\t\t\ttype: this.pullInstance.SubscriptionType.Online,\n\t\t\tcallback: this.onUsersOnlineChange.bind(this)\n\t\t});\n\n\t\treturn Promise.resolve();\n\t}\n\n\tinitComplete()\n\t{\n\t\tthis.inited = true;\n\t\tthis.initPromiseResolver(this);\n\t}\n\n\tinitRest()\n\t{\n\t\tthis.restInstance = RestClient;\n\t\tthis.restClient = Rest;\n\n\t\treturn Promise.resolve();\n\t}\n\n\tinitPull()\n\t{\n\t\tthis.pullInstance = PullClient;\n\t\tthis.pullClient = Pull;\n\t}\n\t/* endregion 01. Initialize and store data */\n\n\t/* region 02. Push & Pull */\n\tonPullStatusChange(data)\n\t{\n\t\tif (data.status === this.pullInstance.PullStatus.Online)\n\t\t{\n\t\t\tthis.offline = false;\n\t\t}\n\t\telse if (data.status === this.pullInstance.PullStatus.Offline)\n\t\t{\n\t\t\tthis.offline = true;\n\t\t}\n\t}\n\n\tonUsersOnlineChange(data)\n\t{\n\t\tif (!['list', 'userStatus'].includes(data.command))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tObject.values(data.params.users).forEach(userInfo => {\n\t\t\tthis.store.dispatch('users/update', {\n\t\t\t\tid: userInfo.id,\n\t\t\t\tfields: userInfo\n\t\t\t});\n\t\t});\n\t}\n\t/* endregion 02. Push & Pull */\n\n\t/* region 04. Template engine */\n\tcreateVue(application, config = {})\n\t{\n\t\tconst initConfig = {};\n\n\t\tif (config.el)\n\t\t{\n\t\t\tinitConfig.el = config.el;\n\t\t}\n\n\t\tif (config.template)\n\t\t{\n\t\t\tinitConfig.template = config.template;\n\t\t}\n\n\t\tif (config.name)\n\t\t{\n\t\t\tinitConfig.name = config.name;\n\t\t}\n\n\t\tif (config.components)\n\t\t{\n\t\t\tinitConfig.components = config.components;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tinitConfig.created = function() {\n\t\t\t\tresolve(this);\n\t\t\t};\n\t\t\tconst bitrixVue = BitrixVue.createApp(initConfig);\n\t\t\tbitrixVue.config.errorHandler = function (err, vm, info) {\n\t\t\t\tconsole.error(err, info);\n\t\t\t};\n\t\t\tbitrixVue.config.warnHandler = function (warn, vm, trace) {\n\t\t\t\tconsole.warn(warn, trace);\n\t\t\t};\n\t\t\tapplication.bitrixVue = bitrixVue;\n\t\t\tbitrixVue.use(this.store).mount(initConfig.el);\n\t\t});\n\t}\n\t/* endregion 04. Template engine */\n\n\t/* region 05. Core methods */\n\tgetHost(): string\n\t{\n\t\treturn this.host;\n\t}\n\n\tgetUserId(): number\n\t{\n\t\treturn this.userId;\n\t}\n\n\tgetSiteId(): string\n\t{\n\t\treturn this.siteId;\n\t}\n\n\tgetLanguageId(): string\n\t{\n\t\treturn this.languageId;\n\t}\n\n\tgetStore(): Store\n\t{\n\t\treturn this.store;\n\t}\n\n\tgetRestClient(): RestClient\n\t{\n\t\treturn this.restClient;\n\t}\n\n\tgetPullClient(): Pull\n\t{\n\t\treturn this.pullClient;\n\t}\n\n\tsetApplicationData(data: {string: any})\n\t{\n\t\tthis.applicationData = {...this.applicationData, ...data};\n\t}\n\n\tgetApplicationData(): {[key]: any}\n\t{\n\t\treturn this.applicationData;\n\t}\n\n\tisOnline()\n\t{\n\t\treturn !this.offline;\n\t}\n\n\tisCloud(): boolean\n\t{\n\t\tconst settings = Extension.getSettings('im.v2.application.core');\n\n\t\treturn settings.get('isCloud');\n\t}\n\n\tready()\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\treturn Promise.resolve(this);\n\t\t}\n\n\t\treturn this.initPromise;\n\t}\n\n\t/* endregion 05. Methods */\n}\n\nconst Core = new CoreApplication();\nexport {Core, CoreApplication};"],"names":["CoreApplication","constructor","applicationData","inited","initPromise","Promise","resolve","initPromiseResolver","offline","vuexAdditionalModel","store","storeBuilder","prepareVariables","initStorage","then","initPullClient","initComplete","catch","error","Logger","localize","BX","message","host","location","origin","userId","Number","parseInt","Loc","getMessage","siteId","siteDir","languageId","initPull","initRest","builder","Builder","init","addModel","ApplicationModel","create","MessagesModel","DialoguesModel","FilesModel","UsersModel","RecentModel","NotificationsModel","SidebarModel","MarketModel","build","result","pullClient","subscribe","BasePullHandler","RecentPullHandler","NotificationPullHandler","NotifierPullHandler","type","pullInstance","SubscriptionType","Status","callback","onPullStatusChange","bind","Online","onUsersOnlineChange","restInstance","RestClient","restClient","Rest","PullClient","Pull","data","status","PullStatus","Offline","includes","command","Object","values","params","users","forEach","userInfo","dispatch","id","fields","createVue","application","config","initConfig","el","template","name","components","created","bitrixVue","BitrixVue","createApp","errorHandler","err","vm","info","console","warnHandler","warn","trace","use","mount","getHost","getUserId","getSiteId","getLanguageId","getStore","getRestClient","getPullClient","setApplicationData","getApplicationData","isOnline","isCloud","settings","Extension","getSettings","get","ready","Core"],"mappings":"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"}