this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,i,s,l,r,n,a,o,d,u,c){"use strict";class h{constructor(e={}){this.inited=false;this.initPromise=new Promise((e=>{this.initPromiseResolver=e}));this.offline=false;this.vuexAdditionalModel=[];this.store=null;this.storeBuilder=null;this.pullHandlers=[];this.prepareParams(e);this.initStorage().then((()=>this.initPullClient())).then((()=>this.initComplete())).catch((e=>{u.Logger.error("Error initializing core controller",e)}))}prepareParams(e){var t;if(!l.Type.isUndefined(e.localize)){this.localize=e.localize}else{this.localize=BX?{...BX.message}:{}}this.host=(t=e.host)!=null?t:location.origin;this.userId=this.prepareUserId(e.userId);this.siteId=this.getLocalize("SITE_ID")||"s1";if(l.Type.isStringFilled(e.siteId)){this.siteId=e.siteId}this.siteDir=this.getLocalize("SITE_DIR")||"s1";if(l.Type.isStringFilled(e.siteDir)){this.siteDir=e.siteDir}this.languageId=this.getLocalize("LANGUAGE_ID")||"en";if(l.Type.isStringFilled(e.languageId)){this.languageId=e.languageId}this.initPull(e);this.initRest(e);this.initVuexBuilder(e)}initStorage(){const e={common:{host:this.getHost(),userId:this.getUserId(),siteId:this.getSiteId(),languageId:this.getLanguageId()},dialog:{messageLimit:50,enableReadMessages:true},device:{type:c.Utils.device.isMobile()?o.DeviceType.mobile:o.DeviceType.desktop,orientation:c.Utils.device.getOrientation()}};const t=n.Builder.init().addModel(a.ApplicationModel.create().useDatabase(false).setVariables(e)).addModel(a.MessagesModel.create().useDatabase(false)).addModel(a.DialoguesModel.create().useDatabase(false)).addModel(a.FilesModel.create().useDatabase(false)).addModel(a.UsersModel.create().useDatabase(false)).addModel(a.RecentModel.create().useDatabase(false));this.vuexAdditionalModel.forEach((e=>{t.addModel(e)}));t.setDatabaseConfig({name:this.vuexBuilder.databaseName,type:this.vuexBuilder.databaseType,siteId:this.getSiteId(),userId:this.getUserId()});return t.build().then((e=>{this.store=e.store;this.storeBuilder=e.builder;return Promise.resolve()}))}initPullClient(){if(!this.pullClient){return false}this.pullClient.subscribe(this.pullBaseHandler=new d.ImBasePullHandler({store:this.store,controller:this}));this.pullClient.subscribe({type:this.pullInstance.SubscriptionType.Status,callback:this.eventStatusInteraction.bind(this)});this.pullClient.subscribe({type:this.pullInstance.SubscriptionType.Online,callback:this.eventOnlineInteraction.bind(this)});return Promise.resolve()}initComplete(){this.inited=true;this.initPromiseResolver(this)}initRest(e){this.restInstance=s.RestClient;this.restClient=s.rest;if(!l.Type.isUndefined(e.rest)){if(!l.Type.isUndefined(e.rest.instance)){this.restInstance=e.rest.instance}if(!l.Type.isUndefined(e.rest.client)){this.restClient=e.rest.client}}return Promise.resolve()}initPull(e){this.pullInstance=i.PullClient;this.pullClient=i.PULL;if(e.pull){if(e.pull.instance){this.pullInstance=e.pull.instance}if(e.pull.client){this.pullClient=e.pull.client}}}initVuexBuilder(e){this.vuexBuilder={database:false,databaseName:"desktop/im",databaseType:n.BuilderDatabaseType.indexedDb};if(e.vuexBuilder){if(l.Type.isBoolean(e.vuexBuilder.database)){this.vuexBuilder.database=e.vuexBuilder.database}if(l.Type.isStringFilled(e.vuexBuilder.databaseName)){this.vuexBuilder.databaseName=e.vuexBuilder.databaseName}if(l.Type.isStringFilled(e.vuexBuilder.databaseType)){this.vuexBuilder.databaseType=e.vuexBuilder.databaseType}if(l.Type.isArray(e.vuexBuilder.models)){e.vuexBuilder.models.forEach((e=>{this.addVuexModel(e)}))}}}prepareUserId(e){let t=0;if(!l.Type.isUndefined(e)){const e=Number.parseInt(params.userId,10);if(e){t=e}}else if(this.getLocalize("USER_ID")){t=Number.parseInt(this.getLocalize("USER_ID"),10)}return t}eventStatusInteraction(e){if(e.status===this.pullInstance.PullStatus.Online){this.offline=false}else if(e.status===this.pullInstance.PullStatus.Offline){this.offline=true}}eventOnlineInteraction(e){if(!["list","userStatus"].includes(e.command)){return false}Object.values(e.params.users).forEach((e=>{this.store.dispatch("users/update",{id:e.id,fields:e})}))}createVue(e,t={}){let i=()=>{};if(t.beforeCreate){i=t.beforeCreate}let s=()=>{};if(t.unmounted){s=t.unmounted}let l=()=>{};if(t.created){l=t.created}const n=this;const a={beforeCreate(){this.$bitrix.Data.set("controller",n);this.$bitrix.Application.set(e);this.$bitrix.Loc.setMessage(n.localize);if(n.restClient){this.$bitrix.RestClient.set(n.restClient)}if(n.pullClient){this.$bitrix.PullClient.set(n.pullClient)}i.bind(this)()},created(){l.bind(this)()},unmounted(){s.bind(this)()}};if(t.el){a.el=t.el}if(t.template){a.template=t.template}if(t.computed){a.computed=t.computed}if(t.data){a.data=t.data}if(t.name){a.name=t.name}if(t.components){a.components=t.components}const o=a.created;return new Promise((t=>{a.created=function(){o.bind(this)();t(this)};const i=r.BitrixVue.createApp(a);i.config.errorHandler=function(e,t,i){console.error(e,i)};i.config.warnHandler=function(e,t,i){console.warn(e,i)};e.bitrixVue=i;i.use(this.store).mount(a.el)}))}getHost(){return this.host}getUserId(){return this.userId}getSiteId(){return this.siteId}getLanguageId(){return this.languageId}getStore(){return this.store}addVuexModel(e){this.vuexAdditionalModel.push(e)}isOnline(){return!this.offline}ready(){if(this.inited){return Promise.resolve(this)}return this.initPromise}setError(e="",t=""){u.Logger.error(`Messenger.Application.error: ${e} (${t})`);let i="";if(e.endsWith("LOCALIZED")){i=t}this.store.commit("application/set",{error:{active:true,code:e,description:i}})}clearError(){this.store.commit("application/set",{error:{active:false,code:"",description:""}})}addLocalize(e){if(!l.Type.isPlainObject(e)){return false}Object.entries(e).forEach((([e,t])=>{this.localize[e]=t}));return true}getLocalize(e){let t="";if(typeof e==="undefined"){return this.localize}else if(typeof this.localize[e.toString()]==="undefined"){u.Logger.warn(`Controller.Core.getLocalize: message with code '${e.toString()}' is undefined.`)}else{t=this.localize[e]}return t}}const p=new h;e.Core=p;e.CoreApplication=h})(this.BX.Messenger.v2.Application=this.BX.Messenger.v2.Application||{},BX.Messenger.v2.Application,BX,BX,BX,BX.Vue3,BX.Vue3.Vuex,BX.Messenger.v2.Model,BX.Messenger.v2.Const,BX.Messenger.v2.Provider.Pull,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=core.bundle.map.js