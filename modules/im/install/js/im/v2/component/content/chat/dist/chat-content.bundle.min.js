this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,i,a,n,s,r,o,d,l,h,c,g,b,u,v){"use strict";const p=5;const C={name:"EditableChatTitle",components:{ChatTitle:c.ChatTitle},props:{dialogId:{type:String,required:true}},emits:["newTitleSubmit"],data(){return{isEditing:false,inputWidth:0,showEditIcon:false,chatTitle:""}},computed:{dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},canBeRenamed(){if(this.dialog.extranet){return false}return this.$store.getters["dialogues/getChatOption"](this.dialog.type,g.ChatOption.rename)},inputStyle(){return{width:`calc(${this.inputWidth}ch + ${p}px)`}}},watch:{chatTitle(){this.inputWidth=this.chatTitle.length}},mounted(){this.chatTitle=this.dialog.name},methods:{onTitleClick(){if(!this.canBeRenamed){return}if(!this.chatTitle){this.chatTitle=this.dialog.name}this.isEditing=true;this.$nextTick().then((()=>{this.$refs["titleInput"].focus()}))},onNewTitleSubmit(){if(!this.isEditing){return}this.isEditing=false;const t=this.chatTitle===this.dialog.name;if(t||this.chatTitle===""){return}this.$emit("newTitleSubmit",this.chatTitle)},onEditCancel(){this.isEditing=false;this.chatTitle=this.dialog.name}},template:`\n\t\t<div\n\t\t\tv-if="!isEditing"\n\t\t\t@click="onTitleClick"\n\t\t\t@mouseover="showEditIcon = true"\n\t\t\t@mouseleave="showEditIcon = false"\n\t\t\tclass="bx-im-chat-header__title --chat"\n\t\t>\n\t\t\t<div class="bx-im-chat-header__title_container">\n\t\t\t\t<ChatTitle :dialogId="dialogId" :withMute="true" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header__edit-icon_container">\n\t\t\t\t<div v-if="showEditIcon && canBeRenamed" class="bx-im-chat-header__edit-icon"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div v-else class="bx-im-chat-header__title-input_container">\n\t\t\t<input\n\t\t\t\tv-model="chatTitle"\n\t\t\t\t:style="inputStyle"\n\t\t\t\t@focus="$event.target.select()"\n\t\t\t\t@blur="onNewTitleSubmit"\n\t\t\t\t@keyup.enter="onNewTitleSubmit"\n\t\t\t\t@keyup.esc="onEditCancel"\n\t\t\t\ttype="text"\n\t\t\t\tclass="bx-im-chat-header__title-input"\n\t\t\t\tref="titleInput"\n\t\t\t/>\n\t\t</div>\n\t`};const m={name:"ChatHeader",components:{Avatar:c.Avatar,ChatTitle:c.ChatTitle,EditableChatTitle:C,AddToChat:o.AddToChat},props:{dialogId:{type:String,default:""},sidebarOpened:{type:Boolean,required:true}},data(){return{showAddToChatPopup:false}},computed:{AvatarSize:()=>c.AvatarSize,user(){return this.$store.getters["users/get"](this.dialogId,true)},dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},isInited(){return this.dialog.inited},isUser(){return this.dialog.type===g.DialogType.user},isChat(){return!this.isUser},avatarStyle(){return{backgroundImage:`url('${this.dialog.avatar}')`}},chatId(){return this.dialog.chatId},dialogDescription(){if(this.isUser){return this.$store.getters["users/getPosition"](this.dialogId)}return u.Loc.getMessagePlural("IM_CONTENT_CHAT_HEADER_USER_COUNT",this.dialog.userCounter,{"#COUNT#":this.dialog.userCounter})},userLink(){return d.Utils.user.getProfileLink(this.dialogId)},userLastOnline(){return this.$store.getters["users/getLastOnline"](this.dialogId)},chatCanBeCalled(){return l.CallManager.getInstance().chatCanBeCalled(this.dialog.dialogId)}},methods:{toggleRightPanel(){this.$emit("toggleRightPanel")},onMembersClick(){if(this.isUser||!this.isInited){return}v.EventEmitter.emit(g.EventType.sidebar.open,{detailBlock:g.SidebarDetailBlock.main})},onNewTitleSubmit(t){this.getChatService().renameChat(this.dialogId,t).catch((()=>{BX.UI.Notification.Center.notify({content:this.loc("IM_CONTENT_CHAT_HEADER_RENAME_ERROR")})}))},getChatService(){if(!this.chatService){this.chatService=new r.ChatService}return this.chatService},openInvitePopup(){this.showAddToChatPopup=true},startVideoCall(){if(!this.chatCanBeCalled){return}h.Messenger.startVideoCall(this.dialog.dialogId)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="bx-im-chat-header__scope bx-im-chat-header__container">\n\t\t\t<div class="bx-im-chat-header__left">\n\t\t\t\t<div class="bx-im-chat-header__avatar">\n\t\t\t\t\t<Avatar v-if="isChat" :dialogId="dialogId" :size="AvatarSize.L" :withStatus="true" />\n\t\t\t\t\t<a v-else :href="userLink" target="_blank">\n\t\t\t\t\t\t<Avatar :dialogId="dialogId" :size="AvatarSize.L" :withStatus="true" />\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="isChat" class="bx-im-chat-header__info">\n\t\t\t\t\t<EditableChatTitle :dialogId="dialogId" @newTitleSubmit="onNewTitleSubmit" />\n\t\t\t\t\t<div :title="loc('IM_CONTENT_CHAT_HEADER_OPEN_MEMBERS')" @click="onMembersClick" class="bx-im-chat-header__subtitle --click" >\n\t\t\t\t\t\t{{ dialogDescription }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div v-else class="bx-im-chat-header__info">\n\t\t\t\t\t<div class="bx-im-chat-header__title --user">\n\t\t\t\t\t\t<a :href="userLink" target="_blank" class="bx-im-chat-header__title_container">\n\t\t\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<span class="bx-im-chat-header__user-status">{{ userLastOnline }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-chat-header__subtitle">{{ dialogDescription }}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header__right">\n\t\t\t\t<div class="bx-im-chat-header__button" :class="{'--disabled': !chatCanBeCalled}" @click="startVideoCall">\n\t\t\t\t\t{{ loc('IM_CONTENT_CHAT_HEADER_VIDEOCALL_HD') }}\n\t\t\t\t</div>\n\t\t\t\t<div \n\t\t\t\t\tclass="bx-im-chat-header__icon --add-people"\n\t\t\t\t\t:class="{'--active': showAddToChatPopup}"\n\t\t\t\t\t@click="openInvitePopup" \n\t\t\t\t\tref="add-members"\n\t\t\t\t></div>\n\t\t\t\t\x3c!--<div class="bx-im-chat-header__icon --search"></div>--\x3e\n\t\t\t\t<div @click="toggleRightPanel" class="bx-im-chat-header__icon --panel" :class="{'--active': sidebarOpened}"></div>\n\t\t\t</div>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['add-members'] || {}"\n\t\t\t\t:chatId="chatId"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: 15, offsetLeft: -300}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const _={name:"SidebarWrapper",components:{ChatSidebar:b.ChatSidebar},props:{dialogId:{type:String,required:true},sidebarDetailBlock:{type:String,default:null}},emits:["back"],methods:{onClickBack(){this.$emit("back")}},template:`\n\t\t<div class="bx-im-sidebar-wrapper__scope bx-im-sidebar-wrapper__container">\n\t\t\t<ChatSidebar\n\t\t\t\t:dialogId="dialogId" \n\t\t\t\t:key="dialogId" \n\t\t\t\t:sidebarDetailBlock="sidebarDetailBlock"\n\t\t\t\t@back="onClickBack"\n\t\t\t/>\n\t\t</div>\n\t`};const S="BX.Messenger.v2.Content.Chat.ResizeManager";var T=babelHelpers.classPrivateFieldLooseKey("observer");var I=babelHelpers.classPrivateFieldLooseKey("textareaHeight");var x=babelHelpers.classPrivateFieldLooseKey("initObserver");class y extends v.EventEmitter{constructor(){super();Object.defineProperty(this,x,{value:f});Object.defineProperty(this,T,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});this.setEventNamespace(S);babelHelpers.classPrivateFieldLooseBase(this,x)[x]()}observeTextarea(t){babelHelpers.classPrivateFieldLooseBase(this,T)[T].observe(t);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=t.clientHeight}unobserveTextarea(t){babelHelpers.classPrivateFieldLooseBase(this,T)[T].unobserve(t);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=0}}function f(){babelHelpers.classPrivateFieldLooseBase(this,T)[T]=new ResizeObserver((t=>{t.forEach((t=>{var e;const i=(e=t.borderBoxSize)==null?void 0:e[0].blockSize;if(u.Type.isNumber(i)&&i!==babelHelpers.classPrivateFieldLooseBase(this,I)[I]){this.emit(y.events.onHeightChange,{newHeight:i});babelHelpers.classPrivateFieldLooseBase(this,I)[I]=i}}))}))}y.events={onHeightChange:"onHeightChange"};const B=64;const E={name:"ChatContent",components:{ChatHeader:m,ChatDialog:e.ChatDialog,ChatTextarea:i.ChatTextarea,SidebarWrapper:_},directives:{"textarea-observer":{mounted(t,e){e.instance.textareaResizeManager.observeTextarea(t)},beforeUnmount(t,e){e.instance.textareaResizeManager.unobserveTextarea(t)}}},props:{entityId:{type:String,default:""},contextMessageId:{type:Number,default:0}},data(){return{needSidebarTransition:false,sidebarOpened:false,sidebarDetailBlock:null,textareaHeight:0}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["dialogues/get"](this.entityId,true)},sidebarTransitionName(){return this.needSidebarTransition?"sidebar-transition":""},backgroundStyle(){return s.ThemeManager.getCurrentBackgroundStyle()},dialogContainerStyle(){return{height:`calc(100% - ${B}px - ${this.textareaHeight}px)`}}},watch:{entityId(t,e){a.Logger.warn(`ChatContent: switching from ${e||"empty"} to ${t}`);if(t===""){this.sidebarOpened=false}this.onChatChange();this.resetSidebarDetailState()},sidebarOpened(t){this.saveSidebarOpenedState(t)}},created(){this.restoreSidebarOpenState();this.chatService=new r.ChatService;if(this.entityId){this.onChatChange()}this.initTextareaResizeManager()},mounted(){v.EventEmitter.subscribe(g.EventType.sidebar.open,this.onSidebarOpen);v.EventEmitter.subscribe(g.EventType.sidebar.close,this.onSidebarClose)},beforeUnmount(){v.EventEmitter.unsubscribe(g.EventType.sidebar.open,this.onSidebarOpen);v.EventEmitter.unsubscribe(g.EventType.sidebar.close,this.onSidebarClose)},methods:{onChatChange(){if(this.entityId===""){return true}if(this.dialog.inited){a.Logger.warn(`ChatContent: chat ${this.entityId} is already loaded`);return true}if(this.dialog.loading){a.Logger.warn(`ChatContent: chat ${this.entityId} is loading`);return true}if(this.layout.contextId){this.loadChatWithContext();return}this.loadChat().then((()=>{this.needSidebarTransition=true}))},loadChatWithContext(){a.Logger.warn(`ChatContent: loading chat ${this.entityId} with context - ${this.layout.contextId}`);this.chatService.loadChatWithContext(this.entityId,this.layout.contextId).then((()=>{a.Logger.warn(`ChatContent: chat ${this.entityId} is loaded with context of ${this.layout.contextId}`)})).catch((t=>{if(t.code==="ACCESS_ERROR"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR"))}console.error(t);h.Messenger.openChat()}))},loadChat(){a.Logger.warn(`ChatContent: loading chat ${this.entityId}`);return this.chatService.loadChatWithMessages(this.entityId).then((()=>{a.Logger.warn(`ChatContent: chat ${this.entityId} is loaded`)})).catch((t=>{console.error(t);h.Messenger.openChat()}))},toggleSidebar(){this.needSidebarTransition=true;this.sidebarOpened=!this.sidebarOpened;this.resetSidebarDetailState()},onClickBack(){this.resetSidebarDetailState()},onSidebarOpen({data:t}){this.sidebarOpened=true;if(t.detailBlock&&g.SidebarDetailBlock[t.detailBlock]){this.sidebarDetailBlock=t.detailBlock}},onSidebarClose(){this.sidebarOpened=false},resetSidebarDetailState(){this.sidebarDetailBlock=null},restoreSidebarOpenState(){const t=n.LocalStorageManager.getInstance().get(g.LocalStorageKey.sidebarOpened);this.sidebarOpened=Boolean(t)},saveSidebarOpenedState(t){const e=200;clearTimeout(this.saveSidebarStateTimeout);this.saveSidebarStateTimeout=setTimeout((()=>{n.LocalStorageManager.getInstance().set(g.LocalStorageKey.sidebarOpened,t)}),e)},initTextareaResizeManager(){this.textareaResizeManager=new y;this.textareaResizeManager.subscribe(y.events.onHeightChange,(t=>{const{newHeight:e}=t.getData();this.textareaHeight=e}))},showNotification(t){BX.UI.Notification.Center.notify({content:t})},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__scope bx-im-content-chat__container" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat__content">\n\t\t\t\t<template v-if="entityId">\n\t\t\t\t\t<ChatHeader \n\t\t\t\t\t\t:dialogId="entityId" \n\t\t\t\t\t\t:key="entityId" \n\t\t\t\t\t\t:sidebarOpened="sidebarOpened"\n\t\t\t\t\t\t@toggleRightPanel="toggleSidebar" \n\t\t\t\t\t/>\n\t\t\t\t\t<div :style="dialogContainerStyle" class="bx-im-content-chat__dialog_container">\n\t\t\t\t\t\t<div class="bx-im-content-chat__dialog_content">\n\t\t\t\t\t\t\t<ChatDialog :dialogId="entityId" :key="entityId" :textareaHeight="textareaHeight" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-textarea-observer class="bx-im-content-chat__textarea_container">\n\t\t\t\t\t\t<ChatTextarea :dialogId="entityId" :key="entityId" />\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<div v-else class="bx-im-content-chat__start_message">\n\t\t\t\t\t<div class="bx-im-content-chat__start_message_icon"></div>\n\t\t\t\t\t<div class="bx-im-content-chat__start_message_text">\n\t\t\t\t\t  {{ loc('IM_CONTENT_CHAT_START_MESSAGE') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<transition :name="sidebarTransitionName">\n\t\t\t\t<SidebarWrapper \n\t\t\t\t\tv-if="entityId && sidebarOpened"\n\t\t\t\t\t:dialogId="entityId" \n\t\t\t\t\t:sidebarDetailBlock="sidebarDetailBlock"\n\t\t\t\t\t@back="onClickBack"\n\t\t\t\t/>\n\t\t\t</transition>\n\t\t</div>\n\t`};t.ChatContent=E})(this.BX.Messenger.v2.Component.Content=this.BX.Messenger.v2.Component.Content||{},BX.Messenger.v2.Component.Dialog,BX.Messenger.v2.Component,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Const,BX.Messenger.v2.Component,BX,BX.Event);
//# sourceMappingURL=chat-content.bundle.map.js