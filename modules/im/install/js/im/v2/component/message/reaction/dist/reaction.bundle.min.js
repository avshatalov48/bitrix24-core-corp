this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,i,r,o,a,n,c,l){"use strict";var d=babelHelpers.classPrivateFieldLooseKey("store");var h=babelHelpers.classPrivateFieldLooseKey("restClient");class u{constructor(){Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,d)[d]=a.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,h)[h]=a.Core.getRestClient()}setReaction(e,t){l.Logger.warn("ReactionService: setReaction",e,t);babelHelpers.classPrivateFieldLooseBase(this,d)[d].dispatch("messages/reactions/setReaction",{messageId:e,reaction:t,userId:a.Core.getUserId()});babelHelpers.classPrivateFieldLooseBase(this,h)[h].callMethod(n.RestMethod.imV2ChatMessageReactionAdd,{messageId:e,reaction:t}).catch((e=>{console.error("ReactionService: error setting reaction",e)}))}removeReaction(e,t){l.Logger.warn("ReactionService: removeReaction",e,t);babelHelpers.classPrivateFieldLooseBase(this,d)[d].dispatch("messages/reactions/removeReaction",{messageId:e,reaction:t,userId:a.Core.getUserId()});babelHelpers.classPrivateFieldLooseBase(this,h)[h].callMethod(n.RestMethod.imV2ChatMessageReactionDelete,{messageId:e,reaction:t}).catch((e=>{console.error("ReactionService: error removing reaction",e)}))}}const m=500;const v=500;const p={props:{messageId:{type:Number,required:true}},data(){return{}},computed:{reactionsData(){return this.$store.getters["messages/reactions/getByMessageId"](this.messageId)},ownReactionSet(){var e,t;return((e=this.reactionsData)==null?void 0:(t=e.ownReactions)==null?void 0:t.size)>0}},methods:{startShowTimer(){this.showTimeout=setTimeout((()=>{this.showSelector()}),m)},clearShowTimer(){clearTimeout(this.showTimeout);this.setHideTimeout()},showSelector(){this.selector=new i.ReactionsSelect({name:"im-base-message-reaction-selector",position:this.$refs["container"]});this.subscribeToSelectorEvents();this.selector.show()},subscribeToSelectorEvents(){this.selector.subscribe("select",(e=>{var t;const{reaction:s}=e.getData();this.getReactionService().setReaction(this.messageId,s);(t=this.selector)==null?void 0:t.hide()}));this.selector.subscribe("mouseleave",this.setHideTimeout);this.selector.subscribe("mouseenter",(()=>{clearTimeout(this.hideTimeout)}));this.selector.subscribe("hide",(()=>{clearTimeout(this.hideTimeout);this.selector=null}))},setHideTimeout(){this.hideTimeout=setTimeout((()=>{var e;(e=this.selector)==null?void 0:e.hide()}),v)},onIconClick(){this.clearShowTimer();if(this.ownReactionSet){const[e]=[...this.reactionsData.ownReactions];this.getReactionService().removeReaction(this.messageId,e);return}this.getReactionService().setReaction(this.messageId,i.reactionType.like)},getReactionService(){if(!this.reactionService){this.reactionService=new u}return this.reactionService}},template:`\n\t\t<div\n\t\t\t@click="onIconClick"\n\t\t\t@mouseenter="startShowTimer"\n\t\t\t@mouseleave="clearShowTimer"\n\t\t\tclass="bx-im-reaction-selector__container"\n\t\t\tref="container"\n\t\t>\n\t\t\t<div  class="bx-im-reaction-selector__icon" :class="{'--active': ownReactionSet}"></div>\n\t\t</div>\n\t`};const g={components:{Avatar:o.Avatar},props:{userId:{type:Number,required:true}},data(){return{}},computed:{AvatarSize:()=>o.AvatarSize,user(){return this.$store.getters["users/get"](this.userId)},avatarStyle(){if(!this.user.avatar){return{}}return{backgroundImage:`url('${this.user.avatar}')`}}},template:`\n\t\t<div class="bx-im-reaction-list__user_avatar">\n\t\t\t<Avatar \n\t\t\t\t:dialogId="userId" \n\t\t\t\t:size="AvatarSize.XS" \n\t\t\t\t:withAvatarLetters="false" \n\t\t\t\t:withStatus="false" \n\t\t\t\t:withTooltip="false"\n\t\t\t/>\n\t\t</div>\n\t`};var b=babelHelpers.classPrivateFieldLooseKey("store");var w=babelHelpers.classPrivateFieldLooseKey("restClient");var R=babelHelpers.classPrivateFieldLooseKey("userManager");class S{constructor(){Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,w,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,b)[b]=a.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,w)[w]=a.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,R)[R]=new c.UserManager}loadReactionUsers(e,t){let s=[];l.Logger.warn("Reactions: UserService: loadReactionUsers",e,t);const i={messageId:e,filter:{reaction:t}};return babelHelpers.classPrivateFieldLooseBase(this,w)[w].callMethod(n.RestMethod.imV2ChatMessageReactionTail,i).then((e=>{s=e.data().users;return babelHelpers.classPrivateFieldLooseBase(this,R)[R].setUsersToModel(Object.values(s))})).then((()=>s.map((e=>e.id)))).catch((e=>{console.error("Reactions: UserService: loadReactionUsers error",e);throw new Error(e)}))}}const y={components:{UserListPopup:o.UserListPopup},props:{messageId:{type:Number,required:true},reaction:{type:String,required:true},show:{type:Boolean,required:true},bindElement:{type:Object,required:true}},emits:["close"],data(){return{showPopup:false,loadingAdditionalUsers:false,additionalUsers:[]}},watch:{show(e,t){if(!t&&e){this.showPopup=true;this.loadUsers()}}},methods:{loadUsers(){this.loadingAdditionalUsers=true;this.getUserService().loadReactionUsers(this.messageId,this.reaction).then((e=>{this.additionalUsers=e;this.loadingAdditionalUsers=false})).catch((()=>{this.loadingAdditionalUsers=false}))},onPopupClose(){this.showPopup=false;this.$emit("close")},prepareAdditionalUsers(e){const t=this.dialog.lastMessageViews.firstViewer.userId;return e.filter((e=>e!==a.Core.getUserId()&&e!==t))},getUserService(){if(!this.userService){this.userService=new S}return this.userService}},template:`\n\t\t<UserListPopup\n\t\t\tid="bx-im-message-reaction-users"\n\t\t\t:showPopup="showPopup"\n\t\t\t:loading="loadingAdditionalUsers"\n\t\t\t:userIds="additionalUsers"\n\t\t\t:bindElement="bindElement || {}"\n\t\t\t:withAngle="false"\n\t\t\t:offsetLeft="-112"\n\t\t\t:forceTop="true"\n\t\t\t@close="onPopupClose"\n\t\t/>\n\t`};const U=5;const f=1500;const T={components:{ReactionUser:g,AdditionalUsers:y},props:{messageId:{type:Number,required:true},type:{type:String,required:true},counter:{type:Number,required:true},users:{type:Array,required:true},selected:{type:Boolean,required:true},animate:{type:Boolean,required:true}},emits:["click"],data(){return{showAdditionalUsers:false}},computed:{showUsers(){const e=this.counter<=U;const t=this.counter===this.users.length;return e&&t},preparedUsers(){return[...this.users].sort(((e,t)=>e-t)).reverse()},reactionClass(){return i.reactionCssClass[this.type]}},mounted(){if(this.animate){this.playAnimation()}},methods:{playAnimation(){this.animation=r.Lottie.loadAnimation({animationData:i.ReactionsSelect.getLottieAnimation(this.type),container:this.$refs.reactionIcon,loop:false,autoplay:false,renderer:"svg",rendererSettings:{viewBoxOnly:true}});s.Event.bind(this.animation,"complete",(()=>{this.animation.destroy()}));s.Event.bind(this.animation,"destroy",(()=>{this.animation=null}));this.animation.play()},startShowUsersTimer(){this.showUsersTimeout=setTimeout((()=>{this.showAdditionalUsers=true}),f)},clearShowUsersTimer(){clearTimeout(this.showUsersTimeout)},onClick(){clearTimeout(this.showUsersTimeout);this.$emit("click",{animateItemFunction:this.playAnimation})}},template:`\n\t\t<div\n\t\t\t@click="onClick" \n\t\t\t@mouseenter="startShowUsersTimer"\n\t\t\t@mouseleave="clearShowUsersTimer"\n\t\t\tclass="bx-im-reaction-list__item"\n\t\t\t:class="{'--selected': selected}"\n\t\t>\n\t\t\t<div class="bx-im-reaction-list__item_icon" :class="reactionClass" ref="reactionIcon"></div>\n\t\t\t<div v-if="showUsers" class="bx-im-reaction-list__user_container" ref="users">\n\t\t\t\t<TransitionGroup name="bx-im-reaction-list__user_animation">\n\t\t\t\t\t<ReactionUser v-for="user in preparedUsers" :key="user" :userId="user" />\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-reaction-list__item_counter" ref="counter">{{ counter }}</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:show="showAdditionalUsers"\n\t\t\t\t:bindElement="$refs['users'] || $refs['counter'] || {}"\n\t\t\t\t:messageId="messageId"\n\t\t\t\t:reaction="type"\n\t\t\t\t@close="showAdditionalUsers = false"\n\t\t\t/>\n\t\t</div>\n\t`};const I={components:{ReactionItem:T},props:{messageId:{type:Number,required:true}},data(){return{mounted:false}},computed:{Reaction:()=>i.reactionType,message(){return this.$store.getters["messages/getById"](this.messageId)},reactionsData(){return this.$store.getters["messages/reactions/getByMessageId"](this.messageId)},reactionCounters(){var e,t;return(e=(t=this.reactionsData)==null?void 0:t.reactionCounters)!=null?e:{}},ownReactions(){var e,t;return(e=(t=this.reactionsData)==null?void 0:t.ownReactions)!=null?e:new Set},showReactionsContainer(){return Object.keys(this.reactionCounters).length>0}},watch:{showReactionsContainer(e,s){if(!s&&e){t.EventEmitter.emit(n.EventType.dialog.scrollToBottom,{chatId:this.message.chatId,threshold:n.DialogScrollThreshold.nearTheBottom})}}},mounted(){this.mounted=true},methods:{onReactionSelect(e,t){var s;const{animateItemFunction:i}=t;if((s=this.ownReactions)!=null&&s.has(e)){this.getReactionService().removeReaction(this.messageId,e);return}this.getReactionService().setReaction(this.messageId,e);i()},getReactionUsers(e){const t=this.reactionsData.reactionUsers[e];if(!t){return[]}return[...t]},getReactionService(){if(!this.reactionService){this.reactionService=new u}return this.reactionService}},template:`\n\t\t<div v-if="showReactionsContainer" class="bx-im-reaction-list__container">\n\t\t\t<template v-for="reactionType in Reaction">\n\t\t\t\t<ReactionItem\n\t\t\t\t\tv-if="reactionCounters[reactionType] > 0"\n\t\t\t\t\t:key="reactionType"\n\t\t\t\t\t:messageId="messageId"\n\t\t\t\t\t:type="reactionType"\n\t\t\t\t\t:counter="reactionCounters[reactionType]"\n\t\t\t\t\t:users="getReactionUsers(reactionType)"\n\t\t\t\t\t:selected="ownReactions.has(reactionType)"\n\t\t\t\t\t:animate="mounted"\n\t\t\t\t\t@click="onReactionSelect(reactionType, $event)"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</div>\n\t`};e.ReactionSelector=p;e.ReactionList=I})(this.BX.Messenger.v2.Component.Message=this.BX.Messenger.v2.Component.Message||{},BX.Event,BX,BX.Ui,BX.UI,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=reaction.bundle.map.js