this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,i,n,a,r,o,l,g,m,d,u,c,h,p){"use strict";const f={name:"ProgressBar",props:{item:{type:Object,required:true},messageId:{type:[String,Number],required:true}},computed:{file(){return this.item}},watch:{"file.status":function(){this.getProgressBarManager().update()},"file.progress":function(){this.getProgressBarManager().update()}},mounted(){this.initProgressBar()},beforeUnmount(){this.removeProgressBar()},methods:{initProgressBar(){if(this.file.progress===100){return}let e;if(this.file.progress<0||!this.isImage&&!this.isVideo){e=false}this.progressBarManager=new a.ProgressBarManager({container:this.$refs["progress-bar"],uploadState:this.file,customConfig:{blurElement:e,hasTitle:false}});this.progressBarManager.subscribe(a.ProgressBarManager.event.cancel,(()=>{n.EventEmitter.emit(p.EventType.uploader.cancel,{tempFileId:this.file.id,tempMessageId:this.messageId})}));this.progressBarManager.subscribe(a.ProgressBarManager.event.destroy,(()=>{if(this.progressBar){this.progressBar=null}}));this.progressBarManager.start()},removeProgressBar(){if(!this.getProgressBarManager()){return}this.getProgressBarManager().destroy()},getProgressBarManager(){return this.progressBarManager}},template:`\n\t\t<div class="bx-im-progress-bar__container" ref="progress-bar"></div>\n\t`};const v=420;const M=340;const I=200;const b=100;const y={name:"ImageItem",directives:{lazyload:s.lazyload},components:{ProgressBar:f},props:{item:{type:Object,required:true},message:{type:Object,required:true}},computed:{messageItem(){return this.message},file(){return this.item},imageSize(){let e=this.file.image.width;let t=this.file.image.height;if(this.file.image.width>v||this.file.image.height>M){const s=this.file.image.width/this.file.image.height;if(this.file.image.width>v){e=v;t=Math.round(v/s)}if(t>M){e=Math.round(M*s);t=M}}const s={width:Math.max(e,I),height:Math.max(t,b)};return{width:`${s.width}px`,height:`${s.height}px`,"object-fit":s.width<100||s.height<100?"cover":"contain"}},viewerAttributes(){return m.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},canBeOpenedWithViewer(){var e;return this.file.viewerAttrs&&((e=BX.UI)==null?void 0:e.Viewer)},imageTitle(){const e=m.Utils.file.formatFileSize(this.file.size);return this.loc("IM_ELEMENTS_MEDIA_IMAGE_TITLE",{"#NAME#":this.file.name,"#SIZE#":e})},isLoaded(){return this.file.progress===100},isForward(){return d.Type.isStringFilled(this.messageItem.forward.id)}},methods:{download(){var e;if(this.file.progress!==100||this.canBeOpenedWithViewer){return}const t=(e=this.file.urlDownload)!=null?e:this.file.urlShow;window.open(t,"_blank")},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div \n\t\t\tv-bind="viewerAttributes" \n\t\t\tclass="bx-im-media-image__container" \n\t\t\t:class="{'--with-forward': isForward}"\n\t\t\t@click="download"\n\t\t\t:style="imageSize"\n\t\t>\n\t\t\t<img\n\t\t\t\tv-lazyload\n\t\t\t\tdata-lazyload-dont-hide\n\t\t\t\t:data-lazyload-src="file.urlShow"\n\t\t\t\t:title="imageTitle"\n\t\t\t\t:alt="file.name"\n\t\t\t\tclass="bx-im-media-image__source"\n\t\t\t/>\n\t\t\t<ProgressBar v-if="!isLoaded" :item="file" :messageId="messageItem.id" />\n\t\t</div>\n\t`};const w={name:"ImageMessage",components:{ReactionList:u.ReactionList,BaseMessage:c.BaseMessage,MessageStatus:u.MessageStatus,DefaultMessageContent:u.DefaultMessageContent,ImageItem:y,ReactionSelector:u.ReactionSelector,ContextMenu:u.ContextMenu,MessageHeader:u.MessageHeader},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},withTitle:{type:Boolean,default:true},menuIsActiveForId:{type:[String,Number],default:0}},computed:{FileType:()=>p.FileType,message(){return this.item},onlyImage(){return this.message.text.length===0&&this.message.attach.length===0},onlyImageOrVideo(){return this.messageFile.type===p.FileType.image||this.messageFile.type===p.FileType.video},messageFile(){const e=this.message.files[0];return this.$store.getters["files/get"](e,true)},needBackground(){if(this.message.text.length>0){return true}return!this.onlyImageOrVideo},canSetReactions(){return d.Type.isNumber(this.message.id)}},template:`\n\t\t<BaseMessage \n\t\t\t:item="item" \n\t\t\t:dialogId="dialogId" \n\t\t\t:withBackground="needBackground" \n\t\t\t:withDefaultContextMenu="!onlyImage"\n\t\t>\n\t\t\t<div class="bx-im-message-image__container">\n\t\t\t\t<div class="bx-im-message-image__content-with-menu">\n\t\t\t\t\t<div class="bx-im-message-image__content-with-header">\n\t\t\t\t\t\t<MessageHeader :withTitle="false" :item="item" class="bx-im-message-image__header" />\n\t\t\t\t\t\t<div class="bx-im-message-image__content">\n\t\t\t\t\t\t\t<ImageItem\n\t\t\t\t\t\t\t\t:key="messageFile.id"\n\t\t\t\t\t\t\t\t:item="messageFile"\n\t\t\t\t\t\t\t\t:message="message"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<template v-if="onlyImage">\n\t\t\t\t\t\t\t\t<div class="bx-im-message-image__message-status-container">\n\t\t\t\t\t\t\t\t\t<MessageStatus :item="message" :isOverlay="onlyImage" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ContextMenu v-if="onlyImage" :message="message" :menuIsActiveForId="menuIsActiveForId" />\n\t\t\t\t</div>\n\t\t\t\t<div v-if="onlyImage" class="bx-im-message-image__reaction-list-container">\n\t\t\t\t\t<ReactionList :messageId="message.id" />\n\t\t\t\t</div>\n\t\t\t\t<div v-if="!onlyImage" class="bx-im-message-image__default-message-container">\n\t\t\t\t\t<DefaultMessageContent :item="item" :dialogId="dialogId" />\n\t\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BaseMessage>\n\t`};var B=babelHelpers.classPrivateFieldLooseKey("getMessageFile");class _ extends o.BaseMenu{constructor(){super();Object.defineProperty(this,B,{value:S});this.id=p.PopupType.messageBaseFileMenu;this.id="bx-im-message-file-context-menu";this.diskService=new r.DiskService}getMenuItems(){return[this.getDownloadFileItem(),this.getSaveToDisk()]}getDownloadFileItem(){const e=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e){return null}return{html:m.Utils.file.createDownloadLink(d.Loc.getMessage("IM_MESSAGE_FILE_MENU_DOWNLOAD_FILE"),e.urlDownload,e.name),onclick:function(){this.menuInstance.close()}.bind(this)}}getSaveToDisk(){const e=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e){return null}return{text:d.Loc.getMessage("IM_MESSAGE_FILE_MENU_SAVE_ON_DISK"),onclick:function(){void this.diskService.save(e.id).then((()=>{BX.UI.Notification.Center.notify({content:d.Loc.getMessage("IM_MESSAGE_FILE_MENU_SAVE_ON_DISK_SUCCESS")})}));this.menuInstance.close()}.bind(this)}}}function S(){if(this.context.files.length===0){return null}return this.store.getters["files/get"](this.context.files[0])}const x={name:"BaseFileItem",components:{ProgressBar:f},props:{item:{type:Object,required:true},messageId:{type:[String,Number],required:true}},computed:{file(){return this.item},fileShortName(){const e=40;return m.Utils.file.getShortFileName(this.file.name,e)},fileSize(){return m.Utils.file.formatFileSize(this.file.size)},iconClass(){const e=m.Utils.file.getIconTypeByFilename(this.file.name);return`ui-icon-file-${e}`},canBeOpenedWithViewer(){var e;return this.file.viewerAttrs&&((e=BX.UI)==null?void 0:e.Viewer)},viewerAttributes(){return m.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},isLoaded(){return this.file.progress===100}},created(){this.contextMenu=new _},beforeUnmount(){this.contextMenu.destroy()},methods:{download(){var e;if(this.file.progress!==100||this.canBeOpenedWithViewer){return}const t=(e=this.file.urlDownload)!=null?e:this.file.urlShow;window.open(t,"_blank")},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)},openContextMenu(e){this.$emit("openContextMenu",e)}},template:`\n\t\t<div class="bx-im-base-file-item__container bx-im-base-file-item__scope">\n\t\t\t<div class="bx-im-base-file-item__icon-container" ref="loader-icon" v-bind="viewerAttributes" @click="download">\n\t\t\t\t<div v-if="isLoaded" :class="iconClass" class="bx-im-base-file-item__type-icon ui-icon"><i></i></div>\n\t\t\t\t<ProgressBar v-else :item="file" :messageId="messageId" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-base-file-item__content" v-bind="viewerAttributes" @click="download">\n\t\t\t\t<span :title="file.name" class="bx-im-base-file-item__title">\n\t\t\t\t\t{{ fileShortName }}\n\t\t\t\t</span>\n\t\t\t\t<div class="bx-im-base-file-item__size">{{ fileSize }}</div>\n\t\t\t</div>\n\t\t\t<div \n\t\t\t\tclass="bx-im-base-file-item__download-icon"\n\t\t\t\t:class="{'--not-active': !isLoaded}"\n\t\t\t\t@click="openContextMenu"\n\t\t\t></div>\n\t\t</div>\n\t`};const F={name:"BaseFileMessage",components:{BaseMessage:c.BaseMessage,DefaultMessageContent:u.DefaultMessageContent,BaseFileItem:x,ReactionSelector:u.ReactionSelector,MessageHeader:u.MessageHeader},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},withTitle:{type:Boolean,default:true}},computed:{FileType:()=>p.FileType,message(){return this.item},messageFile(){const e=this.message.files[0];return this.$store.getters["files/get"](e,true)},canSetReactions(){return d.Type.isNumber(this.message.id)}},created(){this.contextMenu=new _},beforeUnmount(){this.contextMenu.destroy()},methods:{onOpenContextMenu(e){const t={dialogId:this.dialogId,...this.message};this.contextMenu.openMenu(t,e.target)}},template:`\n\t\t<BaseMessage :item="item" :dialogId="dialogId">\n\t\t\t<div class="bx-im-message-base-file__container">\n\t\t\t\t<MessageHeader :withTitle="withTitle" :item="item" class="bx-im-message-base-file__author-title" />\n\t\t\t\t<BaseFileItem\n\t\t\t\t\t:key="messageFile.id"\n\t\t\t\t\t:item="messageFile"\n\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t@openContextMenu="onOpenContextMenu"\n\t\t\t\t/>\n\t\t\t\t<DefaultMessageContent :item="item" :dialogId="dialogId" />\n\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t</div>\n\t\t</BaseMessage>\n\t`};const T=5e6;const C=420;const A=340;const V=200;const L=100;const D=320;const P=180;const E={name:"VideoItem",components:{SocialVideo:g.SocialVideo,ProgressBar:f},props:{item:{type:Object,required:true},messageId:{type:[String,Number],required:true}},computed:{file(){return this.item},autoplay(){return this.file.size<T},canBeOpenedWithViewer(){var e;return this.file.viewerAttrs&&((e=BX.UI)==null?void 0:e.Viewer)},viewerAttributes(){return m.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},imageSize(){let e=this.file.image.width;let t=this.file.image.height;if(!t||!e){return{width:`${D}px`,height:`${P}px`}}if(this.file.image.width>C||this.file.image.height>A){const s=this.file.image.width/this.file.image.height;if(this.file.image.width>C){e=C;t=Math.round(C/s)}if(t>A){e=Math.round(A*s);t=A}}const s={width:Math.max(e,V),height:Math.max(t,L)};return{width:`${s.width}px`,height:`${s.height}px`,"object-fit":s.width<100||s.height<100?"cover":"contain"}},isLoaded(){return this.file.progress===100}},methods:{download(){var e;if(this.file.progress!==100||this.canBeOpenedWithViewer){return}const t=(e=this.file.urlDownload)!=null?e:this.file.urlShow;window.open(t,"_blank")},getPlayCallback(){if(this.autoplay){return null}return()=>{}}},template:`\n\t\t<div @click="download" class="bx-im-video-item__container bx-im-video-item__scope">\n\t\t\t<ProgressBar v-if="!isLoaded" :item="file" :messageId="messageId" />\n\t\t\t<SocialVideo\n\t\t\t\tv-bind="viewerAttributes"\n\t\t\t\t:id="file.id"\n\t\t\t\t:src="file.urlShow"\n\t\t\t\t:preview="file.urlPreview"\n\t\t\t\t:elementStyle="imageSize"\n\t\t\t\t:autoplay="autoplay"\n\t\t\t\t:showControls="isLoaded"\n\t\t\t\t:playCallback="getPlayCallback()"\n\t\t\t/>\n\t\t</div>\n\t`};const k={name:"VideoMessage",components:{ReactionList:u.ReactionList,BaseMessage:c.BaseMessage,MessageStatus:u.MessageStatus,DefaultMessageContent:u.DefaultMessageContent,VideoItem:E,ReactionSelector:u.ReactionSelector,ContextMenu:u.ContextMenu,MessageHeader:u.MessageHeader},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},menuIsActiveForId:{type:[String,Number],default:0}},computed:{FileType:()=>p.FileType,message(){return this.item},onlyVideo(){return this.message.text.length===0&&this.message.attach.length===0},messageFile(){const e=this.message.files[0];return this.$store.getters["files/get"](e,true)},canSetReactions(){return d.Type.isNumber(this.message.id)}},template:`\n\t\t<BaseMessage \n\t\t\t:item="item" \n\t\t\t:dialogId="dialogId" \n\t\t\t:withBackground="!onlyVideo"\n\t\t\t:withDefaultContextMenu="!onlyVideo"\n\t\t>\n\t\t\t<div class="bx-im-message-video__container bx-im-message-video__scope">\n\t\t\t\t<div class="bx-im-message-video__content-with-menu">\n\t\t\t\t\t<div class="bx-im-message-video__content-with-header">\n\t\t\t\t\t\t<MessageHeader :withTitle="false" :item="item" class="bx-im-message-video__header" />\n\t\t\t\t\t\t<div class="bx-im-message-video__content">\n\t\t\t\t\t\t\t<VideoItem\n\t\t\t\t\t\t\t\t:key="messageFile.id"\n\t\t\t\t\t\t\t\t:item="messageFile"\n\t\t\t\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<template v-if="onlyVideo">\n\t\t\t\t\t\t\t\t<div class="bx-im-message-video__message-status-container">\n\t\t\t\t\t\t\t\t\t<MessageStatus :item="message" :isOverlay="onlyVideo" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ContextMenu v-if="onlyVideo" :message="message" :menuIsActiveForId="menuIsActiveForId" />\n\t\t\t\t</div>\n\t\t\t\t<div v-if="onlyVideo" class="bx-im-message-video__reaction-list-container">\n\t\t\t\t\t<ReactionList :messageId="message.id" />\n\t\t\t\t</div>\n\t\t\t\t<div v-if="!onlyVideo" class="bx-im-message-video__default-message-container">\n\t\t\t\t\t<DefaultMessageContent :item="item" :dialogId="dialogId" />\n\t\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BaseMessage>\n\t`};const O={name:"AudioItem",components:{AudioPlayer:h.AudioPlayer,ProgressBar:f},props:{item:{type:Object,required:true},messageType:{type:String,required:true},messageId:{type:[String,Number],required:true}},computed:{file(){return this.item},playerBackgroundType(){return this.messageType===p.MessageType.self?"dark":"light"},isLoaded(){return this.file.progress===100}},template:`\n\t\t<div class="bx-im-media-audio__container">\n\t\t\t<ProgressBar v-if="!isLoaded" :item="file" :messageId="messageId" />\n\t\t\t<AudioPlayer\n\t\t\t\t:id="file.id"\n\t\t\t\t:src="file.urlShow"\n\t\t\t\t:file="file"\n\t\t\t\t:timelineType="Math.floor(Math.random() * 5)"\n\t\t\t\t:authorId="file.authorId"\n\t\t\t\t:withContextMenu="false"\n\t\t\t\t:withAvatar="false"\n\t\t\t/>\n\t\t</div>\n\t`};const X={name:"AudioMessage",components:{BaseMessage:c.BaseMessage,MessageHeader:u.MessageHeader,DefaultMessageContent:u.DefaultMessageContent,AudioItem:O,ReactionSelector:u.ReactionSelector},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},withTitle:{type:Boolean,default:false}},computed:{FileType:()=>p.FileType,message(){return this.item},messageFile(){const e=this.message.files[0];return this.$store.getters["files/get"](e,true)},canSetReactions(){return d.Type.isNumber(this.message.id)},messageType(){return this.$store.getters["messages/getMessageType"](this.message.id)}},template:`\n\t\t<BaseMessage :item="item" :dialogId="dialogId">\n\t\t\t<div class="bx-im-message-audio__container">\n\t\t\t\t<MessageHeader :withTitle="withTitle" :item="item" class="bx-im-message-audio__header"/>\n\t\t\t\t<AudioItem\n\t\t\t\t\t:key="messageFile.id"\n\t\t\t\t\t:item="messageFile"\n\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t:messageType="messageType"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-audio__default-message-container">\n\t\t\t\t<DefaultMessageContent :item="item" :dialogId="dialogId" />\n\t\t\t\t<ReactionSelector :messageId="message.id" />\n\t\t\t</div>\n\t\t</BaseMessage>\n\t`};const N=Object.freeze({image:"ImageMessage",audio:"AudioMessage",video:"VideoMessage",base:"BaseFileMessage",collection:"CollectionFileMessage"});const R={name:"FileMessage",components:{BaseFileMessage:F,ImageMessage:w,VideoMessage:k,AudioMessage:X,UnsupportedMessage:t.UnsupportedMessage},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},withTitle:{type:Boolean,default:true},menuIsActiveForId:{type:[String,Number],default:0}},computed:{FileType:()=>p.FileType,message(){return this.item},messageFiles(){const e=[];if(this.message.files.length===0){return e}this.message.files.forEach((t=>{const s=this.$store.getters["files/get"](t,true);e.push(s)}));return e},componentName(){const e=this.messageFiles[0];const t=Boolean(e.image);if(e.type===p.FileType.image&&t){return N.image}if(e.type===p.FileType.audio){return N.audio}const s=e.type===p.FileType.video||m.Utils.file.getFileExtension(e.name)==="mkv";if(s&&t){return N.video}return N.base}},template:`\n\t\t<component \n\t\t\t:is="componentName" \n\t\t\t:item="message" \n\t\t\t:dialogId="dialogId" \n\t\t\t:withTitle="withTitle" \n\t\t\t:menuIsActiveForId="menuIsActiveForId"\n\t\t\t:withRetryButton="false"\n\t\t/>\n\t`};e.FileMessage=R})(this.BX.Messenger.v2.Component.Message=this.BX.Messenger.v2.Component.Message||{},BX.Messenger.v2.Component.Message,BX.Vue3.Directives,BX.Messenger.v2.Model,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX,BX.Vue3.Components,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Const);
//# sourceMappingURL=file-message.bundle.map.js