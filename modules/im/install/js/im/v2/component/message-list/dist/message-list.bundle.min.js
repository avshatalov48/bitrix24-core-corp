this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,s,i,a,n,o,r,l,c,g,d,u,h,p,m,M,v,I,_,b,C,f,L,A,E,x,T,y,S,B,P,U,k){"use strict";class D{async loadReadUsers(e){let i=[];s.Logger.warn("Dialog: UserService: loadReadUsers",e);const a=await v.Core.getRestClient().callMethod(I.RestMethod.imV2ChatMessageTailViewers,{id:e}).catch((e=>{console.error("Dialog: UserService: loadReadUsers error",e);throw new Error(e)}));i=a.data().users;const n=new t.UserManager;await n.setUsersToModel(Object.values(i));return i.map((e=>e.id))}}const F={components:{UserListPopup:p.UserListPopup},props:{dialogId:{type:String,required:true},show:{type:Boolean,required:true},bindElement:{type:Object,required:true}},emits:["close"],data(){return{showPopup:false,loadingAdditionalUsers:false,additionalUsers:[]}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)}},watch:{show(e,t){if(!t&&e){this.showPopup=true;this.loadUsers()}}},methods:{async loadUsers(){this.loadingAdditionalUsers=true;const e=await this.getUserService().loadReadUsers(this.dialog.lastMessageId).catch((()=>{this.loadingAdditionalUsers=false}));this.additionalUsers=this.prepareAdditionalUsers(e);this.loadingAdditionalUsers=false},onPopupClose(){this.showPopup=false;this.$emit("close")},prepareAdditionalUsers(e){const t=this.dialog.lastMessageViews.firstViewer.userId;return e.filter((e=>e!==v.Core.getUserId()&&e!==t))},getUserService(){if(!this.userService){this.userService=new D}return this.userService}},template:`\n\t\t<UserListPopup\n\t\t\tid="bx-im-dialog-read-users"\n\t\t\t:showPopup="showPopup"\n\t\t\t:loading="loadingAdditionalUsers"\n\t\t\t:userIds="additionalUsers"\n\t\t\t:bindElement="bindElement || {}"\n\t\t\t:withAngle="false"\n\t\t\t:forceTop="true"\n\t\t\t@close="onPopupClose"\n\t\t/>\n\t`};const w=3;const H="bx-im-dialog-chat-status__user-count";const G={components:{AdditionalUsers:F},props:{dialogId:{required:true,type:String}},data(){return{showAdditionalUsers:false,additionalUsersLinkElement:null}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===I.ChatType.user},isChat(){return!this.isUser},typingStatus(){if(!this.dialog.inited||this.dialog.writingList.length===0){return""}const e=this.dialog.writingList.slice(0,w);const t=e.map((e=>e.userName)).join(", ");const s=this.dialog.writingList.length-w;if(s>0){return this.loc("IM_DIALOG_CHAT_STATUS_TYPING_PLURAL",{"#USER#":t,"#COUNT#":s})}return this.loc("IM_DIALOG_CHAT_STATUS_TYPING",{"#USER#":t})},readStatus(){if(!this.dialog.inited){return""}if(this.lastMessageViews.countOfViewers===0){return""}if(this.isUser){return this.formatUserViewStatus()}return this.formatChatViewStatus()},lastMessageViews(){return this.dialog.lastMessageViews}},methods:{formatUserViewStatus(){const{date:e}=this.lastMessageViews.firstViewer;return this.loc("IM_DIALOG_CHAT_STATUS_READ_USER",{"#DATE#":_.DateFormatter.formatByTemplate(e,_.DateTemplate.messageReadStatus)})},formatChatViewStatus(){const{countOfViewers:e,firstViewer:t}=this.lastMessageViews;if(e===1){return this.loc("IM_DIALOG_CHAT_STATUS_READ_CHAT",{"#USER#":t.userName})}return this.loc("IM_DIALOG_CHAT_STATUS_READ_CHAT_PLURAL",{"#USERS#":m.Text.encode(t.userName),"#LINK_START#":`<span class="${H}" ref="moreUsersLink">`,"#COUNT#":e-1,"#LINK_END#":"</span>"})},onClick(e){if(!e.target.matches(`.${H}`)){return}this.onMoreUsersClick()},onMoreUsersClick(){this.additionalUsersLinkElement=document.querySelector(`.${H}`);this.showAdditionalUsers=true},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div @click="onClick" class="bx-im-dialog-chat-status__container">\n\t\t\t<div v-if="typingStatus" class="bx-im-dialog-chat-status__content">\n\t\t\t\t<div class="bx-im-dialog-chat-status__icon --typing"></div>\n\t\t\t\t<div class="bx-im-dialog-chat-status__text">{{ typingStatus }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if="readStatus" class="bx-im-dialog-chat-status__content">\n\t\t\t\t<div class="bx-im-dialog-chat-status__icon --read"></div>\n\t\t\t\t<div v-html="readStatus" class="bx-im-dialog-chat-status__text"></div>\n\t\t\t</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:show="showAdditionalUsers"\n\t\t\t\t:bindElement="additionalUsersLinkElement || {}"\n\t\t\t\t@close="showAdditionalUsers = false"\n\t\t\t/>\n\t\t</div>\n\t`};const O={name:"DialogLoader",props:{fullHeight:{type:Boolean,default:true}},data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-dialog-loader__container" :class="{'--full-height': fullHeight}">\n\t\t\t<div class="bx-im-dialog-loader__spinner"></div>\n\t\t\t<div class="bx-im-dialog-loader__text">{{ loc('IM_DIALOG_CHAT_LOADER_TEXT') }}</div>\n\t\t</div>\n\t`};const N=new Set([I.MessageComponent.unsupported,I.MessageComponent.chatCreation,I.MessageComponent.ownChatCreation,I.MessageComponent.conferenceCreation,I.MessageComponent.callInvite,I.MessageComponent.copilotCreation,I.MessageComponent.copilotMessage,I.MessageComponent.supportVote,I.MessageComponent.supportSessionNumber]);var X=babelHelpers.classPrivateFieldLooseKey("message");var R=babelHelpers.classPrivateFieldLooseKey("store");var K=babelHelpers.classPrivateFieldLooseKey("isServerComponent");var V=babelHelpers.classPrivateFieldLooseKey("hasFiles");var j=babelHelpers.classPrivateFieldLooseKey("hasText");var $=babelHelpers.classPrivateFieldLooseKey("hasAttach");var Y=babelHelpers.classPrivateFieldLooseKey("isEmptyMessage");var q=babelHelpers.classPrivateFieldLooseKey("isDeletedMessage");var z=babelHelpers.classPrivateFieldLooseKey("isSystemMessage");var W=babelHelpers.classPrivateFieldLooseKey("isEmojiOnly");var Q=babelHelpers.classPrivateFieldLooseKey("hasSmilesOnly");var J=babelHelpers.classPrivateFieldLooseKey("hasOnlyText");var Z=babelHelpers.classPrivateFieldLooseKey("isForward");class ee{constructor(e){Object.defineProperty(this,Z,{value:de});Object.defineProperty(this,J,{value:ge});Object.defineProperty(this,Q,{value:ce});Object.defineProperty(this,W,{value:le});Object.defineProperty(this,z,{value:re});Object.defineProperty(this,q,{value:oe});Object.defineProperty(this,Y,{value:ne});Object.defineProperty(this,$,{value:ae});Object.defineProperty(this,j,{value:ie});Object.defineProperty(this,V,{value:se});Object.defineProperty(this,K,{value:te});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e;babelHelpers.classPrivateFieldLooseBase(this,R)[R]=v.Core.getStore()}getName(){if(babelHelpers.classPrivateFieldLooseBase(this,q)[q]()){return I.MessageComponent.deleted}if(babelHelpers.classPrivateFieldLooseBase(this,K)[K]()){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].componentId}if(babelHelpers.classPrivateFieldLooseBase(this,z)[z]()){return I.MessageComponent.system}if(babelHelpers.classPrivateFieldLooseBase(this,V)[V]()){return I.MessageComponent.file}if(babelHelpers.classPrivateFieldLooseBase(this,W)[W]()||babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]()){return I.MessageComponent.smile}return I.MessageComponent.default}}function te(){return N.has(babelHelpers.classPrivateFieldLooseBase(this,X)[X].componentId)}function se(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].files.length>0}function ie(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].text.length>0}function ae(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].attach.length>0}function ne(){return!babelHelpers.classPrivateFieldLooseBase(this,j)[j]()&&!babelHelpers.classPrivateFieldLooseBase(this,V)[V]()&&!babelHelpers.classPrivateFieldLooseBase(this,$)[$]()}function oe(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].isDeleted||babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]()}function re(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].authorId===0}function le(){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X].replyId>0){return false}if(babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]()){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,J)[J]()){return false}return u.Utils.text.isEmojiOnly(babelHelpers.classPrivateFieldLooseBase(this,X)[X].text)}function ce(){var e,t;if(babelHelpers.classPrivateFieldLooseBase(this,X)[X].replyId>0){return false}if(babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]()){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,J)[J]()){return false}const s=i.SmileManager.getInstance();const a=(e=(t=s.smileList)==null?void 0:t.smiles)!=null?e:[];const n=[...a].sort(((e,t)=>t.typing.localeCompare(e.typing)));const o=n.map((e=>u.Utils.text.escapeRegex(e.typing))).join("|");const r=babelHelpers.classPrivateFieldLooseBase(this,X)[X].text.replaceAll(new RegExp(o,"g"),"");const l=r.trim().length===0;const c=new RegExp(`(?:(?:${o})\\s*){4,}`);return l&&!c.test(babelHelpers.classPrivateFieldLooseBase(this,X)[X].text)}function ge(){if(!babelHelpers.classPrivateFieldLooseBase(this,j)[j]()){return false}return!babelHelpers.classPrivateFieldLooseBase(this,V)[V]()&&!babelHelpers.classPrivateFieldLooseBase(this,$)[$]()}function de(){return babelHelpers.classPrivateFieldLooseBase(this,R)[R].getters["messages/isForward"](babelHelpers.classPrivateFieldLooseBase(this,X)[X].id)}class ue extends r.BaseMenu{constructor(){super();this.id="bx-im-avatar-context-menu";this.permissionManager=n.PermissionManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:21}}getMenuItems(){return[this.getMentionItem(),this.getSendItem(),this.getProfileItem(),this.getKickItem()]}getMentionItem(){return{text:m.Loc.getMessage("IM_DIALOG_AVATAR_MENU_MENTION_2"),onclick:()=>{M.EventEmitter.emit(I.EventType.textarea.insertMention,{mentionText:this.context.user.name,mentionReplacement:u.Utils.text.getMentionBbCode(this.context.user.id,this.context.user.name)});this.menuInstance.close()}}}getSendItem(){if(this.context.dialog.type===I.ChatType.user){return null}return{text:m.Loc.getMessage("IM_DIALOG_AVATAR_MENU_SEND_MESSAGE"),onclick:()=>{a.Messenger.openChat(this.context.user.id);this.menuInstance.close()}}}getProfileItem(){return{text:m.Loc.getMessage("IM_DIALOG_AVATAR_MENU_OPEN_PROFILE"),href:u.Utils.user.getProfileLink(this.context.user.id),onclick:()=>{this.menuInstance.close()}}}getKickItem(){const e=this.permissionManager.canPerformAction(I.ChatActionType.kick,this.context.dialog.dialogId);if(!e){return null}return{text:m.Loc.getMessage("IM_DIALOG_AVATAR_MENU_KICK"),onclick:async()=>{this.menuInstance.close();const e=await o.showKickUserConfirm();if(e===true){const e=new g.ChatService;e.kickUserFromChat(this.context.dialog.dialogId,this.context.user.id)}}}}}var he=babelHelpers.classPrivateFieldLooseKey("isOwnMessage");var pe=babelHelpers.classPrivateFieldLooseKey("isDeletedMessage");var me=babelHelpers.classPrivateFieldLooseKey("getMessageFile");var Me=babelHelpers.classPrivateFieldLooseKey("isForwardedMessage");class ve extends r.BaseMenu{constructor(){super();Object.defineProperty(this,Me,{value:Ce});Object.defineProperty(this,me,{value:be});Object.defineProperty(this,pe,{value:_e});Object.defineProperty(this,he,{value:Ie});this.id="bx-im-message-context-menu";this.diskService=new g.DiskService;this.marketManager=d.MarketManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:11}}getMenuItems(){return[this.getReplyItem(),this.getCopyItem(),this.getCopyFileItem(),this.getPinItem(),this.getForwardItem(),this.getDelimiter(),this.getMarkItem(),this.getFavoriteItem(),this.getDelimiter(),this.getCreateItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}getReplyItem(){return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_REPLY"),onclick:()=>{M.EventEmitter.emit(I.EventType.textarea.replyMessage,{messageId:this.context.id});this.menuInstance.close()}}}getForwardItem(){if(babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()||m.Type.isString(this.context.id)){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_FORWARD"),onclick:()=>{M.EventEmitter.emit(I.EventType.dialog.showForwardPopup,{messageId:this.context.id});this.menuInstance.close()}}}getCopyItem(){if(this.context.text.trim().length===0){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY"),onclick:()=>{var e;const t=l.Parser.prepareCopy(this.context);if((e=BX.clipboard)!=null&&e.copy(t)){BX.UI.Notification.Center.notify({content:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY_SUCCESS")})}this.menuInstance.close()}}}getCopyFileItem(){if(this.context.files.length===0){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY_FILE"),onclick:()=>{var e;const t=l.Parser.prepareCopyFile(this.context);if((e=BX.clipboard)!=null&&e.copy(t)){BX.UI.Notification.Center.notify({content:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY_FILE_SUCCESS")})}this.menuInstance.close()}}}getPinItem(){if(babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()){return null}const e=this.store.getters["messages/pin/isPinned"]({chatId:this.context.chatId,messageId:this.context.id});return{text:e?m.Loc.getMessage("IM_DIALOG_CHAT_MENU_UNPIN"):m.Loc.getMessage("IM_DIALOG_CHAT_MENU_PIN"),onclick:()=>{const t=new g.MessageService({chatId:this.context.chatId});if(e){t.unpinMessage(this.context.chatId,this.context.id)}else{t.pinMessage(this.context.chatId,this.context.id)}this.menuInstance.close()}}}getFavoriteItem(){if(babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()){return null}const e=this.store.getters["sidebar/favorites/isFavoriteMessage"](this.context.chatId,this.context.id);const t=e?m.Loc.getMessage("IM_DIALOG_CHAT_MENU_REMOVE_FROM_SAVED"):m.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE");return{text:t,onclick:()=>{const t=new g.MessageService({chatId:this.context.chatId});if(e){t.removeMessageFromFavorite(this.context.id)}else{t.addMessageToFavorite(this.context.id)}this.menuInstance.close()}}}getMarkItem(){const e=this.context.viewed&&!babelHelpers.classPrivateFieldLooseBase(this,he)[he]();const t=this.store.getters["chats/getByChatId"](this.context.chatId);const s=this.context.id===t.markedId;if(!e||s){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_MARK"),onclick:()=>{const e=new g.MessageService({chatId:this.context.chatId});e.markMessage(this.context.id);this.menuInstance.close()}}}getCreateItem(){if(babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE"),items:[this.getCreateTaskItem(),this.getCreateMeetingItem(),...this.getMarketItems()]}}getCreateTaskItem(){return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE_TASK"),onclick:()=>{const e=new c.EntityCreator(this.context.chatId);void e.createTaskForMessage(this.context.id);this.menuInstance.close()}}}getCreateMeetingItem(){return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE_MEETING"),onclick:()=>{const e=new c.EntityCreator(this.context.chatId);void e.createMeetingForMessage(this.context.id);this.menuInstance.close()}}}getEditItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,he)[he]()||babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()||babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]()){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_EDIT"),onclick:()=>{M.EventEmitter.emit(I.EventType.textarea.editMessage,{messageId:this.context.id});this.menuInstance.close()}}}getDeleteItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,he)[he]()||babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_DELETE"),className:"menu-popup-no-icon bx-im-dialog-chat__message-menu_delete",onclick:()=>{const e=new g.MessageService({chatId:this.context.chatId});e.deleteMessage(this.context.id);this.menuInstance.close()}}}getMarketItems(){const{dialogId:e,id:t}=this.context;const s=this.marketManager.getAvailablePlacementsByType(I.PlacementType.contextMenu,e);const i=[];if(s.length>0){i.push(this.getDelimiter())}const a={messageId:t,dialogId:e};s.forEach((e=>{i.push({text:e.title,onclick:()=>{d.MarketManager.openSlider(e,a);this.menuInstance.close()}})}));const n=11;return i.slice(0,n)}getDownloadFileItem(){const e=babelHelpers.classPrivateFieldLooseBase(this,me)[me]();if(!e){return null}return{html:u.Utils.file.createDownloadLink(m.Loc.getMessage("IM_DIALOG_CHAT_MENU_DOWNLOAD_FILE"),e.urlDownload,e.name),onclick:function(){this.menuInstance.close()}.bind(this)}}getSaveToDisk(){const e=babelHelpers.classPrivateFieldLooseBase(this,me)[me]();if(!e){return null}return{text:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE_ON_DISK"),onclick:function(){void this.diskService.save(e.id).then((()=>{BX.UI.Notification.Center.notify({content:m.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE_ON_DISK_SUCCESS")})}));this.menuInstance.close()}.bind(this)}}getDelimiter(){return{delimiter:true}}}function Ie(){return this.context.authorId===v.Core.getUserId()}function _e(){return this.context.isDeleted}function be(){if(this.context.files.length===0){return null}return this.store.getters["files/get"](this.context.files[0])}function Ce(){return m.Type.isStringFilled(this.context.forward.id)}const fe={props:{title:{type:String,required:true}},data(){return{}},template:`\n\t\t<div class="bx-im-message-list-date-group-title__container">\n\t\t\t<div class="bx-im-message-list-date-group-title__text">{{ title }}</div>\n\t\t</div>\n\t`};const Le={name:"DateGroup",components:{DateGroupTitle:fe},props:{item:{type:Object,required:true}},data(){return{}},computed:{BlockType:()=>I.DialogBlockType,dateGroup(){return this.item}},template:`\n\t\t<div class="bx-im-message-list-date-group__container">\n\t\t\t<DateGroupTitle :title="dateGroup.date.title" />\n\t\t\t<template v-for="dateGroupItem in dateGroup.items" >\n\t\t\t\t<slot\n\t\t\t\t\tname="dateGroupItem"\n\t\t\t\t\t:dateGroupItem="dateGroupItem"\n\t\t\t\t\t:isMarkedBlock="dateGroupItem.type === BlockType.markedMessages"\n\t\t\t\t\t:isNewMessagesBlock="dateGroupItem.type === BlockType.newMessages"\n\t\t\t\t\t:isAuthorBlock="dateGroupItem.type === BlockType.authorGroup"\n\t\t\t\t></slot>\n\t\t\t</template>\n\t\t</div>\n\t`};const Ae={name:"AuthorGroup",components:{Avatar:p.Avatar},props:{item:{type:Object,required:true}},emits:["avatarClick"],data(){return{}},computed:{AvatarSize:()=>p.AvatarSize,authorGroup(){return this.item}},methods:{onAvatarClick(e){this.$emit("avatarClick",{dialogId:this.authorGroup.avatar.avatarId,$event:e})}},template:`\n\t\t<div class="bx-im-message-list-author-group__container" :class="'--' + authorGroup.messageType">\n\t\t\t<div v-if="authorGroup.avatar.isNeeded" class="bx-im-message-list-author-group__avatar">\n\t\t\t\t<Avatar\n\t\t\t\t\t:dialogId="authorGroup.avatar.avatarId"\n\t\t\t\t\t:size="AvatarSize.L"\n\t\t\t\t\t:withStatus="false"\n\t\t\t\t\t@click="onAvatarClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-list__content">\n\t\t\t\t<template v-for="(message, index) in authorGroup.items">\n\t\t\t\t\t<slot name="message" :message="message" :index="index"></slot>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ee={data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-message-list-new-message__container">\n\t\t\t<div class="bx-im-message-list-new-message__text">\n\t\t\t\t{{ loc('IM_DIALOG_CHAT_BLOCK_NEW_MESSAGES_2') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const xe={data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-message-list-new-message__container">\n\t\t\t<div class="bx-im-message-list-new-message__text">\n\t\t\t\t{{ loc('IM_DIALOG_CHAT_BLOCK_MARKED_MESSAGES') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Te=[m.Loc.getMessage("IM_MESSAGE_LIST_EMPTY_STATE_DEFAULT_MESSAGE_1"),m.Loc.getMessage("IM_MESSAGE_LIST_EMPTY_STATE_DEFAULT_MESSAGE_2"),m.Loc.getMessage("IM_MESSAGE_LIST_EMPTY_STATE_DEFAULT_MESSAGE_3"),m.Loc.getMessage("IM_MESSAGE_LIST_EMPTY_STATE_DEFAULT_MESSAGE_4"),m.Loc.getMessage("IM_MESSAGE_LIST_EMPTY_STATE_DEFAULT_MESSAGE_5")];const ye={name:"EmptyState",data(){return{}},computed:{defaultMessages:()=>Te},methods:{onMessageClick(e){M.EventEmitter.emit(I.EventType.textarea.insertText,{text:e})},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-message-list-empty-state__container">\n\t\t\t<div class="bx-im-message-list-empty-state__content">\n\t\t\t\t<div class="bx-im-message-list-empty-state__icon"></div>\n\t\t\t\t<div class="bx-im-message-list-empty-state__title">{{ loc('IM_MESSAGE_LIST_EMPTY_STATE_TITLE') }}</div>\n\t\t\t\t<div class="bx-im-message-list-empty-state__action-list">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-for="(message, index) in defaultMessages"\n\t\t\t\t\t\t:key="index"\n\t\t\t\t\t\t@click="onMessageClick(message)"\n\t\t\t\t\t\tclass="bx-im-message-list-empty-state__action-list_item"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ message }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class Se{constructor(e){this.firstIteration=true;this.cachedDateGroups={};this.store=v.Core.getStore();this.dialogId=e}formatMessageCollection(e){const t={};const s=[];let i=null;let a=null;let n=null;const o=this.store.getters["chats/get"](this.dialogId);const{markedId:r,inited:l}=o;let c=false;const g=this.store.getters["chats/getLastReadId"](this.dialogId);if(this.firstIteration){this.initialLastReadMessage=g;this.initialMarkedId=r}if(r!==this.initialMarkedId&&r!==0){this.initialMarkedId=r;this.initialLastReadMessage=null}e.forEach(((o,r)=>{const l=this.getDateGroup(o.date);if(!t[l.title]){t[l.title]=l.id;i=[];s.push({type:I.DialogBlockType.dateGroup,date:l,items:i});a=null}if(o.id===this.initialMarkedId){i.push({type:I.DialogBlockType.markedMessages});a=null;c=true}if(o.authorId!==a){a=o.authorId;n=[];i.push({type:I.DialogBlockType.authorGroup,userId:o.authorId,avatar:this.getAvatarConfig(o),messageType:this.getMessageType(o),items:n})}n.push(o);const g=r===e.length-1;if(!c&&!g&&o.id===this.initialLastReadMessage){i.push({type:I.DialogBlockType.newMessages});a=null}}));if(l){this.firstIteration=false}return s}getDateGroup(e){const t=10;const s=e.toJSON().slice(0,t);if(this.cachedDateGroups[s]){return this.cachedDateGroups[s]}this.cachedDateGroups[s]={id:s,title:_.DateFormatter.formatByTemplate(e,_.DateTemplate.dateGroup)};return this.cachedDateGroups[s]}getAvatarConfig(e){const t=this.getMessageType(e);const s=t===I.MessageType.system;const i=t===I.MessageType.self;const a=this.store.getters["application/settings/get"](I.Settings.appearance.alignment);let n=true;if(a===I.DialogAlignment.left){n=!s}else if(a===I.DialogAlignment.center){n=!i&&!s}return{isNeeded:n,avatarId:e.authorId.toString()}}getMessageType(e){if(!e.authorId){return I.MessageType.system}if(e.authorId===v.Core.getUserId()){return I.MessageType.self}return I.MessageType.opponent}}const Be={DefaultMessage:C.DefaultMessage,FileMessage:b.FileMessage,SmileMessage:E.SmileMessage,CallInviteMessage:f.CallInviteMessage,DeletedMessage:L.DeletedMessage,SystemMessage:x.SystemMessage,UnsupportedMessage:A.UnsupportedMessage,ChatCreationMessage:T.ChatCreationMessage,OwnChatCreationMessage:k.OwnChatCreationMessage,ChatCopilotCreationMessage:y.ChatCopilotCreationMessage,CopilotMessage:S.CopilotMessage,SupportVoteMessage:B.SupportVoteMessage,SupportSessionNumberMessage:P.SupportSessionNumberMessage,ConferenceCreationMessage:U.ConferenceCreationMessage};const Pe={name:"MessageList",directives:{"message-observer":{mounted(e,t){t.instance.observer.observeMessage(e)},beforeUnmount(e,t){t.instance.observer.unobserveMessage(e)}}},components:{DateGroup:Le,AuthorGroup:Ae,NewMessagesBlock:Ee,MarkedMessagesBlock:xe,DialogStatus:G,DialogLoader:O,EmptyState:ye,...Be},props:{dialogId:{type:String,required:true},messages:{type:Array,required:true},observer:{type:Object,required:true}},emits:["showQuoteButton"],data(){return{messageMenuIsActiveForId:0}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===I.ChatType.user},dialogInited(){return this.dialog.inited},messageCollection(){return this.messages},formattedCollection(){if(!this.dialogInited&&this.messageCollection.length===0){return[]}return this.getCollectionManager().formatMessageCollection(this.messageCollection)},noMessages(){return this.formattedCollection.length===0},showDialogStatus(){return this.messageCollection.some((e=>e.id===this.dialog.lastMessageId))},statusComponent(){return G}},created(){this.initContextMenu();this.initCollectionManager()},mounted(){this.subscribeToEvents()},beforeUnmount(){this.unsubscribeFromEvents()},methods:{subscribeToEvents(){M.EventEmitter.subscribe(I.EventType.dialog.onClickMessageContextMenu,this.onMessageContextMenuClick)},unsubscribeFromEvents(){M.EventEmitter.unsubscribe(I.EventType.dialog.onClickMessageContextMenu,this.onMessageContextMenuClick)},initCollectionManager(){this.getCollectionManager()},initContextMenu(){this.messageMenu=new ve;this.messageMenu.subscribe(ve.events.onCloseMenu,(()=>{this.messageMenuIsActiveForId=0}));this.avatarMenu=new ue},onAvatarClick(e){const{dialogId:t,$event:s}=e;const i=this.$store.getters["users/get"](t);const a=Number.parseInt(t,10);if(!i||v.Core.getUserId()===a){return}if(u.Utils.key.isAltOrOption(s)){M.EventEmitter.emit(I.EventType.textarea.insertMention,{mentionText:i.name,mentionReplacement:u.Utils.text.getMentionBbCode(i.id,i.name)});return}this.avatarMenu.openMenu({user:i,dialog:this.dialog},s.currentTarget)},onMessageContextMenuClick(e){const{message:t,event:s}=e.getData();const i={dialogId:this.dialogId,...t};this.messageMenu.openMenu(i,s.currentTarget);this.messageMenuIsActiveForId=t.id},async onMessageMouseUp(e,t){await u.Utils.browser.waitForSelectionToUpdate();const s=window.getSelection().toString().trim();if(s.length===0||this.isGuest){return}this.$emit("showQuoteButton",e,t)},getMessageComponentName(e){return new ee(e).getName()},getCollectionManager(){if(!this.collectionManager){this.collectionManager=new Se(this.dialogId)}return this.collectionManager}},template:`\n\t\t<div class="bx-im-message-list__container">\n\t\t\t<DialogLoader v-if="!dialogInited" :fullHeight="noMessages" />\n\t\t\t<EmptyState v-else-if="noMessages && isUser" />\n\t\t\t<DateGroup v-for="dateGroup in formattedCollection" :key="dateGroup.date.id" :item="dateGroup">\n\t\t\t\t\x3c!-- Slot for every date group item --\x3e\n\t\t\t\t<template #dateGroupItem="{ dateGroupItem, isMarkedBlock, isNewMessagesBlock, isAuthorBlock }">\n\t\t\t\t\t<MarkedMessagesBlock v-if="isMarkedBlock" data-id="newMessages" />\n\t\t\t\t\t<NewMessagesBlock v-else-if="isNewMessagesBlock" data-id="newMessages" />\n\t\t\t\t\t<AuthorGroup v-else-if="isAuthorBlock" :item="dateGroupItem" @avatarClick="onAvatarClick">\n\t\t\t\t\t\t\x3c!-- Slot for every message --\x3e\n\t\t\t\t\t\t<template #message="{ message, index }">\n\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\tv-message-observer\n\t\t\t\t\t\t\t\t:is="getMessageComponentName(message)"\n\t\t\t\t\t\t\t\t:withTitle="index === 0"\n\t\t\t\t\t\t\t\t:item="message"\n\t\t\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t\t\t:key="message.id"\n\t\t\t\t\t\t\t\t:menuIsActiveForId="messageMenuIsActiveForId"\n\t\t\t\t\t\t\t\t:data-viewed="message.viewed"\n\t\t\t\t\t\t\t\t@mouseup="onMessageMouseUp(message, $event)"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</AuthorGroup>\n\t\t\t\t</template>\n\t\t\t</DateGroup>\n\t\t\t<component :is="statusComponent" v-if="showDialogStatus" :dialogId="dialogId" />\n\t\t</div>\n\t`};e.MessageList=Pe})(this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Component.Elements,BX,BX.Event,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message);
//# sourceMappingURL=message-list.bundle.map.js