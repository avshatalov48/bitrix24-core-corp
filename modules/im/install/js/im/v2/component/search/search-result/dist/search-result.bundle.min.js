this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,s,r,i,a,n,l,o,c,d,h,u,m,p,v,b){"use strict";const y={getWordsFromString(e){const t=e.replaceAll("("," ").replaceAll(")"," ").replaceAll("["," ").replaceAll("]"," ").replaceAll("{"," ").replaceAll("}"," ").replaceAll("<"," ").replaceAll(">"," ").replaceAll("-"," ").replaceAll("#"," ").replaceAll('"'," ").replaceAll("'"," ").replace(/\s\s+/g," ");return t.split(" ").filter((e=>e!==""))},getTypeByEntityId(e){switch(e){case v.SearchEntityIdTypes.user:case v.SearchEntityIdTypes.bot:return"user";case v.SearchEntityIdTypes.chat:case v.SearchEntityIdTypes.chatUser:return"chat";case v.SearchEntityIdTypes.department:return"department";case v.SearchEntityIdTypes.network:return"network";default:throw new Error(`Unknown entity id: ${e}`)}},createItemMap(e){const t=new Map;e.forEach((e=>{const s=new T(e);t.set(s.getEntityFullId(),s)}));return t},getFirstItemFromMap(e){const t=e.entries();const s=t.next();const r=s.value;const[,i]=r;return i},convertKeysToLowerCase(e){const t={};Object.keys(e).forEach((s=>{if(u.Type.isObject(e[s])&&!u.Type.isArray(e[s])){t[s.toLowerCase()]=this.convertKeysToLowerCase(e[s])}else{t[s.toLowerCase()]=e[s]}}));return t},convertKeysToUpperCase(e){const t={};Object.keys(e).forEach((s=>{if(u.Type.isObject(e[s])&&!u.Type.isArray(e[s])){t[s.toUpperCase()]=this.convertKeysToUpperCase(e[s])}else{t[s.toUpperCase()]=e[s]}}));return t},prepareRecentItems(e){if(!e){return[]}return e.map((e=>{const[t,s]=e;const r=y.getTypeByEntityId(t);return{cacheId:`${r}|${s}`,date:new Date}}))}};var g=babelHelpers.classPrivateFieldLooseKey("isFromProviderResponse");var f=babelHelpers.classPrivateFieldLooseKey("setId");var I=babelHelpers.classPrivateFieldLooseKey("setDialogId");var S=babelHelpers.classPrivateFieldLooseKey("setEntityId");var L=babelHelpers.classPrivateFieldLooseKey("setEntityType");var F=babelHelpers.classPrivateFieldLooseKey("setTitle");var P=babelHelpers.classPrivateFieldLooseKey("setSubtitle");var w=babelHelpers.classPrivateFieldLooseKey("setName");var C=babelHelpers.classPrivateFieldLooseKey("setLastName");var B=babelHelpers.classPrivateFieldLooseKey("setSecondName");var E=babelHelpers.classPrivateFieldLooseKey("setPosition");var M=babelHelpers.classPrivateFieldLooseKey("setAvatar");var H=babelHelpers.classPrivateFieldLooseKey("setAvatarOptions");var k=babelHelpers.classPrivateFieldLooseKey("setContextSort");var x=babelHelpers.classPrivateFieldLooseKey("setRawData");class T{constructor(e){Object.defineProperty(this,x,{value:X});Object.defineProperty(this,k,{value:Q});Object.defineProperty(this,H,{value:q});Object.defineProperty(this,M,{value:z});Object.defineProperty(this,E,{value:W});Object.defineProperty(this,B,{value:$});Object.defineProperty(this,C,{value:K});Object.defineProperty(this,w,{value:j});Object.defineProperty(this,P,{value:U});Object.defineProperty(this,F,{value:N});Object.defineProperty(this,L,{value:O});Object.defineProperty(this,S,{value:A});Object.defineProperty(this,I,{value:R});Object.defineProperty(this,f,{value:D});Object.defineProperty(this,g,{value:_});this.entityType=null;this.dialogId=null;this.title=null;this.subtitle=null;this.name=null;this.lastName=null;this.secondName=null;this.position=null;this.avatar=null;this.avatarOptions=null;this.customSort=0;this.contextSort=0;this.fromStore=false;this.rawData=null;babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);babelHelpers.classPrivateFieldLooseBase(this,I)[I](e);babelHelpers.classPrivateFieldLooseBase(this,S)[S](e);babelHelpers.classPrivateFieldLooseBase(this,L)[L](e);babelHelpers.classPrivateFieldLooseBase(this,F)[F](e);babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);babelHelpers.classPrivateFieldLooseBase(this,w)[w](e);babelHelpers.classPrivateFieldLooseBase(this,C)[C](e);babelHelpers.classPrivateFieldLooseBase(this,B)[B](e);babelHelpers.classPrivateFieldLooseBase(this,E)[E](e);babelHelpers.classPrivateFieldLooseBase(this,M)[M](e);babelHelpers.classPrivateFieldLooseBase(this,H)[H](e);babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)}isFromModel(e){return u.Type.isString(e.dialogId)&&u.Type.isObject(e.dialog)}getId(){return this.id}getEntityId(){return this.entityId}getEntityType(){return this.entityType.toLowerCase()}getEntityFullId(){const e=y.getTypeByEntityId(this.entityId);return`${e}|${this.id}`}getTitle(){return this.title}getSubtitle(){return this.subtitle}getName(){return this.name}getLastName(){return this.lastName}getSecondName(){return this.secondName}getPosition(){return this.position}getCustomData(){return this.rawData.customData}getDialogId(){return this.dialogId}getAvatar(){return this.avatar}getAvatarOptions(){return this.avatarOptions}getContextSort(){return this.contextSort?this.contextSort:0}addCustomSort(e){this.customSort+=e}getCustomSort(){return this.customSort}isUser(){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](this.rawData)){var e;return!!((e=this.rawData.customData)!=null&&e.imUser)&&this.rawData.customData.imUser.ID>0}return!!this.rawData.user}isChat(){return[v.SearchEntityIdTypes.chat,v.SearchEntityIdTypes.chatUser].includes(this.getEntityId())}isExtranet(){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](this.rawData)){var e,t,s,r;return!!((e=this.rawData.customData)!=null&&(t=e.imUser)!=null&&t.EXTRANET)||!!((s=this.rawData.customData)!=null&&(r=s.imChat)!=null&&r.EXTRANET)}else if(this.isFromModel(this.rawData)){var i;return!!((i=this.rawData.user)!=null&&i.extranet)||!!this.rawData.dialog.extranet}}getUserCustomData(){var e;return(e=this.rawData.customData)!=null&&e.imUser?this.rawData.customData.imUser:null}getChatCustomData(){var e;return(e=this.rawData.customData)!=null&&e.imChat?this.rawData.customData.imChat:null}isOpeLinesType(){return this.getEntityType()==="lines"}isDepartmentType(){return this.getEntityId()===v.SearchEntityIdTypes.department}isNetworkType(){return this.getEntityId()===v.SearchEntityIdTypes.network}getOpenlineEntityId(){var e,t;if(!this.isOpeLinesType()){return""}const s=(e=this.rawData.customData)==null?void 0:(t=e.imChat)==null?void 0:t.ENTITY_ID;return s.toString().split("|")[0]}getAvatarColor(){let e="";if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](this.rawData)){if(this.isUser()){var t,s,r;e=(t=this.rawData.customData)==null?void 0:(s=t.imUser)==null?void 0:(r=s.COLOR)==null?void 0:r.toString()}else if(this.isChat()){var i,a,n;e=(i=this.rawData.customData)==null?void 0:(a=i.imChat)==null?void 0:(n=a.COLOR)==null?void 0:n.toString()}}else if(this.isFromModel(this.rawData)){e=this.rawData.dialog.color.toString()}return e}isCrmSession(){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](this.rawData)&&this.isOpeLinesType()){var e,t;const s=(e=this.rawData.customData)==null?void 0:(t=e.imChat)==null?void 0:t.ENTITY_DATA_1.toString().split("|");return s[0]==="Y"}return false}}function _(e){return u.Type.isString(e.entityId)&&!u.Type.isNil(e.id)}function D(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.id=e.id}else if(this.isFromModel(e)){const t=e.dialogId.startsWith("chat")?e.dialogId.slice(4):e.dialogId;this.id=Number.parseInt(t,10);this.fromStore=true}}function R(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){var t,s,r,i;if(((t=e.customData)==null?void 0:(s=t.imChat)==null?void 0:s.ID)>0){this.dialogId=`chat${e.customData.imChat.ID}`}else if(((r=e.customData)==null?void 0:(i=r.imUser)==null?void 0:i.ID)>0){this.dialogId=e.customData.imUser.ID.toString()}}else if(this.isFromModel(e)){this.dialogId=e.dialogId}}function A(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.entityId=e.entityId}else if(this.isFromModel(e)){if(!e.user){this.entityId=v.SearchEntityIdTypes.chat}else if(e.user.bot){this.entityId=v.SearchEntityIdTypes.bot}else{this.entityId=v.SearchEntityIdTypes.user}}}function O(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.entityType=e.entityType?e.entityType.toLowerCase():""}else if(this.isFromModel(e)){const{type:t}=e.dialog;if(t===v.DialogType.user){this.entityType=e.user.extranet?"extranet":"employee"}else{this.entityType=t}}}function N(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.title=e.title}else if(this.isFromModel(e)){this.title=e.dialog.name}}function U(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.subtitle=e.subtitle}}function j(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){var t;this.name=(t=e.customData)==null?void 0:t.name}else if(this.isFromModel(e)){var s;this.name=(s=e.user)==null?void 0:s.firstName}}function K(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){var t;this.lastName=(t=e.customData)==null?void 0:t.lastName}else if(this.isFromModel(e)){var s;this.lastName=(s=e.user)==null?void 0:s.lastName}}function $(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){var t;this.secondName=(t=e.customData)==null?void 0:t.secondName}}function W(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){var t;this.position=(t=e.customData)==null?void 0:t.position}else if(this.isFromModel(e)){var s;this.position=(s=e.user)==null?void 0:s.workPosition}}function z(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.avatar=e.avatar!==""?e.avatar:null}else if(this.isFromModel(e)){const t=e.user?e.user.avatar:e.dialog.avatar;this.avatar=t!==""?decodeURI(t):null}}function q(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.avatarOptions=e.avatarOptions}}function Q(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){this.contextSort=e.contextSort}}function X(e){this.rawData=e}const V="O";const Y="C";var G=babelHelpers.classPrivateFieldLooseKey("config");var J=babelHelpers.classPrivateFieldLooseKey("store");var Z=babelHelpers.classPrivateFieldLooseKey("currentUserId");var ee=babelHelpers.classPrivateFieldLooseKey("settings");var te=babelHelpers.classPrivateFieldLooseKey("networkSearchButtonClicked");var se=babelHelpers.classPrivateFieldLooseKey("get");var re=babelHelpers.classPrivateFieldLooseKey("getBotsEntity");var ie=babelHelpers.classPrivateFieldLooseKey("getUserEntity");var ae=babelHelpers.classPrivateFieldLooseKey("getChatUserEntity");var ne=babelHelpers.classPrivateFieldLooseKey("getNetworkEntity");var le=babelHelpers.classPrivateFieldLooseKey("getDepartmentEntity");var oe=babelHelpers.classPrivateFieldLooseKey("getChatEntity");var ce=babelHelpers.classPrivateFieldLooseKey("needChats");var de=babelHelpers.classPrivateFieldLooseKey("needBots");var he=babelHelpers.classPrivateFieldLooseKey("needNetwork");var ue=babelHelpers.classPrivateFieldLooseKey("needDepartments");var me=babelHelpers.classPrivateFieldLooseKey("isDepartmentsAvailable");var pe=babelHelpers.classPrivateFieldLooseKey("needExtranet");var ve=babelHelpers.classPrivateFieldLooseKey("needCurrentUser");var be=babelHelpers.classPrivateFieldLooseKey("isCurrentUserExtranet");var ye=babelHelpers.classPrivateFieldLooseKey("getDefaultConfig");class ge{constructor(e){Object.defineProperty(this,ye,{value:_e});Object.defineProperty(this,be,{value:Te});Object.defineProperty(this,ve,{value:xe});Object.defineProperty(this,pe,{value:ke});Object.defineProperty(this,me,{value:He});Object.defineProperty(this,ue,{value:Me});Object.defineProperty(this,he,{value:Ee});Object.defineProperty(this,de,{value:Be});Object.defineProperty(this,ce,{value:Ce});Object.defineProperty(this,oe,{value:we});Object.defineProperty(this,le,{value:Pe});Object.defineProperty(this,ne,{value:Fe});Object.defineProperty(this,ae,{value:Le});Object.defineProperty(this,ie,{value:Se});Object.defineProperty(this,re,{value:Ie});Object.defineProperty(this,se,{value:fe});Object.defineProperty(this,G,{writable:true,value:{}});Object.defineProperty(this,J,{writable:true,value:void 0});Object.defineProperty(this,Z,{writable:true,value:void 0});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,te,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,G)[G]={...babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](),...e};babelHelpers.classPrivateFieldLooseBase(this,J)[J]=l.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=u.Extension.getSettings("im.v2.component.search.search-result");babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=l.Core.getUserId()}getRecentRequestConfig(){const e=[babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](),babelHelpers.classPrivateFieldLooseBase(this,oe)[oe](),babelHelpers.classPrivateFieldLooseBase(this,re)[re](),babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]()];return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}getSearch(){const e=[babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](),babelHelpers.classPrivateFieldLooseBase(this,oe)[oe](),babelHelpers.classPrivateFieldLooseBase(this,re)[re](),babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](),babelHelpers.classPrivateFieldLooseBase(this,le)[le](),babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]()];return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}getDepartmentUsers(){const e=[babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](),babelHelpers.classPrivateFieldLooseBase(this,re)[re](),babelHelpers.classPrivateFieldLooseBase(this,le)[le]()];return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}getNetwork(){const e=[babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]()];return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}enableNetworkSearch(){babelHelpers.classPrivateFieldLooseBase(this,te)[te]=true}disableNetworkSearch(){babelHelpers.classPrivateFieldLooseBase(this,te)[te]=false}isItemAllowed(e){if(e.isUser()&&e.isExtranet()&&!babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]()){return false}if(e.isNetworkType()&&!babelHelpers.classPrivateFieldLooseBase(this,he)[he]()){return false}if(e.isChat()&&!babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]()){return false}if(e.isUser()&&!babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]()&&e.getId()===babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]){return false}return true}isNetworkAvailable(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].get("isNetworkAvailable",false)&&babelHelpers.classPrivateFieldLooseBase(this,G)[G].network}}function fe(e){e=e.filter((e=>!u.Type.isNil(e)));return{dialog:{entities:e,preselectedItems:[],clearUnavailableItems:false,context:"IM_CHAT_SEARCH",id:"im-search"}}}function Ie(){if(!babelHelpers.classPrivateFieldLooseBase(this,de)[de]()){return null}return{id:"im-bot",options:{searchableBotTypes:["H","B","S","N"],fillDialogWithDefaultValues:false},dynamicLoad:true,dynamicSearch:true}}function Se(){return{id:"user",dynamicLoad:true,dynamicSearch:true,filters:[{id:"im.userDataFilter"}]}}function Le(){if(!babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]()){return null}return{id:"im-chat-user",options:{searchableChatTypes:[V,Y],fillDialogWithDefaultValues:false},dynamicLoad:true,dynamicSearch:true}}function Fe(){if(!babelHelpers.classPrivateFieldLooseBase(this,he)[he]()){return}return{id:"imbot-network",dynamicSearch:true,options:{filterExistingLines:true}}}function Pe(){if(!babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]){return null}return{id:"department",dynamicLoad:true,dynamicSearch:true,options:{selectMode:"usersAndDepartments",allowSelectRootDepartment:true},filters:[{id:"im.departmentDataFilter"}]}}function we(){if(!babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]()){return null}return{id:"im-chat",options:{searchableChatTypes:[Y,V],fillDialogWithDefaultValues:false},dynamicLoad:true,dynamicSearch:true}}function Ce(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G].chats}function Be(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G].bots}function Ee(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te]&&this.isNetworkAvailable()}function Me(){if(babelHelpers.classPrivateFieldLooseBase(this,be)[be]()||!babelHelpers.classPrivateFieldLooseBase(this,me)[me]()){return false}return babelHelpers.classPrivateFieldLooseBase(this,G)[G].departments}function He(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].get("isDepartmentsAvailable",false)}function ke(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G].extranet}function xe(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G].currentUser}function Te(){const e=babelHelpers.classPrivateFieldLooseBase(this,J)[J].getters["users/get"](babelHelpers.classPrivateFieldLooseBase(this,Z)[Z],true);return e.extranet}function _e(){return{currentUser:true,excludeUsers:[],extranet:true,chats:true,bots:true,departments:true,network:true}}var De=babelHelpers.classPrivateFieldLooseKey("store");var Re=babelHelpers.classPrivateFieldLooseKey("userManager");var Ae=babelHelpers.classPrivateFieldLooseKey("addDialoguesToModel");var Oe=babelHelpers.classPrivateFieldLooseKey("setDialoguesToModel");var Ne=babelHelpers.classPrivateFieldLooseKey("removeActivityData");var Ue=babelHelpers.classPrivateFieldLooseKey("prepareDataForModels");class je{constructor(){Object.defineProperty(this,Ue,{value:ze});Object.defineProperty(this,Ne,{value:We});Object.defineProperty(this,Oe,{value:$e});Object.defineProperty(this,Ae,{value:Ke});Object.defineProperty(this,De,{writable:true,value:void 0});Object.defineProperty(this,Re,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,De)[De]=l.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=new n.UserManager}update(e){const{items:t,onlyAdd:s}=e;const{users:r,dialogues:i}=babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue](t);if(s){const e=babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne](r);return Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].addUsersToModel(e),babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae](i)])}return Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].setUsersToModel(r),babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe](i)])}}function Ke(e){return babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("dialogues/add",e)}function $e(e){return babelHelpers.classPrivateFieldLooseBase(this,De)[De].dispatch("dialogues/set",e)}function We(e){return e.map((e=>({...e,last_activity_date:false,mobile_last_date:false,status:"",idle:false,absent:false,birthday:""})))}function ze(e){const t={users:[],dialogues:[]};e.forEach((e=>{if(!e.getCustomData()||e.fromStore){return}if(e.isUser()){const s=y.convertKeysToLowerCase(e.getUserCustomData());t.users.push(s)}if(e.isChat()&&!e.isOpeLinesType()){const s=y.convertKeysToLowerCase(e.getChatCustomData());t.dialogues.push({...s,dialogId:`chat${s.id}`})}}));return t}var qe=babelHelpers.classPrivateFieldLooseKey("store");var Qe=babelHelpers.classPrivateFieldLooseKey("isRussianInterface");class Xe{constructor(){Object.defineProperty(this,Qe,{value:Ve});Object.defineProperty(this,qe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]=l.Core.getStore()}changeLayout(e){if(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]()&&BX.correctText){return BX.correctText(e,{replace_way:"AUTO"})}return e}needLayoutChange(e){const t=this.changeLayout(e);const s=t===e;return babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]()&&!s}}function Ve(){return l.Core.getLanguageId()==="ru"}class Ye{constructor(){this.store=l.Core.getStore();this.layoutManager=new Xe}sortItemsByEntityIdAndContextSort(e){const t={user:100,"im-chat":80,"im-chat-user":80,"im-bot":70,department:60,extranet:10};return new Map([...e.entries()].sort(((e,s)=>{const[,r]=e;const[,i]=s;const a=i.isExtranet()?"extranet":i.getEntityId();const n=r.isExtranet()?"extranet":r.getEntityId();if(t[a]<t[n]){return-1}else if(t[a]>t[n]){return 1}else{return i.getContextSort()-r.getContextSort()}})))}allocateSearchResults(e,t){const s=new Map;const r=new Map;const i=new Map;const a=new Map;const n=new Map;e.forEach((e=>{switch(e.getEntityId()){case v.SearchEntityIdTypes.chatUser:{r.set(e.getEntityFullId(),e);break}case v.SearchEntityIdTypes.department:{i.set(e.getEntityFullId(),e);break}case v.SearchEntityIdTypes.network:{n.set(e.getEntityFullId(),e);break}default:{if(e.isOpeLinesType()){a.set(e.getEntityFullId(),e)}else{s.set(e.getEntityFullId(),e)}}}}));return{usersAndChats:this.getSortedItems(s,t),chatUsers:r,departments:i,openLines:a,network:n}}sortItemsBySearchField(e,t){let s=y.getWordsFromString(t);if(this.layoutManager.needLayoutChange(t)){const e=y.getWordsFromString(this.layoutManager.changeLayout(t));s=[...s,...e]}const r=[...new Set(s)];const i={title:1e4,name:1e3,lastName:100,position:1};e.forEach((e=>{r.forEach((t=>{var s,r,a;if(e.getTitle().toLowerCase().startsWith(t)){e.addCustomSort(i.title)}else if((s=e.getName())!=null&&s.toLowerCase().startsWith(t)){e.addCustomSort(i.name)}else if((r=e.getLastName())!=null&&r.toLowerCase().startsWith(t)){e.addCustomSort(i.lastName)}else if((a=e.getPosition())!=null&&a.toLowerCase().startsWith(t)){e.addCustomSort(i.position)}}))}));return new Map([...e.entries()].sort(((e,t)=>{const[,s]=e;const[,r]=t;return r.getCustomSort()-s.getCustomSort()})))}getSortedItems(e,t){let s=this.sortItemsBySearchField(e,t);s=this.sortItemsByEntityIdAndContextSort(s);return s}}const Ge=new Intl.Collator(undefined,{sensitivity:"base"});var Je=babelHelpers.classPrivateFieldLooseKey("store");class Ze{constructor(){Object.defineProperty(this,Je,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]=l.Core.getStore();this.layoutManager=new Xe}load(){const e=[];babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["recent/getSortedCollection"].forEach((t=>{const s=babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["dialogues/get"](t.dialogId,true);const r=babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["users/get"](t.dialogId,true);e.push({dialogId:t.dialogId,dialog:s,user:r})}));return e.filter((e=>e.dialog.type==="user"&&!e.user.bot&&e.user.id!==l.Core.getUserId()))}search(e){let t=Promise.resolve([]);if(this.layoutManager.needLayoutChange(e)){const s=this.layoutManager.changeLayout(e);t=this.getItemsFromRecentListByQuery(s)}const s=this.getItemsFromRecentListByQuery(e);return Promise.all([s,t]).then((e=>new Map([...e[0],...e[1]])))}getItemsFromRecentListByQuery(e){const t=y.getWordsFromString(e);return y.createItemMap(this.getFromStore(t))}getFromStore(e){const t=this.getRecentListItems();const s=[];t.forEach((t=>{if(this.searchByQueryWords(t,e)){s.push(t)}}));return s}getRecentListItems(){return babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["recent/getSortedCollection"].map((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["dialogues/get"](e.dialogId,true);const s=t.type===v.DialogType.user;const r={dialogId:e.dialogId,dialog:t};if(s){r.user=babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].getters["users/get"](e.dialogId,true)}return r}))}searchByQueryWords(e,t){if(e.user){return this.searchByUserFields(e,t)}return this.searchByDialogFields(e,t)}searchByDialogFields(e,t){const s=[];if(e.dialog.name){const t=y.getWordsFromString(e.dialog.name.toLowerCase());s.push(...t)}return this.doesItemMatchQuery(s,t)}searchByUserFields(e,t){const s=[];if(e.user.firstName){const t=y.getWordsFromString(e.user.firstName.toLowerCase());s.push(...t)}if(e.user.lastName){const t=y.getWordsFromString(e.user.lastName.toLowerCase());s.push(...t)}if(e.user.workPosition){const t=y.getWordsFromString(e.user.workPosition.toLowerCase());s.push(...t)}return this.doesItemMatchQuery(s,t)}doesItemMatchQuery(e,t){let s=0;t.forEach((t=>{let r=0;e.forEach((e=>{const s=e.slice(0,t.length);if(Ge.compare(t,s)===0){r++}}));if(r>0){s++}}));return s>=t.length}}class et{static getInstance(e){if(!this.instance){this.instance=new this(e)}return this.instance}constructor(e){this.db=new o.Dexie("bx-im-search-results");this.db.version(2).stores({items:"id, *title, *name, *lastName, *secondName, *position, date",recentItems:"++id, cacheId, date",settings:"&name"}).upgrade((e=>{const t=e.table("items").clear();const s=e.table("recentItems").clear();return o.Dexie.Promise.all([t,s])}));this.db.version(3).stores({items:"id, *title, *name, *lastName, *position, date",recentItems:"++id, cacheId, date",settings:"&name"});this.checkTables(e);this.onAccessDeniedHandler=this.onAccessDenied.bind(this);p.EventEmitter.subscribe(v.EventType.dialog.errors.accessDenied,this.onAccessDeniedHandler);this.collator=new Intl.Collator(undefined,{sensitivity:"base"})}checkTables(e){this.db.open();this.db.on("ready",(()=>this.db.transaction("rw",this.db.settings,this.db.items,this.db.recentItems,(()=>this.db.settings.where("name").equals("userId").first())).then((t=>{const s=[];if((t==null?void 0:t.value)!==e){const e=this.db.items.clear();const t=this.db.recentItems.clear();s.push(e,t)}return o.Dexie.Promise.all(s)})).then((()=>this.db.settings.put({name:"userId",value:e})))))}destroy(){p.EventEmitter.unsubscribe(v.EventType.dialog.errors.accessDenied,this.onAccessDeniedHandler)}loadRecentFromCache(){const e={};return this.db.transaction("rw",this.db.items,this.db.recentItems,(()=>this.deleteExpiredItems().then((()=>this.db.recentItems.orderBy("id").toArray())))).then((t=>{e.recentItems=t;const s=[];e.recentItems.forEach((e=>{s.push(this.db.items.get({id:e.cacheId}))}));return o.Dexie.Promise.all(s)})).then((t=>{e.items=t.filter((e=>!u.Type.isUndefined(e))).map((e=>e.json));return e}))}save(e){const t=e.items?this.prepareItems(e.items):[];const s=e.recentItems?y.prepareRecentItems(e.recentItems):[];this.db.transaction("rw",this.db.items,this.db.recentItems,(()=>{if(t.length>0){this.db.items.bulkPut(t)}if(s.length>0){this.db.recentItems.clear().then((()=>{this.db.recentItems.bulkPut(s)}))}}))}deleteExpiredItems(){const e=new Date(Date.now()-60*60*1e3*24*7*30);return this.db.items.where("date").below(e).delete().then((()=>this.db.recentItems.where("date").below(e).delete()))}onAccessDenied({data:e}){const t=this.convertDialogIdToCacheItemId(e.dialogId);return this.db.items.where("id").equals(t).delete().then((()=>this.db.recentItems.where("cacheId").equals(t).delete()))}convertDialogIdToCacheItemId(e){if(e.startsWith("chat")){return`chat|${e.slice(4)}`}return`user|${e}`}prepareItems(e){return e.filter((e=>e.entityId!==v.SearchEntityIdTypes.department&&e.entityId!==v.SearchEntityIdTypes.network&&e.entityType!=="LINES")).map((e=>{var t,s,r,i;const a=y.getTypeByEntityId(e.entityId);return{id:`${a}|${e.id}`,name:(t=e.customData)!=null&&t.name?y.getWordsFromString(e.customData.name):[],lastName:(s=e.customData)!=null&&s.lastName?y.getWordsFromString(e.customData.lastName):[],position:(r=e.customData.imUser)!=null&&r.WORK_POSITION?y.getWordsFromString((i=e.customData.imUser)==null?void 0:i.WORK_POSITION):[],title:e.title?y.getWordsFromString(e.title):[],json:e,date:new Date}}))}unshiftItem(e){const[t,s]=e;const r=y.getTypeByEntityId(t);const i=`${r}|${s}`;this.db.transaction("rw",this.db.recentItems,(()=>this.db.recentItems.toArray())).then((e=>{const t=e.findIndex((e=>e.cacheId===i));if(t===0){return}if(t!==-1){const s=e.splice(t,1);s[0].date=new Date;e.unshift(s[0])}else{const t={cacheId:`${i}|${s}`,date:new Date};e.unshift(t)}e.forEach((e=>delete e.id));this.db.recentItems.clear().then((()=>{this.db.recentItems.bulkPut(e)}))}))}search(e){return this.db.transaction("r",this.db.items,function*(){const t=yield this.getQueryResultByWords(e);if(!u.Type.isArrayFilled(t)){return[]}const s=this.intersectArrays(...t);const r=[...new Set(s.flat())];return yield this.db.items.where(":id").anyOf(r).toArray()}.bind(this)).then((e=>e.map((e=>e.json))))}getQueryResultByWords(e){return o.Dexie.Promise.all(e.map((e=>this.db.table("items").filter((t=>{const s=[...t.name.flat(),...t.lastName.flat(),...t.position.flat(),...t.title.flat()];return s.some((t=>{const s=t.slice(0,e.length).toLowerCase();return this.collator.compare(s,e)===0}))})).distinct().primaryKeys())))}intersectArrays(e,t,...s){if(u.Type.isUndefined(t)){return e}const r=e.filter((e=>t.includes(e)));if(s.length===0){return r}return this.intersectArrays(r,...s)}}et.instance=null;class tt{constructor(e){this.store=l.Core.getStore();this.db=et.getInstance(l.Core.getUserId());this.config=e;this.layoutManager=new Xe}load(){return this.db.loadRecentFromCache().then((e=>{d.Logger.warn("Im.Search: Recent search loaded from cache",e);return e})).then((e=>{const{items:t,recentItems:s}=e;const r=y.createItemMap(t);return{recentItems:s,itemMap:r}}))}save(e){return this.db.save(e)}unshiftItem(e){return this.db.unshiftItem(e)}search(e){let t=Promise.resolve([]);if(this.layoutManager.needLayoutChange(e)){const s=this.layoutManager.changeLayout(e);t=this.getItemsFromCacheByQuery(s)}const s=this.getItemsFromCacheByQuery(e);return Promise.all([s,t]).then((e=>new Map([...e[0],...e[1]]))).catch((e=>{console.error("Unknown exception",e);return new Map}))}getItemsFromCacheByQuery(e){const t=y.getWordsFromString(e);return this.db.search(t).then((e=>y.createItemMap(e)))}destroy(){this.db.destroy()}}var st=babelHelpers.classPrivateFieldLooseKey("searchConfig");class rt{constructor(e){Object.defineProperty(this,st,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,st)[st]=e}searchRequest(e){const t={json:babelHelpers.classPrivateFieldLooseBase(this,st)[st].getSearch()};t.json.searchQuery={queryWords:y.getWordsFromString(e),query:e};return new Promise(((e,s)=>{u.ajax.runAction("ui.entityselector.doSearch",t).then((t=>{d.Logger.warn(`Im.Search: Search request result`,t);e(t.data.dialog.items)})).catch((e=>s(e)))}))}loadRecentFromServer(){const e={json:babelHelpers.classPrivateFieldLooseBase(this,st)[st].getRecentRequestConfig()};return new Promise(((t,s)=>{u.ajax.runAction("ui.entityselector.load",e).then((e=>{d.Logger.warn(`Im.Search: Recent search request result`,e);t(e.data.dialog)})).catch((e=>s(e)))}))}addItemsToRecentSearchResults(e){const[t,s]=e;const r=[{id:s,entityId:t}];const i={json:{...babelHelpers.classPrivateFieldLooseBase(this,st)[st].getRecentRequestConfig(),recentItems:r}};u.ajax.runAction("ui.entityselector.saveRecentItems",i)}}const it="imopenlines.network.join";var at=babelHelpers.classPrivateFieldLooseKey("searchConfig");class nt{constructor(e){Object.defineProperty(this,at,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,at)[at]=e}search(e){const t={json:babelHelpers.classPrivateFieldLooseBase(this,at)[at].getNetwork()};t.json.searchQuery={queryWords:y.getWordsFromString(e.trim()),query:e.trim()};return new Promise(((e,s)=>{u.ajax.runAction("ui.entityselector.doSearch",t).then((t=>{d.Logger.warn(`Im.Search: Network Search request result`,t);e(t.data.dialog.items)})).catch((e=>s(e)))}))}loadItem(e){const t={[it]:{code:e},[v.RestMethod.imUserGet]:{id:`$result[${it}]`}};return c.callBatch(t).then((e=>{const t=e[v.RestMethod.imUserGet];return{id:t.id,entityId:v.SearchEntityIdTypes.bot,entityType:"network",title:t.name,customData:{imUser:y.convertKeysToUpperCase(t)},avatar:t.avatar}}))}}var lt=babelHelpers.classPrivateFieldLooseKey("searchConfig");class ot{constructor(e){Object.defineProperty(this,lt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,lt)[lt]=e}loadUsers(e){const t={id:e.getId(),entityId:e.getEntityId()};const s={json:{...babelHelpers.classPrivateFieldLooseBase(this,lt)[lt].getDepartmentUsers(),parentItem:t}};return new Promise(((e,t)=>{u.ajax.runAction("ui.entityselector.getChildren",s).then((t=>{d.Logger.warn("Im.V2.Search: department users response",t);e(t.data.dialog.items)})).catch((e=>t(e)))}))}}var ct=babelHelpers.classPrivateFieldLooseKey("processResponse");var dt=babelHelpers.classPrivateFieldLooseKey("filterByConfig");var ht=babelHelpers.classPrivateFieldLooseKey("getItemsFromRecentItems");class ut{constructor(e){Object.defineProperty(this,ht,{value:vt});Object.defineProperty(this,dt,{value:pt});Object.defineProperty(this,ct,{value:mt});this.searchConfig=new ge(e);this.storeUpdater=new je;this.sortingResult=new Ye;this.recentStateSearchService=new Ze;this.indexedDbSearchService=new tt;this.baseServerSearchService=new rt(this.searchConfig);this.networkSearchService=new nt(this.searchConfig);this.departmentSearchService=new ot(this.searchConfig)}loadRecentSearchFromCache(){return this.indexedDbSearchService.load().then((e=>{const{recentItems:t,itemMap:s}=e;return babelHelpers.classPrivateFieldLooseBase(this,ht)[ht](t,s)})).then((e=>babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:e,onlyAdd:true})))}loadRecentUsers(){const e=this.recentStateSearchService.load();const t=y.createItemMap(e);return babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:t,updateStore:false})}loadRecentSearchFromServer(){return this.baseServerSearchService.loadRecentFromServer().then((e=>{this.indexedDbSearchService.save(e);d.Logger.warn("Im.Search: Recent search loaded from server");const{items:t,recentItems:s}=e;const r=y.createItemMap(t);const i=y.prepareRecentItems(s);return babelHelpers.classPrivateFieldLooseBase(this,ht)[ht](i,r)})).then((e=>babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:e})))}searchLocal(e){const t=this.indexedDbSearchService.search(e);const s=this.recentStateSearchService.search(e);return Promise.all([t,s]).then((e=>{const[t,s]=e;return Promise.all([babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:t,onlyAdd:false}),babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:s,updateStore:false})])})).then((t=>{const[s,r]=t;const i=new Map([...r,...s]);return this.sortingResult.getSortedItems(i,e)}))}searchOnServer(e){return this.baseServerSearchService.searchRequest(e).then((e=>{this.indexedDbSearchService.save({items:e});return y.createItemMap(e)})).then((e=>babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:e}))).then((t=>this.sortingResult.allocateSearchResults(t,e)))}searchOnNetwork(e){this.searchConfig.enableNetworkSearch();return this.networkSearchService.search(e).then((e=>y.createItemMap(e)))}loadDepartmentUsers(e){return this.departmentSearchService.loadUsers(e).then((e=>{this.indexedDbSearchService.save({items:e});const t=y.createItemMap(e);return babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:t})}))}loadNetworkItem(e){return this.networkSearchService.loadItem(e).then((e=>{const t=y.createItemMap([e]);return babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]({items:t})}))}addItemToRecent(e){if(e.isDepartmentType()||e.isNetworkType()){return}const t=[e.entityId,e.id];this.indexedDbSearchService.unshiftItem(t);this.baseServerSearchService.addItemsToRecentSearchResults(t)}isNetworkAvailable(){return this.searchConfig.isNetworkAvailable()}disableNetworkSearch(){this.searchConfig.disableNetworkSearch()}destroy(){this.indexedDbSearchService.destroy()}}function mt({items:e,updateStore:t=true,onlyAdd:s=false}){const r=babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](e);if(!t){return Promise.resolve(r)}return this.storeUpdater.update({items:r,onlyAdd:s}).then((()=>r))}function pt(e){const t=[...e].filter((e=>{const[,t]=e;return this.searchConfig.isItemAllowed(t)}));return new Map(t)}function vt(e,t){const s=new Map;e.forEach((e=>{const r=t.get(e.cacheId);if(r&&!r.isOpeLinesType()){s.set(r.getEntityFullId(),r)}}));return s}class bt extends h.RecentMenu{getMenuItems(){return[this.getSendMessageItem(),this.getCallItem(),this.getHistoryItem(),this.getOpenProfileItem()]}}const yt={name:"CarouselUser",components:{Avatar:b.Avatar},props:{item:{type:Object,required:true},selectMode:{type:Boolean,default:false},isSelected:{type:Boolean,required:false}},emits:["clickItem"],data(){return{selected:this.isSelected}},computed:{AvatarSize:()=>b.AvatarSize,searchItem(){return this.item},userId(){return this.searchItem.getId()},user(){return this.$store.getters["users/get"](this.userId,true)},name(){return this.user.firstName?this.user.firstName:this.user.name},isExtranet(){return this.user.extranet},userDialogId(){return this.userId.toString()}},watch:{isSelected(e,t){if(e===true&&t===false){this.selected=true}else if(e===false&&t===true){this.selected=false}}},created(){this.contextMenuManager=new bt},beforeUnmount(){this.contextMenuManager.destroy()},methods:{onClick(e){if(this.selectMode){this.selected=!this.selected}this.$emit("clickItem",{selectedItem:this.searchItem,selectedStatus:this.selected,nativeEvent:e})},onRightClick(e){if(e.altKey&&e.shiftKey){return}const t={dialogId:this.userDialogId};p.EventEmitter.emit(v.EventType.search.openContextMenu,{item:t,nativeEvent:e})}},template:`\n\t\t<div \n\t\t\tclass="bx-im-carousel-user__container bx-im-carousel-user__scope"\n\t\t\t:class="{'--extranet': isExtranet, '--selected': selectMode && selected}"\n\t\t\t@click="onClick" \n\t\t\t@click.right.prevent="onRightClick"\n\t\t>\n\t\t\t<div v-if="selectMode && selected" class="bx-im-carousel-user__selected-mark"></div>\n\t\t\t<Avatar :dialogId="userDialogId" :size="AvatarSize.XL" />\n\t\t\t<div class="bx-im-carousel-user__title" :title="user.name">\n\t\t\t\t{{ name }}\n\t\t\t</div>\n\t\t</div>\n\t`};const gt=6;const ft={name:"RecentUsersCarousel",components:{CarouselUser:yt},props:{items:{type:Object,required:true},selectMode:{type:Boolean,default:false},selectedItems:{type:Array,default:()=>[]}},emits:["clickItem"],computed:{users(){const e=[...this.items.values()];return e.slice(0,gt)}},methods:{isSelected(e){return this.selectedItems.includes(e.getEntityFullId())}},template:`\n\t\t<div class="bx-im-recent-users-carousel__container bx-im-recent-users-carousel__scope">\n\t\t\t<div class="bx-im-recent-users-carousel__title-container">\n\t\t\t\t<span class="bx-im-recent-users-carousel__section-title">\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SEARCH_SECTION_RECENT_CHATS') }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div class="bx-im-recent-users-carousel__users-container">\n\t\t\t\t<CarouselUser \n\t\t\t\t\tv-for="user in users"\n\t\t\t\t\t:key="user.getId()"\n\t\t\t\t\t:item="user"\n\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t:isSelected="isSelected(user)"\n\t\t\t\t\t@clickItem="$emit('clickItem', $event)"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const It={name:"SearchResultSection",components:{ExpandAnimation:m.ExpandAnimation},props:{component:{type:Object,required:true},items:{type:Object,required:true},title:{type:String,default:""},showMoreButton:{type:Boolean,default:true,required:false},minItems:{type:Number,default:10,required:false},maxItems:{type:Number,default:50,required:false},canBeFolded:{type:Boolean,default:true,required:false},selectMode:{type:Boolean,default:false},selectedItems:{type:Array,default:()=>[]}},emits:["clickItem"],data:function(){return{expanded:false,folded:false}},computed:{showMore(){if(!this.showMoreButton){return false}return this.items.size>this.minItems},showMoreButtonText(){return this.expanded?this.$Bitrix.Loc.getMessage("IM_SEARCH_SECTION_TITLE_SHOW_LESS"):this.$Bitrix.Loc.getMessage("IM_SEARCH_SECTION_TITLE_SHOW_MORE")},sectionItems(){const e=[...this.items.values()];if(!this.showMoreButton){return e}return this.expanded?e.slice(0,this.maxItems):e.slice(0,this.minItems)}},methods:{onFoldSection(){if(!this.canBeFolded){return}this.folded=!this.folded},onShowMore(){this.expanded=!this.expanded},isSelected(e){return this.selectedItems.includes(e.getEntityFullId())}},template:`\n\t\t<div class="bx-im-search-result-section__container bx-im-search-result-section__scope">\n\t\t\t<div \n\t\t\t\tv-if="title" \n\t\t\t\tclass="bx-im-search-result-section__title-container" \n\t\t\t\t:class="{'--down': !folded, '--foldable': canBeFolded}"\n\t\t\t\t@click="onFoldSection"\n\t\t\t>\n\t\t\t\t<span \n\t\t\t\t\tclass="bx-im-search-result-section__title-text"\n\t\t\t\t\t:class="{'--icon': canBeFolded}"\n\t\t\t\t>\n\t\t\t\t\t{{title}}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<ExpandAnimation>\n\t\t\t\t<div v-if="!folded" class="bx-im-search-result-section__items-container">\n\t\t\t\t\t<component \n\t\t\t\t\t\t:is="component"\n\t\t\t\t\t\tv-for="item in sectionItems" \n\t\t\t\t\t\t:key="item.getEntityFullId()" \n\t\t\t\t\t\t:item="item" \n\t\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t\t:isSelected="isSelected(item)"\n\t\t\t\t\t\t@clickItem="$emit('clickItem', $event)"\n\t\t\t\t\t/>\n\t\t\t\t\t<button \n\t\t\t\t\t\tv-if="showMore" \n\t\t\t\t\t\tclass="bx-im-search-result-section__show-more" \n\t\t\t\t\t\t@click.prevent="onShowMore"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ showMoreButtonText }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</ExpandAnimation>\n\t\t</div>\n\t`};const St={name:"SearchResultNetworkItem",components:{Loader:b.Loader},inject:["searchService"],props:{item:{type:Object,required:true}},emits:["clickItem"],data:function(){return{isLoading:false}},computed:{searchItem(){return this.item},hasAvatar(){return u.Type.isStringFilled(this.searchItem.getAvatar())},avatarStyles(){if(!this.hasAvatar){return{backgroundSize:"37px",backgroundPosition:"center 8px",backgroundColor:this.searchItem.getAvatarOptions().color}}return{backgroundImage:`url('${this.searchItem.getAvatar()}')`}},title(){return u.Text.decode(this.searchItem.getTitle())}},methods:{onClick(e){this.isLoading=true;const t=this.searchItem.getId();this.searchService.loadNetworkItem(t).then((t=>{const s=y.getFirstItemFromMap(t);this.$emit("clickItem",{selectedItem:s,nativeEvent:e})})).catch((e=>{console.error(e)})).finally((()=>{this.isLoading=false}))}},template:`\n\t\t<div\n\t\t\tclass="bx-im-search-result-network-item__container bx-im-search-result-network-item__scope"\n\t\t\t@click="onClick"\n\t\t>\n\t\t\t<div class="bx-im-search-result-network-item__avatar-container">\n\t\t\t\t<div\n\t\t\t\t\t:title="searchItem.title"\n\t\t\t\t\tclass="bx-im-search-result-network-item__avatar"\n\t\t\t\t\t:style="avatarStyles"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-search-result-network-item__content-container">\n\t\t\t\t<div class="bx-im-search-result-network-item__title-text" :title="title">\n\t\t\t\t\t{{title}}\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-search-result-network-item__item-text" :title="searchItem.getSubtitle()">\n\t\t\t\t\t{{ searchItem.getSubtitle() }}\n\t\t\t\t</div>\n\t\t\t\t<div v-if="isLoading" class="bx-im-search-result-network-item__loader">\n\t\t\t\t\t<Loader />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Lt={name:"SearchResultItem",components:{Avatar:b.Avatar,ChatTitle:b.ChatTitle},inject:["searchService"],props:{item:{type:Object,required:true},selectMode:{type:Boolean,default:false},isSelected:{type:Boolean,required:false}},emits:["clickItem"],data(){return{selected:this.isSelected}},computed:{AvatarSize:()=>b.AvatarSize,searchItem(){return this.item},dialogId(){return this.searchItem.getDialogId()},user(){return this.$store.getters["users/get"](this.dialogId,true)},dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},isChat(){return!this.isUser},isUser(){return this.dialog.type===v.DialogType.user},userItemText(){if(!this.isUser){return""}const e=this.$store.getters["users/getLastOnline"](this.dialogId);if(e){return e}return this.$store.getters["users/getPosition"](this.dialogId)},chatItemText(){if(this.isUser){return""}return this.$Bitrix.Loc.getMessage("IM_SEARCH_ITEM_CHAT_TYPE_GROUP_V2")},itemText(){return this.isUser?this.userItemText:this.chatItemText},selectedStyles(){return{"--selected":this.selectMode&&this.selected}}},watch:{isSelected(e,t){if(e===true&&t===false){this.selected=true}else if(e===false&&t===true){this.selected=false}}},methods:{onClick(e){if(this.selectMode){this.selected=!this.selected}else{this.searchService.addItemToRecent(this.searchItem)}this.$emit("clickItem",{selectedItem:this.searchItem,selectedStatus:this.selected,nativeEvent:e})},onRightClick(e){if(e.altKey&&e.shiftKey){return}const t={dialogId:this.dialogId};p.EventEmitter.emit(v.EventType.search.openContextMenu,{item:t,nativeEvent:e})}},template:`\n\t\t<div \n\t\t\t@click="onClick" \n\t\t\t@click.right.prevent="onRightClick" \n\t\t\tclass="bx-im-search-result-item__container bx-im-search-result-item__scope"\n\t\t\t:class="selectedStyles"\n\t\t>\n\t\t\t<div class="bx-im-search-result-item__avatar-container">\n\t\t\t\t<Avatar :dialogId="dialogId" :size="AvatarSize.XL" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-search-result-item__content-container">\n\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t<div class="bx-im-search-result-item__item-text" :title="itemText">\n\t\t\t\t\t{{ itemText }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="selectMode && selected" class="bx-im-search-result-item__selected"></div>\n\t\t</div>\n\t`};const Ft={name:"SearchResultDepartmentItem",components:{SearchResultItem:Lt,ExpandAnimation:m.ExpandAnimation,Loader:b.Loader},inject:["searchService"],props:{item:{type:Object,required:true},selectMode:{type:Boolean,default:false},isSelected:{type:Boolean,required:false}},emits:["clickItem"],data:function(){return{selected:this.isSelected,expanded:false,isLoading:false,usersInDepartment:[]}},computed:{searchItem(){return this.item},departmentAvatarStyle(){var e;if((e=this.searchItem.avatarOptions)!=null&&e.color){return{backgroundColor:this.searchItem.avatarOptions.color}}return{}},title(){return u.Text.decode(this.searchItem.title)},selectedStyles(){return{"--selected":this.selectMode&&this.selected}}},watch:{isSelected(e,t){if(e===true&&t===false){this.selected=true}else if(e===false&&t===true){this.selected=false}}},methods:{onClick(e){if(!this.expanded){this.openDepartment(e)}else{this.expanded=false}},openDepartment(e){if(this.selectMode){this.selected=!this.selected;this.$emit("clickItem",{selectedItem:this.searchItem,selectedStatus:this.selected,nativeEvent:e})}else{this.isLoading=true;if(u.Type.isArrayFilled(this.usersInDepartment)){this.isLoading=false;this.expanded=true;return}this.searchService.loadDepartmentUsers(this.searchItem).then((e=>{this.usersInDepartment=[...e.values()].filter((e=>e.isUser()));this.isLoading=false;this.expanded=true}))}}},template:`\n\t\t<div \n\t\t\t@click="onClick" \n\t\t\tclass="bx-im-search-result-department-item__container bx-im-search-result-department-item__scope"\n\t\t\t:class="selectedStyles"\n\t\t>\n\t\t\t<div class="bx-im-search-result-department-item__avatar_container">\n\t\t\t\t<div \n\t\t\t\t\t:title="searchItem.title" \n\t\t\t\t\tclass="bx-im-search-result-department-item__avatar"\n\t\t\t\t\t:style="departmentAvatarStyle"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-search-result-department-item__title_container">\n\t\t\t\t<div class="bx-im-search-result-department-item__title_text" :title="title">\n\t\t\t\t\t{{title}}\n\t\t\t\t</div>\n\t\t\t\t<div v-if="!selectMode" class="bx-im-search-result-department-item__expand-button">\n\t\t\t\t\t<div v-if="isLoading" class="bx-im-search-result-department-item__loader">\n\t\t\t\t\t\t<Loader />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-else-if="expanded" class="bx-im-search-result-department-item__arrow --down"></div>\n\t\t\t\t\t<div v-else class="bx-im-search-result-department-item__arrow"></div>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="selectMode && selected" class="bx-im-search-result-department-item__selected"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<ExpandAnimation>\n\t\t\t<div v-if="expanded" class="bx-im-search-result-department-item__users">\n\t\t\t\t<SearchResultItem \n\t\t\t\t\tv-for="user in usersInDepartment" \n\t\t\t\t\t:key="user.getEntityFullId()" \n\t\t\t\t\t:item="user"\n\t\t\t\t\t@clickItem="$emit('clickItem', $event)"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</ExpandAnimation>\n\t`};const Pt={name:"SearchResult",components:{RecentUsersCarousel:ft,SearchResultSection:It,SearchResultNetworkItem:St,SearchResultDepartmentItem:Ft,SearchResultItem:Lt,MessengerButton:b.Button,Loader:b.Loader},props:{searchQuery:{type:String,default:""},searchMode:{type:Boolean,required:true},searchConfig:{type:Object,required:true},selectMode:{type:Boolean,default:false},selectedItems:{type:Array,required:false,default:()=>[]}},data(){return{isRecentLoading:false,isLocalLoading:false,isServerLoading:false,isNetworkLoading:false,currentServerQueries:0,isNetworkButtonClicked:false,result:{recentUsers:new Map,recent:new Map,usersAndChats:new Map,chatUsers:new Map,departments:new Map,openLines:new Map,network:new Map}}},computed:{ButtonSize:()=>b.ButtonSize,ButtonColor:()=>b.ButtonColor,itemComponent:()=>Lt,itemDepartmentComponent:()=>Ft,itemNetworkComponent:()=>St,cleanQuery(){return this.searchQuery.trim().toLowerCase()},isEmptyState(){if(this.isServerLoading||this.isLocalLoading||this.isNetworkLoading){return false}if(this.isNetworkSectionAvailable&&!this.isNetworkButtonClicked&&this.isServerSearch){return false}return this.result.usersAndChats.size===0&&this.result.departments.size===0&&this.result.chatUsers.size===0&&this.result.openLines.size===0&&this.result.network.size===0},isLoadingState(){return this.isServerLoading||this.isRecentLoading},isServerSearch(){return this.cleanQuery.length>=this.minTokenSize},needToShowNetworkSection(){return!this.isNetworkButtonClicked||this.result.network.size>0},showSearchResult(){return this.cleanQuery.length>0},isNetworkSearchCode(){return Boolean(this.cleanQuery.length===32&&/[\da-f]{32}/.test(this.cleanQuery))},isNetworkSectionAvailable(){if(!this.searchService.isNetworkAvailable()){return false}return this.isNetworkSearchEnabled||this.isNetworkSearchCode},recentUsers(){return this.$store.getters["recent/getSortedCollection"]}},watch:{cleanQuery(e,t){if(e===t){return}this.startSearch(e)},searchMode(e,t){if(e===true&&t===false&&this.result.recent.size>0){return}if(e===false&&t===true){this.isNetworkButtonClicked=false;this.searchService.disableNetworkSearch()}this.loadRecentSearchFromServer()},recentUsers(){this.loadRecentUsers()}},created(){this.initSettings();this.contextMenuManager=new bt;this.searchService=new ut(this.searchConfig);r.provide("searchService",this.searchService);this.searchOnServerDelayed=u.Runtime.debounce(this.searchOnServer,1500,this);p.EventEmitter.subscribe(v.EventType.search.openContextMenu,this.onOpenContextMenu);p.EventEmitter.subscribe(v.EventType.dialog.errors.accessDenied,this.onDelete);p.EventEmitter.subscribe(v.EventType.search.keyPressed,this.onPressEnterKey);this.loadInitialRecentResult()},beforeUnmount(){this.searchService.destroy();this.contextMenuManager.destroy();p.EventEmitter.unsubscribe(v.EventType.search.openContextMenu,this.onOpenContextMenu);p.EventEmitter.unsubscribe(v.EventType.dialog.errors.accessDenied,this.onDelete);p.EventEmitter.unsubscribe(v.EventType.search.keyPressed,this.onPressEnterKey)},methods:{loadRecentUsers(){this.searchService.loadRecentUsers().then((e=>{this.result.recentUsers=e}))},loadInitialRecentResult(){this.loadRecentUsers();this.searchService.loadRecentSearchFromCache().then((e=>{if(e.size>0){this.result.recent=e;return}this.loadRecentSearchFromServer()}))},loadRecentSearchFromServer(){this.isRecentLoading=true;this.searchService.loadRecentSearchFromServer().then((e=>{this.result.recent=e;this.isRecentLoading=false}))},initSettings(){const e=u.Extension.getSettings("im.v2.component.search.search-result");const t=3;this.minTokenSize=e.get("minTokenSize",t);this.isNetworkSearchEnabled=e.get("isNetworkSearchEnabled",true)},startSearch(e){if(e.length>0&&e.length<this.minTokenSize){this.isLocalLoading=true;const t=e;this.searchService.searchLocal(e).then((e=>{if(t!==this.cleanQuery){return}this.result.usersAndChats=e;this.isLocalLoading=false}))}else if(e.length>=this.minTokenSize){this.isServerLoading=true;const t=e;this.searchService.searchLocal(e).then((e=>{if(t!==this.cleanQuery){this.isServerLoading=false;return}this.result.usersAndChats=e})).then((()=>this.searchOnServerDelayed(e)))}else{this.cleanSearchResult()}},cleanSearchResult(){this.result.usersAndChats=new Map;this.result.departments=new Map;this.result.chatUsers=new Map;this.result.network=new Map;this.result.openLines=new Map},searchOnServer(e){this.currentServerQueries++;this.isNetworkLoading=this.isNetworkButtonClicked;const t=e;this.searchService.searchOnServer(e).then((e=>{if(t!==this.cleanQuery){this.stopLoader();return}this.result.usersAndChats=this.mergeResults(this.result.usersAndChats,e.usersAndChats);this.result.departments=e.departments;this.result.chatUsers=e.chatUsers;this.result.openLines=e.openLines;this.result.network=e.network})).catch((e=>{console.error(e)})).finally((()=>{this.currentServerQueries--;this.stopLoader()}))},stopLoader(){if(this.currentServerQueries>0){return}this.isNetworkLoading=false;this.isServerLoading=false},mergeResults(e,t){const s=new Map(e.entries());t.forEach(((e,t)=>{if(!s.has(t)){s.set(t,e)}}));return s},onOpenContextMenu(e){const{item:t,nativeEvent:s}=e.getData();if(a.Utils.key.isAltOrOption(s)){return}this.contextMenuManager.openMenu(t,s.currentTarget)},onDelete({data:e}){const{dialogId:t}=e;this.result.recent.delete(t);this.result.usersAndChats.delete(t);this.result.chatUsers.delete(t)},onScroll(e){this.$emit("scroll",e);this.contextMenuManager.destroy()},onClickLoadNetworkResult(){this.isNetworkLoading=true;const e=this.cleanQuery;this.searchService.searchOnNetwork(e).then((t=>{this.isNetworkLoading=false;if(e!==this.cleanQuery){return}this.result.network=t;this.isNetworkButtonClicked=true}))},onClickItem(e){if(!this.searchMode){return}const{selectedItem:t,nativeEvent:s}=e;if(this.selectMode){this.$emit("selectItem",e)}else{i.Messenger.openChat(t.getDialogId())}if(!a.Utils.key.isAltOrOption(s)){p.EventEmitter.emit(v.EventType.search.close)}},onPressEnterKey(e){if(this.selectMode){return}const{keyboardEvent:t}=e.getData();if(!a.Utils.key.isCombination(t,"Enter")){return}const s=this.getFirstItemFromSearchResults();if(!s){return}this.onClickItem({selectedItem:s,nativeEvent:t})},getFirstItemFromSearchResults(){if(!this.showSearchResult&&this.result.recent.size>0){return y.getFirstItemFromMap(this.result.recent)}if(this.result.usersAndChats.size>0){return y.getFirstItemFromMap(this.result.usersAndChats)}if(this.result.chatUsers.size>0){return y.getFirstItemFromMap(this.result.chatUsers)}if(this.result.openLines.size>0){return y.getFirstItemFromMap(this.result.openLines)}return null}},template:`\n\t\t<div class="bx-im-search-result__container bx-im-search-result__scope" @scroll="onScroll">\n\t\t\t<template v-if="!showSearchResult">\n\t\t\t\t<RecentUsersCarousel \n\t\t\t\t\t:items="result.recentUsers"\n\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t/>\n\t\t\t\t<SearchResultSection\n\t\t\t\t\t:component="itemComponent"\n\t\t\t\t\t:items="result.recent"\n\t\t\t\t\t:showMoreButton="false"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_RECENT')"\n\t\t\t\t\t:canBeFolded="false"\n\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<SearchResultSection\n\t\t\t\t\tv-if="result.usersAndChats.size > 0"\n\t\t\t\t\t:component="itemComponent"\n\t\t\t\t\t:items="result.usersAndChats"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_USERS_AND_CHATS')"\n\t\t\t\t\t:min-items:="20"\n\t\t\t\t\t:max-items="50"\n\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t/>\n\t\t\t\t<template v-if="!isLoadingState && isServerSearch">\n\t\t\t\t\t<SearchResultSection\n\t\t\t\t\t\tv-if="result.chatUsers.size > 0"\n\t\t\t\t\t\t:component="itemComponent"\n\t\t\t\t\t\t:items="result.chatUsers"\n\t\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_CHAT_USERS')"\n\t\t\t\t\t\t:min-items:="5"\n\t\t\t\t\t\t:max-items="20"\n\t\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t\t/>\n\t\t\t\t\t<SearchResultSection\n\t\t\t\t\t\tv-if="result.departments.size > 0"\n\t\t\t\t\t\t:component="itemDepartmentComponent"\n\t\t\t\t\t\t:items="result.departments"\n\t\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_DEPARTMENTS')"\n\t\t\t\t\t\t:min-items:="5"\n\t\t\t\t\t\t:max-items="20"\n\t\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t\t/>\n\t\t\t\t\t<template v-if="isNetworkSectionAvailable">\n\t\t\t\t\t\t<SearchResultSection\n\t\t\t\t\t\t\tv-if="needToShowNetworkSection"\n\t\t\t\t\t\t\t:component="itemNetworkComponent"\n\t\t\t\t\t\t\t:items="result.network"\n\t\t\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_NETWORK')"\n\t\t\t\t\t\t\t:canBeFolded="isNetworkButtonClicked"\n\t\t\t\t\t\t\t:min-items:="5"\n\t\t\t\t\t\t\t:max-items="20"\n\t\t\t\t\t\t\t:selectMode="selectMode"\n\t\t\t\t\t\t\t:selectedItems="selectedItems"\n\t\t\t\t\t\t\t@clickItem="onClickItem"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class="bx-im-search-result__network-button-container">\n\t\t\t\t\t\t\t<MessengerButton\n\t\t\t\t\t\t\t\tv-if="!isNetworkButtonClicked"\n\t\t\t\t\t\t\t\t:text="$Bitrix.Loc.getMessage('IM_SEARCH_SECTION_NETWORK_BUTTON')"\n\t\t\t\t\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t\t\t\t\t:size="ButtonSize.L"\n\t\t\t\t\t\t\t\t:isLoading="isNetworkLoading"\n\t\t\t\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t\t\t\t@click="onClickLoadNetworkResult"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t</template>\n\t\t\t\t<div v-if="isEmptyState" class="bx-im-search-result__empty-state-container">\n\t\t\t\t\t<div class="bx-im-search-result__empty-state-icon"></div>\n\t\t\t\t\t<div class="bx-im-search-result__empty-state-title">\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SEARCH_RESULT_NOT_FOUND') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-search-result__empty-state-subtitle">\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SEARCH_RESULT_NOT_FOUND_DESCRIPTION') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<div v-if="isLoadingState" class="bx-im-search-result__loader-container">\n\t\t\t\t<Loader />\n\t\t\t</div>\n\t\t</div>\n\t`};e.SearchResult=Pt})(this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{},BX,BX,BX.Vue3,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Dexie3,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Component.Animation,BX.Event,BX.Messenger.v2.Const,BX.Messenger.v2.Component.Elements);
//# sourceMappingURL=search-result.bundle.map.js