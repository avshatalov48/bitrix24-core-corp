this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(t,e,s,r,i,a,n,o){"use strict";const c={name:"CarouselUser",components:{Avatar:e.Avatar},props:{user:{type:Object,required:true}},computed:{name(){return this.user.dialog.name.split(" ")[0]},AvatarSize:()=>r.AvatarSize},methods:{onClick(){i.EventEmitter.emit(r.EventType.dialog.open,{dialogId:this.user.dialogId})}},template:`\n\t\t<div class="bx-messenger-carousel-item" @click="onClick">\n\t\t\t<Avatar :dialogId="user.dialogId" :size="AvatarSize.L" />\n\t\t\t<div class="bx-messenger-carousel-item-title">{{name}}</div>\n\t\t</div>\n\t`};const l=5;const d={name:"RecentUsersCarousel",components:{CarouselUser:c},props:{title:{type:String,required:true}},computed:{users(){const t=[];this.$store.state.recent.collection.forEach((e=>{const s=this.$store.getters["dialogues/get"](e.dialogId,true);const r=this.$store.getters["users/get"](e.dialogId,true);t.push({...e,dialog:s,user:r})}));return t.filter((t=>t.dialog.type==="user"&&!t.user.bot)).slice(0,l)}},template:`\n\t\t<div class="bx-messenger-recent-users-carousel-title">{{title}}</div>\n\t\t<div class="bx-messenger-recent-users-carousel">\n\t\t\t<div class="bx-messenger-recent-users-carousel-inner">\n\t\t\t\t<CarouselUser v-for="user in users" :key="user.dialogId" :user="user" />\n\t\t\t</div>\n\t\t</div>\n\t`};const h={name:"SearchResultItem",components:{Avatar:e.Avatar,ChatTitle:e.ChatTitle},props:{dialogId:{type:String,required:true},child:{type:Boolean,default:false,required:false}},computed:{user(){return this.$store.getters["users/get"](this.dialogId,true)},dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},isChat(){return!this.isUser},isUser(){return this.dialog.type===r.ChatTypes.user},userOnlineStatus(){return this.$store.getters["users/getLastOnline"](this.dialogId)},workPosition(){return this.$store.getters["users/getPosition"](this.dialogId)},AvatarSize:()=>r.AvatarSize},methods:{onClick(){console.warn("onClick",this.dialog);i.EventEmitter.emit(r.EventType.dialog.open,{dialogId:this.dialogId});i.EventEmitter.emit(r.EventType.search.selectItem,this.dialogId)},onRightClick(){console.warn("onRightClick")}},template:`\n\t\t<div @click="onClick" @click.right.prevent="onRightClick" class="bx-im-search-item" :class="[this.child ? 'bx-im-search-sub-item' : '']">\n\t\t\t<div class="bx-im-search-avatar-wrap">\n\t\t\t\t<Avatar :dialogId="dialogId" :size="AvatarSize.L" />\n\t\t\t</div>\n\t\t\t<div v-if="isUser" class="bx-im-search-result-item-content">\n\t\t\t\t<div class="bx-im-search-result-item-content-header">\n\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-recent-item-content-bottom">\n\t\t\t\t\t<div class="bx-im-search-result-item-text-wrap">\n\t\t\t\t\t\t<div class="bx-im-search-result-item-message-text">{{ workPosition }}</div>\n\t\t\t\t\t\t<div class="bx-im-search-result-item-message-text">{{ userOnlineStatus }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-search-result-item-title-content">\n\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t</div>\n\t\t</div>\n\t`};const m=Object.freeze({user:"user",bot:"im-bot",chat:"im-chat",department:"department"});class u{constructor(){this.db=new a.Dexie("bx-im-search-results");this.db.version(1).stores({items:"id, title, name, lastName, secondName, position, date",recentItems:"++id"})}loadRecentFromCache(){const t={};return this.db.transaction("r",this.db.items,this.db.recentItems,(()=>this.db.recentItems.orderBy("id").toArray())).then((e=>{t.recentItems=e.map((t=>t.json));const s=[];t.recentItems.forEach((t=>{const e=`${t[1]}${t[0]}`;s.push(this.db.items.get({id:e}))}));return a.Dexie.Promise.all(s)})).then((e=>{t.items=e.filter((t=>!o.Type.isUndefined(t))).map((t=>t.json));return t}))}saveToCache(t){let e=[];if(t.items){e=t.items.filter((t=>t.entityId!==m.department)).map((t=>{var e,s,r,i;return{id:`${t.id}${t.entityId}`,name:(e=t.customData)!=null&&e.name?t.customData.name:"",lastName:(s=t.customData)!=null&&s.lastName?t.customData.lastName:"",secondName:(r=t.customData)!=null&&r.secondName?t.customData.secondName:"",position:(i=t.customData)!=null&&i.position?t.customData.position:"",title:t.title?t.title:"",json:t,date:new Date}}))}let s=[];if(t.recentItems){s=t.recentItems.map((t=>({json:t,date:new Date})))}this.db.transaction("rw",this.db.items,this.db.recentItems,(()=>{if(e.length>0){this.db.items.bulkPut(e)}if(s.length>0){this.db.recentItems.clear().then((()=>{this.db.recentItems.bulkPut(s)}))}}))}unshiftItem(t){this.db.transaction("rw",this.db.recentItems,(()=>this.db.recentItems.toArray())).then((e=>{const s=e.map((t=>t.json));const r=s.findIndex((e=>e[1]===t[1]&&e[0]===t[0]));if(r===0){return}if(r!==-1){const t=s.splice(r,1);s.unshift(t[0])}else{s.unshift(t)}this.saveToCache({recentItems:s})}))}search(t){return this.db.transaction("r",this.db.items,function*(){const e=yield this.getQueryResultByWords(t);if(!o.Type.isArrayFilled(e)){return[]}const s=this.intersectArrays(...e);const r=[...new Set(s.flat())];return yield this.db.items.where(":id").anyOf(r).toArray()}.bind(this)).then((t=>t.map((t=>t.json))))}getQueryResultByWords(t){return a.Dexie.Promise.all(t.map((t=>this.db.items.where("name").startsWithIgnoreCase(t).or("lastName").startsWithIgnoreCase(t).or("position").startsWithIgnoreCase(t).or("secondName").startsWithIgnoreCase(t).or("title").startsWithIgnoreCase(t).primaryKeys())))}intersectArrays(t,e,...s){if(o.Type.isUndefined(e)){return t}const r=t.filter((t=>e.includes(t)));if(s.length===0){return r}return this.intersectArrays(r,...s)}}const p={dialog:{entities:[{id:"im-bot",options:{searchableBotTypes:["H","B","S","N"]},dynamicLoad:true,dynamicSearch:true},{id:"im-chat",options:{searchableChatTypes:["C","O"]},dynamicLoad:true,dynamicSearch:true},{id:"user",dynamicLoad:true,dynamicSearch:true,filters:[{id:"im.userDataFilter"}]},{id:"department",dynamicLoad:true,dynamicSearch:true,options:{selectMode:"usersAndDepartments",allowSelectRootDepartment:true}}],preselectedItems:[],clearUnavailableItems:false,context:"IM_CHAT_SEARCH"}};class v{constructor(t){this.store=null;this.cacheService=null;s.Logger.enable("log");s.Logger.enable("warn");this.store=t.Data.get("controller").store;this.cacheService=new u;this.onItemSelectHandler=this.onItemSelect.bind(this);i.EventEmitter.subscribe(r.EventType.search.selectItem,this.onItemSelectHandler)}getJsonConfig(){return p}onItemSelect(t){const e=t.getData();const s=this.dialogIdToRecentItem(e);this.cacheService.unshiftItem(s);this.addItemsToRecentSearchResults([{id:s[1],entityId:s[0]}])}loadDepartmentUsers(t){return new Promise(((e,r)=>{o.ajax.runAction("ui.entityselector.getChildren",{json:{...this.getJsonConfig(),parentItem:t}}).then((t=>{s.Logger.warn(`Im.Search: load department users result`,t);this.cacheService.saveToCache(t.data.dialog);e(t.data.dialog.items)})).catch((t=>r(t)))}))}loadRecentSearch(){return this.cacheService.loadRecentFromCache().then((t=>{if(t.recentItems.length===0){return this.requestRecentSearch().then((t=>this.updateModels(t.items).then((()=>this.convertRecentItemsToDialogIds(t.recentItems)))))}this.updateModels(t.items).then((()=>{this.requestRecentSearch()}));return this.convertRecentItemsToDialogIds(t.recentItems)}))}searchInCache(t){let e=Promise.resolve([]);if(this.store.state.application.common.languageId==="ru"&&BX.correctText){const s=this.splitQueryByWords(BX.correctText(t.trim()));e=this.getDialogIdsByQueryWords(s)}const s=this.splitQueryByWords(t.trim());const r=this.getDialogIdsByQueryWords(s);return Promise.all([r,e]).then((t=>[...new Set([...t[0],...t[1]])]))}getDialogIdsByQueryWords(t){return this.cacheService.search(t).then((t=>this.updateModels(t).then((()=>this.convertItemsToDialogIds(t)))))}requestRecentSearch(){return o.ajax.runAction("ui.entityselector.load",{json:this.getJsonConfig()}).then((t=>{s.Logger.warn(`Im.Search: Recent search request result`,t);this.cacheService.saveToCache(t.data.dialog);return t.data.dialog}))}searchOnServer(t){return this.searchRequest(t).then((t=>this.updateModels(t,true).then((()=>({items:this.convertItemsToDialogIds(t),departments:t.filter((t=>t.entityId===m.department))})))))}searchRequest(t){const e=this.getJsonConfig();const r=this.splitQueryByWords(t);e.searchQuery={queryWords:r,query:t,dynamicSearchEntities:[]};return new Promise(((t,r)=>{o.ajax.runAction("ui.entityselector.doSearch",{json:e}).then((e=>{s.Logger.warn(`Im.Search: Search request result`,e);this.cacheService.saveToCache(e.data.dialog);t(e.data.dialog.items)})).catch((t=>r(t)))}))}addItemsToRecentSearchResults(t){if(!o.Type.isArrayFilled(t)){return}return o.ajax.runAction("ui.entityselector.saveRecentItems",{json:{...this.getJsonConfig(),recentItems:t}})}updateModels(t,e=false){const{users:s,dialogues:r}=this.prepareDataForModels(t);const i=e?"users/set":"users/add";const a=e?"dialogues/set":"dialogues/add";const n=this.store.dispatch(i,s);const o=this.store.dispatch(a,r);return Promise.all([n,o])}prepareDataForModels(t){const e={users:[],dialogues:[]};t.forEach((t=>{if(!t.customData){return}if(t.customData.imUser&&t.customData.imUser.ID>0){const s=this.toLowerCaseKeys(t.customData.imUser);e.users.push(s);e.dialogues.push({avatar:s.avatar,color:s.color,name:s.name,type:r.ChatTypes.user,dialogId:t.id})}if(t.customData.imChat&&t.customData.imChat.ID>0){if(t.entityType==="LINES"){return}const s=this.toLowerCaseKeys(t.customData.imChat);e.dialogues.push({...s,dialogId:`chat${s.id}`})}}));return e}splitQueryByWords(t){const e=t.replace("("," ").replace(")"," ").replace("["," ").replace("]"," ").replace("{"," ").replace("}"," ").replace("<"," ").replace(">"," ").replace("-"," ").replace("#"," ").replace('"'," ").replace("'"," ").replace("/ss+/"," ");return e.toLowerCase().split(" ").filter((t=>t!==""))}toLowerCaseKeys(t){const e={};Object.keys(t).forEach((s=>{e[s.toLowerCase()]=t[s]}));return e}convertRecentItemsToDialogIds(t){const e=[];t.forEach((t=>{if(t[0]===m.chat){e.push(`chat${t[1]}`)}else if(t[0]===m.user||t[0]===m.bot){e.push(t[1].toString())}}));return e}convertItemsToDialogIds(t){const e=[];t.forEach((t=>{if(t.entityType==="LINES"){return}if(t.customData&&t.customData.imChat&&t.customData.imChat.ID>0){e.push(`chat${t.customData.imChat.ID}`)}else if(t.customData&&t.customData.imUser&&t.customData.imUser.ID>0){e.push(t.customData.imUser.ID.toString())}}));return e}dialogIdToRecentItem(t){return t.startsWith("chat")?[m.chat,Number.parseInt(t.replace("chat",""),10)]:[m.user,Number.parseInt(t,10)]}}const g={name:"SearchResultDepartmentItem",components:{SearchResultItem:h},props:{item:{type:Object,required:true}},data:function(){return{expanded:false,isLoading:false,usersInDepartment:[]}},computed:{usersDialogIds(){return this.searchService.convertItemsToDialogIds(this.usersInDepartment)}},created(){this.searchService=new v(this.$Bitrix)},methods:{onClick(){if(!this.expanded){this.openDepartment()}else{this.closeDepartment()}},openDepartment(){this.isLoading=true;if(o.Type.isArrayFilled(this.usersInDepartment)){this.isLoading=false;this.expanded=true;return}this.searchService.loadDepartmentUsers(this.item).then((t=>{this.usersInDepartment=t;this.isLoading=false;this.expanded=true}))},closeDepartment(){this.expanded=false}},template:`\n\t\t<div @click="onClick" class="bx-im-search-item">\n\t\t\t<div class="bx-im-search-avatar-wrap">\n\t\t\t\t<div :title="item.title" class="bx-im-component-avatar-wrap bx-im-component-avatar-size-l">\n\t\t\t\t\t<div class="bx-im-component-avatar-content bx-im-component-avatar-image bx-search-item-department-icon"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-search-result-item-title-content bx-im-component-chat-name-text">\n\t\t\t\t{{item.title}}\n\t\t\t\t<div class="bx-search-item-department-expand-button">\n\t\t\t\t\t<div v-if="isLoading" class="bx-search-item-department-expand-loader"></div>\n\t\t\t\t\t<div v-else-if="expanded" class="bx-search-item-department-down-arrow"></div>\n\t\t\t\t\t<div v-else class="bx-search-item-department-up-arrow"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<template v-if="expanded">\n\t\t\t<SearchResultItem v-for="dialogId in usersDialogIds" :key="dialogId" :dialogId="dialogId" :child="true" />\n\t\t</template>\n\t`};const I={name:"SearchResultSection",components:{SearchResultItem:h,SearchResultDepartmentItem:g},props:{items:{type:Array,required:true},hasChildren:{type:Boolean,default:false,required:false},title:{type:String,required:true},showMore:{type:Boolean,default:false,required:false}},computed:{phrases(){return n.BitrixVue.getFilteredPhrases(this,"IM_SEARCH_")}},template:`\n\t\t<div class="bx-messenger-search-result-section-wrapper">\n\t\t\t<div class="bx-messenger-search-result-section-title">\n\t\t\t\t<div>{{title}}</div>\n\t\t\t\t<div v-if="showMore" class="bx-messenger-search-result-section-show-more">\n\t\t\t\t\t{{phrases['IM_SEARCH_SECTION_TITLE_SHOW_MORE']}}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<template v-if="!hasChildren">\n\t\t\t\t<SearchResultItem v-for="item in items" :key="item" :dialogId="item" />\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<SearchResultDepartmentItem v-for="item in items" :key="item" :item="item" />\n\t\t\t</template>\n\t\t</div>\n\t`};const S={name:"LoadingState",data:function(){return{itemsToShow:50}},template:`\n\t\t<div class="bx-im-recent-loading-state">\n\t\t\t<div v-for="index in itemsToShow" class="bx-im-recent-item">\n\t\t\t\t<div class="bx-im-recent-avatar-wrap">\n\t\t\t\t\t<div class="bx-im-recent-avatar-image-wrap">\n\t\t\t\t\t\t<div class="bx-im-recent-avatar bx-im-recent-placeholder-avatar"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-recent-item-content">\n\t\t\t\t\t<div class="bx-im-recent-item-content-header">\n\t\t\t\t\t\t<div class="bx-im-recent-item-placeholder-title"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-recent-item-content-bottom">\n\t\t\t\t\t\t<div class="bx-im-recent-message-text-wrap">\n\t\t\t\t\t\t\t<div class="bx-im-recent-item-placeholder-subtitle"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const y={components:{RecentUsersCarousel:d,SearchResultSection:I,LoadingState:S},props:{searchQuery:{type:String,required:true}},data:function(){return{minTokenSize:3,isLoading:false,result:{recent:[],usersAndChats:[],departments:[]}}},computed:{showSearchResult(){return this.searchQuery.length>0},phrases(){return n.BitrixVue.getFilteredPhrases(this,"IM_SEARCH_")}},watch:{searchQuery(t){if(t.length>0&&t.length<this.minTokenSize){this.searchInLocal(t)}else if(t.length>=this.minTokenSize){this.isLoading=true;this.searchInLocal(t);this.searchOnServerDelayed(t)}else{this.cleanSearchResult()}}},mounted(){this.isLoading=true;this.searchService.loadRecentSearch().then((t=>{this.result.recent=t;this.isLoading=false}))},created(){this.minTokenSize=o.Extension.getSettings("im.v2.component.search").get("minTokenSize");this.searchService=new v(this.$Bitrix);this.searchOnServerDelayed=o.Runtime.debounce(this.searchOnServer,1500,this)},methods:{cleanSearchResult(){this.result.usersAndChats=[];this.result.departments=[]},searchOnServer(t){this.searchService.searchOnServer(t).then((t=>{t.items.forEach((t=>{const e=this.result.usersAndChats.includes(t);if(!e){this.result.usersAndChats.push(t)}}));this.result.departments=t.departments;this.isLoading=false}))},searchInLocal(t){this.searchService.searchInCache(t).then((t=>{this.result.usersAndChats=t}))}},template:`\n\t\t<div class="bx-messenger-search">\n\t\t\t<div>\n\t\t\t\t<template v-if="!showSearchResult">\n\t\t\t\t\t<RecentUsersCarousel :title="phrases['IM_SEARCH_SECTION_EMPLOYEES']"/>\n\t\t\t\t</template>\n\t\t\t\t<template v-if="!showSearchResult">\n\t\t\t\t\t<SearchResultSection :items="result.recent" :title="phrases['IM_SEARCH_SECTION_RECENT']"/>\n\t\t\t\t</template>\n\t\t\t\t<template v-if="showSearchResult">\n\t\t\t\t\t<SearchResultSection \n\t\t\t\t\t\tv-if="result.usersAndChats.length > 0" \n\t\t\t\t\t\t:items="result.usersAndChats" \n\t\t\t\t\t\t:title="phrases['IM_SEARCH_SECTION_USERS_AND_CHATS']"\n\t\t\t\t\t/>\n\t\t\t\t\t<template v-if="!isLoading && searchQuery.length >= 3">\n\t\t\t\t\t\t<SearchResultSection \n\t\t\t\t\t\t\tv-if="result.departments.length > 0" \n\t\t\t\t\t\t\t:items="result.departments" \n\t\t\t\t\t\t\t:title="phrases['IM_SEARCH_SECTION_DEPARTMENTS']" \n\t\t\t\t\t\t\t:showMore="result.departments.length > 5"\n\t\t\t\t\t\t\t:hasChildren="true"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</template>\n\t\t\t\t</template>\n\t\t\t\t<loading-state v-if="isLoading" />\n\t\t\t</div>\n\t\t</div>\n\t`};t.Search=y})(this.BX.Messenger.v2=this.BX.Messenger.v2||{},BX.Messenger.v2,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Event,BX,BX.Vue3,BX);
//# sourceMappingURL=search.bundle.map.js