{"version":3,"file":"chat-dialog.bundle.js","sources":["../src/classes/scroll-manager.js","../src/classes/collection-manager.js","../src/classes/quote-manager.js","../src/classes/message-menu.js","../src/classes/avatar-menu.js","../src/classes/observer-manager.js","../src/components/block/new-messages.js","../src/components/block/marked-messages.js","../src/components/block/date-group.js","../src/components/pinned/pinned-message.js","../src/components/pinned/pinned-messages.js","../src/classes/user-servlce.js","../src/components/additional-users.js","../src/components/dialog-status.js","../src/components/dialog-loader.js","../src/chat-dialog.js"],"sourcesContent":["import {EventEmitter} from 'main.core.events';\n\nimport {Logger} from 'im.v2.lib.logger';\nimport {Animation} from 'im.v2.lib.animation';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ScrollManager';\nconst SCROLLING_THRESHOLD = 1500;\nconst POSITION_THRESHOLD = 40;\nconst SCROLLED_UP_THRESHOLD = 400;\n\nexport class ScrollManager extends EventEmitter\n{\n\tcontainer: HTMLElement;\n\tisScrolling: boolean = false;\n\tcurrentScroll: number = 0;\n\tlastScroll: number = 0;\n\tchatIsScrolledUp: boolean = false;\n\tscrollButtonClicked: boolean = false;\n\n\tstatic events = {\n\t\tonScrollTriggerUp: 'onScrollTriggerUp',\n\t\tonScrollTriggerDown: 'onScrollTriggerDown',\n\t\tonScrollThresholdPass: 'onScrollThresholdPass'\n\t};\n\n\tconstructor(): ScrollManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\t}\n\n\tsetContainer(container: HTMLElement)\n\t{\n\t\tthis.container = container;\n\t}\n\n\tonScroll(event: Event)\n\t{\n\t\t// if (this.isScrolling || !event.target || this.currentScroll === event.target.scrollTop)\n\t\tif (this.isScrolling || !event.target)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.currentScroll = event.target.scrollTop;\n\t\tconst isScrollingDown = this.lastScroll < this.currentScroll;\n\t\tconst isScrollingUp = !isScrollingDown;\n\t\tif (isScrollingUp)\n\t\t{\n\t\t\tthis.scrollButtonClicked = false;\n\t\t}\n\n\t\tconst leftSpaceBottom = event.target.scrollHeight - event.target.scrollTop - event.target.clientHeight;\n\t\tif (isScrollingDown && this.lastScroll > 0 && leftSpaceBottom < SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerDown);\n\t\t}\n\t\telse if (isScrollingUp && this.currentScroll <= SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerUp);\n\t\t}\n\n\t\tthis.lastScroll = this.currentScroll;\n\n\t\tthis.checkIfChatIsScrolledUp();\n\t}\n\n\tcheckIfChatIsScrolledUp()\n\t{\n\t\tconst availableScrollHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newFlag = this.currentScroll + SCROLLED_UP_THRESHOLD < availableScrollHeight;\n\t\tif (newFlag !== this.chatIsScrolledUp)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollThresholdPass, newFlag);\n\t\t}\n\t\tthis.chatIsScrolledUp = newFlag;\n\t}\n\n\tscrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to bottom');\n\t\tthis.forceScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tanimatedScrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to bottom');\n\t\tthis.animatedScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tscrollToMessage(messageId: number, offset: number = -10)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\tthis.forceScrollTo(position);\n\t}\n\n\tanimatedScrollToMessage(messageId: number, offset: number = -10): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\treturn this.animatedScrollTo(position);\n\t}\n\n\tforceScrollTo(position: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Force scroll to - ', position);\n\t\tthis.cancelAnimatedScroll();\n\t\tthis.container.scroll({top: position, behavior: 'instant'});\n\t}\n\n\tadjustScrollOnHistoryAddition(oldContainerHeight: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Adjusting scroll after history addition');\n\t\tconst newContainerHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newScrollPosition = this.container.scrollTop + newContainerHeight - oldContainerHeight;\n\t\tthis.forceScrollTo(newScrollPosition);\n\t}\n\n\tanimatedScrollTo(position: number): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Animated scroll to - ', position);\n\t\treturn new Promise((resolve) => {\n\t\t\tAnimation.start({\n\t\t\t\tstart: this.container.scrollTop,\n\t\t\t\tend: position,\n\t\t\t\telement: this.container,\n\t\t\t\telementProperty: 'scrollTop',\n\t\t\t\tcallback: () => {\n\t\t\t\t\tthis.checkIfChatIsScrolledUp();\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tcancelAnimatedScroll()\n\t{\n\t\tif (!this.isScrolling)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tAnimation.cancel();\n\t\tthis.isScrolling = false;\n\t}\n\n\tisAtTheTop(): boolean\n\t{\n\t\treturn this.container.scrollTop === 0;\n\t}\n\n\tisAtTheBottom(): boolean\n\t{\n\t\treturn this.container.scrollTop + this.container.clientHeight >= this.container.scrollHeight;\n\t}\n\n\tisAroundBottom(): boolean\n\t{\n\t\treturn this.container.scrollHeight - this.container.scrollTop - this.container.clientHeight < POSITION_THRESHOLD;\n\t}\n\n\tgetDomElementById(id: number | string): ?HTMLElement\n\t{\n\t\treturn this.container.querySelector(`[data-id=\"${id}\"]`);\n\t}\n}","import {Core} from 'im.v2.application.core';\nimport {DialogBlockType as BlockType, MessageType, MessageComponent} from 'im.v2.const';\nimport {DateFormatter, DateTemplate} from 'im.v2.lib.date-formatter';\n\nimport type {ImModelMessage, ImModelDialog} from 'im.v2.model';\n\nexport type FormattedCollectionItem = {\n\ttype: BlockType.dateGroup,\n\tdate: {\n\t\tid: string,\n\t\ttitle: string\n\t},\n\titems: Array<AuthorGroupItem | NewMessagesItem>\n};\n\ntype AuthorGroupItem = {\n\ttype: BlockType.authorGroup,\n\tuserId: number,\n\tmessageType: MessageType.opponent | MessageType.self | MessageType.system,\n\tavatar: {\n\t\tisNeeded: boolean,\n\t\tavatarId: string\n\t},\n\titems: ImModelMessage[]\n};\n\ntype NewMessagesItem = {\n\ttype: BlockType.newMessages\n};\n\nexport class CollectionManager\n{\n\tstore: Object;\n\tdialogId: number;\n\tfirstIteration: boolean = true;\n\tinitialLastReadMessage: boolean;\n\tinitialMarkedId: boolean;\n\tcachedDateGroups: {\n\t\tid: number,\n\t\ttitle: string\n\t} = {};\n\n\tconstructor(dialogId)\n\t{\n\t\tthis.store = Core.getStore();\n\t\tthis.dialogId = dialogId;\n\t}\n\n\tformatMessageCollection(messageCollection: ImModelMessage[]): FormattedCollectionItem[]\n\t{\n\t\tconst dateGroups = {};\n\t\tconst collection = [];\n\t\tlet lastDateItems = null;\n\t\tlet lastAuthorId = null;\n\t\tlet lastAuthorItems = null;\n\n\t\tconst dialog: ImModelDialog = this.store.getters['dialogues/get'](this.dialogId);\n\t\tconst {markedId, inited} = dialog;\n\t\tlet markInserted = false;\n\t\tconst lastReadId = this.store.getters['dialogues/getLastReadId'](this.dialogId);\n\n\t\tif (this.firstIteration)\n\t\t{\n\t\t\tthis.initialLastReadMessage = lastReadId;\n\t\t\tthis.initialMarkedId = markedId;\n\t\t}\n\n\t\tif (markedId !== this.initialMarkedId && markedId !== 0)\n\t\t{\n\t\t\tthis.initialMarkedId = markedId;\n\t\t\tthis.initialLastReadMessage = null;\n\t\t}\n\n\t\tmessageCollection.forEach((message: ImModelMessage, index) => {\n\t\t\tconst dateGroup = this.getDateGroup(message.date);\n\t\t\t// new date = new date group + new author group\n\t\t\tif (!dateGroups[dateGroup.title])\n\t\t\t{\n\t\t\t\tdateGroups[dateGroup.title] = dateGroup.id;\n\t\t\t\tlastDateItems = [];\n\t\t\t\tcollection.push({\n\t\t\t\t\ttype: BlockType.dateGroup,\n\t\t\t\t\tdate: dateGroup,\n\t\t\t\t\titems: lastDateItems\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t}\n\n\t\t\t// marked messages\n\t\t\tif (message.id === this.initialMarkedId)\n\t\t\t{\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.markedMessages\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t\tmarkInserted = true;\n\t\t\t}\n\n\t\t\t// new author = new author group\n\t\t\tif (message.authorId !== lastAuthorId)\n\t\t\t{\n\t\t\t\tlastAuthorId = message.authorId;\n\t\t\t\tlastAuthorItems = [];\n\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.authorGroup,\n\t\t\t\t\tuserId: message.authorId,\n\t\t\t\t\tavatar: this.getAvatarConfig(message),\n\t\t\t\t\tmessageType: this.getMessageType(message),\n\t\t\t\t\titems: lastAuthorItems\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// add current message to last active author group\n\t\t\tlastAuthorItems.push(message);\n\n\t\t\t// new messages block\n\t\t\tconst isLastMessage = index === messageCollection.length - 1;\n\t\t\tif (!markInserted && !isLastMessage && message.id === this.initialLastReadMessage)\n\t\t\t{\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.newMessages\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t}\n\t\t});\n\n\t\tif (inited)\n\t\t{\n\t\t\tthis.firstIteration = false;\n\t\t}\n\n\n\t\treturn collection;\n\t}\n\n\tgetDateGroup(date: Date): {id: number, title: string}\n\t{\n\t\tconst INDEX_BETWEEN_DATE_AND_TIME = 10;\n\t\t// 2022-10-25T14:58:44.000Z => 2022-10-25\n\t\tconst shortDate = date.toJSON().slice(0, INDEX_BETWEEN_DATE_AND_TIME);\n\t\tif (this.cachedDateGroups[shortDate])\n\t\t{\n\t\t\treturn this.cachedDateGroups[shortDate];\n\t\t}\n\n\t\tthis.cachedDateGroups[shortDate] = {\n\t\t\tid: shortDate,\n\t\t\ttitle: DateFormatter.formatByTemplate(date, DateTemplate.dateGroup)\n\t\t};\n\n\t\treturn this.cachedDateGroups[shortDate];\n\t}\n\n\tgetAvatarConfig(message: ImModelMessage): {isNeeded: boolean, avatarId: string}\n\t{\n\t\tconst messageType = this.getMessageType(message);\n\t\tlet avatarId = message.authorId.toString();\n\t\t// if (messageType === MessageType.system)\n\t\t// {\n\t\t// \t// show avatar of current chat\n\t\t// \tavatarId = `chat${message.chatId}`;\n\t\t// }\n\n\t\tlet isNeeded = true;\n\t\tif (\n\t\t\tmessageType === MessageType.self\n\t\t\t|| messageType === MessageType.system\n\t\t\t|| message.componentId !== MessageComponent.base\n\t\t)\n\t\t{\n\t\t\tisNeeded = false;\n\t\t}\n\n\t\treturn {\n\t\t\tisNeeded,\n\t\t\tavatarId\n\t\t};\n\t}\n\n\tgetMessageType(message: ImModelMessage): string\n\t{\n\t\tif (!message.authorId)\n\t\t{\n\t\t\treturn MessageType.system;\n\t\t}\n\t\telse if (message.authorId === Core.getUserId())\n\t\t{\n\t\t\treturn MessageType.self;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn MessageType.opponent;\n\t\t}\n\t}\n}","import {Loc} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\nimport {Core} from 'im.v2.application.core';\nimport {EventType, DialogType} from 'im.v2.const';\nimport {DateFormatter, DateTemplate} from 'im.v2.lib.date-formatter';\nimport {Parser} from 'im.v2.lib.parser';\n\nimport type {ImModelMessage, ImModelUser, ImModelDialog} from 'im.v2.model';\n\nconst QUOTE_DELIMITER = '-'.repeat(54);\n\nexport const QuoteManager = {\n\tsendQuoteEvent(message: ImModelMessage)\n\t{\n\t\tEventEmitter.emit(EventType.textarea.insertText, {\n\t\t\ttext: this.prepareQuoteText(message),\n\t\t\twithNewLine: true\n\t\t});\n\t},\n\tprepareQuoteText(message: ImModelMessage): string\n\t{\n\t\tlet quoteTitle = Loc.getMessage('IM_DIALOG_CHAT_QUOTE_DEFAULT_TITLE');\n\t\tif (message.authorId)\n\t\t{\n\t\t\tconst user: ImModelUser = Core.getStore().getters['users/get'](message.authorId);\n\t\t\tquoteTitle = user.name;\n\t\t}\n\n\t\tconst quoteDate = DateFormatter.formatByTemplate(message.date, DateTemplate.notification);\n\t\tconst quoteText = Parser.prepareQuote(message);\n\n\t\tlet quoteContext = '';\n\t\tconst dialog: ImModelDialog = Core.getStore().getters['dialogues/getByChatId'](message.chatId);\n\t\tif (dialog && dialog.type === DialogType.user)\n\t\t{\n\t\t\tquoteContext = `#${dialog.dialogId}:${Core.getUserId()}/${message.id}`;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tquoteContext = `#${dialog.dialogId}/${message.id}`;\n\t\t}\n\n\t\treturn `${QUOTE_DELIMITER}\\n`\n\t\t\t+ `${quoteTitle} [${quoteDate}] ${quoteContext}\\n`\n\t\t\t+ `${quoteText}\\n`\n\t\t\t+ `${QUOTE_DELIMITER}\\n`\n\t\t;\n\t}\n};","import {Loc} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\nimport {Core} from 'im.v2.application.core';\nimport {BaseMenu} from 'im.v2.lib.menu';\nimport {Parser} from 'im.v2.lib.parser';\nimport {EntityCreator} from 'im.v2.lib.entity-creator';\nimport {ChatService, MessageService} from 'im.v2.provider.service';\nimport {EventType, PlacementType} from 'im.v2.const';\nimport {MarketManager} from 'im.v2.lib.market';\n\nimport {QuoteManager} from './quote-manager';\n\nimport 'ui.notification';\n\nimport type {MenuItem} from 'im.v2.lib.menu';\nimport type {ImModelMessage, ImModelDialog} from 'im.v2.model';\n\nexport class MessageMenu extends BaseMenu\n{\n\tcontext: ImModelMessage & {dialogId: string};\n\tchatService: ChatService;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis.id = 'bx-im-message-context-menu';\n\t\tthis.chatService = new ChatService();\n\t\tthis.marketManager = MarketManager.getInstance();\n\t}\n\n\tgetMenuOptions(): Object\n\t{\n\t\treturn {\n\t\t\t...super.getMenuOptions(),\n\t\t\tclassName: this.getMenuClassName(),\n\t\t\tangle: true,\n\t\t\toffsetLeft: 11\n\t\t};\n\t}\n\n\tgetMenuItems(): MenuItem[]\n\t{\n\t\treturn [\n\t\t\tthis.getQuoteItem(),\n\t\t\tthis.getCopyItem(),\n\t\t\tthis.getQuoteBlockDelimiter(),\n\n\t\t\tthis.getPinItem(),\n\t\t\tthis.getFavoriteItem(),\n\t\t\tthis.getMarkItem(),\n\t\t\tthis.getPinBlockDelimiter(),\n\n\t\t\tthis.getCreateItem(),\n\t\t\tthis.getCreateBlockDelimiter(),\n\n\t\t\tthis.getEditItem(),\n\t\t\tthis.getEditBlockDelimiter(),\n\n\t\t\tthis.getDeleteItem()\n\t\t];\n\t}\n\n\tgetQuoteItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_QUOTE'),\n\t\t\tonclick: () => {\n\t\t\t\tQuoteManager.sendQuoteEvent(this.context);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetCopyItem(): ?MenuItem\n\t{\n\t\tif (this.context.files.length === 0)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_COPY_FILE'),\n\t\t\tonclick: () => {\n\t\t\t\tconst textToCopy = Parser.prepareCopy(this.context);\n\t\t\t\tif (BX.clipboard?.copy(textToCopy))\n\t\t\t\t{\n\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage('IM_DIALOG_CHAT_MENU_COPY_FILE_SUCCESS')\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetQuoteBlockDelimiter(): MenuItem\n\t{\n\t\treturn this.#getDelimiter();\n\t}\n\n\tgetPinItem(): MenuItem\n\t{\n\t\tconst isPinned = this.store.getters['messages/pin/isPinned']({\n\t\t\tchatId: this.context.chatId,\n\t\t\tmessageId: this.context.id\n\t\t});\n\n\t\treturn {\n\t\t\ttext: isPinned? Loc.getMessage('IM_DIALOG_CHAT_MENU_UNPIN') : Loc.getMessage('IM_DIALOG_CHAT_MENU_PIN'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({chatId: this.context.chatId});\n\t\t\t\tif (isPinned)\n\t\t\t\t{\n\t\t\t\t\tmessageService.unpinMessage(this.context.chatId, this.context.id);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmessageService.pinMessage(this.context.chatId, this.context.id);\n\t\t\t\t}\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetFavoriteItem(): MenuItem\n\t{\n\t\tconst isInFavorite = this.store.getters['sidebar/favorites/isFavoriteMessage'](this.context.chatId, this.context.id);\n\n\t\treturn {\n\t\t\ttext: isInFavorite? Loc.getMessage('IM_DIALOG_CHAT_MENU_REMOVE_FROM_SAVED') : Loc.getMessage('IM_DIALOG_CHAT_MENU_SAVE'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({chatId: this.context.chatId});\n\t\t\t\tif (isInFavorite)\n\t\t\t\t{\n\t\t\t\t\tmessageService.removeMessageFromFavorite(this.context.id);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmessageService.addMessageToFavorite(this.context.id);\n\t\t\t\t}\n\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetMarkItem(): ?MenuItem\n\t{\n\t\tconst canUnread = this.context.viewed && !this.#isOwnMessage();\n\n\t\tconst dialog: ImModelDialog = this.store.getters['dialogues/getByChatId'](this.context.chatId);\n\t\tconst isMarked = this.context.id === dialog.markedId;\n\t\tif (!canUnread || isMarked)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_MARK'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({chatId: this.context.chatId});\n\t\t\t\tmessageService.markMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetPinBlockDelimiter(): ?MenuItem\n\t{\n\t\treturn this.#getDelimiter();\n\t}\n\n\tgetCreateItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE'),\n\t\t\titems: [\n\t\t\t\tthis.getCreateTaskItem(),\n\t\t\t\tthis.getCreateMeetingItem(),\n\t\t\t\t...this.getMarketItems()\n\t\t\t]\n\t\t};\n\t}\n\n\tgetCreateTaskItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE_TASK'),\n\t\t\tonclick: () => {\n\t\t\t\tconst entityCreator = new EntityCreator(this.context.chatId);\n\t\t\t\tentityCreator.createTaskForMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetCreateMeetingItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE_MEETING'),\n\t\t\tonclick: () => {\n\t\t\t\tconst entityCreator = new EntityCreator(this.context.chatId);\n\t\t\t\tentityCreator.createMeetingForMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetCreateBlockDelimiter(): ?MenuItem\n\t{\n\t\tif (!this.getEditItem() && !this.getDeleteItem())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn this.#getDelimiter();\n\t}\n\n\tgetEditItem(): ?MenuItem\n\t{\n\t\tif (!this.#isOwnMessage() || this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_EDIT'),\n\t\t\tonclick: () => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.editMessage, {\n\t\t\t\t\tmessageId: this.context.id\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetEditBlockDelimiter(): ?MenuItem\n\t{\n\t\tif (!this.getEditItem())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn this.#getDelimiter();\n\t}\n\n\tgetDeleteItem(): ?MenuItem\n\t{\n\t\tif (!this.#isOwnMessage() || this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_DELETE'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({chatId: this.context.chatId});\n\t\t\t\tmessageService.deleteMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetMarketItems(): MenuItem[]\n\t{\n\t\tconst {dialogId, id} = this.context;\n\t\tconst placements = this.marketManager.getAvailablePlacementsByType(PlacementType.contextMenu, dialogId);\n\t\tconst marketMenuItem = [];\n\t\tif (placements.length > 0)\n\t\t{\n\t\t\tmarketMenuItem.push(this.#getDelimiter());\n\t\t}\n\n\t\tconst context = {messageId: id, dialogId: dialogId};\n\n\t\tplacements.forEach(placement => {\n\t\t\tmarketMenuItem.push({\n\t\t\t\ttext: placement.title,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tMarketManager.openSlider(placement, context);\n\t\t\t\t\tthis.menuInstance.close();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t// (10 items + 1 delimiter), because we don't want to show long context menu.\n\t\tconst itemLimit = 11;\n\n\t\treturn marketMenuItem.slice(0, itemLimit);\n\t}\n\n\t#getDelimiter(): MenuItem\n\t{\n\t\treturn {\n\t\t\tdelimiter: true\n\t\t};\n\t}\n\n\t#isOwnMessage(): boolean\n\t{\n\t\treturn this.context.authorId === Core.getUserId();\n\t}\n\n\t#isDeletedMessage(): boolean\n\t{\n\t\treturn this.context.isDeleted;\n\t}\n}","import {Loc} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\nimport {Messenger} from 'im.public';\nimport {Core} from 'im.v2.application.core';\nimport {BaseMenu} from 'im.v2.lib.menu';\nimport {DialogType, EventType} from 'im.v2.const';\nimport {Utils} from 'im.v2.lib.utils';\nimport {ChatService} from 'im.v2.provider.service';\n\nimport type {ImModelUser, ImModelDialog} from 'im.v2.model';\nimport type {MenuItem} from 'im.v2.lib.menu';\n\ntype AvatarMenuContext = {\n\tuser: ImModelUser,\n\tdialog: ImModelDialog\n};\n\nexport class AvatarMenu extends BaseMenu\n{\n\tcontext: AvatarMenuContext;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis.id = 'bx-im-avatar-context-menu';\n\t}\n\n\tgetMenuOptions(): Object\n\t{\n\t\treturn {\n\t\t\t...super.getMenuOptions(),\n\t\t\tclassName: this.getMenuClassName(),\n\t\t\tangle: true,\n\t\t\toffsetLeft: 21\n\t\t};\n\t}\n\n\tgetMenuItems(): MenuItem[]\n\t{\n\t\treturn [\n\t\t\tthis.getMentionItem(),\n\t\t\tthis.getSendItem(),\n\t\t\tthis.getProfileItem(),\n\t\t\tthis.getKickItem()\n\t\t];\n\t}\n\n\tgetMentionItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_MENTION'),\n\t\t\tonclick: () => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.insertMention, {\n\t\t\t\t\tmentionText: this.context.user.name,\n\t\t\t\t\tmentionReplacement: Utils.user.getMentionBbCode(this.context.user.id, this.context.user.name)\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetSendItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_SEND_MESSAGE'),\n\t\t\tonclick: () => {\n\t\t\t\tMessenger.openChat(this.context.user.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetProfileItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_OPEN_PROFILE'),\n\t\t\thref: Utils.user.getProfileLink(this.context.user.id),\n\t\t\tonclick: () => {\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n\n\tgetKickItem(): ?MenuItem\n\t{\n\t\tconst isOwner = Core.getUserId() === this.context.dialog.owner;\n\t\tconst isUser = this.context.dialog.type === DialogType.user;\n\t\tif (!isOwner || isUser)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_KICK'),\n\t\t\tonclick: () => {\n\t\t\t\tconst chatService = new ChatService();\n\t\t\t\tchatService.kickUserFromChat(this.context.dialog.dialogId, this.context.user.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}\n\t\t};\n\t}\n}","import 'main.polyfill.intersectionobserver';\nimport {EventEmitter} from 'main.core.events';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ObserverManager';\n\nexport class ObserverManager extends EventEmitter\n{\n\t#observer: IntersectionObserver;\n\t#observedElements: {[messageId: string]: HTMLElement} = {};\n\t#visibleMessages: Set = new Set();\n\t#messagesToRead: Set = new Set();\n\t#dialogInited: boolean = false;\n\n\tstatic events = {\n\t\tonMessageIsVisible: 'onMessageIsVisible'\n\t};\n\n\tconstructor(): ObserverManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tthis.#initObserver();\n\t}\n\n\tsetDialogInited(flag: boolean)\n\t{\n\t\tObject.values(this.#observedElements).forEach(element => {\n\t\t\tthis.unobserveMessage(element);\n\t\t\tthis.observeMessage(element);\n\t\t});\n\n\t\tthis.#dialogInited = flag;\n\t}\n\n\tobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.observe(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tthis.#observedElements[messageElement.dataset.id] = messageElement;\n\t\t}\n\t}\n\n\tunobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.unobserve(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tdelete this.#observedElements[messageElement.dataset.id];\n\t\t}\n\t}\n\n\tonReadMessage(messageId: number)\n\t{\n\t\tthis.#messagesToRead.delete(messageId);\n\t}\n\n\tgetMessagesToRead(): number[]\n\t{\n\t\treturn [...this.#messagesToRead];\n\t}\n\n\tgetFirstVisibleMessage(): number\n\t{\n\t\tif (this.#visibleMessages.size === 0)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst [firstVisibleMessage] = [...this.#visibleMessages].sort((a, b) => a - b);\n\n\t\treturn firstVisibleMessage;\n\t}\n\n\t#initObserver()\n\t{\n\t\tthis.#observer = new IntersectionObserver(((entries: IntersectionObserverEntry[]) => {\n\t\t\tentries.forEach((entry: IntersectionObserverEntry) => {\n\t\t\t\tconst messageId = this.#getMessageIdFromElement(entry.target);\n\t\t\t\tif (!messageId || !entry.rootBounds || !this.#dialogInited)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messageIsFullyVisible = entry.isIntersecting && entry.intersectionRatio >= 0.99;\n\t\t\t\tconst messageTakesHalfOfViewport = entry.intersectionRect.height >= entry.rootBounds.height / 2.2;\n\t\t\t\t// const messageIsBiggerThanViewport = entry.boundingClientRect.height + 20 > entry.rootBounds.height;\n\t\t\t\t// const messageCountsAsVisible = messageIsBiggerThanViewport && messageTakesMostOfViewport;\n\t\t\t\tif (messageIsFullyVisible || messageTakesHalfOfViewport)\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.add(messageId);\n\t\t\t\t\tif (!this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.add(messageId);\n\t\t\t\t\t\tthis.emit(ObserverManager.events.onMessageIsVisible);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.delete(messageId);\n\t\t\t\t\tif (this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.delete(messageId);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}), {threshold: Array.from({length: 101}).fill(0).map((zero, index) => index * 0.01)});\n\t}\n\n\t#getMessageIdFromElement(messageElement: HTMLElement): number\n\t{\n\t\treturn +messageElement.dataset.id;\n\t}\n\n\t#messageIsViewed(messageElement: HTMLElement): boolean\n\t{\n\t\treturn messageElement.dataset['viewed'] === 'true';\n\t}\n}","// @vue/component\nexport const NewMessagesBlock = {\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__new-message-block\">\n\t\t\t<div class=\"bx-im-dialog-chat__new-message-block_text\">{{ loc('IM_DIALOG_CHAT_BLOCK_NEW_MESSAGES_2') }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const MarkedMessagesBlock = {\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__new-message-block\">\n\t\t\t<div class=\"bx-im-dialog-chat__new-message-block_text\">{{ loc('IM_DIALOG_CHAT_BLOCK_MARKED_MESSAGES') }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const DateGroupTitle = {\n\tprops:\n\t{\n\t\ttitle: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__date-group_title_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__date-group_title\">{{ title }}</div>\n\t\t</div>\n\t`\n};","import {Parser} from 'im.v2.lib.parser';\n\nimport type {ImModelUser, ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessage = {\n\tprops:\n\t{\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tinternalMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.message;\n\t\t},\n\t\ttext(): string\n\t\t{\n\t\t\treturn Parser.purifyMessage(this.internalMessage);\n\t\t},\n\t\tauthorId(): number\n\t\t{\n\t\t\treturn this.internalMessage.authorId;\n\t\t},\n\t\tauthor(): ImModelUser\n\t\t{\n\t\t\treturn this.$store.getters['users/get'](this.authorId);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__pinned_item\">\n\t\t\t<span v-if=\"author\" class=\"bx-im-dialog-chat__pinned_item_user\">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`\n};","import {PinnedMessage} from './pinned-message';\n\nimport '../../css/pinned-messages.css';\n\nimport type {ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessages = {\n\tcomponents: {PinnedMessage},\n\tprops:\n\t{\n\t\tmessages: {\n\t\t\ttype: Array,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['messageClick', 'messageUnpin'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tfirstMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.messagesToShow[0];\n\t\t},\n\t\tmessagesToShow(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.messages.slice(-1);\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div @click=\"$emit('messageClick', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__pinned_title\">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for=\"message in messagesToShow\"\n\t\t\t\t:message=\"message\"\n\t\t\t\t:key=\"message.id\"\n\t\t\t\t@click=\"$emit('messageClick', message.id)\"\n\t\t\t/>\n\t\t\t<div @click.stop=\"$emit('messageUnpin', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_unpin\"></div>\n\t\t</div>\n\t`\n};","import {Core} from 'im.v2.application.core';\nimport {RestMethod} from 'im.v2.const';\nimport {UserManager} from 'im.v2.lib.user';\nimport {Logger} from 'im.v2.lib.logger';\n\nimport type {Store} from 'ui.vue3.vuex';\nimport type {RestClient} from 'rest.client';\n\nexport class UserService\n{\n\t#store: Store;\n\t#restClient: RestClient;\n\t#userManager: UserManager;\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#userManager = new UserManager();\n\t}\n\n\tloadReadUsers(messageId): Promise<number[]>\n\t{\n\t\tlet users = [];\n\t\tLogger.warn('Dialog: UserService: loadReadUsers', messageId);\n\t\treturn this.#restClient.callMethod(RestMethod.imV2ChatMessageTailViewers, {id: messageId})\n\t\t\t.then(response => {\n\t\t\t\tusers = response.data().users;\n\t\t\t\treturn this.#userManager.setUsersToModel(Object.values(users));\n\t\t\t})\n\t\t\t.then(() => {\n\t\t\t\treturn users.map(user => user.id);\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tconsole.error('Dialog: UserService: loadReadUsers error', error);\n\t\t\t\tthrow new Error(error);\n\t\t\t});\n\t}\n}","import {Core} from 'im.v2.application.core';\nimport {UserListPopup} from 'im.v2.component.elements';\n\nimport {UserService} from '../classes/user-servlce';\n\nimport type {ImModelDialog} from 'im.v2.model';\n\n// @vue/component\nexport const AdditionalUsers = {\n\tcomponents: {UserListPopup},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t},\n\t\tshow: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t},\n\t\tbindElement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['close'],\n\tdata()\n\t{\n\t\treturn {\n\t\t\tshowPopup: false,\n\t\t\tloadingAdditionalUsers: false,\n\t\t\tadditionalUsers: []\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t},\n\twatch:\n\t{\n\t\tshow(newValue, oldValue)\n\t\t{\n\t\t\tif (!oldValue && newValue)\n\t\t\t{\n\t\t\t\tthis.showPopup = true;\n\t\t\t\tthis.loadUsers();\n\t\t\t}\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloadUsers()\n\t\t{\n\t\t\tthis.loadingAdditionalUsers = true;\n\t\t\tthis.getUserService().loadReadUsers(this.dialog.lastMessageId)\n\t\t\t\t.then(userIds => {\n\t\t\t\t\tthis.additionalUsers = this.prepareAdditionalUsers(userIds);\n\t\t\t\t\tthis.loadingAdditionalUsers = false;\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tthis.loadingAdditionalUsers = false;\n\t\t\t\t});\n\t\t},\n\t\tonPopupClose()\n\t\t{\n\t\t\tthis.showPopup = false;\n\t\t\tthis.$emit('close');\n\t\t},\n\t\tprepareAdditionalUsers(userIds: number[]): number[]\n\t\t{\n\t\t\tconst firstViewerId = this.dialog.lastMessageViews.firstViewer.userId;\n\n\t\t\treturn userIds.filter(userId => {\n\t\t\t\treturn userId !== Core.getUserId() && userId !== firstViewerId;\n\t\t\t});\n\t\t},\n\t\tgetUserService(): UserService\n\t\t{\n\t\t\tif (!this.userService)\n\t\t\t{\n\t\t\t\tthis.userService = new UserService();\n\t\t\t}\n\n\t\t\treturn this.userService;\n\t\t},\n\t},\n\ttemplate: `\n\t\t<UserListPopup\n\t\t\tid=\"bx-im-dialog-read-users\"\n\t\t\t:showPopup=\"showPopup\"\n\t\t\t:loading=\"loadingAdditionalUsers\"\n\t\t\t:userIds=\"additionalUsers\"\n\t\t\t:bindElement=\"bindElement || {}\"\n\t\t\t:withAngle=\"false\"\n\t\t\t:forceTop=\"true\"\n\t\t\t@close=\"onPopupClose\"\n\t\t/>\n\t`\n};","import {Text} from 'main.core';\n\nimport {DialogType} from 'im.v2.const';\nimport {DateFormatter, DateTemplate} from 'im.v2.lib.date-formatter';\n\nimport {AdditionalUsers} from './additional-users';\n\nimport '../css/dialog-status.css';\n\nimport type {ImModelDialog} from 'im.v2.model';\n\nconst TYPING_USERS_COUNT = 3;\nconst MORE_USERS_CSS_CLASS = 'bx-im-dialog-chat-status__user-count';\n\n// @vue/component\nexport const DialogStatus = {\n\tcomponents: {AdditionalUsers},\n\tprops: {\n\t\tdialogId: {\n\t\t\trequired: true,\n\t\t\ttype: String\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tshowAdditionalUsers: false,\n\t\t\tadditionalUsersLinkElement: null\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t\tisUser(): boolean\n\t\t{\n\t\t\treturn this.dialog.type === DialogType.user;\n\t\t},\n\t\tisChat(): boolean\n\t\t{\n\t\t\treturn !this.isUser;\n\t\t},\n\t\ttypingStatus(): string\n\t\t{\n\t\t\tif (!this.dialog.inited || this.dialog.writingList.length === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tconst firstTypingUsers = this.dialog.writingList.slice(0, TYPING_USERS_COUNT);\n\t\t\tconst text = firstTypingUsers.map(element => element.userName).join(', ');\n\n\t\t\tconst remainingUsersCount = this.dialog.writingList.length - TYPING_USERS_COUNT;\n\t\t\tif (remainingUsersCount > 0)\n\t\t\t{\n\t\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_TYPING_PLURAL', {\n\t\t\t\t\t'#USER#': text,\n\t\t\t\t\t'#COUNT#': remainingUsersCount\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_TYPING', {'#USER#': text});\n\t\t},\n\t\treadStatus(): string\n\t\t{\n\t\t\tif (!this.dialog.inited)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.lastMessageViews.countOfViewers === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.isUser)\n\t\t\t{\n\t\t\t\treturn this.formatUserViewStatus();\n\t\t\t}\n\n\t\t\treturn this.formatChatViewStatus();\n\t\t},\n\t\tlastMessageViews()\n\t\t{\n\t\t\treturn this.dialog.lastMessageViews;\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tformatUserViewStatus(): string\n\t\t{\n\t\t\tconst {date} = this.lastMessageViews.firstViewer;\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_USER', {\n\t\t\t\t'#DATE#': DateFormatter.formatByTemplate(date, DateTemplate.messageReadStatus)\n\t\t\t});\n\t\t},\n\t\tformatChatViewStatus(): string\n\t\t{\n\t\t\tconst {countOfViewers, firstViewer} = this.lastMessageViews;\n\t\t\tif (countOfViewers === 1)\n\t\t\t{\n\t\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_CHAT', {\n\t\t\t\t\t'#USER#': firstViewer.userName\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_CHAT_PLURAL', {\n\t\t\t\t'#USERS#': Text.encode(firstViewer.userName),\n\t\t\t\t'#LINK_START#': `<span class=\"${MORE_USERS_CSS_CLASS}\" ref=\"moreUsersLink\">`,\n\t\t\t\t'#COUNT#': countOfViewers - 1,\n\t\t\t\t'#LINK_END#': '</span>'\n\t\t\t});\n\t\t},\n\t\tonClick(event: PointerEvent)\n\t\t{\n\t\t\tif (!event.target.matches(`.${MORE_USERS_CSS_CLASS}`))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.onMoreUsersClick();\n\t\t},\n\t\tonMoreUsersClick()\n\t\t{\n\t\t\tthis.additionalUsersLinkElement = document.querySelector(`.${MORE_USERS_CSS_CLASS}`);\n\t\t\tthis.showAdditionalUsers = true;\n\t\t},\n\t\tloc(phraseCode: string, replacements: {[string]: string} = {}): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode, replacements);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div @click=\"onClick\" class=\"bx-im-dialog-chat-status__container\">\n\t\t\t<div v-if=\"typingStatus\" class=\"bx-im-dialog-chat-status__content\">\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__icon --typing\"></div>\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__text\">{{ typingStatus }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if=\"readStatus\" class=\"bx-im-dialog-chat-status__content\">\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__icon --read\"></div>\n\t\t\t\t<div v-html=\"readStatus\" class=\"bx-im-dialog-chat-status__text\"></div>\n\t\t\t</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t:show=\"showAdditionalUsers\"\n\t\t\t\t:bindElement=\"additionalUsersLinkElement || {}\"\n\t\t\t\t@close=\"showAdditionalUsers = false\"\n\t\t\t/>\n\t\t</div>\n\t`\n};","import '../css/dialog-loader.css';\n\n// @vue/component\nexport const DialogLoader = {\n\tname: 'DialogLoader',\n\tprops:\n\t{\n\t\tfullHeight: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true\n\t\t},\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-loader__container\" :class=\"{'--full-height': fullHeight}\">\n\t\t\t<div class=\"bx-im-dialog-loader__spinner\"></div>\n\t\t\t<div class=\"bx-im-dialog-loader__text\">{{ loc('IM_DIALOG_CHAT_LOADER_TEXT') }}</div>\n\t\t</div>\n\t`\n};","import {Runtime, Event, Dom} from 'main.core';\nimport {BaseEvent, EventEmitter} from 'main.core.events';\nimport {PopupManager} from 'main.popup';\n\nimport {Core} from 'im.v2.application.core';\nimport {BaseMessage} from 'im.v2.component.message.base';\nimport {ChatCreationMessage} from 'im.v2.component.message.chat-creation';\nimport {Avatar, AvatarSize, ChatInfoPopup} from 'im.v2.component.elements';\nimport {Logger} from 'im.v2.lib.logger';\nimport {CallManager} from 'im.v2.lib.call';\nimport {Utils} from 'im.v2.lib.utils';\nimport {MessageService, ChatService} from 'im.v2.provider.service';\nimport {DialogBlockType as BlockType, EventType, PopupType, DialogScrollThreshold} from 'im.v2.const';\n\nimport {ScrollManager} from './classes/scroll-manager';\nimport {CollectionManager} from './classes/collection-manager';\nimport {MessageMenu} from './classes/message-menu';\nimport {AvatarMenu} from './classes/avatar-menu';\nimport {ObserverManager} from './classes/observer-manager';\nimport {QuoteManager} from './classes/quote-manager';\nimport {NewMessagesBlock} from './components/block/new-messages';\nimport {MarkedMessagesBlock} from './components/block/marked-messages';\nimport {DateGroupTitle} from './components/block/date-group';\nimport {PinnedMessages} from './components/pinned/pinned-messages';\nimport {DialogStatus} from './components/dialog-status';\nimport {DialogLoader} from './components/dialog-loader';\nimport './css/chat-dialog.css';\n\nimport type {ImModelMessage, ImModelDialog, ImModelLayout} from 'im.v2.model';\nimport type {ScrollToBottomEvent} from 'im.v2.const';\nimport type {FormattedCollectionItem} from './classes/collection-manager';\n\nconst FLOATING_DATE_OFFSET = 52;\nconst LOAD_MESSAGE_ON_EXIT_DELAY = 200;\n\n// @vue/component\nexport const ChatDialog = {\n\tname: 'ChatDialog',\n\tcomponents: {\n\t\tAvatar,\n\t\tBaseMessage,\n\t\tChatCreationMessage,\n\t\tPinnedMessages,\n\t\tNewMessagesBlock,\n\t\tMarkedMessagesBlock,\n\t\tDateGroupTitle,\n\t\tChatInfoPopup,\n\t\tDialogStatus,\n\t\tDialogLoader\n\t},\n\tdirectives: {\n\t\t'message-observer': {\n\t\t\tmounted(element, binding)\n\t\t\t{\n\t\t\t\tbinding.instance.observerManager.observeMessage(element);\n\t\t\t},\n\t\t\tbeforeUnmount(element, binding)\n\t\t\t{\n\t\t\t\tbinding.instance.observerManager.unobserveMessage(element);\n\t\t\t}\n\t\t}\n\t},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: ''\n\t\t},\n\t\ttextareaHeight: {\n\t\t\ttype: Number,\n\t\t\tdefault: 0\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tmessageMenuIsActiveForId: 0,\n\t\t\tchatInfoPopup: {\n\t\t\t\telement: null,\n\t\t\t\tdialogId: 0,\n\t\t\t\tshow: false\n\t\t\t},\n\t\t\tcontextMode: {\n\t\t\t\tactive: false,\n\t\t\t\tmessageIsLoaded: false\n\t\t\t},\n\t\t\tinitialScrollCompleted: false,\n\t\t\tisScrolledUp: false,\n\t\t\twindowFocused: false\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tBlockType: () => BlockType,\n\t\tAvatarSize: () => AvatarSize,\n\t\tlayout(): ImModelLayout\n\t\t{\n\t\t\treturn this.$store.getters['application/getLayout'];\n\t\t},\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t\tdialogInited(): boolean\n\t\t{\n\t\t\treturn this.dialog.inited;\n\t\t},\n\t\tformattedCollection(): FormattedCollectionItem[]\n\t\t{\n\t\t\tif (!this.dialogInited && this.messageCollection.length === 0)\n\t\t\t{\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\treturn this.getCollectionManager().formatMessageCollection(this.messageCollection);\n\t\t},\n\t\tmessageCollection(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/get'](this.dialog.chatId);\n\t\t},\n\t\tpinnedMessages(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/pin/getPinned'](this.dialog.chatId);\n\t\t},\n\t\tisOpened(): boolean\n\t\t{\n\t\t\tconst openedDialogId = this.$store.getters['application/getLayout'].entityId;\n\n\t\t\treturn this.dialogId === openedDialogId;\n\t\t},\n\t\tdebouncedScrollHandler(): Function\n\t\t{\n\t\t\tconst SCROLLING_DEBOUNCE_DELAY = 200;\n\n\t\t\treturn Runtime.debounce(this.getScrollManager().onScroll, SCROLLING_DEBOUNCE_DELAY, this.getScrollManager());\n\t\t},\n\t\tdebouncedReadHandler(): Function\n\t\t{\n\t\t\treturn Runtime.debounce(this.readVisibleMessages, 50, this);\n\t\t},\n\t\tformattedCounter(): string\n\t\t{\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.dialog.counter > 99)\n\t\t\t{\n\t\t\t\treturn '99+';\n\t\t\t}\n\n\t\t\treturn `${this.dialog.counter}`;\n\t\t},\n\t\tshowDialogStatus(): boolean\n\t\t{\n\t\t\treturn this.messageCollection.some((message) => {\n\t\t\t\treturn message.id === this.dialog.lastMessageId;\n\t\t\t});\n\t\t}\n\t},\n\twatch:\n\t{\n\t\tdialogInited(newValue, oldValue)\n\t\t{\n\t\t\tif (!newValue || oldValue)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t// first opening\n\t\t\tthis.onChatInited();\n\t\t},\n\t\ttextareaHeight()\n\t\t{\n\t\t\tif (this.isScrolledUp || !this.dialogInited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t});\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tLogger.warn('Dialog: Chat created', this.dialogId);\n\t\tthis.getCollectionManager();\n\n\t\tthis.initContextMenu();\n\t\tthis.initObserverManager();\n\n\t\tthis.initContextMode();\n\t},\n\tmounted()\n\t{\n\t\tthis.getScrollManager().setContainer(this.getContainer());\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\t// second+ opening\n\t\t\tthis.onChatInited();\n\t\t}\n\t\t// there are P&P messages\n\t\telse if (!this.dialogInited && this.messageCollection.length > 0)\n\t\t{\n\t\t\tthis.scrollOnStart();\n\t\t}\n\n\t\tthis.windowFocused = document.hasFocus();\n\n\t\tthis.subscribeToEvents();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.closeMessageMenu();\n\t\tthis.unsubscribeFromEvents();\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\tthis.saveScrollPosition();\n\t\t\tthis.loadMessagesOnExit();\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\treadVisibleMessages()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.windowFocused || this.hasVisibleCall())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getObserverManager().getMessagesToRead().forEach(messageId => {\n\t\t\t\tthis.getChatService().readMessage(this.dialog.chatId, messageId);\n\t\t\t\tthis.getObserverManager().onReadMessage(messageId);\n\t\t\t});\n\t\t},\n\t\tscrollOnStart()\n\t\t{\n\t\t\tthis.$nextTick(() => {\n\t\t\t\t// we loaded chat with context\n\t\t\t\tif (this.contextMode.active && this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.layout.contextId, -FLOATING_DATE_OFFSET);\n\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\tthis.highlightMessage(this.layout.contextId);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// chat was loaded before\n\t\t\t\telse if (this.contextMode.active && !this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tthis.goToMessageContext(this.layout.contextId);\n\t\t\t\t}\n\t\t\t\t// marked message\n\t\t\t\telse if (this.dialog.markedId)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// saved position\n\t\t\t\telse if (this.dialog.savedPositionMessageId)\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: saved scroll position, scrolling to', this.dialog.savedPositionMessageId);\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId);\n\t\t\t\t}\n\t\t\t\t// unread message\n\t\t\t\telse if (this.$store.getters['dialogues/getLastReadId'](this.dialogId))\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// new chat with unread messages\n\t\t\t\telse if (this.$store.getters['messages/getFirstUnread'](this.dialog.chatId))\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: new chat with unread messages, dont scroll');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tgoToMessageContext(messageId: number): Promise\n\t\t{\n\t\t\tconst hasMessage = this.$store.getters['messages/hasMessage']({\n\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\tmessageId: messageId\n\t\t\t});\n\t\t\tif (hasMessage)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we have this message, scrolling to it', messageId);\n\t\t\t\treturn this.getScrollManager().animatedScrollToMessage(messageId, -FLOATING_DATE_OFFSET)\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tthis.highlightMessage(messageId);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.getMessageService().loadContext(messageId)\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.$nextTick();\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(messageId, -FLOATING_DATE_OFFSET);\n\t\t\t\t\treturn this.$nextTick();\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.highlightMessage(messageId);\n\t\t\t\t\treturn true;\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\tconsole.error('goToMessageContext error', error);\n\t\t\t\t});\n\t\t},\n\t\thighlightMessage(messageId: number)\n\t\t{\n\t\t\tconst HIGHLIGHT_CLASS = 'bx-im-dialog-chat__highlighted-message';\n\t\t\tconst HIGHLIGHT_DURATION = 2000;\n\n\t\t\tconst message = this.getScrollManager().getDomElementById(messageId);\n\t\t\tif (!message)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.addClass(message, HIGHLIGHT_CLASS);\n\t\t\tsetTimeout(() => {\n\t\t\t\tDom.removeClass(message, HIGHLIGHT_CLASS);\n\t\t\t}, HIGHLIGHT_DURATION);\n\t\t},\n\t\tsaveScrollPosition()\n\t\t{\n\t\t\tlet savedPositionMessageId = this.getObserverManager().getFirstVisibleMessage();\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tsavedPositionMessageId = 0;\n\t\t\t}\n\t\t\tthis.$store.dispatch('dialogues/update', {\n\t\t\t\tdialogId: this.dialogId,\n\t\t\t\tfields: {\n\t\t\t\t\tsavedPositionMessageId\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tloadMessagesOnExit()\n\t\t{\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.getMessageService().reloadMessageList();\n\t\t\t}, LOAD_MESSAGE_ON_EXIT_DELAY);\n\t\t},\n\t\t/* region Init methods */\n\t\tinitContextMode()\n\t\t{\n\t\t\tif (!this.layout.contextId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.contextMode.active = true;\n\t\t\t// chat was loaded before, we didn't load context specifically\n\t\t\t// if chat wasn't loaded before - we load it with context\n\t\t\tthis.contextMode.messageIsLoaded = !this.dialogInited;\n\t\t},\n\t\tinitContextMenu()\n\t\t{\n\t\t\tthis.messageMenu = new MessageMenu();\n\t\t\tthis.messageMenu.subscribe(MessageMenu.events.onCloseMenu, () => {\n\t\t\t\tthis.messageMenuIsActiveForId = 0;\n\t\t\t});\n\n\t\t\tthis.avatarMenu = new AvatarMenu();\n\t\t},\n\t\tinitObserverManager()\n\t\t{\n\t\t\tthis.observerManager = new ObserverManager();\n\t\t\tthis.observerManager.subscribe(ObserverManager.events.onMessageIsVisible, () => {\n\t\t\t\tthis.debouncedReadHandler();\n\t\t\t});\n\t\t},\n\t\tgetObserverManager(): ObserverManager\n\t\t{\n\t\t\treturn this.observerManager;\n\t\t},\n\t\tgetCollectionManager(): CollectionManager\n\t\t{\n\t\t\tif (!this.collectionManager)\n\t\t\t{\n\t\t\t\tthis.collectionManager = new CollectionManager(this.dialogId);\n\t\t\t}\n\n\t\t\treturn this.collectionManager;\n\t\t},\n\t\tgetMessageService(): MessageService\n\t\t{\n\t\t\tif (!this.messageService)\n\t\t\t{\n\t\t\t\tthis.messageService = new MessageService({chatId: this.dialog.chatId});\n\t\t\t}\n\n\t\t\treturn this.messageService;\n\t\t},\n\t\tgetChatService(): ChatService\n\t\t{\n\t\t\tif (!this.chatService)\n\t\t\t{\n\t\t\t\tthis.chatService = new ChatService();\n\t\t\t}\n\n\t\t\treturn this.chatService;\n\t\t},\n\t\tgetScrollManager(): ScrollManager\n\t\t{\n\t\t\tif (!this.scrollManager)\n\t\t\t{\n\t\t\t\tthis.scrollManager = new ScrollManager();\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerUp, this.onScrollTriggerUp);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerDown, this.onScrollTriggerDown);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollThresholdPass, (event: BaseEvent<boolean>) => {\n\t\t\t\t\tthis.isScrolledUp = event.getData();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.scrollManager;\n\t\t},\n\t\t/* endregion Init methods */\n\t\t/* region Event handlers */\n\t\tonChatInited()\n\t\t{\n\t\t\tif (!this.dialog.loading)\n\t\t\t{\n\t\t\t\tthis.scrollOnStart();\n\t\t\t\tthis.debouncedReadHandler();\n\t\t\t\tthis.getObserverManager().setDialogInited(true);\n\t\t\t}\n\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tthis.getChatService().clearDialogMark(this.dialogId);\n\t\t\t});\n\n\t\t\tEventEmitter.emit(EventType.dialog.onDialogInited, {dialogId: this.dialogId});\n\t\t},\n\t\tonScrollTriggerUp()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered UP');\n\t\t\tconst container = this.getContainer();\n\t\t\tconst oldHeight = container.scrollHeight - container.clientHeight;\n\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedHistoryMessages())\n\t\t\t{\n\t\t\t\treturn this.getMessageService().drawPreparedHistoryMessages().then(() => {\n\t\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasPrevPage)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tthis.getMessageService().loadHistory().then(() => {\n\t\t\t\t// Messages loaded and we are at the top\n\t\t\t\tif (this.getScrollManager().isAtTheTop())\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: we are at the top after history request, inserting messages');\n\t\t\t\t\tthis.getMessageService().drawPreparedHistoryMessages().then(() => {\n\t\t\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tonScrollTriggerDown()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered DOWN');\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedUnreadMessages())\n\t\t\t{\n\t\t\t\treturn this.getMessageService().drawPreparedUnreadMessages();\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tthis.getMessageService().loadUnread().then(() => {\n\t\t\t\t// Messages loaded and we are at the bottom\n\t\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: we are at the bottom after unread request, inserting messages');\n\t\t\t\t\tthis.getMessageService().drawPreparedUnreadMessages().then(() => {\n\t\t\t\t\t\tthis.getScrollManager().checkIfChatIsScrolledUp();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tonScrollToBottom(event: BaseEvent<ScrollToBottomEvent>)\n\t\t{\n\t\t\tconst {chatId, threshold = DialogScrollThreshold.halfScreenUp} = event.getData();\n\t\t\tif (this.dialog.chatId !== chatId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.windowFocused || this.hasVisibleCall())\n\t\t\t{\n\t\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll to bottom', chatId, threshold);\n\t\t\tif (threshold === DialogScrollThreshold.halfScreenUp && this.isScrolledUp)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (threshold === DialogScrollThreshold.nearTheBottom && !this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tthis.getScrollManager().animatedScrollToBottom();\n\t\t\t});\n\t\t},\n\t\tonGoToMessageContext(event: BaseEvent)\n\t\t{\n\t\t\tconst {dialogId, messageId} = event.getData();\n\t\t\tif (this.dialog.dialogId !== dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonOpenChatInfo(event: BaseEvent)\n\t\t{\n\t\t\tconst {dialogId, event: $event} = event.getData();\n\t\t\tthis.chatInfoPopup.element = $event.target;\n\t\t\tthis.chatInfoPopup.dialogId = dialogId;\n\t\t\tthis.chatInfoPopup.show = true;\n\t\t},\n\t\tonPinnedMessageClick(messageId: number)\n\t\t{\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageUnpin(messageId: number)\n\t\t{\n\t\t\tthis.getMessageService().unpinMessage(this.dialog.chatId, messageId);\n\t\t},\n\t\tonMessageContextMenuClick(event: {message: ImModelMessage, $event: PointerEvent})\n\t\t{\n\t\t\tconst context = {dialogId: this.dialogId, ...event.message};\n\t\t\tthis.messageMenu.openMenu(context, event.$event.currentTarget);\n\t\t\tthis.messageMenuIsActiveForId = event.message.id;\n\t\t},\n\t\tonMessageQuote(event: {message: ImModelMessage})\n\t\t{\n\t\t\tconst {message} = event;\n\t\t\tQuoteManager.sendQuoteEvent(message);\n\t\t},\n\t\tonScroll(event: Event)\n\t\t{\n\t\t\tthis.closeDialogPopups();\n\t\t\tthis.debouncedScrollHandler(event);\n\t\t},\n\t\tonScrollButtonClick()\n\t\t{\n\t\t\tif (this.getScrollManager().scrollButtonClicked)\n\t\t\t{\n\t\t\t\tthis.handleSecondScrollButtonClick();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollButtonClicked = true;\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\tthis.getMessageService().loadInitialMessages().then(() => {\n\t\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\tif (!firstUnreadId)\n\t\t\t{\n\t\t\t\tthis.getMessageService().loadInitialMessages().then(() => {\n\t\t\t\t\tthis.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t},\n\t\tonWindowFocus()\n\t\t{\n\t\t\tthis.windowFocused = true;\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonWindowBlur()\n\t\t{\n\t\t\tthis.windowFocused = false;\n\t\t},\n\t\tonAvatarClick(dialogId: string, event: PointerEvent)\n\t\t{\n\t\t\tconst user = this.$store.getters['users/get'](dialogId);\n\t\t\tconst userId = Number.parseInt(dialogId, 10);\n\t\t\tif (!user || Core.getUserId() === userId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Utils.key.isAltOrOption(event))\n\t\t\t{\n\t\t\t\tEventEmitter.emit(EventType.textarea.insertMention, {\n\t\t\t\t\tmentionText: user.name,\n\t\t\t\t\tmentionReplacement: Utils.user.getMentionBbCode(user.id, user.name)\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.avatarMenu.openMenu({user, dialog: this.dialog}, event.currentTarget);\n\t\t},\n\t\thandleSecondScrollButtonClick()\n\t\t{\n\t\t\tthis.getScrollManager().scrollButtonClicked = false;\n\t\t\tif (this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\tthis.getMessageService().loadContext(this.dialog.lastMessageId).then(() => {\n\t\t\t\t\tEventEmitter.emit(EventType.dialog.scrollToBottom, {\n\t\t\t\t\t\tchatId: this.dialog.chatId\n\t\t\t\t\t});\n\t\t\t\t}).catch(error => {\n\t\t\t\t\tconsole.error('ChatDialog: scroll to chat end loadContext error', error);\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId);\n\t\t},\n\t\t/* endregion Event handlers */\n\t\thasVisibleCall()\n\t\t{\n\t\t\treturn CallManager.getInstance().hasVisibleCall();\n\t\t},\n\t\tcloseDialogPopups()\n\t\t{\n\t\t\tthis.closeMessageMenu();\n\t\t\tthis.chatInfoPopup.show = false;\n\t\t\tthis.avatarMenu.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReactionUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReadUsers)?.close();\n\t\t},\n\t\tcloseMessageMenu()\n\t\t{\n\t\t\tthis.messageMenu.close();\n\t\t\tthis.messageMenuIsActiveForId = 0;\n\t\t},\n\t\tsubscribeToEvents()\n\t\t{\n\t\t\tEventEmitter.subscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.subscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.subscribe(EventType.mention.openChatInfo, this.onOpenChatInfo);\n\n\t\t\tEvent.bind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.bind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tunsubscribeFromEvents()\n\t\t{\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.unsubscribe(EventType.mention.openChatInfo, this.onOpenChatInfo);\n\n\t\t\tEvent.unbind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.unbind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tgetContainer(): ?HTMLElement\n\t\t{\n\t\t\treturn this.$refs['container'];\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__block bx-im-dialog-chat__scope\">\n\t\t\t<PinnedMessages\n\t\t\t\tv-if=\"pinnedMessages.length > 0\"\n\t\t\t\t:messages=\"pinnedMessages\"\n\t\t\t\t@messageClick=\"onPinnedMessageClick\"\n\t\t\t\t@messageUnpin=\"onPinnedMessageUnpin\"\n\t\t\t/>\n\t\t\t<div @scroll=\"onScroll\" class=\"bx-im-dialog-chat__scroll-container\" ref=\"container\">\n\t\t\t\t<div class=\"bx-im-dialog-chat__content\">\n\t\t\t\t\t<!-- Loader -->\n\t\t\t\t\t<DialogLoader v-if=\"!dialogInited\" :fullHeight=\"formattedCollection.length === 0\" />\n\t\t\t\t\t<!-- Date groups -->\n\t\t\t\t\t<div v-for=\"dateGroup in formattedCollection\" :key=\"dateGroup.date.id\" class=\"bx-im-dialog-chat__date-group_container\">\n\t\t\t\t\t\t<!-- Date mark -->\n\t\t\t\t\t\t<DateGroupTitle :title=\"dateGroup.date.title\" />\n\t\t\t\t\t\t<!-- Single date group -->\n\t\t\t\t\t\t<template v-for=\"dateGroupItem in dateGroup.items\">\n\t\t\t\t\t\t\t<!-- 'New messages' mark -->\n\t\t\t\t\t\t\t<MarkedMessagesBlock v-if=\"dateGroupItem.type === BlockType.markedMessages\" data-id=\"newMessages\" />\n\t\t\t\t\t\t\t<NewMessagesBlock v-else-if=\"dateGroupItem.type === BlockType.newMessages\" data-id=\"newMessages\" />\n\t\t\t\t\t\t\t<!-- Author group -->\n\t\t\t\t\t\t\t<div v-else-if=\"dateGroupItem.type === BlockType.authorGroup\" :class=\"'--' + dateGroupItem.messageType\" class=\"bx-im-dialog-chat__author-group_container\">\n\t\t\t\t\t\t\t\t<!-- Author group avatar -->\n\t\t\t\t\t\t\t\t<div v-if=\"dateGroupItem.avatar.isNeeded\" class=\"bx-im-dialog-chat__author-group_avatar\">\n\t\t\t\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t\t\t\t:dialogId=\"dateGroupItem.avatar.avatarId\"\n\t\t\t\t\t\t\t\t\t\t:size=\"AvatarSize.L\"\n\t\t\t\t\t\t\t\t\t\t:withStatus=\"false\"\n\t\t\t\t\t\t\t\t\t\t@click=\"onAvatarClick(dateGroupItem.avatar.avatarId, $event)\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<!-- Messages -->\n\t\t\t\t\t\t\t\t<div class=\"bx-im-dialog-chat__messages_container\">\n\t\t\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t\t\tv-for=\"(message, index) in dateGroupItem.items\"\n\t\t\t\t\t\t\t\t\t\tv-message-observer\n\t\t\t\t\t\t\t\t\t\t:is=\"message.componentId\"\n\t\t\t\t\t\t\t\t\t\t:withTitle=\"index === 0\"\n\t\t\t\t\t\t\t\t\t\t:item=\"message\"\n\t\t\t\t\t\t\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t\t\t\t\t\t\t:key=\"message.id\"\n\t\t\t\t\t\t\t\t\t\t:menuIsActiveForId=\"messageMenuIsActiveForId\"\n\t\t\t\t\t\t\t\t\t\t:withAvatar=\"dateGroupItem.avatar.isNeeded\"\n\t\t\t\t\t\t\t\t\t\t:data-viewed=\"message.viewed\"\n\t\t\t\t\t\t\t\t\t\t@contextMenuClick=\"onMessageContextMenuClick\"\n\t\t\t\t\t\t\t\t\t\t@quoteMessage=\"onMessageQuote\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</div>\n\t\t\t\t\t<DialogStatus v-if=\"showDialogStatus\" :dialogId=\"dialogId\" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Transition name=\"scroll-button-transition\">\n\t\t\t\t<div v-if=\"isScrolledUp\" @click=\"onScrollButtonClick\" class=\"bx-im-dialog-chat__scroll-button\">\n\t\t\t\t\t<div v-if=\"dialog.counter\" class=\"bx-im-dialog-chat__scroll-button_counter\">{{ formattedCounter }}</div>\n\t\t\t\t</div>\n\t\t\t</Transition>\n\t\t\t<ChatInfoPopup\n\t\t\t\tv-if=\"chatInfoPopup.show\" \n\t\t\t\t:dialogId=\"chatInfoPopup.dialogId\"\n\t\t\t\t:bindElement=\"chatInfoPopup.element\"\n\t\t\t\t:showPopup=\"chatInfoPopup.show\"\n\t\t\t\t@close=\"chatInfoPopup.show = false\"\n\t\t\t/>\n\t\t</div>\n\t`\n};"],"names":["EVENT_NAMESPACE","SCROLLING_THRESHOLD","POSITION_THRESHOLD","SCROLLED_UP_THRESHOLD","ScrollManager","EventEmitter","constructor","isScrolling","currentScroll","lastScroll","chatIsScrolledUp","scrollButtonClicked","setEventNamespace","setContainer","container","onScroll","event","target","scrollTop","isScrollingDown","isScrollingUp","leftSpaceBottom","scrollHeight","clientHeight","emit","events","onScrollTriggerDown","onScrollTriggerUp","checkIfChatIsScrolledUp","availableScrollHeight","newFlag","onScrollThresholdPass","scrollToBottom","Logger","warn","forceScrollTo","animatedScrollToBottom","animatedScrollTo","scrollToMessage","messageId","offset","element","getDomElementById","position","offsetTop","animatedScrollToMessage","cancelAnimatedScroll","scroll","top","behavior","adjustScrollOnHistoryAddition","oldContainerHeight","newContainerHeight","newScrollPosition","Promise","resolve","Animation","start","end","elementProperty","callback","cancel","isAtTheTop","isAtTheBottom","isAroundBottom","id","querySelector","CollectionManager","dialogId","firstIteration","cachedDateGroups","store","Core","getStore","formatMessageCollection","messageCollection","dateGroups","collection","lastDateItems","lastAuthorId","lastAuthorItems","dialog","getters","markedId","inited","markInserted","lastReadId","initialLastReadMessage","initialMarkedId","forEach","message","index","dateGroup","getDateGroup","date","title","push","type","BlockType","items","markedMessages","authorId","authorGroup","userId","avatar","getAvatarConfig","messageType","getMessageType","isLastMessage","length","newMessages","INDEX_BETWEEN_DATE_AND_TIME","shortDate","toJSON","slice","DateFormatter","formatByTemplate","DateTemplate","avatarId","toString","isNeeded","MessageType","self","system","componentId","MessageComponent","base","getUserId","opponent","QUOTE_DELIMITER","repeat","QuoteManager","sendQuoteEvent","EventType","textarea","insertText","text","prepareQuoteText","withNewLine","quoteTitle","Loc","getMessage","user","name","quoteDate","notification","quoteText","Parser","prepareQuote","quoteContext","chatId","DialogType","MessageMenu","BaseMenu","chatService","ChatService","marketManager","MarketManager","getInstance","getMenuOptions","className","getMenuClassName","angle","offsetLeft","getMenuItems","getQuoteItem","getCopyItem","getQuoteBlockDelimiter","getPinItem","getFavoriteItem","getMarkItem","getPinBlockDelimiter","getCreateItem","getCreateBlockDelimiter","getEditItem","getEditBlockDelimiter","getDeleteItem","onclick","context","menuInstance","close","files","textToCopy","prepareCopy","BX","clipboard","copy","UI","Notification","Center","notify","content","isPinned","messageService","MessageService","unpinMessage","pinMessage","isInFavorite","removeMessageFromFavorite","addMessageToFavorite","canUnread","viewed","isMarked","markMessage","getCreateTaskItem","getCreateMeetingItem","getMarketItems","entityCreator","EntityCreator","createTaskForMessage","createMeetingForMessage","editMessage","deleteMessage","placements","getAvailablePlacementsByType","PlacementType","contextMenu","marketMenuItem","placement","openSlider","itemLimit","delimiter","isDeleted","AvatarMenu","getMentionItem","getSendItem","getProfileItem","getKickItem","insertMention","mentionText","mentionReplacement","Utils","getMentionBbCode","Messenger","openChat","href","getProfileLink","isOwner","owner","isUser","kickUserFromChat","ObserverManager","Set","setDialogInited","flag","Object","values","unobserveMessage","observeMessage","messageElement","observe","dataset","unobserve","onReadMessage","delete","getMessagesToRead","getFirstVisibleMessage","size","firstVisibleMessage","sort","a","b","IntersectionObserver","entries","entry","rootBounds","messageIsFullyVisible","isIntersecting","intersectionRatio","messageTakesHalfOfViewport","intersectionRect","height","add","onMessageIsVisible","threshold","Array","from","fill","map","zero","NewMessagesBlock","data","methods","loc","phraseCode","$Bitrix","template","MarkedMessagesBlock","DateGroupTitle","props","String","required","PinnedMessage","computed","internalMessage","purifyMessage","author","$store","PinnedMessages","components","messages","emits","firstMessage","messagesToShow","UserService","getRestClient","UserManager","loadReadUsers","users","callMethod","RestMethod","imV2ChatMessageTailViewers","then","response","setUsersToModel","catch","error","console","Error","AdditionalUsers","UserListPopup","show","Boolean","bindElement","showPopup","loadingAdditionalUsers","additionalUsers","watch","newValue","oldValue","loadUsers","getUserService","lastMessageId","userIds","prepareAdditionalUsers","onPopupClose","$emit","firstViewerId","lastMessageViews","firstViewer","filter","userService","TYPING_USERS_COUNT","MORE_USERS_CSS_CLASS","DialogStatus","showAdditionalUsers","additionalUsersLinkElement","isChat","typingStatus","writingList","firstTypingUsers","userName","join","remainingUsersCount","readStatus","countOfViewers","formatUserViewStatus","formatChatViewStatus","messageReadStatus","Text","encode","onClick","matches","onMoreUsersClick","document","replacements","DialogLoader","fullHeight","default","FLOATING_DATE_OFFSET","LOAD_MESSAGE_ON_EXIT_DELAY","ChatDialog","Avatar","BaseMessage","ChatCreationMessage","ChatInfoPopup","directives","mounted","binding","instance","observerManager","beforeUnmount","textareaHeight","Number","messageMenuIsActiveForId","chatInfoPopup","contextMode","active","messageIsLoaded","initialScrollCompleted","isScrolledUp","windowFocused","AvatarSize","layout","dialogInited","formattedCollection","getCollectionManager","pinnedMessages","isOpened","openedDialogId","entityId","debouncedScrollHandler","SCROLLING_DEBOUNCE_DELAY","Runtime","debounce","getScrollManager","debouncedReadHandler","readVisibleMessages","formattedCounter","counter","showDialogStatus","some","onChatInited","$nextTick","created","initContextMenu","initObserverManager","initContextMode","getContainer","scrollOnStart","hasFocus","subscribeToEvents","closeMessageMenu","unsubscribeFromEvents","saveScrollPosition","loadMessagesOnExit","hasVisibleCall","getObserverManager","getChatService","readMessage","contextId","highlightMessage","goToMessageContext","savedPositionMessageId","hasMessage","getMessageService","loadContext","HIGHLIGHT_CLASS","HIGHLIGHT_DURATION","Dom","addClass","setTimeout","removeClass","dispatch","fields","reloadMessageList","messageMenu","subscribe","onCloseMenu","avatarMenu","collectionManager","scrollManager","getData","loading","clearDialogMark","onDialogInited","oldHeight","hasPreparedHistoryMessages","drawPreparedHistoryMessages","isLoading","hasPrevPage","loadHistory","hasPreparedUnreadMessages","drawPreparedUnreadMessages","hasNextPage","loadUnread","onScrollToBottom","DialogScrollThreshold","halfScreenUp","firstUnreadId","nearTheBottom","onGoToMessageContext","onOpenChatInfo","$event","onPinnedMessageClick","onPinnedMessageUnpin","onMessageContextMenuClick","openMenu","currentTarget","onMessageQuote","closeDialogPopups","onScrollButtonClick","handleSecondScrollButtonClick","loadInitialMessages","onWindowFocus","onWindowBlur","onAvatarClick","parseInt","key","isAltOrOption","CallManager","PopupManager","getPopupById","PopupType","dialogReactionUsers","dialogReadUsers","mention","openChatInfo","Event","bind","window","unsubscribe","unbind","$refs"],"mappings":"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"}