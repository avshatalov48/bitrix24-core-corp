{"version":3,"file":"chat-dialog.bundle.js","sources":["../src/classes/scroll-manager.js","../src/classes/observer-manager.js","../src/classes/pull-watch-manager.js","../src/components/pinned/pinned-message.js","../src/components/pinned/pinned-messages.js","../src/components/quote-button.js","../src/chat-dialog.js"],"sourcesContent":["import {EventEmitter} from 'main.core.events';\n\nimport {Logger} from 'im.v2.lib.logger';\nimport {Animation} from 'im.v2.lib.animation';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ScrollManager';\nconst SCROLLING_THRESHOLD = 1500;\nconst POSITION_THRESHOLD = 40;\nconst SCROLLED_UP_THRESHOLD = 400;\n\nexport class ScrollManager extends EventEmitter\n{\n\tcontainer: HTMLElement;\n\tisScrolling: boolean = false;\n\tcurrentScroll: number = 0;\n\tlastScroll: number = 0;\n\tchatIsScrolledUp: boolean = false;\n\tscrollButtonClicked: boolean = false;\n\n\tstatic events = {\n\t\tonScrollTriggerUp: 'onScrollTriggerUp',\n\t\tonScrollTriggerDown: 'onScrollTriggerDown',\n\t\tonScrollThresholdPass: 'onScrollThresholdPass'\n\t};\n\n\tconstructor(): ScrollManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\t}\n\n\tsetContainer(container: HTMLElement)\n\t{\n\t\tthis.container = container;\n\t}\n\n\tonScroll(event: Event)\n\t{\n\t\t// if (this.isScrolling || !event.target || this.currentScroll === event.target.scrollTop)\n\t\tif (this.isScrolling || !event.target)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.currentScroll = event.target.scrollTop;\n\t\tconst isScrollingDown = this.lastScroll < this.currentScroll;\n\t\tconst isScrollingUp = !isScrollingDown;\n\t\tif (isScrollingUp)\n\t\t{\n\t\t\tthis.scrollButtonClicked = false;\n\t\t}\n\n\t\tconst leftSpaceBottom = event.target.scrollHeight - event.target.scrollTop - event.target.clientHeight;\n\t\tif (isScrollingDown && this.lastScroll > 0 && leftSpaceBottom < SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerDown);\n\t\t}\n\t\telse if (isScrollingUp && this.currentScroll <= SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerUp);\n\t\t}\n\n\t\tthis.lastScroll = this.currentScroll;\n\n\t\tthis.checkIfChatIsScrolledUp();\n\t}\n\n\tcheckIfChatIsScrolledUp()\n\t{\n\t\tconst availableScrollHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newFlag = this.currentScroll + SCROLLED_UP_THRESHOLD < availableScrollHeight;\n\t\tif (newFlag !== this.chatIsScrolledUp)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollThresholdPass, newFlag);\n\t\t}\n\t\tthis.chatIsScrolledUp = newFlag;\n\t}\n\n\tscrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to bottom');\n\t\tthis.forceScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tanimatedScrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to bottom');\n\t\tthis.animatedScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tscrollToMessage(messageId: number, offset: number = -10)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\tthis.forceScrollTo(position);\n\t}\n\n\tanimatedScrollToMessage(messageId: number, offset: number = -10): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\treturn this.animatedScrollTo(position);\n\t}\n\n\tforceScrollTo(position: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Force scroll to - ', position);\n\t\tthis.cancelAnimatedScroll();\n\t\tthis.container.scroll({top: position, behavior: 'instant'});\n\t}\n\n\tadjustScrollOnHistoryAddition(oldContainerHeight: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Adjusting scroll after history addition');\n\t\tconst newContainerHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newScrollPosition = this.container.scrollTop + newContainerHeight - oldContainerHeight;\n\t\tthis.forceScrollTo(newScrollPosition);\n\t}\n\n\tanimatedScrollTo(position: number): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Animated scroll to - ', position);\n\t\treturn new Promise((resolve) => {\n\t\t\tAnimation.start({\n\t\t\t\tstart: this.container.scrollTop,\n\t\t\t\tend: position,\n\t\t\t\telement: this.container,\n\t\t\t\telementProperty: 'scrollTop',\n\t\t\t\tcallback: () => {\n\t\t\t\t\tthis.checkIfChatIsScrolledUp();\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tcancelAnimatedScroll()\n\t{\n\t\tif (!this.isScrolling)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tAnimation.cancel();\n\t\tthis.isScrolling = false;\n\t}\n\n\tisAtTheTop(): boolean\n\t{\n\t\treturn this.container.scrollTop === 0;\n\t}\n\n\tisAtTheBottom(): boolean\n\t{\n\t\treturn this.container.scrollTop + this.container.clientHeight >= this.container.scrollHeight;\n\t}\n\n\tisAroundBottom(): boolean\n\t{\n\t\treturn this.container.scrollHeight - this.container.scrollTop - this.container.clientHeight < POSITION_THRESHOLD;\n\t}\n\n\tgetDomElementById(id: number | string): ?HTMLElement\n\t{\n\t\treturn this.container.querySelector(`[data-id=\"${id}\"]`);\n\t}\n}","import 'main.polyfill.intersectionobserver';\nimport {EventEmitter} from 'main.core.events';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ObserverManager';\n\nexport class ObserverManager extends EventEmitter\n{\n\t#observer: IntersectionObserver;\n\t#observedElements: {[messageId: string]: HTMLElement} = {};\n\t#visibleMessages: Set = new Set();\n\t#messagesToRead: Set = new Set();\n\t#dialogInited: boolean = false;\n\n\tstatic events = {\n\t\tonMessageIsVisible: 'onMessageIsVisible'\n\t};\n\n\tconstructor(): ObserverManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tthis.#initObserver();\n\t}\n\n\tsetDialogInited(flag: boolean)\n\t{\n\t\tObject.values(this.#observedElements).forEach(element => {\n\t\t\tthis.unobserveMessage(element);\n\t\t\tthis.observeMessage(element);\n\t\t});\n\n\t\tthis.#dialogInited = flag;\n\t}\n\n\tobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.observe(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tthis.#observedElements[messageElement.dataset.id] = messageElement;\n\t\t}\n\t}\n\n\tunobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.unobserve(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tdelete this.#observedElements[messageElement.dataset.id];\n\t\t}\n\t}\n\n\tonReadMessage(messageId: number)\n\t{\n\t\tthis.#messagesToRead.delete(messageId);\n\t}\n\n\tgetMessagesToRead(): number[]\n\t{\n\t\treturn [...this.#messagesToRead];\n\t}\n\n\tgetFirstVisibleMessage(): number\n\t{\n\t\tif (this.#visibleMessages.size === 0)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst [firstVisibleMessage] = [...this.#visibleMessages].sort((a, b) => a - b);\n\n\t\treturn firstVisibleMessage;\n\t}\n\n\t#initObserver()\n\t{\n\t\tthis.#observer = new IntersectionObserver(((entries: IntersectionObserverEntry[]) => {\n\t\t\tentries.forEach((entry: IntersectionObserverEntry) => {\n\t\t\t\tconst messageId = this.#getMessageIdFromElement(entry.target);\n\t\t\t\tif (!messageId || !entry.rootBounds || !this.#dialogInited)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messageIsFullyVisible = entry.isIntersecting && entry.intersectionRatio >= 0.99;\n\t\t\t\tconst messageTakesHalfOfViewport = entry.intersectionRect.height >= entry.rootBounds.height / 2.2;\n\t\t\t\t// const messageIsBiggerThanViewport = entry.boundingClientRect.height + 20 > entry.rootBounds.height;\n\t\t\t\t// const messageCountsAsVisible = messageIsBiggerThanViewport && messageTakesMostOfViewport;\n\t\t\t\tif (messageIsFullyVisible || messageTakesHalfOfViewport)\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.add(messageId);\n\t\t\t\t\tif (!this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.add(messageId);\n\t\t\t\t\t\tthis.emit(ObserverManager.events.onMessageIsVisible);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.delete(messageId);\n\t\t\t\t\tif (this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.delete(messageId);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}), {threshold: Array.from({length: 101}).fill(0).map((zero, index) => index * 0.01)});\n\t}\n\n\t#getMessageIdFromElement(messageElement: HTMLElement): number\n\t{\n\t\treturn +messageElement.dataset.id;\n\t}\n\n\t#messageIsViewed(messageElement: HTMLElement): boolean\n\t{\n\t\treturn messageElement.dataset['viewed'] === 'true';\n\t}\n}","import { Core } from 'im.v2.application.core';\nimport { UserRole, RestMethod } from 'im.v2.const';\nimport { runAction } from 'im.v2.lib.rest';\n\nimport type { ImModelChat } from 'im.v2.model';\nimport type { PULL as Pull } from 'pull.client';\n\nconst TAG_PREFIX = 'IM_PUBLIC_';\n\nexport class PullWatchManager\n{\n\t#dialog: ImModelChat;\n\t#pullClient: Pull;\n\n\tconstructor(dialogId: string)\n\t{\n\t\tthis.#dialog = Core.getStore().getters['chats/get'](dialogId);\n\t\tthis.#pullClient = Core.getPullClient();\n\t}\n\n\tonChatLoad()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#pullClient.extendWatch(`${TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\tonChatExit()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#pullClient.clearWatch(`${TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\tonLoadedChatEnter()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#requestWatchStart();\n\t\tthis.#pullClient.extendWatch(`${TAG_PREFIX}${this.#dialog.chatId}`, true);\n\t}\n\n\t#requestWatchStart()\n\t{\n\t\trunAction(RestMethod.imV2ChatExtendPullWatch, {\n\t\t\tdata: {\n\t\t\t\tdialogId: this.#dialog.dialogId,\n\t\t\t},\n\t\t});\n\t}\n\n\t#isGuest(): boolean\n\t{\n\t\treturn this.#dialog?.role === UserRole.guest && this.#dialog?.dialogId !== 'settings';\n\t}\n}\n","import {Parser} from 'im.v2.lib.parser';\n\nimport type {ImModelUser, ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessage = {\n\tprops:\n\t{\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tinternalMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.message;\n\t\t},\n\t\ttext(): string\n\t\t{\n\t\t\treturn Parser.purifyMessage(this.internalMessage);\n\t\t},\n\t\tauthorId(): number\n\t\t{\n\t\t\treturn this.internalMessage.authorId;\n\t\t},\n\t\tauthor(): ImModelUser\n\t\t{\n\t\t\treturn this.$store.getters['users/get'](this.authorId);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__pinned_item\">\n\t\t\t<span v-if=\"author\" class=\"bx-im-dialog-chat__pinned_item_user\">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`\n};","import {PinnedMessage} from './pinned-message';\n\nimport '../../css/pinned-messages.css';\n\nimport type {ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessages = {\n\tcomponents: {PinnedMessage},\n\tprops:\n\t{\n\t\tmessages: {\n\t\t\ttype: Array,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['messageClick', 'messageUnpin'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tfirstMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.messagesToShow[0];\n\t\t},\n\t\tmessagesToShow(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.messages.slice(-1);\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div @click=\"$emit('messageClick', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__pinned_title\">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for=\"message in messagesToShow\"\n\t\t\t\t:message=\"message\"\n\t\t\t\t:key=\"message.id\"\n\t\t\t\t@click=\"$emit('messageClick', message.id)\"\n\t\t\t/>\n\t\t\t<div @click.stop=\"$emit('messageUnpin', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_unpin\"></div>\n\t\t</div>\n\t`\n};","import { Event } from 'main.core';\n\nimport { Quote } from 'im.v2.lib.quote';\nimport { Utils } from 'im.v2.lib.utils';\nimport { MessengerSlider } from 'im.v2.lib.slider';\n\nimport '../css/quote-button.css';\n\nimport type { ImModelMessage } from 'im.v2.model';\n\nconst CONTAINER_HEIGHT = 44;\nconst CONTAINER_WIDTH = 60;\nconst CONTAINER_OFFSET = 10;\nconst slider = MessengerSlider.getInstance().getCurrent();\nconst sliderRect = slider?.layout.container.getBoundingClientRect();\nconst offsetY = sliderRect?.top ?? 0;\n\nconst MESSAGE_TEXT_NODE_CLASS = '.bx-im-message-default-content__text';\n\n// @vue/component\nexport const QuoteButton = {\n\tname: 'QuoteButton',\n\tdata()\n\t{\n\t\treturn {\n\t\t\ttext: '',\n\t\t\tmessage: null,\n\t\t\tmouseX: 0,\n\t\t\tmouseY: 0,\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tcontainerStyle(): {top: string, left: string, width: string, height: string}\n\t\t{\n\t\t\treturn {\n\t\t\t\ttop: `${this.mouseY - CONTAINER_HEIGHT - CONTAINER_OFFSET - offsetY}px`,\n\t\t\t\tleft: `${this.mouseX - CONTAINER_WIDTH / 2}px`,\n\t\t\t\twidth: `${CONTAINER_WIDTH}px`,\n\t\t\t\theight: `${CONTAINER_HEIGHT}px`,\n\t\t\t};\n\t\t},\n\t},\n\tmounted()\n\t{\n\t\tEvent.bind(window, 'mousedown', this.onMouseDown);\n\t},\n\tmethods:\n\t{\n\t\tonMessageMouseUp(message: ImModelMessage, event: MouseEvent)\n\t\t{\n\t\t\tif (event.button === 2)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.prepareSelectedText();\n\t\t\tthis.message = message;\n\t\t\tthis.mouseX = event.clientX;\n\t\t\tthis.mouseY = event.clientY;\n\t\t},\n\t\tonMouseDown(event: MouseEvent)\n\t\t{\n\t\t\tconst container = this.$refs.container;\n\t\t\tif (!container || container.contains(event.target))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$emit('close');\n\t\t},\n\t\tprepareSelectedText(): string\n\t\t{\n\t\t\tif (Utils.browser.isFirefox())\n\t\t\t{\n\t\t\t\tthis.text = window.getSelection().toString();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst range = window.getSelection().getRangeAt(0);\n\t\t\tconst rangeContents = range.cloneContents();\n\t\t\tlet nodesToIterate = rangeContents.childNodes;\n\n\t\t\tconst messageNode = rangeContents.querySelector(MESSAGE_TEXT_NODE_CLASS);\n\t\t\tif (messageNode)\n\t\t\t{\n\t\t\t\tnodesToIterate = messageNode.childNodes;\n\t\t\t}\n\n\t\t\tfor (const node of nodesToIterate)\n\t\t\t{\n\t\t\t\tif (this.isImage(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.getAttribute('data-code') ?? node.getAttribute('alt');\n\t\t\t\t}\n\t\t\t\telse if (this.isLineBreak(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += '\\n';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.textContent;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tisImage(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn node.tagName.toLowerCase() === 'img';\n\t\t},\n\t\tisLineBreak(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName.toLowerCase() === 'br';\n\t\t},\n\t\tisText(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName === '#text';\n\t\t},\n\t\tisMessageTextNode(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst textNode = node.matches(MESSAGE_TEXT_NODE_CLASS);\n\n\t\t\treturn Boolean(textNode);\n\t\t},\n\t\textractTextFromMessageNode(node: HTMLElement): string\n\t\t{\n\t\t\tconst textNode = node.querySelector(MESSAGE_TEXT_NODE_CLASS);\n\t\t\tif (!textNode)\n\t\t\t{\n\t\t\t\treturn node.textContent;\n\t\t\t}\n\n\t\t\treturn textNode.textContent;\n\t\t},\n\t\tonQuoteClick()\n\t\t{\n\t\t\tQuote.sendQuoteEvent(this.message, this.text);\n\t\t\tthis.$emit('close');\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div ref=\"container\" @click=\"onQuoteClick\" :style=\"containerStyle\" class=\"bx-im-dialog-chat__quote-button\">\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon\"></div>\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon --hover\"></div>\n\t\t</div>\n\t`,\n};\n","import { Runtime, Event, Dom } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { PopupManager } from 'main.popup';\nimport { PullStatus } from 'pull.vue3.status';\n\nimport { MessageList } from 'im.v2.component.message-list';\nimport { ForwardPopup } from 'im.v2.component.entity-selector';\nimport { Logger } from 'im.v2.lib.logger';\nimport { CallManager } from 'im.v2.lib.call';\nimport { MessageService, ChatService } from 'im.v2.provider.service';\nimport {\n\tDialogBlockType as BlockType,\n\tEventType,\n\tPopupType,\n\tDialogScrollThreshold,\n\tUserRole,\n} from 'im.v2.const';\n\nimport { ScrollManager } from './classes/scroll-manager';\nimport { ObserverManager } from './classes/observer-manager';\nimport { PullWatchManager } from './classes/pull-watch-manager';\nimport { PinnedMessages } from './components/pinned/pinned-messages';\nimport { QuoteButton } from './components/quote-button';\nimport './css/chat-dialog.css';\n\nimport type { BitrixVueComponentProps } from 'ui.vue3';\nimport type { ImModelMessage, ImModelChat, ImModelLayout } from 'im.v2.model';\nimport type { ScrollToBottomEvent } from 'im.v2.const';\n\nconst FLOATING_DATE_OFFSET = 52;\nconst LOAD_MESSAGE_ON_EXIT_DELAY = 200;\n\n// @vue/component\nexport const ChatDialog = {\n\tname: 'ChatDialog',\n\tcomponents: {\n\t\tMessageList,\n\t\tPinnedMessages,\n\t\tQuoteButton,\n\t\tPullStatus,\n\t\tForwardPopup,\n\t},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\ttextareaHeight: {\n\t\t\ttype: Number,\n\t\t\tdefault: 0,\n\t\t},\n\t},\n\tdata(): Object\n\t{\n\t\treturn {\n\t\t\tforwardPopup: {\n\t\t\t\tshow: false,\n\t\t\t\tmessageId: 0,\n\t\t\t},\n\t\t\tcontextMode: {\n\t\t\t\tactive: false,\n\t\t\t\tmessageIsLoaded: false,\n\t\t\t},\n\t\t\tinitialScrollCompleted: false,\n\t\t\tisScrolledUp: false,\n\t\t\twindowFocused: false,\n\t\t\tshowQuoteButton: false,\n\t\t\tselectedText: null,\n\t\t\tquoteButtonStyles: {},\n\t\t\tquoteButtonMessage: 0,\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tlayout(): ImModelLayout\n\t\t{\n\t\t\treturn this.$store.getters['application/getLayout'];\n\t\t},\n\t\tdialog(): ImModelChat\n\t\t{\n\t\t\treturn this.$store.getters['chats/get'](this.dialogId, true);\n\t\t},\n\t\tdialogInited(): boolean\n\t\t{\n\t\t\treturn this.dialog.inited;\n\t\t},\n\t\tmessageCollection(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/get'](this.dialog.chatId);\n\t\t},\n\t\tpinnedMessages(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/pin/getPinned'](this.dialog.chatId);\n\t\t},\n\t\tisOpened(): boolean\n\t\t{\n\t\t\tconst openedDialogId = this.$store.getters['application/getLayout'].entityId;\n\n\t\t\treturn this.dialogId === openedDialogId;\n\t\t},\n\t\tisGuest(): boolean\n\t\t{\n\t\t\treturn this.dialog.role === UserRole.guest;\n\t\t},\n\t\tdebouncedScrollHandler(): Function\n\t\t{\n\t\t\tconst SCROLLING_DEBOUNCE_DELAY = 200;\n\n\t\t\treturn Runtime.debounce(this.getScrollManager().onScroll, SCROLLING_DEBOUNCE_DELAY, this.getScrollManager());\n\t\t},\n\t\tdebouncedReadHandler(): Function\n\t\t{\n\t\t\treturn Runtime.debounce(this.readVisibleMessages, 50, this);\n\t\t},\n\t\tformattedCounter(): string\n\t\t{\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.dialog.counter > 99)\n\t\t\t{\n\t\t\t\treturn '99+';\n\t\t\t}\n\n\t\t\treturn String(this.dialog.counter);\n\t\t},\n\t\tmessageListComponent(): BitrixVueComponentProps\n\t\t{\n\t\t\treturn MessageList;\n\t\t},\n\t\tshowScrollButton(): boolean\n\t\t{\n\t\t\treturn this.isScrolledUp || this.dialog.hasNextPage;\n\t\t},\n\t},\n\twatch:\n\t{\n\t\tdialogInited(newValue, oldValue)\n\t\t{\n\t\t\tif (!newValue || oldValue)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// first opening\n\t\t\tthis.getPullWatchManager().onChatLoad();\n\t\t\tthis.onChatInited();\n\t\t},\n\t\ttextareaHeight()\n\t\t{\n\t\t\tif (this.isScrolledUp || !this.dialogInited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t});\n\t\t},\n\t},\n\tcreated()\n\t{\n\t\tLogger.warn('Dialog: Chat created', this.dialogId);\n\t\tthis.initObserverManager();\n\t\tthis.initContextMode();\n\t},\n\tmounted()\n\t{\n\t\tthis.getScrollManager().setContainer(this.getContainer());\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\t// second+ opening\n\t\t\tthis.getPullWatchManager().onLoadedChatEnter();\n\t\t\tthis.onChatInited();\n\t\t}\n\t\t// there are P&P messages\n\t\telse if (!this.dialogInited && this.messageCollection.length > 0)\n\t\t{\n\t\t\tthis.scrollOnStart();\n\t\t}\n\n\t\tthis.windowFocused = document.hasFocus();\n\n\t\tthis.subscribeToEvents();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.unsubscribeFromEvents();\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\tthis.saveScrollPosition();\n\t\t\tthis.loadMessagesOnExit();\n\t\t}\n\t\tthis.getPullWatchManager().onChatExit();\n\t\tthis.closeDialogPopups();\n\t\tthis.forwardPopup.show = false;\n\t},\n\tmethods:\n\t{\n\t\treadVisibleMessages()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.windowFocused || this.hasVisibleCall() || this.isGuest)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getObserverManager().getMessagesToRead().forEach((messageId) => {\n\t\t\t\tthis.getChatService().readMessage(this.dialog.chatId, messageId);\n\t\t\t\tthis.getObserverManager().onReadMessage(messageId);\n\t\t\t});\n\t\t},\n\t\tscrollOnStart()\n\t\t{\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t// we loaded chat with context\n\t\t\t\tif (this.contextMode.active && this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.layout.contextId, -FLOATING_DATE_OFFSET);\n\t\t\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t\t\tthis.highlightMessage(this.layout.contextId);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// chat was loaded before\n\t\t\t\telse if (this.contextMode.active && !this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tthis.goToMessageContext(this.layout.contextId);\n\t\t\t\t}\n\t\t\t\t// marked message\n\t\t\t\telse if (this.dialog.markedId)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// saved position\n\t\t\t\telse if (this.dialog.savedPositionMessageId)\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: saved scroll position, scrolling to', this.dialog.savedPositionMessageId);\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId);\n\t\t\t\t}\n\t\t\t\t// unread message\n\t\t\t\telse if (this.$store.getters['chats/getLastReadId'](this.dialogId))\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// new chat with unread messages\n\t\t\t\telse if (this.$store.getters['messages/getFirstUnread'](this.dialog.chatId))\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: new chat with unread messages, dont scroll');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tasync goToMessageContext(messageId: number): void\n\t\t{\n\t\t\tconst hasMessage = this.$store.getters['messages/hasMessage']({\n\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\tmessageId,\n\t\t\t});\n\t\t\tif (hasMessage)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we have this message, scrolling to it', messageId);\n\n\t\t\t\tawait this.getScrollManager().animatedScrollToMessage(messageId, -FLOATING_DATE_OFFSET);\n\t\t\t\tthis.highlightMessage(messageId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this.getMessageService().loadContext(messageId)\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tLogger.error('goToMessageContext error', error);\n\t\t\t\t});\n\t\t\tawait this.$nextTick();\n\t\t\tthis.getScrollManager().scrollToMessage(messageId, -FLOATING_DATE_OFFSET);\n\t\t\tawait this.$nextTick();\n\t\t\tthis.highlightMessage(messageId);\n\t\t},\n\t\thighlightMessage(messageId: number)\n\t\t{\n\t\t\tconst HIGHLIGHT_CLASS = 'bx-im-dialog-chat__highlighted-message';\n\t\t\tconst HIGHLIGHT_DURATION = 2000;\n\n\t\t\tconst message = this.getScrollManager().getDomElementById(messageId);\n\t\t\tif (!message)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.addClass(message, HIGHLIGHT_CLASS);\n\t\t\tsetTimeout(() => {\n\t\t\t\tDom.removeClass(message, HIGHLIGHT_CLASS);\n\t\t\t}, HIGHLIGHT_DURATION);\n\t\t},\n\t\tsaveScrollPosition()\n\t\t{\n\t\t\tlet savedPositionMessageId = this.getObserverManager().getFirstVisibleMessage();\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tsavedPositionMessageId = 0;\n\t\t\t}\n\t\t\tthis.$store.dispatch('chats/update', {\n\t\t\t\tdialogId: this.dialogId,\n\t\t\t\tfields: {\n\t\t\t\t\tsavedPositionMessageId,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\tloadMessagesOnExit()\n\t\t{\n\t\t\tsetTimeout(() => {\n\t\t\t\tvoid this.getMessageService().reloadMessageList();\n\t\t\t}, LOAD_MESSAGE_ON_EXIT_DELAY);\n\t\t},\n\t\t/* region Init methods */\n\t\tinitContextMode()\n\t\t{\n\t\t\tif (!this.layout.contextId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.contextMode.active = true;\n\t\t\t// chat was loaded before, we didn't load context specifically\n\t\t\t// if chat wasn't loaded before - we load it with context\n\t\t\tthis.contextMode.messageIsLoaded = !this.dialogInited;\n\t\t},\n\t\tinitObserverManager()\n\t\t{\n\t\t\tthis.observerManager = new ObserverManager();\n\t\t\tthis.observerManager.subscribe(ObserverManager.events.onMessageIsVisible, () => {\n\t\t\t\tthis.debouncedReadHandler();\n\t\t\t});\n\t\t},\n\t\tgetObserverManager(): ObserverManager\n\t\t{\n\t\t\treturn this.observerManager;\n\t\t},\n\t\tgetMessageService(): MessageService\n\t\t{\n\t\t\tif (!this.messageService)\n\t\t\t{\n\t\t\t\tthis.messageService = new MessageService({ chatId: this.dialog.chatId });\n\t\t\t}\n\n\t\t\treturn this.messageService;\n\t\t},\n\t\tgetChatService(): ChatService\n\t\t{\n\t\t\tif (!this.chatService)\n\t\t\t{\n\t\t\t\tthis.chatService = new ChatService();\n\t\t\t}\n\n\t\t\treturn this.chatService;\n\t\t},\n\t\tgetScrollManager(): ScrollManager\n\t\t{\n\t\t\tif (!this.scrollManager)\n\t\t\t{\n\t\t\t\tthis.scrollManager = new ScrollManager();\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerUp, this.onScrollTriggerUp);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerDown, this.onScrollTriggerDown);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollThresholdPass, (event: BaseEvent<boolean>) => {\n\t\t\t\t\tthis.isScrolledUp = event.getData();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.scrollManager;\n\t\t},\n\t\tgetPullWatchManager(): PullWatchManager\n\t\t{\n\t\t\tif (!this.pullWatchManager)\n\t\t\t{\n\t\t\t\tthis.pullWatchManager = new PullWatchManager(this.dialogId);\n\t\t\t}\n\n\t\t\treturn this.pullWatchManager;\n\t\t},\n\t\t/* endregion Init methods */\n\t\t/* region Event handlers */\n\t\tonChatInited()\n\t\t{\n\t\t\tif (!this.dialog.loading)\n\t\t\t{\n\t\t\t\tthis.scrollOnStart();\n\t\t\t\tthis.readVisibleMessages();\n\t\t\t\tthis.getObserverManager().setDialogInited(true);\n\t\t\t}\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tthis.getChatService().clearDialogMark(this.dialogId);\n\t\t\t});\n\n\t\t\tEventEmitter.emit(EventType.dialog.onDialogInited, { dialogId: this.dialogId });\n\t\t},\n\t\tasync onScrollTriggerUp()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered UP');\n\t\t\tconst container = this.getContainer();\n\t\t\tconst oldHeight = container.scrollHeight - container.clientHeight;\n\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedHistoryMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasPrevPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tawait this.getMessageService().loadHistory();\n\t\t\t// Messages loaded and we are at the top\n\t\t\tif (this.getScrollManager().isAtTheTop())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the top after history request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\t\t\t}\n\t\t},\n\t\tasync onScrollTriggerDown()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered DOWN');\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedUnreadMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tawait this.getMessageService().loadUnread();\n\t\t\t// Messages loaded and we are at the bottom\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the bottom after unread request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\t\t\t\tthis.getScrollManager().checkIfChatIsScrolledUp();\n\t\t\t}\n\t\t},\n\t\tasync onScrollToBottom(event: BaseEvent<ScrollToBottomEvent>)\n\t\t{\n\t\t\tconst { chatId, threshold = DialogScrollThreshold.halfScreenUp, animation = true } = event.getData();\n\t\t\tif (this.dialog.chatId !== chatId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.windowFocused || this.hasVisibleCall())\n\t\t\t{\n\t\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\t\tif (firstUnreadId)\n\t\t\t\t{\n\t\t\t\t\tawait this.$nextTick();\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll to bottom', chatId, threshold);\n\t\t\tif (threshold === DialogScrollThreshold.halfScreenUp && this.isScrolledUp)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (threshold === DialogScrollThreshold.nearTheBottom && !this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this.$nextTick();\n\t\t\tif (animation)\n\t\t\t{\n\t\t\t\tthis.getScrollManager().animatedScrollToBottom();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t},\n\t\tonGoToMessageContext(event: BaseEvent)\n\t\t{\n\t\t\tconst { dialogId, messageId } = event.getData();\n\t\t\tif (this.dialog.dialogId !== dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageClick(messageId: number)\n\t\t{\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageUnpin(messageId: number)\n\t\t{\n\t\t\tthis.getMessageService().unpinMessage(this.dialog.chatId, messageId);\n\t\t},\n\t\tonScroll(event: Event)\n\t\t{\n\t\t\tthis.closeDialogPopups();\n\t\t\tthis.debouncedScrollHandler(event);\n\t\t},\n\t\tasync onScrollButtonClick()\n\t\t{\n\t\t\tif (this.getScrollManager().scrollButtonClicked)\n\t\t\t{\n\t\t\t\tthis.handleSecondScrollButtonClick();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollButtonClicked = true;\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\tif (!firstUnreadId)\n\t\t\t{\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t\t}\n\n\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t},\n\t\tonWindowFocus()\n\t\t{\n\t\t\tthis.windowFocused = true;\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonWindowBlur()\n\t\t{\n\t\t\tthis.windowFocused = false;\n\t\t},\n\t\tonCallFold()\n\t\t{\n\t\t\tconst callDialogId = CallManager.getInstance().getCurrentCallDialogId();\n\t\t\tif (callDialogId !== this.dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonChatClick(event: PointerEvent)\n\t\t{\n\t\t\tif (this.isGuest)\n\t\t\t{\n\t\t\t\tevent.stopPropagation();\n\t\t\t}\n\t\t},\n\t\tasync onShowQuoteButton(message: ImModelMessage, event: MouseEvent)\n\t\t{\n\t\t\tthis.showQuoteButton = true;\n\t\t\tawait this.$nextTick();\n\t\t\tthis.$refs.quoteButton.onMessageMouseUp(message, event);\n\t\t},\n\t\thandleSecondScrollButtonClick()\n\t\t{\n\t\t\tthis.getScrollManager().scrollButtonClicked = false;\n\t\t\tif (this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\tthis.getMessageService().loadContext(this.dialog.lastMessageId).then(() => {\n\t\t\t\t\tEventEmitter.emit(EventType.dialog.scrollToBottom, {\n\t\t\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\t\t});\n\t\t\t\t}).catch((error) => {\n\t\t\t\t\tLogger.error('ChatDialog: scroll to chat end loadContext error', error);\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId);\n\t\t},\n\t\t/* endregion Event handlers */\n\t\thasVisibleCall(): boolean\n\t\t{\n\t\t\treturn CallManager.getInstance().hasVisibleCall();\n\t\t},\n\t\tcloseDialogPopups()\n\t\t{\n\t\t\tthis.showQuoteButton = false;\n\t\t\tPopupManager.getPopupById(PopupType.dialogAvatarMenu)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogMessageMenu)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReactionUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReadUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.messageBaseFileMenu)?.close();\n\t\t},\n\t\tsubscribeToEvents()\n\t\t{\n\t\t\tEventEmitter.subscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.subscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.subscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.subscribe(EventType.dialog.showForwardPopup, this.onShowForwardPopup);\n\n\t\t\tEvent.bind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.bind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tunsubscribeFromEvents()\n\t\t{\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.unsubscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.showForwardPopup, this.onShowForwardPopup);\n\n\t\t\tEvent.unbind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.unbind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tgetContainer(): ?HTMLElement\n\t\t{\n\t\t\treturn this.$refs.container;\n\t\t},\n\t\tonShowForwardPopup(event: BaseEvent)\n\t\t{\n\t\t\tconst { messageId } = event.getData();\n\t\t\tthis.forwardPopup.messageId = messageId;\n\t\t\tthis.forwardPopup.show = true;\n\t\t},\n\t\tonCloseForwardPopup()\n\t\t{\n\t\t\tthis.forwardPopup.messageId = 0;\n\t\t\tthis.forwardPopup.show = false;\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__block bx-im-dialog-chat__scope\">\n\t\t\t<PinnedMessages\n\t\t\t\tv-if=\"pinnedMessages.length > 0\"\n\t\t\t\t:messages=\"pinnedMessages\"\n\t\t\t\t@messageClick=\"onPinnedMessageClick\"\n\t\t\t\t@messageUnpin=\"onPinnedMessageUnpin\"\n\t\t\t/>\n\t\t\t<PullStatus/>\n\t\t\t<div @scroll=\"onScroll\" @click.capture=\"onChatClick\" class=\"bx-im-dialog-chat__scroll-container\" ref=\"container\">\n\t\t\t\t<component\n\t\t\t\t\t:is=\"messageListComponent\"\n\t\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t\t:messages=\"messageCollection\"\n\t\t\t\t\t:observer=\"getObserverManager()\"\n\t\t\t\t\t@readMessages=\"debouncedReadHandler\"\n\t\t\t\t\t@showQuoteButton=\"onShowQuoteButton\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<Transition name=\"scroll-button-transition\">\n\t\t\t\t<div v-if=\"showScrollButton\" @click=\"onScrollButtonClick\" class=\"bx-im-dialog-chat__scroll-button\">\n\t\t\t\t\t<div v-if=\"dialog.counter\" class=\"bx-im-dialog-chat__scroll-button_counter\">{{ formattedCounter }}</div>\n\t\t\t\t</div>\n\t\t\t</Transition>\n\t\t\t<ForwardPopup\n\t\t\t\t:showPopup=\"forwardPopup.show\"\n\t\t\t\t:messageId=\"forwardPopup.messageId\"\n\t\t\t\t@close=\"onCloseForwardPopup\"\n\t\t\t/>\n\t\t\t<Transition name=\"fade-up\">\n\t\t\t\t<QuoteButton \n\t\t\t\t\tv-if=\"showQuoteButton\" \n\t\t\t\t\tref=\"quoteButton\"\n\t\t\t\t\t@close=\"showQuoteButton = false\" \n\t\t\t\t\tclass=\"bx-im-message-base__quote-button\" \n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t</div>\n\t`,\n};\n"],"names":["EVENT_NAMESPACE","SCROLLING_THRESHOLD","POSITION_THRESHOLD","SCROLLED_UP_THRESHOLD","ScrollManager","EventEmitter","constructor","isScrolling","currentScroll","lastScroll","chatIsScrolledUp","scrollButtonClicked","setEventNamespace","setContainer","container","onScroll","event","target","scrollTop","isScrollingDown","isScrollingUp","leftSpaceBottom","scrollHeight","clientHeight","emit","events","onScrollTriggerDown","onScrollTriggerUp","checkIfChatIsScrolledUp","availableScrollHeight","newFlag","onScrollThresholdPass","scrollToBottom","Logger","warn","forceScrollTo","animatedScrollToBottom","animatedScrollTo","scrollToMessage","messageId","offset","element","getDomElementById","position","offsetTop","animatedScrollToMessage","cancelAnimatedScroll","scroll","top","behavior","adjustScrollOnHistoryAddition","oldContainerHeight","newContainerHeight","newScrollPosition","Promise","resolve","Animation","start","end","elementProperty","callback","cancel","isAtTheTop","isAtTheBottom","isAroundBottom","id","querySelector","ObserverManager","Set","setDialogInited","flag","Object","values","forEach","unobserveMessage","observeMessage","messageElement","observe","dataset","unobserve","onReadMessage","delete","getMessagesToRead","getFirstVisibleMessage","size","firstVisibleMessage","sort","a","b","IntersectionObserver","entries","entry","rootBounds","messageIsFullyVisible","isIntersecting","intersectionRatio","messageTakesHalfOfViewport","intersectionRect","height","add","onMessageIsVisible","threshold","Array","from","length","fill","map","zero","index","TAG_PREFIX","PullWatchManager","dialogId","Core","getStore","getters","getPullClient","onChatLoad","extendWatch","chatId","onChatExit","clearWatch","onLoadedChatEnter","runAction","RestMethod","imV2ChatExtendPullWatch","data","role","UserRole","guest","PinnedMessage","props","message","type","required","computed","internalMessage","text","Parser","purifyMessage","authorId","author","$store","template","PinnedMessages","components","messages","emits","firstMessage","messagesToShow","slice","methods","loc","phraseCode","$Bitrix","Loc","getMessage","CONTAINER_HEIGHT","CONTAINER_WIDTH","CONTAINER_OFFSET","slider","MessengerSlider","getInstance","getCurrent","sliderRect","layout","getBoundingClientRect","offsetY","MESSAGE_TEXT_NODE_CLASS","QuoteButton","name","mouseX","mouseY","containerStyle","left","width","mounted","Event","bind","window","onMouseDown","onMessageMouseUp","button","prepareSelectedText","clientX","clientY","$refs","contains","$emit","Utils","browser","isFirefox","getSelection","toString","range","getRangeAt","rangeContents","cloneContents","nodesToIterate","childNodes","messageNode","node","isImage","getAttribute","isLineBreak","textContent","HTMLElement","tagName","toLowerCase","nodeName","isText","isMessageTextNode","textNode","matches","Boolean","extractTextFromMessageNode","onQuoteClick","Quote","sendQuoteEvent","FLOATING_DATE_OFFSET","LOAD_MESSAGE_ON_EXIT_DELAY","ChatDialog","MessageList","PullStatus","ForwardPopup","String","default","textareaHeight","Number","forwardPopup","show","contextMode","active","messageIsLoaded","initialScrollCompleted","isScrolledUp","windowFocused","showQuoteButton","selectedText","quoteButtonStyles","quoteButtonMessage","dialog","dialogInited","inited","messageCollection","pinnedMessages","isOpened","openedDialogId","entityId","isGuest","debouncedScrollHandler","SCROLLING_DEBOUNCE_DELAY","Runtime","debounce","getScrollManager","debouncedReadHandler","readVisibleMessages","formattedCounter","counter","messageListComponent","showScrollButton","hasNextPage","watch","newValue","oldValue","getPullWatchManager","onChatInited","$nextTick","created","initObserverManager","initContextMode","getContainer","scrollOnStart","document","hasFocus","subscribeToEvents","beforeUnmount","unsubscribeFromEvents","saveScrollPosition","loadMessagesOnExit","closeDialogPopups","hasVisibleCall","getObserverManager","getChatService","readMessage","contextId","highlightMessage","goToMessageContext","markedId","BlockType","newMessages","savedPositionMessageId","hasMessage","getMessageService","loadContext","catch","error","HIGHLIGHT_CLASS","HIGHLIGHT_DURATION","Dom","addClass","setTimeout","removeClass","dispatch","fields","reloadMessageList","observerManager","subscribe","messageService","MessageService","chatService","ChatService","scrollManager","getData","pullWatchManager","loading","clearDialogMark","EventType","onDialogInited","oldHeight","hasPreparedHistoryMessages","drawPreparedHistoryMessages","isLoading","hasPrevPage","loadHistory","hasPreparedUnreadMessages","drawPreparedUnreadMessages","loadUnread","onScrollToBottom","DialogScrollThreshold","halfScreenUp","animation","firstUnreadId","nearTheBottom","onGoToMessageContext","onPinnedMessageClick","onPinnedMessageUnpin","unpinMessage","onScrollButtonClick","handleSecondScrollButtonClick","loadInitialMessages","onWindowFocus","onWindowBlur","onCallFold","callDialogId","CallManager","getCurrentCallDialogId","onChatClick","stopPropagation","onShowQuoteButton","quoteButton","lastMessageId","then","PopupManager","getPopupById","PopupType","dialogAvatarMenu","close","dialogMessageMenu","dialogReactionUsers","dialogReadUsers","messageBaseFileMenu","call","onFold","showForwardPopup","onShowForwardPopup","unsubscribe","unbind","onCloseForwardPopup"],"mappings":"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"}