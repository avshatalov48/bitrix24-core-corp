{"version":3,"file":"chat-dialog.bundle.js","sources":["../src/classes/message-component-manager.js","../src/classes/scroll-manager.js","../src/classes/collection-manager.js","../src/classes/message-menu.js","../src/classes/avatar-menu.js","../src/classes/observer-manager.js","../src/classes/pull-watch-manager.js","../src/components/block/new-messages.js","../src/components/block/marked-messages.js","../src/components/block/date-group.js","../src/components/pinned/pinned-message.js","../src/components/pinned/pinned-messages.js","../src/classes/user-servlce.js","../src/components/additional-users.js","../src/components/dialog-status.js","../src/components/dialog-loader.js","../src/components/quote-button.js","../src/chat-dialog.js"],"sourcesContent":["import { MessageComponent } from 'im.v2.const';\nimport { Utils } from 'im.v2.lib.utils';\nimport { SmileManager } from 'im.v2.lib.smile-manager';\n\nimport type { ImModelMessage } from 'im.v2.model';\n\nexport class MessageComponentManager\n{\n\t#message: ImModelMessage;\n\n\tconstructor(message: ImModelMessage)\n\t{\n\t\tthis.#message = message;\n\t}\n\n\tgetName(): $Values<typeof MessageComponent>\n\t{\n\t\tif (this.#isDeletedMessage())\n\t\t{\n\t\t\treturn MessageComponent.deleted;\n\t\t}\n\n\t\tif (this.#isCallInviteMessage())\n\t\t{\n\t\t\treturn MessageComponent.callInvite;\n\t\t}\n\n\t\tif (this.#isUnsupportedMessage())\n\t\t{\n\t\t\treturn MessageComponent.unsupported;\n\t\t}\n\n\t\tif (this.#isChatCreationMessage())\n\t\t{\n\t\t\treturn MessageComponent.chatCreation;\n\t\t}\n\n\t\tif (this.#isConferenceCreationMessage())\n\t\t{\n\t\t\treturn MessageComponent.conferenceCreation;\n\t\t}\n\n\t\tif (this.#isSystemMessage())\n\t\t{\n\t\t\treturn MessageComponent.system;\n\t\t}\n\n\t\tif (this.#hasFiles())\n\t\t{\n\t\t\treturn MessageComponent.file;\n\t\t}\n\n\t\tif (this.#isEmojiOnly() || this.#hasSmilesOnly())\n\t\t{\n\t\t\treturn MessageComponent.smile;\n\t\t}\n\n\t\treturn MessageComponent.default;\n\t}\n\n\t#hasFiles(): boolean\n\t{\n\t\treturn this.#message.files.length > 0;\n\t}\n\n\t#hasText(): boolean\n\t{\n\t\treturn this.#message.text.length > 0;\n\t}\n\n\t#hasAttach(): boolean\n\t{\n\t\treturn this.#message.attach.length > 0;\n\t}\n\n\t#isEmptyMessage(): boolean\n\t{\n\t\treturn !this.#hasText() && !this.#hasFiles() && !this.#hasAttach();\n\t}\n\n\t#isDeletedMessage(): boolean\n\t{\n\t\treturn this.#message.isDeleted || this.#isEmptyMessage();\n\t}\n\n\t#isSystemMessage(): boolean\n\t{\n\t\treturn this.#message.authorId === 0;\n\t}\n\n\t#isUnsupportedMessage(): boolean\n\t{\n\t\treturn this.#message.componentId === MessageComponent.unsupported;\n\t}\n\n\t#isChatCreationMessage(): boolean\n\t{\n\t\treturn this.#message.componentId === MessageComponent.chatCreation;\n\t}\n\n\t#isConferenceCreationMessage(): boolean\n\t{\n\t\treturn this.#message.componentId === MessageComponent.conferenceCreation;\n\t}\n\n\t#isCallInviteMessage(): boolean\n\t{\n\t\treturn this.#message.componentId === MessageComponent.callInvite;\n\t}\n\n\t#isEmojiOnly(): boolean\n\t{\n\t\tif (this.#message.replyId > 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.#hasOnlyText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Utils.text.isEmojiOnly(this.#message.text);\n\t}\n\n\t#hasSmilesOnly(): boolean\n\t{\n\t\tif (this.#message.replyId > 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.#hasOnlyText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\t// todo: need to sync with getSmileRatio in lib/parser/src/functions/smile.js\n\t\tconst smileManager = SmileManager.getInstance();\n\t\tconst smiles = smileManager.smileList?.smiles ?? [];\n\t\tconst sortedSmiles = [...smiles].sort((a, b) => {\n\t\t\treturn b.typing.localeCompare(a.typing);\n\t\t});\n\t\tconst pattern = sortedSmiles.map((smile) => {\n\t\t\treturn Utils.text.escapeRegex(smile.typing);\n\t\t}).join('|');\n\n\t\tconst replacedText = this.#message.text.replaceAll(new RegExp(pattern, 'g'), '');\n\t\tconst hasOnlySmiles = replacedText.trim().length === 0;\n\n\t\tconst matchOnlySmiles = new RegExp(`(?:(?:${pattern})\\\\s*){4,}`);\n\n\t\treturn hasOnlySmiles && !matchOnlySmiles.test(this.#message.text);\n\t}\n\n\t#hasOnlyText(): boolean\n\t{\n\t\tif (!this.#hasText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn !this.#hasFiles() && !this.#hasAttach();\n\t}\n}\n","import {EventEmitter} from 'main.core.events';\n\nimport {Logger} from 'im.v2.lib.logger';\nimport {Animation} from 'im.v2.lib.animation';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ScrollManager';\nconst SCROLLING_THRESHOLD = 1500;\nconst POSITION_THRESHOLD = 40;\nconst SCROLLED_UP_THRESHOLD = 400;\n\nexport class ScrollManager extends EventEmitter\n{\n\tcontainer: HTMLElement;\n\tisScrolling: boolean = false;\n\tcurrentScroll: number = 0;\n\tlastScroll: number = 0;\n\tchatIsScrolledUp: boolean = false;\n\tscrollButtonClicked: boolean = false;\n\n\tstatic events = {\n\t\tonScrollTriggerUp: 'onScrollTriggerUp',\n\t\tonScrollTriggerDown: 'onScrollTriggerDown',\n\t\tonScrollThresholdPass: 'onScrollThresholdPass'\n\t};\n\n\tconstructor(): ScrollManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\t}\n\n\tsetContainer(container: HTMLElement)\n\t{\n\t\tthis.container = container;\n\t}\n\n\tonScroll(event: Event)\n\t{\n\t\t// if (this.isScrolling || !event.target || this.currentScroll === event.target.scrollTop)\n\t\tif (this.isScrolling || !event.target)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.currentScroll = event.target.scrollTop;\n\t\tconst isScrollingDown = this.lastScroll < this.currentScroll;\n\t\tconst isScrollingUp = !isScrollingDown;\n\t\tif (isScrollingUp)\n\t\t{\n\t\t\tthis.scrollButtonClicked = false;\n\t\t}\n\n\t\tconst leftSpaceBottom = event.target.scrollHeight - event.target.scrollTop - event.target.clientHeight;\n\t\tif (isScrollingDown && this.lastScroll > 0 && leftSpaceBottom < SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerDown);\n\t\t}\n\t\telse if (isScrollingUp && this.currentScroll <= SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerUp);\n\t\t}\n\n\t\tthis.lastScroll = this.currentScroll;\n\n\t\tthis.checkIfChatIsScrolledUp();\n\t}\n\n\tcheckIfChatIsScrolledUp()\n\t{\n\t\tconst availableScrollHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newFlag = this.currentScroll + SCROLLED_UP_THRESHOLD < availableScrollHeight;\n\t\tif (newFlag !== this.chatIsScrolledUp)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollThresholdPass, newFlag);\n\t\t}\n\t\tthis.chatIsScrolledUp = newFlag;\n\t}\n\n\tscrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to bottom');\n\t\tthis.forceScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tanimatedScrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to bottom');\n\t\tthis.animatedScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tscrollToMessage(messageId: number, offset: number = -10)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\tthis.forceScrollTo(position);\n\t}\n\n\tanimatedScrollToMessage(messageId: number, offset: number = -10): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = element.offsetTop + offset;\n\t\treturn this.animatedScrollTo(position);\n\t}\n\n\tforceScrollTo(position: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Force scroll to - ', position);\n\t\tthis.cancelAnimatedScroll();\n\t\tthis.container.scroll({top: position, behavior: 'instant'});\n\t}\n\n\tadjustScrollOnHistoryAddition(oldContainerHeight: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Adjusting scroll after history addition');\n\t\tconst newContainerHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newScrollPosition = this.container.scrollTop + newContainerHeight - oldContainerHeight;\n\t\tthis.forceScrollTo(newScrollPosition);\n\t}\n\n\tanimatedScrollTo(position: number): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Animated scroll to - ', position);\n\t\treturn new Promise((resolve) => {\n\t\t\tAnimation.start({\n\t\t\t\tstart: this.container.scrollTop,\n\t\t\t\tend: position,\n\t\t\t\telement: this.container,\n\t\t\t\telementProperty: 'scrollTop',\n\t\t\t\tcallback: () => {\n\t\t\t\t\tthis.checkIfChatIsScrolledUp();\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tcancelAnimatedScroll()\n\t{\n\t\tif (!this.isScrolling)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tAnimation.cancel();\n\t\tthis.isScrolling = false;\n\t}\n\n\tisAtTheTop(): boolean\n\t{\n\t\treturn this.container.scrollTop === 0;\n\t}\n\n\tisAtTheBottom(): boolean\n\t{\n\t\treturn this.container.scrollTop + this.container.clientHeight >= this.container.scrollHeight;\n\t}\n\n\tisAroundBottom(): boolean\n\t{\n\t\treturn this.container.scrollHeight - this.container.scrollTop - this.container.clientHeight < POSITION_THRESHOLD;\n\t}\n\n\tgetDomElementById(id: number | string): ?HTMLElement\n\t{\n\t\treturn this.container.querySelector(`[data-id=\"${id}\"]`);\n\t}\n}","import { Core } from 'im.v2.application.core';\nimport { DialogBlockType as BlockType, MessageType, Settings, DialogAlignment } from 'im.v2.const';\nimport { DateFormatter, DateTemplate } from 'im.v2.lib.date-formatter';\n\nimport type { ImModelMessage, ImModelDialog } from 'im.v2.model';\n\nexport type FormattedCollectionItem = {\n\ttype: BlockType.dateGroup,\n\tdate: {\n\t\tid: string,\n\t\ttitle: string\n\t},\n\titems: Array<AuthorGroupItem | NewMessagesItem>\n};\n\ntype AuthorGroupItem = {\n\ttype: BlockType.authorGroup,\n\tuserId: number,\n\tmessageType: MessageType.opponent | MessageType.self | MessageType.system,\n\tavatar: {\n\t\tisNeeded: boolean,\n\t\tavatarId: string\n\t},\n\titems: ImModelMessage[]\n};\n\ntype NewMessagesItem = {\n\ttype: BlockType.newMessages\n};\n\nexport class CollectionManager\n{\n\tstore: Object;\n\tdialogId: number;\n\tfirstIteration: boolean = true;\n\tinitialLastReadMessage: boolean;\n\tinitialMarkedId: boolean;\n\tcachedDateGroups: {\n\t\tid: number,\n\t\ttitle: string\n\t} = {};\n\n\tconstructor(dialogId)\n\t{\n\t\tthis.store = Core.getStore();\n\t\tthis.dialogId = dialogId;\n\t}\n\n\tformatMessageCollection(messageCollection: ImModelMessage[]): FormattedCollectionItem[]\n\t{\n\t\tconst dateGroups = {};\n\t\tconst collection = [];\n\t\tlet lastDateItems = null;\n\t\tlet lastAuthorId = null;\n\t\tlet lastAuthorItems = null;\n\n\t\tconst dialog: ImModelDialog = this.store.getters['dialogues/get'](this.dialogId);\n\t\tconst { markedId, inited } = dialog;\n\t\tlet markInserted = false;\n\t\tconst lastReadId = this.store.getters['dialogues/getLastReadId'](this.dialogId);\n\n\t\tif (this.firstIteration)\n\t\t{\n\t\t\tthis.initialLastReadMessage = lastReadId;\n\t\t\tthis.initialMarkedId = markedId;\n\t\t}\n\n\t\tif (markedId !== this.initialMarkedId && markedId !== 0)\n\t\t{\n\t\t\tthis.initialMarkedId = markedId;\n\t\t\tthis.initialLastReadMessage = null;\n\t\t}\n\n\t\tmessageCollection.forEach((message: ImModelMessage, index) => {\n\t\t\tconst dateGroup = this.getDateGroup(message.date);\n\t\t\t// new date = new date group + new author group\n\t\t\tif (!dateGroups[dateGroup.title])\n\t\t\t{\n\t\t\t\tdateGroups[dateGroup.title] = dateGroup.id;\n\t\t\t\tlastDateItems = [];\n\t\t\t\tcollection.push({\n\t\t\t\t\ttype: BlockType.dateGroup,\n\t\t\t\t\tdate: dateGroup,\n\t\t\t\t\titems: lastDateItems\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t}\n\n\t\t\t// marked messages\n\t\t\tif (message.id === this.initialMarkedId)\n\t\t\t{\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.markedMessages\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t\tmarkInserted = true;\n\t\t\t}\n\n\t\t\t// new author = new author group\n\t\t\tif (message.authorId !== lastAuthorId)\n\t\t\t{\n\t\t\t\tlastAuthorId = message.authorId;\n\t\t\t\tlastAuthorItems = [];\n\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.authorGroup,\n\t\t\t\t\tuserId: message.authorId,\n\t\t\t\t\tavatar: this.getAvatarConfig(message),\n\t\t\t\t\tmessageType: this.getMessageType(message),\n\t\t\t\t\titems: lastAuthorItems\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// add current message to last active author group\n\t\t\tlastAuthorItems.push(message);\n\n\t\t\t// new messages block\n\t\t\tconst isLastMessage = index === messageCollection.length - 1;\n\t\t\tif (!markInserted && !isLastMessage && message.id === this.initialLastReadMessage)\n\t\t\t{\n\t\t\t\tlastDateItems.push({\n\t\t\t\t\ttype: BlockType.newMessages\n\t\t\t\t});\n\t\t\t\tlastAuthorId = null;\n\t\t\t}\n\t\t});\n\n\t\tif (inited)\n\t\t{\n\t\t\tthis.firstIteration = false;\n\t\t}\n\n\n\t\treturn collection;\n\t}\n\n\tgetDateGroup(date: Date): {id: number, title: string}\n\t{\n\t\tconst INDEX_BETWEEN_DATE_AND_TIME = 10;\n\t\t// 2022-10-25T14:58:44.000Z => 2022-10-25\n\t\tconst shortDate = date.toJSON().slice(0, INDEX_BETWEEN_DATE_AND_TIME);\n\t\tif (this.cachedDateGroups[shortDate])\n\t\t{\n\t\t\treturn this.cachedDateGroups[shortDate];\n\t\t}\n\n\t\tthis.cachedDateGroups[shortDate] = {\n\t\t\tid: shortDate,\n\t\t\ttitle: DateFormatter.formatByTemplate(date, DateTemplate.dateGroup)\n\t\t};\n\n\t\treturn this.cachedDateGroups[shortDate];\n\t}\n\n\tgetAvatarConfig(message: ImModelMessage): {isNeeded: boolean, avatarId: string}\n\t{\n\t\tconst messageType = this.getMessageType(message);\n\t\tconst isSystem = messageType === MessageType.system;\n\t\tconst isSelf = messageType === MessageType.self;\n\n\t\tconst alignment = this.store.getters['application/settings/get'](Settings.appearance.alignment);\n\t\tlet isNeeded = true;\n\t\tif (alignment === DialogAlignment.left)\n\t\t{\n\t\t\tisNeeded = !isSystem;\n\t\t}\n\t\telse if (alignment === DialogAlignment.center)\n\t\t{\n\t\t\tisNeeded = !isSelf && !isSystem;\n\t\t}\n\n\t\treturn {\n\t\t\tisNeeded,\n\t\t\tavatarId: message.authorId.toString(),\n\t\t};\n\t}\n\n\tgetMessageType(message: ImModelMessage): string\n\t{\n\t\tif (!message.authorId)\n\t\t{\n\t\t\treturn MessageType.system;\n\t\t}\n\n\t\tif (message.authorId === Core.getUserId())\n\t\t{\n\t\t\treturn MessageType.self;\n\t\t}\n\n\t\treturn MessageType.opponent;\n\t}\n}\n","import { Loc } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { BaseMenu } from 'im.v2.lib.menu';\nimport { Parser } from 'im.v2.lib.parser';\nimport { EntityCreator } from 'im.v2.lib.entity-creator';\nimport { MessageService, DiskService } from 'im.v2.provider.service';\nimport { EventType, PlacementType } from 'im.v2.const';\nimport { MarketManager } from 'im.v2.lib.market';\nimport { Utils } from 'im.v2.lib.utils';\n\nimport 'ui.notification';\n\nimport type { MenuItem } from 'im.v2.lib.menu';\nimport type { ImModelMessage, ImModelDialog, ImModelFile } from 'im.v2.model';\n\nexport class MessageMenu extends BaseMenu\n{\n\tcontext: ImModelMessage & {dialogId: string};\n\tdiskService: DiskService;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis.id = 'bx-im-message-context-menu';\n\t\tthis.diskService = new DiskService();\n\t\tthis.marketManager = MarketManager.getInstance();\n\t}\n\n\tgetMenuOptions(): Object\n\t{\n\t\treturn {\n\t\t\t...super.getMenuOptions(),\n\t\t\tclassName: this.getMenuClassName(),\n\t\t\tangle: true,\n\t\t\toffsetLeft: 11,\n\t\t};\n\t}\n\n\tgetMenuItems(): MenuItem[]\n\t{\n\t\treturn [\n\t\t\tthis.getReplyItem(),\n\t\t\tthis.getCopyItem(),\n\t\t\tthis.getDelimiter(),\n\n\t\t\tthis.getDownloadFileItem(),\n\t\t\tthis.getSaveToDisk(),\n\t\t\tthis.getPinItem(),\n\t\t\tthis.getFavoriteItem(),\n\t\t\tthis.getMarkItem(),\n\t\t\tthis.getDelimiter(),\n\n\t\t\tthis.getCreateItem(),\n\t\t\tthis.getDelimiter(),\n\n\t\t\tthis.getEditItem(),\n\t\t\tthis.getDelimiter(),\n\n\t\t\tthis.getDeleteItem(),\n\t\t];\n\t}\n\n\tgetReplyItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_REPLY'),\n\t\t\tonclick: () => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.replyMessage, {\n\t\t\t\t\tmessageId: this.context.id,\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetCopyItem(): ?MenuItem\n\t{\n\t\tif (this.context.files.length === 0)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_COPY_FILE'),\n\t\t\tonclick: () => {\n\t\t\t\tconst textToCopy = Parser.prepareCopy(this.context);\n\t\t\t\tif (BX.clipboard?.copy(textToCopy))\n\t\t\t\t{\n\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage('IM_DIALOG_CHAT_MENU_COPY_FILE_SUCCESS'),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetPinItem(): MenuItem\n\t{\n\t\tif (this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst isPinned = this.store.getters['messages/pin/isPinned']({\n\t\t\tchatId: this.context.chatId,\n\t\t\tmessageId: this.context.id,\n\t\t});\n\n\t\treturn {\n\t\t\ttext: isPinned ? Loc.getMessage('IM_DIALOG_CHAT_MENU_UNPIN') : Loc.getMessage('IM_DIALOG_CHAT_MENU_PIN'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({ chatId: this.context.chatId });\n\t\t\t\tif (isPinned)\n\t\t\t\t{\n\t\t\t\t\tmessageService.unpinMessage(this.context.chatId, this.context.id);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmessageService.pinMessage(this.context.chatId, this.context.id);\n\t\t\t\t}\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetFavoriteItem(): MenuItem\n\t{\n\t\tif (this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst isInFavorite = this.store.getters['sidebar/favorites/isFavoriteMessage'](this.context.chatId, this.context.id);\n\n\t\tconst menuItemText = isInFavorite\n\t\t\t? Loc.getMessage('IM_DIALOG_CHAT_MENU_REMOVE_FROM_SAVED')\n\t\t\t: Loc.getMessage('IM_DIALOG_CHAT_MENU_SAVE')\n\t\t;\n\n\t\treturn {\n\t\t\ttext: menuItemText,\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({ chatId: this.context.chatId });\n\t\t\t\tif (isInFavorite)\n\t\t\t\t{\n\t\t\t\t\tmessageService.removeMessageFromFavorite(this.context.id);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmessageService.addMessageToFavorite(this.context.id);\n\t\t\t\t}\n\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetMarkItem(): ?MenuItem\n\t{\n\t\tconst canUnread = this.context.viewed && !this.#isOwnMessage();\n\n\t\tconst dialog: ImModelDialog = this.store.getters['dialogues/getByChatId'](this.context.chatId);\n\t\tconst isMarked = this.context.id === dialog.markedId;\n\t\tif (!canUnread || isMarked)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_MARK'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({ chatId: this.context.chatId });\n\t\t\t\tmessageService.markMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetCreateItem(): MenuItem\n\t{\n\t\tif (this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE'),\n\t\t\titems: [\n\t\t\t\tthis.getCreateTaskItem(),\n\t\t\t\tthis.getCreateMeetingItem(),\n\t\t\t\t...this.getMarketItems(),\n\t\t\t],\n\t\t};\n\t}\n\n\tgetCreateTaskItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE_TASK'),\n\t\t\tonclick: () => {\n\t\t\t\tconst entityCreator = new EntityCreator(this.context.chatId);\n\t\t\t\tvoid entityCreator.createTaskForMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetCreateMeetingItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_CREATE_MEETING'),\n\t\t\tonclick: () => {\n\t\t\t\tconst entityCreator = new EntityCreator(this.context.chatId);\n\t\t\t\tvoid entityCreator.createMeetingForMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetEditItem(): ?MenuItem\n\t{\n\t\tif (!this.#isOwnMessage() || this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_EDIT'),\n\t\t\tonclick: () => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.editMessage, {\n\t\t\t\t\tmessageId: this.context.id,\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetDeleteItem(): ?MenuItem\n\t{\n\t\tif (!this.#isOwnMessage() || this.#isDeletedMessage())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_DELETE'),\n\t\t\tonclick: () => {\n\t\t\t\tconst messageService = new MessageService({ chatId: this.context.chatId });\n\t\t\t\tmessageService.deleteMessage(this.context.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetMarketItems(): MenuItem[]\n\t{\n\t\tconst { dialogId, id } = this.context;\n\t\tconst placements = this.marketManager.getAvailablePlacementsByType(PlacementType.contextMenu, dialogId);\n\t\tconst marketMenuItem = [];\n\t\tif (placements.length > 0)\n\t\t{\n\t\t\tmarketMenuItem.push(this.getDelimiter());\n\t\t}\n\n\t\tconst context = { messageId: id, dialogId };\n\n\t\tplacements.forEach((placement) => {\n\t\t\tmarketMenuItem.push({\n\t\t\t\ttext: placement.title,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tMarketManager.openSlider(placement, context);\n\t\t\t\t\tthis.menuInstance.close();\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\n\t\t// (10 items + 1 delimiter), because we don't want to show long context menu.\n\t\tconst itemLimit = 11;\n\n\t\treturn marketMenuItem.slice(0, itemLimit);\n\t}\n\n\tgetDownloadFileItem(): ?MenuItem\n\t{\n\t\tconst file = this.#getMessageFile();\n\t\tif (!file)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\thtml: Utils.file.createDownloadLink(\n\t\t\t\tLoc.getMessage('IM_DIALOG_CHAT_MENU_DOWNLOAD_FILE'),\n\t\t\t\tfile.urlDownload,\n\t\t\t\tfile.name,\n\t\t\t),\n\t\t\tonclick: function() {\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}.bind(this),\n\t\t};\n\t}\n\n\tgetSaveToDisk(): ?MenuItem\n\t{\n\t\tconst file = this.#getMessageFile();\n\t\tif (!file)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_CHAT_MENU_SAVE_ON_DISK'),\n\t\t\tonclick: function() {\n\t\t\t\tvoid this.diskService.save(file.id).then(() => {\n\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage('IM_DIALOG_CHAT_MENU_SAVE_ON_DISK_SUCCESS'),\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t}.bind(this),\n\t\t};\n\t}\n\n\tgetDelimiter(): MenuItem\n\t{\n\t\treturn {\n\t\t\tdelimiter: true,\n\t\t};\n\t}\n\n\t#isOwnMessage(): boolean\n\t{\n\t\treturn this.context.authorId === Core.getUserId();\n\t}\n\n\t#isDeletedMessage(): boolean\n\t{\n\t\treturn this.context.isDeleted;\n\t}\n\n\t#getMessageFile(): ?ImModelFile\n\t{\n\t\tif (this.context.files.length === 0)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\t// for now, we have only one file in one message. In the future we need to change this logic.\n\t\treturn this.store.getters['files/get'](this.context.files[0]);\n\t}\n}\n","import { Loc } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nimport { Messenger } from 'im.public';\nimport { BaseMenu } from 'im.v2.lib.menu';\nimport { PermissionManager } from 'im.v2.lib.permission';\nimport { EventType, ChatActionType } from 'im.v2.const';\nimport { Utils } from 'im.v2.lib.utils';\nimport { showKickUserConfirm } from 'im.v2.lib.confirm';\nimport { ChatService } from 'im.v2.provider.service';\n\nimport type { ImModelUser, ImModelDialog } from 'im.v2.model';\nimport type { MenuItem } from 'im.v2.lib.menu';\n\ntype AvatarMenuContext = {\n\tuser: ImModelUser,\n\tdialog: ImModelDialog\n};\n\nexport class AvatarMenu extends BaseMenu\n{\n\tcontext: AvatarMenuContext;\n\tpermissionManager: PermissionManager;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis.id = 'bx-im-avatar-context-menu';\n\t\tthis.permissionManager = PermissionManager.getInstance();\n\t}\n\n\tgetMenuOptions(): Object\n\t{\n\t\treturn {\n\t\t\t...super.getMenuOptions(),\n\t\t\tclassName: this.getMenuClassName(),\n\t\t\tangle: true,\n\t\t\toffsetLeft: 21,\n\t\t};\n\t}\n\n\tgetMenuItems(): MenuItem[]\n\t{\n\t\treturn [\n\t\t\tthis.getMentionItem(),\n\t\t\tthis.getSendItem(),\n\t\t\tthis.getProfileItem(),\n\t\t\tthis.getKickItem(),\n\t\t];\n\t}\n\n\tgetMentionItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_MENTION_2'),\n\t\t\tonclick: () => {\n\t\t\t\tEventEmitter.emit(EventType.textarea.insertMention, {\n\t\t\t\t\tmentionText: this.context.user.name,\n\t\t\t\t\tmentionReplacement: Utils.text.getMentionBbCode(this.context.user.id, this.context.user.name),\n\t\t\t\t});\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetSendItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_SEND_MESSAGE'),\n\t\t\tonclick: () => {\n\t\t\t\tMessenger.openChat(this.context.user.id);\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetProfileItem(): MenuItem\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_OPEN_PROFILE'),\n\t\t\thref: Utils.user.getProfileLink(this.context.user.id),\n\t\t\tonclick: () => {\n\t\t\t\tthis.menuInstance.close();\n\t\t\t},\n\t\t};\n\t}\n\n\tgetKickItem(): ?MenuItem\n\t{\n\t\tconst canKick = this.permissionManager.canPerformKick(this.context.dialog.dialogId, this.context.user.id);\n\t\tif (!canKick)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\ttext: Loc.getMessage('IM_DIALOG_AVATAR_MENU_KICK'),\n\t\t\tonclick: async () => {\n\t\t\t\tthis.menuInstance.close();\n\t\t\t\tconst userChoice = await showKickUserConfirm();\n\t\t\t\tif (userChoice === true)\n\t\t\t\t{\n\t\t\t\t\tconst chatService = new ChatService();\n\t\t\t\t\tchatService.kickUserFromChat(this.context.dialog.dialogId, this.context.user.id);\n\t\t\t\t}\n\t\t\t},\n\t\t};\n\t}\n}\n","import 'main.polyfill.intersectionobserver';\nimport {EventEmitter} from 'main.core.events';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ObserverManager';\n\nexport class ObserverManager extends EventEmitter\n{\n\t#observer: IntersectionObserver;\n\t#observedElements: {[messageId: string]: HTMLElement} = {};\n\t#visibleMessages: Set = new Set();\n\t#messagesToRead: Set = new Set();\n\t#dialogInited: boolean = false;\n\n\tstatic events = {\n\t\tonMessageIsVisible: 'onMessageIsVisible'\n\t};\n\n\tconstructor(): ObserverManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tthis.#initObserver();\n\t}\n\n\tsetDialogInited(flag: boolean)\n\t{\n\t\tObject.values(this.#observedElements).forEach(element => {\n\t\t\tthis.unobserveMessage(element);\n\t\t\tthis.observeMessage(element);\n\t\t});\n\n\t\tthis.#dialogInited = flag;\n\t}\n\n\tobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.observe(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tthis.#observedElements[messageElement.dataset.id] = messageElement;\n\t\t}\n\t}\n\n\tunobserveMessage(messageElement: HTMLElement)\n\t{\n\t\tthis.#observer.unobserve(messageElement);\n\t\tif (this.#getMessageIdFromElement(messageElement))\n\t\t{\n\t\t\tdelete this.#observedElements[messageElement.dataset.id];\n\t\t}\n\t}\n\n\tonReadMessage(messageId: number)\n\t{\n\t\tthis.#messagesToRead.delete(messageId);\n\t}\n\n\tgetMessagesToRead(): number[]\n\t{\n\t\treturn [...this.#messagesToRead];\n\t}\n\n\tgetFirstVisibleMessage(): number\n\t{\n\t\tif (this.#visibleMessages.size === 0)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst [firstVisibleMessage] = [...this.#visibleMessages].sort((a, b) => a - b);\n\n\t\treturn firstVisibleMessage;\n\t}\n\n\t#initObserver()\n\t{\n\t\tthis.#observer = new IntersectionObserver(((entries: IntersectionObserverEntry[]) => {\n\t\t\tentries.forEach((entry: IntersectionObserverEntry) => {\n\t\t\t\tconst messageId = this.#getMessageIdFromElement(entry.target);\n\t\t\t\tif (!messageId || !entry.rootBounds || !this.#dialogInited)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messageIsFullyVisible = entry.isIntersecting && entry.intersectionRatio >= 0.99;\n\t\t\t\tconst messageTakesHalfOfViewport = entry.intersectionRect.height >= entry.rootBounds.height / 2.2;\n\t\t\t\t// const messageIsBiggerThanViewport = entry.boundingClientRect.height + 20 > entry.rootBounds.height;\n\t\t\t\t// const messageCountsAsVisible = messageIsBiggerThanViewport && messageTakesMostOfViewport;\n\t\t\t\tif (messageIsFullyVisible || messageTakesHalfOfViewport)\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.add(messageId);\n\t\t\t\t\tif (!this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.add(messageId);\n\t\t\t\t\t\tthis.emit(ObserverManager.events.onMessageIsVisible);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#visibleMessages.delete(messageId);\n\t\t\t\t\tif (this.#messageIsViewed(entry.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#messagesToRead.delete(messageId);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}), {threshold: Array.from({length: 101}).fill(0).map((zero, index) => index * 0.01)});\n\t}\n\n\t#getMessageIdFromElement(messageElement: HTMLElement): number\n\t{\n\t\treturn +messageElement.dataset.id;\n\t}\n\n\t#messageIsViewed(messageElement: HTMLElement): boolean\n\t{\n\t\treturn messageElement.dataset['viewed'] === 'true';\n\t}\n}","import { Core } from 'im.v2.application.core';\nimport { UserRole, RestMethod } from 'im.v2.const';\nimport { runAction } from 'im.v2.lib.rest';\n\nimport type { ImModelDialog } from 'im.v2.model';\nimport type { PULL as Pull } from 'pull.client';\n\nconst TAG_PREFIX = 'IM_PUBLIC_';\n\nexport class PullWatchManager\n{\n\t#dialog: ImModelDialog;\n\t#pullClient: Pull;\n\n\tconstructor(dialogId: string)\n\t{\n\t\tthis.#dialog = Core.getStore().getters['dialogues/get'](dialogId);\n\t\tthis.#pullClient = Core.getPullClient();\n\t}\n\n\tonChatLoad()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#pullClient.extendWatch(`${TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\tonChatExit()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#pullClient.clearWatch(`${TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\tonLoadedChatEnter()\n\t{\n\t\tif (!this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#requestWatchStart();\n\t\tthis.#pullClient.extendWatch(`${TAG_PREFIX}${this.#dialog.chatId}`, true);\n\t}\n\n\t#requestWatchStart()\n\t{\n\t\trunAction(RestMethod.imV2ChatExtendPullWatch, {\n\t\t\tdata: {\n\t\t\t\tdialogId: this.#dialog.dialogId,\n\t\t\t},\n\t\t});\n\t}\n\n\t#isGuest(): boolean\n\t{\n\t\treturn this.#dialog.role === UserRole.guest && this.#dialog.dialogId !== 'settings';\n\t}\n}\n","// @vue/component\nexport const NewMessagesBlock = {\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__new-message-block\">\n\t\t\t<div class=\"bx-im-dialog-chat__new-message-block_text\">{{ loc('IM_DIALOG_CHAT_BLOCK_NEW_MESSAGES_2') }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const MarkedMessagesBlock = {\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__new-message-block\">\n\t\t\t<div class=\"bx-im-dialog-chat__new-message-block_text\">{{ loc('IM_DIALOG_CHAT_BLOCK_MARKED_MESSAGES') }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const DateGroupTitle = {\n\tprops:\n\t{\n\t\ttitle: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__date-group_title_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__date-group_title\">{{ title }}</div>\n\t\t</div>\n\t`\n};","import {Parser} from 'im.v2.lib.parser';\n\nimport type {ImModelUser, ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessage = {\n\tprops:\n\t{\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tinternalMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.message;\n\t\t},\n\t\ttext(): string\n\t\t{\n\t\t\treturn Parser.purifyMessage(this.internalMessage);\n\t\t},\n\t\tauthorId(): number\n\t\t{\n\t\t\treturn this.internalMessage.authorId;\n\t\t},\n\t\tauthor(): ImModelUser\n\t\t{\n\t\t\treturn this.$store.getters['users/get'](this.authorId);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__pinned_item\">\n\t\t\t<span v-if=\"author\" class=\"bx-im-dialog-chat__pinned_item_user\">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`\n};","import {PinnedMessage} from './pinned-message';\n\nimport '../../css/pinned-messages.css';\n\nimport type {ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessages = {\n\tcomponents: {PinnedMessage},\n\tprops:\n\t{\n\t\tmessages: {\n\t\t\ttype: Array,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['messageClick', 'messageUnpin'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tfirstMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.messagesToShow[0];\n\t\t},\n\t\tmessagesToShow(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.messages.slice(-1);\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div @click=\"$emit('messageClick', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__pinned_title\">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for=\"message in messagesToShow\"\n\t\t\t\t:message=\"message\"\n\t\t\t\t:key=\"message.id\"\n\t\t\t\t@click=\"$emit('messageClick', message.id)\"\n\t\t\t/>\n\t\t\t<div @click.stop=\"$emit('messageUnpin', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_unpin\"></div>\n\t\t</div>\n\t`\n};","import {Core} from 'im.v2.application.core';\nimport {RestMethod} from 'im.v2.const';\nimport {UserManager} from 'im.v2.lib.user';\nimport {Logger} from 'im.v2.lib.logger';\n\nimport type {Store} from 'ui.vue3.vuex';\nimport type {RestClient} from 'rest.client';\n\nexport class UserService\n{\n\t#store: Store;\n\t#restClient: RestClient;\n\t#userManager: UserManager;\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#userManager = new UserManager();\n\t}\n\n\tloadReadUsers(messageId): Promise<number[]>\n\t{\n\t\tlet users = [];\n\t\tLogger.warn('Dialog: UserService: loadReadUsers', messageId);\n\t\treturn this.#restClient.callMethod(RestMethod.imV2ChatMessageTailViewers, {id: messageId})\n\t\t\t.then(response => {\n\t\t\t\tusers = response.data().users;\n\t\t\t\treturn this.#userManager.setUsersToModel(Object.values(users));\n\t\t\t})\n\t\t\t.then(() => {\n\t\t\t\treturn users.map(user => user.id);\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tconsole.error('Dialog: UserService: loadReadUsers error', error);\n\t\t\t\tthrow new Error(error);\n\t\t\t});\n\t}\n}","import {Core} from 'im.v2.application.core';\nimport {UserListPopup} from 'im.v2.component.elements';\n\nimport {UserService} from '../classes/user-servlce';\n\nimport type {ImModelDialog} from 'im.v2.model';\n\n// @vue/component\nexport const AdditionalUsers = {\n\tcomponents: {UserListPopup},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t},\n\t\tshow: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t},\n\t\tbindElement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['close'],\n\tdata()\n\t{\n\t\treturn {\n\t\t\tshowPopup: false,\n\t\t\tloadingAdditionalUsers: false,\n\t\t\tadditionalUsers: []\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t},\n\twatch:\n\t{\n\t\tshow(newValue, oldValue)\n\t\t{\n\t\t\tif (!oldValue && newValue)\n\t\t\t{\n\t\t\t\tthis.showPopup = true;\n\t\t\t\tthis.loadUsers();\n\t\t\t}\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloadUsers()\n\t\t{\n\t\t\tthis.loadingAdditionalUsers = true;\n\t\t\tthis.getUserService().loadReadUsers(this.dialog.lastMessageId)\n\t\t\t\t.then(userIds => {\n\t\t\t\t\tthis.additionalUsers = this.prepareAdditionalUsers(userIds);\n\t\t\t\t\tthis.loadingAdditionalUsers = false;\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tthis.loadingAdditionalUsers = false;\n\t\t\t\t});\n\t\t},\n\t\tonPopupClose()\n\t\t{\n\t\t\tthis.showPopup = false;\n\t\t\tthis.$emit('close');\n\t\t},\n\t\tprepareAdditionalUsers(userIds: number[]): number[]\n\t\t{\n\t\t\tconst firstViewerId = this.dialog.lastMessageViews.firstViewer.userId;\n\n\t\t\treturn userIds.filter(userId => {\n\t\t\t\treturn userId !== Core.getUserId() && userId !== firstViewerId;\n\t\t\t});\n\t\t},\n\t\tgetUserService(): UserService\n\t\t{\n\t\t\tif (!this.userService)\n\t\t\t{\n\t\t\t\tthis.userService = new UserService();\n\t\t\t}\n\n\t\t\treturn this.userService;\n\t\t},\n\t},\n\ttemplate: `\n\t\t<UserListPopup\n\t\t\tid=\"bx-im-dialog-read-users\"\n\t\t\t:showPopup=\"showPopup\"\n\t\t\t:loading=\"loadingAdditionalUsers\"\n\t\t\t:userIds=\"additionalUsers\"\n\t\t\t:bindElement=\"bindElement || {}\"\n\t\t\t:withAngle=\"false\"\n\t\t\t:forceTop=\"true\"\n\t\t\t@close=\"onPopupClose\"\n\t\t/>\n\t`\n};","import {Text} from 'main.core';\n\nimport {DialogType} from 'im.v2.const';\nimport {DateFormatter, DateTemplate} from 'im.v2.lib.date-formatter';\n\nimport {AdditionalUsers} from './additional-users';\n\nimport '../css/dialog-status.css';\n\nimport type {ImModelDialog} from 'im.v2.model';\n\nconst TYPING_USERS_COUNT = 3;\nconst MORE_USERS_CSS_CLASS = 'bx-im-dialog-chat-status__user-count';\n\n// @vue/component\nexport const DialogStatus = {\n\tcomponents: {AdditionalUsers},\n\tprops: {\n\t\tdialogId: {\n\t\t\trequired: true,\n\t\t\ttype: String\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tshowAdditionalUsers: false,\n\t\t\tadditionalUsersLinkElement: null\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t\tisUser(): boolean\n\t\t{\n\t\t\treturn this.dialog.type === DialogType.user;\n\t\t},\n\t\tisChat(): boolean\n\t\t{\n\t\t\treturn !this.isUser;\n\t\t},\n\t\ttypingStatus(): string\n\t\t{\n\t\t\tif (!this.dialog.inited || this.dialog.writingList.length === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tconst firstTypingUsers = this.dialog.writingList.slice(0, TYPING_USERS_COUNT);\n\t\t\tconst text = firstTypingUsers.map(element => element.userName).join(', ');\n\n\t\t\tconst remainingUsersCount = this.dialog.writingList.length - TYPING_USERS_COUNT;\n\t\t\tif (remainingUsersCount > 0)\n\t\t\t{\n\t\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_TYPING_PLURAL', {\n\t\t\t\t\t'#USER#': text,\n\t\t\t\t\t'#COUNT#': remainingUsersCount\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_TYPING', {'#USER#': text});\n\t\t},\n\t\treadStatus(): string\n\t\t{\n\t\t\tif (!this.dialog.inited)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.lastMessageViews.countOfViewers === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.isUser)\n\t\t\t{\n\t\t\t\treturn this.formatUserViewStatus();\n\t\t\t}\n\n\t\t\treturn this.formatChatViewStatus();\n\t\t},\n\t\tlastMessageViews()\n\t\t{\n\t\t\treturn this.dialog.lastMessageViews;\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tformatUserViewStatus(): string\n\t\t{\n\t\t\tconst {date} = this.lastMessageViews.firstViewer;\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_USER', {\n\t\t\t\t'#DATE#': DateFormatter.formatByTemplate(date, DateTemplate.messageReadStatus)\n\t\t\t});\n\t\t},\n\t\tformatChatViewStatus(): string\n\t\t{\n\t\t\tconst {countOfViewers, firstViewer} = this.lastMessageViews;\n\t\t\tif (countOfViewers === 1)\n\t\t\t{\n\t\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_CHAT', {\n\t\t\t\t\t'#USER#': firstViewer.userName\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.loc('IM_DIALOG_CHAT_STATUS_READ_CHAT_PLURAL', {\n\t\t\t\t'#USERS#': Text.encode(firstViewer.userName),\n\t\t\t\t'#LINK_START#': `<span class=\"${MORE_USERS_CSS_CLASS}\" ref=\"moreUsersLink\">`,\n\t\t\t\t'#COUNT#': countOfViewers - 1,\n\t\t\t\t'#LINK_END#': '</span>'\n\t\t\t});\n\t\t},\n\t\tonClick(event: PointerEvent)\n\t\t{\n\t\t\tif (!event.target.matches(`.${MORE_USERS_CSS_CLASS}`))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.onMoreUsersClick();\n\t\t},\n\t\tonMoreUsersClick()\n\t\t{\n\t\t\tthis.additionalUsersLinkElement = document.querySelector(`.${MORE_USERS_CSS_CLASS}`);\n\t\t\tthis.showAdditionalUsers = true;\n\t\t},\n\t\tloc(phraseCode: string, replacements: {[string]: string} = {}): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode, replacements);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div @click=\"onClick\" class=\"bx-im-dialog-chat-status__container\">\n\t\t\t<div v-if=\"typingStatus\" class=\"bx-im-dialog-chat-status__content\">\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__icon --typing\"></div>\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__text\">{{ typingStatus }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if=\"readStatus\" class=\"bx-im-dialog-chat-status__content\">\n\t\t\t\t<div class=\"bx-im-dialog-chat-status__icon --read\"></div>\n\t\t\t\t<div v-html=\"readStatus\" class=\"bx-im-dialog-chat-status__text\"></div>\n\t\t\t</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t:show=\"showAdditionalUsers\"\n\t\t\t\t:bindElement=\"additionalUsersLinkElement || {}\"\n\t\t\t\t@close=\"showAdditionalUsers = false\"\n\t\t\t/>\n\t\t</div>\n\t`\n};","import '../css/dialog-loader.css';\n\n// @vue/component\nexport const DialogLoader = {\n\tname: 'DialogLoader',\n\tprops:\n\t{\n\t\tfullHeight: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true\n\t\t},\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-loader__container\" :class=\"{'--full-height': fullHeight}\">\n\t\t\t<div class=\"bx-im-dialog-loader__spinner\"></div>\n\t\t\t<div class=\"bx-im-dialog-loader__text\">{{ loc('IM_DIALOG_CHAT_LOADER_TEXT') }}</div>\n\t\t</div>\n\t`\n};","import { Event } from 'main.core';\n\nimport { Quote } from 'im.v2.lib.quote';\nimport { Utils } from 'im.v2.lib.utils';\nimport { MessengerSlider } from 'im.v2.lib.slider';\n\nimport '../css/quote-button.css';\n\nimport type { ImModelMessage } from 'im.v2.model';\n\nconst CONTAINER_HEIGHT = 44;\nconst CONTAINER_WIDTH = 60;\nconst CONTAINER_OFFSET = 10;\nconst slider = MessengerSlider.getInstance().getCurrent();\nconst sliderRect = slider?.layout.container.getBoundingClientRect();\nconst offsetY = sliderRect?.top ?? 0;\n\n// @vue/component\nexport const QuoteButton = {\n\tname: 'QuoteButton',\n\tdata()\n\t{\n\t\treturn {\n\t\t\ttext: '',\n\t\t\tmessage: null,\n\t\t\tmouseX: 0,\n\t\t\tmouseY: 0,\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tcontainerStyle(): {top: string, left: string, width: string, height: string}\n\t\t{\n\t\t\treturn {\n\t\t\t\ttop: `${this.mouseY - CONTAINER_HEIGHT - CONTAINER_OFFSET - offsetY}px`,\n\t\t\t\tleft: `${this.mouseX - CONTAINER_WIDTH / 2}px`,\n\t\t\t\twidth: `${CONTAINER_WIDTH}px`,\n\t\t\t\theight: `${CONTAINER_HEIGHT}px`,\n\t\t\t};\n\t\t},\n\t},\n\tmounted()\n\t{\n\t\tEvent.bind(window, 'mousedown', this.onMouseDown);\n\t},\n\tmethods:\n\t{\n\t\tonMessageMouseUp(message: ImModelMessage, event: MouseEvent)\n\t\t{\n\t\t\tif (event.button === 2)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.prepareSelectedText();\n\t\t\tthis.message = message;\n\t\t\tthis.mouseX = event.clientX;\n\t\t\tthis.mouseY = event.clientY;\n\t\t},\n\t\tonMouseDown(event: MouseEvent)\n\t\t{\n\t\t\tconst container = this.$refs.container;\n\t\t\tif (!container || container.contains(event.target))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$emit('close');\n\t\t},\n\t\tprepareSelectedText(): string\n\t\t{\n\t\t\tif (Utils.browser.isFirefox())\n\t\t\t{\n\t\t\t\tthis.text = window.getSelection().toString();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst range = window.getSelection().getRangeAt(0);\n\t\t\tconst selectedNodes = range.cloneContents().childNodes;\n\t\t\tfor (const node of selectedNodes)\n\t\t\t{\n\t\t\t\tif (this.isImage(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.getAttribute('data-code') ?? node.getAttribute('alt');\n\t\t\t\t}\n\t\t\t\telse if (this.isLineBreak(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += '\\n';\n\t\t\t\t}\n\t\t\t\telse if (this.isMessageTextNode(node) || this.isText(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.textContent;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tisImage(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn node.tagName.toLowerCase() === 'img';\n\t\t},\n\t\tisLineBreak(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName.toLowerCase() === 'br';\n\t\t},\n\t\tisText(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName === '#text';\n\t\t},\n\t\tisMessageTextNode(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst MESSAGE_TEXT_NODE_CLASS = '.bx-im-message-default-content__text';\n\t\t\tconst textNode = node.querySelector(MESSAGE_TEXT_NODE_CLASS);\n\n\t\t\treturn Boolean(textNode);\n\t\t},\n\t\tonQuoteClick()\n\t\t{\n\t\t\tQuote.sendQuoteEvent(this.message, this.text);\n\t\t\tthis.$emit('close');\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div ref=\"container\" @click=\"onQuoteClick\" :style=\"containerStyle\" class=\"bx-im-dialog-chat__quote-button\">\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon\"></div>\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon --hover\"></div>\n\t\t</div>\n\t`,\n};\n","import { Runtime, Event, Dom } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { PopupManager } from 'main.popup';\nimport { PullStatus } from 'pull.vue3.status';\n\nimport { Core } from 'im.v2.application.core';\nimport { FileMessage } from 'im.v2.component.message.file';\nimport { DefaultMessage } from 'im.v2.component.message.default';\nimport { CallInviteMessage } from 'im.v2.component.message.call-invite';\nimport { DeletedMessage } from 'im.v2.component.message.deleted';\nimport { UnsupportedMessage } from 'im.v2.component.message.unsupported';\nimport { SmileMessage } from 'im.v2.component.message.smile';\nimport { SystemMessage } from 'im.v2.component.message.system';\nimport { ChatCreationMessage } from 'im.v2.component.message.chat-creation';\nimport { ConferenceCreationMessage } from 'im.v2.component.message.conference-creation';\nimport { Avatar, AvatarSize, ChatInfoPopup } from 'im.v2.component.elements';\nimport { Logger } from 'im.v2.lib.logger';\nimport { CallManager } from 'im.v2.lib.call';\nimport { Utils } from 'im.v2.lib.utils';\nimport { MessageService, ChatService } from 'im.v2.provider.service';\nimport {\n\tDialogBlockType as BlockType,\n\tEventType,\n\tPopupType,\n\tDialogScrollThreshold,\n\tMessageComponent,\n\tUserRole,\n} from 'im.v2.const';\n\nimport { MessageComponentManager } from './classes/message-component-manager';\nimport { ScrollManager } from './classes/scroll-manager';\nimport { CollectionManager } from './classes/collection-manager';\nimport { MessageMenu } from './classes/message-menu';\nimport { AvatarMenu } from './classes/avatar-menu';\nimport { ObserverManager } from './classes/observer-manager';\nimport { PullWatchManager } from './classes/pull-watch-manager';\nimport { NewMessagesBlock } from './components/block/new-messages';\nimport { MarkedMessagesBlock } from './components/block/marked-messages';\nimport { DateGroupTitle } from './components/block/date-group';\nimport { PinnedMessages } from './components/pinned/pinned-messages';\nimport { DialogStatus } from './components/dialog-status';\nimport { DialogLoader } from './components/dialog-loader';\nimport { QuoteButton } from './components/quote-button';\nimport './css/chat-dialog.css';\n\nimport type { ImModelMessage, ImModelDialog, ImModelLayout } from 'im.v2.model';\nimport type { ScrollToBottomEvent } from 'im.v2.const';\nimport type { FormattedCollectionItem } from './classes/collection-manager';\n\nconst FLOATING_DATE_OFFSET = 52;\nconst LOAD_MESSAGE_ON_EXIT_DELAY = 200;\n\n// @vue/component\nexport const ChatDialog = {\n\tname: 'ChatDialog',\n\tcomponents: {\n\t\tAvatar,\n\t\tDefaultMessage,\n\t\tFileMessage,\n\t\tSmileMessage,\n\t\tCallInviteMessage,\n\t\tDeletedMessage,\n\t\tSystemMessage,\n\t\tUnsupportedMessage,\n\t\tChatCreationMessage,\n\t\tConferenceCreationMessage,\n\t\tPinnedMessages,\n\t\tNewMessagesBlock,\n\t\tMarkedMessagesBlock,\n\t\tDateGroupTitle,\n\t\tChatInfoPopup,\n\t\tDialogStatus,\n\t\tDialogLoader,\n\t\tQuoteButton,\n\t\tPullStatus,\n\t},\n\tdirectives: {\n\t\t'message-observer': {\n\t\t\tmounted(element, binding)\n\t\t\t{\n\t\t\t\tbinding.instance.observerManager.observeMessage(element);\n\t\t\t},\n\t\t\tbeforeUnmount(element, binding)\n\t\t\t{\n\t\t\t\tbinding.instance.observerManager.unobserveMessage(element);\n\t\t\t},\n\t\t},\n\t},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\ttextareaHeight: {\n\t\t\ttype: Number,\n\t\t\tdefault: 0,\n\t\t},\n\t},\n\tdata(): Object\n\t{\n\t\treturn {\n\t\t\tmessageMenuIsActiveForId: 0,\n\t\t\tchatInfoPopup: {\n\t\t\t\telement: null,\n\t\t\t\tdialogId: 0,\n\t\t\t\tshow: false,\n\t\t\t},\n\t\t\tcontextMode: {\n\t\t\t\tactive: false,\n\t\t\t\tmessageIsLoaded: false,\n\t\t\t},\n\t\t\tinitialScrollCompleted: false,\n\t\t\tisScrolledUp: false,\n\t\t\twindowFocused: false,\n\t\t\tshowQuoteButton: false,\n\t\t\tselectedText: null,\n\t\t\tquoteButtonStyles: {},\n\t\t\tquoteButtonMessage: 0,\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tBlockType: () => BlockType,\n\t\tAvatarSize: () => AvatarSize,\n\t\tlayout(): ImModelLayout\n\t\t{\n\t\t\treturn this.$store.getters['application/getLayout'];\n\t\t},\n\t\tdialog(): ImModelDialog\n\t\t{\n\t\t\treturn this.$store.getters['dialogues/get'](this.dialogId, true);\n\t\t},\n\t\tdialogInited(): boolean\n\t\t{\n\t\t\treturn this.dialog.inited;\n\t\t},\n\t\tformattedCollection(): FormattedCollectionItem[]\n\t\t{\n\t\t\tif (!this.dialogInited && this.messageCollection.length === 0)\n\t\t\t{\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\treturn this.getCollectionManager().formatMessageCollection(this.messageCollection);\n\t\t},\n\t\tmessageCollection(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/get'](this.dialog.chatId);\n\t\t},\n\t\tpinnedMessages(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/pin/getPinned'](this.dialog.chatId);\n\t\t},\n\t\tisOpened(): boolean\n\t\t{\n\t\t\tconst openedDialogId = this.$store.getters['application/getLayout'].entityId;\n\n\t\t\treturn this.dialogId === openedDialogId;\n\t\t},\n\t\tisGuest(): boolean\n\t\t{\n\t\t\treturn this.dialog.role === UserRole.guest;\n\t\t},\n\t\tdebouncedScrollHandler(): Function\n\t\t{\n\t\t\tconst SCROLLING_DEBOUNCE_DELAY = 200;\n\n\t\t\treturn Runtime.debounce(this.getScrollManager().onScroll, SCROLLING_DEBOUNCE_DELAY, this.getScrollManager());\n\t\t},\n\t\tdebouncedReadHandler(): Function\n\t\t{\n\t\t\treturn Runtime.debounce(this.readVisibleMessages, 50, this);\n\t\t},\n\t\tformattedCounter(): string\n\t\t{\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.dialog.counter > 99)\n\t\t\t{\n\t\t\t\treturn '99+';\n\t\t\t}\n\n\t\t\treturn String(this.dialog.counter);\n\t\t},\n\t\tshowDialogStatus(): boolean\n\t\t{\n\t\t\treturn this.messageCollection.some((message) => {\n\t\t\t\treturn message.id === this.dialog.lastMessageId;\n\t\t\t});\n\t\t},\n\t\tshowScrollButton(): boolean\n\t\t{\n\t\t\treturn this.isScrolledUp || this.dialog.hasNextPage;\n\t\t},\n\t},\n\twatch:\n\t{\n\t\tdialogInited(newValue, oldValue)\n\t\t{\n\t\t\tif (!newValue || oldValue)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// first opening\n\t\t\tthis.getPullWatchManager().onChatLoad();\n\t\t\tthis.onChatInited();\n\t\t},\n\t\ttextareaHeight()\n\t\t{\n\t\t\tif (this.isScrolledUp || !this.dialogInited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t});\n\t\t},\n\t},\n\tcreated()\n\t{\n\t\tLogger.warn('Dialog: Chat created', this.dialogId);\n\t\tthis.getCollectionManager();\n\n\t\tthis.initContextMenu();\n\t\tthis.initObserverManager();\n\n\t\tthis.initContextMode();\n\t},\n\tmounted()\n\t{\n\t\tthis.getScrollManager().setContainer(this.getContainer());\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\t// second+ opening\n\t\t\tthis.getPullWatchManager().onLoadedChatEnter();\n\t\t\tthis.onChatInited();\n\t\t}\n\t\t// there are P&P messages\n\t\telse if (!this.dialogInited && this.messageCollection.length > 0)\n\t\t{\n\t\t\tthis.scrollOnStart();\n\t\t}\n\n\t\tthis.windowFocused = document.hasFocus();\n\n\t\tthis.subscribeToEvents();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.closeMessageMenu();\n\t\tthis.unsubscribeFromEvents();\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\tthis.saveScrollPosition();\n\t\t\tthis.loadMessagesOnExit();\n\t\t}\n\t\tthis.getPullWatchManager().onChatExit();\n\t},\n\tmethods:\n\t{\n\t\treadVisibleMessages()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.windowFocused || this.hasVisibleCall() || this.isGuest)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getObserverManager().getMessagesToRead().forEach((messageId) => {\n\t\t\t\tthis.getChatService().readMessage(this.dialog.chatId, messageId);\n\t\t\t\tthis.getObserverManager().onReadMessage(messageId);\n\t\t\t});\n\t\t},\n\t\tscrollOnStart()\n\t\t{\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t// we loaded chat with context\n\t\t\t\tif (this.contextMode.active && this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.layout.contextId, -FLOATING_DATE_OFFSET);\n\t\t\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t\t\tthis.highlightMessage(this.layout.contextId);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// chat was loaded before\n\t\t\t\telse if (this.contextMode.active && !this.contextMode.messageIsLoaded)\n\t\t\t\t{\n\t\t\t\t\tvoid this.goToMessageContext(this.layout.contextId);\n\t\t\t\t}\n\t\t\t\t// marked message\n\t\t\t\telse if (this.dialog.markedId)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// saved position\n\t\t\t\telse if (this.dialog.savedPositionMessageId)\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: saved scroll position, scrolling to', this.dialog.savedPositionMessageId);\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId);\n\t\t\t\t}\n\t\t\t\t// unread message\n\t\t\t\telse if (this.$store.getters['dialogues/getLastReadId'](this.dialogId))\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages, -FLOATING_DATE_OFFSET);\n\t\t\t\t}\n\t\t\t\t// new chat with unread messages\n\t\t\t\telse if (this.$store.getters['messages/getFirstUnread'](this.dialog.chatId))\n\t\t\t\t{\n\t\t\t\t\tLogger.warn('Dialog: new chat with unread messages, dont scroll');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tgoToMessageContext(messageId: number): Promise\n\t\t{\n\t\t\tconst hasMessage = this.$store.getters['messages/hasMessage']({\n\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\tmessageId,\n\t\t\t});\n\t\t\tif (hasMessage)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we have this message, scrolling to it', messageId);\n\n\t\t\t\treturn this.getScrollManager().animatedScrollToMessage(messageId, -FLOATING_DATE_OFFSET)\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tthis.highlightMessage(messageId);\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.getMessageService().loadContext(messageId)\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.$nextTick();\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(messageId, -FLOATING_DATE_OFFSET);\n\n\t\t\t\t\treturn this.$nextTick();\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.highlightMessage(messageId);\n\n\t\t\t\t\treturn true;\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tLogger.error('goToMessageContext error', error);\n\t\t\t\t});\n\t\t},\n\t\thighlightMessage(messageId: number)\n\t\t{\n\t\t\tconst HIGHLIGHT_CLASS = 'bx-im-dialog-chat__highlighted-message';\n\t\t\tconst HIGHLIGHT_DURATION = 2000;\n\n\t\t\tconst message = this.getScrollManager().getDomElementById(messageId);\n\t\t\tif (!message)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.addClass(message, HIGHLIGHT_CLASS);\n\t\t\tsetTimeout(() => {\n\t\t\t\tDom.removeClass(message, HIGHLIGHT_CLASS);\n\t\t\t}, HIGHLIGHT_DURATION);\n\t\t},\n\t\tsaveScrollPosition()\n\t\t{\n\t\t\tlet savedPositionMessageId = this.getObserverManager().getFirstVisibleMessage();\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tsavedPositionMessageId = 0;\n\t\t\t}\n\t\t\tthis.$store.dispatch('dialogues/update', {\n\t\t\t\tdialogId: this.dialogId,\n\t\t\t\tfields: {\n\t\t\t\t\tsavedPositionMessageId,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\tloadMessagesOnExit()\n\t\t{\n\t\t\tsetTimeout(() => {\n\t\t\t\tvoid this.getMessageService().reloadMessageList();\n\t\t\t}, LOAD_MESSAGE_ON_EXIT_DELAY);\n\t\t},\n\t\t/* region Init methods */\n\t\tinitContextMode()\n\t\t{\n\t\t\tif (!this.layout.contextId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.contextMode.active = true;\n\t\t\t// chat was loaded before, we didn't load context specifically\n\t\t\t// if chat wasn't loaded before - we load it with context\n\t\t\tthis.contextMode.messageIsLoaded = !this.dialogInited;\n\t\t},\n\t\tinitContextMenu()\n\t\t{\n\t\t\tthis.messageMenu = new MessageMenu();\n\t\t\tthis.messageMenu.subscribe(MessageMenu.events.onCloseMenu, () => {\n\t\t\t\tthis.messageMenuIsActiveForId = 0;\n\t\t\t});\n\n\t\t\tthis.avatarMenu = new AvatarMenu();\n\t\t},\n\t\tinitObserverManager()\n\t\t{\n\t\t\tthis.observerManager = new ObserverManager();\n\t\t\tthis.observerManager.subscribe(ObserverManager.events.onMessageIsVisible, () => {\n\t\t\t\tthis.debouncedReadHandler();\n\t\t\t});\n\t\t},\n\t\tgetObserverManager(): ObserverManager\n\t\t{\n\t\t\treturn this.observerManager;\n\t\t},\n\t\tgetCollectionManager(): CollectionManager\n\t\t{\n\t\t\tif (!this.collectionManager)\n\t\t\t{\n\t\t\t\tthis.collectionManager = new CollectionManager(this.dialogId);\n\t\t\t}\n\n\t\t\treturn this.collectionManager;\n\t\t},\n\t\tgetMessageService(): MessageService\n\t\t{\n\t\t\tif (!this.messageService)\n\t\t\t{\n\t\t\t\tthis.messageService = new MessageService({ chatId: this.dialog.chatId });\n\t\t\t}\n\n\t\t\treturn this.messageService;\n\t\t},\n\t\tgetChatService(): ChatService\n\t\t{\n\t\t\tif (!this.chatService)\n\t\t\t{\n\t\t\t\tthis.chatService = new ChatService();\n\t\t\t}\n\n\t\t\treturn this.chatService;\n\t\t},\n\t\tgetScrollManager(): ScrollManager\n\t\t{\n\t\t\tif (!this.scrollManager)\n\t\t\t{\n\t\t\t\tthis.scrollManager = new ScrollManager();\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerUp, this.onScrollTriggerUp);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerDown, this.onScrollTriggerDown);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollThresholdPass, (event: BaseEvent<boolean>) => {\n\t\t\t\t\tthis.isScrolledUp = event.getData();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.scrollManager;\n\t\t},\n\t\tgetPullWatchManager(): PullWatchManager\n\t\t{\n\t\t\tif (!this.pullWatchManager)\n\t\t\t{\n\t\t\t\tthis.pullWatchManager = new PullWatchManager(this.dialogId);\n\t\t\t}\n\n\t\t\treturn this.pullWatchManager;\n\t\t},\n\t\t/* endregion Init methods */\n\t\t/* region Event handlers */\n\t\tonChatInited()\n\t\t{\n\t\t\tif (!this.dialog.loading)\n\t\t\t{\n\t\t\t\tthis.scrollOnStart();\n\t\t\t\tthis.readVisibleMessages();\n\t\t\t\tthis.getObserverManager().setDialogInited(true);\n\t\t\t}\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tthis.getChatService().clearDialogMark(this.dialogId);\n\t\t\t});\n\n\t\t\tEventEmitter.emit(EventType.dialog.onDialogInited, { dialogId: this.dialogId });\n\t\t},\n\t\tasync onScrollTriggerUp()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered UP');\n\t\t\tconst container = this.getContainer();\n\t\t\tconst oldHeight = container.scrollHeight - container.clientHeight;\n\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedHistoryMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasPrevPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tawait this.getMessageService().loadHistory();\n\t\t\t// Messages loaded and we are at the top\n\t\t\tif (this.getScrollManager().isAtTheTop())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the top after history request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\t\t\t}\n\t\t},\n\t\tasync onScrollTriggerDown()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered DOWN');\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedUnreadMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tawait this.getMessageService().loadUnread();\n\t\t\t// Messages loaded and we are at the bottom\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the bottom after unread request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\t\t\t\tthis.getScrollManager().checkIfChatIsScrolledUp();\n\t\t\t}\n\t\t},\n\t\tonScrollToBottom(event: BaseEvent<ScrollToBottomEvent>)\n\t\t{\n\t\t\tconst { chatId, threshold = DialogScrollThreshold.halfScreenUp, animation = true } = event.getData();\n\t\t\tif (this.dialog.chatId !== chatId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.windowFocused || this.hasVisibleCall())\n\t\t\t{\n\t\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\t\tif (firstUnreadId)\n\t\t\t\t{\n\t\t\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t\t\tthis.getScrollManager().scrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll to bottom', chatId, threshold);\n\t\t\tif (threshold === DialogScrollThreshold.halfScreenUp && this.isScrolledUp)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (threshold === DialogScrollThreshold.nearTheBottom && !this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tif (animation)\n\t\t\t\t{\n\t\t\t\t\tthis.getScrollManager().animatedScrollToBottom();\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t\t});\n\t\t},\n\t\tonGoToMessageContext(event: BaseEvent)\n\t\t{\n\t\t\tconst { dialogId, messageId } = event.getData();\n\t\t\tif (this.dialog.dialogId !== dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.goToMessageContext(messageId);\n\t\t},\n\t\tonOpenChatInfo(event: BaseEvent)\n\t\t{\n\t\t\tconst { dialogId, event: $event } = event.getData();\n\t\t\tthis.chatInfoPopup.element = $event.target;\n\t\t\tthis.chatInfoPopup.dialogId = dialogId;\n\t\t\tthis.chatInfoPopup.show = true;\n\t\t},\n\t\tonPinnedMessageClick(messageId: number)\n\t\t{\n\t\t\tvoid this.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageUnpin(messageId: number)\n\t\t{\n\t\t\tthis.getMessageService().unpinMessage(this.dialog.chatId, messageId);\n\t\t},\n\t\tonMessageContextMenuClick(eventData: BaseEvent)\n\t\t{\n\t\t\tconst { message, event }: { message: ImModelMessage, event: PointerEvent } = eventData.getData();\n\n\t\t\tconst context = { dialogId: this.dialogId, ...message };\n\t\t\tthis.messageMenu.openMenu(context, event.currentTarget);\n\t\t\tthis.messageMenuIsActiveForId = message.id;\n\t\t},\n\t\tonScroll(event: Event)\n\t\t{\n\t\t\tthis.closeDialogPopups();\n\t\t\tthis.debouncedScrollHandler(event);\n\t\t},\n\t\tasync onScrollButtonClick()\n\t\t{\n\t\t\tif (this.getScrollManager().scrollButtonClicked)\n\t\t\t{\n\t\t\t\tthis.handleSecondScrollButtonClick();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollButtonClicked = true;\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\tif (!firstUnreadId)\n\t\t\t{\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t\t}\n\n\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId, -FLOATING_DATE_OFFSET);\n\t\t},\n\t\tonWindowFocus()\n\t\t{\n\t\t\tthis.windowFocused = true;\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonWindowBlur()\n\t\t{\n\t\t\tthis.windowFocused = false;\n\t\t},\n\t\tonAvatarClick(dialogId: string, event: PointerEvent)\n\t\t{\n\t\t\tconst user = this.$store.getters['users/get'](dialogId);\n\t\t\tconst userId = Number.parseInt(dialogId, 10);\n\t\t\tif (!user || Core.getUserId() === userId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Utils.key.isAltOrOption(event))\n\t\t\t{\n\t\t\t\tEventEmitter.emit(EventType.textarea.insertMention, {\n\t\t\t\t\tmentionText: user.name,\n\t\t\t\t\tmentionReplacement: Utils.text.getMentionBbCode(user.id, user.name),\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.avatarMenu.openMenu({ user, dialog: this.dialog }, event.currentTarget);\n\t\t},\n\t\tonCallFold()\n\t\t{\n\t\t\tconst callDialogId = CallManager.getInstance().getCurrentCallDialogId();\n\t\t\tif (callDialogId !== this.dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonChatClick(event: PointerEvent)\n\t\t{\n\t\t\tif (this.isGuest)\n\t\t\t{\n\t\t\t\tevent.stopPropagation();\n\t\t\t}\n\t\t},\n\t\thandleSecondScrollButtonClick()\n\t\t{\n\t\t\tthis.getScrollManager().scrollButtonClicked = false;\n\t\t\tif (this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\tthis.getMessageService().loadContext(this.dialog.lastMessageId).then(() => {\n\t\t\t\t\tEventEmitter.emit(EventType.dialog.scrollToBottom, {\n\t\t\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\t\t});\n\t\t\t\t}).catch((error) => {\n\t\t\t\t\tLogger.error('ChatDialog: scroll to chat end loadContext error', error);\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId);\n\t\t},\n\t\t/* endregion Event handlers */\n\t\thasVisibleCall(): boolean\n\t\t{\n\t\t\treturn CallManager.getInstance().hasVisibleCall();\n\t\t},\n\t\tcloseDialogPopups()\n\t\t{\n\t\t\tthis.closeMessageMenu();\n\t\t\tthis.chatInfoPopup.show = false;\n\t\t\tthis.showQuoteButton = false;\n\t\t\tthis.avatarMenu.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReactionUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReadUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.messageBaseFileMenu)?.close();\n\t\t},\n\t\tcloseMessageMenu()\n\t\t{\n\t\t\tthis.messageMenu.close();\n\t\t\tthis.messageMenuIsActiveForId = 0;\n\t\t},\n\t\tsubscribeToEvents()\n\t\t{\n\t\t\tEventEmitter.subscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.subscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.subscribe(EventType.mention.openChatInfo, this.onOpenChatInfo);\n\t\t\tEventEmitter.subscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.subscribe(EventType.dialog.onClickMessageContextMenu, this.onMessageContextMenuClick);\n\n\t\t\tEvent.bind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.bind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tunsubscribeFromEvents()\n\t\t{\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.unsubscribe(EventType.mention.openChatInfo, this.onOpenChatInfo);\n\t\t\tEventEmitter.unsubscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.onClickMessageContextMenu, this.onMessageContextMenuClick);\n\n\t\t\tEvent.unbind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.unbind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tgetContainer(): ?HTMLElement\n\t\t{\n\t\t\treturn this.$refs.container;\n\t\t},\n\t\tasync onMessageMouseUp(message: ImModelMessage, event: MouseEvent)\n\t\t{\n\t\t\tawait Utils.browser.waitForSelectionToUpdate();\n\t\t\tconst selection = window.getSelection().toString().trim();\n\t\t\tif (selection.length === 0 || this.isGuest)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.showQuoteButton = true;\n\t\t\tawait this.$nextTick();\n\t\t\tthis.$refs.quoteButton.onMessageMouseUp(message, event);\n\t\t},\n\t\tgetMessageComponentName(message: ImModelMessage): $Values<typeof MessageComponent>\n\t\t{\n\t\t\treturn (new MessageComponentManager(message)).getName();\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__block bx-im-dialog-chat__scope\">\n\t\t\t<PinnedMessages\n\t\t\t\tv-if=\"pinnedMessages.length > 0\"\n\t\t\t\t:messages=\"pinnedMessages\"\n\t\t\t\t@messageClick=\"onPinnedMessageClick\"\n\t\t\t\t@messageUnpin=\"onPinnedMessageUnpin\"\n\t\t\t/>\n\t\t\t<PullStatus/>\n\t\t\t<div @scroll=\"onScroll\" @click.capture=\"onChatClick\" class=\"bx-im-dialog-chat__scroll-container\" ref=\"container\">\n\t\t\t\t<div class=\"bx-im-dialog-chat__content\">\n\t\t\t\t\t<!-- Loader -->\n\t\t\t\t\t<DialogLoader v-if=\"!dialogInited\" :fullHeight=\"formattedCollection.length === 0\" />\n\t\t\t\t\t<!-- Date groups -->\n\t\t\t\t\t<div v-for=\"dateGroup in formattedCollection\" :key=\"dateGroup.date.id\" class=\"bx-im-dialog-chat__date-group_container\">\n\t\t\t\t\t\t<!-- Date mark -->\n\t\t\t\t\t\t<DateGroupTitle :title=\"dateGroup.date.title\" />\n\t\t\t\t\t\t<!-- Single date group -->\n\t\t\t\t\t\t<template v-for=\"dateGroupItem in dateGroup.items\">\n\t\t\t\t\t\t\t<!-- 'New messages' mark -->\n\t\t\t\t\t\t\t<MarkedMessagesBlock v-if=\"dateGroupItem.type === BlockType.markedMessages\" data-id=\"newMessages\" />\n\t\t\t\t\t\t\t<NewMessagesBlock v-else-if=\"dateGroupItem.type === BlockType.newMessages\" data-id=\"newMessages\" />\n\t\t\t\t\t\t\t<!-- Author group -->\n\t\t\t\t\t\t\t<div v-else-if=\"dateGroupItem.type === BlockType.authorGroup\" :class=\"'--' + dateGroupItem.messageType\" class=\"bx-im-dialog-chat__author-group_container\">\n\t\t\t\t\t\t\t\t<!-- Author group avatar -->\n\t\t\t\t\t\t\t\t<div v-if=\"dateGroupItem.avatar.isNeeded\" class=\"bx-im-dialog-chat__author-group_avatar\">\n\t\t\t\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t\t\t\t:dialogId=\"dateGroupItem.avatar.avatarId\"\n\t\t\t\t\t\t\t\t\t\t:size=\"AvatarSize.L\"\n\t\t\t\t\t\t\t\t\t\t:withStatus=\"false\"\n\t\t\t\t\t\t\t\t\t\t@click=\"onAvatarClick(dateGroupItem.avatar.avatarId, $event)\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<!-- Messages -->\n\t\t\t\t\t\t\t\t<div class=\"bx-im-dialog-chat__messages_container\">\n\t\t\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t\t\tv-for=\"(message, index) in dateGroupItem.items\"\n\t\t\t\t\t\t\t\t\t\tv-message-observer\n\t\t\t\t\t\t\t\t\t\t:is=\"getMessageComponentName(message)\"\n\t\t\t\t\t\t\t\t\t\t:withTitle=\"index === 0\"\n\t\t\t\t\t\t\t\t\t\t:item=\"message\"\n\t\t\t\t\t\t\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t\t\t\t\t\t\t:key=\"message.id\"\n\t\t\t\t\t\t\t\t\t\t:menuIsActiveForId=\"messageMenuIsActiveForId\"\n\t\t\t\t\t\t\t\t\t\t:withAvatar=\"dateGroupItem.avatar.isNeeded\"\n\t\t\t\t\t\t\t\t\t\t:data-viewed=\"message.viewed\"\n\t\t\t\t\t\t\t\t\t\t@mouseup=\"onMessageMouseUp(message, $event)\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</div>\n\t\t\t\t\t<DialogStatus v-if=\"showDialogStatus\" :dialogId=\"dialogId\" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Transition name=\"scroll-button-transition\">\n\t\t\t\t<div v-if=\"showScrollButton\" @click=\"onScrollButtonClick\" class=\"bx-im-dialog-chat__scroll-button\">\n\t\t\t\t\t<div v-if=\"dialog.counter\" class=\"bx-im-dialog-chat__scroll-button_counter\">{{ formattedCounter }}</div>\n\t\t\t\t</div>\n\t\t\t</Transition>\n\t\t\t<ChatInfoPopup\n\t\t\t\tv-if=\"chatInfoPopup.show\"\n\t\t\t\t:dialogId=\"chatInfoPopup.dialogId\"\n\t\t\t\t:bindElement=\"chatInfoPopup.element\"\n\t\t\t\t:showPopup=\"chatInfoPopup.show\"\n\t\t\t\t@close=\"chatInfoPopup.show = false\"\n\t\t\t/>\n            <Transition name=\"fade-up\">\n\t\t\t\t<QuoteButton \n\t\t\t\t\tv-if=\"showQuoteButton\" \n\t\t\t\t\tref=\"quoteButton\"\n\t\t\t\t\t@close=\"showQuoteButton = false\" \n\t\t\t\t\tclass=\"bx-im-message-base__quote-button\" \n\t\t\t\t/>\n            </Transition>\n\t\t</div>\n\t`,\n};\n"],"names":["MessageComponentManager","constructor","message","getName","MessageComponent","deleted","callInvite","unsupported","chatCreation","conferenceCreation","system","file","smile","default","files","length","text","attach","isDeleted","authorId","componentId","replyId","Utils","isEmojiOnly","smileManager","SmileManager","getInstance","smiles","smileList","sortedSmiles","sort","a","b","typing","localeCompare","pattern","map","escapeRegex","join","replacedText","replaceAll","RegExp","hasOnlySmiles","trim","matchOnlySmiles","test","EVENT_NAMESPACE","SCROLLING_THRESHOLD","POSITION_THRESHOLD","SCROLLED_UP_THRESHOLD","ScrollManager","EventEmitter","isScrolling","currentScroll","lastScroll","chatIsScrolledUp","scrollButtonClicked","setEventNamespace","setContainer","container","onScroll","event","target","scrollTop","isScrollingDown","isScrollingUp","leftSpaceBottom","scrollHeight","clientHeight","emit","events","onScrollTriggerDown","onScrollTriggerUp","checkIfChatIsScrolledUp","availableScrollHeight","newFlag","onScrollThresholdPass","scrollToBottom","Logger","warn","forceScrollTo","animatedScrollToBottom","animatedScrollTo","scrollToMessage","messageId","offset","element","getDomElementById","position","offsetTop","animatedScrollToMessage","cancelAnimatedScroll","scroll","top","behavior","adjustScrollOnHistoryAddition","oldContainerHeight","newContainerHeight","newScrollPosition","Promise","resolve","Animation","start","end","elementProperty","callback","cancel","isAtTheTop","isAtTheBottom","isAroundBottom","id","querySelector","CollectionManager","dialogId","firstIteration","cachedDateGroups","store","Core","getStore","formatMessageCollection","messageCollection","dateGroups","collection","lastDateItems","lastAuthorId","lastAuthorItems","dialog","getters","markedId","inited","markInserted","lastReadId","initialLastReadMessage","initialMarkedId","forEach","index","dateGroup","getDateGroup","date","title","push","type","BlockType","items","markedMessages","authorGroup","userId","avatar","getAvatarConfig","messageType","getMessageType","isLastMessage","newMessages","INDEX_BETWEEN_DATE_AND_TIME","shortDate","toJSON","slice","DateFormatter","formatByTemplate","DateTemplate","isSystem","MessageType","isSelf","self","alignment","Settings","appearance","isNeeded","DialogAlignment","left","center","avatarId","toString","getUserId","opponent","MessageMenu","BaseMenu","diskService","DiskService","marketManager","MarketManager","getMenuOptions","className","getMenuClassName","angle","offsetLeft","getMenuItems","getReplyItem","getCopyItem","getDelimiter","getDownloadFileItem","getSaveToDisk","getPinItem","getFavoriteItem","getMarkItem","getCreateItem","getEditItem","getDeleteItem","Loc","getMessage","onclick","EventType","textarea","replyMessage","context","menuInstance","close","textToCopy","Parser","prepareCopy","BX","clipboard","copy","UI","Notification","Center","notify","content","isPinned","chatId","messageService","MessageService","unpinMessage","pinMessage","isInFavorite","menuItemText","removeMessageFromFavorite","addMessageToFavorite","canUnread","viewed","isMarked","markMessage","getCreateTaskItem","getCreateMeetingItem","getMarketItems","entityCreator","EntityCreator","createTaskForMessage","createMeetingForMessage","editMessage","deleteMessage","placements","getAvailablePlacementsByType","PlacementType","contextMenu","marketMenuItem","placement","openSlider","itemLimit","html","createDownloadLink","urlDownload","name","bind","save","then","delimiter","AvatarMenu","permissionManager","PermissionManager","getMentionItem","getSendItem","getProfileItem","getKickItem","insertMention","mentionText","user","mentionReplacement","getMentionBbCode","Messenger","openChat","href","getProfileLink","canKick","canPerformKick","userChoice","showKickUserConfirm","chatService","ChatService","kickUserFromChat","ObserverManager","Set","setDialogInited","flag","Object","values","unobserveMessage","observeMessage","messageElement","observe","dataset","unobserve","onReadMessage","delete","getMessagesToRead","getFirstVisibleMessage","size","firstVisibleMessage","IntersectionObserver","entries","entry","rootBounds","messageIsFullyVisible","isIntersecting","intersectionRatio","messageTakesHalfOfViewport","intersectionRect","height","add","onMessageIsVisible","threshold","Array","from","fill","zero","TAG_PREFIX","PullWatchManager","getPullClient","onChatLoad","extendWatch","onChatExit","clearWatch","onLoadedChatEnter","runAction","RestMethod","imV2ChatExtendPullWatch","data","role","UserRole","guest","NewMessagesBlock","methods","loc","phraseCode","$Bitrix","template","MarkedMessagesBlock","DateGroupTitle","props","String","required","PinnedMessage","computed","internalMessage","purifyMessage","author","$store","PinnedMessages","components","messages","emits","firstMessage","messagesToShow","UserService","getRestClient","UserManager","loadReadUsers","users","callMethod","imV2ChatMessageTailViewers","response","setUsersToModel","catch","error","console","Error","AdditionalUsers","UserListPopup","show","Boolean","bindElement","showPopup","loadingAdditionalUsers","additionalUsers","watch","newValue","oldValue","loadUsers","getUserService","lastMessageId","userIds","prepareAdditionalUsers","onPopupClose","$emit","firstViewerId","lastMessageViews","firstViewer","filter","userService","TYPING_USERS_COUNT","MORE_USERS_CSS_CLASS","DialogStatus","showAdditionalUsers","additionalUsersLinkElement","isUser","DialogType","isChat","typingStatus","writingList","firstTypingUsers","userName","remainingUsersCount","readStatus","countOfViewers","formatUserViewStatus","formatChatViewStatus","messageReadStatus","Text","encode","onClick","matches","onMoreUsersClick","document","replacements","DialogLoader","fullHeight","CONTAINER_HEIGHT","CONTAINER_WIDTH","CONTAINER_OFFSET","slider","MessengerSlider","getCurrent","sliderRect","layout","getBoundingClientRect","offsetY","QuoteButton","mouseX","mouseY","containerStyle","width","mounted","Event","window","onMouseDown","onMessageMouseUp","button","prepareSelectedText","clientX","clientY","$refs","contains","browser","isFirefox","getSelection","range","getRangeAt","selectedNodes","cloneContents","childNodes","node","isImage","getAttribute","isLineBreak","isMessageTextNode","isText","textContent","HTMLElement","tagName","toLowerCase","nodeName","MESSAGE_TEXT_NODE_CLASS","textNode","onQuoteClick","Quote","sendQuoteEvent","FLOATING_DATE_OFFSET","LOAD_MESSAGE_ON_EXIT_DELAY","ChatDialog","Avatar","DefaultMessage","FileMessage","SmileMessage","CallInviteMessage","DeletedMessage","SystemMessage","UnsupportedMessage","ChatCreationMessage","ConferenceCreationMessage","ChatInfoPopup","PullStatus","directives","binding","instance","observerManager","beforeUnmount","textareaHeight","Number","messageMenuIsActiveForId","chatInfoPopup","contextMode","active","messageIsLoaded","initialScrollCompleted","isScrolledUp","windowFocused","showQuoteButton","selectedText","quoteButtonStyles","quoteButtonMessage","AvatarSize","dialogInited","formattedCollection","getCollectionManager","pinnedMessages","isOpened","openedDialogId","entityId","isGuest","debouncedScrollHandler","SCROLLING_DEBOUNCE_DELAY","Runtime","debounce","getScrollManager","debouncedReadHandler","readVisibleMessages","formattedCounter","counter","showDialogStatus","some","showScrollButton","hasNextPage","getPullWatchManager","onChatInited","$nextTick","created","initContextMenu","initObserverManager","initContextMode","getContainer","scrollOnStart","hasFocus","subscribeToEvents","closeMessageMenu","unsubscribeFromEvents","saveScrollPosition","loadMessagesOnExit","hasVisibleCall","getObserverManager","getChatService","readMessage","contextId","highlightMessage","goToMessageContext","savedPositionMessageId","hasMessage","getMessageService","loadContext","HIGHLIGHT_CLASS","HIGHLIGHT_DURATION","Dom","addClass","setTimeout","removeClass","dispatch","fields","reloadMessageList","messageMenu","subscribe","onCloseMenu","avatarMenu","collectionManager","scrollManager","getData","pullWatchManager","loading","clearDialogMark","onDialogInited","oldHeight","hasPreparedHistoryMessages","drawPreparedHistoryMessages","isLoading","hasPrevPage","loadHistory","hasPreparedUnreadMessages","drawPreparedUnreadMessages","loadUnread","onScrollToBottom","DialogScrollThreshold","halfScreenUp","animation","firstUnreadId","nearTheBottom","onGoToMessageContext","onOpenChatInfo","$event","onPinnedMessageClick","onPinnedMessageUnpin","onMessageContextMenuClick","eventData","openMenu","currentTarget","closeDialogPopups","onScrollButtonClick","handleSecondScrollButtonClick","loadInitialMessages","onWindowFocus","onWindowBlur","onAvatarClick","parseInt","key","isAltOrOption","onCallFold","callDialogId","CallManager","getCurrentCallDialogId","onChatClick","stopPropagation","PopupManager","getPopupById","PopupType","dialogReactionUsers","dialogReadUsers","messageBaseFileMenu","mention","openChatInfo","call","onFold","onClickMessageContextMenu","unsubscribe","unbind","waitForSelectionToUpdate","selection","quoteButton","getMessageComponentName"],"mappings":"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"}