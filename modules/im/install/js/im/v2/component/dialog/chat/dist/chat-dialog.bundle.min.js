this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,i,a,o,r,n,l,c,g,d,h,u,p,v,m,M,b,I,f,S,L,C,P,T,_,x,B,w,y,H,E,F,A,D,U){"use strict";var k=babelHelpers.classPrivateFieldLooseKey("message");var O=babelHelpers.classPrivateFieldLooseKey("hasFiles");var N=babelHelpers.classPrivateFieldLooseKey("hasText");var G=babelHelpers.classPrivateFieldLooseKey("hasAttach");var R=babelHelpers.classPrivateFieldLooseKey("isEmptyMessage");var X=babelHelpers.classPrivateFieldLooseKey("isDeletedMessage");var $=babelHelpers.classPrivateFieldLooseKey("isSystemMessage");var K=babelHelpers.classPrivateFieldLooseKey("isUnsupportedMessage");var j=babelHelpers.classPrivateFieldLooseKey("isChatCreationMessage");var V=babelHelpers.classPrivateFieldLooseKey("isConferenceCreationMessage");var q=babelHelpers.classPrivateFieldLooseKey("isCallInviteMessage");var W=babelHelpers.classPrivateFieldLooseKey("isEmojiOnly");var Q=babelHelpers.classPrivateFieldLooseKey("hasSmilesOnly");var Y=babelHelpers.classPrivateFieldLooseKey("hasOnlyText");class z{constructor(e){Object.defineProperty(this,Y,{value:ge});Object.defineProperty(this,Q,{value:ce});Object.defineProperty(this,W,{value:le});Object.defineProperty(this,q,{value:ne});Object.defineProperty(this,V,{value:re});Object.defineProperty(this,j,{value:oe});Object.defineProperty(this,K,{value:ae});Object.defineProperty(this,$,{value:ie});Object.defineProperty(this,X,{value:se});Object.defineProperty(this,R,{value:te});Object.defineProperty(this,G,{value:ee});Object.defineProperty(this,N,{value:Z});Object.defineProperty(this,O,{value:J});Object.defineProperty(this,k,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,k)[k]=e}getName(){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X]()){return y.MessageComponent.deleted}if(babelHelpers.classPrivateFieldLooseBase(this,q)[q]()){return y.MessageComponent.callInvite}if(babelHelpers.classPrivateFieldLooseBase(this,K)[K]()){return y.MessageComponent.unsupported}if(babelHelpers.classPrivateFieldLooseBase(this,j)[j]()){return y.MessageComponent.chatCreation}if(babelHelpers.classPrivateFieldLooseBase(this,V)[V]()){return y.MessageComponent.conferenceCreation}if(babelHelpers.classPrivateFieldLooseBase(this,$)[$]()){return y.MessageComponent.system}if(babelHelpers.classPrivateFieldLooseBase(this,O)[O]()){return y.MessageComponent.file}if(babelHelpers.classPrivateFieldLooseBase(this,W)[W]()||babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]()){return y.MessageComponent.smile}return y.MessageComponent.default}}function J(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].files.length>0}function Z(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].text.length>0}function ee(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].attach.length>0}function te(){return!babelHelpers.classPrivateFieldLooseBase(this,N)[N]()&&!babelHelpers.classPrivateFieldLooseBase(this,O)[O]()&&!babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}function se(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].isDeleted||babelHelpers.classPrivateFieldLooseBase(this,R)[R]()}function ie(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].authorId===0}function ae(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].componentId===y.MessageComponent.unsupported}function oe(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].componentId===y.MessageComponent.chatCreation}function re(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].componentId===y.MessageComponent.conferenceCreation}function ne(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].componentId===y.MessageComponent.callInvite}function le(){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k].replyId>0){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]()){return false}return D.Utils.text.isEmojiOnly(babelHelpers.classPrivateFieldLooseBase(this,k)[k].text)}function ce(){var e,t;if(babelHelpers.classPrivateFieldLooseBase(this,k)[k].replyId>0){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]()){return false}const s=u.SmileManager.getInstance();const i=(e=(t=s.smileList)==null?void 0:t.smiles)!=null?e:[];const a=[...i].sort(((e,t)=>t.typing.localeCompare(e.typing)));const o=a.map((e=>D.Utils.text.escapeRegex(e.typing))).join("|");const r=babelHelpers.classPrivateFieldLooseBase(this,k)[k].text.replaceAll(new RegExp(o,"g"),"");const n=r.trim().length===0;const l=new RegExp(`(?:(?:${o})\\s*){4,}`);return n&&!l.test(babelHelpers.classPrivateFieldLooseBase(this,k)[k].text)}function ge(){if(!babelHelpers.classPrivateFieldLooseBase(this,N)[N]()){return false}return!babelHelpers.classPrivateFieldLooseBase(this,O)[O]()&&!babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}const de="BX.Messenger.v2.Dialog.ScrollManager";const he=1500;const ue=40;const pe=400;class ve extends P.EventEmitter{constructor(){super();this.isScrolling=false;this.currentScroll=0;this.lastScroll=0;this.chatIsScrolledUp=false;this.scrollButtonClicked=false;this.setEventNamespace(de)}setContainer(e){this.container=e}onScroll(e){if(this.isScrolling||!e.target){return false}this.currentScroll=e.target.scrollTop;const t=this.lastScroll<this.currentScroll;const s=!t;if(s){this.scrollButtonClicked=false}const i=e.target.scrollHeight-e.target.scrollTop-e.target.clientHeight;if(t&&this.lastScroll>0&&i<he){this.emit(ve.events.onScrollTriggerDown)}else if(s&&this.currentScroll<=he){this.emit(ve.events.onScrollTriggerUp)}this.lastScroll=this.currentScroll;this.checkIfChatIsScrolledUp()}checkIfChatIsScrolledUp(){const e=this.container.scrollHeight-this.container.clientHeight;const t=this.currentScroll+pe<e;if(t!==this.chatIsScrolledUp){this.emit(ve.events.onScrollThresholdPass,t)}this.chatIsScrolledUp=t}scrollToBottom(){E.Logger.warn("Dialog: ScrollManager: scroll to bottom");this.forceScrollTo(this.container.scrollHeight-this.container.clientHeight)}animatedScrollToBottom(){E.Logger.warn("Dialog: ScrollManager: animated scroll to bottom");this.animatedScrollTo(this.container.scrollHeight-this.container.clientHeight)}scrollToMessage(e,t=-10){E.Logger.warn("Dialog: ScrollManager: scroll to message - ",e);const s=this.getDomElementById(e);if(!s){E.Logger.warn("Dialog: ScrollManager: message not found - ",e);return}const i=s.offsetTop+t;this.forceScrollTo(i)}animatedScrollToMessage(e,t=-10){E.Logger.warn("Dialog: ScrollManager: animated scroll to message - ",e);const s=this.getDomElementById(e);if(!s){E.Logger.warn("Dialog: ScrollManager: message not found - ",e);return}const i=s.offsetTop+t;return this.animatedScrollTo(i)}forceScrollTo(e){E.Logger.warn("Dialog: ScrollManager: Force scroll to - ",e);this.cancelAnimatedScroll();this.container.scroll({top:e,behavior:"instant"})}adjustScrollOnHistoryAddition(e){E.Logger.warn("Dialog: ScrollManager: Adjusting scroll after history addition");const t=this.container.scrollHeight-this.container.clientHeight;const s=this.container.scrollTop+t-e;this.forceScrollTo(s)}animatedScrollTo(e){E.Logger.warn("Dialog: ScrollManager: Animated scroll to - ",e);return new Promise((t=>{p.Animation.start({start:this.container.scrollTop,end:e,element:this.container,elementProperty:"scrollTop",callback:()=>{this.checkIfChatIsScrolledUp();t()}})}))}cancelAnimatedScroll(){if(!this.isScrolling){return}p.Animation.cancel();this.isScrolling=false}isAtTheTop(){return this.container.scrollTop===0}isAtTheBottom(){return this.container.scrollTop+this.container.clientHeight>=this.container.scrollHeight}isAroundBottom(){return this.container.scrollHeight-this.container.scrollTop-this.container.clientHeight<ue}getDomElementById(e){return this.container.querySelector(`[data-id="${e}"]`)}}ve.events={onScrollTriggerUp:"onScrollTriggerUp",onScrollTriggerDown:"onScrollTriggerDown",onScrollThresholdPass:"onScrollThresholdPass"};class me{constructor(e){this.firstIteration=true;this.cachedDateGroups={};this.store=w.Core.getStore();this.dialogId=e}formatMessageCollection(e){const t={};const s=[];let i=null;let a=null;let o=null;const r=this.store.getters["dialogues/get"](this.dialogId);const{markedId:n,inited:l}=r;let c=false;const g=this.store.getters["dialogues/getLastReadId"](this.dialogId);if(this.firstIteration){this.initialLastReadMessage=g;this.initialMarkedId=n}if(n!==this.initialMarkedId&&n!==0){this.initialMarkedId=n;this.initialLastReadMessage=null}e.forEach(((r,n)=>{const l=this.getDateGroup(r.date);if(!t[l.title]){t[l.title]=l.id;i=[];s.push({type:y.DialogBlockType.dateGroup,date:l,items:i});a=null}if(r.id===this.initialMarkedId){i.push({type:y.DialogBlockType.markedMessages});a=null;c=true}if(r.authorId!==a){a=r.authorId;o=[];i.push({type:y.DialogBlockType.authorGroup,userId:r.authorId,avatar:this.getAvatarConfig(r),messageType:this.getMessageType(r),items:o})}o.push(r);const g=n===e.length-1;if(!c&&!g&&r.id===this.initialLastReadMessage){i.push({type:y.DialogBlockType.newMessages});a=null}}));if(l){this.firstIteration=false}return s}getDateGroup(e){const t=10;const s=e.toJSON().slice(0,t);if(this.cachedDateGroups[s]){return this.cachedDateGroups[s]}this.cachedDateGroups[s]={id:s,title:x.DateFormatter.formatByTemplate(e,x.DateTemplate.dateGroup)};return this.cachedDateGroups[s]}getAvatarConfig(e){const t=this.getMessageType(e);const s=t===y.MessageType.system;const i=t===y.MessageType.self;const a=this.store.getters["application/settings/get"](y.Settings.appearance.alignment);let o=true;if(a===y.DialogAlignment.left){o=!s}else if(a===y.DialogAlignment.center){o=!i&&!s}return{isNeeded:o,avatarId:e.authorId.toString()}}getMessageType(e){if(!e.authorId){return y.MessageType.system}if(e.authorId===w.Core.getUserId()){return y.MessageType.self}return y.MessageType.opponent}}var Me=babelHelpers.classPrivateFieldLooseKey("isOwnMessage");var be=babelHelpers.classPrivateFieldLooseKey("isDeletedMessage");var Ie=babelHelpers.classPrivateFieldLooseKey("getMessageFile");class fe extends I.BaseMenu{constructor(){super();Object.defineProperty(this,Ie,{value:Ce});Object.defineProperty(this,be,{value:Le});Object.defineProperty(this,Me,{value:Se});this.id="bx-im-message-context-menu";this.diskService=new L.DiskService;this.marketManager=m.MarketManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:11}}getMenuItems(){return[this.getReplyItem(),this.getCopyItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getPinItem(),this.getFavoriteItem(),this.getMarkItem(),this.getDelimiter(),this.getCreateItem(),this.getDelimiter(),this.getEditItem(),this.getDelimiter(),this.getDeleteItem()]}getReplyItem(){return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_REPLY"),onclick:()=>{P.EventEmitter.emit(y.EventType.textarea.replyMessage,{messageId:this.context.id});this.menuInstance.close()}}}getCopyItem(){if(this.context.files.length===0){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY_FILE"),onclick:()=>{var e;const t=_.Parser.prepareCopy(this.context);if((e=BX.clipboard)!=null&&e.copy(t)){BX.UI.Notification.Center.notify({content:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_COPY_FILE_SUCCESS")})}this.menuInstance.close()}}}getPinItem(){if(babelHelpers.classPrivateFieldLooseBase(this,be)[be]()){return null}const e=this.store.getters["messages/pin/isPinned"]({chatId:this.context.chatId,messageId:this.context.id});return{text:e?F.Loc.getMessage("IM_DIALOG_CHAT_MENU_UNPIN"):F.Loc.getMessage("IM_DIALOG_CHAT_MENU_PIN"),onclick:()=>{const t=new L.MessageService({chatId:this.context.chatId});if(e){t.unpinMessage(this.context.chatId,this.context.id)}else{t.pinMessage(this.context.chatId,this.context.id)}this.menuInstance.close()}}}getFavoriteItem(){if(babelHelpers.classPrivateFieldLooseBase(this,be)[be]()){return null}const e=this.store.getters["sidebar/favorites/isFavoriteMessage"](this.context.chatId,this.context.id);const t=e?F.Loc.getMessage("IM_DIALOG_CHAT_MENU_REMOVE_FROM_SAVED"):F.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE");return{text:t,onclick:()=>{const t=new L.MessageService({chatId:this.context.chatId});if(e){t.removeMessageFromFavorite(this.context.id)}else{t.addMessageToFavorite(this.context.id)}this.menuInstance.close()}}}getMarkItem(){const e=this.context.viewed&&!babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]();const t=this.store.getters["dialogues/getByChatId"](this.context.chatId);const s=this.context.id===t.markedId;if(!e||s){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_MARK"),onclick:()=>{const e=new L.MessageService({chatId:this.context.chatId});e.markMessage(this.context.id);this.menuInstance.close()}}}getCreateItem(){if(babelHelpers.classPrivateFieldLooseBase(this,be)[be]()){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE"),items:[this.getCreateTaskItem(),this.getCreateMeetingItem(),...this.getMarketItems()]}}getCreateTaskItem(){return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE_TASK"),onclick:()=>{const e=new v.EntityCreator(this.context.chatId);void e.createTaskForMessage(this.context.id);this.menuInstance.close()}}}getCreateMeetingItem(){return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_CREATE_MEETING"),onclick:()=>{const e=new v.EntityCreator(this.context.chatId);void e.createMeetingForMessage(this.context.id);this.menuInstance.close()}}}getEditItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]()||babelHelpers.classPrivateFieldLooseBase(this,be)[be]()){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_EDIT"),onclick:()=>{P.EventEmitter.emit(y.EventType.textarea.editMessage,{messageId:this.context.id});this.menuInstance.close()}}}getDeleteItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]()||babelHelpers.classPrivateFieldLooseBase(this,be)[be]()){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_DELETE"),onclick:()=>{const e=new L.MessageService({chatId:this.context.chatId});e.deleteMessage(this.context.id);this.menuInstance.close()}}}getMarketItems(){const{dialogId:e,id:t}=this.context;const s=this.marketManager.getAvailablePlacementsByType(y.PlacementType.contextMenu,e);const i=[];if(s.length>0){i.push(this.getDelimiter())}const a={messageId:t,dialogId:e};s.forEach((e=>{i.push({text:e.title,onclick:()=>{m.MarketManager.openSlider(e,a);this.menuInstance.close()}})}));const o=11;return i.slice(0,o)}getDownloadFileItem(){const e=babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]();if(!e){return null}return{html:D.Utils.file.createDownloadLink(F.Loc.getMessage("IM_DIALOG_CHAT_MENU_DOWNLOAD_FILE"),e.urlDownload,e.name),onclick:function(){this.menuInstance.close()}.bind(this)}}getSaveToDisk(){const e=babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]();if(!e){return null}return{text:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE_ON_DISK"),onclick:function(){void this.diskService.save(e.id).then((()=>{BX.UI.Notification.Center.notify({content:F.Loc.getMessage("IM_DIALOG_CHAT_MENU_SAVE_ON_DISK_SUCCESS")})}));this.menuInstance.close()}.bind(this)}}getDelimiter(){return{delimiter:true}}}function Se(){return this.context.authorId===w.Core.getUserId()}function Le(){return this.context.isDeleted}function Ce(){if(this.context.files.length===0){return null}return this.store.getters["files/get"](this.context.files[0])}class Pe extends I.BaseMenu{constructor(){super();this.id="bx-im-avatar-context-menu";this.permissionManager=f.PermissionManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:21}}getMenuItems(){return[this.getMentionItem(),this.getSendItem(),this.getProfileItem(),this.getKickItem()]}getMentionItem(){return{text:F.Loc.getMessage("IM_DIALOG_AVATAR_MENU_MENTION_2"),onclick:()=>{P.EventEmitter.emit(y.EventType.textarea.insertMention,{mentionText:this.context.user.name,mentionReplacement:D.Utils.text.getMentionBbCode(this.context.user.id,this.context.user.name)});this.menuInstance.close()}}}getSendItem(){return{text:F.Loc.getMessage("IM_DIALOG_AVATAR_MENU_SEND_MESSAGE"),onclick:()=>{b.Messenger.openChat(this.context.user.id);this.menuInstance.close()}}}getProfileItem(){return{text:F.Loc.getMessage("IM_DIALOG_AVATAR_MENU_OPEN_PROFILE"),href:D.Utils.user.getProfileLink(this.context.user.id),onclick:()=>{this.menuInstance.close()}}}getKickItem(){const e=this.permissionManager.canPerformKick(this.context.dialog.dialogId,this.context.user.id);if(!e){return null}return{text:F.Loc.getMessage("IM_DIALOG_AVATAR_MENU_KICK"),onclick:async()=>{this.menuInstance.close();const e=await S.showKickUserConfirm();if(e===true){const e=new L.ChatService;e.kickUserFromChat(this.context.dialog.dialogId,this.context.user.id)}}}}}const Te="BX.Messenger.v2.Dialog.ObserverManager";var _e=babelHelpers.classPrivateFieldLooseKey("observer");var xe=babelHelpers.classPrivateFieldLooseKey("observedElements");var Be=babelHelpers.classPrivateFieldLooseKey("visibleMessages");var we=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var ye=babelHelpers.classPrivateFieldLooseKey("dialogInited");var He=babelHelpers.classPrivateFieldLooseKey("initObserver");var Ee=babelHelpers.classPrivateFieldLooseKey("getMessageIdFromElement");var Fe=babelHelpers.classPrivateFieldLooseKey("messageIsViewed");class Ae extends P.EventEmitter{constructor(){super();Object.defineProperty(this,Fe,{value:ke});Object.defineProperty(this,Ee,{value:Ue});Object.defineProperty(this,He,{value:De});Object.defineProperty(this,_e,{writable:true,value:void 0});Object.defineProperty(this,xe,{writable:true,value:{}});Object.defineProperty(this,Be,{writable:true,value:new Set});Object.defineProperty(this,we,{writable:true,value:new Set});Object.defineProperty(this,ye,{writable:true,value:false});this.setEventNamespace(Te);babelHelpers.classPrivateFieldLooseBase(this,He)[He]()}setDialogInited(e){Object.values(babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]).forEach((e=>{this.unobserveMessage(e);this.observeMessage(e)}));babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]=e}observeMessage(e){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e].observe(e);if(babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e)){babelHelpers.classPrivateFieldLooseBase(this,xe)[xe][e.dataset.id]=e}}unobserveMessage(e){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e].unobserve(e);if(babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e)){delete babelHelpers.classPrivateFieldLooseBase(this,xe)[xe][e.dataset.id]}}onReadMessage(e){babelHelpers.classPrivateFieldLooseBase(this,we)[we].delete(e)}getMessagesToRead(){return[...babelHelpers.classPrivateFieldLooseBase(this,we)[we]]}getFirstVisibleMessage(){if(babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].size===0){return 0}const[e]=[...babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]].sort(((e,t)=>e-t));return e}}function De(){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]=new IntersectionObserver((e=>{e.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee](e.target);if(!t||!e.rootBounds||!babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]){return}const s=e.isIntersecting&&e.intersectionRatio>=.99;const i=e.intersectionRect.height>=e.rootBounds.height/2.2;if(s||i){babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].add(t);if(!babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe](e.target)){babelHelpers.classPrivateFieldLooseBase(this,we)[we].add(t);this.emit(Ae.events.onMessageIsVisible)}}else{babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].delete(t);if(babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe](e.target)){babelHelpers.classPrivateFieldLooseBase(this,we)[we].delete(t)}}}))}),{threshold:Array.from({length:101}).fill(0).map(((e,t)=>t*.01))})}function Ue(e){return+e.dataset.id}function ke(e){return e.dataset["viewed"]==="true"}Ae.events={onMessageIsVisible:"onMessageIsVisible"};const Oe="IM_PUBLIC_";var Ne=babelHelpers.classPrivateFieldLooseKey("dialog");var Ge=babelHelpers.classPrivateFieldLooseKey("pullClient");var Re=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");var Xe=babelHelpers.classPrivateFieldLooseKey("isGuest");class $e{constructor(e){Object.defineProperty(this,Xe,{value:je});Object.defineProperty(this,Re,{value:Ke});Object.defineProperty(this,Ne,{writable:true,value:void 0});Object.defineProperty(this,Ge,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne]=w.Core.getStore().getters["dialogues/get"](e);babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]=w.Core.getPullClient()}onChatLoad(){if(!babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]()){return}babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].extendWatch(`${Oe}${babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].chatId}`)}onChatExit(){if(!babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]()){return}babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].clearWatch(`${Oe}${babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].chatId}`)}onLoadedChatEnter(){if(!babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]()){return}babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]();babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].extendWatch(`${Oe}${babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].chatId}`,true)}}function Ke(){T.runAction(y.RestMethod.imV2ChatExtendPullWatch,{data:{dialogId:babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dialogId}})}function je(){return babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].role===y.UserRole.guest&&babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].dialogId!=="settings"}const Ve={data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-dialog-chat__new-message-block">\n\t\t\t<div class="bx-im-dialog-chat__new-message-block_text">{{ loc('IM_DIALOG_CHAT_BLOCK_NEW_MESSAGES_2') }}</div>\n\t\t</div>\n\t`};const qe={data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-dialog-chat__new-message-block">\n\t\t\t<div class="bx-im-dialog-chat__new-message-block_text">{{ loc('IM_DIALOG_CHAT_BLOCK_MARKED_MESSAGES') }}</div>\n\t\t</div>\n\t`};const We={props:{title:{type:String,required:true}},data(){return{}},template:`\n\t\t<div class="bx-im-dialog-chat__date-group_title_container">\n\t\t\t<div class="bx-im-dialog-chat__date-group_title">{{ title }}</div>\n\t\t</div>\n\t`};const Qe={props:{message:{type:Object,required:true}},data(){return{}},computed:{internalMessage(){return this.message},text(){return _.Parser.purifyMessage(this.internalMessage)},authorId(){return this.internalMessage.authorId},author(){return this.$store.getters["users/get"](this.authorId)}},template:`\n\t\t<div class="bx-im-dialog-chat__pinned_item">\n\t\t\t<span v-if="author" class="bx-im-dialog-chat__pinned_item_user">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`};const Ye={components:{PinnedMessage:Qe},props:{messages:{type:Array,required:true}},emits:["messageClick","messageUnpin"],data(){return{}},computed:{firstMessage(){return this.messagesToShow[0]},messagesToShow(){return this.messages.slice(-1)}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div @click="$emit('messageClick', firstMessage.id)" class="bx-im-dialog-chat__pinned_container">\n\t\t\t<div class="bx-im-dialog-chat__pinned_title">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for="message in messagesToShow"\n\t\t\t\t:message="message"\n\t\t\t\t:key="message.id"\n\t\t\t\t@click="$emit('messageClick', message.id)"\n\t\t\t/>\n\t\t\t<div @click.stop="$emit('messageUnpin', firstMessage.id)" class="bx-im-dialog-chat__pinned_unpin"></div>\n\t\t</div>\n\t`};var ze=babelHelpers.classPrivateFieldLooseKey("store");var Je=babelHelpers.classPrivateFieldLooseKey("restClient");var Ze=babelHelpers.classPrivateFieldLooseKey("userManager");class et{constructor(){Object.defineProperty(this,ze,{writable:true,value:void 0});Object.defineProperty(this,Je,{writable:true,value:void 0});Object.defineProperty(this,Ze,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]=w.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]=w.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]=new H.UserManager}loadReadUsers(e){let t=[];E.Logger.warn("Dialog: UserService: loadReadUsers",e);return babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].callMethod(y.RestMethod.imV2ChatMessageTailViewers,{id:e}).then((e=>{t=e.data().users;return babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].setUsersToModel(Object.values(t))})).then((()=>t.map((e=>e.id)))).catch((e=>{console.error("Dialog: UserService: loadReadUsers error",e);throw new Error(e)}))}}const tt={components:{UserListPopup:B.UserListPopup},props:{dialogId:{type:String,required:true},show:{type:Boolean,required:true},bindElement:{type:Object,required:true}},emits:["close"],data(){return{showPopup:false,loadingAdditionalUsers:false,additionalUsers:[]}},computed:{dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)}},watch:{show(e,t){if(!t&&e){this.showPopup=true;this.loadUsers()}}},methods:{loadUsers(){this.loadingAdditionalUsers=true;this.getUserService().loadReadUsers(this.dialog.lastMessageId).then((e=>{this.additionalUsers=this.prepareAdditionalUsers(e);this.loadingAdditionalUsers=false})).catch((()=>{this.loadingAdditionalUsers=false}))},onPopupClose(){this.showPopup=false;this.$emit("close")},prepareAdditionalUsers(e){const t=this.dialog.lastMessageViews.firstViewer.userId;return e.filter((e=>e!==w.Core.getUserId()&&e!==t))},getUserService(){if(!this.userService){this.userService=new et}return this.userService}},template:`\n\t\t<UserListPopup\n\t\t\tid="bx-im-dialog-read-users"\n\t\t\t:showPopup="showPopup"\n\t\t\t:loading="loadingAdditionalUsers"\n\t\t\t:userIds="additionalUsers"\n\t\t\t:bindElement="bindElement || {}"\n\t\t\t:withAngle="false"\n\t\t\t:forceTop="true"\n\t\t\t@close="onPopupClose"\n\t\t/>\n\t`};const st=3;const it="bx-im-dialog-chat-status__user-count";const at={components:{AdditionalUsers:tt},props:{dialogId:{required:true,type:String}},data(){return{showAdditionalUsers:false,additionalUsersLinkElement:null}},computed:{dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},isUser(){return this.dialog.type===y.DialogType.user},isChat(){return!this.isUser},typingStatus(){if(!this.dialog.inited||this.dialog.writingList.length===0){return""}const e=this.dialog.writingList.slice(0,st);const t=e.map((e=>e.userName)).join(", ");const s=this.dialog.writingList.length-st;if(s>0){return this.loc("IM_DIALOG_CHAT_STATUS_TYPING_PLURAL",{"#USER#":t,"#COUNT#":s})}return this.loc("IM_DIALOG_CHAT_STATUS_TYPING",{"#USER#":t})},readStatus(){if(!this.dialog.inited){return""}if(this.lastMessageViews.countOfViewers===0){return""}if(this.isUser){return this.formatUserViewStatus()}return this.formatChatViewStatus()},lastMessageViews(){return this.dialog.lastMessageViews}},methods:{formatUserViewStatus(){const{date:e}=this.lastMessageViews.firstViewer;return this.loc("IM_DIALOG_CHAT_STATUS_READ_USER",{"#DATE#":x.DateFormatter.formatByTemplate(e,x.DateTemplate.messageReadStatus)})},formatChatViewStatus(){const{countOfViewers:e,firstViewer:t}=this.lastMessageViews;if(e===1){return this.loc("IM_DIALOG_CHAT_STATUS_READ_CHAT",{"#USER#":t.userName})}return this.loc("IM_DIALOG_CHAT_STATUS_READ_CHAT_PLURAL",{"#USERS#":F.Text.encode(t.userName),"#LINK_START#":`<span class="${it}" ref="moreUsersLink">`,"#COUNT#":e-1,"#LINK_END#":"</span>"})},onClick(e){if(!e.target.matches(`.${it}`)){return}this.onMoreUsersClick()},onMoreUsersClick(){this.additionalUsersLinkElement=document.querySelector(`.${it}`);this.showAdditionalUsers=true},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div @click="onClick" class="bx-im-dialog-chat-status__container">\n\t\t\t<div v-if="typingStatus" class="bx-im-dialog-chat-status__content">\n\t\t\t\t<div class="bx-im-dialog-chat-status__icon --typing"></div>\n\t\t\t\t<div class="bx-im-dialog-chat-status__text">{{ typingStatus }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if="readStatus" class="bx-im-dialog-chat-status__content">\n\t\t\t\t<div class="bx-im-dialog-chat-status__icon --read"></div>\n\t\t\t\t<div v-html="readStatus" class="bx-im-dialog-chat-status__text"></div>\n\t\t\t</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:show="showAdditionalUsers"\n\t\t\t\t:bindElement="additionalUsersLinkElement || {}"\n\t\t\t\t@close="showAdditionalUsers = false"\n\t\t\t/>\n\t\t</div>\n\t`};const ot={name:"DialogLoader",props:{fullHeight:{type:Boolean,default:true}},data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-dialog-loader__container" :class="{'--full-height': fullHeight}">\n\t\t\t<div class="bx-im-dialog-loader__spinner"></div>\n\t\t\t<div class="bx-im-dialog-loader__text">{{ loc('IM_DIALOG_CHAT_LOADER_TEXT') }}</div>\n\t\t</div>\n\t`};var rt;const nt=44;const lt=60;const ct=10;const gt=U.MessengerSlider.getInstance().getCurrent();const dt=gt==null?void 0:gt.layout.container.getBoundingClientRect();const ht=(rt=dt==null?void 0:dt.top)!=null?rt:0;const ut={name:"QuoteButton",data(){return{text:"",message:null,mouseX:0,mouseY:0}},computed:{containerStyle(){return{top:`${this.mouseY-nt-ct-ht}px`,left:`${this.mouseX-lt/2}px`,width:`${lt}px`,height:`${nt}px`}}},mounted(){F.Event.bind(window,"mousedown",this.onMouseDown)},methods:{onMessageMouseUp(e,t){if(t.button===2){return}this.prepareSelectedText();this.message=e;this.mouseX=t.clientX;this.mouseY=t.clientY},onMouseDown(e){const t=this.$refs.container;if(!t||t.contains(e.target)){return}this.$emit("close")},prepareSelectedText(){if(D.Utils.browser.isFirefox()){this.text=window.getSelection().toString();return}const e=window.getSelection().getRangeAt(0);const t=e.cloneContents().childNodes;for(const e of t){if(this.isImage(e)){var s;this.text+=(s=e.getAttribute("data-code"))!=null?s:e.getAttribute("alt")}else if(this.isLineBreak(e)){this.text+="\n"}else if(this.isMessageTextNode(e)||this.isText(e)){this.text+=e.textContent}}},isImage(e){if(!(e instanceof HTMLElement)){return false}return e.tagName.toLowerCase()==="img"},isLineBreak(e){return e.nodeName.toLowerCase()==="br"},isText(e){return e.nodeName==="#text"},isMessageTextNode(e){if(!(e instanceof HTMLElement)){return false}const t=".bx-im-message-default-content__text";const s=e.querySelector(t);return Boolean(s)},onQuoteClick(){A.Quote.sendQuoteEvent(this.message,this.text);this.$emit("close")}},template:`\n\t\t<div ref="container" @click="onQuoteClick" :style="containerStyle" class="bx-im-dialog-chat__quote-button">\n\t\t\t<div class="bx-im-dialog-chat__quote-icon"></div>\n\t\t\t<div class="bx-im-dialog-chat__quote-icon --hover"></div>\n\t\t</div>\n\t`};const pt=52;const vt=200;const mt={name:"ChatDialog",components:{Avatar:B.Avatar,DefaultMessage:a.DefaultMessage,FileMessage:i.FileMessage,SmileMessage:l.SmileMessage,CallInviteMessage:o.CallInviteMessage,DeletedMessage:r.DeletedMessage,SystemMessage:c.SystemMessage,UnsupportedMessage:n.UnsupportedMessage,ChatCreationMessage:g.ChatCreationMessage,ConferenceCreationMessage:d.ConferenceCreationMessage,PinnedMessages:Ye,NewMessagesBlock:Ve,MarkedMessagesBlock:qe,DateGroupTitle:We,ChatInfoPopup:B.ChatInfoPopup,DialogStatus:at,DialogLoader:ot,QuoteButton:ut,PullStatus:s.PullStatus},directives:{"message-observer":{mounted(e,t){t.instance.observerManager.observeMessage(e)},beforeUnmount(e,t){t.instance.observerManager.unobserveMessage(e)}}},props:{dialogId:{type:String,default:""},textareaHeight:{type:Number,default:0}},data(){return{messageMenuIsActiveForId:0,chatInfoPopup:{element:null,dialogId:0,show:false},contextMode:{active:false,messageIsLoaded:false},initialScrollCompleted:false,isScrolledUp:false,windowFocused:false,showQuoteButton:false,selectedText:null,quoteButtonStyles:{},quoteButtonMessage:0}},computed:{BlockType:()=>y.DialogBlockType,AvatarSize:()=>B.AvatarSize,layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["dialogues/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},formattedCollection(){if(!this.dialogInited&&this.messageCollection.length===0){return[]}return this.getCollectionManager().formatMessageCollection(this.messageCollection)},messageCollection(){return this.$store.getters["messages/get"](this.dialog.chatId)},pinnedMessages(){return this.$store.getters["messages/pin/getPinned"](this.dialog.chatId)},isOpened(){const e=this.$store.getters["application/getLayout"].entityId;return this.dialogId===e},isGuest(){return this.dialog.role===y.UserRole.guest},debouncedScrollHandler(){const e=200;return F.Runtime.debounce(this.getScrollManager().onScroll,e,this.getScrollManager())},debouncedReadHandler(){return F.Runtime.debounce(this.readVisibleMessages,50,this)},formattedCounter(){if(this.dialog.counter===0){return""}if(this.dialog.counter>99){return"99+"}return String(this.dialog.counter)},showDialogStatus(){return this.messageCollection.some((e=>e.id===this.dialog.lastMessageId))},showScrollButton(){return this.isScrolledUp||this.dialog.hasNextPage}},watch:{dialogInited(e,t){if(!e||t){return}this.getPullWatchManager().onChatLoad();this.onChatInited()},textareaHeight(){if(this.isScrolledUp||!this.dialogInited){return}void this.$nextTick((()=>{this.getScrollManager().scrollToBottom()}))}},created(){E.Logger.warn("Dialog: Chat created",this.dialogId);this.getCollectionManager();this.initContextMenu();this.initObserverManager();this.initContextMode()},mounted(){this.getScrollManager().setContainer(this.getContainer());if(this.dialogInited){this.getPullWatchManager().onLoadedChatEnter();this.onChatInited()}else if(!this.dialogInited&&this.messageCollection.length>0){this.scrollOnStart()}this.windowFocused=document.hasFocus();this.subscribeToEvents()},beforeUnmount(){this.closeMessageMenu();this.unsubscribeFromEvents();if(this.dialogInited){this.saveScrollPosition();this.loadMessagesOnExit()}this.getPullWatchManager().onChatExit()},methods:{readVisibleMessages(){if(!this.dialogInited||!this.windowFocused||this.hasVisibleCall()||this.isGuest){return}this.getObserverManager().getMessagesToRead().forEach((e=>{this.getChatService().readMessage(this.dialog.chatId,e);this.getObserverManager().onReadMessage(e)}))},scrollOnStart(){void this.$nextTick((()=>{if(this.contextMode.active&&this.contextMode.messageIsLoaded){this.getScrollManager().scrollToMessage(this.layout.contextId,-pt);void this.$nextTick((()=>{this.highlightMessage(this.layout.contextId)}))}else if(this.contextMode.active&&!this.contextMode.messageIsLoaded){void this.goToMessageContext(this.layout.contextId)}else if(this.dialog.markedId){this.getScrollManager().scrollToMessage(y.DialogBlockType.newMessages,-pt)}else if(this.dialog.savedPositionMessageId){E.Logger.warn("Dialog: saved scroll position, scrolling to",this.dialog.savedPositionMessageId);this.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId)}else if(this.$store.getters["dialogues/getLastReadId"](this.dialogId)){this.getScrollManager().scrollToMessage(y.DialogBlockType.newMessages,-pt)}else if(this.$store.getters["messages/getFirstUnread"](this.dialog.chatId)){E.Logger.warn("Dialog: new chat with unread messages, dont scroll")}else{this.getScrollManager().scrollToBottom()}}))},goToMessageContext(e){const t=this.$store.getters["messages/hasMessage"]({chatId:this.dialog.chatId,messageId:e});if(t){E.Logger.warn("Dialog: we have this message, scrolling to it",e);return this.getScrollManager().animatedScrollToMessage(e,-pt).then((()=>{this.highlightMessage(e);return true}))}return this.getMessageService().loadContext(e).then((()=>this.$nextTick())).then((()=>{this.getScrollManager().scrollToMessage(e,-pt);return this.$nextTick()})).then((()=>{this.highlightMessage(e);return true})).catch((e=>{E.Logger.error("goToMessageContext error",e)}))},highlightMessage(e){const t="bx-im-dialog-chat__highlighted-message";const s=2e3;const i=this.getScrollManager().getDomElementById(e);if(!i){return}F.Dom.addClass(i,t);setTimeout((()=>{F.Dom.removeClass(i,t)}),s)},saveScrollPosition(){let e=this.getObserverManager().getFirstVisibleMessage();if(this.getScrollManager().isAroundBottom()){e=0}this.$store.dispatch("dialogues/update",{dialogId:this.dialogId,fields:{savedPositionMessageId:e}})},loadMessagesOnExit(){setTimeout((()=>{void this.getMessageService().reloadMessageList()}),vt)},initContextMode(){if(!this.layout.contextId){return}this.contextMode.active=true;this.contextMode.messageIsLoaded=!this.dialogInited},initContextMenu(){this.messageMenu=new fe;this.messageMenu.subscribe(fe.events.onCloseMenu,(()=>{this.messageMenuIsActiveForId=0}));this.avatarMenu=new Pe},initObserverManager(){this.observerManager=new Ae;this.observerManager.subscribe(Ae.events.onMessageIsVisible,(()=>{this.debouncedReadHandler()}))},getObserverManager(){return this.observerManager},getCollectionManager(){if(!this.collectionManager){this.collectionManager=new me(this.dialogId)}return this.collectionManager},getMessageService(){if(!this.messageService){this.messageService=new L.MessageService({chatId:this.dialog.chatId})}return this.messageService},getChatService(){if(!this.chatService){this.chatService=new L.ChatService}return this.chatService},getScrollManager(){if(!this.scrollManager){this.scrollManager=new ve;this.scrollManager.subscribe(ve.events.onScrollTriggerUp,this.onScrollTriggerUp);this.scrollManager.subscribe(ve.events.onScrollTriggerDown,this.onScrollTriggerDown);this.scrollManager.subscribe(ve.events.onScrollThresholdPass,(e=>{this.isScrolledUp=e.getData()}))}return this.scrollManager},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new $e(this.dialogId)}return this.pullWatchManager},onChatInited(){if(!this.dialog.loading){this.scrollOnStart();this.readVisibleMessages();this.getObserverManager().setDialogInited(true)}void this.$nextTick((()=>{this.getChatService().clearDialogMark(this.dialogId)}));P.EventEmitter.emit(y.EventType.dialog.onDialogInited,{dialogId:this.dialogId})},async onScrollTriggerUp(){if(!this.dialogInited||!this.getContainer()){return}E.Logger.warn("Dialog: scroll triggered UP");const e=this.getContainer();const t=e.scrollHeight-e.clientHeight;if(this.getMessageService().hasPreparedHistoryMessages()){await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(t);return}if(this.getMessageService().isLoading()||!this.dialog.hasPrevPage){return}await this.getMessageService().loadHistory();if(this.getScrollManager().isAtTheTop()){E.Logger.warn("Dialog: we are at the top after history request, inserting messages");await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(t)}},async onScrollTriggerDown(){if(!this.dialogInited||!this.getContainer()){return}E.Logger.warn("Dialog: scroll triggered DOWN");if(this.getMessageService().hasPreparedUnreadMessages()){await this.getMessageService().drawPreparedUnreadMessages();return}if(this.getMessageService().isLoading()||!this.dialog.hasNextPage){return}await this.getMessageService().loadUnread();if(this.getScrollManager().isAroundBottom()){E.Logger.warn("Dialog: we are at the bottom after unread request, inserting messages");await this.getMessageService().drawPreparedUnreadMessages();this.getScrollManager().checkIfChatIsScrolledUp()}},onScrollToBottom(e){const{chatId:t,threshold:s=y.DialogScrollThreshold.halfScreenUp,animation:i=true}=e.getData();if(this.dialog.chatId!==t){return}if(!this.windowFocused||this.hasVisibleCall()){const e=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(e){void this.$nextTick((()=>{this.getScrollManager().scrollToMessage(e,-pt)}));return}}E.Logger.warn("Dialog: scroll to bottom",t,s);if(s===y.DialogScrollThreshold.halfScreenUp&&this.isScrolledUp){return}if(s===y.DialogScrollThreshold.nearTheBottom&&!this.getScrollManager().isAroundBottom()){return}void this.$nextTick((()=>{if(i){this.getScrollManager().animatedScrollToBottom();return}this.getScrollManager().scrollToBottom()}))},onGoToMessageContext(e){const{dialogId:t,messageId:s}=e.getData();if(this.dialog.dialogId!==t){return}void this.goToMessageContext(s)},onOpenChatInfo(e){const{dialogId:t,event:s}=e.getData();this.chatInfoPopup.element=s.target;this.chatInfoPopup.dialogId=t;this.chatInfoPopup.show=true},onPinnedMessageClick(e){void this.goToMessageContext(e)},onPinnedMessageUnpin(e){this.getMessageService().unpinMessage(this.dialog.chatId,e)},onMessageContextMenuClick(e){const{message:t,event:s}=e.getData();const i={dialogId:this.dialogId,...t};this.messageMenu.openMenu(i,s.currentTarget);this.messageMenuIsActiveForId=t.id},onScroll(e){this.closeDialogPopups();this.debouncedScrollHandler(e)},async onScrollButtonClick(){if(this.getScrollManager().scrollButtonClicked){this.handleSecondScrollButtonClick();return}this.getScrollManager().scrollButtonClicked=true;if(this.dialog.counter===0){await this.getMessageService().loadInitialMessages();this.getScrollManager().scrollToBottom();return}const e=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(!e){await this.getMessageService().loadInitialMessages();await this.getScrollManager().animatedScrollToMessage(e,-pt)}await this.getScrollManager().animatedScrollToMessage(e,-pt)},onWindowFocus(){this.windowFocused=true;this.readVisibleMessages()},onWindowBlur(){this.windowFocused=false},onAvatarClick(e,t){const s=this.$store.getters["users/get"](e);const i=Number.parseInt(e,10);if(!s||w.Core.getUserId()===i){return}if(D.Utils.key.isAltOrOption(t)){P.EventEmitter.emit(y.EventType.textarea.insertMention,{mentionText:s.name,mentionReplacement:D.Utils.text.getMentionBbCode(s.id,s.name)});return}this.avatarMenu.openMenu({user:s,dialog:this.dialog},t.currentTarget)},onCallFold(){const e=h.CallManager.getInstance().getCurrentCallDialogId();if(e!==this.dialogId){return}this.readVisibleMessages()},onChatClick(e){if(this.isGuest){e.stopPropagation()}},handleSecondScrollButtonClick(){this.getScrollManager().scrollButtonClicked=false;if(this.dialog.hasNextPage){this.getMessageService().loadContext(this.dialog.lastMessageId).then((()=>{P.EventEmitter.emit(y.EventType.dialog.scrollToBottom,{chatId:this.dialog.chatId})})).catch((e=>{E.Logger.error("ChatDialog: scroll to chat end loadContext error",e)}));return}void this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId)},hasVisibleCall(){return h.CallManager.getInstance().hasVisibleCall()},closeDialogPopups(){var e,s,i;this.closeMessageMenu();this.chatInfoPopup.show=false;this.showQuoteButton=false;this.avatarMenu.close();(e=t.PopupManager.getPopupById(y.PopupType.dialogReactionUsers))==null?void 0:e.close();(s=t.PopupManager.getPopupById(y.PopupType.dialogReadUsers))==null?void 0:s.close();(i=t.PopupManager.getPopupById(y.PopupType.messageBaseFileMenu))==null?void 0:i.close()},closeMessageMenu(){this.messageMenu.close();this.messageMenuIsActiveForId=0},subscribeToEvents(){P.EventEmitter.subscribe(y.EventType.dialog.scrollToBottom,this.onScrollToBottom);P.EventEmitter.subscribe(y.EventType.dialog.goToMessageContext,this.onGoToMessageContext);P.EventEmitter.subscribe(y.EventType.mention.openChatInfo,this.onOpenChatInfo);P.EventEmitter.subscribe(y.EventType.call.onFold,this.onCallFold);P.EventEmitter.subscribe(y.EventType.dialog.onClickMessageContextMenu,this.onMessageContextMenuClick);F.Event.bind(window,"focus",this.onWindowFocus);F.Event.bind(window,"blur",this.onWindowBlur)},unsubscribeFromEvents(){P.EventEmitter.unsubscribe(y.EventType.dialog.scrollToBottom,this.onScrollToBottom);P.EventEmitter.unsubscribe(y.EventType.dialog.goToMessageContext,this.onGoToMessageContext);P.EventEmitter.unsubscribe(y.EventType.mention.openChatInfo,this.onOpenChatInfo);P.EventEmitter.unsubscribe(y.EventType.call.onFold,this.onCallFold);P.EventEmitter.unsubscribe(y.EventType.dialog.onClickMessageContextMenu,this.onMessageContextMenuClick);F.Event.unbind(window,"focus",this.onWindowFocus);F.Event.unbind(window,"blur",this.onWindowBlur)},getContainer(){return this.$refs.container},async onMessageMouseUp(e,t){await D.Utils.browser.waitForSelectionToUpdate();const s=window.getSelection().toString().trim();if(s.length===0||this.isGuest){return}this.showQuoteButton=true;await this.$nextTick();this.$refs.quoteButton.onMessageMouseUp(e,t)},getMessageComponentName(e){return new z(e).getName()}},template:`\n\t\t<div class="bx-im-dialog-chat__block bx-im-dialog-chat__scope">\n\t\t\t<PinnedMessages\n\t\t\t\tv-if="pinnedMessages.length > 0"\n\t\t\t\t:messages="pinnedMessages"\n\t\t\t\t@messageClick="onPinnedMessageClick"\n\t\t\t\t@messageUnpin="onPinnedMessageUnpin"\n\t\t\t/>\n\t\t\t<PullStatus/>\n\t\t\t<div @scroll="onScroll" @click.capture="onChatClick" class="bx-im-dialog-chat__scroll-container" ref="container">\n\t\t\t\t<div class="bx-im-dialog-chat__content">\n\t\t\t\t\t\x3c!-- Loader --\x3e\n\t\t\t\t\t<DialogLoader v-if="!dialogInited" :fullHeight="formattedCollection.length === 0" />\n\t\t\t\t\t\x3c!-- Date groups --\x3e\n\t\t\t\t\t<div v-for="dateGroup in formattedCollection" :key="dateGroup.date.id" class="bx-im-dialog-chat__date-group_container">\n\t\t\t\t\t\t\x3c!-- Date mark --\x3e\n\t\t\t\t\t\t<DateGroupTitle :title="dateGroup.date.title" />\n\t\t\t\t\t\t\x3c!-- Single date group --\x3e\n\t\t\t\t\t\t<template v-for="dateGroupItem in dateGroup.items">\n\t\t\t\t\t\t\t\x3c!-- 'New messages' mark --\x3e\n\t\t\t\t\t\t\t<MarkedMessagesBlock v-if="dateGroupItem.type === BlockType.markedMessages" data-id="newMessages" />\n\t\t\t\t\t\t\t<NewMessagesBlock v-else-if="dateGroupItem.type === BlockType.newMessages" data-id="newMessages" />\n\t\t\t\t\t\t\t\x3c!-- Author group --\x3e\n\t\t\t\t\t\t\t<div v-else-if="dateGroupItem.type === BlockType.authorGroup" :class="'--' + dateGroupItem.messageType" class="bx-im-dialog-chat__author-group_container">\n\t\t\t\t\t\t\t\t\x3c!-- Author group avatar --\x3e\n\t\t\t\t\t\t\t\t<div v-if="dateGroupItem.avatar.isNeeded" class="bx-im-dialog-chat__author-group_avatar">\n\t\t\t\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t\t\t\t:dialogId="dateGroupItem.avatar.avatarId"\n\t\t\t\t\t\t\t\t\t\t:size="AvatarSize.L"\n\t\t\t\t\t\t\t\t\t\t:withStatus="false"\n\t\t\t\t\t\t\t\t\t\t@click="onAvatarClick(dateGroupItem.avatar.avatarId, $event)"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\x3c!-- Messages --\x3e\n\t\t\t\t\t\t\t\t<div class="bx-im-dialog-chat__messages_container">\n\t\t\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t\t\tv-for="(message, index) in dateGroupItem.items"\n\t\t\t\t\t\t\t\t\t\tv-message-observer\n\t\t\t\t\t\t\t\t\t\t:is="getMessageComponentName(message)"\n\t\t\t\t\t\t\t\t\t\t:withTitle="index === 0"\n\t\t\t\t\t\t\t\t\t\t:item="message"\n\t\t\t\t\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t\t\t\t\t:key="message.id"\n\t\t\t\t\t\t\t\t\t\t:menuIsActiveForId="messageMenuIsActiveForId"\n\t\t\t\t\t\t\t\t\t\t:withAvatar="dateGroupItem.avatar.isNeeded"\n\t\t\t\t\t\t\t\t\t\t:data-viewed="message.viewed"\n\t\t\t\t\t\t\t\t\t\t@mouseup="onMessageMouseUp(message, $event)"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</div>\n\t\t\t\t\t<DialogStatus v-if="showDialogStatus" :dialogId="dialogId" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Transition name="scroll-button-transition">\n\t\t\t\t<div v-if="showScrollButton" @click="onScrollButtonClick" class="bx-im-dialog-chat__scroll-button">\n\t\t\t\t\t<div v-if="dialog.counter" class="bx-im-dialog-chat__scroll-button_counter">{{ formattedCounter }}</div>\n\t\t\t\t</div>\n\t\t\t</Transition>\n\t\t\t<ChatInfoPopup\n\t\t\t\tv-if="chatInfoPopup.show"\n\t\t\t\t:dialogId="chatInfoPopup.dialogId"\n\t\t\t\t:bindElement="chatInfoPopup.element"\n\t\t\t\t:showPopup="chatInfoPopup.show"\n\t\t\t\t@close="chatInfoPopup.show = false"\n\t\t\t/>\n            <Transition name="fade-up">\n\t\t\t\t<QuoteButton \n\t\t\t\t\tv-if="showQuoteButton" \n\t\t\t\t\tref="quoteButton"\n\t\t\t\t\t@close="showQuoteButton = false" \n\t\t\t\t\tclass="bx-im-message-base__quote-button" \n\t\t\t\t/>\n            </Transition>\n\t\t</div>\n\t`};e.ChatDialog=mt})(this.BX.Messenger.v2.Component.Dialog=this.BX.Messenger.v2.Component.Dialog||{},BX.Main,window,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Component.Message,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Im.V2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=chat-dialog.bundle.map.js