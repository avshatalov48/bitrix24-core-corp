this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.Embedding=this.BX.Messenger.Embedding||{};(function(e,i,t,s,n,l,a,r,d,o,u,h,c){"use strict";class p{constructor(e={}){this.applicationData={};this.inited=false;this.initPromise=new Promise((e=>{this.initPromiseResolver=e}));this.offline=false;this.vuexAdditionalModel=[];this.store=null;this.storeBuilder=null;this.pullHandlers=[];this.prepareParams(e);this.initStorage().then((()=>this.initPullClient())).then((()=>this.initComplete())).catch((e=>{u.Logger.error("Error initializing core controller",e)}))}prepareParams(e){var i;if(!n.Type.isUndefined(e.localize)){this.localize=e.localize}else{this.localize=BX?{...BX.message}:{}}this.host=(i=e.host)!=null?i:location.origin;this.userId=this.prepareUserId(e.userId);this.siteId=this.getLocalize("SITE_ID")||"s1";if(n.Type.isStringFilled(e.siteId)){this.siteId=e.siteId}this.siteDir=this.getLocalize("SITE_DIR")||"s1";if(n.Type.isStringFilled(e.siteDir)){this.siteDir=e.siteDir}this.languageId=this.getLocalize("LANGUAGE_ID")||"en";if(n.Type.isStringFilled(e.languageId)){this.languageId=e.languageId}this.initPull(e);this.initRest(e);this.initVuexBuilder(e)}initStorage(){const e={common:{host:this.getHost(),userId:this.getUserId(),siteId:this.getSiteId(),languageId:this.getLanguageId()},dialog:{messageLimit:50,enableReadMessages:true},device:{type:h.Utils.device.isMobile()?d.DeviceType.mobile:d.DeviceType.desktop,orientation:h.Utils.device.getOrientation()}};const i=a.Builder.init().addModel(r.ApplicationModel.create().useDatabase(false).setVariables(e)).addModel(r.DialoguesModel.create().useDatabase(false)).addModel(r.UsersModel.create().useDatabase(false)).addModel(r.RecentModel.create().useDatabase(false));this.vuexAdditionalModel.forEach((e=>{i.addModel(e)}));i.setDatabaseConfig({name:this.vuexBuilder.databaseName,type:this.vuexBuilder.databaseType,siteId:this.getSiteId(),userId:this.getUserId()});return i.build().then((e=>{this.store=e.store;this.storeBuilder=e.builder;return Promise.resolve()}))}initPullClient(){if(!this.pullClient){return false}this.pullClient.subscribe(new o.BasePullHandler);this.pullClient.subscribe(new o.RecentPullHandler);this.pullClient.subscribe({type:this.pullInstance.SubscriptionType.Status,callback:this.eventStatusInteraction.bind(this)});this.pullClient.subscribe({type:this.pullInstance.SubscriptionType.Online,callback:this.eventOnlineInteraction.bind(this)});return Promise.resolve()}initComplete(){this.inited=true;this.initPromiseResolver(this)}initRest(e){this.restInstance=s.RestClient;this.restClient=s.rest;if(!n.Type.isUndefined(e.rest)){if(!n.Type.isUndefined(e.rest.instance)){this.restInstance=e.rest.instance}if(!n.Type.isUndefined(e.rest.client)){this.restClient=e.rest.client}}return Promise.resolve()}initPull(e){this.pullInstance=t.PullClient;this.pullClient=t.PULL;if(e.pull){if(e.pull.instance){this.pullInstance=e.pull.instance}if(e.pull.client){this.pullClient=e.pull.client}}}initVuexBuilder(e){this.vuexBuilder={database:false,databaseName:"desktop/im",databaseType:a.BuilderDatabaseType.indexedDb};if(e.vuexBuilder){if(n.Type.isBoolean(e.vuexBuilder.database)){this.vuexBuilder.database=e.vuexBuilder.database}if(n.Type.isStringFilled(e.vuexBuilder.databaseName)){this.vuexBuilder.databaseName=e.vuexBuilder.databaseName}if(n.Type.isStringFilled(e.vuexBuilder.databaseType)){this.vuexBuilder.databaseType=e.vuexBuilder.databaseType}if(n.Type.isArray(e.vuexBuilder.models)){e.vuexBuilder.models.forEach((e=>{this.addVuexModel(e)}))}}}prepareUserId(e){let i=0;if(!n.Type.isUndefined(e)){const e=Number.parseInt(params.userId,10);if(e){i=e}}else if(this.getLocalize("USER_ID")){i=Number.parseInt(this.getLocalize("USER_ID"),10)}return i}eventStatusInteraction(e){if(e.status===this.pullInstance.PullStatus.Online){this.offline=false}else if(e.status===this.pullInstance.PullStatus.Offline){this.offline=true}}eventOnlineInteraction(e){if(!["list","userStatus"].includes(e.command)){return false}Object.values(e.params.users).forEach((e=>{this.store.dispatch("users/update",{id:e.id,fields:e})}))}createVue(e,i={}){let t=()=>{};if(i.beforeCreate){t=i.beforeCreate}let s=()=>{};if(i.unmounted){s=i.unmounted}let n=()=>{};if(i.created){n=i.created}const a=this;const r={beforeCreate(){this.$bitrix.Data.set("controller",a);this.$bitrix.Application.set(e);this.$bitrix.Loc.setMessage(a.localize);if(a.restClient){this.$bitrix.RestClient.set(a.restClient)}if(a.pullClient){this.$bitrix.PullClient.set(a.pullClient)}t.bind(this)()},created(){n.bind(this)()},unmounted(){s.bind(this)()}};if(i.el){r.el=i.el}if(i.template){r.template=i.template}if(i.computed){r.computed=i.computed}if(i.data){r.data=i.data}if(i.name){r.name=i.name}if(i.components){r.components=i.components}const d=r.created;return new Promise((i=>{r.created=function(){d.bind(this)();i(this)};const t=l.BitrixVue.createApp(r);t.config.errorHandler=function(e,i,t){console.error(e,t)};t.config.warnHandler=function(e,i,t){console.warn(e,t)};e.bitrixVue=t;t.use(this.store).mount(r.el)}))}getHost(){return this.host}getUserId(){return this.userId}getSiteId(){return this.siteId}getLanguageId(){return this.languageId}getStore(){return this.store}getRestClient(){return this.restClient}setApplicationData(e,i){this.applicationData[e]=i}getApplicationData(e){var i;return(i=this.applicationData[e])!=null?i:{}}addVuexModel(e){this.vuexAdditionalModel.push(e)}isOnline(){return!this.offline}ready(){if(this.inited){return Promise.resolve(this)}return this.initPromise}addLocalize(e){if(!n.Type.isPlainObject(e)){return false}Object.entries(e).forEach((([e,i])=>{this.localize[e]=i}));return true}getLocalize(e){let i="";if(typeof e==="undefined"){return this.localize}else if(typeof this.localize[e.toString()]==="undefined"){u.Logger.warn(`Controller.Core.getLocalize: message with code '${e.toString()}' is undefined.`)}else{i=this.localize[e]}return i}}const g=new p;e.Core=g;e.CoreApplication=p})(this.BX.Messenger.Embedding.Application=this.BX.Messenger.Embedding.Application||{},BX.Messenger.Embedding.Application,BX,BX,BX,BX.Vue3,BX.Vue3.Vuex,BX.Messenger.Embedding.Model,BX.Messenger.Embedding.Const,BX.Messenger.Embedding.Provider.Pull,BX.Messenger.Embedding.Lib,BX.Messenger.Embedding.Lib,BX.Messenger.Embedding.Lib);
//# sourceMappingURL=core.bundle.map.js