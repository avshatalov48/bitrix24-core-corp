this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.Embedding=this.BX.Messenger.Embedding||{};this.BX.Messenger.Embedding.Provider=this.BX.Messenger.Embedding.Provider||{};(function(e,t,s,r,i,a){"use strict";class d{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.store=null;this.restClient=null;this.dataIsPreloaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null;this.store=r.Core.getStore();this.restClient=r.Core.getRestClient();this.onUpdateStateHandler=this.onUpdateState.bind(this);t.EventEmitter.subscribe(i.EventType.recent.updateState,this.onUpdateStateHandler)}getCollection(){return this.store.getters["recent/getRecentCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){a.Logger.warn(`Im.RecentList: first page was preloaded`);return Promise.resolve()}this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){a.Logger.warn(`Im.RecentList: setting preloaded data`,e);const{items:t,hasMore:s}=e;this.lastMessageDate=this.getLastMessageDate(t);if(!s){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){a.Logger.warn(`Im.RecentList: hide chat`,e);const t=this.store.getters["recent/get"](e);if(!t){return false}this.store.dispatch("recent/delete",{id:e});this.restClient.callMethod(i.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}requestItems({firstPage:e=false}={}){const t=this.getQueryParams(e);return this.restClient.callMethod(this.getQueryMethod(),t).then((e=>{this.pagesLoaded++;a.Logger.warn(`Im.RecentList: ${this.pagesLoaded} page request result`,e.data());const{items:t,hasMore:s}=e.data();this.lastMessageDate=this.getLastMessageDate(t);if(!s){this.hasMoreItemsToLoad=false}return this.updateModels(e.data()).then((()=>{this.isLoading=false}))})).catch((e=>{console.error("Im.RecentList: page request error",e)}))}getQueryMethod(){return i.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y"}}updateModels(e){const{users:t,dialogues:s,recent:r}=this.prepareDataForModels(e);const i=this.store.dispatch("users/set",t);if(e.botList){this.store.dispatch("users/setBotList",e.botList)}const a=this.store.dispatch("dialogues/set",s);const d=this.store.dispatch("recent/setRecent",r);return Promise.all([i,a,d])}onUpdateState({data:e}){a.Logger.warn(`Im.RecentList: setting UpdateState data`,e);this.updateModels(e)}prepareDataForModels({items:e,birthdayList:t=[]}){const s={users:[],dialogues:[],recent:[]};e.forEach((e=>{if(e.user&&e.user.id&&!this.isAddedAlready(s,"users",e.user.id)){s.users.push(e.user)}if(e.chat){s.dialogues.push(this.prepareGroupChat(e));if(e.user.id&&!this.isAddedAlready(s,"dialogues",e.user.id)){s.dialogues.push(this.prepareChatForAdditionalUser(e.user))}}else if(e.user.id){const t=this.store.getters["recent/get"](e.user.id);if(!t||!e.options.default_user_record){s.dialogues.push(this.prepareChatForUser(e))}}s.recent.push({...e})}));t.forEach((e=>{if(!this.isAddedAlready(s,"users",e.id)){s.users.push(e);s.dialogues.push(this.prepareChatForAdditionalUser(e))}if(!this.isAddedAlready(s,"recent",e.id)){s.recent.push(this.getBirthdayPlaceholder(e))}}));a.Logger.warn(`Im.RecentList: prepared data for models`,s);return s}isAddedAlready(e,t,s){if(t==="users"){return e.users.some((e=>e.id===s))}else if(t==="dialogues"){return e.dialogues.some((e=>e.dialogId===s))}else if(t==="recent"){return e.recent.some((e=>e.id===s))}return false}prepareGroupChat(e){return{...e.chat,counter:e.counter,dialogId:e.id}}prepareChatForUser(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:i.DialogType.user,counter:e.counter}}prepareChatForAdditionalUser(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:i.DialogType.user}}getBirthdayPlaceholder(e){return{id:e.id,options:{birthdayPlaceholder:true}}}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}}d.instance=null;e.RecentService=d})(this.BX.Messenger.Embedding.Provider.Service=this.BX.Messenger.Embedding.Provider.Service||{},BX.Event,BX,BX.Messenger.Embedding.Application,BX.Messenger.Embedding.Const,BX.Messenger.Embedding.Lib);
//# sourceMappingURL=registry.bundle.map.js