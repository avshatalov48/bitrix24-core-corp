this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.Embedding=this.BX.Messenger.Embedding||{};(function(e,t,i,s,a,n){"use strict";class o extends i.BuilderModel{getName(){return"application"}getState(){return{common:{host:this.getVariable("common.host",`${location.protocol}//${location.host}`),siteId:this.getVariable("common.siteId","default"),userId:this.getVariable("common.userId",0),languageId:this.getVariable("common.languageId","en")},dialog:{dialogId:this.getVariable("dialog.dialogId","0"),chatId:this.getVariable("dialog.chatId",0),diskFolderId:this.getVariable("dialog.diskFolderId",0),messageLimit:this.getVariable("dialog.messageLimit",20),enableReadMessages:this.getVariable("dialog.enableReadMessages",true)},disk:{enabled:false,maxFileSize:5242880},call:{serverEnabled:false,maxParticipants:24},mobile:{keyboardShow:false},device:{type:this.getVariable("device.type",a.DeviceType.desktop),orientation:this.getVariable("device.orientation",a.DeviceOrientation.portrait)},options:{quoteEnable:this.getVariable("options.quoteEnable",true),quoteFromRight:this.getVariable("options.quoteFromRight",true),autoplayVideo:this.getVariable("options.autoplayVideo",true),darkTheme:this.getVariable("options.darkTheme",false),bigSmileEnable:this.getVariable("options.bigSmileEnable",true)},error:{active:false,code:"",description:""}}}getGetters(){return{getOption:e=>t=>{if(!a.Settings[t]){return false}return e.options[t]}}}getActions(){return{setOptions:(e,i)=>{if(!t.Type.isPlainObject(i)){return false}i=this.validateOptions(i);Object.entries(i).forEach((([t,i])=>{e.commit("setOptions",{option:t,value:i})}))}}}getMutations(){return{update:(e,t)=>{Object.keys(t).forEach((i=>{Object.entries(t[i]).forEach((([t,s])=>{e[i][t]=s}))}))},setOptions:(e,t)=>{e.options[t.option]=t.value}}}validate(e){const t={};if(typeof e.common==="object"&&e.common){t.common={};if(typeof e.common.userId==="number"){t.common.userId=e.common.userId}if(typeof e.common.languageId==="string"){t.common.languageId=e.common.languageId}}if(typeof e.dialog==="object"&&e.dialog){t.dialog={};if(typeof e.dialog.dialogId==="number"){t.dialog.dialogId=e.dialog.dialogId.toString();t.dialog.chatId=0}else if(typeof e.dialog.dialogId==="string"){t.dialog.dialogId=e.dialog.dialogId;if(typeof e.dialog.chatId!=="number"){let i=e.dialog.dialogId;if(i.startsWith("chat")){i=e.dialog.dialogId.substr(4)}i=parseInt(i);t.dialog.chatId=!isNaN(i)?i:0;e.dialog.chatId=t.dialog.chatId}}if(typeof e.dialog.chatId==="number"){t.dialog.chatId=e.dialog.chatId}if(typeof e.dialog.diskFolderId==="number"){t.dialog.diskFolderId=e.dialog.diskFolderId}if(typeof e.dialog.messageLimit==="number"){t.dialog.messageLimit=e.dialog.messageLimit}if(typeof e.dialog.enableReadMessages==="boolean"){t.dialog.enableReadMessages=e.dialog.enableReadMessages}}if(typeof e.disk==="object"&&e.disk){t.disk={};if(typeof e.disk.enabled==="boolean"){t.disk.enabled=e.disk.enabled}if(typeof e.disk.maxFileSize==="number"){t.disk.maxFileSize=e.disk.maxFileSize}}if(typeof e.call==="object"&&e.call){t.call={};if(typeof e.call.serverEnabled==="boolean"){t.call.serverEnabled=e.call.serverEnabled}if(typeof e.call.maxParticipants==="number"){t.call.maxParticipants=e.call.maxParticipants}}if(typeof e.mobile==="object"&&e.mobile){t.mobile={};if(typeof e.mobile.keyboardShow==="boolean"){t.mobile.keyboardShow=e.mobile.keyboardShow}}if(typeof e.device==="object"&&e.device){t.device={};if(typeof e.device.type==="string"&&typeof a.DeviceType[e.device.type]!=="undefined"){t.device.type=e.device.type}if(typeof e.device.orientation==="string"&&typeof a.DeviceOrientation[e.device.orientation]!=="undefined"){t.device.orientation=e.device.orientation}}if(typeof e.error==="object"&&e.error){if(typeof e.error.active==="boolean"){t.error={active:e.error.active,code:e.error.code.toString()||"",description:e.error.description.toString()||""}}}return t}validateOptions(e){const i={};if(!t.Type.isUndefined(e.darkTheme)&&t.Type.isStringFilled(e.darkTheme)){if(e.darkTheme==="auto"&&BX.MessengerProxy){i.darkTheme=BX.MessengerProxy.isDarkTheme()}else{i.darkTheme=e.darkTheme==="dark"}}return i}}const l=35e3;class r extends i.BuilderModel{getName(){return"dialogues"}getState(){return{collection:{},writingStatusTimers:{},chatOptions:{}}}getElementState(){return{dialogId:"0",chatId:0,type:a.DialogType.chat,name:"",description:"",avatar:"",color:a.Color.base,extranet:false,counter:0,userCounter:0,lastReadId:0,markedId:0,lastMessageId:0,lastMessageViews:{countOfViewers:0,firstViewer:null,messageId:0},savedPositionMessageId:0,managerList:[],writingList:[],muteList:[],textareaMessage:"",quoteId:0,owner:0,entityType:"",entityId:"",dateCreate:null,public:{code:"",link:""},inited:false,loading:false,hasPrevPage:false,hasNextPage:false,diskFolderId:0}}getGetters(){return{get:e=>(t,i=false)=>{if(!e.collection[t]&&i){return this.getElementState()}else if(!e.collection[t]&&!i){return null}return e.collection[t]},getByChatId:e=>t=>{t=Number.parseInt(t,10);return Object.values(e.collection).find((e=>e.chatId===t))},getBlank:()=>this.getElementState(),getChatOption:e=>(t,i)=>{if(!e.chatOptions[t]){t="default"}return e.chatOptions[t][i]},getQuoteId:e=>t=>{if(!e.collection[t]){return 0}return e.collection[t].quoteId},isUser:e=>t=>{if(!e.collection[t]){return false}return e.collection[t].type===a.DialogType.user},canLeave:e=>t=>{if(!e.collection[t]){return false}const i=e.collection[t];const n=i.type===a.DialogType.call;const o=i.type===a.DialogType.user;if(n||o){return false}const l=s.Core.getUserId();const r=i.owner===l?a.ChatOption.leaveOwner:a.ChatOption.leave;return this.store.getters["dialogues/getChatOption"](i.type,r)},canMute:e=>t=>{if(!e.collection[t]){return false}const i=e.collection[t];const s=i.type===a.DialogType.user;const n=i.type===a.DialogType.announcement;if(s||n){return null}return this.store.getters["dialogues/getChatOption"](i.type,a.ChatOption.mute)},getLastReadId:e=>t=>{if(!e.collection[t]){return 0}const{lastReadId:i,lastMessageId:s}=e.collection[t];return i===s?0:i},getInitialMessageId:e=>t=>{if(!e.collection[t]){return 0}const{lastReadId:i,markedId:s}=e.collection[t];if(s===0){return i}return Math.min(i,s)}}}getActions(){return{set:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.map((e=>this.validate(e))).forEach((t=>{const i=e.state.collection[t.dialogId];if(i){e.commit("update",{dialogId:t.dialogId,fields:t})}else{e.commit("add",{dialogId:t.dialogId,fields:{...this.getElementState(),...t}})}}))},add:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.map((e=>this.validate(e))).forEach((t=>{const i=e.state.collection[t.dialogId];if(!i){e.commit("add",{dialogId:t.dialogId,fields:{...this.getElementState(),...t}})}}))},update:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}e.commit("update",{dialogId:t.dialogId,fields:this.validate(t.fields)})},delete:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}e.commit("delete",{dialogId:t.dialogId})},startWriting:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const s=`${t.dialogId}|${t.userId}`;const a=i.writingList.some((e=>e.userId===t.userId));if(a){clearTimeout(e.state.writingStatusTimers[s]);e.state.writingStatusTimers[s]=this.setWritingStatusTimeout(t);return true}const n={userId:t.userId,userName:t.userName};const o=[n,...i.writingList];e.commit("update",{actionName:"startWriting",dialogId:t.dialogId,fields:this.validate({writingList:o})});if(!e.state.writingStatusTimers[s]){e.state.writingStatusTimers[s]=this.setWritingStatusTimeout(t)}},stopWriting:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const s=i.writingList.find((e=>e.userId===t.userId));if(!s){return false}const a=i.writingList.filter((e=>e.userId!==t.userId));e.commit("update",{actionName:"stopWriting",dialogId:t.dialogId,fields:this.validate({writingList:a})});const n=`${t.dialogId}|${t.userId}`;clearTimeout(e.state.writingStatusTimers[n]);delete e.state.writingStatusTimers[n]},increaseCounter:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}if(i.counter===100){return true}let s=i.counter+t.count;if(s>100){s=100}e.commit("update",{actionName:"increaseCounter",dialogId:t.dialogId,fields:{counter:s,previousCounter:i.counter}})},decreaseCounter:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}if(i.counter===100){return true}let s=i.counter-t.count;if(s<0){s=0}e.commit("update",{actionName:"decreaseCounter",dialogId:t.dialogId,fields:{counter:s,previousCounter:i.counter}})},clearCounters:e=>{e.commit("clearCounters")},mute:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const a=s.Core.getUserId();if(i.muteList.includes(a)){return false}const n=[...i.muteList,a];e.commit("update",{actionName:"mute",dialogId:t.dialogId,fields:this.validate({muteList:n})})},unmute:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const a=s.Core.getUserId();const n=i.muteList.filter((e=>e!==a));e.commit("update",{actionName:"unmute",dialogId:t.dialogId,fields:this.validate({muteList:n})})},setChatOptions:(e,t)=>{e.commit("setChatOptions",this.validateChatOptions(t))},setLastMessageViews:(e,t)=>{const{dialogId:i,fields:{userId:s,userName:a,date:o,messageId:l}}=t;const r=e.state.collection[i];if(!r){return false}const d={countOfViewers:1,messageId:l,firstViewer:{userId:s,userName:a,date:n.Utils.date.cast(o)}};e.commit("update",{actionName:"setLastMessageViews",dialogId:i,fields:{lastMessageViews:d}})},clearLastMessageViews:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const{lastMessageViews:s}=this.getElementState();e.commit("update",{actionName:"clearLastMessageViews",dialogId:t.dialogId,fields:{lastMessageViews:s}})},incrementLastMessageViews:(e,t)=>{const i=e.state.collection[t.dialogId];if(!i){return false}const s=i.lastMessageViews.countOfViewers+1;e.commit("update",{actionName:"incrementLastMessageViews",dialogId:t.dialogId,fields:{lastMessageViews:{...i.lastMessageViews,countOfViewers:s}}})}}}getMutations(){return{add:(e,t)=>{e.collection[t.dialogId]=t.fields},update:(e,t)=>{e.collection[t.dialogId]={...e.collection[t.dialogId],...t.fields}},delete:(e,t)=>{delete e.collection[t.dialogId]},setChatOptions:(e,t)=>{e.chatOptions=t},clearCounters:e=>{Object.keys(e.collection).forEach((t=>{e.collection[t].counter=0;e.collection[t].markedId=0}))}}}setWritingStatusTimeout(e){return setTimeout((()=>{this.store.dispatch("dialogues/stopWriting",{dialogId:e.dialogId,userId:e.userId})}),l)}validate(e){const i={};if(!t.Type.isUndefined(e.dialog_id)){e.dialogId=e.dialog_id}if(t.Type.isNumber(e.dialogId)||t.Type.isStringFilled(e.dialogId)){i.dialogId=e.dialogId.toString()}if(!t.Type.isUndefined(e.chat_id)){e.chatId=e.chat_id}else if(!t.Type.isUndefined(e.id)){e.chatId=e.id}if(t.Type.isNumber(e.chatId)||t.Type.isStringFilled(e.chatId)){i.chatId=Number.parseInt(e.chatId,10)}if(t.Type.isStringFilled(e.type)){i.type=e.type.toString()}if(t.Type.isNumber(e.quoteId)){i.quoteId=Number.parseInt(e.quoteId,10)}if(t.Type.isNumber(e.counter)||t.Type.isStringFilled(e.counter)){i.counter=Number.parseInt(e.counter,10)}if(!t.Type.isUndefined(e.user_counter)){i.userCounter=e.user_counter}if(t.Type.isNumber(e.userCounter)||t.Type.isStringFilled(e.userCounter)){i.userCounter=Number.parseInt(e.userCounter,10)}if(!t.Type.isUndefined(e.last_id)){e.lastId=e.last_id}if(t.Type.isNumber(e.lastId)){i.lastReadId=e.lastId}if(!t.Type.isUndefined(e.marked_id)){e.markedId=e.marked_id}if(t.Type.isNumber(e.markedId)){i.markedId=e.markedId}if(!t.Type.isUndefined(e.last_message_id)){e.lastMessageId=e.last_message_id}if(t.Type.isNumber(e.lastMessageId)||t.Type.isStringFilled(e.lastMessageId)){i.lastMessageId=Number.parseInt(e.lastMessageId,10)}if(t.Type.isPlainObject(e.last_message_views)){e.lastMessageViews=e.last_message_views}if(t.Type.isPlainObject(e.lastMessageViews)){i.lastMessageViews=this.prepareLastMessageViews(e.lastMessageViews)}if(t.Type.isBoolean(e.hasPrevPage)){i.hasPrevPage=e.hasPrevPage}if(t.Type.isBoolean(e.hasNextPage)){i.hasNextPage=e.hasNextPage}if(t.Type.isNumber(e.savedPositionMessageId)){i.savedPositionMessageId=e.savedPositionMessageId}if(!t.Type.isUndefined(e.textareaMessage)){i.textareaMessage=e.textareaMessage.toString()}if(!t.Type.isUndefined(e.title)){e.name=e.title}if(t.Type.isNumber(e.name)||t.Type.isStringFilled(e.name)){i.name=t.Text.decode(e.name.toString())}if(!t.Type.isUndefined(e.owner)){e.ownerId=e.owner}if(t.Type.isNumber(e.ownerId)||t.Type.isStringFilled(e.ownerId)){i.owner=Number.parseInt(e.ownerId,10)}if(t.Type.isString(e.avatar)){i.avatar=this.prepareAvatar(e.avatar)}if(t.Type.isStringFilled(e.color)){i.color=e.color}if(t.Type.isBoolean(e.extranet)){i.extranet=e.extranet}if(!t.Type.isUndefined(e.entity_type)){e.entityType=e.entity_type}if(t.Type.isStringFilled(e.entityType)){i.entityType=e.entityType}if(!t.Type.isUndefined(e.entity_id)){e.entityId=e.entity_id}if(t.Type.isNumber(e.entityId)||t.Type.isStringFilled(e.entityId)){i.entityId=e.entityId.toString()}if(!t.Type.isUndefined(e.date_create)){e.dateCreate=e.date_create}if(!t.Type.isUndefined(e.dateCreate)){i.dateCreate=n.Utils.date.cast(e.dateCreate)}if(t.Type.isPlainObject(e.public)){i.public={};if(t.Type.isStringFilled(e.public.code)){i.public.code=e.public.code}if(t.Type.isStringFilled(e.public.link)){i.public.link=e.public.link}}if(!t.Type.isUndefined(e.writing_list)){e.writingList=e.writing_list}if(t.Type.isArray(e.writingList)){i.writingList=this.prepareWritingList(e.writingList)}if(!t.Type.isUndefined(e.manager_list)){e.managerList=e.manager_list}if(t.Type.isArray(e.managerList)){i.managerList=[];e.managerList.forEach((e=>{e=Number.parseInt(e,10);if(e>0){i.managerList.push(e)}}))}if(!t.Type.isUndefined(e.mute_list)){e.muteList=e.mute_list}if(t.Type.isArray(e.muteList)||t.Type.isPlainObject(e.muteList)){i.muteList=this.prepareMuteList(e.muteList)}if(t.Type.isBoolean(e.inited)){i.inited=e.inited}if(t.Type.isBoolean(e.loading)){i.loading=e.loading}if(t.Type.isString(e.description)){i.description=e.description}if(t.Type.isNumber(e.disk_folder_id)){i.diskFolderId=e.disk_folder_id}return i}prepareAvatar(e){let t="";if(!e||e.endsWith("/js/im/images/blank.gif")){t=""}else if(e.startsWith("http")){t=e}else{t=this.store.state.application.common.host+e}if(t){t=encodeURI(t)}return t}prepareWritingList(e){const t=[];e.forEach((e=>{const i={};if(!e.userId){return false}i.userId=Number.parseInt(e.userId,10);i.userName=n.Utils.text.htmlspecialcharsback(e.userName);t.push(i)}));return t}prepareMuteList(e){const i=[];if(t.Type.isArray(e)){e.forEach((e=>{e=Number.parseInt(e,10);if(e>0){i.push(e)}}))}else if(t.Type.isPlainObject(e)){Object.entries(e).forEach((([e,t])=>{if(!t){return}const s=Number.parseInt(e,10);if(s>0){i.push(s)}}))}return i}prepareLastMessageViews(e){const{count_of_viewers:t,first_viewers:i,message_id:a}=e;let o;i.forEach((e=>{if(e.user_id===s.Core.getUserId()){return}o={userId:e.user_id,userName:e.user_name,date:n.Utils.date.cast(e.date)}}));if(t>0&&!o){throw new Error("Dialogues model: no first viewer for message")}return{countOfViewers:t,firstViewer:o,messageId:a}}validateChatOptions(e){const t={};Object.entries(e).forEach((([e,i])=>{const s=n.Utils.text.convertSnakeToCamelCase(e.toLowerCase());t[s]={};Object.entries(i).forEach((([e,i])=>{const a=n.Utils.text.convertSnakeToCamelCase(e.toLowerCase());t[s][a]=i}))}));return t}}class d extends i.BuilderModel{getName(){return"users"}getState(){return{collection:{},onlineList:[],mobileOnlineList:[],absentList:[],botList:{}}}getElementState(e={}){const{id:t=0}=e;return{id:t,name:"",firstName:"",lastName:"",avatar:"",color:a.Color.base,workPosition:"",gender:"M",extranet:false,network:false,bot:false,connector:false,externalAuthId:"default",status:"",idle:false,lastActivityDate:false,mobileLastDate:false,isOnline:false,isMobileOnline:false,birthday:false,isBirthday:false,absent:false,isAbsent:false,departments:[],phones:{workPhone:"",personalMobile:"",personalPhone:"",innerPhone:""}}}getGetters(){return{get:e=>(t,i=false)=>{t=Number.parseInt(t,10);if(t<=0){if(i){t=0}else{return null}}const s=e.collection[t];if(!i&&!s){return null}else if(i&&!s){return this.getElementState({id:t})}return s},getBlank:()=>e=>this.getElementState(e),getList:e=>t=>{const i=[];if(!Array.isArray(t)){return null}t.forEach((t=>{if(e.collection[t]){i.push(e.collection[t])}else{i.push(this.getElementState({id:t}))}}));return i},hasBirthday:e=>t=>{t=Number.parseInt(t,10);const i=e.collection[t];if(t<=0||!i){return false}return i.isBirthday},hasVacation:e=>t=>{t=Number.parseInt(t,10);const i=e.collection[t];if(t<=0||!i){return false}return i.isAbsent},getStatus:e=>t=>{t=Number.parseInt(t,10);const i=e.collection[t];if(t<=0||!i){return false}if(!i.isOnline){return""}if(i.isMobileOnline){return a.UserStatus.mobileOnline}else if(i.idle){return a.UserStatus.idle}else{return i.status}},getLastOnline:e=>t=>{t=Number.parseInt(t,10);const i=e.collection[t];if(t<=0||!i){return""}return n.Utils.user.getLastDateText(i)},getPosition:e=>i=>{i=Number.parseInt(i,10);const s=e.collection[i];if(i<=0||!s){return""}if(s.workPosition){return s.workPosition}return t.Loc.getMessage("IM_EMBED_MODEL_USERS_DEFAULT_NAME")},getBotType:e=>t=>{t=Number.parseInt(t,10);const i=e.collection[t];if(t<=0||!i||!i.bot||!e.botList[t]){return""}const s=e.botList[t].type;if(!a.BotType[s]){return a.BotType.bot}return s}}}getActions(){return{set:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.map((e=>this.validate(e))).forEach((t=>{const i=e.state.collection[t.id];if(i){e.commit("update",{id:t.id,fields:t})}else{e.commit("add",{id:t.id,fields:{...this.getElementState(),...t}})}}))},add:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.map((e=>this.validate(e))).forEach((t=>{const i=e.state.collection[t.id];if(!i){e.commit("add",{id:t.id,fields:{...this.getElementState(),...t}})}}))},update:(e,t)=>{t.id=Number.parseInt(t.id,10);const i=e.state.collection[t.id];if(!i){return false}e.commit("update",{id:t.id,fields:this.validate(t.fields)})},delete:(e,t)=>{e.commit("delete",t.id)},setBotList:(e,t)=>{e.commit("setBotList",t)},setStatus:(e,t)=>{const i=this.store.state.application.common.userId;e.commit("update",{id:i,fields:this.validate(t)})}}}getMutations(){return{add:(e,t)=>{e.collection[t.id]=t.fields;const i=e.collection[t.id];if(n.Utils.user.isOnline(i.lastActivityDate)){i.isOnline=true;this.addToOnlineList(i.id)}if(n.Utils.user.isMobileOnline(i.lastActivityDate,i.mobileLastDate)){i.isMobileOnline=true;this.addToMobileOnlineList(i.id)}if(i.birthday&&n.Utils.user.isBirthdayToday(i.birthday)){i.isBirthday=true;setTimeout((()=>{i.isBirthday=false}),n.Utils.date.getTimeToNextMidnight())}if(i.absent){i.isAbsent=true;this.addToAbsentList(i.id)}this.startOnlineCheckInterval();this.startAbsentCheckInterval()},update:(e,i)=>{const s=e.collection[i.id];if(n.Utils.user.isOnline(i.fields.lastActivityDate)){s.isOnline=true;this.addToOnlineList(i.fields.id)}if(n.Utils.user.isMobileOnline(i.fields.lastActivityDate,i.fields.mobileLastDate)){s.isMobileOnline=true;this.addToMobileOnlineList(i.fields.id)}if(i.fields.absent===false){e.absentList=e.absentList.filter((e=>e!==i.id));e.collection[i.id].isAbsent=false}else if(t.Type.isDate(i.fields.absent)){e.collection[i.id].isAbsent=true;this.addToAbsentList(i.id)}e.collection[i.id]={...e.collection[i.id],...i.fields}},delete:(e,t)=>{delete e.collection[t.id]},setBotList:(e,t)=>{e.botList=t}}}validate(e){const i={};if(t.Type.isNumber(e.id)||t.Type.isString(e.id)){i.id=Number.parseInt(e.id,10)}if(t.Type.isStringFilled(e.first_name)){e.firstName=e.first_name}if(t.Type.isStringFilled(e.last_name)){e.lastName=e.last_name}if(t.Type.isStringFilled(e.firstName)){i.firstName=n.Utils.text.htmlspecialcharsback(e.firstName)}if(t.Type.isStringFilled(e.lastName)){i.lastName=n.Utils.text.htmlspecialcharsback(e.lastName)}if(t.Type.isStringFilled(e.name)){e.name=n.Utils.text.htmlspecialcharsback(e.name);i.name=e.name}if(t.Type.isStringFilled(e.color)){i.color=e.color}if(t.Type.isStringFilled(e.avatar)){i.avatar=this.prepareAvatar(e.avatar)}if(t.Type.isStringFilled(e.work_position)){e.workPosition=e.work_position}if(t.Type.isStringFilled(e.workPosition)){i.workPosition=n.Utils.text.htmlspecialcharsback(e.workPosition)}if(t.Type.isStringFilled(e.gender)){i.gender=e.gender==="F"?"F":"M"}if(t.Type.isStringFilled(e.birthday)){i.birthday=e.birthday}if(t.Type.isBoolean(e.extranet)){i.extranet=e.extranet}if(t.Type.isBoolean(e.network)){i.network=e.network}if(t.Type.isBoolean(e.bot)){i.bot=e.bot}if(t.Type.isBoolean(e.connector)){i.connector=e.connector}if(t.Type.isStringFilled(e.external_auth_id)){e.externalAuthId=e.external_auth_id}if(t.Type.isStringFilled(e.externalAuthId)){i.externalAuthId=e.externalAuthId}if(t.Type.isStringFilled(e.status)){i.status=e.status}if(!t.Type.isUndefined(e.idle)){i.idle=n.Utils.date.cast(e.idle,false)}if(!t.Type.isUndefined(e.last_activity_date)){e.lastActivityDate=e.last_activity_date}if(!t.Type.isUndefined(e.lastActivityDate)){i.lastActivityDate=n.Utils.date.cast(e.lastActivityDate,false)}if(!t.Type.isUndefined(e.mobile_last_date)){e.mobileLastDate=e.mobile_last_date}if(!t.Type.isUndefined(e.mobileLastDate)){i.mobileLastDate=n.Utils.date.cast(e.mobileLastDate,false)}if(!t.Type.isUndefined(e.absent)){i.absent=n.Utils.date.cast(e.absent,false)}if(Array.isArray(e.departments)){i.departments=[];e.departments.forEach((e=>{e=Number.parseInt(e,10);if(e>0){i.departments.push(e)}}))}if(t.Type.isPlainObject(e.phones)){i.phones=this.preparePhones(e.phones)}return i}prepareAvatar(e){let t="";if(!e||e.endsWith("/js/im/images/blank.gif")){t=""}else if(e.startsWith("http")){t=e}else{t=this.store.state.application.common.host+e}if(t){t=encodeURI(t)}return t}preparePhones(e){const i={};if(!t.Type.isUndefined(e.work_phone)){e.workPhone=e.work_phone}if(t.Type.isStringFilled(e.workPhone)||t.Type.isNumber(e.workPhone)){i.workPhone=e.workPhone.toString()}if(!t.Type.isUndefined(e.personal_mobile)){e.personalMobile=e.personal_mobile}if(t.Type.isStringFilled(e.personalMobile)||t.Type.isNumber(e.personalMobile)){i.personalMobile=e.personalMobile.toString()}if(!t.Type.isUndefined(e.personal_phone)){e.personalPhone=e.personal_phone}if(t.Type.isStringFilled(e.personalPhone)||t.Type.isNumber(e.personalPhone)){i.personalPhone=e.personalPhone.toString()}if(!t.Type.isUndefined(e.inner_phone)){e.innerPhone=e.inner_phone}if(t.Type.isStringFilled(e.innerPhone)||t.Type.isNumber(e.innerPhone)){i.innerPhone=e.innerPhone.toString()}return i}addToOnlineList(e){const t=this.store.state.users;if(!t.onlineList.includes(e)){t.onlineList.push(e)}}addToMobileOnlineList(e){const t=this.store.state.users;if(!t.mobileOnlineList.includes(e)){t.mobileOnlineList.push(e)}}addToAbsentList(e){const t=this.store.state.users;if(!t.absentList.includes(e)){t.absentList.push(e)}}startAbsentCheckInterval(){if(this.absentCheckInterval){return true}const e=1e3*60*60*24;this.absentCheckInterval=setTimeout((()=>{setInterval((()=>{const e=this.store.state.users;e.absentList.forEach((t=>{const i=e.collection[t];if(!i){return}const s=Date.now();const a=new Date(i.absent).getTime();if(a<=s){e.absentList=e.absentList.filter((e=>e!==t));i.isAbsent=false}}))}),e)}),n.Utils.date.getTimeToNextMidnight())}startOnlineCheckInterval(){if(this.onlineCheckInterval){return true}const e=6e4;this.onlineCheckInterval=setInterval((()=>{const e=this.store.state.users;e.onlineList.forEach((t=>{const i=e.collection[t];if(!i){return}if(n.Utils.user.isOnline(i.lastActivityDate)){i.isOnline=true}else{i.isOnline=false;e.onlineList=e.onlineList.filter((e=>e!==t))}}));e.mobileOnlineList.forEach((t=>{const i=e.collection[t];if(!i){return}if(n.Utils.user.isMobileOnline(i.lastActivityDate,i.mobileLastDate)){i.isMobileOnline=true}else{i.isMobileOnline=false;e.mobileOnlineList=e.mobileOnlineList.filter((e=>e!==t))}}))}),e)}}class c extends i.BuilderModel{getName(){return"recent"}getState(){return{collection:{},recentCollection:new Set,unreadCollection:new Set,unloadedChatCounters:{},activeCalls:[],options:{showBirthday:true,showInvited:true,showLastMessage:true}}}getElementState(){return{dialogId:"0",message:{id:0,senderId:0,date:new Date,status:a.MessageStatus.received,sending:false,text:"",params:{withFile:false,withAttach:false}},draft:{text:"",date:null},unread:false,pinned:false,liked:false,invitation:{isActive:false,originator:0,canResend:false},options:{}}}getActiveCallDefaultState(){return{dialogId:0,name:"",call:{},state:a.RecentCallStatus.waiting}}getGetters(){return{getRecentCollection:e=>[...e.recentCollection].map((t=>e.collection[t])),getUnreadCollection:e=>[...e.unreadCollection].map((t=>e.collection[t])),getSortedCollection:e=>{const t=Object.values(e.collection).filter((e=>{const t=e.options.birthdayPlaceholder;const i=e.options.defaultUserRecord;return!t&&!i&&e.message.id}));return[...t].sort(((e,t)=>t.message.date-e.message.date))},get:e=>i=>{if(t.Type.isNumber(i)){i=i.toString()}if(e.collection[i]){return e.collection[i]}return null},needsBirthdayPlaceholder:e=>t=>{const i=e.collection[t];if(!i){return false}const s=this.store.getters["dialogues/get"](t);if(!s||s.type!==a.DialogType.user){return false}const o=this.store.getters["users/hasBirthday"](t);if(!o){return false}const l=n.Utils.text.isTempMessage(i.message.id)||i.message.id>0;const r=l&&n.Utils.date.isToday(i.message.date);return e.options.showBirthday&&!r&&s.counter===0},needsVacationPlaceholder:e=>t=>{const i=e.collection[t];if(!i){return false}const s=this.store.getters["dialogues/get"](t);if(!s||s.type!==a.DialogType.user){return false}const o=this.store.getters["users/hasVacation"](t);if(!o){return false}const l=n.Utils.text.isTempMessage(i.message.id)||i.message.id>0;const r=l&&n.Utils.date.isToday(i.message.date);return!r&&s.counter===0},getMessageDate:e=>i=>{const s=e.collection[i];if(!s){return null}if(t.Type.isDate(s.draft.date)&&s.draft.date>s.message.date){return s.draft.date}const a=this.store.getters["recent/needsBirthdayPlaceholder"](s.dialogId);if(a){return n.Utils.date.getStartOfTheDay()}return s.message.date},hasActiveCall:e=>e.activeCalls.some((e=>e.state===a.RecentCallStatus.joined)),getOption:e=>t=>{if(!a.RecentSettings[t]){return false}return e.options[t]},getTotalCounter:e=>{let t=0;[...e.recentCollection].forEach((i=>{const a=this.store.getters["dialogues/get"](i,true);const n=e.collection[i];const o=a.muteList.includes(s.Core.getUserId());if(o){return}const l=n.unread;if(a.counter===0&&l){t++;return}t+=a.counter}));let i=0;Object.values(e.unloadedChatCounters).forEach((e=>{i+=e}));return t+i}}}getActions(){return{setRecent:(e,i)=>{this.store.dispatch("recent/set",i).then((t=>{e.commit("setRecentCollection",t)}));if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}const s={};i.forEach((e=>{s[e.chat_id]=0}));this.store.dispatch("recent/setUnloadedChatCounters",s)},setUnread:(e,t)=>{this.store.dispatch("recent/set",t).then((t=>{e.commit("setUnreadCollection",t)}))},set:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}const s=[];const a=[];i.map((e=>this.validate(e))).forEach((t=>{const i=e.state.collection[t.dialogId];if(i){s.push({dialogId:i.dialogId,fields:{...t}})}else{a.push({...this.getElementState(),...t})}}));if(a.length>0){e.commit("add",a)}if(s.length>0){e.commit("update",s)}return[...a,...s].map((e=>e.dialogId))},update:(e,t)=>{const{id:i,fields:s}=t;const a=e.state.collection[i];if(!a){return false}if(s.message){s.message={...a.message,...s.message}}e.commit("update",{dialogId:a.dialogId,fields:this.validate(s)})},unread:(e,t)=>{const i=e.state.collection[t.id];if(!i){return false}e.commit("update",{dialogId:i.dialogId,fields:{unread:t.action}})},pin:(e,t)=>{const i=e.state.collection[t.id];if(!i){return false}e.commit("update",{dialogId:i.dialogId,fields:{pinned:t.action}})},like:(e,i)=>{const s=e.state.collection[i.id];if(!s){return false}const a=s.message.id===Number.parseInt(i.messageId,10);const n=!t.Type.isUndefined(i.messageId)&&i.liked===true;if(n&&!a){return false}e.commit("update",{dialogId:s.dialogId,fields:{liked:i.liked===true}})},draft:(e,t)=>{const i=this.store.getters["dialogues/get"](t.id);if(!i){return false}let s=e.state.collection[t.id];if(!s){if(t.text===""){return false}const i={dialogId:t.id.toString()};e.commit("add",{...this.getElementState(),...i});e.commit("setRecentCollection",[i.dialogId]);s=e.state.collection[t.id]}const a=this.validate({draft:{text:t.text.toString()}});if(a.draft.text===s.draft.text){return false}e.commit("update",{dialogId:s.dialogId,fields:a})},delete:(e,t)=>{const i=e.state.collection[t.id];if(!i){return false}e.commit("delete",{id:i.dialogId});e.commit("deleteFromRecentCollection",i.dialogId)},addActiveCall:(e,t)=>{const i=e.state.activeCalls.findIndex((e=>e.dialogId===t.dialogId||e.call.id===t.call.id));if(i>-1){e.commit("updateActiveCall",{index:i,fields:this.validateActiveCall(t)});return true}e.commit("addActiveCall",this.prepareActiveCall(t))},updateActiveCall:(e,t)=>{const i=e.state.activeCalls.findIndex((e=>e.dialogId===t.dialogId));e.commit("updateActiveCall",{index:i,fields:this.validateActiveCall(t.fields)})},deleteActiveCall:(e,t)=>{const i=e.state.activeCalls.findIndex((e=>e.dialogId===t.dialogId));if(i===-1){return false}e.commit("deleteActiveCall",{index:i})},setOptions:(e,i)=>{if(!t.Type.isPlainObject(i)){return false}i=this.validateOptions(i);Object.entries(i).forEach((([t,i])=>{e.commit("setOptions",{option:t,value:i})}))},clearUnread:e=>{e.commit("clearUnread")},setUnloadedChatCounters:(e,i)=>{if(!t.Type.isPlainObject(i)){return}e.commit("setUnloadedChatCounters",i)}}}getMutations(){return{setRecentCollection:(e,t)=>{t.forEach((t=>{e.recentCollection.add(t)}))},deleteFromRecentCollection:(e,t)=>{e.recentCollection.delete(t)},setUnreadCollection:(e,t)=>{t.forEach((t=>{e.unreadCollection.add(t)}))},add:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.forEach((t=>{e.collection[t.dialogId]=t}))},update:(e,i)=>{if(!Array.isArray(i)&&t.Type.isPlainObject(i)){i=[i]}i.forEach((({dialogId:t,fields:i})=>{const s=i.options&&i.options.defaultUserRecord&&!i.invitation;if(s){return false}const a=e.collection[t];i.message={...a.message,...i.message};i.options={...a.options,...i.options};e.collection[t]={...a,...i}}))},delete:(e,t)=>{delete e.collection[t.id]},addActiveCall:(e,t)=>{e.activeCalls.push(t)},updateActiveCall:(e,t)=>{e.activeCalls[t.index]={...e.activeCalls[t.index],...t.fields}},deleteActiveCall:(e,t)=>{e.activeCalls.splice(t.index,1)},setOptions:(e,t)=>{e.options[t.option]=t.value},clearUnread:e=>{Object.keys(e.collection).forEach((t=>{e.collection[t].unread=false}))},setUnloadedChatCounters:(e,t)=>{Object.entries(t).forEach((([t,i])=>{if(i===0){delete e.unloadedChatCounters[t];return}e.unloadedChatCounters[t]=i}))}}}validate(e){const i={options:{}};if(t.Type.isNumber(e.id)){i.dialogId=e.id.toString()}if(t.Type.isStringFilled(e.id)){i.dialogId=e.id}if(t.Type.isNumber(e.dialogId)){i.dialogId=e.dialogId.toString()}if(t.Type.isStringFilled(e.dialogId)){i.dialogId=e.dialogId}if(t.Type.isPlainObject(e.message)){i.message=this.prepareMessage(e)}if(t.Type.isPlainObject(e.draft)){i.draft=this.prepareDraft(e)}if(t.Type.isBoolean(e.unread)){i.unread=e.unread}if(t.Type.isBoolean(e.pinned)){i.pinned=e.pinned}if(t.Type.isBoolean(e.liked)){i.liked=e.liked}if(t.Type.isPlainObject(e.invited)){i.invitation={isActive:true,originator:e.invited.originator_id,canResend:e.invited.can_resend};i.options.defaultUserRecord=true}else if(e.invited===false){i.invitation={isActive:false,originator:0,canResend:false};i.options.defaultUserRecord=true}if(t.Type.isPlainObject(e.options)){if(!i.options){i.options={}}if(t.Type.isBoolean(e.options.default_user_record)){e.options.defaultUserRecord=e.options.default_user_record}if(t.Type.isBoolean(e.options.defaultUserRecord)){i.options.defaultUserRecord=e.options.defaultUserRecord}if(t.Type.isBoolean(e.options.birthdayPlaceholder)){i.options.birthdayPlaceholder=e.options.birthdayPlaceholder}}return i}prepareMessage(e){var i,s,a,o,l;const{message:r}=this.getElementState();if(t.Type.isNumber(e.message.id)||n.Utils.text.isUuidV4(e.message.id)||t.Type.isStringFilled(e.message.id)){r.id=e.message.id}if(t.Type.isString(e.message.text)){r.text=e.message.text}if(t.Type.isStringFilled(e.message.attach)||t.Type.isBoolean(e.message.attach)||t.Type.isArray(e.message.attach)){r.params.withAttach=e.message.attach}else if(t.Type.isStringFilled((i=e.message.params)==null?void 0:i.withAttach)||t.Type.isBoolean((s=e.message.params)==null?void 0:s.withAttach)||t.Type.isArray((a=e.message.params)==null?void 0:a.withAttach)){r.params.withAttach=e.message.params.withAttach}if(t.Type.isBoolean(e.message.file)||t.Type.isPlainObject(e.message.file)){r.params.withFile=e.message.file}else if(t.Type.isBoolean((o=e.message.params)==null?void 0:o.withFile)||t.Type.isPlainObject((l=e.message.params)==null?void 0:l.withFile)){r.params.withFile=e.message.params.withFile}if(t.Type.isDate(e.message.date)||t.Type.isString(e.message.date)){r.date=n.Utils.date.cast(e.message.date)}if(t.Type.isNumber(e.message.author_id)){r.senderId=e.message.author_id}else if(t.Type.isNumber(e.message.authorId)){r.senderId=e.message.authorId}else if(t.Type.isNumber(e.message.senderId)){r.senderId=e.message.senderId}if(t.Type.isStringFilled(e.message.status)){r.status=e.message.status}if(t.Type.isBoolean(e.message.sending)){r.sending=e.message.sending}return r}prepareDraft(e){const{draft:i}=this.getElementState();if(t.Type.isString(e.draft.text)){i.text=e.draft.text}if(t.Type.isStringFilled(i.text)){i.date=new Date}else{i.date=null}return i}prepareActiveCall(e){return{...this.getActiveCallDefaultState(),...this.validateActiveCall(e)}}validateActiveCall(e){const i={};if(t.Type.isStringFilled(e.dialogId)||t.Type.isNumber(e.dialogId)){i.dialogId=e.dialogId}if(t.Type.isStringFilled(e.name)){i.name=e.name}if(t.Type.isObjectLike(e.call)){var s,n;i.call=e.call;if(((s=e.call)==null?void 0:(n=s.associatedEntity)==null?void 0:n.avatar)==="/bitrix/js/im/images/blank.gif"){i.call.associatedEntity.avatar=""}}if(a.RecentCallStatus[e.state]){i.state=e.state}return i}validateOptions(e){const i={};if(t.Type.isBoolean(e.showBirthday)){i.showBirthday=e.showBirthday}if(t.Type.isBoolean(e.showInvited)){i.showInvited=e.showInvited}if(t.Type.isBoolean(e.showLastMessage)){i.showLastMessage=e.showLastMessage}return i}}e.ApplicationModel=o;e.DialoguesModel=r;e.UsersModel=d;e.RecentModel=c})(this.BX.Messenger.Embedding.Model=this.BX.Messenger.Embedding.Model||{},BX,BX.Vue3.Vuex,BX.Messenger.Embedding.Application,BX.Messenger.Embedding.Const,BX.Messenger.Embedding.Lib);
//# sourceMappingURL=registry.bundle.map.js