{"version":3,"file":"localstorage.bundle.js","sources":["../src/localstorage.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * LocalStorage manager\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nclass LocalStorage\n{\n\tconstructor()\n\t{\n\t\tthis.enabled = null;\n\t\tthis.expireList = null;\n\t\tthis.expireInterval = null;\n\t}\n\n\tisEnabled()\n\t{\n\t\tif (this.enabled !== null)\n\t\t{\n\t\t\treturn this.enabled;\n\t\t}\n\n\t\tthis.enabled = false;\n\n\t\tif (typeof window.localStorage !== 'undefined')\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\twindow.localStorage.setItem('__bx_test_ls_feature__', 'ok');\n\t\t\t\tif (window.localStorage.getItem('__bx_test_ls_feature__') === 'ok')\n\t\t\t\t{\n\t\t\t\t\twindow.localStorage.removeItem('__bx_test_ls_feature__');\n\t\t\t\t\tthis.enabled = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch(e)\n\t\t\t{\n\t\t\t}\n\t\t}\n\n\t\tif (this.enabled && !this.expireInterval)\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\tlet expireList = window.localStorage.getItem('bx-messenger-localstorage-expire');\n\t\t\t\tif (expireList)\n\t\t\t\t{\n\t\t\t\t\tthis.expireList = JSON.parse(expireList);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch(e)\n\t\t\t{\n\t\t\t}\n\n\t\t\tclearInterval(this.expireInterval);\n\t\t\tthis.expireInterval = setInterval(this._checkExpireInterval.bind(this), 60000);\n\t\t}\n\n\t\treturn this.enabled;\n\t}\n\n\tset(siteId, userId, name, value, ttl = 0)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tlet expire = null;\n\t\tif (ttl)\n\t\t{\n\t\t\texpire = new Date(((new Date()).getTime() + ttl * 1000));\n\t\t}\n\n\t\tlet storeValue = JSON.stringify({value, expire});\n\t\tif (window.localStorage.getItem(this._getKey(siteId, userId, name)) !== storeValue)\n\t\t{\n\t\t\twindow.localStorage.setItem(this._getKey(siteId, userId, name), storeValue);\n\t\t}\n\n\n\t\tif (ttl)\n\t\t{\n\t\t\tif (!this.expireList)\n\t\t\t{\n\t\t\t\tthis.expireList = {};\n\t\t\t}\n\t\t\tthis.expireList[this._getKey(siteId, userId, name)] = expire;\n\t\t\twindow.localStorage.setItem('bx-messenger-localstorage-expire', JSON.stringify(this.expireList));\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tget(siteId, userId, name, defaultValue)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\tlet result = window.localStorage.getItem(this._getKey(siteId, userId, name));\n\t\tif (result === null)\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tresult = JSON.parse(result);\n\t\t\tif (result && typeof result.value !== 'undefined')\n\t\t\t{\n\t\t\t\tif (\n\t\t\t\t\t!result.expire\n\t\t\t\t\t|| new Date(result.expire) > new Date()\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tresult = result.value;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\twindow.localStorage.removeItem(this._getKey(siteId, userId, name));\n\n\t\t\t\t\tif (this.expireList)\n\t\t\t\t\t{\n\t\t\t\t\t\tdelete this.expireList[this._getKey(siteId, userId, name)];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t\t}\n\t\t}\n\t\tcatch(e)\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tremove(siteId, userId, name)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.expireList)\n\t\t{\n\t\t\tdelete this.expireList[this._getKey(siteId, userId, name)];\n\t\t}\n\n\t\treturn window.localStorage.removeItem(this._getKey(siteId, userId, name));\n\t}\n\n\t_getKey(siteId, userId, name)\n\t{\n\t\treturn 'bx-messenger-' + siteId + '-' + userId + '-' + name;\n\t}\n\n\t_checkExpireInterval()\n\t{\n\t\tif (!this.expireList)\n\t\t\treturn true;\n\n\t\tlet currentTime = new Date();\n\n\t\tlet count = 0;\n\t\tfor (let name in this.expireList)\n\t\t{\n\t\t\tif (!this.expireList.hasOwnProperty(name))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (new Date(this.expireList[name]) <= currentTime)\n\t\t\t{\n\t\t\t\twindow.localStorage.removeItem(name);\n\t\t\t\tdelete this.expireList[name];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcount++;\n\t\t\t}\n\t\t}\n\n\t\tif (count)\n\t\t{\n\t\t\twindow.localStorage.setItem('bx-messenger-localstorage-expire', JSON.stringify(this.expireList));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.expireList = null;\n\t\t\twindow.localStorage.removeItem('bx-messenger-localstorage-expire');\n\t\t}\n\n\t\treturn true;\n\t}\n}\n\nlet localStorage = new LocalStorage();\n\nexport {localStorage as LocalStorage};"],"names":["LocalStorage","enabled","expireList","expireInterval","window","localStorage","setItem","getItem","removeItem","e","JSON","parse","clearInterval","setInterval","_checkExpireInterval","bind","siteId","userId","name","value","ttl","isEnabled","expire","Date","getTime","storeValue","stringify","_getKey","defaultValue","result","currentTime","count","hasOwnProperty"],"mappings":"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"}