{"version":3,"file":"localstorage.bundle.js","sources":["../src/localstorage.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * LocalStorage manager\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nclass LocalStorage\n{\n\tconstructor()\n\t{\n\t\tthis.enabled = null;\n\t\tthis.expireList = null;\n\t\tthis.expireInterval = null;\n\t}\n\n\tisEnabled()\n\t{\n\t\tif (this.enabled !== null)\n\t\t{\n\t\t\treturn this.enabled;\n\t\t}\n\n\t\tthis.enabled = false;\n\n\t\tif (typeof window.localStorage !== 'undefined')\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\twindow.localStorage.setItem('__bx_test_ls_feature__', 'ok');\n\t\t\t\tif (window.localStorage.getItem('__bx_test_ls_feature__') === 'ok')\n\t\t\t\t{\n\t\t\t\t\twindow.localStorage.removeItem('__bx_test_ls_feature__');\n\t\t\t\t\tthis.enabled = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch(e)\n\t\t\t{\n\t\t\t}\n\t\t}\n\n\t\tif (this.enabled && !this.expireInterval)\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\tlet expireList = window.localStorage.getItem('bx-messenger-localstorage-expire');\n\t\t\t\tif (expireList)\n\t\t\t\t{\n\t\t\t\t\tthis.expireList = JSON.parse(expireList);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch(e)\n\t\t\t{\n\t\t\t}\n\n\t\t\tclearInterval(this.expireInterval);\n\t\t\tthis.expireInterval = setInterval(this._checkExpireInterval.bind(this), 60000);\n\t\t}\n\n\t\treturn this.enabled;\n\t}\n\n\tset(siteId, userId, name, value, ttl = 0)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tlet expire = null;\n\t\tif (ttl)\n\t\t{\n\t\t\texpire = new Date(((new Date()).getTime() + ttl * 1000));\n\t\t}\n\n\t\tlet storeValue = JSON.stringify({value, expire});\n\t\tif (window.localStorage.getItem(this._getKey(siteId, userId, name)) !== storeValue)\n\t\t{\n\t\t\twindow.localStorage.setItem(this._getKey(siteId, userId, name), storeValue);\n\t\t}\n\n\n\t\tif (ttl)\n\t\t{\n\t\t\tif (!this.expireList)\n\t\t\t{\n\t\t\t\tthis.expireList = {};\n\t\t\t}\n\t\t\tthis.expireList[this._getKey(siteId, userId, name)] = expire;\n\t\t\twindow.localStorage.setItem('bx-messenger-localstorage-expire', JSON.stringify(this.expireList));\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tget(siteId, userId, name, defaultValue)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\tlet result = window.localStorage.getItem(this._getKey(siteId, userId, name));\n\t\tif (result === null)\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tresult = JSON.parse(result);\n\t\t\tif (result && typeof result.value !== 'undefined')\n\t\t\t{\n\t\t\t\tif (\n\t\t\t\t\t!result.expire\n\t\t\t\t\t|| new Date(result.expire) > new Date()\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tresult = result.value;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\twindow.localStorage.removeItem(this._getKey(siteId, userId, name));\n\n\t\t\t\t\tif (this.expireList)\n\t\t\t\t\t{\n\t\t\t\t\t\tdelete this.expireList[this._getKey(siteId, userId, name)];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t\t}\n\t\t}\n\t\tcatch(e)\n\t\t{\n\t\t\treturn typeof defaultValue !== 'undefined'? defaultValue: null;\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tremove(siteId, userId, name)\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.expireList)\n\t\t{\n\t\t\tdelete this.expireList[this._getKey(siteId, userId, name)];\n\t\t}\n\n\t\treturn window.localStorage.removeItem(this._getKey(siteId, userId, name));\n\t}\n\n\t_getKey(siteId, userId, name)\n\t{\n\t\treturn 'bx-messenger-' + siteId + '-' + userId + '-' + name;\n\t}\n\n\t_checkExpireInterval()\n\t{\n\t\tif (!this.expireList)\n\t\t\treturn true;\n\n\t\tlet currentTime = new Date();\n\n\t\tlet count = 0;\n\t\tfor (let name in this.expireList)\n\t\t{\n\t\t\tif (!this.expireList.hasOwnProperty(name))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (new Date(this.expireList[name]) <= currentTime)\n\t\t\t{\n\t\t\t\twindow.localStorage.removeItem(name);\n\t\t\t\tdelete this.expireList[name];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcount++;\n\t\t\t}\n\t\t}\n\n\t\tif (count)\n\t\t{\n\t\t\twindow.localStorage.setItem('bx-messenger-localstorage-expire', JSON.stringify(this.expireList));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.expireList = null;\n\t\t\twindow.localStorage.removeItem('bx-messenger-localstorage-expire');\n\t\t}\n\n\t\treturn true;\n\t}\n}\n\nlet localStorage = new LocalStorage();\n\nexport {localStorage as LocalStorage};"],"names":["LocalStorage","enabled","expireList","expireInterval","window","localStorage","setItem","getItem","removeItem","e","JSON","parse","clearInterval","setInterval","_checkExpireInterval","bind","siteId","userId","name","value","ttl","isEnabled","expire","Date","getTime","storeValue","stringify","_getKey","defaultValue","result","currentTime","count","hasOwnProperty"],"mappings":"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"}