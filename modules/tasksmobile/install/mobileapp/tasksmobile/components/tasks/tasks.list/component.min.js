include("InAppNotifier");(()=>{const e=Application.getApiVersion();const t=Application.getPlatform();const s=new Map;const{EntityReady:i}=jn.require("entity-ready");const{TaskCreateManager:o}=jn.require("tasks/layout/task/create");class r{static debounce(e,t,s){let i=0;return function(){clearTimeout(i);i=setTimeout((()=>e.apply(s,arguments)),t)}}}class a{static get type(){return{empty:"empty",privateProject:"privateProject"}}constructor(e){this.list=e}isEnabled(){return e>=40}show(e=a.type.privateProject){if(this.isEnabled()&&Object.values(a.type).includes(e)){let t;let s;let i;if(e===a.type.privateProject){t=BX.message("MOBILE_TASKS_LIST_WELCOME_SCREEN_PRIVATE_PROJECT_TITLE");s=BX.message("MOBILE_TASKS_LIST_WELCOME_SCREEN_PRIVATE_PROJECT_SUBTITLE");i="ws_private_project"}else{t=BX.message("MOBILE_TASKS_LIST_WELCOME_SCREEN_EMPTY_TITLE");s=BX.message("MOBILE_TASKS_LIST_WELCOME_SCREEN_EMPTY_SUBTITLE");i="ws_create_task"}this.list.list.welcomeScreen.show({upperText:t,lowerText:s,iconName:i})}}hide(){if(this.isEnabled()){this.list.list.welcomeScreen.hide()}}}class n{constructor(e){this.list=e}isEnabled(){return e>=40}showForOpened(){if(this.isEnabled()){this.list.list.showJoinButton({type:"openProject"})}}showForPrivate(e=false){if(this.isEnabled()){if(e){this.list.list.showJoinButton({state:"requested"})}else{this.list.list.showJoinButton({type:"privateProject"})}}}onClick(){new RequestExecutor("socialnetwork.api.usertogroup.join",{params:{groupId:this.list.groupId}}).call().then((e=>{if(!this.list.group.isOpened&&e.result.success&&!e.result.confirmationNeeded){this.list.initAccessibleList()}}))}}class l{static getInstance(){if(l.instance==null){l.instance=new l}return l.instance}static get sections(){return{new:"new",pinned:"pinned",default:"default",more:"more",empty:"empty"}}constructor(){this.clear()}clear(){const e={title:"",foldable:false,folded:false,badgeValue:0,sortItemParams:{activityDate:"desc"},backgroundColor:"#ffffff",styles:{title:{font:{size:18}}}};this.items={new:{...{id:l.sections.new},...e},pinned:{...{id:l.sections.pinned},...e},default:{...{id:l.sections.default},...e},more:{...{id:l.sections.more},...e},empty:{...{id:l.sections.empty},...e}}}setSortItemParams(e,t){if(this.has(e)){this.items[e].sortItemParams=t}}has(e){return e in this.items}get list(){return Object.values(this.items)}}class c{constructor(e){this.cacheKey=e;this.storage=Application.sharedStorage("tasksTaskList");this.defaultData={}}static getInstance(e){if(!s.has(e)){s.set(e,new c(e))}return s.get(e)}get(){const e=this.storage.get(this.cacheKey);if(typeof e==="string"){return JSON.parse(e)}return this.defaultData}set(e){this.storage.set(this.cacheKey,JSON.stringify(e))}update(e,t){const s=this.get();s[e]=t;this.set(s)}clear(){this.set({})}setDefaultData(e){this.defaultData=e}}class u extends c{constructor(e){super(e);this.init()}static getInstance(e){if(!s.has(e)){s.set(e,new u(e))}return s.get(e)}init(){const e=[d.roleType.all,d.roleType.responsible,d.roleType.accomplice,d.roleType.originator,d.roleType.auditor];const t=[d.counterType.none,d.counterType.expired,d.counterType.newComments,d.counterType.supposedlyCompleted];const s=Object.prototype.hasOwnProperty;const i=this.get();e.forEach((e=>{if(!s.call(i,e)){i[e]={}}t.forEach((t=>{if(!s.call(i[e],t)){i[e][t]=[]}}))}));this.set(i)}addTask(e){const t=this.get();if(!t||Object.keys(t).length===0){return}const{task:s,taskData:i}=e[Object.keys(e)[0]];const o=parseInt(BX.componentParameters.get("GROUP_ID",0),10);const r={[d.roleType.all]:o>0&&o===Number(s.groupId)||s.isMember(),[d.roleType.responsible]:s.isResponsible(),[d.roleType.accomplice]:s.isAccomplice(),[d.roleType.originator]:s.isPureCreator(),[d.roleType.auditor]:s.isAuditor()};Object.keys(r).forEach((e=>{if(r[e]){const{existing:o}=d.getCountersByRole(e,s);o.forEach((s=>t[e][s].splice(0,0,i)))}}));this.set(t);this.sortTasks()}setTaskData(e){const t=this.get();if(!t||Object.keys(t).length===0){return}Object.keys(e).forEach((s=>{const{task:i,taskData:o}=e[s];const r=parseInt(BX.componentParameters.get("GROUP_ID",0),10);const a={[d.roleType.all]:r>0&&r===Number(i.groupId)||i.isMember(),[d.roleType.responsible]:i.isResponsible(),[d.roleType.accomplice]:i.isAccomplice(),[d.roleType.originator]:i.isPureCreator(),[d.roleType.auditor]:i.isAuditor()};Object.keys(a).forEach((e=>{const{existing:r,notExisting:n}=d.getCountersByRole(e,i);if(a[e]){r.forEach((i=>{const r=t[e][i].findIndex((e=>e.id===s));if(r===-1){t[e][i].splice(0,0,o)}else{t[e][i][r]=o}}));n.forEach((i=>{const o=t[e][i].findIndex((e=>e.id===s));if(o!==-1){t[e][i].splice(o,1)}}))}else{r.concat(n).forEach((i=>{const o=t[e][i].findIndex((e=>e.id===s));if(o!==-1){t[e][i].splice(o,1)}}))}}))}));this.set(t);this.sortTasks()}removeTask(e){const t=this.get();if(!t||Object.keys(t).length===0){return}Object.keys(t).forEach((s=>{if(Object.values(d.roleType).includes(s)){Object.keys(t[s]).forEach((i=>{if(Object.values(d.counterType).includes(i)){const o=t[s][i].findIndex((t=>t.id===e));if(o!==-1){t[s][i].splice(o,1)}}}))}}));this.set(t)}sortTasks(){const e=this.get();if(!e||Object.keys(e).length===0){return}Object.keys(e).forEach((t=>{if(Object.values(d.roleType).includes(t)){Object.keys(e[t]).forEach((s=>{if(Object.values(d.counterType).includes(s)){const i=e[t][s].filter((e=>e.sectionCode===l.sections.pinned));const o=e[t][s].filter((e=>e.sectionCode!==l.sections.pinned));e[t][s]=i.sort(u.compare).concat(o.sort(u.compare))}}))}}));this.set(e)}static compare(e,t){if(e.sortValues.activityDate>t.sortValues.activityDate){return-1}if(e.sortValues.activityDate<t.sortValues.activityDate){return 1}return 0}}class h{static get fields(){return{activityDate:[{field:"ACTIVITY_DATE",direction:"DESC"},{field:"ID",direction:"DESC"}],deadline:[{field:"DEADLINE",direction:"ASC,NULLS"},{field:"ID",direction:"DESC"}]}}static get sectionOrderFields(){return{activityDate:"desc",deadline:"asc"}}constructor(){this.order=BX.componentParameters.get("ORDER","activityDate")}get(){const e={};h.fields[this.order].forEach((t=>{e[t.field]=t.direction}));return e}getForSearch(){const e={};h.fields.activityDate.forEach((t=>{e[t.field]=t.direction}));return e}changeOrder(){this.order=Object.keys(h.fields).filter((e=>e!==this.order))[0]}isDeadline(){return this.checkOrder("deadline")}isActivityDate(){return this.checkOrder("activityDate")}checkOrder(e){return this.order===e}get order(){return this._order||"activityDate"}set order(e){this._order=e}}class d{static getColumn(e,t){const s=[];for(let i=0;i<e.length;i++){s.push(e[i][t])}return s}static get roleType(){return{all:"view_all",responsible:"view_role_responsible",accomplice:"view_role_accomplice",originator:"view_role_originator",auditor:"view_role_auditor"}}static get counterType(){return{none:"none",expired:"expired",newComments:"new_comments",supposedlyCompleted:"supposedly_completed"}}static getPresetsMap(){return{[d.roleType.all]:[d.counterType.expired,d.counterType.newComments],[d.roleType.responsible]:[d.counterType.expired,d.counterType.newComments],[d.roleType.accomplice]:[d.counterType.expired,d.counterType.newComments],[d.roleType.originator]:[d.counterType.expired,d.counterType.newComments],[d.roleType.auditor]:[d.counterType.expired,d.counterType.newComments]}}static getCountersByRole(e,t){const s=parseInt(BX.componentParameters.get("GROUP_ID",0),10);const i={[d.counterType.none]:s>0&&s===Number(t.groupId)||t.isMember(),[d.counterType.expired]:t.getCounterMyExpiredCount()>0,[d.counterType.newComments]:t.getCounterMyNewCommentsCount()>0,[d.counterType.supposedlyCompleted]:t.isSupposedlyCompleted};switch(e){case d.roleType.all:i[d.counterType.supposedlyCompleted]=i[d.counterType.supposedlyCompleted]&&t.isPureCreator();break;case d.roleType.responsible:i[d.counterType.none]=i[d.counterType.none]&&t.isResponsible();i[d.counterType.supposedlyCompleted]=i[d.counterType.supposedlyCompleted]&&t.isResponsible();break;case d.roleType.accomplice:i[d.counterType.none]=i[d.counterType.none]&&t.isAccomplice();i[d.counterType.supposedlyCompleted]=i[d.counterType.supposedlyCompleted]&&t.isAccomplice();break;case d.roleType.originator:i[d.counterType.none]=i[d.counterType.none]&&t.isPureCreator();i[d.counterType.expired]=i[d.counterType.expired]&&t.isPureCreator();i[d.counterType.newComments]=i[d.counterType.newComments]&&t.isPureCreator();i[d.counterType.supposedlyCompleted]=i[d.counterType.supposedlyCompleted]&&t.isPureCreator();break;case d.roleType.auditor:i[d.counterType.none]=i[d.counterType.none]&&t.isAuditor();i[d.counterType.supposedlyCompleted]=i[d.counterType.supposedlyCompleted]&&t.isAuditor();break;default:break}return{existing:Object.keys(i).filter((e=>i[e])),notExisting:Object.keys(i).filter((e=>!i[e]))}}constructor(e,t,s,o){this.list=e;this.currentUser=t;this.owner=s;this.groupId=o||0;this.role=BX.componentParameters.get("ROLE",d.roleType.all);this.counter=BX.componentParameters.get("COUNTER",d.counterType.none);this.showCompleted=BX.componentParameters.get("SHOW_COMPLETED",false);this.counters={};this.cache=c.getInstance(`filterCounters_${this.groupId}`);this.setCounterValue(this.cache.get().counterValue||0);this.setVisualCounters();i.wait("chat").then((()=>this.updateCounters()))}updateCounters(){if(this.isAnotherUserList()){return}console.log("UPDATE COUNTERS");const e={};Object.keys(d.getPresetsMap()).forEach((t=>{e[t]=["tasks.task.counters.get",{type:t,userId:this.owner.id||this.currentUser.id,groupId:this.groupId}]}));BX.rest.callBatch(e,(e=>{if(!e.view_all.answer.result){return}this.counters={};Object.keys(d.getPresetsMap()).forEach((t=>{const s=d.getPresetsMap()[t];const i=e[t].answer.result;this.counters[t]={};this.counters[`${t}_total`]=0;s.forEach((e=>{const s=i[e];const o=s?Number(s.counter):0;this.counters[t][e]=o;this.counters[`${t}_total`]+=o}))}));this.setVisualCounters();this.saveCache()}))}pseudoUpdateCounters(e,t=null){if(this.isAnotherUserList()||t&&t.isMuted){return}this.counters.view_all_total+=e;if(this.counters.view_all_total<0){this.counters.view_all_total=0}this.setVisualCounters()}onUserCounter(e){return new Promise((t=>{if(Number(this.currentUser.id)!==Number(e.userId)||this.isAnotherUserList()){t();return}const s=e[this.groupId];if(!s[this.role]){console.log({error:`${this.role} not found in counters`,counters:s})}this.counters={};Object.keys(d.getPresetsMap()).forEach((e=>{const t=d.getPresetsMap()[e];const i=s[e];this.counters[e]=i;this.counters[`${e}_total`]=0;t.forEach((t=>{const s=i[t];const o=s?Number(s):0;this.counters[`${e}_total`]+=o}))}));this.setVisualCounters();this.saveCache();t()}))}setVisualCounters(e){const t=e||this.getCounterValue();this.setDownMenuTasksCounter(t);this.setListTopButtonCounter(t);this.setTasksTabCounter(t)}setDownMenuTasksCounter(e){if(this.isMyList()){Application.setBadges({tasks:e})}}setListTopButtonCounter(e){if(!this.isAnotherUserList()){Application.setBadges({[`tasksTaskListMoreButton_${this.owner.id}_${this.groupId}`]:e})}}setTasksTabCounter(e){if(this.list.isTabsMode){if(this.isMyList()){BX.postComponentEvent("tasks.list:setVisualCounter",[{value:e}],"tasks.tabs")}else if(this.isGroupList()){BX.postComponentEvent("tasks.list:setVisualCounter",[{value:e,guid:this.list.tabsGuid}])}}}getCounterValue(e=d.roleType.all,t="total"){if(!this.counters[e]&&!this.counters[`${e}_${t}`]){return 0}if(t==="total"){return this.counters[`${e}_${t}`]||0}return this.counters[e][t]||0}setCounterValue(e){this.counters.view_all_total=!this.isAnotherUserList()?e:0}saveCache(){if(!this.isAnotherUserList()){this.cache.set({counterValue:this.getCounterValue()})}}get(){const e={[d.roleType.responsible]:"R",[d.roleType.accomplice]:"A",[d.roleType.originator]:"O",[d.roleType.auditor]:"U"};const t=this.owner.id||this.currentUser.id;const s={MEMBER:t,ZOMBIE:"N",CHECK_PERMISSIONS:"Y",IS_PINNED:"N"};if(e[this.role]){s.ROLE=e[this.role]}if(!this.isMyList()){delete s.IS_PINNED}if(this.groupId>0){s.GROUP_ID=this.groupId;delete s.MEMBER}if(!this.showCompleted){s["::SUBFILTER-STATUS-OR"]={"::LOGIC":"OR","::SUBFILTER-1":{REAL_STATUS:[2,3,4,6]},"::SUBFILTER-2":{WITH_NEW_COMMENTS:"Y",REAL_STATUS:5}}}switch(this.counter){case d.counterType.newComments:if(this.groupId>0){s.MEMBER=t}s.WITH_NEW_COMMENTS="Y";s.IS_MUTED="N";break;case d.counterType.expired:if(this.groupId>0){s.MEMBER=t}s.REAL_STATUS=[2,3];s.IS_MUTED="N";s["<=DEADLINE"]=(new Date).toISOString();break;case d.counterType.supposedlyCompleted:if(this.role===d.roleType.all||this.role===d.roleType.originator){s.CREATED_BY=t;s["!RESPONSIBLE_ID"]=t}else if(this.role===d.roleType.responsible){s.RESPONSIBLE_ID=t}else if(this.role===d.roleType.accomplice){s.ACCOMPLICE=t}else if(this.role===d.roleType.auditor){s.AUDITOR=t}s.REAL_STATUS=4;break;case d.counterType.none:default:break}return s}getForPinned(){const e=this.get();e.IS_PINNED="Y";return e}getForSearch(e){const t={SEARCH_INDEX:e,MEMBER:this.currentUser.id};if(!this.showCompleted){t["::SUBFILTER-STATUS-OR"]={"::LOGIC":"OR","::SUBFILTER-1":{REAL_STATUS:[2,3,4,6]},"::SUBFILTER-2":{WITH_NEW_COMMENTS:"Y"}}}return t}isGroupList(){return this.groupId>0}isAnotherUserList(){return Number(this.currentUser.id)!==Number(this.owner.id)}isMyList(){return!this.isGroupList()&&!this.isAnotherUserList()}getRole(){return this.role}setRole(e){this.role=e}getCounter(){return this.counter}setCounter(e){this.counter=e}}class p{constructor(e){this.list=e;this.filter=e.filter;this.order=e.order}show(){const e=this.prepareItems();const t=this.prepareSections();if(!this.popupMenu){this.popupMenu=dialogs.createPopupMenu()}this.popupMenu.setData(e,t,((e,t)=>{if(e==="onItemSelected"){this.onItemSelected(t)}}));this.popupMenu.show()}prepareSections(){return[{id:l.sections.default}]}prepareItems(){}onItemSelected(){}}class m extends p{prepareItems(){const e=`${component.path}images/mobile-tasks-list-popup-`;return[{id:d.roleType.all,title:BX.message("TASKS_POPUP_MENU_ROLE_ALL"),iconUrl:`${e}role-all.png`,iconName:"finished_tasks",sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.all,counterValue:this.filter.getCounterValue(),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.responsible,title:BX.message("TASKS_POPUP_MENU_ROLE_RESPONSIBLE"),iconUrl:`${e}role-responsible.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.responsible,counterValue:this.filter.getCounterValue(d.roleType.responsible),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.accomplice,title:BX.message("TASKS_POPUP_MENU_ROLE_ACCOMPLICE"),iconUrl:`${e}role-accomplice.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.accomplice,counterValue:this.filter.getCounterValue(d.roleType.accomplice),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.originator,title:BX.message("TASKS_POPUP_MENU_ROLE_ORIGINATOR"),iconUrl:`${e}role-originator.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.originator,counterValue:this.filter.getCounterValue(d.roleType.originator),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.auditor,title:BX.message("TASKS_POPUP_MENU_ROLE_AUDITOR"),iconUrl:`${e}role-auditor.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.auditor,counterValue:this.filter.getCounterValue(d.roleType.auditor),counterStyle:{backgroundColor:"#FF5752"}},{id:"toggleOrder",title:BX.message(this.order.isDeadline()?"TASKS_POPUP_MENU_ORDER_ACTIVITY":"TASKS_POPUP_MENU_ORDER_DEADLINE"),iconName:"term",sectionCode:l.sections.default,showTopSeparator:true},{id:"toggleCompletedTasks",title:BX.message(`TASKS_POPUP_MENU_${!this.filter.showCompleted?"SHOW":"HIDE"}_CLOSED_TASKS`),iconUrl:`${e}${!this.filter.showCompleted?"show":"hide"}-completed.png`,sectionCode:l.sections.default,disable:this.order.isDeadline()},{id:"readAll",title:BX.message("TASKS_POPUP_MENU_READ_ALL"),iconName:"read",sectionCode:l.sections.default}]}onItemSelected(e){const{id:t}=e;switch(t){case d.roleType.all:case d.roleType.responsible:case d.roleType.accomplice:case d.roleType.originator:case d.roleType.auditor:this.onRoleClick(t);break;case"toggleOrder":this.onDeadlineSwitchClick();break;case"readAll":this.onReadAllClick();break;case"toggleCompletedTasks":this.onToggleCompleted();break}}onRoleClick(e){const t=this.filter.getRole();if(t===e){this.filter.setRole(d.roleType.all)}else{this.filter.setRole(e)}this.list.updateTitle();this.list.reload(0,true)}onDeadlineSwitchClick(){this.order.changeOrder();if(this.order.isDeadline()){this.filter.showCompleted=false}this.list.updateTitle();this.list.reload(0,true)}onToggleCompleted(){this.filter.showCompleted=!this.filter.showCompleted;this.list.reload()}onReadAllClick(){this.list.pseudoReadTasks([...this.list.taskList.keys()],true);new RequestExecutor("tasks.task.comment.readAll",{groupId:this.list.groupId||null,userId:this.list.owner.id||this.list.currentUser.id,role:this.filter.getRole()}).call().then((e=>{console.log(e);if(e.result===true){Notify.showIndicatorSuccess({text:BX.message("TASKS_LIST_READ_ALL_NOTIFICATION"),hideAfter:1500})}}))}}class T extends p{prepareItems(){const e=`${component.path}images/mobile-tasks-list-popup-`;const t=[{id:d.roleType.all,title:BX.message("TASKS_POPUP_MENU_ROLE_ALL"),iconUrl:`${e}role-all.png`,iconName:"finished_tasks",sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.all,counterValue:this.filter.getCounterValue(),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.responsible,title:BX.message("TASKS_POPUP_MENU_ROLE_RESPONSIBLE"),iconUrl:`${e}role-responsible.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.responsible,counterValue:this.filter.getCounterValue(d.roleType.responsible),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.accomplice,title:BX.message("TASKS_POPUP_MENU_ROLE_ACCOMPLICE"),iconUrl:`${e}role-accomplice.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.accomplice,counterValue:this.filter.getCounterValue(d.roleType.accomplice),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.originator,title:BX.message("TASKS_POPUP_MENU_ROLE_ORIGINATOR"),iconUrl:`${e}role-originator.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.originator,counterValue:this.filter.getCounterValue(d.roleType.originator),counterStyle:{backgroundColor:"#FF5752"}},{id:d.roleType.auditor,title:BX.message("TASKS_POPUP_MENU_ROLE_AUDITOR"),iconUrl:`${e}role-auditor.png`,sectionCode:l.sections.default,checked:this.filter.getRole()===d.roleType.auditor,counterValue:this.filter.getCounterValue(d.roleType.auditor),counterStyle:{backgroundColor:"#FF5752"}}];const s=[{id:d.counterType.newComments,title:BX.message("TASKS_POPUP_MENU_COUNTER_NEW_COMMENTS"),sectionCode:l.sections.default,checked:this.filter.getCounter()===d.counterType.newComments,counterValue:this.filter.getCounterValue(this.filter.getRole(),d.counterType.newComments),counterStyle:{backgroundColor:"#9DCF00"}},{id:d.counterType.expired,title:BX.message("TASKS_POPUP_MENU_COUNTER_EXPIRED"),sectionCode:l.sections.default,checked:this.filter.getCounter()===d.counterType.expired,counterValue:this.filter.getCounterValue(this.filter.getRole(),d.counterType.expired),counterStyle:{backgroundColor:"#FF5752"}},{id:d.counterType.supposedlyCompleted,title:BX.message("TASKS_POPUP_MENU_COUNTER_SUPPOSEDLY_COMPLETED"),sectionCode:l.sections.default,checked:this.filter.getCounter()===d.counterType.supposedlyCompleted}];const i=[{id:"toggleOrder",title:BX.message(this.order.isDeadline()?"TASKS_POPUP_MENU_ORDER_ACTIVITY":"TASKS_POPUP_MENU_ORDER_DEADLINE"),iconName:"term",sectionCode:l.sections.default,showTopSeparator:true},{id:"toggleCompletedTasks",title:BX.message(`TASKS_POPUP_MENU_${!this.filter.showCompleted?"SHOW":"HIDE"}_CLOSED_TASKS`),iconUrl:`${e}${!this.filter.showCompleted?"show":"hide"}-completed.png`,sectionCode:l.sections.default,disable:this.order.isDeadline()},{id:"readAll",title:BX.message("TASKS_POPUP_MENU_READ_ALL"),iconName:"read",sectionCode:l.sections.default,showTopSeparator:true}];const o=[];t.forEach((e=>{o.push(e);if(e.id===this.filter.getRole()){s.forEach((e=>o.push(e)))}}));i.forEach((e=>o.push(e)));return o}onItemSelected(e){switch(e.id){case d.roleType.all:case d.roleType.responsible:case d.roleType.accomplice:case d.roleType.originator:case d.roleType.auditor:this.onRoleClick(e.id);break;case d.counterType.expired:case d.counterType.newComments:case d.counterType.supposedlyCompleted:this.onCounterClick(e.id);break;case"toggleOrder":this.onDeadlineSwitchClick();break;case"toggleCompletedTasks":this.onToggleCompleted();break;case"readAll":this.onReadAllClick();break}}onRoleClick(e){e=this.filter.getRole()===e?d.roleType.all:e;this.filter.setRole(e);this.filter.setCounter(d.counterType.none);this.list.updateTitle();this.list.setTopButtons();this.list.reload(0,true)}onCounterClick(e){e=this.filter.getCounter()===e?d.counterType.none:e;this.filter.setCounter(e);this.list.updateTitle();this.list.setTopButtons();this.list.reload(0,true)}onDeadlineSwitchClick(){this.order.changeOrder();if(this.order.isDeadline()){this.filter.showCompleted=false}this.list.updateTitle();this.list.reload(0,true)}onToggleCompleted(){this.filter.showCompleted=!this.filter.showCompleted;this.list.reload()}onReadAllClick(){this.list.pseudoReadTasks([...this.list.taskList.keys()],true);let e=this.getReadAllForProject();if(!this.list.isGroupList()||this.filter.getRole()!==d.roleType.all){e=this.getReadAllByRole()}e.call().then((e=>this.onReadAllSuccess(e.result)))}onReadAllSuccess(e){if(e){Notify.showIndicatorSuccess({text:BX.message("TASKS_LIST_READ_ALL_NOTIFICATION"),hideAfter:1500})}}getReadAllForProject(){const e={groupId:this.list.groupId};return new RequestExecutor("tasks.task.comment.readProject",e)}getReadAllByRole(){const e={groupId:this.list.groupId||null,userId:this.list.owner.id||this.list.currentUser.id,role:this.filter.getRole()};return new RequestExecutor("tasks.task.comment.readAll",e)}}class g{constructor(){const e=new Date;e.setDate(e.getDate()-1);this.cache=c.getInstance("options");this.cache.setDefaultData({swipeShowHelper:{value:0,limit:2},deadlines:{lastTime:e.getTime(),value:result.deadlines}})}get(){return this.cache.get()}set(e){this.cache.set(e)}update(e,t){this.cache.update(e,t)}}class f{static get cacheKeys(){return{tasks:"tasks",lastActiveProjects:"lastActiveProjects",lastSearchedProjects:"lastSearchedProjects"}}constructor(e){this.list=e;this.minSize=parseInt(BX.componentParameters.get("MIN_SEARCH_SIZE",3),10);this.maxTaskCount=50;this.maxProjectCount=15;this.text="";this.taskList=new Map;this.projectList=new Map;this.commonProjectList=new Map;this.debounceFunction=this.getDebounceFunction();this.cache=c.getInstance("search");this.fillCacheWithLastActiveProjects()}fillCacheWithLastActiveProjects(){if(e>=41){return}new RequestExecutor("mobile.tasks.group.lastActive.get").call().then((e=>{const t=f.cacheKeys.lastActiveProjects;this.cache.update(t,e.result.slice(0,this.maxProjectCount+1))}))}getDebounceFunction(){return r.debounce((e=>{console.log("Search:fnUserTypeText");const t=[].concat(this.renderProjectItems(),this.renderTaskItems(),this.renderLoadingItems());const s=[{id:"project"},{id:"default",title:BX.message("TASKS_LIST_SEARCH_SECTION_SEARCH_RESULTS")}];this.setSearchResultItems(t,s);const i={projects:["mobile.tasks.group.search",{searchText:e}],tasks:["tasks.task.list",{select:k.selectFields,filter:this.list.filter.getForSearch(e),order:this.list.order.getForSearch(),params:k.queryParams}]};BX.rest.callBatch(i,(e=>this.onSearchSuccess(e)))}),100,this)}onSearchSuccess(e){const t=e.projects.answer.result;const{tasks:s}=e.tasks.answer.result;this.projectList.clear();this.taskList.clear();this.fillProjectList(t);this.fillTaskList(s);this.renderList()}fillProjectList(e){e.forEach((e=>{this.projectList.set(e.id,e);this.commonProjectList.set(e.id,e)}))}fillTaskList(e){e.forEach((e=>{const t=e.id.toString();let s;if(this.list.taskList.has(t)){s=this.list.taskList.get(t)}else{s=new Task(this.list.currentUser);s.setData(e)}this.taskList.set(s.id,s)}))}renderList(e=false){console.log("Search:renderList",{tasks:this.taskList.size,projects:this.projectList.size});let t=this.renderProjectItems();let s=this.renderEmptyResultItems();if(this.taskList.size>0){s=this.renderTaskItems()}else if(e){s=this.renderEmptyCacheItems()}t=t.concat(s);const i=e?"TASKS_LIST_SEARCH_SECTION_LAST":"TASKS_LIST_SEARCH_SECTION_SEARCH_RESULTS";const o=[{id:"project"},{id:"default",title:BX.message(i),backgroundColor:"#ffffff"}];console.log({title:"search",searchResultItems:t,sections:o});this.setSearchResultItems(t,o)}renderProjectItems(){if(e>=41){return[]}const t=[];this.projectList.forEach((e=>{t.push({id:e.id,title:e.name,imageUrl:e.image,type:"project"})}));if(t.length<1){return[]}return[{type:"carousel",sectionCode:"project",childItems:t}]}renderTaskItems(){const e=[];this.taskList.forEach((t=>{const s=this.list.getItemDataFromTask(t,false);s.sectionCode="default";e.push(s)}));return e}renderLoadingItems(){return[{id:0,type:"loading",title:BX.message("TASKS_LIST_BUTTON_NEXT_PROCESS"),sectionCode:"default",unselectable:true}]}renderEmptyCacheItems(){return[{id:0,type:"button",title:BX.message("TASKS_LIST_SEARCH_HINT"),sectionCode:"default",unselectable:true}]}renderEmptyResultItems(){console.log("Empty");return[{id:0,type:"button",title:BX.message("TASKS_LIST_SEARCH_EMPTY_RESULT"),sectionCode:"default",unselectable:true}]}setSearchResultItems(e,t){this.list.list.setSearchResultItems(e,t)}onUserTypeText(e){console.log("Search:onUserTypeText");BX.onViewLoaded((()=>{const t=e.text.trim();if(this.text===t){return}this.text=t;if(this.text.length<this.minSize){this.projectList.clear();this.taskList.clear();if(this.text===""){this.loadProjectsFromCache();this.loadTasksFromCache()}else{this.fillProjectList(this.getLocalSearchedProjects(this.text));this.fillTaskList(this.getLocalSearchedTasks(this.text))}this.renderList(this.text==="");return}this.debounceFunction(this.text)}))}getLocalSearchedProjects(e){const t=[];const s={};this.commonProjectList.forEach((i=>{s[i.id]=false;const o=`${i.name}`.toLowerCase();o.split(" ").forEach((o=>{if(!s[i.id]&&o.search(e.toLowerCase())===0){t.push(i);s[i.id]=true}}))}));return t}getLocalSearchedTasks(e){const t=[];const s={};this.list.taskList.forEach((i=>{s[i.id]=false;const o=`${i.title} ${i.creator.name} ${i.responsible.name}`.toLowerCase();o.split(" ").forEach((o=>{if(!s[i.id]&&o.search(e.toLowerCase())===0){t.push(i);s[i.id]=true}}))}));return t}onSearchShow(){this.loadProjectsFromCache();this.loadTasksFromCache();this.renderList(true)}loadProjectsFromCache(){console.log("Search:loadProjectsFromCache");const e=this.cache.get();const t=e[f.cacheKeys.lastSearchedProjects]||[];let s=e[f.cacheKeys.lastActiveProjects]||[];const i=t.map((e=>Number(e.id)));s=s.filter((e=>!i.includes(Number(e.id))));let o=t;if(o.length<this.maxProjectCount){const e=this.maxProjectCount-o.length+1;o=o.concat(s.slice(0,e))}if(o.length){this.fillProjectList(o);return true}return false}loadTasksFromCache(){console.log("Search:loadTasksFromCache");const e=this.cache.get()[f.cacheKeys.tasks]||[];if(e.length){this.fillTaskList(e);return true}return false}onSearchHide(){this.taskList.clear();this.projectList.clear()}onSearchItemSelected(e){if(e.type==="task"){this.onTaskSelected(e.id.toString())}else if(e.type==="project"){this.onProjectSelected(e)}}onTaskSelected(e){if(!this.taskList.has(e)){return}new RequestExecutor("tasks.task.list",{select:k.selectFields,filter:{ID:e},params:k.queryParams}).call().then((t=>{const s=t.result.tasks||[];const i=s[0];if(i){const t=f.cacheKeys.tasks;let s=this.cache.get()[t]||[];s=s.filter((t=>Number(t.id)!==Number(e)));this.cache.update(t,[i].concat(s.slice(0,this.maxTaskCount)));setTimeout((()=>{const t=new Task(this.list.currentUser);t.setData(i);const s=new Map([[e,t]]);this.taskList.forEach(((e,t)=>s.set(t,e)));this.taskList=s;if(this.text.length<this.minSize){this.renderList(this.text==="")}}),500)}}));this.taskList.get(e).open()}onProjectSelected(t){const s={id:t.id,name:t.title,image:t.imageUrl};const i=f.cacheKeys.lastSearchedProjects;let o=this.cache.get()[i]||[];o=o.filter((e=>Number(e.id)!==Number(s.id)));this.cache.update(i,[s].concat(o.slice(0,this.maxProjectCount)));if(e>=41){let e=null;this.list.taskList.forEach((s=>{if(Number(s.group.id)===Number(t.id)){e=s.group}}));const i={id:s.id,title:s.name,params:{avatar:e?e.image:s.image,initiatedByType:e&&e.additionalData?e.additionalData.initiatedByType:null,features:e&&e.additionalData?e.additionalData.features:[],membersCount:e?e.membersCount:0,role:e&&e.additionalData?e.additionalData.role:null,opened:s.opened||false}};const o={siteId:BX.componentParameters.get("SITE_ID",env.siteId),siteDir:BX.componentParameters.get("SITE_DIR",env.siteDir),projectId:s.id,action:"view",item:i,newsPathTemplate:this.list.projectNewsPathTemplate,calendarWebPathTemplate:this.list.projectCalendarWebPathTemplate,currentUserId:parseInt(this.list.owner.id)};BX.postComponentEvent("projectbackground::project::action",[o],"background")}else{BX.postComponentEvent("taskbackground::task::action",[{groupId:s.id,groupName:s.name,groupImageUrl:s.image,ownerId:this.list.owner.id,getProjectData:true}])}setTimeout((()=>{const e=new Map([[s.id,s]]);this.projectList.forEach(((t,s)=>e.set(s,t)));this.projectList=e;const t=new Map([[s.id,s]]);this.commonProjectList.forEach(((e,s)=>t.set(s,e)));this.commonProjectList=t;if(this.text.length<this.minSize){this.renderList(this.text==="")}}),500)}removeTask(e){if(this.taskList.has(e)){this.taskList.delete(e);this.list.list.removeItem(e)}}}class S{constructor(e){this.list=e;this.queue=new Set;this.canExecute=true}getEventHandlers(){return{task_view:{method:this.list.onPullView,context:this.list},task_add:{method:this.list.onPullAdd,context:this.list},task_update:{method:this.list.onPullUpdate,context:this.list},task_remove:{method:this.list.onPullDelete,context:this.list},comment_add:{method:this.list.onPullComment,context:this.list},comment_read_all:{method:this.list.onPullCommentReadAll,context:this.list},project_read_all:{method:this.list.onPullProjectReadAll,context:this.list},user_option_changed:{method:this.list.onPullUserOptionChanged,context:this.list},user_counter:{method:this.list.filter.onUserCounter,context:this.list.filter},task_result_create:{method:this.list.onPullTaskResultCreate,context:this.list},task_result_delete:{method:this.list.onPullTaskResultDelete,context:this.list},task_timer_start:{method:this.list.onTaskTimerStart,context:this.list},task_timer_stop:{method:this.list.onTaskTimerStop,context:this.list}}}subscribe(){BX.PULL.subscribe({moduleId:"tasks",callback:e=>this.processPullEvent(e)})}clear(){this.queue.clear()}freeQueue(){const e=["comment_read_all","project_read_all","user_counter"];this.queue=new Set([...this.queue].filter((t=>e.includes(t.command))));const t=(e,t)=>{if(typeof e[t.command]==="undefined"||t.extra.server_time_ago<e[t.command].extra.server_time_ago){e[t.command]=t}return e};this.queue=new Set(Object.values([...this.queue].reduce(t,{})));const s=[...this.queue].map((e=>this.executePullEvent(e)));return Promise.allSettled(s)}processTaskEvents(){const e=new Map;this.queue.forEach((t=>{const s=Object.prototype.hasOwnProperty;const i=this.getEventHandlers();const{command:o,params:r}=t;if(s.call(i,o)){const s=r.TASK_ID||r.taskId||0;if(s){e.set(Number(s));this.queue.delete(t)}}}));return e}processPullEvent(e){if(this.canExecute){void this.executePullEvent(e)}else{this.queue.add(e)}}executePullEvent(e){return new Promise(((t,s)=>{const i=Object.prototype.hasOwnProperty;const o=this.getEventHandlers();const{command:r,params:a}=e;if(i.call(o,r)){const{method:e,context:i}=o[r];if(e){e.apply(i,[a]).then((()=>t()),(()=>s())).catch((()=>s()))}}}))}getCanExecute(){return this.canExecute}setCanExecute(e){this.canExecute=e}}class E{constructor(e){this.list=e;this.manager=Application.getNotificationHistory("tasks_task");this.events=new Map;this.processedTasks=new Map}updateList(){const e=this.manager.get();if(!e){return}const t=[new RegExp("TASKS\\|([A-Z_]+)\\|([0-9]+)\\|([0-9]+)\\|([A-Z_]+)"),new RegExp("TASKS\\|([A-Z_]+)\\|([0-9]+)\\|([0-9]+)\\|([0-9]+)\\|(.+)")];Object.entries(e).forEach((([e,s])=>{for(const i in t){const o=e.match(t[i]);if(o){const[,e,t]=o;let i;if(e==="TASK"){i=o[4]}else if(e==="COMMENT"){i=o[5]}this.collectEvents(s,t,i);return}}}));this.processEvents();this.manager.clear()}collectEvents(e,t,s){e.forEach((e=>{const i=e.extra.server_time_unix;if(!this.events.has(t)||this.events.get(t).time<i){this.events.set(t,{time:i,action:s,data:e.data})}}))}processEvents(){this.events.forEach(((e,t)=>{switch(e.action){case"TASK_DELETE":if(this.list.taskList.has(t)){this.removeTask(t)}break;case"TASK_ADD":if(!this.list.taskList.has(t)){this.addTask(this.convertFields(e.data))}break;case"TASK_UPDATE":case"TASK_STATUS_CHANGED_MESSAGE":case"TASK_EXPIRED_SOON":case"TASK_EXPIRED":case"TASK_PINGED_STATUS":{const s=this.convertFields(e.data);this.list.taskList.has(t)?this.updateTask(t,s):this.addTask(s);break}default:break}}))}addTask(e){const t=new Task(this.list.currentUser);t.setData(e);if(this.list.isTaskSuitList(t)){this.list.addItem(t);this.processedTasks.set(Number(t.id))}}updateTask(e,t){const s=this.list.taskList.get(e);s.updateData(t);if(this.list.isTaskSuitList(s)){this.list.updateItem(e,s);this.processedTasks.set(Number(e))}else{this.removeTask(e)}}removeTask(e){this.list.search.removeTask(e);this.list.removeItem(e)}convertFields(e){const t={1:"id",2:"title",3:"deadline",4:"activityDate",5:"status",6:"newCommentsCount",20:"groupId",21:"group",22:"image",23:"name",30:"creator",31:"responsible",32:"icon",41:"accomplices",42:"auditors"};const s=function(e){if(!e||typeof e!=="object"){return e}if(e instanceof Array){return e.map((e=>s(e)))}const i={};for(const o in e){if(!e.hasOwnProperty(o)){continue}const r=t[o]?t[o]:o;i[r]=s(e[o])}return i};return s(e)}clear(){this.events.clear();this.manager.clear();this.processedTasks.clear()}}class k{static getItemDataFromUser(e){return{id:e.id,name:e.title,icon:e.defaultImage?"":e.imageUrl,link:""}}static getItemDataFromGroup(e){return{id:e.id,name:e.title,image:e.defaultImage?"":e.imageUrl}}static get selectFields(){return["ID","TITLE","DESCRIPTION","STATUS","GROUP_ID","CREATED_BY","RESPONSIBLE_ID","ACCOMPLICES","AUDITORS","DEADLINE","ACTIVITY_DATE","FAVORITE","NOT_VIEWED","IS_MUTED","IS_PINNED","MATCH_WORK_TIME","TIME_SPENT_IN_LOGS","TIME_ESTIMATE","PRIORITY","COUNTERS","COMMENTS_COUNT","SERVICE_COMMENTS_COUNT"]}static get queryParams(){return{RETURN_ACCESS:"Y",RETURN_USER_INFO:"Y",RETURN_GROUP_INFO:"Y",SEND_PULL:"Y",MODE:"mobile",WITH_RESULT_INFO:"Y",WITH_TIMER_INFO:"Y",WITH_PARSED_DESCRIPTION:"Y"}}static get statusList(){return Task.statusList}static get titles(){return{[d.roleType.all]:BX.message("TASKS_LIST_HEADER_ROLE_ALL_V2"),[d.roleType.responsible]:BX.message("TASKS_LIST_HEADER_ROLE_RESPONSIBLE"),[d.roleType.accomplice]:BX.message("TASKS_LIST_HEADER_ROLE_ACCOMPLICE"),[d.roleType.originator]:BX.message("TASKS_LIST_HEADER_ROLE_ORIGINATOR"),[d.roleType.auditor]:BX.message("TASKS_LIST_HEADER_ROLE_AUDITOR"),deadlines:BX.message("TASKS_LIST_HEADER_DEADLINES")}}static get projectRoles(){return{owner:"A",moderator:"E",member:"K",request:"Z"}}static get initiatorTypes(){return{group:"G",user:"U"}}constructor(e,t,s){console.log("taskList.constructor");this.initCommon(e,t,s);if(this.group.getData){this.fillProjectData().then((()=>{if(!this.group.id||this.group.isOpened||this.isMember()){this.initAccessibleList(s)}else{this.initInaccessibleList()}}))}else if(!this.group.id||this.group.isOpened||this.isMember()){this.initAccessibleList(s)}else{this.initInaccessibleList()}}fillProjectData(){return new Promise(((e,t)=>{new RequestExecutor("socialnetwork.api.workgroup.get",{params:{select:["AVATAR","AVATAR_TYPES","USER_DATA"],groupId:this.group.id}}).call().then((t=>{const{result:s}=t;this.group={id:parseInt(s.ID,10),name:s.NAME,imageUrl:s.AVATAR||s.AVATAR_TYPES[s.AVATAR_TYPE||"folder"].mobileUrl,isOpened:s.OPENED==="Y",role:s.USER_DATA.ROLE,initiatedByType:s.USER_DATA.INITIATED_BY_TYPE};e()}),(()=>t()))}))}initCommon(e,t,s){this.list=e;this.owner={id:t};this.currentUser=result.settings.userInfo;this.isTabsMode=s.isTabsMode;this.projectNewsPathTemplate=s.projectNewsPathTemplate||"";this.projectCalendarWebPathTemplate=s.projectCalendarWebPathTemplate||"";this.taskList=new Map;this.newTaskList=new Map;this.comments=new Map;const i=BX.componentParameters.get("DATA",{});this.groupId=parseInt(BX.componentParameters.get("GROUP_ID",0),10);this.group={id:this.groupId,name:i.groupName,imageUrl:i.groupImageUrl,isOpened:i.groupOpened,role:i.relationRole,initiatedByType:i.relationInitiatedByType,getData:i.getProjectData};this.search=new f(this);this.welcomeScreen=new a(this);this.joinButton=new n(this);BX.onViewLoaded((()=>{this.setListListeners()}))}initAccessibleList(){this.tabsGuid=BX.componentParameters.get("TABS_GUID","");this.start=0;this.pageSize=50;this.canShowSwipeActions=true;this.isRepeating=false;this.filter=new d(this,this.currentUser,this.owner,this.groupId);this.order=new h;this.options=new g;this.moreMenu=new T(this);this.pull=new S(this);this.push=new E(this);this.fileStorage=new TaskUploadFilesStorage;this.cache=u.getInstance(`tasksList_${this.owner.id}_${this.groupId}`);this.getTaskLimitExceeded();this.checkDeadlinesUpdate();this.getOwnerData();BX.addCustomEvent("onPullEvent-tasks",((e,t)=>{if(e==="user_counter"){this.filter.onUserCounter.apply(this.filter,[t])}}));BX.onViewLoaded((()=>{this.list.setItems([{type:"loading",title:BX.message("TASKS_LIST_BUTTON_NEXT_PROCESS")}]);this.setTopButtons();this.setFloatingButton();this.setJoinButton();this.bindEvents();this.filter.updateCounters();this.loadTasksFromCache();this.reload()}))}initInaccessibleList(){BX.onViewLoaded((()=>{this.welcomeScreen.show();if(this.group.role!==k.projectRoles.request){this.joinButton.showForPrivate()}else if(this.group.initiatedByType===k.initiatorTypes.group){this.joinButton.showForOpened()}else{this.joinButton.showForPrivate(true)}}))}isMember(){const e=[k.projectRoles.owner,k.projectRoles.moderator,k.projectRoles.member];return e.includes(this.group.role)}isMyList(){return!this.isGroupList()&&!this.isAnotherUserList()}isGroupList(){return this.groupId>0}isAnotherUserList(){return Number(this.currentUser.id)!==Number(this.owner.id)}setListListeners(){const e={onRefresh:{callback:()=>{if(!this.isRepeating){this.reload();this.filter.updateCounters()}},context:this},onNewItem:{callback:this.onNewItem,context:this},onUserTypeText:{callback:this.search.onUserTypeText,context:this.search},onSearchItemSelected:{callback:this.search.onSearchItemSelected,context:this.search},onSearchShow:{callback:this.search.onSearchShow,context:this.search},onSearchHide:{callback:this.search.onSearchHide,context:this.search},onProjectSelected:{callback:this.onProjectSelected,context:this},onItemSelected:{callback:this.onItemSelected,context:this},onItemAction:{callback:this.onItemAction,context:this},onItemChecked:{callback:this.onItemChecked,context:this},onClickJoinButton:{callback:this.joinButton.onClick,context:this.joinButton}};this.list.setListener(((t,s)=>{console.log(`Fire event: app.${t}`);if(e[t]){e[t].callback.apply(e[t].context,[s])}}))}bindEvents(){BX.addCustomEvent("task.view.onCommentsRead",(e=>this.onCommentsRead(e)));BX.addCustomEvent("onFileUploadStatusChanged",this.onFileUploadStatusChange.bind(this));if(this.isTabsMode&&this.isMyList()){BX.addCustomEvent("tasks.tabs:onTabSelected",(e=>this.onTabSelected(e)));BX.addCustomEvent("tasks.tabs:onAppActiveBefore",(()=>this.onAppActiveBefore()));BX.addCustomEvent("tasks.tabs:onAppActive",(()=>this.onAppActive()));BX.addCustomEvent("tasks.tabs:onAppPaused",(()=>this.onAppPaused()))}else{BX.addCustomEvent("onAppActiveBefore",(()=>this.onAppActiveBefore()));BX.addCustomEvent("onAppActive",(()=>this.onAppActive()));BX.addCustomEvent("onAppPaused",(()=>this.onAppPaused()))}if(e>=34){BX.addCustomEvent("onTabsSelected",(e=>this.onTabsSelected(e)))}this.pull.subscribe()}setTopButtons(){const e=this.filter.getRole()===d.roleType.all;const t=this.filter.getCounter()===d.counterType.none;this.list.setRightButtons([{type:"search",callback:()=>this.list.showSearchBar()},{type:e&&t?"more":"more_active",badgeCode:`tasksTaskListMoreButton_${this.owner.id}_${this.groupId}`,callback:()=>this.moreMenu.show()}]);this.filter.setVisualCounters()}setFloatingButton(){if(e>=40){this.getCanCreateTask().then((e=>this.renderFloatingButton(e.result)),(e=>console.error(e)))}}getCanCreateTask(){return new Promise(((e,t)=>{if(!this.groupId){e({result:true});return}new RequestExecutor("mobile.tasks.group.getCanCreateTask",{groupId:this.groupId}).call().then((t=>e(t)),(e=>t(e)))}))}renderFloatingButton(t=false){if(t){this.list.setFloatingButton({icon:"plus",callback:()=>{if(e>=45){const e={currentUser:this.currentUser,responsible:this.owner,groupId:this.groupId,groupData:{},diskFolderId:result.diskFolderId,deadlines:this.options.get().deadlines.value};if(this.groupId>0){e.groupData={id:this.group.id,name:this.group.name,image:this.group.imageUrl}}o.open(e)}else{this.list.showAudioInput()}}})}else{this.list.setFloatingButton({})}}setJoinButton(){if(this.group.id>0&&this.group.isOpened&&!this.isMember()){this.joinButton.showForOpened()}}loadTasksFromCache(){console.log("loadTasksFromCache");BX.onViewLoaded((()=>{const e=this.filter.getRole();const t=this.filter.getCounter();const s=Object.prototype.hasOwnProperty;const i=this.cache.get();let o=[];if(s.call(i,e)&&s.call(i[e],t)){o=i[e][t]||[]}if(!Array.isArray(o)||o.length<1){console.log("tasks cache is empty");return}o=o.map((e=>({...e,checkable:false})));this.list.setItems(o,null,false)}))}reload(e=0,t=false){BX.onViewLoaded((()=>{console.log("reload");if(!this.isRepeating){if(t){this.showLoading()}this.updateTitle(true)}let s=k.selectFields;if(!this.isMyList()){s=s.filter((e=>e!=="IS_PINNED"))}const i={all:["tasks.task.list",{select:s,filter:this.filter.get(),order:this.order.get(),start:e,params:{...k.queryParams,...{GET_PLUS_ONE:"Y"}}}]};if(!e&&this.isMyList()){i.pinned=["tasks.task.list",{select:s,filter:this.filter.getForPinned(),order:this.order.get(),params:{...k.queryParams,...{GET_PLUS_ONE:"Y"}}}]}BX.rest.callBatch(i,(s=>{this.onReloadSuccess(s,t,e)}))}))}onReloadSuccess(e,t,s){console.log("onReloadSuccess",e);const{all:i,pinned:o}=e;const r=(i?i.answer.result.tasks:[])||[];const a=r.length>this.pageSize;if(a){r.splice(this.pageSize,1)}const n=(o?o.answer.result.tasks:[])||[];const l=n.concat(r);const c=s===0;this.start=s+this.pageSize;if(c){this.comments.clear();this.taskList.clear();this.newTaskList.clear()}this.updateSections(c);const u=[];l.forEach((e=>{const t=new Task(this.currentUser);t.setData(e);const s=this.getItemDataFromTask(t);u.push(s);this.taskList.set(t.id,t)}));if(c&&this.order.isActivityDate()){this.fillCache(u)}this.renderTaskListItems(u,c,a);if(t){this.hideLoading()}this.updateTitle();this.list.stopRefreshing()}updateSections(e=true){const t=l.getInstance();if(e){t.clear()}t.setSortItemParams(l.sections.default,{[this.order.order]:h.sectionOrderFields[this.order.order]});t.setSortItemParams(l.sections.pinned,{[this.order.order]:h.sectionOrderFields[this.order.order]});this.list.setSections(t.list)}fillCache(e){console.log("fillCache");const t=this.filter.getRole();const s=this.filter.getCounter();const i=this.cache.get();i[t][s]=e;this.cache.set(i)}renderTaskListItems(e,t,s){if(e.length<=0){this.welcomeScreen.show(a.type.empty);return}if(t){this.welcomeScreen.hide();const t=this.handleSwipeActionsShow(e);this.list.setItems(t,null,true);setTimeout((()=>{this.list.updateItem({id:t[0].id},{showSwipeActions:false})}),300)}else{this.list.removeItem({id:"-more-"});this.list.addItems(e)}if(s){this.list.addItems([{id:"-more-",title:BX.message("TASKS_LIST_BUTTON_NEXT"),type:"button",sectionCode:l.sections.more}])}}handleSwipeActionsShow(e){const{swipeShowHelper:t}=this.options.get();if(t.value<t.limit&&this.canShowSwipeActions){this.canShowSwipeActions=false;e[0].showSwipeActions=true;t.value+=1;const s=e=>Object.keys(e)[0];this.options.update(s({swipeShowHelper:t}),t)}return e}showLoading(){if(e>=34){dialogs.showSpinnerIndicator({color:"#777777",backgroundColor:"#77FFFFFF"})}}hideLoading(){if(e>=34){dialogs.hideSpinnerIndicator()}}onTabSelected(e){if(e.tabId==="tasks.list"){this.onAppActiveBefore();this.onAppActive()}else{this.onAppPaused()}}onAppPaused(){this.pauseTime=new Date;this.pull.setCanExecute(false);this.pull.clear();this.push.clear()}onAppActiveBefore(){BX.onViewLoaded((()=>{if(this.push){this.push.updateList()}}))}onAppActive(){this.activationTime=new Date;this.canShowSwipeActions=true;if(this.pauseTime){const e=this.activationTime.getTime()-this.pauseTime.getTime();const t=Math.abs(Math.round(e/6e4));if(t>29){this.runOnAppActiveRepeatedActions()}else{this.updateTasksFromEvents()}}this.getTaskLimitExceeded();this.checkDeadlinesUpdate()}updateTasksFromEvents(){this.updateTitle(true);setTimeout((()=>{const e=new Map([...this.pull.processTaskEvents(),...this.push.processedTasks]);const t=[...e.keys()].map((e=>e.toString()));if(t.length>30){this.runOnAppActiveRepeatedActions()}else{let e=[new Promise((e=>{this.pull.setCanExecute(true);this.pull.freeQueue().then((()=>e()))}))];if(t.length){e.push(this.updateTasks(t))}Promise.allSettled(e).then((()=>this.updateTitle()))}}),1e3)}updateTasks(e){return new Promise(((t,s)=>{const{IS_PINNED:i,...o}={...this.filter.get(),ID:e};new RequestExecutor("tasks.task.list",{select:k.selectFields,filter:o,params:k.queryParams}).call().then((s=>{this.onUpdateTasksSuccess(e,s.result.tasks);t()}),(e=>{console.error(e);s()}))}))}onUpdateTasksSuccess(e,t){e.forEach((e=>{const s=t.find((t=>Number(t.id)===Number(e)));if(s){this.updateTaskListItem(e,s)}else if(this.taskList.has(e)){this.removeItem(e)}}))}updateTaskListItem(e,t,s=l.sections.default){const i=this.newTaskList.has(t.guid)||this.newTaskList.has(t.id);if(this.taskList.has(e)){const s=this.taskList.get(e);s.setData(t);this.isTaskSuitList(s)||i?this.updateItem(e,s):this.removeItem(e)}else if(!i){const i=new Task(this.currentUser);i.setData(t);this.isTaskSuitList(i)?this.addItem(i,s):this.removeItem(e)}}isTaskSuitList(e){return this.isTaskSuitFilter(e)&&this.isTaskSuitGroup(e)}isTaskSuitFilter(e){const t=this.filter.getRole();const s={[d.roleType.all]:this.groupId>0&&this.groupId===Number(e.groupId)||e.isMember(),[d.roleType.responsible]:e.isResponsible(),[d.roleType.accomplice]:e.isAccomplice(),[d.roleType.originator]:e.isPureCreator(),[d.roleType.auditor]:e.isAuditor()};if(s[t]){const s=this.filter.getCounter();const{existing:i}=d.getCountersByRole(t,e);return i.includes(s)}return false}isTaskSuitGroup(e){return this.groupId>0&&this.groupId===Number(e.groupId)||!this.groupId}runOnAppActiveRepeatedActions(){this.filter.updateCounters();this.reload();this.setFloatingButton();this.search.fillCacheWithLastActiveProjects();this.pull.setCanExecute(true)}getTaskLimitExceeded(){new RequestExecutor("tasks.task.limit.isExceeded").call().then((e=>{console.log("taskList:limit.isExceeded",e.result);this.taskLimitExceeded=e.result||false}))}checkDeadlinesUpdate(){const e=new Date;const t=new Date(this.options.get().deadlines.lastTime);const s=e.getDate()!==t.getDate();if(s){new RequestExecutor("mobile.tasks.deadlines.get").call().then((t=>{this.options.update("deadlines",{lastTime:e.getTime(),value:t.result})}))}}getOwnerData(){new RequestExecutor("tasksmobile.User.getUsersData",{userIds:[this.owner.id]}).call().then((e=>this.owner=e.result[this.owner.id]))}onTabsSelected(e){const t=this.filter.getRole()===d.roleType.all;const s=this.filter.getCounter()===d.counterType.none;if(e!=="tasks"&&(!t||!s||this.order.isDeadline())){setTimeout((()=>{this.filter.setRole(d.roleType.all);this.filter.setCounter(d.counterType.none);if(this.order.isDeadline()){this.order.changeOrder()}this.updateTitle();this.setTopButtons();this.reload()}),300)}}onCommentsRead(e){console.log("task.view.onCommentsRead",e);const t=String(e.taskId);if(this.taskList.has(t)){this.taskList.get(t).pseudoRead();this.updateItem(t)}}onPullUserOptionChanged(e){return new Promise(((t,s)=>{if(Number(e.USER_ID)===Number(this.currentUser.id)){this.updateTasks([e.TASK_ID.toString()]).then((()=>t()),(()=>s()))}}))}onPullView(e){return new Promise(((t,s)=>{if(Number(e.USER_ID)===Number(this.currentUser.id)){this.updateTasks([e.TASK_ID.toString()]).then((()=>t()),(()=>s()))}}))}onPullComment(e){return new Promise(((t,s)=>{console.log("onPullComment",e);const[i,o]=e.entityXmlId.split("_");const{messageId:r}=e;if(!this.comments.has(o)){this.comments.set(o,new Set)}const a=this.comments.get(o);if(i!=="TASK"||a.has(r)){t();return}a.add(r);this.comments.set(o,a);this.updateTasks([o]).then((()=>t()),(()=>s()))}))}onPullCommentReadAll(e){return new Promise((t=>{const s=Number(e.USER_ID);const i=Number(e.GROUP_ID);const o=e.ROLE||d.roleType.all;if(s>0&&s!==this.owner.id){t();return}const r=[];this.taskList.forEach(((e,t)=>{const s={[d.roleType.all]:e.isMember(),[d.roleType.responsible]:e.isResponsible(),[d.roleType.accomplice]:e.isAccomplice(),[d.roleType.originator]:e.isPureCreator(),[d.roleType.auditor]:e.isAuditor()};const a=!i||Number(e.groupId)===i;if(s[o]&&a){r.push(t)}}));this.pseudoReadTasks(r);t()}))}onPullProjectReadAll(e){return new Promise((t=>{const s=Number(e.USER_ID);const i=Number(e.GROUP_ID);if(s>0&&s!==this.owner.id){t();return}const o=[];this.taskList.forEach(((e,t)=>{if(i?Number(e.groupId)===i:Number(e.groupId)>0){o.push(t)}}));this.pseudoReadTasks(o);t()}))}onPullAdd(e){return new Promise(((t,s)=>{console.log("onPullAdd");if(e.params.addCommentExists!==false){console.log("onPullAdd -> addCommentExists");t();return}this.updateTasks([e.TASK_ID.toString()]).then((()=>t()),(()=>s()))}))}onPullUpdate(e){return new Promise(((t,s)=>{console.log("onPullUpdate",e);if(e.params.updateCommentExists!==false){console.log("onPullUpdate -> updateCommentExists");t();return}this.updateTasks([e.TASK_ID.toString()]).then((()=>t()),(()=>s()))}))}onPullDelete(e){return new Promise((t=>{console.log("onPullDelete");const s=e.TASK_ID.toString();this.search.removeTask(s);this.removeItem(s);t()}))}onPullTaskResultCreate(e){return this.updateTaskResultData(e)}onPullTaskResultDelete(e){return this.updateTaskResultData(e)}updateTaskResultData(e){return new Promise((t=>{const s=String(e.taskId);if(this.taskList.has(s)){this.taskList.get(s).updateData({taskRequireResult:e.taskRequireResult,taskHasOpenResult:e.taskHasOpenResult,taskHasResult:e.taskHasResult})}t()}))}onTaskTimerStart(e){return new Promise((t=>{const s=String(e.taskId);if(this.taskList.has(s)){this.taskList.get(s).updateData({timerIsRunningForCurrentUser:"Y",timeElapsed:e.timeElapsed})}t()}))}onTaskTimerStop(e){return new Promise((t=>{const s=String(e.taskId);if(this.taskList.has(s)){const t=this.taskList.get(s);if(Number(e.userId)===Number(t.currentUser.id)){t.updateData({timerIsRunningForCurrentUser:"N"})}t.updateData({timeElapsed:e.timeElapsed[t.currentUser.id]})}t()}))}onNewItem(t){console.log("onNewItem",t);const s=e>=40?t.text:t;const i=this.prepareNewItemAttachedFiles(e>=40?t.attachedFiles:null);if(s.trim().length===0){return}const o=new Task(this.currentUser);o.title=s;o.creator=this.currentUser;o.responsible=this.currentUser;o.activityDate=Date.now();o.groupId=this.groupId;if(this.groupId>0){o.group={id:this.group.id,name:this.group.name,image:this.group.imageUrl}}o.diskFiles=i.disk;this.newTaskList.set(o.guid);this.addItem(o,l.sections.new);const r=o.id;o.save().then((()=>{this.newTaskList.set(o.id);this.attachFiles(i,o.id);this.updateItem(r,{id:o.id})}),(()=>{this.newTaskList.delete(o.guid);this.removeItem(r)}))}prepareNewItemAttachedFiles(e){const t={disk:[],local:[]};if(!e){return t}const s=function(){const e=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`};e.forEach((e=>{if(e.dataAttributes){t.disk.push(e.dataAttributes.VALUE)}else{const i=`task-${s()}`;t.local.push({taskId:i,id:i,params:e,name:e.name,type:e.type,url:e.url,previewUrl:e.previewUrl,folderId:result.diskFolderId,onDestroyEventName:TaskUploaderEvents.FILE_SUCCESS_UPLOAD})}}));return t}attachFiles(e,t){const{local:s}=e;if(s.length<=0){return}s.forEach((e=>e.params.taskId=t));this.fileStorage.addFiles(s);BX.postComponentEvent("onFileUploadTaskReceived",[{files:s}],"background")}onFileUploadStatusChange(e,t,s){if(s.indexOf("task-")!==0){return false}switch(e){case BX.FileUploadEvents.FILE_CREATED:case BX.FileUploadEvents.FILE_UPLOAD_START:case BX.FileUploadEvents.FILE_UPLOAD_PROGRESS:case BX.FileUploadEvents.ALL_TASK_COMPLETED:case BX.FileUploadEvents.TASK_TOKEN_DEFINED:case BX.FileUploadEvents.TASK_CREATED:default:break;case BX.FileUploadEvents.TASK_STARTED_FAILED:case BX.FileUploadEvents.FILE_CREATED_FAILED:case BX.FileUploadEvents.FILE_UPLOAD_FAILED:case BX.FileUploadEvents.TASK_CANCELLED:case BX.FileUploadEvents.TASK_NOT_FOUND:case BX.FileUploadEvents.FILE_READ_ERROR:case TaskUploaderEvents.FILE_SUCCESS_UPLOAD:this.fileStorage.removeFiles([s]);this.updateItem(t.file.extra.params.taskId,{});break;case TaskUploaderEvents.FILE_FAIL_UPLOAD:if(t.errors&&Array.isArray(t.errors)&&t.errors.length){InAppNotifier.showNotification({backgroundColor:"#075776",time:5,blur:true,message:`${t.errors[0].message}: ${t.file.name}`})}this.fileStorage.removeFiles([s]);this.updateItem(t.file.extra.params.taskId,{});break}return true}getItemDataFromTask(e,t=true){let s=e.getTaskInfo(t);s.backgroundColor=Task.backgroundColors.default;s.sectionCode=l.sections.default;s.type="task";s.sortValues={deadline:e.deadline||9999999999999,activityDate:e.activityDate};s.locked=this.fileStorage.getArrayFiles().findIndex((t=>t.params.taskId===e.id))>=0;if(e.isPinned){s.backgroundColor=Task.backgroundColors.pinned;s.sectionCode=l.sections.pinned}if(t){s=this.handleItemActions(s)}return s}handleItemActions(e){let{actions:s}=e;if(!this.isMyList()){s=s.filter((e=>!["pin","unpin"].includes(e.identifier)))}if(this.taskLimitExceeded){s=s.filter((e=>e.identifier!=="delegate"))}if(t==="ios"){const t=s.filter((e=>e.position==="left"));if(s.length>4+t.length){const i=t.concat([Task.actions.more]);const o=[];s.filter((e=>!t.includes(e))).forEach((e=>{if(i.length<4+t.length){i.push(e)}else{o.push({id:e.identifier,title:e.title,iconUrl:Task.popupImageUrls[e.identifier],sectionCode:l.sections.default})}}));o.push(Task.actions.cancel);s=i;e.params.popupActions=o}}else{s=s.map((e=>{e.iconUrl=Task.popupImageUrls[e.identifier];return e}));e.menuMode="dialog"}e.actions=s;return e}addItem(t,s=l.sections.default){BX.onViewLoaded((()=>{const i=t.id;if(this.taskList.has(i)){return}this.welcomeScreen.hide();const o=this.getItemDataFromTask(t);o.sectionCode=s;if(s===l.sections.new){if(e>=38){o.locked=true}o.actions=o.actions.filter((e=>e.identifier==="changeResponsible"))}this.taskList.set(i,t);this.list.addItems([o]);this.cache.addTask({[i]:{task:t,taskData:o}})}))}updateItem(e,t={}){BX.onViewLoaded((()=>{const s=e.toString();if(!this.taskList.has(s)){return}const i=this.taskList.get(s);const o=Object.prototype.hasOwnProperty;if(t.id&&t.id!==s){this.taskList.delete(s);this.taskList.set(t.id.toString(),i)}Object.keys(t).forEach((e=>{if(o.call(i,e)||o.call(Object.getPrototypeOf(i),e)){i[e]=t[e]}}));const r=this.getItemDataFromTask(i);r.sectionCode=this.newTaskList.has(i.guid)||this.newTaskList.has(i.id)?l.sections.new:r.sectionCode;console.log(`updateItem #${e}`,r);this.list.updateItem({id:e},r);this.cache.setTaskData({[s]:{task:i,taskData:r}})}))}removeItem(e){BX.onViewLoaded((()=>{this.taskList.delete(e);this.list.removeItem({id:e});this.cache.removeTask(e);if(this.taskList.size===0){this.welcomeScreen.show(a.type.empty)}}))}onProjectSelected(t){if(this.groupId>0){return}let s=null;this.taskList.forEach((e=>{if(Number(e.group.id)===Number(t.id)){s=e.group}}));if(e>=41){const e={id:t.id,title:s?s.name:"",params:{avatar:s?s.image:t.imageUrl,initiatedByType:s&&s.additionalData?s.additionalData.initiatedByType:null,features:s&&s.additionalData?s.additionalData.features:[],membersCount:s.membersCount,role:s&&s.additionalData?s.additionalData.role:null,opened:s.opened||false}};const i={siteId:BX.componentParameters.get("SITE_ID",env.siteId),siteDir:BX.componentParameters.get("SITE_DIR",env.siteDir),projectId:t.id,action:"view",item:e,newsPathTemplate:this.projectNewsPathTemplate,calendarWebPathTemplate:this.projectCalendarWebPathTemplate,currentUserId:parseInt(this.owner.id)};BX.postComponentEvent("projectbackground::project::action",[i],"background")}else{BX.postComponentEvent("taskbackground::task::action",[{groupId:t.id,groupName:s.name,groupImageUrl:t.imageUrl,ownerId:this.owner.id,getProjectData:true}])}}onItemSelected(t){const s=t.id.toString();if(s==="-more-"){this.list.updateItem({id:"-more-"},{type:"loading",title:BX.message("TASKS_LIST_BUTTON_NEXT_PROCESS")});this.reload(this.start)}else if(this.taskList.has(s)){const t=this.taskList.get(s);this.filter.pseudoUpdateCounters(-t.getCounterMyNewCommentsCount(),t);if(e<45){t.pseudoRead();this.updateItem(s)}t.open()}}onItemChecked(e){const t=this.taskList.get(e.id.toString());if(t.isCompletedCounts){this.updateItem(t.id,{status:Task.statusList.pending,activityDate:Date.now()});void t.renew()}else if(t.isSupposedlyCompletedCounts){this.onApproveAction(t)}else{if(!t.isResultRequired||t.isOpenResultExists){this.updateItem(t.id,{status:Task.statusList.completed,activityDate:Date.now()});void t.complete()}else{t.complete().then((()=>{}),(()=>this.updateItem(t.id)))}}}onItemAction(e){const t=this.taskList.get(e.item.id);switch(e.action.identifier){case"ping":this.onPingAction(t);break;case"changeDeadline":this.onChangeDeadlineAction(t);break;case"approve":this.onApproveAction(t);break;case"disapprove":this.onDisapproveAction(t);break;case"start":this.onStartAction(t);break;case"pause":this.onPauseAction(t);break;case"renew":this.onRenewAction(t);break;case"changeResponsible":this.onChangeResponsibleAction(t);break;case"delegate":this.onDelegateAction(t);break;case"changeGroup":this.onChangeGroupAction(t);break;case"mute":this.onMuteAction(t);break;case"unmute":this.onUnmuteAction(t);break;case"unfollow":this.onUnfollowAction(t);break;case"remove":this.onRemoveAction(t);break;case"more":this.onMoreAction(t);return;case"pin":this.onPinAction(t);break;case"unpin":this.onUnpinAction(t);break;case"read":this.onReadAction(t);break;default:break}this.updateItem(t.id,{})}onMoreAction(e){const t=this.getItemDataFromTask(e);if(!this.popupMenu){this.popupMenu=dialogs.createPopupMenu()}this.popupMenu.setData(t.params.popupActions,[{id:l.sections.default}],((t,s)=>{if(t==="onItemSelected"){this.onActionsPopupItemSelected(s,e)}}));this.popupMenu.setPosition("center");this.popupMenu.show()}onActionsPopupItemSelected(e,t){switch(e.id){case"ping":this.onPingAction(t);break;case"changeDeadline":this.onChangeDeadlineAction(t);break;case"approve":this.onApproveAction(t);break;case"disapprove":this.onDisapproveAction(t);break;case"start":this.onStartAction(t);break;case"pause":this.onPauseAction(t);break;case"renew":this.onRenewAction(t);break;case"changeResponsible":this.onChangeResponsibleAction(t);break;case"delegate":this.onDelegateAction(t);break;case"changeGroup":this.onChangeGroupAction(t);break;case"mute":this.onMuteAction(t);break;case"unmute":this.onUnmuteAction(t);break;case"unfollow":this.onUnfollowAction(t);break;case"remove":this.onRemoveAction(t);break;case"pin":this.onPinAction(t);break;case"unpin":this.onUnpinAction(t);break;case"read":this.onReadAction(t);break;case"cancel":return;default:break}this.updateItem(t.id,{})}onPingAction(e){void e.ping();this.updateItem(e.id,{activityDate:Date.now()});Notify.showIndicatorSuccess({text:BX.message("TASKS_LIST_PING_NOTIFICATION"),hideAfter:1500})}onChangeDeadlineAction(t){const s={title:BX.message("TASKS_LIST_POPUP_SELECT_DATE"),type:"datetime",value:t.deadline};if(e>=34){s.items=[];Object.keys(Task.deadlines).forEach((e=>{const{deadlines:t}=this.options.get();s.items.push({name:Task.deadlines[e].name,value:t.value[e]*1e3})}))}dialogs.showDatePicker(s,((e,s)=>{if(s>0&&s!==t.deadline){this.updateItem(t.id,{deadline:s,activityDate:Date.now()});void t.saveDeadline()}}))}onApproveAction(e){if(e.status===k.statusList.waitCtrl){e.updateActions({canApprove:false,canDisapprove:false,canComplete:false,canRenew:true});e.approve().then((()=>this.updateItem(e.id,{status:e.status})));this.updateItem(e.id,{status:e.status,activityDate:Date.now()})}}onDisapproveAction(e){if(e.status===k.statusList.waitCtrl){e.updateActions({canApprove:false,canDisapprove:false,canRenew:false,canComplete:false,canStart:true});e.disapprove().then((()=>this.updateItem(e.id,{status:e.status})));this.updateItem(e.id,{status:e.status})}}onStartAction(e){if(e.status!==k.statusList.inprogress){e.updateActions({canStart:false,canPause:true,canRenew:false});e.start().then((()=>this.updateItem(e.id,{status:e.status})));this.updateItem(e.id,{status:e.status})}}onPauseAction(e){if(e.status!==k.statusList.pending){e.updateActions({canStart:true,canPause:false,canRenew:false});e.pause().then((()=>this.updateItem(e.id,{status:e.status})));this.updateItem(e.id,{status:e.status})}}onRenewAction(e){if(e.isCompletedCounts){e.updateActions({canStart:true,canPause:false,canRenew:false});e.renew().then((()=>this.updateItem(e.id,{status:e.status,activityDate:Date.now()})));this.updateItem(e.id,{status:e.status,activityDate:Date.now()})}}onChangeResponsibleAction(e){new RecipientSelector("TASKS_MEMBER_SELECTOR_EDIT_responsible",["user"]).setSingleChoose(true).setTitle(BX.message("TASKS_LIST_POPUP_RESPONSIBLE")).setSelected({user:[{id:e.responsible.id,title:e.responsible.name,imageUrl:e.responsible.icon}]}).open().then((t=>{if(t.user&&t.user.length>0){const s=t.user[0];if(Number(e.responsible.id)===Number(s.id)){return}e.responsible=k.getItemDataFromUser(s);if(!e.isMember(this.currentUser.id)){if(!this.groupId){this.removeItem(e.id)}this.filter.pseudoUpdateCounters(-e.getCounterMyCount(),e)}else{this.updateItem(e.id,{responsibleIcon:e.responsible.icon,activityDate:Date.now()})}void e.save()}}))}onDelegateAction(e){new RecipientSelector("TASKS_MEMBER_SELECTOR_EDIT_responsible",["user"]).setSingleChoose(true).setTitle(BX.message("TASKS_LIST_POPUP_RESPONSIBLE")).setSelected({user:[{id:e.responsible.id,title:e.responsible.name,imageUrl:e.responsible.image}]}).open().then((t=>{if(t.user&&t.user.length){const s=t.user[0];if(Number(e.responsible.id)===Number(s.id)){return}e.responsible=k.getItemDataFromUser(s);this.updateItem(e.id,{responsibleIcon:e.responsible.icon,activityDate:Date.now()});void e.delegate()}}))}onChangeGroupAction(e){const t=[];if(e.group.id>0){t.push({id:e.group.id,title:e.group.name,imageUrl:e.group.image})}new RecipientSelector("TASKS_PROJECT",["project"]).setSingleChoose(true).setTitle(BX.message("TASKS_LIST_POPUP_PROJECT")).setSelected({project:t}).open().then((t=>{if(t.project&&t.project.length){const s=t.project[0];if(Number(e.groupId)===Number(s.id)){return}e.groupId=Number(s.id);e.group=k.getItemDataFromGroup(s);this.updateItem(e.id,{activityDate:Date.now()});void e.save()}}))}onMuteAction(e){this.updateItem(e.id,{isMuted:true});this.filter.pseudoUpdateCounters(-e.getCounterMyCount());e.mute()}onUnmuteAction(e){this.updateItem(e.id,{isMuted:false});this.filter.pseudoUpdateCounters(e.getCounterMyCount());e.unmute()}onUnfollowAction(e){delete e.auditors[this.currentUser.id.toString()];if(!e.isMember(this.currentUser.id)){if(!this.groupId){this.removeItem(e.id)}this.filter.pseudoUpdateCounters(-e.getCounterMyCount(),e)}e.stopWatch()}onRemoveAction(e){dialogs.showActionSheet({title:BX.message("TASKS_CONFIRM_DELETE"),callback:t=>{if(t.code==="YES"){this.removeItem(e.id);this.filter.pseudoUpdateCounters(-e.getCounterMyCount(),e);new RequestExecutor("tasks.task.delete",{taskId:e.id}).call().then((()=>{}),(e=>console.log(e)))}},items:[{title:BX.message("TASKS_CONFIRM_DELETE_YES"),code:"YES"},{title:BX.message("TASKS_CONFIRM_DELETE_NO"),code:"NO"}]})}onPinAction(e){this.updateItem(e.id,{isPinned:true});e.pin()}onUnpinAction(e){this.updateItem(e.id,{isPinned:false});e.unpin()}onReadAction(e){this.filter.pseudoUpdateCounters(-e.getCounterMyNewCommentsCount(),e);void e.read();this.updateItem(e.id)}updateTitle(e=false){const t={useProgress:e,largeMode:true};if(this.groupId>0){if(this.filter.getRole()===d.roleType.all){t.text=this.order.isDeadline()?k.titles.deadlines:this.group.name}else{t.text=k.titles[this.filter.getRole()].replace("#DEADLINES#","")}t.imageUrl=this.group.imageUrl}else{const e=this.order.isDeadline()?BX.message("TASKS_LIST_SUB_HEADER_DEADLINES"):"";t.text=k.titles[this.filter.getRole()].replace("#DEADLINES#",e)}this.list.setTitle(t);BX.postComponentEvent("tasks.list:updateTitle",[{useProgress:e,guid:this.tabsGuid}])}pseudoReadTasks(e,t=false){const s=[];const i={};let o=0;this.taskList.forEach((t=>{const r=String(t.id);if(e.includes(r)){o+=t.getCounterMyNewCommentsCount();t.pseudoRead();const e=this.getItemDataFromTask(t);s.push({filter:{id:r},element:e});i[r]={task:t,taskData:e}}}));this.list.updateItems(s);this.cache.setTaskData(i);if(t){this.filter.pseudoUpdateCounters(-o)}}}return new k(list,parseInt(BX.componentParameters.get("USER_ID",0),10),{projectNewsPathTemplate:BX.componentParameters.get("PROJECT_NEWS_PATH_TEMPLATE",""),projectCalendarWebPathTemplate:BX.componentParameters.get("PROJECT_CALENDAR_WEB_PATH_TEMPLATE",""),isTabsMode:BX.componentParameters.get("IS_TABS_MODE",false)})})();
//# sourceMappingURL=component.map.js