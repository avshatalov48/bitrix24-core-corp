(()=>{const e=Application.getApiVersion();const t=Application.getPlatform();const s=new Map;const{EntityReady:i}=jn.require("entity-ready");class o{static debounce(e,t,s){let i=0;return function(){clearTimeout(i);i=setTimeout((()=>e.apply(s,arguments)),t)}}}class r{constructor(e){this.list=e.list}isEnabled(){return e>=34}showForList(){if(this.isEnabled()){dialogs.showSpinnerIndicator({color:"#777777",backgroundColor:"#77ffffff"})}}hideForList(){if(this.isEnabled()){dialogs.hideSpinnerIndicator()}}showForTitle(){this.list.setTitle({useProgress:true,largeMode:true,text:BX.message("MOBILE_TASKS_PROJECT_LIST_HEADER_PROJECTS")})}hideForTitle(){this.list.setTitle({useProgress:false,largeMode:true,text:BX.message("MOBILE_TASKS_PROJECT_LIST_HEADER_PROJECTS")})}}class n{constructor(e){this.list=e}isEnabled(){return e>=40}show(){if(this.isEnabled()){this.list.list.welcomeScreen.show({upperText:BX.message("MOBILE_TASKS_PROJECT_LIST_WELCOME_SCREEN_TITLE"),lowerText:BX.message("MOBILE_TASKS_PROJECT_LIST_WELCOME_SCREEN_SUBTITLE"),iconName:"ws_open_project"})}}hide(){if(this.isEnabled()){this.list.list.welcomeScreen.hide()}}}class c{static getInstance(){if(c.instance==null){c.instance=new c}return c.instance}static get sections(){return{new:"new",pinned:"pinned",default:"default",more:"more",empty:"empty"}}constructor(){this.clear()}clear(){const e={title:"",foldable:false,folded:false,badgeValue:0,sortItemParams:{activityDate:"desc"},backgroundColor:"#ffffff",styles:{title:{font:{size:18}}}};this.items={new:{...{id:c.sections.new},...e},pinned:{...{id:c.sections.pinned},...e},default:{...{id:c.sections.default},...e},more:{...{id:c.sections.more},...e},empty:{...{id:c.sections.empty},...e}}}setSortItemParams(e,t){if(this.has(e)){this.items[e].sortItemParams=t}}has(e){return e in this.items}get list(){return Object.values(this.items)}}class a{constructor(e){this.cacheKey=e;this.storage=Application.sharedStorage("tasksProjectList");this.defaultData={}}static getInstance(e){if(!s.has(e)){s.set(e,new a(e))}return s.get(e)}get(){const e=this.storage.get(this.cacheKey);if(typeof e==="string"){return JSON.parse(e)}return this.defaultData}set(e){this.storage.set(this.cacheKey,JSON.stringify(e))}update(e,t){const s=this.get();s[e]=t;this.set(s)}clear(){this.set({})}setDefaultData(e){this.defaultData=e}}class l extends a{constructor(e){super(e);this.init()}getInstance(e){if(!s.has(e)){s.set(e,new l(e))}return s.get(e)}init(){const e=Object.prototype.hasOwnProperty;const t=this.get();Object.values(u.counterTypes).forEach((s=>{if(!e.call(t,s)){t[s]=[]}}));this.set(t)}addProject(e,t){const s=this.get();if(!s||Object.keys(s).length===0){return}const i={[u.counterTypes.none]:true,[u.counterTypes.sonetTotalExpired]:e.getCounterMyExpiredCount()>0,[u.counterTypes.sonetTotalComments]:e.getCounterMyNewCommentsCount()>0,[u.counterTypes.sonetForeignExpired]:e.getCounterProjectExpiredCount()>0,[u.counterTypes.sonetForeignComments]:e.getCounterProjectNewCommentsCount()>0};Object.keys(i).forEach((e=>{if(i[e]){s[e].splice(0,0,t)}}));this.set(s)}updateProject(e){const t=this.get();if(!t||Object.keys(t).length===0){return}Object.keys(e).forEach((s=>{const{project:i,projectItem:o}=e[s];const r=e=>Number(e.id)===Number(s);const n={[u.counterTypes.none]:true,[u.counterTypes.sonetTotalExpired]:i.getCounterMyExpiredCount()>0,[u.counterTypes.sonetTotalComments]:i.getCounterMyNewCommentsCount()>0,[u.counterTypes.sonetForeignExpired]:i.getCounterProjectExpiredCount()>0,[u.counterTypes.sonetForeignComments]:i.getCounterProjectNewCommentsCount()>0};Object.keys(n).forEach((e=>{if(n[e]){const s=t[e].findIndex(r);if(s!==-1){t[e][s]=o}else{t[e].splice(0,0,o)}}else{const s=t[e].findIndex(r);if(s!==-1){t[e].splice(s,1)}}}))}));this.set(t)}removeProject(e){const t=this.get();if(!t||Object.keys(t).length===0){return}Object.keys(t).forEach((s=>{const i=t[s].findIndex((t=>Number(t.id)===Number(e)));if(i!==-1){t[s].splice(i,1)}}));this.set(t)}}class h{static get fields(){return{activityDate:[{field:"ACTIVITY_DATE",direction:"DESC"},{field:"ID",direction:"DESC"}]}}static get sectionOrderFields(){return{activityDate:"desc"}}constructor(){this.order="activityDate"}get(){const e={IS_PINNED:"DESC"};h.fields[this.order].forEach((t=>{e[t.field]=t.direction}));return e}getForSearch(){const e={IS_PINNED:"DESC"};h.fields.activityDate.forEach((t=>{e[t.field]=t.direction}));return e}get order(){return this._order||"activityDate"}set order(e){this._order=e}}class u{static get counterTypes(){return{none:"none",sonetTotalExpired:"sonetTotalExpired",sonetTotalComments:"sonetTotalComments",sonetForeignExpired:"sonetForeignExpired",sonetForeignComments:"sonetForeignComments"}}constructor(e,t){this.list=e;this.userId=t;this.counter=u.counterTypes.none;this.counters={};this.isShowMine=true;this.cache=a.getInstance("filterCounters");this.total=this.cache.get().counterValue||0;i.wait("chat").then((()=>this.updateCounters()))}updateCounters(){console.log("ProjectList.Filter.updateCounters");new RequestExecutor("tasks.project.counter.getTotal",{userId:this.userId}).call().then((e=>{this.counters={};this.total=0;Object.entries(e.result).forEach((([e,t])=>{this.counters[e]=t;if(e===u.counterTypes.sonetTotalExpired||e===u.counterTypes.sonetTotalComments){this.total+=t}}));this.setVisualCounters();this.saveCache()}))}pseudoUpdateCounters(e){this.total+=e;this.total=this.total<0?0:this.total;this.setVisualCounters()}setVisualCounters(e=null){e=e||this.total;Application.setBadges({[`tasksProjectListMoreButton_${this.userId}`]:e});BX.postComponentEvent("tasks.project.list:setVisualCounter",[{value:e}],"tasks.tabs")}saveCache(){this.cache.set({counterValue:this.total})}get(){const e={};switch(this.counter){case u.counterTypes.sonetTotalExpired:e["COUNTERS"]="EXPIRED";break;case u.counterTypes.sonetTotalComments:e["COUNTERS"]="NEW_COMMENTS";break;case u.counterTypes.sonetForeignExpired:e["COUNTERS"]="PROJECT_EXPIRED";break;case u.counterTypes.sonetForeignComments:e["COUNTERS"]="PROJECT_NEW_COMMENTS";break;case u.counterTypes.none:default:break}if(this.isShowMine){e["MEMBER_ID"]=this.userId}return e}getForSearch(e){return{SEARCH_INDEX:e}}getCounterValue(e){return this.counters[e]||0}getCounter(){return this.counter}setCounter(e){this.counter=e}getIsShowMine(){return this.isShowMine}setIsShowMine(e){this.isShowMine=e}}class d{constructor(e){this.list=e;this.filter=e.filter}show(){const e=this.prepareItems();const t=this.prepareSections();if(!this.popupMenu){this.popupMenu=dialogs.createPopupMenu()}this.popupMenu.setData(e,t,((e,t)=>{if(e==="onItemSelected"){this.onItemSelected(t)}}));this.popupMenu.show()}prepareSections(){return[{id:c.sections.default}]}prepareItems(){}onItemSelected(){}}class p extends d{static get counterColors(){return{gray:"#a8adb4",green:"#9dcf00",red:"#ff5752"}}prepareItems(){return[{id:u.counterTypes.sonetTotalComments,title:BX.message("MOBILE_TASKS_PROJECT_LIST_FILTER_COUNTER_MY_NEW_COMMENTS"),sectionCode:"default",checked:this.filter.getCounter()===u.counterTypes.sonetTotalComments,counterValue:this.filter.getCounterValue(u.counterTypes.sonetTotalComments),counterStyle:{backgroundColor:p.counterColors.green}},{id:u.counterTypes.sonetTotalExpired,title:BX.message("MOBILE_TASKS_PROJECT_LIST_FILTER_COUNTER_MY_EXPIRED"),sectionCode:"default",checked:this.filter.getCounter()===u.counterTypes.sonetTotalExpired,counterValue:this.filter.getCounterValue(u.counterTypes.sonetTotalExpired),counterStyle:{backgroundColor:p.counterColors.red}},{id:u.counterTypes.sonetForeignComments,title:BX.message("MOBILE_TASKS_PROJECT_LIST_FILTER_COUNTER_OTHER_NEW_COMMENTS"),sectionCode:"default",checked:this.filter.getCounter()===u.counterTypes.sonetForeignComments,counterValue:this.filter.getCounterValue(u.counterTypes.sonetForeignComments),counterStyle:{backgroundColor:p.counterColors.gray}},{id:u.counterTypes.sonetForeignExpired,title:BX.message("MOBILE_TASKS_PROJECT_LIST_FILTER_COUNTER_OTHER_EXPIRED"),sectionCode:"default",checked:this.filter.getCounter()===u.counterTypes.sonetForeignExpired,counterValue:this.filter.getCounterValue(u.counterTypes.sonetForeignExpired),counterStyle:{backgroundColor:p.counterColors.gray}},{id:"toggleShowMine",title:BX.message(this.filter.getIsShowMine()?"MOBILE_TASKS_PROJECT_LIST_ACTION_SHOW_ALL":"MOBILE_TASKS_PROJECT_LIST_ACTION_SHOW_MINE"),sectionCode:c.sections.default,showTopSeparator:true},{id:"readAll",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_READ_ALL"),iconName:"read",sectionCode:c.sections.default,showTopSeparator:true}]}onItemSelected(e){switch(e.id){case u.counterTypes.sonetTotalExpired:case u.counterTypes.sonetTotalComments:case u.counterTypes.sonetForeignExpired:case u.counterTypes.sonetForeignComments:this.onCounterChange(e.id);break;case"toggleShowMine":this.onToggleShowMineAction();break;case"readAll":this.onReadAllAction();break}}onCounterChange(e){e=this.filter.getCounter()===e?u.counterTypes.none:e;this.filter.setCounter(e);this.list.setTopButtons();this.list.reload(0,true)}onToggleShowMineAction(){this.filter.setIsShowMine(!this.filter.getIsShowMine());this.list.setTopButtons();this.list.reload(0,true)}onReadAllAction(){this.list.pseudoReadProjects([...this.list.projectList.keys()]);new RequestExecutor("tasks.task.comment.readProject").call().then((e=>{if(e.result===true){Notify.showIndicatorSuccess({text:BX.message("MOBILE_TASKS_PROJECT_LIST_NOTIFICATION_READ_ALL"),hideAfter:1500})}}))}}class m{static get swipeActions(){const e=`${component.path}images/mobile-tasks-projectlist-swipe-`;return{about:{identifier:"about",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_ABOUT"),iconName:"action_project",iconUrl:`${e}about.png`,color:"#f2a100",position:"right"},members:{identifier:"members",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_MEMBERS"),iconName:"action_userlist",iconUrl:`${e}members.png`,color:"#2f72b9",position:"right"},join:{identifier:"join",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_JOIN"),iconName:"action_accept",iconUrl:`${e}join.png`,color:"#468ee5",position:"right"},read:{identifier:"read",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_READ"),iconName:"action_read",iconUrl:`${e}read.png`,color:"#e57bb6",position:"left"},pin:{identifier:"pin",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_PIN"),iconName:"action_pin",iconUrl:`${e}pin.png`,color:"#468ee5",position:"left"},unpin:{identifier:"unpin",title:BX.message("MOBILE_TASKS_PROJECT_LIST_ACTION_UNPIN"),iconName:"action_unpin",iconUrl:`${e}unpin.png`,color:"#468ee5",position:"left"}}}constructor(e){this.list=e}fill(e,s){s.menuMode=t!=="ios"?"dialog":"swipe";s.actions=Object.values(m.swipeActions).filter((t=>e.actions[t.identifier]));if(!e.isOpened){const e=s.actions.findIndex((e=>e.identifier==="join"));if(e>=0){delete s.actions[e]}}return s}onItemAction(e){const t=this.list.projectList.get(e.item.id);switch(e.action.identifier){case"pin":this.onPinAction(t);break;case"unpin":this.onUnpinAction(t);break;case"read":this.onReadAction(t);break;case"about":this.onAboutAction(t);break;case"members":this.onMembersAction(t);break;case"join":this.onJoinAction({id:t.id});break;case"leave":this.onLeaveAction(t);break;default:break}this.list.updateItem(t.id)}onPinAction(e){void e.pin()}onUnpinAction(e){void e.unpin()}onReadAction(e){this.list.filter.pseudoUpdateCounters(-e.getNewCommentsCount());void e.read()}onAboutAction(e){ProjectViewManager.open(this.list.userId,e.id)}onMembersAction(e){PageManager.openWidget("list",{backdrop:{bounceEnable:false,swipeAllowed:true,showOnTop:true,hideNavigationBar:false,horizontalSwipeAllowed:false},useSearch:true,useLargeTitleMode:true,title:"Project members",onReady:t=>{new ProjectMemberList(t,this.list.userId,e.id,{isOwner:e.isOwner(),canInvite:e.actions.invite,minSearchSize:3})},onError:e=>console.log(e)})}onJoinAction(e){const t=String(e.id);if(this.list.projectList.has(t)){const e=this.list.projectList.get(t);if(e.isOpened){e.join().then((()=>this.list.updateItem(t)));const s=this.list.prepareListItem(e);s.joinButtonState="animated";this.list.list.updateItem({id:t},s)}}else if(this.list.search.projectList.has(t)){const e=this.list.search.projectList.get(t);if(e.isOpened){void e.join()}}}onLeaveAction(e){void e.leave()}}class g{static get cacheKeys(){return{selected:"selected",active:"active"}}constructor(e,t){this.list=e;this.userId=t;this.minSize=parseInt(BX.componentParameters.get("MIN_SEARCH_SIZE",3),10);this.maxProjectCount=30;this.text="";this.projectList=new Map;this.debounceFunction=this.getDebounceFunction();BX.onViewLoaded((()=>{this.cache=a.getInstance("search");this.fillCacheWithLastActiveProjects()}))}fillCacheWithLastActiveProjects(){const e=this.cache.get()[g.cacheKeys.selected];if(e&&e.length>=this.maxProjectCount){return}new RequestExecutor("tasks.project.list",{select:f.select,order:this.list.order.get(),params:{GET_LAST_ACTIVE:"Y",mode:"mobile"}}).call().then((e=>{const t=g.cacheKeys.active;this.cache.update(t,e.result.projects.slice(0,this.maxProjectCount))}))}getDebounceFunction(){return o.debounce((e=>{const t=[].concat(this.renderProjectItems(),this.renderLoadingItems());const s=[{id:"default",title:BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_RESULTS")}];this.setSearchResultItems(t,s);new RequestExecutor("tasks.project.list",{select:f.select,filter:this.list.filter.getForSearch(e),order:this.list.order.get(),params:{mode:"mobile"}}).call().then((e=>this.onSearchSuccess(e)))}),100,this)}onSearchSuccess(e){this.projectList.clear();this.fillList(e.result.projects);this.renderList()}fillList(e){e.forEach((e=>{const t=e.id.toString();let s;if(this.list.projectList.has(t)){s=this.list.projectList.get(t)}else{s=new Project(this.userId);s.setData(e)}this.projectList.set(String(s.id),s)}))}renderList(e=false){console.log("ProjectList.Search:renderList",{projects:this.projectList.size});let t=this.renderEmptyResultItems();if(this.projectList.size>0){t=this.renderProjectItems()}else if(e){t=this.renderEmptyCacheItems()}const s=[{id:"default",title:e?BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_LAST_RESULTS"):BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_RESULTS"),backgroundColor:"#ffffff"}];this.setSearchResultItems(t,s)}renderProjectItems(){const e=[];this.projectList.forEach((t=>{t.isPinned=false;const s=this.list.prepareListItem(t,false);e.push(s)}));return e}renderLoadingItems(){return[{id:0,type:"loading",title:BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_LOADING"),sectionCode:"default",unselectable:true}]}renderEmptyCacheItems(){return[{id:0,type:"button",title:BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_HINT"),sectionCode:"default",unselectable:true}]}renderEmptyResultItems(){return[{id:0,type:"button",title:BX.message("MOBILE_TASKS_PROJECT_LIST_SEARCH_EMPTY_RESULT"),sectionCode:"default",unselectable:true}]}setSearchResultItems(e,t){this.list.list.setSearchResultItems(e,t)}onUserTypeText(e){BX.onViewLoaded((()=>{const t=e.text.trim();if(this.text===t){return}this.text=t;if(this.text.length<this.minSize){this.projectList.clear();if(this.text===""){this.loadProjectsFromCache()}else{this.fillList(this.getLocalSearches(this.text))}this.renderList(this.text==="");return}this.debounceFunction(this.text)}))}getLocalSearches(e){const t=[];const s={};this.list.projectList.forEach((i=>{s[i.id]=false;const o=`${i.name}`.toLowerCase();o.split(" ").forEach((o=>{if(!s[i.id]&&o.search(e.toLowerCase())===0){t.push(i);s[i.id]=true}}))}));return t}onSearchShow(){this.loadProjectsFromCache();this.renderList(true)}loadProjectsFromCache(){const e=this.cache.get();const t=e[g.cacheKeys.selected]||[];if(t&&t.length>=this.maxProjectCount){this.fillList(t);return true}const s=t.map((e=>Number(e.id)));let i=e[g.cacheKeys.active]||[];i=i.filter((e=>!s.includes(Number(e.id))));const o=this.maxProjectCount-t.length;const r=t.concat(i.slice(0,o));if(r.length){this.fillList(r);return true}return false}onSearchHide(){this.projectList.clear()}onSearchItemSelected(e){const t=String(e.id);if(!this.projectList.has(t)){return}new RequestExecutor("tasks.project.list",{select:f.select,filter:{ID:t},params:{mode:"mobile"}}).call().then((e=>{const s=e.result.projects||[];const i=s[0];if(i){this.saveProjectToCache(t,i);setTimeout((()=>{const e=new Project(this.userId);e.setData(i);const s=new Map([[t,e]]);this.projectList.forEach(((e,t)=>s.set(t,e)));this.projectList=s;if(this.text.length<this.minSize){this.renderList(this.text==="")}}),500)}}));const s=this.list.projectList.has(t)?this.list.projectList.get(t):this.projectList.get(t);const i={id:s.id,title:s.name,params:{avatar:s.image,initiatedByType:s.additionalData.initiatedByType,features:s.additionalData.features||[],membersCount:s.getHeadCount()+s.getMemberCount(),role:s.additionalData.role,opened:s.isOpened}};const o={siteId:BX.componentParameters.get("SITE_ID",env.siteId),siteDir:BX.componentParameters.get("SITE_DIR",env.siteDir),projectId:s.id,action:"view",item:i,newsPathTemplate:this.list.projectNewsPathTemplate||"",calendarWebPathTemplate:this.list.projectCalendarWebPathTemplate||"",currentUserId:parseInt(this.list.userId||0)};BX.postComponentEvent("projectbackground::project::action",[o],"background")}saveProjectToCache(e,t){const s=g.cacheKeys.selected;let i=this.cache.get()[s]||[];i=i.filter((t=>Number(t.id)!==Number(e)));this.cache.update(s,[t].concat(i.slice(0,this.maxProjectCount-1)))}removeProject(e){if(this.projectList.has(e)){this.projectList.delete(e)}}}class T{static get commonEvents(){return["project_read_all","comment_read_all"]}static get counterEvents(){return["onAfterTaskAdd","onAfterTaskDelete","onAfterTaskRestore","onAfterTaskView","onAfterTaskMute","onAfterCommentAdd","onAfterCommentDelete","onProjectPermUpdate"]}static get userOptions(){return{pinned:2}}constructor(e,t){this.list=e;this.userId=t;this.queue=new Set;this.counterEventData=new Map;this.canExecute=true;this.extendWatch();this.startWatch().then((()=>this.subscribe()))}getEventHandlers(){return{project_add:{method:this.onProjectAdd,context:this},project_update:{method:this.onProjectUpdate,context:this},project_remove:{method:this.onProjectRemove,context:this},project_user_add:{method:this.onProjectUserAdd,context:this},project_user_update:{method:this.onProjectUserUpdate,context:this},project_user_remove:{method:this.onProjectUserRemove,context:this},project_user_option_changed:{method:this.onProjectUserOptionChanged,context:this},project_read_all:{method:this.onProjectCommentsReadAll,context:this},comment_read_all:{method:this.onProjectCommentsReadAll,context:this},project_counter:{method:this.onProjectCounter,context:this}}}startWatch(){return new Promise(((e,t)=>{new RequestExecutor("mobile.tasks.project.list.startWatch").call().then((t=>e(t)),(e=>{console.error(e);t(e)}))}))}extendWatch(){BX.PULL.extendWatch("TASKS_PROJECTS",true);setTimeout((()=>this.extendWatch()),29*60*1e3)}subscribe(){BX.PULL.subscribe({moduleId:"tasks",callback:e=>this.processPullEvent(e)})}processPullEvent(e){if(this.getCanExecute()){void this.executePullEvent(e)}else{this.queue.add(e)}}executePullEvent(e){return new Promise(((t,s)=>{const i=Object.prototype.hasOwnProperty;const o=this.getEventHandlers();const{command:r,params:n}=e;if(i.call(o,r)){const{method:e,context:i}=o[r];if(e){e.apply(i,[n]).then((()=>t()),(()=>s())).catch((()=>s()))}}}))}freeQueue(){const e=(e,t)=>{if(typeof e[t.command]==="undefined"||t.extra.server_time_ago<e[t.command].extra.server_time_ago){e[t.command]=t}return e};this.queue=new Set([...this.queue].filter((e=>T.commonEvents.includes(e.command))));this.queue=new Set(Object.values([...this.queue].reduce(e,{})));const t=[...this.queue].map((e=>this.executePullEvent(e)));return Promise.allSettled(t)}clear(){this.queue.clear()}getProjectsToUpdateFromEvents(){const e=[];this.queue.forEach((t=>{const s=Object.prototype.hasOwnProperty;const i=this.getEventHandlers();const{command:o,params:r}=t;if(s.call(i,o)){const s=r.ID||r.GROUP_ID||0;if(s){e.push(String(s));this.queue.delete(t)}}}));return e}getCanExecute(){return this.canExecute}setCanExecute(e){this.canExecute=e}onProjectAdd(e){return this.list.updateProjects([String(e.ID)])}onProjectUpdate(e){return this.list.updateProjects([String(e.ID)])}onProjectRemove(e){return new Promise((t=>{const s=String(e.ID);this.list.removeItem(s);this.list.search.removeProject(s);t()}))}onProjectUserAdd(e){return this.list.updateProjects([String(e.GROUP_ID)])}onProjectUserUpdate(e){return this.list.updateProjects([String(e.GROUP_ID)])}onProjectUserRemove(e){return this.list.updateProjects([String(e.GROUP_ID)])}onProjectUserOptionChanged(e){return new Promise(((t,s)=>{if(Number(e.USER_ID)!==Number(this.userId)){t();return}switch(e.OPTION){case T.userOptions.pinned:this.onProjectPinChanged(String(e.PROJECT_ID),e.ADDED).then((()=>t())).catch((()=>s()));break;default:break}}))}onProjectPinChanged(e,t){return new Promise(((s,i)=>{if(this.list.projectList.has(e)){this.list.updateItem(e,{isPinned:t?"Y":"N"});s()}else if(t){this.list.updateProjects([e]).then((()=>s()),(()=>i())).catch((()=>i()))}}))}onProjectCommentsReadAll(e){return new Promise((t=>{const s=Number(e.USER_ID);if(s>0&&s!==this.userId){t();return}const i=String(e.GROUP_ID);if(Number(i)>0){if(this.list.projectList.has(i)){this.list.pseudoReadProjects([i])}}else{this.list.pseudoReadProjects([...this.list.projectList.keys()])}t()}))}onProjectCounter(e){this.list.filter.updateCounters();const t=String(e.GROUP_ID);const s=e.EVENT;if(!T.counterEvents.includes(s)){return}if(!this.timer){this.timer=setTimeout((()=>{this.freeCounterQueue()}),1e3)}if(!this.counterEventData.has(t)){this.counterEventData.set(t,s)}}freeCounterQueue(){void this.list.updateProjects([...this.counterEventData.keys()]);this.counterEventData.clear();this.timer=null}onAppActive(){this.clear();this.extendWatch();this.startWatch().then((()=>this.setCanExecute(true)))}}class f{static get backgroundColors(){return{default:"#ffffff",pinned:"#f4f5f7"}}static get counterColors(){return{danger:"#ff5752",gray:"#a8adb4",success:"#9dcf00"}}static get select(){return["ID","NAME","IMAGE_ID","AVATAR_TYPE","NUMBER_OF_MODERATORS","NUMBER_OF_MEMBERS","OPENED","CLOSED","VISIBLE","IS_EXTRANET","USER_GROUP_ID","ACTIVITY_DATE","IS_PINNED","MEMBERS","COUNTERS","ACTIONS"]}static get avatarTypes(){return{public:"status_task_public",private:"status_task_private",secret:"status_task_secret",extranet:"status_task_extranet"}}constructor(e,t,s){console.log("ProjectList.constructor",t);this.list=e;this.userId=t;this.newsPathTemplate=s.projectNewsPathTemplate||"";this.calendarWebPathTemplate=s.projectCalendarWebPathTemplate||"";this.start=0;this.pageSize=50;this.projectList=new Map;this.cache=new l(`projectList_${this.userId}`);this.order=new h;this.filter=new u(this,this.userId);this.moreMenu=new p(this);this.welcomeScreen=new n(this);this.loading=new r(this);this.action=new m(this);this.search=new g(this,this.userId);this.pull=new T(this,this.userId);BX.onViewLoaded((()=>{this.list.setItems([{type:"loading",title:BX.message("MOBILE_TASKS_PROJECT_LIST_LOADING")}]);this.setTopButtons();this.setFloatingButton();this.setListListeners();this.bindEvents();this.filter.updateCounters();this.loadProjectsFromCache();this.reload()}))}getCanCreateProject(){return new Promise(((e,t)=>{new RequestExecutor("socialnetwork.api.workgroup.getCanCreate").call().then((t=>e(t.result)),(e=>t(e)))}))}setTopButtons(){this.list.setRightButtons([{type:"search",callback:()=>this.list.showSearchBar()},{type:this.filter.getCounter()===u.counterTypes.none?"more":"more_active",badgeCode:`tasksProjectListMoreButton_${this.userId}`,callback:()=>this.moreMenu.show()}]);this.filter.setVisualCounters()}setFloatingButton(){this.getCanCreateProject().then((e=>this.renderFloatingButton(e)),(e=>console.error(e)))}renderFloatingButton(e=false){if(e){this.list.setFloatingButton({icon:"plus",callback:()=>this.addProject()})}else{this.list.setFloatingButton({})}}setListListeners(){const e={onRefresh:{callback:()=>{this.reload();this.filter.updateCounters()},context:this},onUserTypeText:{callback:this.search.onUserTypeText,context:this.search},onSearchItemSelected:{callback:this.search.onSearchItemSelected,context:this.search},onSearchShow:{callback:this.search.onSearchShow,context:this.search},onSearchHide:{callback:this.search.onSearchHide,context:this.search},onItemSelected:{callback:this.onItemSelected,context:this},onItemAction:{callback:this.action.onItemAction,context:this.action},eventJoin:{callback:this.action.onJoinAction,context:this.action}};this.list.setListener(((t,s)=>{console.log(`ProjectList.appEvent.${t}`);if(e[t]){e[t].callback.apply(e[t].context,[s])}}))}bindEvents(){BX.addCustomEvent("tasks.tabs:onTabSelected",(e=>this.onTabSelected(e)));BX.addCustomEvent("tasks.tabs:onAppActive",(()=>this.onAppActive()));BX.addCustomEvent("tasks.tabs:onAppPaused",(()=>this.onAppPaused()))}loadProjectsFromCache(){const e=this.filter.getCounter();const t=Object.prototype.hasOwnProperty;const s=this.cache.get();let i=[];if(t.call(s,e)){i=s[e]||[]}if(!Array.isArray(i)||i.length<1){console.log("ProjectList.loadProjectsFromCache.empty");return}this.list.setItems(i,null,false)}reload(e=0,t=false){if(t){this.loading.showForList()}this.loading.showForTitle();BX.rest.callMethod("tasks.project.list",{select:f.select,filter:this.filter.get(),order:this.order.get(),start:e,params:{mode:"mobile"}},(s=>this.onReloadSuccess(s,t,e)))}onReloadSuccess(e,t,s){console.log("ProjectList.onReloadSuccess",e);this.start=s+this.pageSize;const i=s===0;if(i){this.projectList.clear()}this.updateSections(i);const{projects:o}=e.answer.result;const r=[];o.forEach((e=>{const t=new Project(this.userId);t.setData(e);this.projectList.set(String(t.id),t);r.push(this.prepareListItem(t))}));console.log("ProjectList.onReloadSuccess:items",r);if(i){this.fillCache(r)}const n=this.projectList.size<e.answer.total;this.renderProjectListItems(r,i,n);console.log("ProjectList.onReloadSuccess:render");if(t){this.loading.hideForList()}this.loading.hideForTitle();this.list.stopRefreshing()}updateSections(e=true){const t=c.getInstance();if(e){t.clear()}t.setSortItemParams(c.sections.pinned,{[this.order.order]:h.sectionOrderFields[this.order.order]});t.setSortItemParams(c.sections.default,{[this.order.order]:h.sectionOrderFields[this.order.order]});this.list.setSections(t.list)}prepareListItem(t,s=true){let i={id:String(t.id),title:t.name||"",imageUrl:t.image||"",date:t.activityDate/1e3,messageCount:t.counter.value,joinButtonState:t.actions.join&&t.isOpened?"showed":"hidden",creatorIcons:t.getHeadIcons(),creatorCount:t.getHeadCount(),responsibleIcons:t.getMemberIcons(),responsibleCount:t.getMemberCount(),styles:{counter:{backgroundColor:f.counterColors[t.counter.color]},date:{image:{name:t.isPinned?"message_pin":""},font:{size:13}}},backgroundColor:f.backgroundColors.default,sectionCode:c.sections.default,sortValues:{activityDate:t.activityDate},type:"project"};if(t.counter.isHidden){i.messageCount=0}if(t.isPinned){i.backgroundColor=f.backgroundColors.pinned;i.sectionCode=c.sections.pinned}if(e>=40){i.styles.avatar={image:{name:f.avatarTypes[t.getType()]}}}if(s){i=this.action.fill(t,i)}return i}fillCache(e){const t=this.filter.getCounter();const s=this.cache.get();s[t]=e;this.cache.set(s)}renderProjectListItems(e,t,s){if(e.length<=0){this.welcomeScreen.show();return}if(t){this.welcomeScreen.hide();this.list.setItems(e)}else{this.list.removeItem({id:"-more-"});this.list.addItems(e)}if(s){this.list.addItems([{id:"-more-",title:BX.message("MOBILE_TASKS_PROJECT_LIST_NEXT_PAGE"),type:"button",sectionCode:c.sections.more}])}}onItemSelected(e){const t=e.id.toString();if(t==="-more-"){this.list.updateItem({id:"-more-"},{type:"loading",title:BX.message("MOBILE_TASKS_PROJECT_LIST_LOADING")});this.reload(this.start)}else if(this.projectList.has(t)){const e=this.projectList.get(t);const s={id:e.id,title:e.name,params:{avatar:e.image,initiatedByType:e.additionalData.initiatedByType,features:e.additionalData.features||[],membersCount:e.getHeadCount()+e.getMemberCount(),role:e.additionalData.role,opened:e.isOpened}};const i={siteId:BX.componentParameters.get("SITE_ID",env.siteId),siteDir:BX.componentParameters.get("SITE_DIR",env.siteDir),projectId:e.id,action:"view",item:s,newsPathTemplate:this.newsPathTemplate,calendarWebPathTemplate:this.calendarWebPathTemplate,currentUserId:parseInt(this.userId||0)};BX.postComponentEvent("projectbackground::project::action",[i],"background")}}addProject(){ProjectCreateManager.open(this.userId)}addItem(e){BX.onViewLoaded((()=>{const t=String(e.id);if(this.projectList.has(t)){return}const s=new Project(this.userId);s.setData(e);this.projectList.set(t,s);this.welcomeScreen.hide();const i=this.prepareListItem(s);this.list.addItems([i]);this.cache.addProject(s,i)}))}updateItem(e,t={}){BX.onViewLoaded((()=>{const s=e.toString();if(!this.projectList.has(s)){return}const i=this.projectList.get(s);i.updateData(t);const o=this.prepareListItem(i);this.list.updateItem({id:s},o);this.cache.updateProject({[s]:{project:i,projectItem:o}})}))}removeItem(e){BX.onViewLoaded((()=>{this.projectList.delete(e);this.list.removeItem({id:e});this.cache.removeProject(e);if(this.projectList.size===0){this.welcomeScreen.show()}}))}onTabSelected(e){if(e.tabId==="tasks.project.list"){this.onAppActive()}else{this.onAppPaused()}}onAppPaused(){this.pauseTime=new Date;this.pull.setCanExecute(false);this.pull.clear()}onAppActive(){this.activationTime=new Date;if(this.pauseTime){const e=this.activationTime.getTime()-this.pauseTime.getTime();const t=Math.abs(Math.round(e/6e4));if(t>29){this.runOnAppActiveRepeatedActions()}else{this.updateProjectsFromEvents()}}}runOnAppActiveRepeatedActions(){this.setFloatingButton();this.filter.updateCounters();this.reload();this.search.fillCacheWithLastActiveProjects();this.pull.onAppActive()}updateProjectsFromEvents(){this.loading.showForTitle();setTimeout((()=>{const e=this.pull.getProjectsToUpdateFromEvents();if(e.length>15){this.runOnAppActiveRepeatedActions();return}const t=[new Promise((e=>{this.pull.extendWatch();this.pull.startWatch().then((()=>{this.pull.setCanExecute(true);this.pull.freeQueue().then((()=>e()))}))}))];if(e.length){t.push(new Promise((e=>{this.filter.updateCounters();e()})));t.push(this.updateProjects(e))}Promise.allSettled(t).then((()=>this.loading.hideForTitle()))}),1e3)}updateProjects(e){return new Promise(((t,s)=>{new RequestExecutor("tasks.project.list",{select:f.select,filter:{...this.filter.get(),ID:e},params:{mode:"mobile"}}).call().then((s=>{this.onUpdateProjectsSuccess(e,s.result.projects);t()}),(e=>{console.error(e);s()}))}))}onUpdateProjectsSuccess(e,t){e.forEach((e=>{const s=t.find((t=>Number(t.id)===Number(e)));if(s){this.projectList.has(e)?this.updateItem(e,s):this.addItem(s)}else if(this.projectList.has(e)){this.removeItem(e)}}))}pseudoReadProjects(e){const t=[];const s={};let i=0;this.projectList.forEach((o=>{const r=String(o.id);if(e.includes(r)){i+=o.getNewCommentsCount();o.pseudoRead();const e=this.prepareListItem(o);t.push({filter:{id:r},element:e});s[r]={project:o,projectItem:e}}}));this.list.updateItems(t);this.cache.updateProject(s);this.filter.pseudoUpdateCounters(-i)}}return new f(list,parseInt(BX.componentParameters.get("USER_ID",0),10),{projectNewsPathTemplate:BX.componentParameters.get("PROJECT_NEWS_PATH_TEMPLATE",""),projectCalendarWebPathTemplate:BX.componentParameters.get("PROJECT_CALENDAR_WEB_PATH_TEMPLATE","")})})();
//# sourceMappingURL=component.map.js