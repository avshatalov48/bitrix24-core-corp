(()=>{const{Loc:e}=jn.require("loc");const{Type:t}=jn.require("type");const s="/bitrix/mobileapp/tasksmobile/extensions/tasks/task/";class i{static get types(){return{expired:{expired:"expired",projectExpired:"projectExpired"},newComments:{newComments:"newComments",projectNewComments:"projectNewComments"},my:{expired:"expired",newComments:"newComments"},project:{projectExpired:"projectExpired",projectNewComments:"projectNewComments"}}}static get colors(){return{danger:"danger",success:"success",gray:"gray"}}constructor(e){this.task=e;this.set(this.getDefault())}getDefault(){return{counters:{[i.types.my.expired]:0,[i.types.my.newComments]:0,[i.types.project.projectExpired]:0,[i.types.project.projectNewComments]:0},color:i.colors.gray,value:0}}get(){return{counters:this.counters,color:this.color,value:this.value}}set(e){this.counters=e.counters||this.counters;this.color=e.color||this.color;this.value=e.value||0}exportProperties(){return this.get()}importProperties(e){this.set(e)}read(){Object.keys(this.counters).forEach((e=>{if(i.types.newComments[e]){this.value-=this.counters[e];this.counters[e]=0}}));this.value=this.value<0?0:this.value;this.color=this.counters[i.types.expired.expired]>0?i.colors.danger:i.colors.gray}getNewCommentsCount(){let e=0;Object.keys(this.counters).forEach((t=>{if(i.types.newComments[t]){e+=this.counters[t]}}));return e}}class a{static get types(){return{changeDeadline:"changeDeadline",changeResponsible:"changeResponsible",changeGroup:"changeGroup",delegate:"delegate",unfollow:"unfollow",start:"start",pause:"pause",complete:"complete",renew:"renew",approve:"approve",disapprove:"disapprove",defer:"defer",edit:"edit",remove:"remove",pin:"pin",unpin:"unpin",mute:"mute",unmute:"unmute",read:"read",ping:"ping",addTask:"addTask",addSubTask:"addSubTask","favorite.add":"favorite.add","favorite.delete":"favorite.delete"}}constructor(e){this.task=e;this.counter=e._counter;this.fieldChangesTracker=e._fieldChangesTracker;this.set(this.getDefault())}getDefault(){return{[a.types.changeDeadline]:false,[a.types.delegate]:false,[a.types.start]:false,[a.types.pause]:false,[a.types.complete]:false,[a.types.renew]:false,[a.types.approve]:false,[a.types.disapprove]:false,[a.types.defer]:false,[a.types.edit]:false,[a.types.remove]:false,[a.types["favorite.add"]]:false,[a.types["favorite.delete"]]:false}}get(){return{[a.types.changeDeadline]:this.canChangeDeadline,[a.types.changeResponsible]:this.canEdit||this.task.currentUser.isAdmin||this.task.isCreator(),[a.types.changeGroup]:this.canEdit,[a.types.delegate]:this.canDelegate,[a.types.unfollow]:this.task.isAuditor(),[a.types.start]:this.canStart,[a.types.pause]:this.canPause,[a.types.complete]:this.canComplete,[a.types.renew]:this.canRenew,[a.types.approve]:this.canApprove,[a.types.disapprove]:this.canDisapprove,[a.types.defer]:this.canDefer,[a.types.edit]:this.canEdit,[a.types.remove]:this.canRemove,[a.types.pin]:!this.task.isPinned,[a.types.unpin]:this.task.isPinned,[a.types.mute]:!this.task.isMuted,[a.types.unmute]:this.task.isMuted,[a.types.read]:true,[a.types.ping]:true,[a.types.addTask]:true,[a.types.addSubTask]:true,[a.types["favorite.add"]]:this.canAddToFavorite,[a.types["favorite.delete"]]:this.canRemoveFromFavorite}}set(e){this.canChangeDeadline=e.changeDeadline||false;this.canDelegate=e.delegate||false;this.canStart=e.start||false;this.canPause=e.pause||false;this.canComplete=e.complete||false;this.canRenew=e.renew||false;this.canApprove=e.approve||false;this.canDisapprove=e.disapprove||false;this.canDefer=e.defer||false;this.canEdit=e.edit||false;this.canRemove=e.remove||false;this.canAddToFavorite=e["favorite.add"]||false;this.canRemoveFromFavorite=e["favorite.delete"]||false}updateActions(e){const t=Object.prototype.hasOwnProperty;if(t.call(e,"canChangeDeadline")){this.canChangeDeadline=e.canChangeDeadline}if(t.call(e,"canDelegate")){this.canDelegate=e.canDelegate}if(t.call(e,"canStart")){this.canStart=e.canStart}if(t.call(e,"canPause")){this.canPause=e.canPause}if(t.call(e,"canComplete")){this.canComplete=e.canComplete}if(t.call(e,"canRenew")){this.canRenew=e.canRenew}if(t.call(e,"canApprove")){this.canApprove=e.canApprove}if(t.call(e,"canDisapprove")){this.canDisapprove=e.canDisapprove}if(t.call(e,"canDefer")){this.canDefer=e.canDefer}if(t.call(e,"canEdit")){this.canEdit=e.canEdit}if(t.call(e,"canRemove")){this.canRemove=e.canRemove}if(t.call(e,"canAddToFavorite")){this.canAddToFavorite=e.canAddToFavorite}if(t.call(e,"canRemoveFromFavorite")){this.canRemoveFromFavorite=e.canRemoveFromFavorite}}exportProperties(){return{canChangeDeadline:this.canChangeDeadline,canDelegate:this.canDelegate,canStart:this.canStart,canPause:this.canPause,canComplete:this.canComplete,canRenew:this.canRenew,canApprove:this.canApprove,canDisapprove:this.canDisapprove,canDefer:this.canDefer,canEdit:this.canEdit,canRemove:this.canRemove,canAddToFavorite:this.canAddToFavorite,canRemoveFromFavorite:this.canRemoveFromFavorite}}importProperties(e){this.canChangeDeadline=e.canChangeDeadline;this.canDelegate=e.canDelegate;this.canStart=e.canStart;this.canPause=e.canPause;this.canComplete=e.canComplete;this.canRenew=e.canRenew;this.canApprove=e.canApprove;this.canDisapprove=e.canDisapprove;this.canDefer=e.canDefer;this.canEdit=e.canEdit;this.canRemove=e.canRemove;this.canAddToFavorite=e.canAddToFavorite;this.canRemoveFromFavorite=e.canRemoveFromFavorite}save(){if(this.task.isNewRecord){return this.add()}return this.update()}add(){console.log("Create task");return new Promise(((e,t)=>{new RequestExecutor("tasks.task.add",{fields:{...this.getFieldsToSave(),GUID:this.task.guid},params:{PLATFORM:"mobile"}}).call().then((t=>{console.log(t);const{task:s}=t.result;this.task.isNewRecord=false;this.task.id=s.id;this.set(s.action);e(t)}),(e=>{console.log(e);Notify.showMessage(e.error.description.replace(/<\/?[^>]+(>|$)/g,""),"",{time:5});t(e)}))}))}update(){console.log("Update task");return new Promise(((e,t)=>{const s=this.getFieldsToSave();if(!Object.keys(s).length){e()}new RequestExecutor("tasks.task.update",{taskId:this.task.id,fields:s}).call().then((t=>{console.log(t);const{task:s}=t.result;this.task.updateData(s);e(t)}),(e=>{console.log(e);t(e)}))}))}getFieldsToSave(){const e={[o.fields.title]:()=>({TITLE:this.task.title}),[o.fields.description]:()=>({DESCRIPTION:this.task.description}),[o.fields.status]:()=>({STATUS:this.task.status}),[o.fields.group]:()=>({GROUP_ID:this.task.groupId||0}),[o.fields.priority]:()=>({PRIORITY:this.task.priority}),[o.fields.timeEstimate]:()=>({TIME_ESTIMATE:this.task.timeEstimate}),[o.fields.creator]:()=>({CREATED_BY:this.task.creator.id}),[o.fields.responsible]:()=>({RESPONSIBLE_ID:this.task.responsible.id}),[o.fields.accomplices]:()=>({ACCOMPLICES:Object.keys(this.task.accomplices)}),[o.fields.auditors]:()=>({AUDITORS:Object.keys(this.task.auditors)}),[o.fields.deadline]:()=>({DEADLINE:this.task.deadline?new Date(this.task.deadline).toISOString():null}),[o.fields.startDatePlan]:()=>({START_DATE_PLAN:this.task.startDatePlan?new Date(this.task.startDatePlan).toISOString():null}),[o.fields.endDatePlan]:()=>({END_DATE_PLAN:this.task.endDatePlan?new Date(this.task.endDatePlan).toISOString():null}),[o.fields.allowChangeDeadline]:()=>({ALLOW_CHANGE_DEADLINE:this.task.allowChangeDeadline?"Y":"N"}),[o.fields.isMatchWorkTime]:()=>({MATCH_WORK_TIME:this.task.isMatchWorkTime?"Y":"N"}),[o.fields.allowTaskControl]:()=>({TASK_CONTROL:this.task.allowTaskControl?"Y":"N"}),[o.fields.allowTimeTracking]:()=>({ALLOW_TIME_TRACKING:this.task.allowTimeTracking?"Y":"N"}),[o.fields.isResultRequired]:()=>({SE_PARAMETER:[{CODE:o.parameterCodes.isResultRequired,VALUE:this.task.isResultRequired?"Y":"N"}]}),[o.fields.mark]:()=>!t.isUndefined(this.task.mark)?{MARK:this.task.mark===o.mark.none?"":this.task.mark}:{},[o.fields.tags]:()=>!t.isUndefined(this.task.tags)?{TAGS:this.task.tags}:{},[o.fields.crm]:()=>!t.isUndefined(this.task.crm)?{CRM:Object.keys(this.task.crm).length>0?this.task.crm:[]}:{},[o.fields.uploadedFiles]:()=>!t.isUndefined(this.task.uploadedFiles)?{UPLOADED_FILES:this.task.uploadedFiles.map((e=>e.token))}:{},[o.fields.files]:()=>{const e={};if(!t.isUndefined(this.task.diskFiles)){e.UF_TASK_WEBDAV_FILES=this.task.diskFiles}else if(!t.isUndefined(this.task.files)){e.UF_TASK_WEBDAV_FILES=this.task.files.map((e=>e.id))}return e}};const s=this.fieldChangesTracker.isEnabled?this.fieldChangesTracker.getChangedFields():Object.values(o.fields);return s.reduce(((t,s)=>{if(Object.keys(e).includes(s)){t={...t,...e[s]()}}return t}),{})}remove(){return new Promise(((e,t)=>{new RequestExecutor("tasks.task.delete",{taskId:this.task.id}).call().then((t=>{console.log(t);e(t)}),(e=>{console.log(e);t(e)}))}))}saveDeadline(){return new Promise(((e,t)=>{new RequestExecutor("tasks.task.update",{taskId:this.task.id,fields:{DEADLINE:this.task.deadline?new Date(this.task.deadline).toISOString():null}}).call().then((t=>{console.log(t);e(t)}),(e=>{console.log(e);t(e)}))}))}delegate(){return new Promise(((e,t)=>{new RequestExecutor("tasks.task.delegate",{taskId:this.task.id,userId:this.task.responsible.id,params:{PLATFORM:"mobile"}}).call().then((t=>{console.log(t);const{task:s}=t.result;this.task.auditors=s.auditors;this.set(s.action);e(t)}),(e=>{console.log(e);t(e)}))}))}stopWatch(){return new Promise(((e,t)=>{new RequestExecutor("tasks.task.stopWatch",{taskId:this.task.id}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}startTimer(){this.task.isTimerRunningForCurrentUser=true;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.startTimer",{taskId:this.task.id}).call().then((t=>{console.log(t);const{task:s}=t.result;this.task.isTimerRunningForCurrentUser=s.timerIsRunningForCurrentUser==="Y";this.set(t.result.task.action);e(t)}),(e=>{console.log(e);Notify.showMessage(e.error.description.replace(/<\/?[^>]+(>|$)/g,""),"",{time:5});this.task.isTimerRunningForCurrentUser=false;t(e)}))}))}pauseTimer(){this.task.isTimerRunningForCurrentUser=false;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.pauseTimer",{taskId:this.task.id}).call().then((t=>{console.log(t);const{task:s}=t.result;this.task.isTimerRunningForCurrentUser=s.timerIsRunningForCurrentUser==="Y";this.set(t.result.task.action);e(t)}),(e=>{console.log(e);Notify.showMessage(e.error.description.replace(/<\/?[^>]+(>|$)/g,""),"",{time:5});this.task.isTimerRunningForCurrentUser=true;t(e)}))}))}start(){this.task.status=o.statusList.inprogress;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.start",{taskId:this.task.id}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}pause(){this.task.status=o.statusList.pending;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.pause",{taskId:this.task.id}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}complete(){const e=this.task.status;this.task.status=o.statusList.completed;return new Promise(((t,s)=>{new RequestExecutor("tasks.task.complete",{taskId:this.task.id,params:{HIDE:false,PLATFORM:"mobile"}}).call().then((e=>{console.log(e);this.set(e.result.task.action);t(e)}),(t=>{console.log(t);Notify.showMessage(t.error.description.replace(/<\/?[^>]+(>|$)/g,""),"",{time:5});if(this.task.isResultRequired&&!this.task.isOpenResultExists){this.task.status=e}s(t)}))}))}renew(){this.task.status=o.statusList.pending;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.renew",{taskId:this.task.id,params:{HIDE:false}}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}approve(){this.task.status=o.statusList.completed;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.approve",{taskId:this.task.id}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}disapprove(){this.task.status=o.statusList.pending;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.disapprove",{taskId:this.task.id}).call().then((t=>{console.log(t);this.set(t.result.task.action);e(t)}),(e=>{console.log(e);t(e)}))}))}pin(){this.task.isPinned=true;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.pin",{taskId:this.task.id}).call().then((t=>{console.log(t);this.task.isPinned=true;e(t)}),(e=>{console.log(e);this.task.isPinned=false;t(e)}))}))}unpin(){this.task.isPinned=false;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.unpin",{taskId:this.task.id}).call().then((t=>{console.log(t);this.task.isPinned=false;e(t)}),(e=>{console.log(e);this.task.isPinned=true;t(e)}))}))}mute(){this.task.isMuted=true;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.mute",{taskId:this.task.id}).call().then((t=>{console.log(t);this.task.isMuted=true;e(t)}),(e=>{console.log(e);this.task.isMuted=false;t(e)}))}))}unmute(){this.task.isMuted=false;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.unmute",{taskId:this.task.id}).call().then((t=>{console.log(t);this.task.isMuted=false;e(t)}),(e=>{console.log(e);this.task.isMuted=true;t(e)}))}))}pseudoRead(){this.counter.read()}read(){this.pseudoRead();return new Promise(((e,t)=>{new RequestExecutor("tasks.task.view.update",{taskId:this.task.id}).call().then((t=>{console.log(t);e(t)}),(e=>{console.log(e);t(e)}))}))}ping(){return new Promise(((e,t)=>{new RequestExecutor("tasks.task.ping",{taskId:this.task.id}).call().then((t=>{console.log(t);e(t)}),(e=>{console.log(e);t(e)}))}))}addToFavorite(){this.canAddToFavorite=false;this.canRemoveFromFavorite=true;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.favorite.add",{taskId:this.task.id}).call().then((t=>{console.log(t);this.canAddToFavorite=false;this.canRemoveFromFavorite=true;e(t)}),(e=>{console.log(e);this.canAddToFavorite=true;this.canRemoveFromFavorite=false;t(e)}))}))}removeFromFavorite(){this.canAddToFavorite=true;this.canRemoveFromFavorite=false;return new Promise(((e,t)=>{new RequestExecutor("tasks.task.favorite.remove",{taskId:this.task.id}).call().then((t=>{console.log(t);this.canAddToFavorite=true;this.canRemoveFromFavorite=false;e(t)}),(e=>{console.log(e);this.canAddToFavorite=false;this.canRemoveFromFavorite=true;t(e)}))}))}open(){if(Application.getApiVersion()<31){const e=`${env.siteDir}mobile/tasks/snmrouter/?routePage=#action#&TASK_ID=#taskId#`;const t=BX.componentParameters.get("PATH_TO_TASK_ADD",e).replace("#action#","view").replace("#taskId#",this.task.id);PageManager.openPage({backdrop:{showOnTop:true,forceDismissOnSwipeDown:true},url:t,cache:false,modal:false,title:this.task.title||null})}else{const e=this.task.id;const t={id:e,title:"TASK",taskInfo:this.task.getTaskInfo()};const s={userId:this.task.currentUser.id,taskObject:this.task.canSendMyselfOnOpen?this.task.exportProperties():null};delete t.taskInfo.project;BX.postComponentEvent("taskbackground::task::action",[t,e,s])}}}class r{static checkMatchDates(e,t){let s=false;t.forEach((t=>{if(!s){s=e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()}}));return s}constructor(e){this.task=e}get(){const e=this.getList();let t=null;Object.keys(e).forEach((s=>{if(t===null&&this[s]){t=e[s]}}));return t}getList(){const t="MOBILE_TASKS_TASK_CARD_DEADLINE_STATE";const s=new Date(this.task.deadline);const i=s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return{isCompleted:{message:"",fontColor:"",backgroundColor:""},isDeferred:{message:e.getMessage("MOBILE_TASKS_TASK_CARD_STATE_DEFERRED"),fontColor:"#333333",backgroundColor:"#FFFFFF",border:{color:"#A8ADB4",width:2}},isSupposedlyCompleted:{message:e.getMessage("MOBILE_TASKS_TASK_CARD_STATE_SUPPOSEDLY_COMPLETED"),fontColor:"#333333",backgroundColor:"#FFFFFF",border:{color:"#F7A700",width:2}},isExpired:{message:this.getExpiredTimeText(),fontColor:"#FFFFFF",backgroundColor:"#FF6864"},isToday:{message:`${e.getMessage(`${t}_TODAY`)} ${i}`,fontColor:"#FFFFFF",backgroundColor:"#F9B933"},isTomorrow:{message:e.getMessage(`${t}_TOMORROW`),fontColor:"#FFFFFF",backgroundColor:"#A5C933"},isThisWeek:{message:e.getMessage(`${t}_THIS_WEEK`),fontColor:"#FFFFFF",backgroundColor:"#59D1F8"},isNextWeek:{message:e.getMessage(`${t}_NEXT_WEEK`),fontColor:"#FFFFFF",backgroundColor:"#3AD4CC"},isWoDeadline:{message:e.getMessage(`${t}_NO_DEADLINE`),fontColor:"#828B95",backgroundColor:"#E2E9EC"},isMoreThanTwoWeeks:{message:e.getMessage(`${t}_MORE_THAN_TWO_WEEKS`),fontColor:"#FFFFFF",backgroundColor:"#C2C6CB"}}}get isCompeted(){return this.task.isCompleted}get isDeferred(){return this.task.isDeferred}get isSupposedlyCompleted(){return this.task.isSupposedlyCompleted}get isExpired(){return this.task.isExpired}get isWoDeadline(){return this.task.isWoDeadline}getExpiredTimeText(){const t="MOBILE_TASKS_TASK_CARD_DEADLINE_STATE_EXPIRED";const s={year:{value:31536e3,message:e.getMessage(`${t}_YEAR`)},month:{value:2592e3,message:e.getMessage(`${t}_MONTH`)},week:{value:604800,message:e.getMessage(`${t}_WEEK`)},day:{value:86400,message:e.getMessage(`${t}_DAY`)},hour:{value:3600,message:e.getMessage(`${t}_HOUR`)},minute:{value:60,message:e.getMessage(`${t}_MINUTE`)}};const i=new Date;let a=(i.getTime()-this.task.deadline)/1e3;let r=false;Object.keys(s).forEach((e=>{const t=Math.floor(a/s[e].value);if(!r&&t>=1){r=s[e].message.replace("#TIME#",t);return}a-=t*s[e].value}));return r||s.minute.message.replace("#TIME#",1)}get isToday(){if(!this.task.deadline){return false}const e=new Date(this.task.deadline);const t=new Date;return e&&r.checkMatchDates(e,[t])}get isTomorrow(){if(!this.task.deadline){return false}const e=new Date(this.task.deadline);const t=new Date;t.setDate(t.getDate()+1);return e&&r.checkMatchDates(e,[t])}get isThisWeek(){if(!this.task.deadline){return false}const e=new Date(this.task.deadline);const t=new Date;const s=[];for(let e=1;e<=7;e++){const i=t.getDate()-t.getDay()+e;const a=new Date(t.setDate(i));s.push(a)}return e&&r.checkMatchDates(e,s)}get isNextWeek(){if(!this.task.deadline){return false}const e=new Date(this.task.deadline);const t=[];const s=new Date;s.setDate(s.getDate()+7);for(let e=1;e<=7;e++){const i=s.getDate()-s.getDay()+e;const a=new Date(s.setDate(i));t.push(a)}return e&&r.checkMatchDates(e,t)}get isMoreThanTwoWeeks(){return true}}class n{constructor(e){this.task=e;this.isEnabled=false;this.changedFields=new Set}addChangedFields(e){if(!t.isArray(e)){e=[e]}e.forEach((e=>{if(this.isValidField(e)&&!this.changedFields.has(e)){this.changedFields.add(e)}}))}removeChangedFields(e){if(!t.isArray(e)){e=[e]}e.forEach((e=>{if(this.isFieldChanged(e)){this.changedFields.delete(e)}}))}isFieldChanged(e){return this.isValidField(e)&&this.changedFields.has(e)}getChangedFields(){return Array.from(this.changedFields)}clearChangedFields(){this.changedFields.clear()}isValidField(e){return Object.values(o.fields).includes(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}}class o{static get statusList(){return{pending:2,inprogress:3,waitCtrl:4,completed:5,deferred:6}}static get userOptions(){return{muted:1,pinned:2}}static get parameterCodes(){return{isResultRequired:3}}static get counterColors(){return{danger:"#ff5752",gray:"#a8adb4",success:"#9dcf00"}}static get backgroundColors(){return{default:"#FFFFFF",pinned:"#F4F5F7"}}static get actions(){const t="MOBILE_TASKS_TASK_CARD_VIEW_ACTION";return{more:{identifier:"more",title:e.getMessage(`${t}_MORE`),iconName:"more",color:"#848E9E",position:"right"},cancel:{id:"cancel",title:e.getMessage(`${t}_CANCEL`),textColor:"#828B95",sectionCode:"default",showTopSeparator:true}}}static get deadlines(){const t="MOBILE_TASKS_TASK_CARD_DEADLINE_STATE";return{today:{name:e.getMessage(`${t}_TODAY`)},tomorrow:{name:e.getMessage(`${t}_TOMORROW`)},thisWeek:{name:e.getMessage(`${t}_THIS_WEEK`)},nextWeek:{name:e.getMessage(`${t}_NEXT_WEEK`)},moreThanTwoWeeks:{name:e.getMessage(`${t}_MORE_THAN_TWO_WEEKS`)}}}static get popupImageUrls(){const e=`${s}images/mobile-task-popup-`;const t=".png";const i={ping:"ping",changeDeadline:"deadline",approve:"approve",disapprove:"disapprove",start:"start",pause:"pause",renew:"renew",changeResponsible:"responsible",delegate:"delegate",changeGroup:"group",mute:"mute",unmute:"unmute",unfollow:"unfollow",remove:"remove",read:"read",pin:"pin",unpin:"unpin"};const a={};Object.keys(i).forEach((s=>{a[s]=`${e}${i[s]}${t}`}));return a}static get priority(){return{important:"2",none:"1"}}static get mark(){return{positive:"P",negative:"N",none:null}}static get fields(){return{id:"id",guid:"guid",title:"title",description:"description",group:"group",timeElapsed:"timeElapsed",timeEstimate:"timeEstimate",commentsCount:"commentsCount",serviceCommentsCount:"serviceCommentsCount",status:"status",subStatus:"subStatus",priority:"priority",mark:"mark",creator:"creator",responsible:"responsible",accomplices:"accomplices",auditors:"auditors",crm:"crm",tags:"tags",files:"files",uploadedFiles:"uploadedFiles",relatedTasks:"relatedTasks",subTasks:"subTasks",isMuted:"isMuted",isPinned:"isPinned",isResultRequired:"isResultRequired",isResultExists:"isResultExists",isOpenResultExists:"isOpenResultExists",isMatchWorkTime:"isMatchWorkTime",allowChangeDeadline:"allowChangeDeadline",allowTimeTracking:"allowTimeTracking",allowTaskControl:"allowTaskControl",isTimerRunningForCurrentUser:"isTimerRunningForCurrentUser",deadline:"deadline",activityDate:"activityDate",startDatePlan:"startDatePlan",endDatePlan:"endDatePlan",checkList:"checkList"}}constructor(e){this.currentUser=e;this._counter=new i(this);this._fieldChangesTracker=new n(this);this._actions=new a(this);this._state=new r(this);this.setDefaultData();this.isNewRecord=true}setDefaultData(){this.id=`tmp-id-${(new Date).getTime()}`;this.guid="";this.title="";this.description="";this.parsedDescription="";this.groupId=0;this.group={id:0,name:"",image:""};this.timeElapsed=0;this.timeEstimate=0;this.commentsCount=0;this.serviceCommentsCount=0;this.status=o.statusList.pending;this.subStatus=o.statusList.pending;this.priority=o.priority.none;this.mark=undefined;this.creator={};this.responsible={};this.accomplices={};this.auditors={};this.relatedTasks={};this.subTasks={};this.crm=undefined;this.tags=undefined;this.files=undefined;this.diskFiles=undefined;this.uploadedFiles=undefined;this.counter={};this.actions={};this.isMuted=false;this.isPinned=false;this.isResultRequired=false;this.isResultExists=false;this.isOpenResultExists=false;this.isMatchWorkTime=false;this.allowChangeDeadline=false;this.allowTimeTracking=false;this.allowTaskControl=false;this.isTimerRunningForCurrentUser=false;this.deadline=null;this.activityDate=null;this.startDatePlan=null;this.endDatePlan=null;this.canSendMyselfOnOpen=true}setData(e){this.id=e.id;this.title=e.title;this.description=e.description;this.parsedDescription=e.parsedDescription;this.groupId=e.groupId;this.group=this.groupId>0&&e.group?e.group:{id:0,name:"",image:""};this.timeElapsed=Number(e.timeElapsed);this.timeEstimate=Number(e.timeEstimate);this.commentsCount=Number(e.commentsCount);this.serviceCommentsCount=Number(e.serviceCommentsCount);this.status=e.status;this.subStatus=e.subStatus||this.status;this.priority=e.priority;if(!t.isUndefined(e.mark)){this.mark=e.mark===""?o.mark.none:e.mark}this.creator=e.creator;this.responsible=e.responsible;this.accomplices=t.isArray(e.accomplicesData)?{}:e.accomplicesData;this.auditors=t.isArray(e.auditorsData)?{}:e.auditorsData;this.relatedTasks=t.isArray(e.relatedTasks)?{}:e.relatedTasks;this.subTasks=t.isArray(e.subTasks)?{}:e.subTasks;if(!t.isUndefined(e.crm)){this.crm=t.isArray(e.crm)?{}:e.crm}if(!t.isUndefined(e.tags)){this.tags=e.tags||[]}if(!t.isUndefined(e.files)){this.files=e.files||[]}if(!t.isUndefined(e.uploadedFiles)){this.uploadedFiles=e.uploadedFiles||[]}this.counter=e.counter;this.actions=e.action;this.isMuted=e.isMuted==="Y";this.isPinned=e.isPinned==="Y";this.isResultRequired=e.taskRequireResult==="Y";this.isResultExists=e.taskHasResult==="Y";this.isOpenResultExists=e.taskHasOpenResult==="Y";this.isMatchWorkTime=e.matchWorkTime==="Y";this.allowChangeDeadline=e.allowChangeDeadline==="Y";this.allowTaskControl=e.taskControl==="Y";this.allowTimeTracking=e.allowTimeTracking==="Y";this.isTimerRunningForCurrentUser=e.timerIsRunningForCurrentUser==="Y";this.deadline=Date.parse(e.deadline)||null;this.activityDate=Date.parse(e.activityDate)||null;this.startDatePlan=Date.parse(e.startDatePlan)||null;this.endDatePlan=Date.parse(e.endDatePlan)||null;this.tryUpdateCurrentUserIcon(e.creator);this.tryUpdateCurrentUserIcon(e.responsible)}updateData(e){const s=Object.prototype.hasOwnProperty;if(s.call(e,"id")){this.id=e.id}if(s.call(e,"title")){this.title=e.title}if(s.call(e,"description")){this.description=e.description}if(s.call(e,"parsedDescription")){this.parsedDescription=e.parsedDescription}if(s.call(e,"groupId")){this.groupId=e.groupId}if(s.call(e,"group")){this.group=this.groupId>0&&e.group?e.group:{id:0,name:"",image:""}}if(s.call(e,"timeElapsed")){this.timeElapsed=Number(e.timeElapsed)}if(s.call(e,"timeEstimate")){this.timeEstimate=Number(e.timeEstimate)}if(s.call(e,"commentsCount")){this.commentsCount=Number(e.commentsCount)}if(s.call(e,"serviceCommentsCount")){this.serviceCommentsCount=Number(e.serviceCommentsCount)}if(s.call(e,"status")){this.status=e.status}if(s.call(e,"subStatus")){this.subStatus=e.subStatus}if(s.call(e,"priority")){this.priority=e.priority}if(s.call(e,"mark")){this.mark=e.mark===""?o.mark.none:e.mark}if(s.call(e,"creator")){this.creator=e.creator;this.tryUpdateCurrentUserIcon(e.creator)}if(s.call(e,"responsible")){this.responsible=e.responsible;this.tryUpdateCurrentUserIcon(e.responsible)}if(s.call(e,"accomplicesData")){this.accomplices=t.isArray(e.accomplicesData)?{}:e.accomplicesData}if(s.call(e,"auditorsData")){this.auditors=t.isArray(e.auditorsData)?{}:e.auditorsData}if(s.call(e,"relatedTasks")){this.relatedTasks=t.isArray(e.relatedTasks)?{}:e.relatedTasks}if(s.call(e,"subTasks")){this.subTasks=t.isArray(e.subTasks)?{}:e.subTasks}if(s.call(e,"crm")){this.crm=t.isArray(e.crm)?{}:e.crm}if(s.call(e,"tags")){this.tags=e.tags}if(s.call(e,"files")){this.files=e.files}if(s.call(e,"uploadedFiles")){this.uploadedFiles=e.uploadedFiles}if(s.call(e,"counter")){this.counter=e.counter}if(s.call(e,"action")){this.actions=e.action}if(s.call(e,"isMuted")){this.isMuted=e.isMuted==="Y"}if(s.call(e,"isPinned")){this.isPinned=e.isPinned==="Y"}if(s.call(e,"taskRequireResult")){this.isResultRequired=e.taskRequireResult==="Y"}if(s.call(e,"taskHasResult")){this.isResultExists=e.taskHasResult==="Y"}if(s.call(e,"taskHasOpenResult")){this.isOpenResultExists=e.taskHasOpenResult==="Y"}if(s.call(e,"matchWorkTime")){this.isMatchWorkTime=e.matchWorkTime==="Y"}if(s.call(e,"allowChangeDeadline")){this.allowChangeDeadline=e.allowChangeDeadline==="Y"}if(s.call(e,"taskControl")){this.allowTaskControl=e.taskControl==="Y"}if(s.call(e,"allowTimeTracking")){this.allowTimeTracking=e.allowTimeTracking==="Y"}if(s.call(e,"timerIsRunningForCurrentUser")){this.isTimerRunningForCurrentUser=e.timerIsRunningForCurrentUser==="Y"}if(s.call(e,"deadline")){this.deadline=Date.parse(e.deadline)||null}if(s.call(e,"activityDate")){this.activityDate=Date.parse(e.activityDate)||null}if(s.call(e,"startDatePlan")){this.startDatePlan=Date.parse(e.startDatePlan)||null}if(s.call(e,"endDatePlan")){this.endDatePlan=Date.parse(e.endDatePlan)||null}}exportProperties(){return{currentUser:this.currentUser,isNewRecord:this.isNewRecord,_id:this._id,_guid:this._guid,_status:this._status,_subStatus:this._subStatus,title:this.title,description:this.description,parsedDescription:this.parsedDescription,groupId:this.groupId,group:this.group,timeElapsed:this.timeElapsed,timeEstimate:this.timeEstimate,commentsCount:this.commentsCount,serviceCommentsCount:this.serviceCommentsCount,priority:this.priority,mark:this.mark,creator:this.creator,responsible:this.responsible,accomplices:this.accomplices,auditors:this.auditors,relatedTasks:this.relatedTasks,subTasks:this.subTasks,crm:this.crm,tags:this.tags,files:this.files,diskFiles:this.diskFiles,uploadedFiles:this.uploadedFiles,isMuted:this.isMuted,isPinned:this.isPinned,isResultRequired:this.isResultRequired,isResultExists:this.isResultExists,isOpenResultExists:this.isOpenResultExists,isMatchWorkTime:this.isMatchWorkTime,allowChangeDeadline:this.allowChangeDeadline,allowTaskControl:this.allowTaskControl,allowTimeTracking:this.allowTimeTracking,isTimerRunningForCurrentUser:this.isTimerRunningForCurrentUser,deadline:this.deadline,activityDate:this.activityDate,startDatePlan:this.startDatePlan,endDatePlan:this.endDatePlan,_counter:this._counter.exportProperties(),_actions:this._actions.exportProperties(),isCreator:this.isCreator(),isPureCreator:this.isPureCreator(),isResponsible:this.isResponsible(),isAccomplice:this.isAccomplice(),isAuditor:this.isAuditor(),isMember:this.isMember(),isSupposedlyCompleted:this.isSupposedlyCompleted,isSupposedlyCompletedCounts:this.isSupposedlyCompletedCounts,isCompleted:this.isCompleted,isCompletedCounts:this.isCompletedCounts,isDeferred:this.isDeferred,isWoDeadline:this.isWoDeadline,isExpired:this.isExpired}}importProperties(e){const t=Object.prototype.hasOwnProperty;for(const s in e){if(s==="_counter"){this._counter.importProperties(e[s])}else if(s==="_actions"){this._actions.importProperties(e[s])}else if(t.call(this,s)){this[s]=e[s]}}}tryUpdateCurrentUserIcon(e){if(Number(this.currentUser.id)===Number(e.id)&&this.currentUser.icon!==e.icon){this.currentUser.icon=e.icon}}get id(){return this._id.toString()}set id(e){this._id=e.toString();this.isNewRecord=false}get guid(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}if(!this._guid){this._guid=`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}return this._guid}set guid(e){this._guid=e}get status(){return this._status}set status(e){this._status=Number(e)}get subStatus(){return this._subStatus}set subStatus(e){this._subStatus=Number(e)}isCreator(e=null){return Number(e||this.currentUser.id)===Number(this.creator.id)}isPureCreator(e=null){return Number(e||this.currentUser.id)===Number(this.creator.id)&&Number(e||this.currentUser.id)!==Number(this.responsible.id)}isResponsible(e=null){return Number(e||this.currentUser.id)===Number(this.responsible.id)}isAccomplice(e=null){return Object.keys(this.accomplices).includes((e||this.currentUser.id).toString())}isAuditor(e=null){return Object.keys(this.auditors).includes((e||this.currentUser.id).toString())}isMember(e=null){return this.isCreator(e)||this.isResponsible(e)||this.isAccomplice(e)||this.isAuditor(e)}get isSupposedlyCompleted(){return this.status===o.statusList.waitCtrl}get isSupposedlyCompletedCounts(){return this.isSupposedlyCompleted&&this.isCreator()&&!this.isResponsible()}get isCompleted(){return this.status===o.statusList.completed}get isCompletedCounts(){return this.isCompleted||this.isSupposedlyCompleted&&!this.isCreator()}get isDeferred(){return this.status===o.statusList.deferred}get isWoDeadline(){return!this.deadline}get isExpired(){const e=new Date;return Boolean(this.deadline)&&this.deadline<=e.getTime()}get counter(){return this._counter.get()}set counter(e){this._counter.set(e)}getCounterValue(){return this.counter.value}getCounterColor(){return this.counter.color}getCounterMyExpiredCount(){return this.counter.counters[i.types.my.expired]}getCounterMyNewCommentsCount(){return this.counter.counters[i.types.my.newComments]}getCounterMyCount(){return this.getCounterMyExpiredCount()+this.getCounterMyNewCommentsCount()}getNewCommentsCount(){return this._counter.getNewCommentsCount()}getTaskInfo(e=true){const t=this.getState()||this.getStateList().isCompleted;const s={id:this.id,title:this.title||"",checked:this.isCompletedCounts,checkable:this.actions[a.types.complete]||this.actions[a.types.approve]||this.actions[a.types.renew],state:t.message,date:this.activityDate/1e3,messageCount:this.getCounterValue(),creatorIcon:this.creator.icon,responsibleIcon:this.responsible.icon,actions:e?this.getSwipeActions():[],project:{},params:{},styles:{state:{backgroundColor:t.backgroundColor,font:{color:t.fontColor,fontStyle:"semibold"},border:t.border},counter:{backgroundColor:o.counterColors[this.getCounterColor()]},date:{image:{name:this.isPinned?"message_pin":""},font:{size:13}},title:{additionalImage:{name:this.isMuted?"name_status_mute":""}}}};if(this.groupId>0){s.project={id:this.groupId,imageUrl:this.group.image}}return s}getState(){return this._state.get()}getStateList(){return this._state.getList()}getSwipeActions(){const t="MOBILE_TASKS_TASK_CARD_VIEW_ACTION";const s={changeDeadline:{identifier:"changeDeadline",title:e.getMessage(`${t}_CHANGE_DEADLINE`),iconName:"action_term",color:"#F2A100",position:"right"},approve:{identifier:"approve",title:e.getMessage(`${t}_APPROVE`),iconName:"action_accept",color:"#468EE5",position:"right"},disapprove:{identifier:"disapprove",title:e.getMessage(`${t}_DISAPPROVE`),iconName:"action_finish_up",color:"#FF5752",position:"right"},changeResponsible:{identifier:"changeResponsible",title:e.getMessage(`${t}_CHANGE_RESPONSIBLE`),iconName:"action_userlist",color:"#2F72B9",position:"right"},delegate:{identifier:"delegate",title:e.getMessage(`${t}_DELEGATE`),iconName:"action_userlist",color:"#2F72B9",position:"right"},ping:{identifier:"ping",title:e.getMessage(`${t}_PING`),iconName:"action_ping",color:"#00B4AC",position:"right"},changeGroup:{identifier:"changeGroup",title:e.getMessage(`${t}_CHANGE_GROUP`),iconName:"action_project",color:"#1BA09B",position:"right"},start:{identifier:"start",title:e.getMessage(`${t}_START`),iconName:"action_start",color:"#38C4D6",position:"right"},pause:{identifier:"pause",title:e.getMessage(`${t}_PAUSE`),iconName:"action_finish",color:"#38C4D6",position:"right"},renew:{identifier:"renew",title:e.getMessage(`${t}_RENEW`),iconName:"action_reload",color:"#00B4AC",position:"right"},mute:{identifier:"mute",title:e.getMessage(`${t}_MUTE`),iconName:"action_mute",color:"#8BC84B",position:"right"},unmute:{identifier:"unmute",title:e.getMessage(`${t}_UNMUTE`),iconName:"action_unmute",color:"#8BC84B",position:"right"},unfollow:{identifier:"unfollow",title:e.getMessage(`${t}_DONT_FOLLOW`),iconName:"action_unfollow",color:"#AF6D4D",position:"right"},remove:{identifier:"remove",title:e.getMessage(`${t}_REMOVE`),iconName:"action_remove",color:"#6E7B8F",position:"right"},read:{identifier:"read",title:e.getMessage(`${t}_READ`),iconName:"action_read",color:"#E57BB6",position:"left"},pin:{identifier:"pin",title:e.getMessage(`${t}_PIN`),iconName:"action_pin",color:"#468EE5",position:"left"},unpin:{identifier:"unpin",title:e.getMessage(`${t}_UNPIN`),iconName:`action_unpin`,color:"#468EE5",position:"left"}};const i=[];Object.keys(s).forEach((e=>{if(this.actions[e]){i.push(s[e])}}));if(this.actions[a.types.changeResponsible]&&this.actions[a.types.delegate]){i.splice(i.findIndex((e=>e.identifier==="delegate")),1)}return i}enableFieldChangesTracker(){this._fieldChangesTracker.isEnabled=true}disableFieldChangesTracker(){this._fieldChangesTracker.isEnabled=false}addChangedFields(e){this._fieldChangesTracker.addChangedFields(e)}removeChangedFields(e){this._fieldChangesTracker.removeChangedFields(e)}isFieldChanged(e){return this._fieldChangesTracker.isFieldChanged(e)}haveChangedFields(){return this._fieldChangesTracker.getChangedFields().length>0}getChangedFields(){return this._fieldChangesTracker.getChangedFields()}clearChangedFields(){this._fieldChangesTracker.clearChangedFields()}get actions(){return this._actions.get()}set actions(e){this._actions.set(e)}updateActions(e){this._actions.updateActions(e)}exportActions(){return this._actions.exportProperties()}open(){this._actions.open()}save(){return this._actions.save()}add(){return this._actions.add()}update(){return this._actions.update()}remove(){return this._actions.remove()}saveDeadline(){return this._actions.saveDeadline()}delegate(){return this._actions.delegate()}stopWatch(){return this._actions.stopWatch()}startTimer(){return this._actions.startTimer()}pauseTimer(){return this._actions.pauseTimer()}start(){return this._actions.start()}pause(){return this._actions.pause()}complete(){return this._actions.complete()}renew(){return this._actions.renew()}approve(){return this._actions.approve()}disapprove(){return this._actions.disapprove()}mute(){return this._actions.mute()}unmute(){return this._actions.unmute()}pin(){return this._actions.pin()}unpin(){return this._actions.unpin()}pseudoRead(){this._actions.pseudoRead()}read(){return this._actions.read()}ping(){return this._actions.ping()}addToFavorite(){return this._actions.addToFavorite()}removeFromFavorite(){return this._actions.removeFromFavorite()}}this.Task=o})();
//# sourceMappingURL=extension.map.js