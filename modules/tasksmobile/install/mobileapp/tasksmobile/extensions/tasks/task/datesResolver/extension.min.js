jn.define("tasks/task/datesResolver",((t,e,i)=>{const{CalendarSettings:a}=t("tasks/task/calendar");const{EventEmitter:s}=t("event-emitter");const{Type:n}=t("type");class r{static get durationType(){return{days:"days",hours:"hours",minutes:"mins"}}constructor(t){this.calendar=a;this.id=t.id;this.guid=t.guid;this.isMatchWorkTime=t.isMatchWorkTime;this.deadline=t.deadline?t.deadline/1e3:0;this.startDateStamp=t.startDatePlan?t.startDatePlan/1e3:0;this.endDateStamp=t.endDatePlan?t.endDatePlan/1e3:0;this.durationByType=0;this.durationInSeconds=0;this.durationType=r.durationType.days;this.isSolving=false;this.maxDuration=2147483647;this.eventEmitter=s.createWithUid(this.guid);this.setInitialDuration()}setData(t){this.isMatchWorkTime=t.isMatchWorkTime;this.deadline=t.deadline?t.deadline/1e3:0;this.startDateStamp=t.startDatePlan?t.startDatePlan/1e3:0;this.endDateStamp=t.endDatePlan?t.endDatePlan/1e3:0;this.setInitialDuration()}setInitialDuration(){let t=0;if(this.startDateStamp&&this.endDateStamp){const e=this.startDateStamp?new Date(this.startDateStamp*1e3):null;const i=this.endDateStamp?new Date(this.endDateStamp*1e3):null;if(e&&i&&e<i){t=this.calculateDuration(e,i)/1e3}}this.setDurationFromSeconds(t)}on(t,e){this.eventEmitter.on(t,e);return this}updateDeadline(t,e=false){if(!this.checkNoWorkDays()){this.solveDeadline(t,e)}}updateStartDate(t){if(!this.checkNoWorkDays()){const e=new Date(t*1e3);e.setSeconds(0);this.setStartDate(e);this.solveTriangle(true,false,false)}}updateEndDate(t){if(!this.checkNoWorkDays()){const e=new Date(t*1e3);e.setSeconds(0);this.setEndDate(e);this.solveTriangle(false,true,false)}}updateDuration(t){if(!this.checkNoWorkDays()){this.durationByType=t;this.durationInSeconds=this.getDurationInSeconds(this.durationType,this.durationByType);this.solveTriangle(false,false,true)}}updateDurationType(t){if(!this.checkNoWorkDays()){this.durationType=t;this.durationInSeconds=this.getDurationInSeconds(this.durationType,this.durationByType);this.solveTriangle(false,false,true)}}checkNoWorkDays(){if(!this.isMatchWorkTime){return false}let t=true;const e=this.calendar.weekends;const i=[0,1,2,3,4,5,6];i.forEach((i=>{if(!(i in e)){t=false}}));return t}setDeadline(t){this.deadline=t.getTime()/1e3}setStartDate(t){this.startDateStamp=t.getTime()/1e3}setEndDate(t){this.endDateStamp=t.getTime()/1e3}setIsMatchWorkTime(t){this.isMatchWorkTime=t;if(this.checkNoWorkDays()){return}this.recalculateDuration();if(this.startDateStamp){this.solveTriangle(true,false,false)}else if(this.endDateStamp){this.solveTriangle(false,true,false)}if(this.deadline){this.solveDeadline(this.deadline)}}fixDeadline(t){if(this.isMatchWorkTime&&!this.calendar.isWorkTime(t)){t=this.calendar.getClosestWorkTime(t,true)}return t}fixStartDate(t){if(this.isMatchWorkTime&&!this.calendar.isWorkTime(t)){t=this.calendar.getClosestWorkTime(t,true)}return t}fixEndDate(t){if(this.isMatchWorkTime&&!this.calendar.isWorkTime(t)){t=this.calendar.getClosestWorkTime(t,false)}return t}calculateStartDate(t,e){if(this.isMatchWorkTime){return this.calendar.calculateStartDate(t,e)}else{return new Date(t.getTime()-e)}}calculateEndDate(t,e){if(this.isMatchWorkTime){return this.calendar.calculateEndDate(t,e)}else{return new Date(t.getTime()+e)}}calculateDuration(t,e){if(this.isMatchWorkTime){const i=this.calendar.calculateDuration(t,e);if(i>0){return i}}return e-t}solveDeadline(t,e=false){const i=this.deadline;const a=new Date(t*1e3);a.setSeconds(0);this.setDeadline(this.fixDeadline(a));if(this.deadline!==i){this.eventEmitter.emit("datesResolver:deadlineChanged",[this.deadline,e])}}solveTriangle(t,e,i){if(i){this.solveOnDurationChange()}else if(t){this.solveOnStartDateChange()}else if(e){this.solveOnEndDateChange()}this.eventEmitter.emit("datesResolver:datesChanged",[this.startDateStamp,this.endDateStamp])}solveOnDurationChange(){if(this.isSolving){return}this.isSolving=true;const t=this.durationInSeconds*1e3;const e=this.startDateStamp?new Date(this.startDateStamp*1e3):null;const i=this.endDateStamp?new Date(this.endDateStamp*1e3):null;if(this.durationInSeconds&&!this.isMaxDurationReached(t)){if(e){this.setEndDate(this.calculateEndDate(e,t))}else if(i){this.setStartDate(this.calculateStartDate(i,t))}}this.isSolving=false}solveOnStartDateChange(){if(this.isSolving){return}this.isSolving=true;const t=this.getMultiplier(r.durationType.days);const e=t*1e3;let i=this.durationInSeconds;let a=i*1e3;let s=this.startDateStamp?new Date(this.startDateStamp*1e3):null;let n=this.endDateStamp?new Date(this.endDateStamp*1e3):null;if(s){const r=this.fixStartDate(s);if(r.getTime()!==s.getTime()){s=r;this.setStartDate(r)}if(i){if(!this.isMaxDurationReached(a)){this.setEndDate(this.calculateEndDate(s,a))}}else if(n){const r=this.fixEndDate(n);n=r;this.setEndDate(r);if(s<n){a=this.calculateDuration(s,n);i=a/1e3;this.setDurationFromSeconds(i);this.isMaxDurationReached(a)}else{this.setDurationFromSeconds(t);this.setEndDate(this.calculateEndDate(s,e))}}}this.isSolving=false}solveOnEndDateChange(){if(this.isSolving){return}this.isSolving=true;const t=this.getMultiplier(r.durationType.days);const e=t*1e3;let i=this.durationInSeconds;let a=i*1e3;const s=this.startDateStamp?new Date(this.startDateStamp*1e3):null;let n=this.endDateStamp?new Date(this.endDateStamp*1e3):null;if(n){const r=this.fixEndDate(n);if(r.getTime()!==n.getTime()){n=r;this.setEndDate(r)}if(s){if(s<n){a=this.calculateDuration(s,n);i=a/1e3;this.setDurationFromSeconds(i);this.isMaxDurationReached(a)}else{this.setDurationFromSeconds(t);this.setStartDate(this.calculateStartDate(n,e))}}else if(i){this.setDurationFromSeconds(i);if(!this.isMaxDurationReached(a)){this.setStartDate(this.calculateStartDate(n,a))}}}this.isSolving=false}isMaxDurationReached(t){return!n.isNumber(t)||t/1e3>=this.maxDuration}getMultiplier(t){switch(t){case r.durationType.days:return this.isMatchWorkTime?this.getWorkDayDuration():86400;case r.durationType.hours:return 3600;case r.durationType.minutes:return 60;default:return 1}}getWorkDayDuration(){if(!this.workDayDuration){const t=this.calendar.getWorkDayDuration();this.workDayDuration=t>0?t/1e3:86400}return this.workDayDuration}setDurationFromSeconds(t){if(!n.isNumber(t)){return}this.durationInSeconds=t;if(t){const e=this.getDurationTypeByDuration(t);if(e!==this.durationType){this.durationType=e}}this.durationByType=this.getDurationByType()}getDurationTypeByDuration(t){for(let e=0;e<Object.values(r.durationType).length;e++){const i=Object.values(r.durationType)[e];const a=this.getMultiplier(i);if(t%a===0){return i}}return r.durationType.minutes}getDurationInSeconds(t,e){e=parseInt(e,10);if(n.isNumber(e)&&e>0){return this.getMultiplier(t)*e}return 0}getDurationByType(){const t=Math.floor(this.durationInSeconds/this.getMultiplier(this.durationType));if(t>0){return t}return 0}recalculateDuration(){this.durationInSeconds=this.getDurationInSeconds(this.durationType,this.durationByType)}}i.exports={DatesResolver:r}}));
//# sourceMappingURL=extension.map.js