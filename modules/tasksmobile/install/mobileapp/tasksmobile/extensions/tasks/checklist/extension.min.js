jn.define("tasks/checklist",((e,t,s)=>{const{Loc:i}=e("loc");const{Type:n}=e("type");class a{static buildTree(e){const t=new a({});t.setNodeId(0);if(n.isUndefined(e)||e.descendants.length===0){t.addListItem(t.buildDefaultList());t.setActive(false);return t}Object.keys(e.descendants).forEach((s=>{t.add(a.makeTree(e.descendants[s]))}));return t}static makeTree(e){const t=e.fields;const s=e.descendants;t.action=e.action;const i=new a(t);if(s){Object.keys(s).forEach((e=>{i.add(a.makeTree(s[e]))}))}return i}constructor(e){this.emitter=new JNEventEmitter;const{action:t}=e;this.action={canAdd:t&&"add"in t?t.add:true,canAddAccomplice:t&&"addAccomplice"in t?t.addAccomplice:true,canUpdate:t&&"modify"in t?t.modify:true,canRemove:t&&"remove"in t?t.remove:true,canToggle:t&&"toggle"in t?t.toggle:true};this.taskId=0;this.active=true;this.fields={id:null,parentId:null,title:"",sortIndex:0,displaySortIndex:"",isComplete:false,isImportant:false,isSelected:false,isCollapse:false,completedCount:0,totalCount:0,members:new Map,attachments:{}};this.descendants=[];this.setFields(e);this.focused=this.getTitle()==="";this.setNodeId(this.generateUniqueNodeId());this.setParent(null)}on(e,t){this.emitter.on(e,t);return this}off(){this.emitter.removeAll()}save(e){if(!this.isRoot()){return Promise.resolve()}if(n.isUndefined(e)){e=this.taskId}const t=this.getRequestData();return new Promise(((s,i)=>{new RequestExecutor("tasks.task.checklist.save",{taskId:e,items:t.length>0?t:null}).call().then((e=>{s(e.result)}),(e=>{i(e)}))}))}complete(e){return new Promise(((t,s)=>{new RequestExecutor("tasks.task.checklist.complete",{taskId:this.taskId,checkListItemId:e}).call().then((e=>{t(e.result)}),(e=>{s(e)}))}))}renew(e){return new Promise(((t,s)=>{new RequestExecutor("tasks.task.checklist.renew",{taskId:this.taskId,checkListItemId:e}).call().then((e=>{t(e.result)}),(e=>{s(e)}))}))}buildDefaultList(e=true){const t=new a({title:i.getMessage("TASKSMOBILE_CHECKLIST_PARENT_DEFAULT_TEXT").replace("#number#",this.getDescendantsCount()+1),totalCount:1});if(e){const e=new a({});t.add(e)}return t}getRequestData(e=null){const t=this.getTitle();let s=e||[];if(!this.isRoot()&&t!==""&&t.length>0){s.push(this.getItemRequestData())}this.getDescendants().forEach((e=>{s=e.getRequestData(s)}));return s}getItemRequestData(){const e={NODE_ID:this.getNodeId(),PARENT_NODE_ID:this.getParent().getNodeId(),ID:this.getId(),PARENT_ID:this.getParentId(),TITLE:this.getTitle(),SORT_INDEX:this.getSortIndex(),IS_COMPLETE:this.getIsComplete(),IS_IMPORTANT:this.getIsImportant(),MEMBERS:{},ATTACHMENTS:this.getAttachments()||{}};this.getMembers().forEach(((t,s)=>{e.MEMBERS[s]={TYPE:t.type}}));return e}addListItem(e=null,t=null,s="after"){if(!e){e=new a({})}if(t){if(s==="before"){this.addBefore(e,t)}else if(s==="after"){this.addAfter(e,t)}}else{this.add(e)}this.updateIndexes()}removeListItem(){const e=this.getParent();e.remove(this);e.updateCounts();e.updateIndexes();if(!e.isRoot()&&!e.isList()){const e=this.getList();e.updateCounts();e.updateIndexes()}}add(e,t=null){e.setParent(this);if(t===null){this.descendants.push(e)}else{this.descendants.splice(t,0,e)}e.off();e.on("auditorAdd",(e=>this.emitter.emit("auditorAdd",[e])));e.on("accompliceAdd",(e=>this.emitter.emit("accompliceAdd",[e])));this.updateCounts()}addAfter(e,t){const s=this.descendants.findIndex((e=>e===t));if(s!==-1){this.add(e,s+1)}}addBefore(e,t){const s=this.descendants.findIndex((e=>e===t));if(s!==-1){this.add(e,s)}}remove(e){const t=this.descendants.findIndex((t=>t===e));if(t!==-1){this.descendants.splice(t,1);this.updateCounts()}}isRoot(){return this.getNodeId()===0&&this.getParent()===null}isList(){return!this.isRoot()&&this.getParent().isRoot()}isEmpty(){const e=this.isRoot()?this.getDescendantsCount()===0:this.getList().getDescendantsCount()===0;return e||!this.isActive()}getList(){let e=this;while(!e.getParent().isRoot()){e=e.getParent()}return e}getRootNode(){let e=this;while(e.getParent()!==null){e=e.getParent()}return e}makeChildOf(e,t="bottom"){if(e.getDescendantsCount()>0){const s={top:e.getFirstDescendant(),bottom:e.getLastDescendant()};this.move(s[t],t)}else{const t=this.getParent();const s=e;t.remove(this);s.add(this);this.updateParents(t,s)}}move(e,t="bottom"){if(this.getNodeId()===e.getNodeId()||this.findChild(e.getNodeId())!==null){return}const s=this.getParent();const i=e.getParent();s.remove(this);if(t==="top"){i.addBefore(this,e)}else{i.addAfter(this,e)}this.updateParents(s,i)}tabIn(){if(!this.isFirstDescendant()){this.makeChildOf(this.getLeftSibling(),"bottom")}}tabOut(){const e=this.getParent();if(e.isList()){return}this.move(e,"bottom")}countCompletedCount(e=false){let t=0;this.getDescendants().forEach((s=>{if(s.getIsComplete()){t+=1}if(e){t+=s.countCompletedCount(e)}}));return t}countTotalCount(e=false){let t=0;if(!e){t=this.getDescendantsCount()}else{this.getDescendants().forEach((s=>{t+=1;t+=s.countTotalCount(e)}))}return t}updateParents(e,t){if(e!==t){e.updateCounts();t.updateCounts();e.updateIndexes();t.updateIndexes()}else{t.updateIndexes()}}updateCompletedCount(){const e=this.countCompletedCount();this.setCompletedCount(e)}updateTotalCount(){const e=this.countTotalCount();this.setTotalCount(e)}updateCounts(){this.updateCompletedCount();this.updateTotalCount()}updateIndexes(){this.updateSortIndexes();this.updateDisplaySortIndexes()}updateSortIndexes(){let e=0;this.getDescendants().forEach((t=>{t.setSortIndex(e);e+=1}))}updateDisplaySortIndexes(){const e=this.isList()||this.isRoot()?"":`${this.getDisplaySortIndex()}.`;let t=0;this.getDescendants().forEach((s=>{t+=1;const i=`${e}${t}`;s.setDisplaySortIndex(i);if(!s.isList()){}s.updateDisplaySortIndexes()}))}toggleComplete(){if(this.getList().getIsSelected()||!this.checkCanToggle()){return}const e=this.getIsComplete();this.setIsComplete(!e);this.getParent().updateCounts();this.getList().updateCounts()}toggleImportant(){this.setIsImportant(!this.getIsImportant())}setFields(e){const t=["id","parentId","title","sortIndex","displaySortIndex","isComplete","isImportant","isSelected","isCollapse","completedCount","totalCount","members","attachments"];Object.keys(e).forEach((s=>{const i=this.snakeToCamelCase(s);if(t.indexOf(s)!==-1){const t=this.camelToSnakeCase(s);const i=this[this.snakeToCamelCase(`SET_${t}`)].bind(this);i(e[s])}else if(t.indexOf(i)!==-1){const t=this[this.snakeToCamelCase(`SET_${s}`)].bind(this);t(e[s])}}))}getNodeId(){return this.nodeId}setNodeId(e){this.nodeId=e}getParent(){return this.parent}setParent(e){this.parent=e}getId(){return this.fields.id}setId(e){this.fields.id=e}getParentId(){return this.fields.parentId}setParentId(e){this.fields.parentId=e}getTitle(){return this.fields.title}setTitle(e){this.fields.title=e}getSortIndex(){return this.fields.sortIndex}setSortIndex(e){this.fields.sortIndex=e}getDisplaySortIndex(){return this.fields.displaySortIndex}setDisplaySortIndex(e){this.fields.displaySortIndex=e}getIsComplete(){return this.fields.isComplete}setIsComplete(e){this.fields.isComplete=e}getIsImportant(){return this.fields.isImportant}setIsImportant(e){this.fields.isImportant=e}getIsSelected(){return this.fields.isSelected}setIsSelected(e){this.fields.isSelected=e}getIsCollapse(){return this.fields.isCollapse}setIsCollapse(e){this.fields.isCollapse=e}getCompletedCount(){return this.fields.completedCount}setCompletedCount(e){this.fields.completedCount=e}getTotalCount(){return this.fields.totalCount}setTotalCount(e){this.fields.totalCount=e}getMembers(){return this.fields.members}setMembers(e){const t=new Map;const s={A:"accomplice",U:"auditor"};Object.keys(e).forEach((i=>{const{name:n,type:a}=e[i];t.set(i,{id:i,nameFormatted:n,type:s[a],avatar:""})}));this.fields.members=t}addMember(e){this.emitter.emit(e.type+"Add",[e]);this.fields.members.set(e.id,e)}removeMember(e){this.fields.members.delete(e)}getAttachments(){return this.fields.attachments}getAttachmentsCount(){return Object.keys(this.fields.attachments).length}setAttachments(e){this.fields.attachments=e}addAttachments(e){Object.keys(e).forEach((t=>{this.fields.attachments[t]=e[t]}))}removeAttachment(e){delete this.fields.attachments[e]}getDescendants(){return this.descendants}getDescendantsCount(){return this.descendants.length}getEmptyDescendant(){if(this.getTitle()===""){return this}let e=null;this.descendants.forEach((t=>{if(e===null){e=t.getEmptyDescendant()}}));return e}removeEmptyDescendant(){const e=this.getEmptyDescendant();if(e){e.removeListItem()}}getFocusedDescendant(){if(this.isFocused()){return this}let e=null;this.descendants.forEach((t=>{if(e===null){e=t.getFocusedDescendant()}}));return e}getFirstDescendant(){if(this.descendants.length>0){return this.descendants[0]}return false}getLastDescendant(){if(this.descendants.length>0){return this.descendants[this.descendants.length-1]}return false}isFirstListDescendant(){return this.getParent().isList()&&this.isFirstDescendant()}isFirstDescendant(){return this===this.getParent().getFirstDescendant()}isLastDescendant(){return this===this.getParent().getLastDescendant()}getLeftSibling(){if(this.isFirstDescendant()){return null}const e=this.getParent().getDescendants();const t=e.findIndex((e=>e===this));if(t!==-1){return e[t-1]}return null}getRightSibling(){if(this.isLastDescendant()){return null}const e=this.getParent().getDescendants();const t=e.findIndex((e=>e===this));if(t!==-1){return e[t+1]}return null}getLeftSiblingThrough(){if(this===this.getRootNode()){return null}if(this.isFirstDescendant()){return this.getParent()}let e=this.getLeftSibling();while(e&&e.getDescendantsCount()>0){e=e.getLastDescendant()}return e}getRightSiblingThrough(){if(this.getDescendantsCount()>0){return this.getFirstDescendant()}if(!this.isLastDescendant()){return this.getRightSibling()}let e=this;while(e.getParent()!==null&&e.isLastDescendant()){e=e.getParent()}if(e!==this.getRootNode()){return e.getRightSibling()}return null}findChild(e){if(!e){return null}if(this.getNodeId().toString()===e.toString()){return this}let t=null;this.descendants.forEach((s=>{if(t===null){t=s.findChild(e)}}));return t}findById(e){if(!e){return null}if(this.getId()&&this.getId().toString()===e.toString()){return this}let t=null;this.getDescendants().forEach((s=>{if(t===null){t=s.findById(e)}}));return t}getFakeAttachmentsCount(e,t){const s=Object.keys(this.getAttachments());const i=s.filter((t=>!e.includes(t))).length;return i+t.length}countTreeSize(){let e=this.getDescendantsCount();this.descendants.forEach((t=>{e+=t.countTreeSize()}));return e}getTreeSize(){return this.getRootNode().countTreeSize()+1}hasAnotherCheckLists(){const e=this.getList();const t=this.getRootNode().getDescendants().filter((t=>t!==e));return t.length>0}getAnotherCheckLists(){const e=[];const t=this.getList();const s=this.getRootNode().getDescendants().filter((e=>e!==t));s.forEach((t=>{e.push({id:t.getNodeId(),title:t.getTitle()})}));return e}generateUniqueNodeId(){return Math.random().toString(36).substr(2,9)}snakeToCamelCase(e){let t=e;if(BX.type.isString(t)){t=t.toLowerCase();t=t.replace(/[-_\s]+(.)?/g,((e,t)=>t?t.toUpperCase():""));return t.substr(0,1).toLowerCase()+t.substr(1)}return t}camelToSnakeCase(e){let t=e;if(BX.type.isString(t)){t=t.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase()}return t}isActive(){return this.active}setActive(e){this.active=e===true}setTaskId(e){this.taskId=parseInt(e,10)}getTaskId(){if(this.isRoot()){return this.taskId}else{return this.getParent().getTaskId()}}setCanAdd(e){this.action.canAdd=e===true}checkCanAdd(){return this.action.canAdd}checkCanAddAccomplice(){return this.action.canAddAccomplice}checkCanUpdate(){return this.action.canUpdate}checkCanRemove(){return this.action.canRemove}checkCanToggle(){return this.action.canToggle}checkEditMode(){if(this.isRoot()){return this.taskId===0}else{return this.getParent().checkEditMode()}}checkCanTabIn(){return!this.isRoot()&&!this.isList()&&!this.isFirstDescendant()}checkCanTabOut(){return!this.isRoot()&&!this.isList()&&!this.getParent().isList()}focus(){this.focused=true}blur(){this.focused=false}isFocused(){return this.focused}}class d{constructor(){this.queue=new Map}getQueue(){return this.queue}addChecklistQueue(e){if(!this.queue.has(e)){this.queue.set(e,new Set)}}removeChecklistQueue(e){if(this.queue.has(e)){this.queue.delete(e)}}getChecklistQueue(e){this.addChecklistQueue(e);return this.queue.get(e)}getArrayChecklistQueue(e){return Array.from(this.getChecklistQueue(e))}addFile(e,t){this.getChecklistQueue(e).add(t)}removeFile(e){this.queue.forEach((t=>t.delete(e)))}}class o extends BaseList{static id(){return"checklistFiles"}static method(){return"mobile.disk.getattachmentsdata"}static getTypeByFileName(e){let t=e.split(".").pop();if(t){t=t.toLowerCase()}return o.getTypeByFileExtension(t)}static getTypeByFileExtension(e=""){const t={jpg:"image",jpeg:"image",png:"image",gif:"image",tiff:"image",bmp:"image",avi:"video",mov:"video",mpeg:"video",mp4:"video"};return t[e.toLowerCase()]||"document"}static getIconByFileName(e){let t=e.split(".").pop();if(t){t=t.toLowerCase()}return o.getIconByFileExtension(t)}static getIconByFileExtension(e=""){const t={pdf:"pdf.png",jpg:"img.png",png:"img.png",doc:"doc.png",docx:"doc.png",ppt:"ppt.png",pptx:"ppt.png",rar:"rar.png",xls:"xls.png",csv:"xls.png",xlsx:"xls.png",zip:"zip.png",txt:"txt.png",avi:"movie.png",mov:"movie.png",mpeg:"movie.png",mp4:"movie.png"};let s=e;if(s){s=s.toLowerCase()}return t[s]?`${t[s]}?2`:"blank.png?21"}static getFileSize(e){let t=e/1024;if(t<1024){t=`${Math.ceil(t)} ${i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_ITEM_SIZE_KB")}`}else{t=`${(t/1024).toFixed(1)} ${i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_ITEM_SIZE_MB")}`}return t}prepareItem(e){const t=e.SIZE||o.getFileSize(e.size);const s=e.EXTENSION?o.getTypeByFileExtension(e.EXTENSION):o.getTypeByFileName(e.NAME||e.name);const n={id:String(e.ID||e.id),title:e.NAME||e.name,subtitle:`${t} ${new Date(e.UPDATE_TIME||e.updateTime).toLocaleString()}`,sectionCode:"checklistFiles",styles:{image:{image:{borderRadius:0}}},params:{previewUrl:e.URL||e.links.download,type:s},type:"info"};if(this.canUpdate){n.actions=[{title:i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_REMOVE"),color:"#fb5d54",identifier:"remove"}]}if(s==="image"){n.imageUrl=e.URL||e.links.download;n.styles.image.image.borderRadius=10}else{const t="/bitrix/mobileapp/mobile/extensions/bitrix/disk/";const s=e.EXTENSION?o.getIconByFileExtension(e.EXTENSION):o.getIconByFileName(e.NAME||e.name);n.imageUrl=`${t}/images/${s}`}return n}static prepareLoadingItem(e){const t={id:e.id,title:e.name,subtitle:i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_ITEM_LOADING"),sectionCode:"checklistFiles",unselectable:true,styles:{image:{image:{borderRadius:0}}},params:{previewUrl:e.previewUrl,type:o.getTypeByFileName(e.name)},type:"info"};if(t.params.type==="image"){t.imageUrl=e.previewUrl;t.styles.image.image.borderRadius=10}else{const s="/bitrix/mobileapp/mobile/extensions/bitrix/disk/";const i=o.getIconByFileName(e.name);t.imageUrl=`${s}/images/${i}`}return t}static prepareDiskItem(e){const t=o.getTypeByFileName(e.NAME);const s={id:e.ID,title:e.NAME,subtitle:e.TAGS,sectionCode:"checklistFiles",styles:{image:{image:{borderRadius:0}}},params:{previewUrl:e.URL.URL,type:t},actions:[{title:i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_REMOVE"),color:"#fb5d54",identifier:"remove"}],type:"info"};if(t==="image"){s.imageUrl=e.URL.URL;s.styles.image.image.borderRadius=10}else{const t="/bitrix/mobileapp/mobile/extensions/bitrix/disk/";const i=o.getIconByFileName(e.NAME);s.imageUrl=`${t}/images/${i}`}return s}static openFile(e,t="",s,i=""){if(s==="video"){viewer.openVideo(e)}else if(s==="image"){viewer.openImageCollection([{url:e,previewUrl:t,name:i}])}else{viewer.openDocument(e,i)}}params(){return{attachmentsIds:this.attachmentsIds}}prepareItems(e){const t=[];this.files.forEach((s=>{if(s.id.indexOf("taskChecklist-")!==0&&!e.find((e=>e.ID===s.id))&&!this.filesStorage.getArrayFiles().find((e=>e.id===s.id))&&!this.filesToShow.has(s.id)){t.push(s)}}));this.files=new Map;e.forEach((e=>{const s=this.prepareItem(e);this.files.set(s.id,s);t.push(s)}));if(this.isEditMode()){this.filesToShow.forEach((e=>{if(e.dataAttributes){if(e.checkListItemId===this.checkListItemId){const s=o.prepareDiskItem(e.dataAttributes);this.files.set(s.id,s);t.push(s)}}else if(e.extra.params.ajaxData.checkListItemId===this.checkListItemId){const s=this.prepareItem(e);this.files.set(s.id,s);t.push(s)}}))}this.filesStorage.getArrayFiles().forEach((e=>{if(e.params.ajaxData.checkListItemId===this.checkListItemId){const s=o.prepareLoadingItem(e);this.files.set(s.id,s);t.push(s)}}));return t}get list(){return this._list}constructor(e,t,s,i){super(e);this.emitter=new JNEventEmitter;this.userId=t;this.checklistData=s;this.checklistController=i;this.canUpdate=s.canUpdate;this.attachmentsIds=s.attachmentsIds;this.checkListItemId=s.ajaxData.checkListItemId;this.filesToRemoveQueue=i.filesToRemoveQueue;this.filesToAddQueue=i.filesToAddQueue;this.filesToShow=i.filesToShow;this.filesStorage=i.filesStorage;this.mode=i.mode;this.files=new Map;this.setListeners();this.setTopButtons()}on(e,t){this.emitter.on(e,t);return this}setTopButtons(){this.list.setLeftButtons([{name:i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_BACK"),callback:()=>{this.list.close()}}]);if(this.canUpdate){this.list.setRightButtons([{name:i.getMessage("TASKSMOBILE_CHECKLIST_FILES_LIST_ADD"),callback:()=>{const{nodeId:e}=this.checklistData;this.checklistController.addFile(this.checklistData,{nodeId:e})}}])}}setListeners(){const e={onViewRemoved:this.onViewRemoved,onItemSelected:this.onItemSelected,onItemAction:this.onItemAction};this.list.setListener(((t,s)=>{if(e[t]){e[t].apply(this,[s])}}))}isEditMode(){return this.mode==="edit"}addDiskFile(e){const t=o.prepareDiskItem(e);this.list.addItems([t]);this.files.set(t.id,t)}addLoadingFile(e,t){t.id=e;const s=o.prepareLoadingItem(t);this.list.addItems([s]);this.files.set(s.id,s)}addRealFile(e,t){const s=Object.assign(this.prepareItem(t),{unselectable:false});this.list.findItem({id:e},(t=>{if(t){this.list.updateItem({id:e},s)}else{this.list.addItems([s])}}));this.files.delete(e);this.files.set(s.id,s)}onViewRemoved(){this.checklistController.filesList=null}onItemSelected(e){if(e.unselectable){return}const{previewUrl:t,type:s}=e.params;o.openFile(t,t,s,e.title)}onItemAction(e){const t=e.item.id;if(e.action.identifier==="remove"){this.onItemActionDelete(t)}}onItemActionDelete(e){if(!this.canUpdate){return}const{ajaxData:t}=this.checklistData;const{checkListItemId:s}=t;this.list.removeItem({id:e});this.filesToRemoveQueue.addFile(s,e);this.filesToShow.delete(e);this.files.delete(e);this.emitter.emit("fakeRemoveFiles",[{nodeId:this.checklistData.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(s),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(s)}]);if(this.isEditMode()){this.removeFileInEditMode(t,e)}else{this.removeFileInViewMode(t,e)}if(this.files.size===0){this.list.close()}}removeFileInViewMode(e,t){const{entityId:s,entityTypeId:i,checkListItemId:n}=e;BX.ajax.runAction("tasks.task.checklist.removeAttachments",{data:{checkListItemId:n,[i]:s,attachmentsIds:[t]}}).then((e=>{if(e.status==="success"){const{attachments:s}=e.data.checkListItem;this.attachmentsIds=this.attachmentsIds.filter((e=>e!==t));this.filesToRemoveQueue.removeFile(t);this.emitter.emit("removeFiles",[{attachments:s,nodeId:this.checklistData.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(n),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(n)}])}else{this.filesToRemoveQueue.removeFile(t);this.reload();this.emitter.emit("fakeRemoveFiles",[{nodeId:this.checklistData.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(n),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(n)}])}}))}removeFileInEditMode(e,t){const{checkListItemId:s}=e;this.filesToRemoveQueue.removeFile(t);this.emitter.emit("removeAttachment",[{nodeId:s,attachmentId:t}]);this.emitter.emit("fakeRemoveFiles",[{nodeId:this.checklistData.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(s),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(s)}])}}class l{static getGuid(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}constructor(e){this.taskId=e.taskId;this.userId=e.userId;this.taskGuid=e.taskGuid;this.diskConfig=e.diskConfig;this.mode=e.mode;this.emitter=new JNEventEmitter;this.filesList=null;this.filesToAddQueue=new d;this.filesToRemoveQueue=new d;this.filesToShow=new Map;this.filesStorage=new TaskChecklistUploadFilesStorage;this.filesStorage.getArrayFiles().forEach((e=>{if(this.checkEvent(e.params.taskId)){const{checkListItemId:t}=e.params.ajaxData;this.filesToAddQueue.addFile(t,e.id)}}));this.setListeners()}setMode(e){this.mode=e==="edit"?"edit":"view"}on(e,t){this.emitter.on(e,t);return this}setListeners(){BX.addCustomEvent("onChecklistInit",this.onChecklistInit.bind(this));BX.addCustomEvent("onFileUploadStatusChanged",this.onFileUploadStatusChange.bind(this))}checkEvent(e=null,t=null){let s=true;let i=true;if(e!==null){s=Number(this.taskId)===Number(e)}if(t!==null){i=this.taskGuid===t}return s&&i}sendOnChecklistInitQueueData(){this.filesToAddQueue.getQueue().forEach(((e,t)=>{this.emitter.emit("fakeAttachFiles",[{checkListItemId:t,nodeId:null,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(t),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(t)}])}))}onChecklistInit(e){const{taskId:t,taskGuid:s}=e;if(this.checkEvent(t,s)){this.sendOnChecklistInitQueueData()}}initFileList(e,t){t.ajaxData.entityId=this.taskId;this.filesToAddQueue.addChecklistQueue(t.checkListItemId);this.filesList=new o(e,this.userId,t,this);this.filesList.init(false);this.filesList.on("removeAttachment",(e=>{this.emitter.emit("removeAttachment",[e])}));this.filesList.on("removeFiles",(e=>{this.emitter.emit("removeFiles",[e])}));this.filesList.on("fakeRemoveFiles",(e=>{this.emitter.emit("fakeRemoveFiles",[e])}))}addFile(e,t){const s=`/mobile/?mobile_action=disk_folder_list&type=user&path=%2F&entityId=${this.userId}`;dialogs.showImagePicker({settings:{resize:{targetWidth:-1,targetHeight:-1,sourceType:1,encodingType:0,mediaType:2,allowsEdit:true,saveToPhotoAlbum:true,cameraDirection:0},maxAttachedFilesCount:3,previewMaxWidth:640,previewMaxHeight:640,attachButton:{items:[{id:"disk",name:i.getMessage("TASKSMOBILE_CHECKLIST_IMAGE_PICKER_BITRIX24_DISK"),dataSource:{multiple:true,url:s}},{id:"mediateka",name:i.getMessage("TASKSMOBILE_CHECKLIST_IMAGE_PICKER_GALLERY")}]}}},(s=>{this.onImagePickerFileChoose(e,t,s)}))}onImagePickerFileChoose(e,t,s){const{ajaxData:i}=e;const n=[];const a=[];const d=[];let o="mediateka";s.forEach((e=>{if(e.dataAttributes){o="disk";n.push(e);a.push(e.dataAttributes.ID)}else{const t=`taskChecklist-${l.getGuid()}`;e.ajaxData=i;e.taskId=this.taskId;d.push({taskId:t,id:t,params:e,name:e.name,type:e.type,url:e.url,previewUrl:e.previewUrl,folderId:this.diskConfig.folderId,onDestroyEventName:TaskChecklistUploaderEvents.FILE_SUCCESS_UPLOAD})}}));if(o==="disk"){i.attachmentsIds=a;this.attachDiskFiles(i,n,t)}else{this.filesStorage.addFiles(d);BX.postComponentEvent("onFileUploadTaskReceived",[{files:d}],"background")}}attachDiskFiles(e,t,s){this.sendFakeAttachFilesEvent(e,t,s);if(this.mode==="edit"){this.attachDiskFilesInEditMode(e,t,s)}else{this.runAjaxAttachingFilesFromDisk(e,t,s)}}attachDiskFilesInEditMode(e,t,s){const{checkListItemId:i}=e;t.forEach((e=>{const t=e.dataAttributes.ID;e.checkListItemId=i;this.filesToShow.set(t,e);this.filesToAddQueue.removeFile(t);if(this.filesList&&this.filesList.checkListItemId===i){this.filesList.addDiskFile(e.dataAttributes)}const n={nodeId:s.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(i),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(i),attachment:{[t]:t}};this.emitter.emit("addAttachment",[n]);this.emitter.emit("fakeAttachFiles",[n])}))}sendFakeAttachFilesEvent(e,t,s){const{checkListItemId:i}=e;t.forEach((e=>this.filesToAddQueue.addFile(i,e.dataAttributes.ID)));this.emitter.emit("fakeAttachFiles",[{nodeId:s.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(i),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(i)}])}runAjaxAttachingFilesFromDisk(e,t,s){const{entityTypeId:i,entityId:n,checkListItemId:a,attachmentsIds:d}=e;BX.ajax.runAction("tasks.task.checklist.addAttachmentsFromDisk",{data:{checkListItemId:a,[i]:n,filesIds:d}}).then((e=>{if(e.status==="success"){const{attachments:i}=e.data.checkListItem;t.forEach((e=>{const t=e.dataAttributes.ID;if(Object.values(i).includes(`n${t}`)){this.filesToAddQueue.removeFile(t);if(this.filesList&&this.filesList.checkListItemId===a){e.dataAttributes.ID=Object.keys(i).find((e=>i[e]===`n${t}`));this.filesList.addDiskFile(e.dataAttributes)}}}));this.emitter.emit("attachFiles",[{attachments:i,nodeId:s.nodeId,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(a),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(a)}])}}))}onFileUploadStatusChange(e,t,s){if(s.indexOf("taskChecklist-")!==0){return false}switch(e){default:console.log("onFileUploadStatusChange::default event warning!");break;case BX.FileUploadEvents.FILE_CREATED:case BX.FileUploadEvents.FILE_UPLOAD_PROGRESS:case BX.FileUploadEvents.ALL_TASK_COMPLETED:case BX.FileUploadEvents.TASK_TOKEN_DEFINED:case BX.FileUploadEvents.TASK_CREATED:break;case BX.FileUploadEvents.FILE_UPLOAD_START:this.onFileUploadStart(t,s);break;case TaskChecklistUploaderEvents.FILE_SUCCESS_UPLOAD:this.onFileUploadSuccess(t,s);break;case BX.FileUploadEvents.TASK_STARTED_FAILED:case BX.FileUploadEvents.FILE_CREATED_FAILED:case BX.FileUploadEvents.FILE_UPLOAD_FAILED:case BX.FileUploadEvents.TASK_CANCELLED:case BX.FileUploadEvents.TASK_NOT_FOUND:case BX.FileUploadEvents.FILE_READ_ERROR:case TaskChecklistUploaderEvents.FILE_FAIL_UPLOAD:this.onFileUploadError(t,s);break}return true}onFileUploadStart(e,t){const s=e.file.params;const{checkListItemId:i,mode:n}=s.ajaxData;if(!this.checkEvent(s.taskId)||n!==this.mode){return}this.filesToAddQueue.addFile(i,t);if(this.filesList&&this.filesList.checkListItemId===i){this.filesList.addLoadingFile(t,s)}const a={checkListItemId:i,nodeId:i,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(i),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(i)};delete a[this.mode==="edit"?"checkListItemId":"nodeId"];this.emitter.emit("fakeAttachFiles",[a])}handleSuccessUploadInViewMode(e,t){const{file:s}=e;const{checkListItem:i}=e.result;const{attachments:n}=i;const a=i.id;if(this.filesList&&this.filesList.checkListItemId===a){const e=Object.keys(n).find((e=>n[e]===`n${s.id}`));if(e){s.id=e;this.filesList.addRealFile(t,s)}}this.filesToAddQueue.removeFile(t);this.filesStorage.removeFiles([t]);this.emitter.emit("attachFiles",[{checkListItemId:a,nodeId:null,attachments:i.attachments}])}handleSuccessUploadInEditMode(e,t){const{file:s}=e;const{checkListItemId:i}=e.result;if(this.filesList&&this.filesList.checkListItemId===i){this.filesList.addRealFile(t,s)}s.id=String(s.id);this.filesToShow.set(s.id,s);this.filesToAddQueue.removeFile(t);this.filesStorage.removeFiles([t]);const n={nodeId:i,filesToRemove:this.filesToRemoveQueue.getArrayChecklistQueue(i),filesToAdd:this.filesToAddQueue.getArrayChecklistQueue(i),attachment:{[s.id]:s.id}};this.emitter.emit("addAttachment",[n]);this.emitter.emit("fakeAttachFiles",[n])}onFileUploadSuccess(e,t){const s=e.file.extra.params;const{mode:i}=s.ajaxData;if(!this.checkEvent(s.taskId)||i!==this.mode){return}if(i==="edit"){this.handleSuccessUploadInEditMode(e,t)}else{this.handleSuccessUploadInViewMode(e,t)}}onFileUploadError(e,t){this.filesToAddQueue.removeFile(t);this.filesStorage.removeFiles([t])}}s.exports={CheckListTree:a,CheckListController:l}}));
//# sourceMappingURL=extension.map.js