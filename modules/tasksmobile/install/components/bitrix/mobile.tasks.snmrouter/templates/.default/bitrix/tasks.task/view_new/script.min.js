(function(){var e=window.BX;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["detail"]){return}e.namespace("BX.Mobile.Tasks.detail");e.Mobile.Tasks.detail=function(t,s){this.parentConstruct(e.Mobile.Tasks.detail,t);e.merge(this,{sys:{classCode:"detail"},vars:{objectId:e.util.getRandomString()},task:t.taskData,taskEditObj:new e.Mobile.Tasks.edit({taskData:t.taskData,formId:t.formId,setTitle:false}),currentTs:t.currentTs});this.handleInitStack(s,e.Mobile.Tasks.detail,t);app.getPageParams({callback:function(t){if(t&&t["bSetFocusOnCommentsList"]=="YES"){e.ready((function(){var t;if((t=e("task-comments-block"))&&t){var s=e.pos(t);window.scrollTo(0,s["top"])}}))}}})};e.extend(e.Mobile.Tasks.detail,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.detail.prototype,{init:function(){window.app.hidePopupLoader();this.act=e.delegate(this.act,this);this.actExecute=e.delegate(this.actExecute,this);this.actSuccess=e.delegate(this.actSuccess,this);this.actFailure=e.delegate(this.actFailure,this);e.onCustomEvent("onTaskWasLoaded",[this.task]);if(typeof this.task["LOG_ID"]!="undefined"){BXMobileApp.onCustomEvent("onLogEntryRead",{log_id:this.task["LOG_ID"],ts:this.currentTs,bPull:false},true)}BXMobileApp.addCustomEvent("onTaskWasUpdated",e.delegate((function(e,t,s){if(!s){t=e[1];e=e[0]}if(this.task["ID"]==e&&t!==this.taskEditObj.vars["id"]){window.app.showPopupLoader();window.app.reload()}}),this));BXMobileApp.addCustomEvent("onTaskWasRemoved",e.delegate((function(e,t,s){if(!s){e=e[0]}if(this.task["ID"]==e){window.app.closeController({drop:true})}}),this));BXMobileApp.addCustomEvent("onTaskWasPerformed",e.delegate((function(e,t,s){if(!s){s=e[2];t=e[1];e=e[0]}if(this.task["ID"]==e&&t!==this.variable("objectId")){if(s["OPERATION"]==="task.dayplan.timer.start"||s["OPERATION"]==="task.dayplan.timer.stop"||s["OPERATION"]==="task.complete"){this.actSuccess(s["OPERATION"],s,true)}else{this.actSuccess("get",s,false)}}}),this));if(e("favorites"+this.task["ID"])){e.bind(e("favorites"+this.task["ID"]),"click",e.proxy((function(){if(this.task["ACTION"]["ADD_FAVORITE"]){this.act("addFavorite");e.addClass(e("favorites"+this.task["ID"]),"active")}else if(this.task["ACTION"]["DELETE_FAVORITE"]){this.act("deleteFavorite");e.removeClass(e("favorites"+this.task["ID"]),"active")}}),this))}e.MobileUI.addLivefeedLongTapHandler(e("post_inform_wrap_two"),{likeNodeClass:"post-item-informer-like"});e.MobileUI.addLivefeedLongTapHandler(e("task-comments-block"),{likeNodeClass:"post-comment-control-item-like"});this.initEventsForFormInterface()},getDefaultMenu:function(){var t=[{name:e.message("MB_TASKS_TASK_DETAIL_TASK_ADD"),arrowFlag:false,icon:"add",action:e.Mobile.Tasks.createWindow},{name:e.message("MB_TASKS_TASK_DETAIL_TASK_ADD_SUBTASK"),arrowFlag:false,icon:"add",action:e.proxy((function(){e.Mobile.Tasks.createWindow(null,this.task["ID"])}),this)}];var s,a=this.task["ACTION"],i=this.task["ID"];for(var o in this.task["ACTION"]){if(this.task["ACTION"].hasOwnProperty(o)){if(!a[o]){continue}s=(o+"").toUpperCase();if(s=="EDIT"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_EDIT"),icon:"edit",arrowFlag:false,action:function(){var t=e.message("TASK_PATH_TO_EDIT").replace(/#TASK_ID#/gi,i).replace(/#USER_ID#/gi,e.message("USER_ID")).replace(/#SALT#/gi,(new Date).getTime());window.BXMobileApp.PageManager.loadPageModal({url:t,bx24ModernStyle:true,cache:false})}})}else if(s=="REMOVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_REMOVE"),icon:"delete",action:e.proxy((function(){window.app.confirm({title:e.message("MB_TASKS_TASK_REMOVE_CONFIRM_TITLE"),text:e.message("MB_TASKS_TASK_DETAIL_CONFIRM_REMOVE"),buttons:["OK",e.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")],callback:e.proxy((function(e){if(e==1){this.act("delete")}}),this)})}),this)})}else if(s=="START"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_START_TASK"),icon:"play",action:e.proxy((function(){this.act("start")}),this)})}else if(s=="RENEW"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_RENEW_TASK"),icon:"reload",action:e.proxy((function(){this.act("renew")}),this)})}else if(s=="COMPLETE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_CLOSE_TASK"),icon:"finish",action:e.proxy((function(){this.act("complete")}),this)})}else if(s=="DEFER"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_PAUSE_TASK"),icon:"pause",action:e.proxy((function(){this.act("defer")}),this)})}else if(s=="APPROVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_APPROVE_TASK"),icon:"check",action:e.proxy((function(){this.act("approve")}),this)})}else if(s=="DISAPPROVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_REDO_TASK"),icon:"reload",action:e.proxy((function(){this.act("disapprove")}),this)})}else if(s=="DELEGATE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_DELEGATE_TASK"),icon:"finish",action:e.proxy((function(){new window.BXMobileApp.UI.Table({url:e.message("SITE_DIR")+"mobile/index.php?mobile_action=get_user_list",table_settings:{callback:e.proxy((function(e){if(!(e&&e.a_users&&e.a_users[0])){return}this.act("delegate",{userid:e.a_users[0]["ID"].toString()})}),this),markmode:true,multiple:false,return_full_mode:true,skipSpecialChars:true,modal:true,alphabet_index:true,outsection:false,cancelname:e.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")}},"users").show()}),this)})}else if(s=="ADD_FAVORITE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_ADD_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:e.proxy((function(){this.act("addFavorite")}),this)})}else if(s=="DELETE_FAVORITE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_DELETE_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:e.proxy((function(){this.act("deleteFavorite")}),this)})}}}return t},act:function(t,s,a){if(this.task.isBusy){return}if(this.appCtrls&&this.appCtrls.menu){this.appCtrls.menu.hide()}window.app.showPopupLoader();if(a){window.app.BasicAuth({success:e.proxy((function(){e.ajax.runComponentAction("bitrix:tasks.task",t,{mode:"class",data:{taskId:this.task["ID"],parameters:params}}).then(function(e){this.task.isBusy=false;window.app.hidePopupLoader();this.actExecute(t,e)}.bind(this),function(e){this.task.isBusy=false;window.app.hidePopupLoader();this.actFailure()}.bind(this))}),this),failure:this.actFailure})}else{e.ajax.runComponentAction("bitrix:tasks.task",t,{mode:"class",data:{taskId:this.task["ID"],parameters:params},onrequeststart:function(e){this.xhr=e}.bind(this)}).then(function(e){this.task.isBusy=false;window.app.hidePopupLoader();this.actExecute(t,e)}.bind(this),function(e){this.task.isBusy=false;window.app.hidePopupLoader();if(this.xhr&&this.xhr.status&&this.xhr.status===401){this.act(t,s,true)}else if(e.errors&&e.errors.length){this.actError(e.errors)}else{this.actFailure()}}.bind(this))}},actError:function(t){if(t&&t.length>0){for(var s=0;s<t.length;s++){t[s]=t[s]["message"]||t[s]["code"]}window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}},actExecute:function(e,t){window.app.hidePopupLoader();if(t.errors&&t.errors.length){this.actError(t.errors);return}if(e==="delete"){window.BXMobileApp.onCustomEvent("onTaskWasRemoved",[this.task["ID"],this.variable("objectId"),data],true,true);return}window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[this.task["ID"],this.variable("objectId"),data],true,true);this.actSuccess(e,t.data,true)},actSuccess:function(t,s,a){var i,o=false;if(t==="deleteFavorite"){o=true;this.task["ACTION"]["DELETE_FAVORITE"]=false;this.task["ACTION"]["ADD_FAVORITE"]=true;if(e("favorites"+this.task["ID"])){e.removeClass(e("favorites"+this.task["ID"]),"active")}}else if(t==="addFavorite"){o=true;this.task["ACTION"]["DELETE_FAVORITE"]=true;this.task["ACTION"]["ADD_FAVORITE"]=false;if(e("favorites"+this.task["ID"])){e.addClass(e("favorites"+this.task["ID"]),"active")}}else if(t==="delegate"){e.reload()}else if(t==="get"){this.task["ACTION"]={};for(i in s["RESULT"]["CAN"]["ACTION"]){if(s["RESULT"]["CAN"]["ACTION"].hasOwnProperty(i)){this.task["ACTION"][i.toUpperCase()]=s["RESULT"]["CAN"]["ACTION"][i]==="YES"||s["RESULT"]["CAN"]["ACTION"][i]==="true"||s["RESULT"]["CAN"]["ACTION"][i]===true}}o=true;var n=s["RESULT"]["DATA"]["REAL_STATUS"];if(e("bx-task-status-"+this.task["ID"])&&n!=this.task["REAL_STATUS"]){this.task["REAL_STATUS"]=s["RESULT"]["DATA"]["REAL_STATUS"];this.task["STATUS"]=s["RESULT"]["DATA"]["STATUS"];var r=e.Mobile.Tasks.statusMap[n]||"STATE_UNKNOWN";e("bx-task-status-"+this.task["ID"]).innerHTML=e.message("TASKS_STATUS_"+r)}}else if(a===true){this.act("get",s)}if(o){this.resetMenu(this.getDefaultMenu())}},actFailure:function(){window.app.alert({text:e.message("TASKS_LIST_GROUP_ACTION_ERROR1"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})},initEventsForFormInterface:function(){this.formInterface=e.Mobile.Grid.Form.getByFormId(this.option("formId"));if(e.type.isNotEmptyObject(this.formInterface)){this.customizeDefaultView();return}setTimeout(this.initEventsForFormInterface.bind(this),500)},customizeDefaultView:function(){for(var t=0;t<this.formInterface.elements.length;t++){if(this.formInterface.elements[t]["dialogName"]=="DiskFileDialog"){e.addCustomEvent(this.formInterface.elements[t],"onChange",function(t){e.onCustomEvent("onCheckFileBlockVisibility",[t.container,t.agent.queue.items.length])}.bind(this));e.onCustomEvent("onCheckFileBlockVisibility",[this.formInterface.elements[t].container,this.formInterface.elements[t].agent.queue.items.length])}}}});e.ready((function(){var t=function(){if(Application.getApiVersion()>=30){var e=window.BX.MobileUI.TextField.defaultParams.callback;window.BX.MobileUI.TextField.defaultParams.callback=function(t){console.log("arguments task input",arguments);if(t["event"]==="getFocus"){BXMobileApp.Events.postToComponent("onTabSelect",{tab:"commentTab"},"tasks.view")}e.apply(null,arguments)}}window.BX.MobileUI.TextField.show()};if(e.MobileUI.TextField.defaultParams){t()}else{e.addCustomEvent(e.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,t)}document.querySelector("#task-comments-block").style.display="none";var s="taskTab";e.addCustomEvent("onInitialTabLoaded",(function(e){if(e.id==="commentTab"){a(e.id)}}));e.addCustomEvent("onTabSelected",(function(e){a(e.tab.id)}));function a(t){if(t===s)return;s=t;document.querySelectorAll(".bx-edit-tab-inner").forEach((function(e){e.style.display="none"}));document.querySelector("#task-comments-block").style.display="none";document.querySelector("#rating-footer-wrap").style.display="none";document.querySelector("#empty_block").style.display="none";document.querySelector("#empty_text").innerHTML="";switch(t){default:case"taskTab":document.querySelector("#rating-footer-wrap").style.display="block";document.querySelector("#inner_tab_task_base").style.display="block";break;case"commentTab":console.log("commentTab");e.onCustomEvent(window,"OnUCMoreButtonListRecalc",[]);var a=e.findChild(e("post-comments-wrap"),{className:"post-comment-block-new"},true);if(a){document.body.scrollTop=a.offsetTop}else{var o=e.findChild(e("post-comments-wrap"),{className:"post-comment-block"},true);document.body.scrollTop=o?o.offsetTop:0}document.querySelector("#task-comments-block").style.display="block";if(!commentsCount)i(e.message("MB_TASKS_ADD_COMMENT_FIRST"),"task-mobile-no-data-comment ");break;case"checklistTab":document.querySelector("#inner_tab_task_checklist").style.display="block";break;case"filesTab":document.querySelector("#inner_tab_task_files").style.display="block";e.LazyLoad.showImages(true);break}}function i(e,t){console.log("showEmptyBlock");document.querySelector("#empty_block").style.display="block";document.querySelector("#empty_text").innerHTML=e;document.querySelector("#empty_block .task-mobile-no-data").classList.value="task-mobile-no-data "+t}function o(){console.log("hideEmptyBlock");document.querySelector("#empty_block").style.display="none";document.querySelector("#empty_block .task-mobile-no-data").classList.value="task-mobile-no-data ";document.querySelector("#empty_text").innerHTML=""}var n=new URL(location.href).searchParams.get("tabId");if(n==="commentTab"){a(n);return}e.addCustomEvent(window,"OnUCFormBeforeSubmit",o);e.addCustomEvent(window,"OnUCAfterRecordAdd",(function(){console.log("tasks: OnUCAfterRecordAdd");o();setTimeout(r,500)}));e.addCustomEvent(window,"OnUCCommentWasPulled",(function(){console.log("tasks: OnUCCommentWasPulled");o();setTimeout(r,500)}));function r(){document.body.scrollTop=document.body.scrollHeight}}))})();
//# sourceMappingURL=script.map.js