{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Dom, GetWindowInnerSize, GetWindowScrollPos, Reflection} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\nimport {ResultManager} from 'tasks.result';\n\nconst namespace = Reflection.namespace('BX.TasksMobile');\n\nexport default class Comments\n{\n\tstatic get block(): Object\n\t{\n\t\treturn {\n\t\t\tcomments: 'comments',\n\t\t\tstub: 'stub',\n\t\t};\n\t}\n\n\tconstructor(options): void\n\t{\n\t\tthis.userId = options.userId;\n\t\tthis.taskId = options.taskId;\n\t\tthis.guid = options.guid;\n\n\t\tthis.timeout = 0;\n\t\tthis.timeoutSec = 2000;\n\t\tthis.commentsList = null;\n\t\tthis.unreadComments = new Map();\n\t\tthis.commentsToRead = new Map();\n\n\t\tthis.initTextField();\n\t\tthis.initCommentsBlock();\n\t\tthis.initTaskResultManager(options);\n\n\t\tthis.sendEvents(options);\n\t\tthis.bindEvents();\n\t}\n\n\tinitTextField(): void\n\t{\n\t\tif (BX.MobileUI.TextField.defaultParams)\n\t\t{\n\t\t\twindow.BX.MobileUI.TextField.show();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tEventEmitter.subscribe(BX.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS, () => {\n\t\t\t\twindow.BX.MobileUI.TextField.show();\n\t\t\t});\n\t\t}\n\t}\n\n\tinitCommentsBlock(): void\n\t{\n\t\tthis.stub = BX('commentsStub');\n\t\tthis.commentsBlock = BX('task-comments-block');\n\n\t\tconst firstComment = BX('post-comments-wrap').querySelector('.post-comment-block');\n\t\tthis.resolveVisibility(firstComment ? Comments.block.comments : Comments.block.stub);\n\t}\n\n\tresolveVisibility(visibleBlock = Comments.block.stub): void\n\t{\n\t\tconst hiddenClass = '--hidden';\n\n\t\tif (visibleBlock === Comments.block.stub)\n\t\t{\n\t\t\tif (Dom.hasClass(this.stub, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.removeClass(this.stub, hiddenClass);\n\t\t\t}\n\t\t\tif (!Dom.hasClass(this.commentsBlock, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.addClass(this.commentsBlock, hiddenClass);\n\t\t\t}\n\t\t}\n\t\telse if (visibleBlock === Comments.block.comments)\n\t\t{\n\t\t\tif (Dom.hasClass(this.commentsBlock, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.removeClass(this.commentsBlock, hiddenClass);\n\t\t\t}\n\t\t\tif (!Dom.hasClass(this.stub, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.addClass(this.stub, hiddenClass);\n\t\t\t}\n\t\t}\n\t}\n\n\tinitTaskResultManager({resultComments, isClosed})\n\t{\n\t\tResultManager.getInstance().initResult({\n\t\t\tcontext: 'task',\n\t\t\ttaskId: this.taskId,\n\t\t\tcomments: resultComments,\n\t\t\tisClosed,\n\t\t});\n\t}\n\n\tsendEvents(options): void\n\t{\n\t\tif (options.logId)\n\t\t{\n\t\t\tconst params = {\n\t\t\t\tlog_id: options.logId,\n\t\t\t\tts: options.currentTs,\n\t\t\t\tbPull: false,\n\t\t\t};\n\t\t\tBXMobileApp.onCustomEvent('onLogEntryRead', params, true);\n\t\t}\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('OnUCHasBeenInitialized', (event) => {\n\t\t\tconst [xmlId, list] = event.getData();\n\t\t\tif (xmlId === `TASK_${this.taskId}`)\n\t\t\t{\n\t\t\t\tthis.commentsList = list;\n\t\t\t\tthis.commentsList.canCheckVisibleComments = false;\n\t\t\t\tthis.unreadComments = new Map(this.commentsList.unreadComments);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('onUCFormSubmit', () => this.resolveVisibility(Comments.block.comments));\n\n\t\tEventEmitter.subscribe('OnUCCommentWasPulled', (event) => {\n\t\t\tconst [id, data] = event.getData();\n\t\t\tif (id[0] === `TASK_${this.taskId}`)\n\t\t\t{\n\t\t\t\tconst author = data.messageFields.AUTHOR;\n\t\t\t\tif (Number(author['ID']) !== Number(this.userId))\n\t\t\t\t{\n\t\t\t\t\tthis.unreadComments.set(id[1], new Date());\n\t\t\t\t}\n\t\t\t\tthis.resolveVisibility(Comments.block.comments);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('OnUCommentWasDeleted', (event) => {\n\t\t\tconst [xmlId, id] = event.getData();\n\t\t\tconst commentId = id[1];\n\t\t\tif (xmlId === `TASK_${this.taskId}`)\n\t\t\t{\n\t\t\t\tif (this.commentsList.getCommentsCount() <= 0)\n\t\t\t\t{\n\t\t\t\t\tthis.resolveVisibility(Comments.block.stub);\n\t\t\t\t}\n\t\t\t\tthis.unreadComments.delete(commentId);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('OnUCCommentWasRead', (event) => {\n\t\t\tconst [xmlId, id] = event.getData();\n\t\t\tconst commentId = id[1];\n\t\t\tif (xmlId === `TASK_${this.taskId}` && this.unreadComments.has(commentId))\n\t\t\t{\n\t\t\t\tthis.commentsToRead.set(commentId, this.unreadComments.get(commentId));\n\t\t\t\tthis.unreadComments.delete(commentId);\n\n\t\t\t\tthis.sendOnCommentsReadEvent(this.unreadComments.size);\n\n\t\t\t\tif (this.timeout <= 0)\n\t\t\t\t{\n\t\t\t\t\tthis.timeout = setTimeout(() => this.readComments(), this.timeoutSec);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tBXMobileApp.addCustomEvent('onPull-tasks', () => {});\n\n\t\tBXMobileApp.addCustomEvent('tasks.task.tabs:onTabSelected', (event) => {\n\t\t\tif (\n\t\t\t\tevent.guid === this.guid\n\t\t\t\t&& this.commentsList\n\t\t\t)\n\t\t\t{\n\t\t\t\tthis.commentsList.canCheckVisibleComments = (event.tab === 'tasks.task.comments');\n\n\t\t\t\tif (event.tab === 'tasks.task.comments')\n\t\t\t\t{\n\t\t\t\t\tconst scroll = GetWindowScrollPos();\n\t\t\t\t\tconst position = {\n\t\t\t\t\t\ttop: scroll.scrollTop,\n\t\t\t\t\t\tbottom: scroll.scrollTop + GetWindowInnerSize().innerHeight,\n\t\t\t\t\t};\n\t\t\t\t\tthis.commentsList.checkVisibleComments(position);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tBX.MobileUI.addLivefeedLongTapHandler(this.commentsBlock, {\n\t\t\tlikeNodeClass: 'post-comment-control-item-like',\n\t\t});\n\t}\n\n\tsendOnCommentsReadEvent(newCommentsCount: number = 0): void\n\t{\n\t\tconst params = {\n\t\t\tnewCommentsCount,\n\t\t\ttaskId: this.taskId,\n\t\t};\n\t\tBXMobileApp.Events.postToComponent('tasks.task.comments:onCommentsRead', params);\n\t\tBXMobileApp.Events.postToComponent('task.view.onCommentsRead', params, 'tasks.list');\n\t}\n\n\treadComments(): void\n\t{\n\t\tthis.timeout = 0;\n\t\tthis.commentsToRead.clear();\n\n\t\tvoid BX.ajax.runAction('tasks.task.view.update', {data: {taskId: this.taskId}});\n\t}\n}\n\nnamespace.Comments = Comments;"],"names":["namespace","Reflection","Comments","comments","stub","options","userId","taskId","guid","timeout","timeoutSec","commentsList","unreadComments","Map","commentsToRead","initTextField","initCommentsBlock","initTaskResultManager","sendEvents","bindEvents","BX","MobileUI","TextField","defaultParams","window","show","EventEmitter","subscribe","events","MOBILE_UI_TEXT_FIELD_SET_PARAMS","commentsBlock","firstComment","querySelector","resolveVisibility","block","visibleBlock","hiddenClass","Dom","hasClass","removeClass","addClass","resultComments","isClosed","ResultManager","getInstance","initResult","context","logId","params","log_id","ts","currentTs","bPull","BXMobileApp","onCustomEvent","event","getData","xmlId","list","canCheckVisibleComments","id","data","author","messageFields","AUTHOR","Number","set","Date","commentId","getCommentsCount","has","get","sendOnCommentsReadEvent","size","setTimeout","readComments","addCustomEvent","tab","scroll","GetWindowScrollPos","position","top","scrollTop","bottom","GetWindowInnerSize","innerHeight","checkVisibleComments","addLivefeedLongTapHandler","likeNodeClass","newCommentsCount","Events","postToComponent","clear","ajax","runAction"],"mappings":"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"}