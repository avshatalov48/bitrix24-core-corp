(function(e,t,s,n){"use strict";var i=t.Reflection.namespace("BX.TasksMobile");var o=function(){babelHelpers.createClass(e,null,[{key:"block",get:function e(){return{comments:"comments",stub:"stub"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.taskId=t.taskId;this.guid=t.guid;this.canReadCommentsOnInit=true;this.timeout=0;this.timeoutSec=2e3;this.commentsList=null;this.unreadComments=new Map;this.commentsToRead=new Map;this.initTextField();this.initCommentsBlock();this.initTaskResultManager(t);this.sendEvents(t);this.bindEvents()}babelHelpers.createClass(e,[{key:"initTextField",value:function e(){if(BX.MobileUI.TextField.defaultParams){window.BX.MobileUI.TextField.show()}else{s.EventEmitter.subscribe(BX.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,(function(){return window.BX.MobileUI.TextField.show()}))}}},{key:"initCommentsBlock",value:function t(){this.stub=BX("commentsStub");this.commentsBlock=BX("task-comments-block");var s=BX("post-comments-wrap").querySelector(".post-comment-block");this.resolveVisibility(s?e.block.comments:e.block.stub)}},{key:"resolveVisibility",value:function s(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:e.block.stub;var i="--hidden";if(n===e.block.stub){if(t.Dom.hasClass(this.stub,i)){t.Dom.removeClass(this.stub,i)}if(!t.Dom.hasClass(this.commentsBlock,i)){t.Dom.addClass(this.commentsBlock,i)}}else if(n===e.block.comments){if(t.Dom.hasClass(this.commentsBlock,i)){t.Dom.removeClass(this.commentsBlock,i)}if(!t.Dom.hasClass(this.stub,i)){t.Dom.addClass(this.stub,i)}}}},{key:"initTaskResultManager",value:function e(t){var s=t.resultComments,i=t.isClosed;n.ResultManager.getInstance().initResult({context:"task",taskId:this.taskId,comments:s,isClosed:i})}},{key:"sendEvents",value:function e(t){if(t.logId){var s={log_id:t.logId,ts:t.currentTs,bPull:false};BXMobileApp.onCustomEvent("onLogEntryRead",s,true)}}},{key:"bindEvents",value:function n(){var i=this;s.EventEmitter.subscribe("OnUCHasBeenInitialized",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],o=s[1];if(n==="TASK_".concat(i.taskId)){i.commentsList=o;i.commentsList.canCheckVisibleComments=false;i.unreadComments=new Map(i.commentsList.unreadComments)}}));s.EventEmitter.subscribe("onUCFormSubmit",(function(){return i.resolveVisibility(e.block.comments)}));s.EventEmitter.subscribe("OnUCCommentWasPulled",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),o=n[0],a=n[1];if(o[0]==="TASK_".concat(i.taskId)){var m=a.messageFields.AUTHOR;if(Number(m["ID"])!==Number(i.userId)){i.unreadComments.set(o[1],new Date)}i.resolveVisibility(e.block.comments)}}));s.EventEmitter.subscribe("OnUCommentWasDeleted",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),o=n[0],a=n[1];var m=a[1];if(o==="TASK_".concat(i.taskId)){if(i.commentsList.getCommentsCount()<=0){i.resolveVisibility(e.block.stub)}i.unreadComments["delete"](m)}}));s.EventEmitter.subscribe("OnUCCommentWasRead",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],o=s[1];var a=o[1];if(n==="TASK_".concat(i.taskId)&&i.unreadComments.has(a)){i.commentsToRead.set(a,i.unreadComments.get(a));i.unreadComments["delete"](a);i.sendOnCommentsReadEvent(i.unreadComments.size);if(i.timeout<=0){i.timeout=setTimeout((function(){return i.readComments()}),i.timeoutSec)}}}));BXMobileApp.addCustomEvent("onPull-tasks",(function(){}));BXMobileApp.addCustomEvent("tasks.task.tabs:onTabSelected",(function(e){if(e.guid===i.guid&&i.commentsList){var s=e.tab==="tasks.task.comments";i.commentsList.canCheckVisibleComments=s;if(s){var n=t.GetWindowScrollPos();var o={top:n.scrollTop,bottom:n.scrollTop+t.GetWindowInnerSize().innerHeight};i.commentsList.checkVisibleComments(o);if(i.canReadCommentsOnInit){i.canReadCommentsOnInit=false;i.readComments()}}}}));BX.MobileUI.addLivefeedLongTapHandler(this.commentsBlock,{likeNodeClass:"post-comment-control-item-like"})}},{key:"sendOnCommentsReadEvent",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var s={newCommentsCount:t,taskId:this.taskId};BXMobileApp.Events.postToComponent("tasks.task.comments:onCommentsRead",s);BXMobileApp.Events.postToComponent("task.view.onCommentsRead",s,"tasks.list")}},{key:"readComments",value:function e(){this.timeout=0;this.commentsToRead.clear();void BX.ajax.runAction("tasks.task.view.update",{data:{taskId:this.taskId,parameters:{IS_REAL_VIEW:"Y"}}})}}]);return e}();i.Comments=o;e.default=o})(this.window=this.window||{},BX,BX.Event,BX.Tasks);
//# sourceMappingURL=script.map.js