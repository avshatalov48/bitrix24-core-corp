(function(e,t,s,n){"use strict";var o=t.Reflection.namespace("BX.TasksMobile");var i=function(){babelHelpers.createClass(e,null,[{key:"block",get:function e(){return{comments:"comments",stub:"stub"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.taskId=t.taskId;this.guid=t.guid;this.timeout=0;this.timeoutSec=2e3;this.commentsList=null;this.unreadComments=new Map;this.commentsToRead=new Map;this.initTextField();this.initCommentsBlock();this.initTaskResultManager(t);this.sendEvents(t);this.bindEvents()}babelHelpers.createClass(e,[{key:"initTextField",value:function e(){if(BX.MobileUI.TextField.defaultParams){window.BX.MobileUI.TextField.show()}else{s.EventEmitter.subscribe(BX.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,(function(){window.BX.MobileUI.TextField.show()}))}}},{key:"initCommentsBlock",value:function t(){this.stub=BX("commentsStub");this.commentsBlock=BX("task-comments-block");var s=BX("post-comments-wrap").querySelector(".post-comment-block");this.resolveVisibility(s?e.block.comments:e.block.stub)}},{key:"resolveVisibility",value:function s(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:e.block.stub;var o="--hidden";if(n===e.block.stub){if(t.Dom.hasClass(this.stub,o)){t.Dom.removeClass(this.stub,o)}if(!t.Dom.hasClass(this.commentsBlock,o)){t.Dom.addClass(this.commentsBlock,o)}}else if(n===e.block.comments){if(t.Dom.hasClass(this.commentsBlock,o)){t.Dom.removeClass(this.commentsBlock,o)}if(!t.Dom.hasClass(this.stub,o)){t.Dom.addClass(this.stub,o)}}}},{key:"initTaskResultManager",value:function e(t){var s=t.resultComments,o=t.isClosed;n.ResultManager.getInstance().initResult({context:"task",taskId:this.taskId,comments:s,isClosed:o})}},{key:"sendEvents",value:function e(t){if(t.logId){var s={log_id:t.logId,ts:t.currentTs,bPull:false};BXMobileApp.onCustomEvent("onLogEntryRead",s,true)}}},{key:"bindEvents",value:function n(){var o=this;s.EventEmitter.subscribe("OnUCHasBeenInitialized",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],i=s[1];if(n==="TASK_".concat(o.taskId)){o.commentsList=i;o.commentsList.canCheckVisibleComments=false;o.unreadComments=new Map(o.commentsList.unreadComments)}}));s.EventEmitter.subscribe("onUCFormSubmit",(function(){return o.resolveVisibility(e.block.comments)}));s.EventEmitter.subscribe("OnUCCommentWasPulled",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),i=n[0],a=n[1];if(i[0]==="TASK_".concat(o.taskId)){var m=a.messageFields.AUTHOR;if(Number(m["ID"])!==Number(o.userId)){o.unreadComments.set(i[1],new Date)}o.resolveVisibility(e.block.comments)}}));s.EventEmitter.subscribe("OnUCommentWasDeleted",(function(t){var s=t.getData(),n=babelHelpers.slicedToArray(s,2),i=n[0],a=n[1];var m=a[1];if(i==="TASK_".concat(o.taskId)){if(o.commentsList.getCommentsCount()<=0){o.resolveVisibility(e.block.stub)}o.unreadComments["delete"](m)}}));s.EventEmitter.subscribe("OnUCCommentWasRead",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),n=s[0],i=s[1];var a=i[1];if(n==="TASK_".concat(o.taskId)&&o.unreadComments.has(a)){o.commentsToRead.set(a,o.unreadComments.get(a));o.unreadComments["delete"](a);o.sendOnCommentsReadEvent(o.unreadComments.size);if(o.timeout<=0){o.timeout=setTimeout((function(){return o.readComments()}),o.timeoutSec)}}}));BXMobileApp.addCustomEvent("onPull-tasks",(function(){}));BXMobileApp.addCustomEvent("tasks.task.tabs:onTabSelected",(function(e){if(e.guid===o.guid&&o.commentsList){o.commentsList.canCheckVisibleComments=e.tab==="tasks.task.comments";if(e.tab==="tasks.task.comments"){var s=t.GetWindowScrollPos();var n={top:s.scrollTop,bottom:s.scrollTop+t.GetWindowInnerSize().innerHeight};o.commentsList.checkVisibleComments(n)}}}));BX.MobileUI.addLivefeedLongTapHandler(this.commentsBlock,{likeNodeClass:"post-comment-control-item-like"})}},{key:"sendOnCommentsReadEvent",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var s={newCommentsCount:t,taskId:this.taskId};BXMobileApp.Events.postToComponent("tasks.task.comments:onCommentsRead",s);BXMobileApp.Events.postToComponent("task.view.onCommentsRead",s,"tasks.list")}},{key:"readComments",value:function e(){this.timeout=0;this.commentsToRead.clear();void BX.ajax.runAction("tasks.task.view.update",{data:{taskId:this.taskId}})}}]);return e}();o.Comments=i;e.default=i})(this.window=this.window||{},BX,BX.Event,BX.Tasks);
//# sourceMappingURL=script.map.js