{"version":3,"file":"search.bundle.js","sources":["../src/search.js"],"sourcesContent":["import { Type, Tag, Loc, Event, Dom } from 'main.core';\nimport { Util } from 'calendar.util';\nimport { EventEmitter } from 'main.core.events';\n\nexport class Search\n{\n\tconstructor(filterId, counters = '')\n\t{\n\t\tthis.BX = BX; // for calendar in slider\n\t\tthis.filterId = filterId;\n\t\tthis.minSearchStringLength = 2;\n\t\t\n\t\tif (counters)\n\t\t{\n\t\t\tthis.counters = [\n\t\t\t\t{\n\t\t\t\t\tid: 'invitation',\n\t\t\t\t\tclassName: 'calendar-counter-invitation',\n\t\t\t\t\tpluralMessageId: 'EC_COUNTER_INVITATION_PLURAL_',\n\t\t\t\t\tvalue: counters.invitation || 0\n\t\t\t\t}\n\t\t\t];\n\t\t}\n\t\t\n\t\tthis.filter = this.BX.Main.filterManager.getById(this.filterId);\n\t\tif (this.filter)\n\t\t{\n\t\t\tthis.filterApi = this.filter.getApi();\n\t\t\tthis.applyFilterBinded = this.applyFilter.bind(this);\n\t\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.applyFilterBinded);\n\t\t}\n\t}\n\t\n\tgetFilter()\n\t{\n\t\treturn this.filter;\n\t}\n\t\n\tupdateCounters()\n\t{\n\t\tthis.showCounters = false;\n\t\tconst calendarContext = Util.getCalendarContext();\n\t\t\n\t\tthis.BX.cleanNode(calendarContext.countersCont);\n\t\tthis.countersWrap = Tag.render`<div class=\"calendar-counter-title\"></div>`;\n\t\tDom.append(this.countersWrap, calendarContext.countersCont);\n\t\t\n\t\tfor (const counter of this.counters)\n\t\t{\n\t\t\tif (counter && counter.value > 0)\n\t\t\t{\n\t\t\t\tthis.showCounters = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (this.showCounters)\n\t\t{\n\t\t\tthis.countersPage = Tag.render`<span class=\"calendar-counter-page-name\">${Loc.getMessage('EC_COUNTER_TOTAL')}</span>`\n\t\t\tDom.append(this.countersPage, this.countersWrap);\n\t\t\t\n\t\t\tfor (const counter of this.counters)\n\t\t\t{\n\t\t\t\tif (counter && counter.value > 0)\n\t\t\t\t{\n\t\t\t\t\tconst pluralNumber = Loc.getPluralForm(counter.value);\n\t\t\t\t\tthis.countersContainer = Tag.render`\n\t\t\t\t\t<span class=\"calendar-counter-container ${counter.className}\" data-bx-counter=\"${counter.id}\">\n\t\t\t\t\t\t<span class=\"calendar-counter-inner\">\n\t\t\t\t\t\t\t<span class=\"calendar-counter-number\">${counter.value}</span>\n\t\t\t\t\t\t\t<span class=\"calendar-counter-text\">\n\t\t\t\t\t\t\t\t ${Loc.getMessage(counter.pluralMessageId + pluralNumber)}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>`;\n\t\t\t\t\tDom.append(this.countersContainer, this.countersWrap);\n\t\t\t\t\t\n\t\t\t\t\tEvent.bind(this.countersContainer, 'click', () => {\n\t\t\t\t\t\tthis.applyCounterEntries(counter.id)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\telse\n\t\t{\n\t\t\tthis.countersWrap.innerHTML = Loc.getMessage('EC_NO_COUNTERS');\n\t\t}\n\t}\n\t\n\tsetCountersValue(counters)\n\t{\n\t\tif (Type.isPlainObject(counters))\n\t\t{\n\t\t\tfor (const counter of this.counters)\n\t\t\t{\n\t\t\t\tif (!Type.isUndefined(counters[counter.id]))\n\t\t\t\t{\n\t\t\t\t\tcounter.value = counters[counter.id] || 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.updateCounters();\n\t\t}\n\t}\n\t\n\tdisplaySearchResult(response)\n\t{\n\t\tconst calendarContext = Util.getCalendarContext();\n\t\tconst entries = [];\n\t\t\n\t\tfor (const entry of response.entries)\n\t\t{\n\t\t\tentries.push(new window.BXEventCalendar.Entry(calendarContext, entry));\n\t\t}\n\t\t\n\t\tcalendarContext.getView().displayResult(entries);\n\t\t\n\t\tif (response.counters)\n\t\t{\n\t\t\tthis.setCountersValue(response.counters);\n\t\t}\n\t}\n\t\n\tapplyCounterEntries(counterId)\n\t{\n\t\tif (counterId === 'invitation')\n\t\t{\n\t\t\tthis.filterApi.setFilter({\n\t\t\t\tpreset_id: \"filter_calendar_meeting_status_q\"\n\t\t\t});\n\t\t}\n\t}\n\t\n\tapplyFilter(id, data, ctx, promise, params)\n\t{\n\t\tif (params)\n\t\t{\n\t\t\tparams.autoResolve = false;\n\t\t}\n\t\tthis.applyFilterHandler(promise)\n\t\t.then(() => {});\n\t}\n\t\n\tapplyFilterHandler(promise)\n\t{\n\t\treturn new Promise(resolve => {\n\t\t\tconst calendarContext = Util.getCalendarContext();\n\t\t\t\n\t\t\tif (this.isFilterEmpty())\n\t\t\t{\n\t\t\t\tif (calendarContext.getView().resetFilterMode)\n\t\t\t\t{\n\t\t\t\t\tcalendarContext.getView().resetFilterMode({resetSearchFilter: false});\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (promise)\n\t\t\t\t{\n\t\t\t\t\tpromise.fulfill();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcalendarContext.setView('list', {animation: false});\n\t\t\t\tcalendarContext.getView().applyFilterMode();\n\t\t\t\t\n\t\t\t\tBX.ajax.runAction('calendar.api.calendarajax.getFilterData', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\townerId: calendarContext.util.config.ownerId,\n\t\t\t\t\t\tuserId: calendarContext.util.config.userId,\n\t\t\t\t\t\ttype: calendarContext.util.config.type,\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(\n\t\t\t\t\t(response) => {\n\t\t\t\t\t\tif (response.data.entries)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!calendarContext.getView().filterMode)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcalendarContext.getView().applyFilterMode();\n\t\t\t\t\t\t\t\tthis.displaySearchResult(response.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.displaySearchResult(response.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (promise)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpromise.fulfill();\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tresolve(response.data);\n\t\t\t\t\t},\n\t\t\t\t\t(response) => {\n\t\t\t\t\t\tresolve(response.data);\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t})\n\t}\n\t\n\tisFilterEmpty()\n\t{\n\t\tconst searchField = this.filter.getSearch();\n\t\treturn !searchField.getLastSquare()\n\t\t\t&& (!searchField.getSearchString()\n\t\t\t|| searchField.getSearchString().length < this.minSearchStringLength\n\t\t);\n\t}\n\t\n\tresetFilter()\n\t{\n\t\tthis.filter.resetFilter();\n\t}\n}"],"names":["Search","constructor","filterId","counters","BX","minSearchStringLength","id","className","pluralMessageId","value","invitation","filter","Main","filterManager","getById","filterApi","getApi","applyFilterBinded","applyFilter","bind","EventEmitter","subscribe","getFilter","updateCounters","showCounters","calendarContext","Util","getCalendarContext","cleanNode","countersCont","countersWrap","Tag","render","Dom","append","counter","countersPage","Loc","getMessage","pluralNumber","getPluralForm","countersContainer","Event","applyCounterEntries","innerHTML","setCountersValue","Type","isPlainObject","isUndefined","displaySearchResult","response","entries","entry","push","window","BXEventCalendar","Entry","getView","displayResult","counterId","setFilter","preset_id","data","ctx","promise","params","autoResolve","applyFilterHandler","then","Promise","resolve","isFilterEmpty","resetFilterMode","resetSearchFilter","fulfill","setView","animation","applyFilterMode","ajax","runAction","ownerId","util","config","userId","type","filterMode","searchField","getSearch","getLastSquare","getSearchString","length","resetFilter"],"mappings":"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"}