{"version":3,"file":"search.bundle.js","sources":["../src/search.js"],"sourcesContent":["import { Type, Tag, Loc, Event, Dom } from 'main.core';\nimport { Util } from 'calendar.util';\nimport { EventEmitter } from 'main.core.events';\n\nexport class Search\n{\n\tconstructor(filterId, counters = '')\n\t{\n\t\tthis.BX = BX; // for calendar in slider\n\t\tthis.filterId = filterId;\n\t\tthis.minSearchStringLength = 2;\n\t\t\n\t\tif (counters)\n\t\t{\n\t\t\tthis.counters = [\n\t\t\t\t{\n\t\t\t\t\tid: 'invitation',\n\t\t\t\t\tclassName: 'calendar-counter-invitation',\n\t\t\t\t\tpluralMessageId: 'EC_COUNTER_INVITATION_PLURAL_',\n\t\t\t\t\tvalue: counters.invitation || 0\n\t\t\t\t}\n\t\t\t];\n\t\t}\n\t\t\n\t\tthis.filter = this.BX.Main.filterManager.getById(this.filterId);\n\t\tif (this.filter)\n\t\t{\n\t\t\tthis.filterApi = this.filter.getApi();\n\t\t\tthis.applyFilterBinded = this.applyFilter.bind(this);\n\t\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.applyFilterBinded);\n\t\t}\n\t}\n\t\n\tgetFilter()\n\t{\n\t\treturn this.filter;\n\t}\n\t\n\tupdateCounters()\n\t{\n\t\tthis.showCounters = false;\n\t\tconst calendarContext = Util.getCalendarContext();\n\t\t\n\t\tthis.BX.cleanNode(calendarContext.countersCont);\n\t\tthis.countersWrap = Tag.render`<div class=\"calendar-counter-title\"></div>`;\n\t\tDom.append(this.countersWrap, calendarContext.countersCont);\n\t\t\n\t\tfor (const counter of this.counters)\n\t\t{\n\t\t\tif (counter && counter.value > 0)\n\t\t\t{\n\t\t\t\tthis.showCounters = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (this.showCounters)\n\t\t{\n\t\t\tthis.countersPage = Tag.render`<span class=\"calendar-counter-page-name\">${Loc.getMessage('EC_COUNTER_TOTAL')}</span>`\n\t\t\tDom.append(this.countersPage, this.countersWrap);\n\t\t\t\n\t\t\tfor (const counter of this.counters)\n\t\t\t{\n\t\t\t\tif (counter && counter.value > 0)\n\t\t\t\t{\n\t\t\t\t\tconst pluralNumber = Loc.getPluralForm(counter.value);\n\t\t\t\t\tthis.countersContainer = Tag.render`\n\t\t\t\t\t<span class=\"calendar-counter-container ${counter.className}\" data-bx-counter=\"${counter.id}\">\n\t\t\t\t\t\t<span class=\"calendar-counter-inner\">\n\t\t\t\t\t\t\t<span class=\"calendar-counter-number\">${counter.value}</span>\n\t\t\t\t\t\t\t<span class=\"calendar-counter-text\">\n\t\t\t\t\t\t\t\t ${Loc.getMessage(counter.pluralMessageId + pluralNumber)}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>`;\n\t\t\t\t\tDom.append(this.countersContainer, this.countersWrap);\n\t\t\t\t\t\n\t\t\t\t\tEvent.bind(this.countersContainer, 'click', () => {\n\t\t\t\t\t\tthis.applyCounterEntries(counter.id)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\telse\n\t\t{\n\t\t\tthis.countersWrap.innerHTML = Loc.getMessage('EC_NO_COUNTERS');\n\t\t}\n\t}\n\t\n\tsetCountersValue(counters)\n\t{\n\t\tif (Type.isPlainObject(counters))\n\t\t{\n\t\t\tfor (const counter of this.counters)\n\t\t\t{\n\t\t\t\tif (!Type.isUndefined(counters[counter.id]))\n\t\t\t\t{\n\t\t\t\t\tcounter.value = counters[counter.id] || 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.updateCounters();\n\t\t}\n\t}\n\t\n\tdisplaySearchResult(response)\n\t{\n\t\tconst calendarContext = Util.getCalendarContext();\n\t\tconst entries = [];\n\t\t\n\t\tfor (const entry of response.entries)\n\t\t{\n\t\t\tentries.push(new window.BXEventCalendar.Entry(calendarContext, entry));\n\t\t}\n\t\t\n\t\tcalendarContext.getView().displayResult(entries);\n\t\t\n\t\tif (response.counters)\n\t\t{\n\t\t\tthis.setCountersValue(response.counters);\n\t\t}\n\t}\n\t\n\tapplyCounterEntries(counterId)\n\t{\n\t\tif (counterId === 'invitation')\n\t\t{\n\t\t\tthis.filterApi.setFilter({\n\t\t\t\tpreset_id: \"filter_calendar_meeting_status_q\"\n\t\t\t});\n\t\t}\n\t}\n\t\n\tapplyFilter(id, data, ctx, promise, params)\n\t{\n\t\tif (params)\n\t\t{\n\t\t\tparams.autoResolve = false;\n\t\t}\n\t\tthis.applyFilterHandler(promise)\n\t\t.then(() => {});\n\t}\n\t\n\tapplyFilterHandler(promise)\n\t{\n\t\treturn new Promise(resolve => {\n\t\t\tconst calendarContext = Util.getCalendarContext();\n\t\t\t\n\t\t\tif (this.isFilterEmpty())\n\t\t\t{\n\t\t\t\tif (calendarContext.getView().resetFilterMode)\n\t\t\t\t{\n\t\t\t\t\tcalendarContext.getView().resetFilterMode({resetSearchFilter: false});\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (promise)\n\t\t\t\t{\n\t\t\t\t\tpromise.fulfill();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcalendarContext.setView('list', {animation: false});\n\t\t\t\tcalendarContext.getView().applyFilterMode();\n\t\t\t\t\n\t\t\t\tBX.ajax.runAction('calendar.api.calendarajax.getFilterData', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\townerId: calendarContext.util.config.ownerId,\n\t\t\t\t\t\tuserId: calendarContext.util.config.userId,\n\t\t\t\t\t\ttype: calendarContext.util.config.type,\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(\n\t\t\t\t\t(response) => {\n\t\t\t\t\t\tif (response.data.entries)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!calendarContext.getView().filterMode)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcalendarContext.getView().applyFilterMode();\n\t\t\t\t\t\t\t\tthis.displaySearchResult(response.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.displaySearchResult(response.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (promise)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpromise.fulfill();\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tresolve(response.data);\n\t\t\t\t\t},\n\t\t\t\t\t(response) => {\n\t\t\t\t\t\tresolve(response.data);\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t})\n\t}\n\t\n\tisFilterEmpty()\n\t{\n\t\tconst searchField = this.filter.getSearch();\n\t\treturn !searchField.getLastSquare()\n\t\t\t&& (!searchField.getSearchString()\n\t\t\t|| searchField.getSearchString().length < this.minSearchStringLength\n\t\t);\n\t}\n\t\n\tresetFilter()\n\t{\n\t\tthis.filter.resetFilter();\n\t}\n}"],"names":["Search","filterId","counters","BX","minSearchStringLength","id","className","pluralMessageId","value","invitation","filter","Main","filterManager","getById","filterApi","getApi","applyFilterBinded","applyFilter","bind","EventEmitter","subscribe","showCounters","calendarContext","Util","getCalendarContext","cleanNode","countersCont","countersWrap","Tag","render","Dom","append","counter","countersPage","Loc","getMessage","pluralNumber","getPluralForm","countersContainer","Event","applyCounterEntries","innerHTML","Type","isPlainObject","isUndefined","updateCounters","response","entries","entry","push","window","BXEventCalendar","Entry","getView","displayResult","setCountersValue","counterId","setFilter","preset_id","data","ctx","promise","params","autoResolve","applyFilterHandler","then","Promise","resolve","isFilterEmpty","resetFilterMode","resetSearchFilter","fulfill","setView","animation","applyFilterMode","ajax","runAction","ownerId","util","config","userId","type","filterMode","displaySearchResult","searchField","getSearch","getLastSquare","getSearchString","length","resetFilter"],"mappings":"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"}