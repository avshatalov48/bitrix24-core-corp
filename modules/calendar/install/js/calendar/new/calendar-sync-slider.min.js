(function(window){function SyncSlider(e){this.calendar=e.calendar;this.id=this.calendar.id+"_sync";this.zIndex=e.zIndex||1e3;this.sliderId="calendar:sync-slider";this.SLIDER_WIDTH=500;this.SLIDER_DURATION=80;this.DOM={button:e.button};this.config=this.calendar.util.config;this.syncInfo=this.config.syncInfo;if(this.DOM.button){BX.bind(this.DOM.button,"click",BX.proxy(this.show,this))}}SyncSlider.prototype={show:function(){this.calendar.util.doBxContextFix();this.init();BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.create,this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION,events:{onClose:BX.proxy(this.hide,this),onCloseComplete:BX.proxy(this.destroy,this)}});this.calendar.disableKeyHandler()},close:function(){BX.SidePanel.Instance.close()},hide:function(e){if(e&&e.getSliderPage&&e.getSliderPage().getUrl()===this.sliderId){if(this.denyClose){e.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this))}}},destroy:function(e){if(e&&e.getSliderPage&&e.getSliderPage().getUrl()===this.sliderId){BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.SidePanel.Instance.destroy(this.sliderId);this.calendar.enableKeyHandler();this.calendar.util.restoreBxContextFix()}},init:function(){this.syncList=[{id:"google",label:BX.message("EC_CAL_SYNC_GOOGLE"),active:!!this.syncInfo.google.active,connected:!!this.syncInfo.google.connected,syncDate:this.syncInfo.google.syncDate,connectHandler:BX.delegate(function(e){BX.util.popup(this.config.googleCalDavStatus.authLink,500,600);return BX.PreventDefault(e||window.event)},this),disconnectHandler:BX.delegate(function(e){this.disconnectGoogle(e);return BX.PreventDefault(e||window.event)},this)},{id:"macosx",label:BX.message("EC_CAL_SYNC_MAC"),active:!!this.syncInfo.macosx.active,connected:!!this.syncInfo.macosx.connected,syncDate:this.syncInfo.macosx.syncDate,connectHandler:BX.delegate(function(e){this.connectMacOSX();return BX.PreventDefault(e||window.event)},this),disconnectHandler:BX.delegate(function(e){this.disconnectMacOSX();return BX.PreventDefault(e||window.event)},this)},{id:"iphone",label:BX.message("EC_CAL_SYNC_IPHONE"),active:!!this.syncInfo.iphone.active,connected:!!this.syncInfo.iphone.connected,syncDate:this.syncInfo.iphone.syncDate,connectHandler:BX.delegate(function(e){this.connectIphone();return BX.PreventDefault(e||window.event)},this),disconnectHandler:BX.delegate(function(e){this.disconnectIphone();return BX.PreventDefault(e||window.event)},this)},{id:"android",label:BX.message("EC_CAL_SYNC_ANDROID"),active:!!this.syncInfo.android.active,connected:!!this.syncInfo.android.connected,syncDate:this.syncInfo.android.syncDate,connectHandler:BX.delegate(function(e){this.connectAndroid();return BX.PreventDefault(e||window.event)},this),disconnectHandler:BX.delegate(function(e){this.disconnectAndroid();return BX.PreventDefault(e||window.event)},this)},{id:"outlook",label:BX.message("EC_CAL_SYNC_OUTLOOK"),active:!!this.syncInfo.outlook.active&&!BX.browser.IsMac(),connected:!!this.syncInfo.outlook.connected,syncDate:this.syncInfo.outlook.syncDate,connectHandler:BX.delegate(function(e){this.connectOutlook();return BX.PreventDefault(e||window.event)},this),disconnectHandler:BX.delegate(function(e){this.disconnectOutlook();return BX.PreventDefault(e||window.event)},this)},{id:"office365",label:BX.message("EC_CAL_SYNC_OFFICE_365"),active:!!this.syncInfo.office365.active,connected:!!this.syncInfo.office365.connected,syncDate:this.syncInfo.office365.syncDate},{id:"exchange",label:BX.message("EC_CAL_SYNC_EXCHANGE"),active:!!this.syncInfo.exchange.active,connected:!!this.syncInfo.exchange.connected,syncDate:this.syncInfo.exchange.syncDate,connectHandler:function(e){},disconnectHandler:function(e){},refreshHandler:BX.delegate(function(e){this.calendar.request({type:"post",data:{action:"exchange_sync"},handler:BX.delegate(function(e){if(e.result===false)alert(BX.message("EC_BAN_EXCH_NO_SYNC"));else BX.reload()},this)});return BX.PreventDefault(e||window.event)},this)}];this.syncList.forEach(function(e){if(e.active&&e.connected&&e.syncDate){e.syncDate=BX.parseDate(e.syncDate)}e.DOM={}});this.syncList.sort(function(e,n){if(e.active&&e.connected&&n.active&&n.connected&&e.syncDate&&n.syncDate){return n.syncDate.getTime()-e.syncDate.getTime()}if(e.active&&e.connected)return-1;if(n.active&&n.connected)return 1;return 0})},create:function(){top.BX.onCustomEvent(top,"onCalendarBeforeCustomSliderCreate");this.DOM.wrap=BX.create("DIV",{props:{className:"calendar-slider-calendar-wrap calendar-custom-scroll"}});this.DOM.header=this.DOM.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-slider-header"},html:'<div class="calendar-head-area"><div class="calendar-head-area-inner"><div class="calendar-head-area-title">'+'<span class="calendar-head-area-name">'+BX.message("EC_CAL_SYNC_TITLE")+"</span>"+"</div></div></div>"}));this.DOM.sliderWorkarea=this.DOM.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-slider-workarea"},style:{minWidth:"auto"}}));this.DOM.tableWrap=this.DOM.sliderWorkarea.appendChild(BX.create("DIV",{props:{className:"calendar-slider-content calendar-slider-sync-content"}}));this.DOM.table=this.DOM.tableWrap.appendChild(BX.create("TABLE",{props:{className:"calendar-sync"}}));var e,n,t,s,c,a,i,o,l,r;for(o=0;o<this.syncList.length;o++){r=this.syncList[o];r.DOM={};if(r.active){l=BX.adjust(this.DOM.table.insertRow(-1),{props:{className:"calendar-sync-column"}});e=BX.adjust(l.insertCell(-1),{props:{className:"calendar-sync-cell calendar-sync-cell-icon"}}).appendChild(BX.create("DIV",{props:{className:"calendar-sync-platform-icon calendar-sync-platform-icon-"+this.syncList[o].id}}));n=BX.adjust(l.insertCell(-1),{props:{className:"calendar-sync-cell"}}).appendChild(BX.create("DIV",{props:{className:"calendar-sync-platform-name calendar-sync-cell"},text:this.syncList[o].label}));t=BX.adjust(l.insertCell(-1),{props:{className:"calendar-sync-cell"}});if(r.connected){s=t.appendChild(BX.create("DIV",{props:{className:"calendar-sync-info"}})).appendChild(BX.create("DIV",{props:{className:"calendar-sync-info-inner"}}));c=s.appendChild(BX.create("DIV",{props:{className:"calendar-sync-info-status"},text:BX.message("EC_CAL_SYNC_OK")}));if(r.syncDate){var d=this.calendar.util.formatDateUsable(r.syncDate);if(((new Date).getTime()-r.syncDate.getTime())/this.calendar.util.dayLength<3){d+=" "+this.calendar.util.formatTime(r.syncDate.getHours(),r.syncDate.getMinutes())}a=s.appendChild(BX.create("DIV",{props:{className:"calendar-sync-info-date"},html:d}))}if(r.id=="exchange"&&this.calendar.util.config.bExchange){n.style.cursor="pointer";BX.bind(n,"click",BX.proxy(this.syncExchange,this))}}i=BX.adjust(l.insertCell(-1),{props:{className:"calendar-sync-cell calendar-sync-cell-link"}});if(!r.connected&&r.connectHandler){r.DOM.connectLink=i.appendChild(BX.create("SPAN",{props:{className:"calendar-sync-link"},events:{click:r.connectHandler},text:BX.message("EC_CAL_SYNC_CONNECT")}))}else if(r.connected){if(r.disconnectHandler){r.DOM.disconnectLink=i.appendChild(BX.create("SPAN",{props:{className:"calendar-sync-link"},events:{click:r.disconnectHandler},text:BX.message("EC_CAL_SYNC_DISCONNECT")}))}if(r.refreshHandler){r.DOM.refreshLink=i.appendChild(BX.create("SPAN",{props:{className:"calendar-sync-link"},events:{click:r.refreshHandler},text:BX.message("EC_CAL_SYNC_REFRESH")}))}if(r.disconnectHandler&&r.refreshHandler){BX.addClass(i,"calendar-sync-two-links")}}r.DOM.row=l}}return this.DOM.wrap},syncSectionWithOutlook:function(section){if(section&&section.data.OUTLOOK_JS)try{eval(section.data.OUTLOOK_JS)}catch(e){}},disconnectGoogle:function(e){if(confirm(BX.message("EC_CAL_REMOVE_GOOGLE_SYNC_CONFIRM"))){var n,t=null;for(n=0;n<this.calendar.calDavConnections.length;n++){t=this.calendar.calDavConnections[n];if(t.account_type=="caldav_google_oauth"){break}}if(t&&t.id){this.calendar.request({type:"post",data:{action:"disconnect_google",connectionId:t.id},handler:BX.delegate(function(e){BX.reload()},this)})}}return BX.PreventDefault(e||window.event)},connectOutlook:function(){var e=this.calendar.sectionController.getSectionList(),n=this,t=[],s,c,a;for(c=0;c<e.length;c++){if(e[c].belongsToView()&&e[c].data.OUTLOOK_JS){t.push(e[c])}}if(t.length==1){this.syncSectionWithOutlook(t[0])}else{var i=this.getSyncItem("outlook");if(i){s=[];for(c=0;c<t.length;c++){s.push({id:"bx-calendar-outlook-"+t[c].id,text:BX.util.htmlspecialchars(t[c].name),color:t[c].color,className:"calendar-add-popup-section-menu-item",onclick:function(e){return function(){n.syncSectionWithOutlook(n.calendar.sectionController.getSection(e));n.sectionMenu.close()}}(t[c].id)})}this.sectionMenu=top.BX.PopupMenu.create("outlookSectionMenu"+this.calendar.id,i.DOM.connectLink,s,{closeByEsc:true,autoHide:true,zIndex:3200,offsetTop:0,offsetLeft:0,angle:true});this.sectionMenu.show();for(c=0;c<this.sectionMenu.menuItems.length;c++){if(this.sectionMenu.menuItems[c].layout.item){a=this.sectionMenu.menuItems[c].layout.item.querySelector(".menu-popup-item-icon");if(a){a.style.backgroundColor=this.sectionMenu.menuItems[c].color}}}}}},connectIphone:function(){this.showSyncHelp("iphone")},connectMacOSX:function(){this.showSyncHelp("macosx")},connectAndroid:function(){this.showSyncHelp("android")},disconnectIphone:function(){this.clearSyncInformation("iphone");var e=this.getSyncItem("iphone");if(e&&e.pDisconnectLink){var n=this;this.showInfoPopup(e.pDisconnectLink,BX.message("EC_CAL_DISCONNECT_IPHONE"),function(){n.syncInfo.iphone.connected=false;n.syncInfo.iphone.syncDate=false})}},disconnectMacOSX:function(){this.clearSyncInformation("mac");var e=this.getSyncItem("macosx");if(e&&e.pDisconnectLink){var n=this;this.showInfoPopup(e.pDisconnectLink,BX.message("EC_CAL_DISCONNECT_MAC"),function(){n.syncInfo.macosx.connected=false;n.syncInfo.macosx.syncDate=false})}},disconnectAndroid:function(){this.clearSyncInformation("android");var e=this.getSyncItem("android");if(e&&e.pDisconnectLink){var n=this;this.showInfoPopup(e.pDisconnectLink,BX.message("EC_CAL_DISCONNECT_ANDROID"),function(){n.syncInfo.android.connected=false;n.syncInfo.android.syncDate=false})}},disconnectOutlook:function(){this.clearSyncInformation("outlook");var e=this.getSyncItem("outlook");if(e&&e.pDisconnectLink){var n=this;this.showInfoPopup(e.pDisconnectLink,BX.message("EC_CAL_DISCONNECT_OUTLOOK"),function(){n.syncInfo.outlook.connected=false;n.syncInfo.outlook.syncDate=false})}},showInfoPopup:function(e,n,t){var s=top.BX.PopupWindowManager.create(this.id+"-disconnect-popup",e,{autoHide:true,closeByEsc:true,offsetTop:-1,offsetLeft:1,lightShadow:true,content:BX.create("DIV",{props:{className:"bxec-disconnect-popup-wrap"},html:n})});s.show(true);function c(){if(t&&typeof t=="function")t();if(s&&s.destroy){BX.removeCustomEvent(s,"onPopupClose",c);s.destroy();s=null}}BX.addCustomEvent(s,"onPopupClose",c)},buildSyncItem:function(e,n){if(!n)n=this.pWrap;if(e.active){e.pOuter=n.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-el "+(e.className||"")}}));e.pInner=e.pOuter.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-el-block"}}));if(!e.connected&&e.connectHandler){e.pConnectLink=e.pInner.appendChild(BX.create("A",{props:{className:"bxec-sect-access-connect-link"},text:BX.message("EC_CAL_SYNC_CONNECT")}));BX.bind(e.pConnectLink,"click",e.connectHandler)}e.pIcon=e.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-icon"}}));e.pTextWrap=e.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-text-wrap"},text:e.label}));if(!this.brightMode||e.connected)BX.addClass(e.pOuter,"bxec-sect-access-connected");if(e.connected){e.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-allowed-icon"}}));e.pInfoCont=e.pOuter.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-block-info bxec-sect-access-el-block-active"}}));var t=e.pInfoCont.appendChild(BX.create("TABLE",{props:{className:"bxec-sect-access-el-table"}}));var s=t.insertRow(-1);BX.adjust(s.insertCell(-1),{props:{className:"bxec-sect-access-status"},html:BX.message("EC_CAL_SYNC_OK")});var c=BX.adjust(s.insertCell(-1),{style:{textAlign:"right"}});if(e.syncDate){e.pSyncDate=c.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-status-time"}}));e.pSyncDate.innerHTML=e.syncDate}if(e.disconnectHandler){e.pDisconnectLink=c.appendChild(BX.create("SPAN",{props:{className:"bxec-sect-access-disconnect-link"},html:BX.message("EC_CAL_SYNC_DISCONNECT")}));BX.bind(e.pDisconnectLink,"click",e.disconnectHandler)}if(e.id=="exchange"&&this.calendar.util.config.bExchange){e.pTextWrap.style.cursor="pointer";BX.bind(e.pTextWrap,"click",BX.proxy(this.syncExchange,this))}}}},getSyncItem:function(e){var n;for(n=0;n<this.syncList.length;n++){if(this.syncList[n].active&&this.syncList[n].id==e){return this.syncList[n]}}},showSyncHelp:function(e){var n=[],t;var s=this.syncList.filter(function(n){return n.id==e});if(!s||!s[0])return;s=s[0];if(!s.DOM.helpCell){s.DOM.helpRow=BX.adjust(this.DOM.table.insertRow(s.DOM.row.rowIndex+1),{props:{className:"calendar-sync-column calendar-sync-desc"}});s.DOM.helpCell=BX.adjust(s.DOM.helpRow.insertCell(-1),{attrs:{colspan:"4"},props:{className:"calendar-sync-cell"}}).appendChild(BX.create("DIV",{props:{className:"calendar-sync-help-wrap"}}));if(e=="iphone"){s.DOM.helpCell.innerHTML=BX.message("EC_MOBILE_HELP_IPHONE")}else if(e=="macosx"){s.DOM.helpCell.innerHTML=BX.message("EC_MOBILE_HELP_MAC")}else if(e=="android"){s.DOM.helpCell.innerHTML=BX.message("EC_MOBILE_HELP_ANDROID")}if(e=="iphone"||e=="macosx"){n=n.concat(BX.findChildren(s.DOM.helpCell,{tagName:"SPAN",className:"bxec-link"},true));for(t=0;t<n.length;t++){if(n[t]&&n[t].nodeName){n[t].innerHTML=this.calendar.util.config.caldav_link_all}}}}if(BX.hasClass(s.DOM.helpCell,"open")){BX.removeClass(s.DOM.helpCell,"open");setTimeout(function(){s.DOM.helpRow.style.display="none"},300)}else{s.DOM.helpRow.style.display="";setTimeout(function(){BX.addClass(s.DOM.helpCell,"open")},0)}},clearSyncInformation:function(e){this.calendar.request({type:"post",data:{action:"clear_sync_info",sync_type:e},handler:BX.delegate(function(e){BX.reload()},this)})},showICalExportDialog:function(e){var n;if(!this.exportDialog){n=BX.create("DIV",{html:"<span>"+BX.message("EC_EXP_TEXT")+"</span>"});this.exportDialog=new top.BX.PopupWindow("export_dialog"+this.calendar.id,null,{autoHide:false,closeByEsc:true,zIndex:4e3,offsetLeft:0,offsetTop:0,width:800,draggable:true,titleBar:BX.message("EC_JS_EXPORT_TILE"),closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new top.BX.PopupWindowButtonLink({text:BX.message("EC_SEC_SLIDER_CLOSE"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(function(){this.exportDialog.close()},this)}})],content:n});this.exportDialog.DOM={}}else{n=this.exportDialog.contentContainer}this.exportDialog.show();var t=this.calendar.util.config.path;t+=t.indexOf("?")>=0?"&":"?";if(e&&e.data.EXPORT.LINK){t+="action=export"+e.data.EXPORT.LINK}if(this.exportDialog.DOM.link){BX.remove(this.exportDialog.DOM.link)}this.exportDialog.DOM.link=n.appendChild(BX.create("DIV",{props:{className:""}})).appendChild(BX.create("A",{props:{href:t,target:"_blank"},html:t,events:{click:function(e){window.location.href="webcal"+t.substr(t.indexOf("://"));e.preventDefault();e.stopPropagation()}}}));BX.ajax.get(t+"&check=Y","",function(e){setTimeout(function(){if(!e||e.length<=0||e.toUpperCase().indexOf("BEGIN:VCALENDAR")==-1){alert(BX.message("EC_EDEV_EXP_WARN"))}},300)})}};if(window.BXEventCalendar){window.BXEventCalendar.SyncSlider=SyncSlider}else{BX.addCustomEvent(window,"onBXEventCalendarInit",function(){window.BXEventCalendar.SyncSlider=SyncSlider})}})(window);
//# sourceMappingURL=calendar-sync-slider.map.js