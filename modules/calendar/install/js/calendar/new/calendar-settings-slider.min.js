(function(e){function s(e){this.calendar=e.calendar;this.id=this.calendar.id+"_settings_slider";this.uid=this.id+"_"+Math.round(Math.random()*1e6);this.zIndex=e.zIndex||3100;this.sliderId="calendar:settings-slider";this.inPersonal=this.calendar.util.userIsOwner();this.showGeneralSettings=!!(this.calendar.util.config.perm&&this.calendar.util.config.perm.access);this.settings=this.calendar.util.config.settings;this.SLIDER_WIDTH=500;this.SLIDER_DURATION=80}s.prototype={show:function(){this.calendar.util.doBxContextFix();BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.create,this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION,events:{onClose:BX.proxy(this.hide,this),onCloseComplete:BX.proxy(this.destroy,this)}});this.calendar.disableKeyHandler()},close:function(){BX.SidePanel.Instance.close()},hide:function(e){if(e&&e.getSliderPage&&e.getSliderPage().getUrl()===this.sliderId){if(this.denyClose){e.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this))}}},destroy:function(e){if(e&&e.getSliderPage&&e.getSliderPage().getUrl()===this.sliderId){BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.SidePanel.Instance.destroy(this.sliderId);this.calendar.enableKeyHandler();this.calendar.util.restoreBxContextFix()}},create:function(){top.BX.onCustomEvent(top,"onCalendarBeforeCustomSliderCreate");var e=new BX.Promise;BX.ajax.get(this.calendar.util.getActionUrl(),{action:"get_settings_slider",is_personal:this.inPersonal?"Y":"N",show_general_settings:this.showGeneralSettings?"Y":"N",unique_id:this.uid,sessid:BX.bitrix_sessid(),bx_event_calendar_request:"Y",reqId:Math.round(Math.random()*1e6)},BX.delegate(function(s){e.fulfill(BX.util.trim(s));this.initControls()},this));return e},initControls:function(){BX.bind(top.BX(this.uid+"_save"),"click",BX.proxy(this.save,this));BX.bind(top.BX(this.uid+"_close"),"click",BX.proxy(this.close,this));this.DOM={denyBusyInvitation:top.BX(this.uid+"_deny_busy_invitation"),showWeekNumbers:top.BX(this.uid+"_show_week_numbers")};if(this.inPersonal){this.DOM.sectionSelect=top.BX(this.uid+"_meet_section");this.DOM.crmSelect=top.BX(this.uid+"_crm_section");this.DOM.showDeclined=top.BX(this.uid+"_show_declined");this.DOM.showTasks=top.BX(this.uid+"_show_tasks");this.DOM.showCompletedTasks=top.BX(this.uid+"_show_completed_tasks");this.DOM.timezoneSelect=top.BX(this.uid+"_set_tz_sel");this.DOM.syncPeriodPast=top.BX(this.uid+"_sync_period_past");this.DOM.syncPeriodFuture=top.BX(this.uid+"_sync_period_future")}this.DOM.workTimeStart=top.BX(this.uid+"work_time_start");this.DOM.workTimeEnd=top.BX(this.uid+"work_time_end");this.DOM.weekHolidays=top.BX(this.uid+"week_holidays");this.DOM.yearHolidays=top.BX(this.uid+"year_holidays");this.DOM.yearWorkdays=top.BX(this.uid+"year_workdays");this.typeAccess=false;if(this.calendar.util.config.TYPE_ACCESS){this.accessWrap=top.BX(this.uid+"type-access-values-cont");if(this.accessWrap){this.initAccessController();this.typeAccess=this.calendar.util.config.TYPE_ACCESS||{};var e;for(e in this.typeAccess){if(this.typeAccess.hasOwnProperty(e)){this.insertAccessRow(this.calendar.util.getAccessName(e),e,this.typeAccess[e])}}}}this.DOM.manageCalDav=top.BX(this.uid+"_manage_caldav");if(this.DOM.manageCalDav){BX.bind(this.DOM.manageCalDav,"click",BX.proxy(this.calendar.syncSlider.showCalDavSyncDialog,this.calendar.syncSlider))}if(this.inPersonal){this.DOM.sectionSelect.options.length=0;var s=this.calendar.sectionController.getSectionList(),t=parseInt(this.calendar.util.getUserOption("meetSection")),i=parseInt(this.calendar.util.getUserOption("crmSection")),a,n,o;for(a=0;a<s.length;a++){n=s[a];if(n.belongsToOwner()){if(!t){t=n.id}o=t===parseInt(n.id);this.DOM.sectionSelect.options.add(new Option(n.name,n.id,o,o));if(!i){i=n.id}o=i===parseInt(n.id);this.DOM.crmSelect.options.add(new Option(n.name,n.id,o,o))}}}if(this.DOM.showDeclined){this.DOM.showDeclined.checked=!!parseInt(this.calendar.util.getUserOption("showDeclined"))}if(this.DOM.showTasks){this.DOM.showTasks.checked=this.calendar.util.getUserOption("showTasks")==="Y"}if(this.DOM.showCompletedTasks){this.DOM.showCompletedTasks.checked=this.calendar.util.getUserOption("showCompletedTasks")==="Y"}if(this.DOM.denyBusyInvitation){this.DOM.denyBusyInvitation.checked=!!parseInt(this.calendar.util.getUserOption("denyBusyInvitation"))}if(this.DOM.showWeekNumbers){this.DOM.showWeekNumbers.checked=this.calendar.util.showWeekNumber()}if(this.DOM.timezoneSelect){this.DOM.timezoneSelect.value=this.calendar.util.getUserOption("timezoneName")||""}if(this.DOM.syncPeriodPast){this.DOM.syncPeriodPast.value=this.calendar.util.getUserOption("syncPeriodPast")||3}if(this.DOM.syncPeriodFuture){this.DOM.syncPeriodFuture.value=this.calendar.util.getUserOption("syncPeriodFuture")||12}if(this.showGeneralSettings){this.DOM.workTimeStart.value=this.settings.work_time_start;this.DOM.workTimeEnd.value=this.settings.work_time_end;if(this.DOM.weekHolidays){for(a=0;a<this.DOM.weekHolidays.options.length;a++){this.DOM.weekHolidays.options[a].selected=BX.util.in_array(this.DOM.weekHolidays.options[a].value,this.settings.week_holidays)}}this.DOM.yearHolidays.value=this.settings.year_holidays;this.DOM.yearWorkdays.value=this.settings.year_workdays}},save:function(){var e=this.calendar.util.config.userSettings;if(this.DOM.showDeclined){e.showDeclined=this.DOM.showDeclined.checked?1:0}if(this.DOM.showWeekNumbers){e.showWeekNumbers=this.DOM.showWeekNumbers.checked?"Y":"N"}if(this.DOM.showTasks){e.showTasks=this.DOM.showTasks.checked?"Y":"N"}if(this.DOM.showCompletedTasks){e.showCompletedTasks=this.DOM.showCompletedTasks.checked?"Y":"N"}if(this.DOM.sectionSelect){e.meetSection=this.DOM.sectionSelect.value}if(this.DOM.crmSelect){e.crmSection=this.DOM.crmSelect.value}if(this.DOM.denyBusyInvitation){e.denyBusyInvitation=this.DOM.denyBusyInvitation.checked?1:0}if(this.DOM.timezoneSelect){e.userTimezoneName=this.DOM.timezoneSelect.value}if(this.DOM.syncPeriodPast){e.syncPeriodPast=this.DOM.syncPeriodPast.value}if(this.DOM.syncPeriodFuture){e.syncPeriodFuture=this.DOM.syncPeriodFuture.value}var s={action:"save_settings",user_settings:e,user_timezone_name:e.userTimezoneName};if(this.showGeneralSettings&&this.DOM.workTimeStart){s.settings={work_time_start:this.DOM.workTimeStart.value,work_time_end:this.DOM.workTimeEnd.value,week_holidays:[],year_holidays:this.DOM.yearHolidays.value,year_workdays:this.DOM.yearWorkdays.value};for(var t=0;t<this.DOM.weekHolidays.options.length;t++){if(this.DOM.weekHolidays.options[t].selected){s.settings.week_holidays.push(this.DOM.weekHolidays.options[t].value)}}}if(this.typeAccess!==false){s.type_access=this.typeAccess}this.calendar.request({type:"post",data:s,handler:BX.delegate(function(e){BX.reload()},this)});this.close()},initAccessController:function(){this.accessControls={};this.accessTasks=this.calendar.util.getTypeAccessTasks();BX.bind(this.accessLink,"click",BX.delegate(function(){if(BX.hasClass(this.accessWrap,"shown")){BX.removeClass(this.accessWrap,"shown")}else{BX.addClass(this.accessWrap,"shown")}},this));top.BX.Access.Init();this.accessWrapInner=this.accessWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-access-inner-wrap"}}));this.accessTable=this.accessWrapInner.appendChild(BX.create("TABLE",{props:{className:"calendar-section-slider-access-table"}}));this.accessButtonWrap=this.accessWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-new-calendar-options-container"}}));this.accessButton=this.accessButtonWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-add"},html:BX.message("EC_SEC_SLIDER_ACCESS_ADD")}));BX.bind(this.accessButton,"click",BX.proxy(function(){top.BX.Access.ShowForm({callback:BX.proxy(function(e){var s,t;for(s in e){if(e.hasOwnProperty(s)){for(t in e[s]){if(e[s].hasOwnProperty(t)){this.insertAccessRow(top.BX.Access.GetProviderName(s)+" "+e[s][t].name,t)}}}}},this),bind:this.accessButton});if(top.BX.Access.popup&&top.BX.Access.popup.popupContainer){top.BX.Access.popup.popupContainer.style.zIndex=this.zIndex+10}},this));BX.bind(this.accessWrapInner,"click",BX.proxy(function(e){var s,t=this.calendar.util.findTargetNode(e.target||e.srcElement,this.outerWrap);if(t&&t.getAttribute){if(t.getAttribute("data-bx-calendar-access-selector")!==null){s=t.getAttribute("data-bx-calendar-access-selector");if(this.accessControls[s]){this.showAccessSelectorPopup({node:this.accessControls[s].removeIcon,setValueCallback:BX.delegate(function(e){if(this.accessTasks[e]&&this.accessControls[s]){this.accessControls[s].valueNode.innerHTML=BX.util.htmlspecialchars(this.accessTasks[e].title);this.typeAccess[s]=e}},this)})}}else if(t.getAttribute("data-bx-calendar-access-remove")!==null){s=t.getAttribute("data-bx-calendar-access-remove");if(this.accessControls[s]){BX.cleanNode(this.accessControls[s].rowNode,true);delete this.typeAccess[s]}}}},this))},insertAccessRow:function(e,s,t){if(t===undefined){t=this.calendar.util.getDefaultTypeAccessTask();this.typeAccess[s]=t}var i=BX.adjust(this.accessTable.insertRow(-1),{props:{className:"calendar-section-slider-access-table-row"}}),a=BX.adjust(i.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},html:'<span class="calendar-section-slider-access-title">'+BX.util.htmlspecialchars(e)+":</span>"}),n=BX.adjust(i.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},attrs:{"data-bx-calendar-access-selector":s}}),o=n.appendChild(BX.create("SPAN",{props:{className:"calendar-section-slider-access-container"}})),c=o.appendChild(BX.create("SPAN",{text:this.accessTasks[t]?this.accessTasks[t].title:"",props:{className:"calendar-section-slider-access-value"}})),r=o.appendChild(BX.create("SPAN",{props:{className:"calendar-section-slider-access-remove"},attrs:{"data-bx-calendar-access-remove":s}}));this.accessControls[s]={rowNode:i,titleNode:a,valueNode:c,removeIcon:r}},showAccessSelectorPopup:function(e){if(this.accessPopupMenu&&this.accessPopupMenu.popupWindow&&this.accessPopupMenu.popupWindow.isShown()){return this.accessPopupMenu.close()}var s=this.calendar.id+"_type_access_popup",t,i=this,a=[];for(t in this.accessTasks){if(this.accessTasks.hasOwnProperty(t)){a.push({text:this.accessTasks[t].title,onclick:function(s){return function(){e.setValueCallback(s);i.accessPopupMenu.close()}}(t)})}}this.accessPopupMenu=top.BX.PopupMenu.create(s,e.node,a,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:-5,offsetLeft:0,angle:true});this.accessPopupMenu.show();top.BX.addCustomEvent(this.accessPopupMenu.popupWindow,"onPopupClose",function(){top.BX.PopupMenu.destroy(s);i.accessPopupMenu=null})}};if(e.BXEventCalendar){e.BXEventCalendar.SettingsSlider=s}else{BX.addCustomEvent(e,"onBXEventCalendarInit",function(){e.BXEventCalendar.SettingsSlider=s})}})(window);
//# sourceMappingURL=calendar-settings-slider.map.js