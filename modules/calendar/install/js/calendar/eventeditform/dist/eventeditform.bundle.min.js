this.BX=this.BX||{};(function(e,t,i,n,s,o,a,r){"use strict";var l=function(e){babelHelpers.inherits(n,e);function n(){babelHelpers.classCallCheck(this,n);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).apply(this,arguments))}babelHelpers.createClass(n,[{key:"create",value:function e(){this.DOM.dateTimeWrap=this.DOM.outerContent.querySelector("#".concat(this.UID,"_datetime_container"));this.DOM.fromDate=this.DOM.outerContent.querySelector("#".concat(this.UID,"_date_from"));this.DOM.toDate=this.DOM.outerContent.querySelector("#".concat(this.UID,"_date_to"));this.DOM.fromTime=this.DOM.outerContent.querySelector("#".concat(this.UID,"_time_from"));this.DOM.toTime=this.DOM.outerContent.querySelector("#".concat(this.UID,"_time_to"));this.fromTimeControl=new i.TimeSelector({input:this.DOM.fromTime,onChangeCallback:this.handleTimeFromChange.bind(this)});this.toTimeControl=new i.TimeSelector({input:this.DOM.toTime,onChangeCallback:this.handleTimeToChange.bind(this)});this.DOM.fullDay=this.DOM.outerContent.querySelector("#".concat(this.UID,"_date_full_day"));this.DOM.defTimezoneWrap=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_default_wrap"));this.DOM.defTimezone=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_default"));this.DOM.fromTz=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_from"));this.DOM.toTz=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_to"));this.DOM.tzButton=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_btn"));this.DOM.tzOuterCont=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_wrap"));this.DOM.tzCont=this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_inner_wrap"));this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_hint")).title=t.Loc.getMessage("EC_EVENT_TZ_HINT");this.DOM.outerContent.querySelector("#".concat(this.UID,"_timezone_default_hint")).title=t.Loc.getMessage("EC_EVENT_TZ_DEF_HINT");this.prepareModel();this.bindEventHandlers()}},{key:"prepareModel",value:function e(){t.Dom.adjust(this.DOM.fromDate,{props:{autocomplete:"off"}});t.Dom.adjust(this.DOM.toDate,{props:{autocomplete:"off"}});t.Dom.adjust(this.DOM.fromTime,{props:{autocomplete:"off"}});t.Dom.adjust(this.DOM.toTime,{props:{autocomplete:"off"}})}}]);return n}(i.DateTimeControl);function d(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);d=function t(){return e};return e}var h=function(){function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"DOM",{});babelHelpers.defineProperty(this,"planner",null);babelHelpers.defineProperty(this,"uid",null);babelHelpers.defineProperty(this,"sliderId","calendar:edit-entry-slider");babelHelpers.defineProperty(this,"zIndex",3100);babelHelpers.defineProperty(this,"denyClose",false);babelHelpers.defineProperty(this,"formType","slider_main");babelHelpers.defineProperty(this,"STATE",{READY:1,REQUEST:2,ERROR:3});babelHelpers.defineProperty(this,"sections",[]);babelHelpers.defineProperty(this,"sectionIndex",{});babelHelpers.defineProperty(this,"trackingUsersList",[]);babelHelpers.defineProperty(this,"userSettings",{});this.name=i.name||"eventeditform";this.type=i.type||"user";this.ownerId=i.ownerId;this.userId=i.userId||parseInt(t.Loc.getMessage("USER_ID"));this.entryId=parseInt(i.entryId);this.entry=i.entry||null;this.emitter=new a.EventEmitter;this.emitter.setEventNamespace("BX.Calendar.EventEditForm");this.BX=n.Util.getBX();this.formSettings={pinnedFields:{}};if(!this.ownerId&&this.type==="user"){this.ownerId=parseInt(t.Loc.getMessage("USER_ID"))}this.state=this.STATE.READY;this.sliderOnClose=this.hide.bind(this)}babelHelpers.createClass(e,[{key:"initInSlider",value:function e(i,n){this.sliderId=i.getUrl();this.BX.addCustomEvent(i,"SidePanel.Slider:onLoad",this.onLoadSlider.bind(this));this.BX.addCustomEvent(i,"SidePanel.Slider:onClose",this.sliderOnClose);this.BX.addCustomEvent(i,"SidePanel.Slider:onBeforeCloseComplete",this.destroy.bind(this));this.setCurrentEntry(this.entry||null);this.createContent(i).then(function(e){if(t.Type.isFunction(n)){n(e)}}.bind(this));this.opened=true;this.bindEventHandlers()}},{key:"show",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setCurrentEntry(i.entry);if(i.formType){this.formType=i.formType}this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),label:{text:t.Loc.getMessage("CALENDAR_EVENT"),bgColor:"#55D0E0"},events:{onClose:this.sliderOnClose,onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}});this.opened=true;this.bindEventHandlers()}},{key:"isOpened",value:function e(){return this.opened}},{key:"bindEventHandlers",value:function e(){var i=this;this.keyHandlerBind=this.keyHandler.bind(this);t.Event.bind(document,"click",n.Util.applyHacksForPopupzIndex);t.Event.bind(document,"keydown",this.keyHandlerBind);this.mouseUpNodeCheck=null;t.Event.bind(document,"mousedown",function(e){i.mousedownTarget=e.target||e.srcElement});t.Event.bind(document,"mouseup",function(e){var t=e.target||e.srcElement;if(i.mousedownTarget!==t){i.mouseUpNodeCheck=false}setTimeout(function(){i.mouseUpNodeCheck=null},0)});this.BX.addCustomEvent(window,"onCalendarControlChildPopupShown",this.BX.proxy(this.denySliderClose,this));this.BX.addCustomEvent(window,"onCalendarControlChildPopupClosed",this.BX.proxy(this.allowSliderClose,this))}},{key:"onLoadSlider",value:function e(t){var i=t.getSlider();this.DOM.content=i.layout.content;this.sliderId=i.getUrl();this.BX.html(i.layout.content,i.getData().get("sliderContent"));this.initControls(this.uid);this.setFormValues()}},{key:"close",value:function e(){if(!this.checkDenyClose()){this.state=this.STATE.READY;this.BX.SidePanel.Instance.close()}}},{key:"save",value:function e(){var i=this;var o=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.state===this.STATE.REQUEST)return;o=t.Type.isPlainObject(o)?o:{};if(this.entry.id&&this.entry.isRecursive()&&!o.confirmed&&this.checkForSignificantChanges()){s.EntryManager.showConfirmEditDialog({callback:function e(t){i.save({recursionMode:t.recursionMode,confirmed:true})}});return false}t.Dom.addClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);t.Dom.addClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);this.DOM.form.id.value=this.entry.id||0;this.DOM.form.location.value=this.locationSelector.getTextValue();if(this.editor){this.editor.SaveContent()}var r=this.getCurrentSection();if(r){if(r.COLOR.toLowerCase()!==this.colorSelector.getValue().toLowerCase()){this.DOM.form.color.value=this.colorSelector.getValue()}this.BX.userOptions.save("calendar","user_settings","lastUsedSection",parseInt(r.ID))}this.DOM.form.current_date_from.value=o.recursionMode?n.Util.formatDate(this.entry.from):"";this.DOM.form.rec_edit_mode.value=o.recursionMode||"";this.state=this.STATE.REQUEST;this.BX.ajax.runAction("calendar.api.calendarajax.editEntry",{data:new FormData(this.DOM.form)}).then(function(e){t.Dom.removeClass(i.DOM.saveBtn,i.BX.UI.Button.State.CLOCKING);t.Dom.removeClass(i.DOM.closeBtn,i.BX.UI.Button.State.DISABLED);i.state=i.STATE.READY;if(e.data.entryId){if(i.entry.id){s.EntryManager.showEditEntryNotification(e.data.entryId)}else{s.EntryManager.showNewEntryNotification(e.data.entryId)}}i.emitter.emit("onSave",new a.BaseEvent({data:{responseData:e.data,options:o}}));i.close()},function(e){t.Dom.removeClass(i.DOM.saveBtn,i.BX.UI.Button.State.CLOCKING);t.Dom.removeClass(i.DOM.closeBtn,i.BX.UI.Button.State.DISABLED);if(e.data&&t.Type.isPlainObject(e.data.busyUsersList)){i.handleBusyUsersError(e.data.busyUsersList);var n=[];e.errors.forEach(function(e){if(e.code!=="edit_entry_user_busy"){n.push(e)}});e.errors=n}if(e.errors&&e.errors.length){i.showError(e.errors)}i.state=i.STATE.ERROR})}},{key:"handleBusyUsersError",value:function e(t){var n=this;var s=[],o=[];for(var a in t){if(t.hasOwnProperty(a)){s.push(t[a]);o.push(a)}}this.busyUsersDialog=new i.BusyUsersDialog;this.busyUsersDialog.subscribe("onSaveWithout",function(){n.DOM.form.exclude_users.value=o.join(",");n.save()});this.busyUsersDialog.show({users:s})}},{key:"clientSideCheck",value:function e(){}},{key:"hide",value:function e(t){if(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId){if(this.checkDenyClose()){t.denyAction()}else{this.BX.removeCustomEvent("SidePanel.Slider::onClose",this.sliderOnClose);if(this.attendeesSelector)this.attendeesSelector.closeAll();this.destroy(t)}}}},{key:"destroy",value:function e(i){if(i&&i.getSliderPage&&i.getSliderPage().getUrl()===this.sliderId){this.BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}]);this.BX.removeCustomEvent("OnDestinationAddNewItem",this.BX.proxy(this.checkPlannerState,this));this.BX.removeCustomEvent("OnDestinationUnselect",this.BX.proxy(this.checkPlannerState,this));t.Event.unbind(document,"keydown",this.keyHandlerBind);this.BX.SidePanel.Instance.destroy(this.sliderId);t.Event.unbind(document,"click",n.Util.applyHacksForPopupzIndex);this.planner=null;this.opened=false}}},{key:"createContent",value:function e(i){var s=this;var o=new this.BX.Promise;var a=this.getCurrentEntry();this.BX.ajax.runAction("calendar.api.calendarajax.getEditEventSlider",{data:{event_id:this.entryId||a.id,date_from:a?n.Util.formatDate(a.from):"",form_type:this.formType,type:this.type,ownerId:this.ownerId}}).then(function(e){if(t.Type.isFunction(i.isOpen)&&i.isOpen()||i.isOpen===true){var n=s.BX.util.trim(e.data.html);i.getData().set("sliderContent",n);var r=e.data.additionalParams;s.uid=r.uniqueId;s.editorId=r.editorId;s.lastUsedSection=r.lastSection;s.socnetDestination=r.socnetDestination||{};s.formSettings=s.getSettings(r.formSettings||[]);s.setUserSettings(r.userSettings);s.handleSections(r.sections,r.trackingUsersList);s.handleLocationData(r.locationFeatureEnabled,r.locationList,r.iblockMeetingRoomList);if(!a.id&&!a.sectionId){s.setCurrentEntry()}s.updateEntryData(r.entry,{userSettings:s.userSettings});o.fulfill(n);if(window.top.BX!==window.BX){window.top.BX.loadCSS(["/bitrix/components/bitrix/calendar.grid/templates/.default/style.css","/bitrix/js/calendar/new/calendar.css","/bitrix/js/calendar/cal-style.css"])}}},function(e){});return o}},{key:"initControls",value:function e(i){this.DOM.title=this.DOM.content.querySelector("#".concat(i,"_title"));this.DOM.formWrap=this.DOM.content.querySelector("#".concat(i,"_form_wrap"));this.DOM.form=this.DOM.content.querySelector("#".concat(i,"_form"));this.DOM.saveBtn=this.DOM.content.querySelector("#".concat(i,"_save"));this.DOM.closeBtn=this.DOM.content.querySelector("#".concat(i,"_close"));t.Event.bind(this.DOM.saveBtn,"click",this.save.bind(this));t.Event.bind(this.DOM.closeBtn,"click",this.close.bind(this));this.DOM.content.querySelector("#".concat(i,"_save_cmd")).innerHTML=t.Browser.isMac()?"(Cmd+Enter)":"(Ctrl+Enter)";this.initFormFieldManager(i);this.initDateTimeControl(i);this.initNameControl(i);this.initEditorControl(i);this.initAttendeesControl(i);this.initPlanner(i);this.initReminderControl(i);this.initSectionSelector(i);this.initLocationControl(i);this.initRepeatRuleControl(i);this.initColorControl(i);this.initCrmUfControl(i);this.initAdditionalControls(i);this.checkLastItemBorder()}},{key:"updateEntryData",value:function e(i){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(this.entry instanceof s.Entry){var o=n.userSettings||{};if(t.Type.isPlainObject(i)){this.entry.prepareData(i)}else{if(!this.entry.getTimezoneFrom()||this.entry.getTimezoneTo()){this.entry.setTimezone(o.timezoneName||o.timezoneDefaultName||null)}}}}},{key:"handleSections",value:function e(i,n){var s=this;this.sections=i;this.sectionIndex={};this.trackingUsersList=n||[];if(t.Type.isArray(i)){i.forEach(function(e,t){s.sectionIndex[parseInt(e.ID)]=t},this)}}},{key:"handleLocationData",value:function e(t,n,s){this.locationFeatureEnabled=!!t;this.locationList=n||[];this.iblockMeetingRoomList=s||[];i.Location.setLocationList(n);i.Location.setMeetingRoomList(s)}},{key:"setUserSettings",value:function e(t){this.userSettings=t}},{key:"setFormValues",value:function e(){var t=this.entry;this.dateTimeControl.setValue({from:t.from,to:t.to,fullDay:t.fullDay,timezoneFrom:t.getTimezoneFrom()||"",timezoneTo:t.getTimezoneTo()||"",timezoneName:this.userSettings.timezoneName});this.DOM.entryName.value=t.getName();this.DOM.sectionInput.value=this.getCurrentSectionId();this.sectionSelector.updateValue();if(!this.fieldIsPinned("section")){var i=this.getCurrentSection();if(i["CAL_TYPE"]!==this.type||i["CAL_TYPE"]===this.type&&parseInt(i["OWNER_ID"])!==this.ownerId){this.pinField("section")}}this.colorSelector.setValue(t.getColor()||this.getCurrentSection().COLOR);this.reminderControl.setValue(t.getReminders());this.repeatSelector.setValue(t.getRrule());if(this.DOM.accessibilityInput){this.DOM.accessibilityInput.value=t.accessibility}this.locationSelector.setValue(t.getLocation());if(this.DOM.privateEventCheckbox){this.DOM.privateEventCheckbox.checked=t.private}if(this.DOM.importantEventCheckbox){this.DOM.importantEventCheckbox.checked=t.important}if(this.userSelector){this.userSelector.setValue(t.getAttendeesCodes())}this.loadPlannerData({codes:t.getAttendeesCodes(),from:n.Util.formatDate(t.from.getTime()-n.Util.getDayLength()*3),to:n.Util.formatDate(t.to.getTime()+n.Util.getDayLength()*10),timezone:t.getTimezoneFrom(),location:this.locationSelector.getTextValue()})}},{key:"switchFullDay",value:function e(i){i=!!this.DOM.fullDay.checked;if(i&&t.Type.isString(this.userSettings.timezoneName)&&(!this.DOM.fromTz.value||!this.DOM.toTz.value)){this.DOM.fromTz.value=this.userSettings.timezoneName;this.DOM.toTz.value=this.userSettings.timezoneName;this.DOM.defTimezone.value=this.userSettings.timezoneName}if(i){t.Dom.addClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}else{t.Dom.removeClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}if(this.reminderControl){this.reminderControl.setFullDayMode(i)}this.refreshPlannerState()}},{key:"switchTimezone",value:function e(){if(t.Dom.hasClass(this.DOM.tzCont,"calendar-options-timezone-collapse")){t.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-expand");t.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-collapse")}else{t.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-collapse");t.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-expand")}}},{key:"initFormFieldManager",value:function e(i){var n=this;this.DOM.mainBlock=this.DOM.content.querySelector("#".concat(i,"_main_block_wrap"));this.DOM.additionalBlockWrap=this.DOM.content.querySelector("#".concat(i,"_additional_block_wrap"));this.DOM.additionalBlock=this.DOM.content.querySelector("#".concat(i,"_additional_block"));this.DOM.pinnedNamesWrap=this.DOM.content.querySelector("#".concat(i,"_additional_pinned_names"));this.DOM.additionalSwitch=this.DOM.content.querySelector("#".concat(i,"_additional_switch"));t.Event.bind(this.DOM.additionalSwitch,"click",function(){t.Dom.toggleClass(n.DOM.additionalSwitch,"opened");t.Dom.toggleClass(n.DOM.additionalBlock,"invisible")});t.Event.bind(this.DOM.formWrap,"click",function(e){var t=e.target||e.srcElement;if(t&&t.getAttribute&&t.getAttribute("data-bx-fixfield")){var i=t.getAttribute("data-bx-fixfield");if(!n.fieldIsPinned(i)){n.pinField(i)}else{n.unPinField(i)}}})}},{key:"initDateTimeControl",value:function e(t){this.dateTimeControl=new l(t,{showTimezone:true,outerContent:this.DOM.content})}},{key:"initNameControl",value:function e(t){var i=this;this.DOM.entryName=this.DOM.content.querySelector("#".concat(t,"_entry_name"));setTimeout(function(){i.DOM.entryName.focus();i.DOM.entryName.select()},500)}},{key:"initReminderControl",value:function e(n){var s=this;this.reminderValues=[];this.DOM.reminderWrap=this.DOM.content.querySelector("#".concat(n,"_reminder"));this.DOM.reminderInputsWrap=this.DOM.reminderWrap.appendChild(t.Tag.render(d()));this.reminderControl=new i.Reminder({wrap:this.DOM.reminderWrap,zIndex:this.zIndex});this.reminderControl.subscribe("onChange",function(e){if(e instanceof a.BaseEvent){s.reminderValues=e.getData().values;t.Dom.clean(s.DOM.reminderInputsWrap);s.reminderValues.forEach(function(e){s.DOM.reminderInputsWrap.appendChild(t.Dom.create("INPUT",{props:{name:"reminder[]",type:"hidden"},attrs:{value:e}}))})}});if(this.dateTimeControl){this.dateTimeControl.subscribe("onChange",function(e){if(e instanceof a.BaseEvent){var t=e.getData().value;this.reminderControl.setFullDayMode(t.fullDay);if(this.newPlanner){this.newPlanner.updateSelector(t.from,t.to,t.fullDay)}}}.bind(this))}}},{key:"initSectionSelector",value:function e(t){var n=this;this.DOM.sectionInput=this.DOM.content.querySelector("#".concat(t,"_section"));this.sectionSelector=new i.SectionSelector({outerWrap:this.DOM.content.querySelector("#".concat(t,"_section_wrap")),defaultCalendarType:this.type,defaultOwnerId:this.ownerId,sectionList:this.sections,sectionGroupList:o.CalendarSectionManager.getSectionGroupList({type:this.type||"user",ownerId:this.ownerId||this.userId,userId:this.userId,trackingUsersList:this.trackingUsersList}),mode:"full",zIndex:this.zIndex,getCurrentSection:function e(){var t=n.getCurrentSection();if(t){return{id:t.ID,name:t.NAME,color:t.COLOR}}return false},selectCallback:function e(t){if(t){n.DOM.sectionInput.value=t.id;if(n.colorSelector){n.colorSelector.setValue(t.color)}n.entry.setSectionId(t.id)}}})}},{key:"initEditorControl",value:function e(t){if(!window["BXHtmlEditor"]){return setTimeout(BX.delegate(this.initEditorControl,this),50)}this.editor=null;if(window["BXHtmlEditor"]){this.editor=window["BXHtmlEditor"].Get(this.editorId)}if(!this.editor&&top["BXHtmlEditor"]!==window["BXHtmlEditor"]){this.editor=top["BXHtmlEditor"].Get(this.editorId)}if(this.editor&&this.editor.IsShown()){this.customizeHtmlEditor()}else{this.BX.addCustomEvent(window["BXHtmlEditor"],"OnEditorCreated",function(e){if(e.id===this.editorId){this.editor=e;this.customizeHtmlEditor()}}.bind(this))}}},{key:"customizeHtmlEditor",value:function e(){var i=this.editor;if(i.toolbar&&i.toolbar.controls&&i.toolbar.controls.spoiler){t.Dom.remove(i.toolbar.controls.spoiler.pCont)}}},{key:"initLocationControl",value:function e(t){this.DOM.locationWrap=this.DOM.content.querySelector("#".concat(t,"_location_wrap"));this.DOM.locationInput=this.DOM.content.querySelector("#".concat(t,"_location"));this.locationSelector=new i.Location({inputName:"lo_cation",wrap:this.DOM.locationWrap,richLocationEnabled:this.locationFeatureEnabled,locationList:this.locationList,iblockMeetingRoomList:this.iblockMeetingRoomList,onChangeCallback:this.checkPlannerState.bind(this)})}},{key:"initRepeatRuleControl",value:function e(t){var n=this;this.DOM.rruleWrap=this.DOM.content.querySelector("#".concat(t,"_rrule_wrap"));this.repeatSelector=new i.RepeatSelector({wrap:this.DOM.rruleWrap,rruleType:this.DOM.content.querySelector("#".concat(t,"_rrule_type")),getDate:function(){return this.dateTimeControl.getValue().from}.bind(this)});this.dateTimeControl.subscribe("onChange",function(){if(n.repeatSelector.getType()==="weekly"){n.repeatSelector.changeType(n.repeatSelector.getType())}})}},{key:"initAttendeesControl",value:function e(t){var n=this;this.DOM.attendeesWrap=this.DOM.content.querySelector("#".concat(t,"_attendees_wrap"));this.DOM.plannerWrap=this.DOM.content.querySelector("#".concat(t,"_planner_wrap"));this.DOM.attendeesTitle=this.DOM.content.querySelector("#".concat(t,"_attendees_title_wrap"));this.plannerId=t+"_slider_planner";this.userSelector=new i.UserSelector({wrapNode:this.DOM.attendeesWrap,items:this.getUserSelectorConfig("items"),itemsSelected:this.getUserSelectorConfig("itemsSelected"),itemsLast:this.getUserSelectorConfig("itemsLast")});this.DOM.plannerWrap=this.DOM.content.querySelector("#".concat(t,"_planner_wrap1"));this.DOM.attendeesTitle=this.DOM.content.querySelector("#".concat(t,"_attendees_title_wrap"));this.plannerId=t+"_slider_planner";setTimeout(function(){n.BX.addCustomEvent("OnDestinationAddNewItem",n.checkPlannerState.bind(n));n.BX.addCustomEvent("OnDestinationUnselect",n.checkPlannerState.bind(n))},100);this.DOM.moreOuterWrap=BX(this.id+"_more_outer_wrap");if(this.DOM.form.allow_invite){if(this.entry.data)this.DOM.form.allow_invite.checked=this.entry.data.MEETING&&this.entry.data.MEETING.ALLOW_INVITE;else this.DOM.form.allow_invite.checked=this.entry.allowInvite}if(this.DOM.form.meeting_notify){if(this.entry.data&&this.entry.data.MEETING)this.DOM.form.meeting_notify.checked=this.entry.data.MEETING.NOTIFY;else this.DOM.form.meeting_notify.checked=true}this.dateTimeControl.subscribe("onChange",function(e){}.bind(this))}},{key:"initPlanner",value:function e(t){this.DOM.plannerOuterWrap=this.DOM.content.querySelector("#".concat(t,"_planner_outer_wrap"));this.newPlanner=new r.Planner({wrap:this.DOM.plannerOuterWrap,minWidth:parseInt(this.DOM.plannerOuterWrap.offsetWidth)});this.newPlanner.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this));this.newPlanner.show();this.newPlanner.showLoader()}},{key:"loadPlannerData",value:function e(){var i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.newPlanner.showLoader();return new Promise(function(e){i.BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{entryId:i.entry.id||0,codes:n.codes||[],dateFrom:n.from||"",dateTo:n.to||"",timezone:n.timezone||"",location:n.location||"",entries:n.entrieIds||false}}).then(function(n){i.newPlanner.hideLoader();var s=[],o=n.data.entries;if(t.Type.isArray(n.data.entries)){n.data.entries.forEach(function(e){if(e.type==="user"){s.push({id:e.id,name:e.name,avatar:e.avatar,smallAvatar:e.smallAvatar||e.avatar,url:e.url})}})}var a=i.dateTimeControl.getValue();i.newPlanner.update(n.data.entries,n.data.accessibility);i.newPlanner.updateSelector(a.from,a.to,a.fullDay);e(n)},function(t){e(t)})})}},{key:"initAdditionalControls",value:function e(t){this.DOM.accessibilityInput=this.DOM.content.querySelector("#".concat(t,"_accessibility"));this.DOM.privateEventCheckbox=this.DOM.content.querySelector("#".concat(t,"_private"));this.DOM.importantEventCheckbox=this.DOM.content.querySelector("#".concat(t,"_important"))}},{key:"initColorControl",value:function e(t){this.DOM.colorWrap=this.DOM.content.querySelector("#".concat(t,"_color_selector_wrap"));this.colorSelector=new i.ColorSelector({wrap:this.DOM.colorWrap})}},{key:"initCrmUfControl",value:function e(i){this.DOM.crmUfWrap=BX(i+"-uf-crm-wrap");if(this.DOM.crmUfWrap){var s=this.getCurrentEntry();var o=this.DOM.crmUfWrap.appendChild(t.Dom.adjust(n.Util.getLoader(50),{style:{height:"40px",width:"40px"}}));setTimeout(function(){this.BX.ajax.runAction("calendar.api.calendarajax.getCrmUserfield",{data:{event_id:s&&s.id?s.id:0}}).then(function(e){if(t.Type.isDomNode(this.DOM.crmUfWrap)){this.BX.html(this.DOM.crmUfWrap,e.data.html)}}.bind(this),function(e){t.Dom.remove(o)}.bind(this))}.bind(this),800)}}},{key:"denySliderClose",value:function e(){this.denyClose=true}},{key:"allowSliderClose",value:function e(){this.denyClose=false}},{key:"checkDenyClose",value:function e(){if(this.state===this.STATE.REQUEST){return true}if(!t.Type.isNull(this.mouseUpNodeCheck)){return!this.mouseUpNodeCheck}return this.denyClose}},{key:"setCurrentEntry",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this.entry=s.EntryManager.getEntryInstance(t,i)}},{key:"getCurrentEntry",value:function e(){return this.entry}},{key:"getCurrentSection",value:function e(){var t=false,i=this.getCurrentSectionId();if(i&&this.sectionIndex[i]!==undefined&&this.sections[this.sectionIndex[i]]!==undefined){t=this.sections[this.sectionIndex[i]]}return t}},{key:"getCurrentSectionId",value:function e(){var t=0,i=this.getCurrentEntry();if(i instanceof s.Entry){t=parseInt(i.sectionId)}if(!t&&this.lastUsedSection&&this.sections[this.sectionIndex[parseInt(this.lastUsedSection)]]){t=parseInt(this.lastUsedSection)}if(!t&&this.sections[0]){t=parseInt(this.sections[0].ID)}return t}},{key:"getUserSelectorConfig",value:function e(i){var n;if(i==="items"){n={users:this.socnetDestination.USERS||{},groups:this.socnetDestination.EXTRANET_USER==="Y"||this.socnetDestination.DENY_TOALL?{}:{UA:{id:"UA",name:this.socnetDestination.DEPARTMENT?t.Loc.getMessage("EC_SOCNET_DESTINATION_4"):t.Loc.getMessage("EC_SOCNET_DESTINATION_3")}},sonetgroups:this.socnetDestination.SONETGROUPS||{},department:this.socnetDestination.DEPARTMENT||{},departmentRelation:this.socnetDestination.DEPARTMENT_RELATION||{}}}else if(i==="itemsLast"&&this.socnetDestination.LAST){n={users:this.socnetDestination.LAST.USERS||{},groups:this.socnetDestination.EXTRANET_USER==="Y"?{}:{UA:true},sonetgroups:this.socnetDestination.LAST.SONETGROUPS||{},department:this.socnetDestination.LAST.DEPARTMENT||{}}}else if(i==="itemsSelected"){n=this.socnetDestination.SELECTED||{}}return n}},{key:"setUserSelectorConfig",value:function e(t){this.socnetDestination=t}},{key:"pinField",value:function e(i){var n=this;var s=this.getPlaceholders(),o=babelHelpers.slicedToArray(s,2),a=o[0],r=o[1];var l=r[i],d=a[i],h=l.offsetHeight;l.style.height=h+"px";setTimeout(function(){t.Dom.addClass(l,"calendar-hide-field")},0);d.style.height="0";if(i==="description"){setTimeout(function(){if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(this.DOM.descriptionAdditionalWrap.firstChild){d.appendChild(this.DOM.descriptionAdditionalWrap.firstChild)}}d.style.height=h+"px"}.bind(this),200);setTimeout(function(){t.Dom.removeClass(l,"calendar-hide-field");l.style.display="none";d.style.height="";this.pinnedFieldsIndex[i]=true;var e=window["BXHtmlEditor"].Get(this.editorId);if(e){e.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}.bind(this),500)}else{setTimeout(function(){while(l.firstChild){d.appendChild(l.firstChild)}d.style.height=h+"px"},200);setTimeout(function(){t.Dom.removeClass(l,"calendar-hide-field");l.style.height="";d.style.height="";n.pinnedFieldsIndex[i]=true;n.saveSettings();n.updateAdditionalBlockState()},300)}}},{key:"unPinField",value:function e(i){var n=this.getPlaceholders(),s=babelHelpers.slicedToArray(n,2),o=s[0],a=s[1];var r=o[i],l=a[i],d=r.offsetHeight;r.style.height=d+"px";setTimeout(function(){t.Dom.addClass(r,"calendar-hide-field")},0);l.style.height="0";if(i==="description"){setTimeout(function(){if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(r.firstChild){this.DOM.descriptionAdditionalWrap.appendChild(r.firstChild)}}l.style.display="";l.style.height=d+"px"}.bind(this),200);setTimeout(function(){t.Dom.removeClass(r,"calendar-hide-field");r.style.height="";l.style.height="";this.pinnedFieldsIndex[i]=false;var e=window["BXHtmlEditor"].Get(this.editorId);if(e){e.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}.bind(this),300)}else{setTimeout(function(){while(r.firstChild){l.appendChild(r.firstChild)}l.style.height=d+"px"},200);setTimeout(function(){t.Dom.removeClass(r,"calendar-hide-field");r.style.height="";l.style.height="";this.pinnedFieldsIndex[i]=false;this.saveSettings();this.updateAdditionalBlockState()}.bind(this),300)}}},{key:"fieldIsPinned",value:function e(t){return this.pinnedFieldsIndex[t]}},{key:"getPlaceholders",value:function e(){if(!this.placeHolders){this.placeHolders={};this.placeHoldersAdditional={};var t,i,n=this.DOM.formWrap.querySelectorAll(".calendar-field-additional-placeholder");for(t=0;t<n.length;t++){i=n[t].getAttribute("data-bx-block-placeholer");if(i){this.placeHoldersAdditional[i]=n[t]}}n=this.DOM.formWrap.querySelectorAll(".calendar-field-placeholder");for(t=0;t<n.length;t++){i=n[t].getAttribute("data-bx-block-placeholer");if(i){this.placeHolders[i]=n[t]}}}return[this.placeHolders,this.placeHoldersAdditional]}},{key:"getSettings",value:function e(t){this.pinnedFieldsIndex={};var i,n=[];for(i in t.pinnedFields){if(t.pinnedFields.hasOwnProperty(i)){n.push(t.pinnedFields[i]);this.pinnedFieldsIndex[t.pinnedFields[i]]=true}}t.pinnedFields=n;return t}},{key:"saveSettings",value:function e(){var t,i=[];for(t in this.pinnedFieldsIndex){if(this.pinnedFieldsIndex.hasOwnProperty(t)&&this.pinnedFieldsIndex[t]){i.push(t)}}this.formSettings.pinnedFields=i;this.BX.userOptions.save("calendar",this.formType,"pinnedFields",i)}},{key:"updateAdditionalBlockState",value:function e(i){var n=this;if(i!==false){if(this.updateAdditionalBlockTimeout){clearTimeout(this.updateAdditionalBlockTimeout);this.updateAdditionalBlockTimeout=null}this.updateAdditionalBlockTimeout=setTimeout(function(){n.updateAdditionalBlockState(false)},300)}else{var s,o=this.DOM.additionalBlock.getElementsByClassName("js-calendar-field-name");t.Dom.clean(this.DOM.pinnedNamesWrap);for(s=0;s<o.length;s++){this.DOM.pinnedNamesWrap.appendChild(t.Dom.create("SPAN",{props:{className:"calendar-additional-alt-promo-text"},html:o[s].innerHTML}))}if(!o.length){t.Dom.addClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}else if(t.Dom.hasClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")){t.Dom.removeClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}this.checkLastItemBorder()}}},{key:"checkLastItemBorder",value:function e(){var i="no-border",n,s;s=this.DOM.mainBlock.querySelectorAll(".calendar-options-item-border");for(n=0;n<s.length;n++){if(n===s.length-1){t.Dom.addClass(s[n],i)}else{t.Dom.removeClass(s[n],i)}}s=this.DOM.additionalBlock.querySelectorAll(".calendar-options-item-border");for(n=0;n<s.length;n++){if(n===s.length-1){t.Dom.addClass(s[n],i)}else{t.Dom.removeClass(s[n],i)}}}},{key:"handlePlannerSelectorChanges",value:function e(t){if(t instanceof a.BaseEvent){var i=t.getData();this.dateTimeControl.setValue({from:i.dateFrom,to:i.dateTo})}}},{key:"checkPlannerState",value:function e(){var t=this.dateTimeControl.getValue();this.loadPlannerData({codes:this.userSelector.getCodes(),from:n.Util.formatDate(t.from.getTime()-n.Util.getDayLength()*3),to:n.Util.formatDate(t.to.getTime()+n.Util.getDayLength()*10),timezone:t.timezoneFrom,location:this.locationSelector.getTextValue()})}},{key:"updatePlanner",value:function e(i){if(!i){i={}}this.BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{entry_id:this.entry.id||0,codes:i.codes||[],date_from:i.from||"",date_to:i.to||"",timezone:i.timezone||"",location:i.location||"",entries:i.entrieIds||false}}).then(function(e){var n,s=[],o={},a=e.data.entries,r=e.data.accessibility,l=!!(i.entries||a&&a.length>0);if(t.Type.isArray(a)){for(n=0;n<a.length;n++){if(a[n].type==="user"){s.push({id:a[n].id,name:a[n].name,avatar:a[n].avatar,smallAvatar:a[n].smallAvatar||a[n].avatar,url:a[n].url});o[a[n].id]=true}}}if(l){var d={};if(i.entries){a=i.entries;d.scaleFrom=i.from;d.scaleTo=i.to}d.loadedDataFrom=i.from;d.loadedDataTo=i.to;d.data={entries:a,accessibility:r};d.focusSelector=i.focusSelector===undefined?false:i.focusSelector;this.refreshPlanner(d)}}.bind(this),function(e){}.bind(this))}},{key:"refreshPlanner",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var s=this.dateTimeControl.getValue();var o=s.from,a=s.to,r={},l,d;if(t.Type.isDate(o)&&t.Type.isDate(a)&&o.getTime()<=a.getTime()){t.Dom.addClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown");if(!this.plannerIsShown()&&i.show||i.focusSelector===undefined){i.focusSelector=true}if(s.fullDay){l=i.scaleFrom||new Date(o.getTime()-n.Util.getDayLength()*3);d=i.scaleTo||new Date(l.getTime()+n.Util.getDayLength()*10);r.scaleType="1day";r.scaleDateFrom=l;r.scaleDateTo=d;r.adjustCellWidth=false}else{r.changeFromFullDay={scaleType:"1hour",timelineCellWidth:40}}r.entriesListWidth=this.DOM.attendeesTitle.offsetWidth+16;r.width=this.DOM.plannerWrap.offsetWidth;if(this.DOM.moreOuterWrap){this.DOM.moreOuterWrap.style.paddingLeft=r.entriesListWidth+"px"}var h=false;this.BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,config:r,focusSelector:i.focusSelector,selector:{from:o,to:a,fullDay:s.fullDay,RRULE:h,animation:true,updateScaleLimits:true},data:i.data||false,loadedDataFrom:i.loadedDataFrom,loadedDataTo:i.loadedDataTo,show:true}])}}},{key:"plannerIsShown",value:function e(){return this.DOM.plannerWrap&&t.Dom.hasClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown")}},{key:"keyHandler",value:function e(t){if((t.ctrlKey||t.metaKey)&&!t.altKey&&t.keyCode===n.Util.getKeyCode("enter")){this.save()}}},{key:"showError",value:function e(i){var s=this;var o="";if(t.Type.isArray(i)){i.forEach(function(e){if(e.code==="edit_entry_location_busy"){return n.Util.showFieldError(e.message,s.DOM.locationWrap,{clearTimeout:1e4})}o+=e.message+"\n"})}if(o!==""){alert(o)}}},{key:"checkForSignificantChanges",value:function e(){return true;var t=false;if(!t&&this.entry.name!==this.DOM.form.name.value)t=true;if(!t&&this.descriptionValue!==this.DOM.form.desc.value)t=true;if(!t&&this.entry.data.LOCATION!==this.DOM.form.lo_cation.value)t=true;if(!t&&this.entry.isFullDay()!=this.DOM.form.skip_time.checked)t=true;if(!t){var i=BX.parseDate(this.entry.data.DATE_FROM),n=new Date(i.getTime()+(this.entry.data.DT_LENGTH-(this.entry.isFullDay()?1:0))*1e3);if(Math.abs(i.getTime()-this.fromDate.getTime())>1e3||Math.abs(n.getTime()-this.toDate.getTime())>1e3)t=true;if(!t&&!this.entry.isFullDay()&&(this.entry.data.TZ_FROM!==this.DOM.form.tz_from.value||this.entry.data.TZ_TO!==this.DOM.form.tz_to.value)){t=true}}if(!t&&this.plannerData&&false){var s,o={};if(this.entry.isMeeting()){var a=this.entry.getAttendees();for(s in a){if(a.hasOwnProperty(s)&&a[s]["ID"]){o[a[s]["ID"]]=true}}}for(s in this.plannerData.entries){if(this.plannerData.entries.hasOwnProperty(s)&&this.plannerData.entries[s].type=="user"&&this.plannerData.entries[s].id){if(o[this.plannerData.entries[s].id]){o[this.plannerData.entries[s].id]="+"}else{t=true;break}}}if(!t&&o){for(s in o){if(o.hasOwnProperty(s)&&o[s]!=="+"){t=true;break}}}}return t}}]);return e}();e.EventEditForm=h})(this.BX.Calendar=this.BX.Calendar||{},BX,BX.Calendar.Controls,BX.Calendar,BX.Calendar,BX.Calendar,BX.Event,BX.Calendar);
//# sourceMappingURL=eventeditform.bundle.map.js