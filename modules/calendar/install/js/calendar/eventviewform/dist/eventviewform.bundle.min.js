this.BX=this.BX||{};(function(e,t,n,i,s,r,a,l){"use strict";var o=function(){function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"permissions",{});babelHelpers.defineProperty(this,"name","eventviewform");babelHelpers.defineProperty(this,"uid",null);babelHelpers.defineProperty(this,"DOM",{});babelHelpers.defineProperty(this,"RELOAD_REQUESTED","RELOAD_REQUESTED");babelHelpers.defineProperty(this,"RELOAD_FINISHED","RELOAD_FINISHED");babelHelpers.defineProperty(this,"reloadStatus",null);babelHelpers.defineProperty(this,"entityChanged",false);babelHelpers.defineProperty(this,"LOAD_DELAY",500);this.type=i.type||"user";this.ownerId=i.ownerId||0;this.userId=i.userId||0;this.zIndex=3100;this.entryId=i.entryId||null;this.calendarContext=i.calendarContext||null;this.entryDateFrom=i.entryDateFrom||null;this.timezoneOffset=i.timezoneOffset||null;this.BX=t.Util.getBX();this.sliderOnLoad=this.onLoadSlider.bind(this);this.handlePullBind=this.handlePull.bind(this);this.keyHandlerBind=this.keyHandler.bind(this);this.destroyBind=this.destroy.bind(this);this.loadPlannerDataDebounce=n.Runtime.debounce(this.loadPlannerData,this.LOAD_DELAY,this);this.reloadSliderDebounce=n.Runtime.debounce(this.reloadSlider,this.LOAD_DELAY,this);this.pullEventList=new Set}babelHelpers.createClass(e,[{key:"initInSlider",value:function e(t,i){this.slider=t;r.EventEmitter.subscribe(t,"SidePanel.Slider:onLoad",this.sliderOnLoad);r.EventEmitter.subscribe(t,"SidePanel.Slider:onCloseComplete",this.destroyBind);n.Event.bind(document,"keydown",this.keyHandlerBind);n.Event.bind(document,"visibilitychange",this.handleVisibilityChange.bind(this));r.EventEmitter.subscribe("onPullEvent-calendar",this.handlePullBind);this.createContent(t).then(function(e){if(n.Type.isFunction(i)){i(e)}}.bind(this));this.opened=true}},{key:"isOpened",value:function e(){return this.opened}},{key:"destroy",value:function e(){r.EventEmitter.unsubscribe(this.slider,"SidePanel.Slider:onLoad",this.sliderOnLoad);r.EventEmitter.unsubscribe(this.slider,"SidePanel.Slider:onCloseComplete",this.destroyBind);r.EventEmitter.unsubscribe("onPullEvent-calendar",this.handlePullBind);n.Event.unbind(document,"keydown",this.keyHandlerBind);if(this.intranetControllButton&&this.intranetControllButton.destroy){this.intranetControllButton.destroy()}t.Util.closeAllPopups();this.opened=false}},{key:"onLoadSlider",value:function e(t){var i;if(!t instanceof r.BaseEvent){return}var s=t.getData();var a=(i=s[0])===null||i===void 0?void 0:i.slider;this.DOM.content=a.layout.content;this.BX.html(a.layout.content,a.getData().get("sliderContent"));if(!n.Type.isNull(this.uid)){this.initControls(this.uid)}this.reloadStatus=this.RELOAD_FINISHED}},{key:"createContent",value:function e(i){var s=this;return new Promise((function(e){s.BX.ajax.runAction("calendar.api.calendarajax.getViewEventSlider",{analyticsLabel:{calendarAction:"view_event",formType:"full"},data:{entryId:s.entryId,dateFrom:t.Util.formatDate(s.entryDateFrom),timezoneOffset:s.timezoneOffset}}).then((function(t){var r="";if(n.Type.isFunction(i.isOpen)&&i.isOpen()||i.isOpen===true){r=t.data.html;i.getData().set("sliderContent",r);var a=t.data.additionalParams;s.userId=a.userId;s.uid=a.uniqueId;s.entryUrl=a.entryUrl;s.userTimezone=a.userTimezone;s.dayOfWeekMonthFormat=a.dayOfWeekMonthFormat;s.plannerFeatureEnabled=!!a.plannerFeatureEnabled;if(s.planner&&!s.plannerFeatureEnabled){s.planner.lock()}s.handleEntryData(a.entry,a.userIndex,a.section)}e(r)}),(function(t){if(t.errors&&t.errors.length){i.getData().set("sliderContent",'<div class="calendar-slider-alert">'+'<div class="calendar-slider-alert-inner">'+'<div class="calendar-slider-alert-img"></div>'+'<h1 class="calendar-slider-alert-text">'+n.Text.encode(t.errors[0].message)+"</h1>"+"</div>"+"</div>")}s.displayError(t.errors);e(t)}))}))}},{key:"initControls",value:function e(s){var a=this,o,d;this.DOM.title=this.DOM.content.querySelector("#".concat(s,"_title"));this.DOM.buttonSet=this.DOM.content.querySelector("#".concat(s,"_buttonset"));this.DOM.editButton=this.DOM.content.querySelector("#".concat(s,"_but_edit"));this.DOM.delButton=this.DOM.content.querySelector("#".concat(s,"_but_del"));this.DOM.sidebarInner=this.DOM.content.querySelector("#".concat(s,"_sidebar_inner"));if(this.DOM.buttonSet){this.initPlannerControl(s);this.initUserListControl(s)}var u=this.DOM.content.querySelector("#".concat(s,"_time_inner_wrap"));if(n.Type.isElementNode(u)&&u.offsetHeight>50){n.Dom.addClass(this.DOM.content.querySelector("#".concat(s,"_time_wrap")),"calendar-slider-sidebar-head-long-time")}if(this.canDo(this.entry,"edit")&&this.DOM.editButton){n.Event.bind(this.DOM.editButton,"click",(function(){a.BX.SidePanel.Instance.close(false,function(){i.EntryManager.openEditSlider({entry:this.entry,type:this.type,ownerId:this.ownerId,userId:this.userId})}.bind(a))}))}else{this.BX.remove(this.DOM.editButton)}if(this.DOM.sidebarInner){this.DOM.reminderWrap=this.DOM.sidebarInner.querySelector(".calendar-slider-sidebar-remind-wrap");if(n.Type.isDomNode(this.DOM.reminderWrap)){var h=!this.canDo(this.entry,"edit")&&this.entry.getCurrentStatus()===false;this.reminderControl=new this.BX.Calendar.Controls.Reminder({wrap:this.DOM.reminderWrap,zIndex:this.zIndex,viewMode:h});this.reminderControl.setValue(this.entry.getReminders());if(!h){this.reminderControl.subscribe("onChange",(function(e){if(e instanceof r.BaseEvent){a.handleEntityChanges();a.reminderValues=e.getData().values;a.BX.ajax.runAction("calendar.api.calendarajax.updateReminders",{data:{entryId:a.entry.id,userId:a.userId,reminders:a.reminderValues}})}}))}}var c=this.DOM.sidebarInner.querySelectorAll(".calendar-slider-sidebar-border-bottom");if(c.length>=2){this.BX.removeClass(c[c.length-1],"calendar-slider-sidebar-border-bottom")}}if(this.canDo(this.entry,"delete")){n.Event.bind(this.DOM.delButton,"click",(function(){r.EventEmitter.subscribeOnce("BX.Calendar.Entry:beforeDelete",(function(){a.BX.SidePanel.Instance.close()}));i.EntryManager.deleteEntry(a.entry,a.calendarContext)}))}else{this.BX.remove(this.DOM.delButton)}this.BX.viewElementBind(s+"_"+this.entry.id+"_files_wrap",{showTitle:true},(function(e){return n.Type.isElementNode(e)&&(e.getAttribute("data-bx-viewer")||e.getAttribute("data-bx-image"))}));if(this.entry&&this.entry.isMeeting()){this.initAcceptMeetingControl(s)}if(this.DOM.sidebarInner){var p=this.DOM.sidebarInner.querySelectorAll(".calendar-slider-sidebar-border-bottom");if(p.length>=2){this.BX.removeClass(p[p.length-1],"calendar-slider-sidebar-border-bottom")}}this.DOM.copyButton=this.DOM.content.querySelector("#".concat(s,"_copy_url_btn"));if(this.DOM.copyButton){n.Event.bind(this.DOM.copyButton,"click",this.copyEventUrl.bind(this))}this.DOM.videoCall=this.DOM.sidebarInner.querySelector(".calendar-slider-sidebar-videocall");if((o=BX)!==null&&o!==void 0&&(d=o.Intranet)!==null&&d!==void 0&&d.ControlButton&&n.Type.isElementNode(this.DOM.videoCall)&&this.entry.getCurrentStatus()!==false){this.DOM.videoCall.style.display="";this.intranetControllButton=new l.ControlButton({container:this.DOM.videoCall,entityType:"calendar_event",entityId:this.entry.parentId,entityData:{dateFrom:t.Util.formatDate(this.entry.from),parentId:this.entry.parentId},analyticsLabel:{formType:"full"}})}}},{key:"handleEntryData",value:function e(t,s,r){this.entry=new i.Entry({data:t,userIndex:s});if(n.Type.isPlainObject(r)){this.permissions=r.PERM}i.EntryManager.registerEntrySlider(this.entry,this)}},{key:"initPlannerControl",value:function e(t){var i=this;this.plannerId=t+"_view_slider_planner";this.DOM.plannerWrapOuter=this.DOM.content.querySelector(".calendar-slider-detail-timeline");this.DOM.plannerWrap=this.DOM.plannerWrapOuter.querySelector(".calendar-view-planner-wrap");this.planner=new a.Planner({wrap:this.DOM.plannerWrap,minWidth:parseInt(this.DOM.plannerWrap.offsetWidth),solidStatus:true,readonly:true,locked:!this.plannerFeatureEnabled,dayOfWeekMonthFormat:this.dayOfWeekMonthFormat});this.planner.show();this.planner.showLoader();setTimeout((function(){if(i.DOM.plannerWrapOuter){n.Dom.removeClass(i.DOM.plannerWrapOuter,"hidden")}}),500);this.loadPlannerDataDebounce()}},{key:"initUserListControl",value:function e(t){var i=this;var s={y:[],i:[],q:[],n:[]};if(this.entry.isMeeting()){this.entry.getAttendees().forEach((function(e){if(e.STATUS==="H"){s.y.push(e)}else if(s[e.STATUS.toLowerCase()]){s[e.STATUS.toLowerCase()].push(e)}}),this)}this.DOM.attendeesListY=this.DOM.content.querySelector("#".concat(t,"_attendees_y"));this.DOM.attendeesListN=this.DOM.content.querySelector("#".concat(t,"_attendees_n"));this.DOM.attendeesListQ=this.DOM.content.querySelector("#".concat(t,"_attendees_q"));this.DOM.attendeesListI=this.DOM.content.querySelector("#".concat(t,"_attendees_i"));n.Event.bind(this.DOM.attendeesListY,"click",(function(){i.showUserListPopup(i.DOM.attendeesListY,s.y)}));n.Event.bind(this.DOM.attendeesListN,"click",(function(){i.showUserListPopup(i.DOM.attendeesListN,s.n)}));n.Event.bind(this.DOM.attendeesListQ,"click",(function(){i.showUserListPopup(i.DOM.attendeesListQ,s.q)}));n.Event.bind(this.DOM.attendeesListI,"click",(function(){i.showUserListPopup(i.DOM.attendeesListI,s.i)}))}},{key:"showUserListPopup",value:function e(t,n){var i=this;if(this.userListPopup){this.userListPopup.close()}if(n&&n.length){this.DOM.userListPopupWrap=this.BX.create("DIV",{props:{className:"calendar-user-list-popup-block"}});n.forEach((function(e){var t=this.DOM.userListPopupWrap.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-container calendar-slider-sidebar-user-card"}}));t.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-avatar"}})).appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-item"}})).appendChild(this.BX.create("IMG",{props:{width:34,height:34,src:e.AVATAR}}));t.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-info"}})).appendChild(this.BX.create("A",{props:{href:e.URL?e.URL:"#",className:"calendar-slider-sidebar-user-info-name"},text:e.DISPLAY_NAME}))}),this);this.userListPopup=this.BX.PopupWindowManager.create("user-list-popup-"+Math.random(),t,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,resizable:false,lightShadow:true,content:this.DOM.userListPopupWrap,className:"calendar-user-list-popup",zIndex:4e3});this.userListPopup.setAngle({offset:36});this.userListPopup.show();this.BX.addCustomEvent(this.userListPopup,"onPopupClose",(function(){i.userListPopup.destroy()}))}}},{key:"initAcceptMeetingControl",value:function e(t){var a=this;this.DOM.statusButtonset=this.DOM.content.querySelector("#".concat(t,"_status_buttonset"));this.DOM.statusButtonset.style.marginRight="12px";if(this.entry.getCurrentStatus()==="H"||this.entry.getCurrentStatus()===false){n.Dom.remove(this.DOM.statusButtonset)}else{this.statusControl=new s.MeetingStatusControl({wrap:this.DOM.statusButtonset,currentStatus:this.DOM.content.querySelector("#".concat(t,"_current_status")).value||this.entry.getCurrentStatus()});this.statusControl.subscribe("onSetStatus",(function(e){if(e instanceof r.BaseEvent){a.handleEntityChanges();i.EntryManager.setMeetingStatus(a.entry,e.getData().status).then((function(){a.statusControl.setStatus(a.entry.getCurrentStatus(),false);a.statusControl.updateStatus()}))}}))}}},{key:"copyEventUrl",value:function e(){if(!this.entryUrl||!this.BX.clipboard.copy(this.entryUrl)){return}this.timeoutIds=this.timeoutIds||[];var t=new this.BX.PopupWindow("calendar_clipboard_copy",this.DOM.copyButton,{content:n.Loc.getMessage("CALENDAR_TIP_TEMPLATE_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,offsetLeft:20,cachable:false});t.show();var i;while(i=this.timeoutIds.pop()){clearTimeout(i)}this.timeoutIds.push(setTimeout((function(){t.close()}),1500))}},{key:"displayError",value:function e(){}},{key:"canDo",value:function e(t,n){if(n==="edit"||n==="delete"){if(t.isResourcebooking()){return false}return this.permissions.edit}if(n==="view"){return this.permissions.view_full}return false}},{key:"plannerIsShown",value:function e(){return this.DOM.plannerWrap&&n.Dom.hasClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown")}},{key:"loadPlannerData",value:function e(){var n=this;this.planner.showLoader();return new Promise((function(e){n.BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{entryId:n.entry.id||0,entryLocation:n.entry.data.LOCATION||"",ownerId:n.ownerId,hostId:n.entry.getMeetingHost(),type:n.type,entityList:n.entry.getAttendeesEntityList(),dateFrom:t.Util.formatDate(n.entry.from.getTime()-t.Util.getDayLength()*3),dateTo:t.Util.formatDate(n.entry.to.getTime()+t.Util.getDayLength()*10),timezone:n.userTimezone,location:n.entry.getLocation()}}).then((function(i){n.planner.hideLoader();n.planner.update(i.data.entries,i.data.accessibility);n.planner.updateSelector(t.Util.adjustDateForTimezoneOffset(n.entry.from,n.entry.userTimezoneOffsetFrom,n.entry.fullDay),t.Util.adjustDateForTimezoneOffset(n.entry.to,n.entry.userTimezoneOffsetTo,n.entry.fullDay),n.entry.fullDay);e(i)}),(function(t){e(t)}))}))}},{key:"keyHandler",value:function e(s){var a=this;if(s.keyCode===t.Util.getKeyCode("delete")&&this.canDo(this.entry,"delete")){var l=event.target||event.srcElement;var o=n.Type.isElementNode(l)?l.tagName.toLowerCase():null;if(o&&!["input","textarea"].includes(o)){r.EventEmitter.subscribeOnce("BX.Calendar.Entry:beforeDelete",(function(){a.BX.SidePanel.Instance.close()}));i.EntryManager.deleteEntry(this.entry,this.calendarContext)}}}},{key:"handlePull",value:function e(n){if(!n instanceof r.BaseEvent){return}var i=n.getData();var s=i[0];if(BX.Calendar.Util.documentIsDisplayingNow()){switch(s){case"edit_event":case"delete_event":case"set_meeting_status":var a=t.Util.getCalendarContext();if(a){if(this.planner&&this.reloadStatus===this.RELOAD_FINISHED){this.loadPlannerDataDebounce()}}else{this.reloadSliderDebounce()}break}}else{var l={command:s};if(this.pullEventList.has(l)){this.pullEventList["delete"](l)}this.pullEventList.add(l)}}},{key:"handleVisibilityChange",value:function e(){var n=this;if(this.pullEventList.size){this.pullEventList.forEach((function(e,i,s){if(["edit_event","delete_event","set_meeting_status"].includes(e.command)){if(!t.Util.getCalendarContext()){n.reloadSliderDebounce()}}}));this.pullEventList.clear()}}},{key:"handleEntityChanges",value:function e(){this.entityChanged=true}},{key:"reloadSlider",value:function e(){var t=this;if(this.reloadStatus===this.RELOAD_FINISHED){var i=document.activeElement;if(["IFRAME","TEXTAREA"].includes(i.tagName.toUpperCase())){return}if(this.entityChanged){setTimeout((function(){t.entityChanged=false}),500);return}r.EventEmitter.unsubscribe(this.slider,"SidePanel.Slider:onLoad",this.sliderOnLoad);r.EventEmitter.unsubscribe(this.slider,"SidePanel.Slider:onCloseComplete",this.destroyBind);r.EventEmitter.unsubscribe("onPullEvent-calendar",this.handlePullBind);n.Event.unbind(document,"keydown",this.keyHandlerBind);this.reloadStatus=this.RELOAD_REQUESTED;this.slider.reload()}}}]);return e}();e.EventViewForm=o})(this.BX.Calendar=this.BX.Calendar||{},BX.Calendar,BX,BX.Calendar,BX.Calendar.Controls,BX.Event,BX.Calendar,BX.Intranet);
//# sourceMappingURL=eventviewform.bundle.map.js