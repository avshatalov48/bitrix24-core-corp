{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Dom, Tag, Type, Runtime, Text, Event} from 'main.core';\nimport { Util } from 'calendar.util';\nimport { EventEmitter } from 'main.core.events';\n\nclass NextEventList\n{\n\tDOM = {};\n\n\tconstructor(options = {})\n\t{\n\t\tthis.maxEntryAmount = options.maxEntryAmount || 5;\n\t\tif (options && options.entries)\n\t\t{\n\t\t\tthis.renderList(options.entries);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.displayEventList();\n\t\t}\n\n\t\tthis.displayEventListDebounce = Runtime.debounce(this.displayEventList, 3000, this);\n\n\t\tEvent.bind(document, 'visibilitychange', this.checkDisplayEventList.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onCloseComplete', this.checkDisplayEventList.bind(this));\n\n\t\tEventEmitter.subscribe('onPullEvent-calendar', this.displayEventListDebounce);\n\t}\n\n\tcheckDisplayEventList()\n\t{\n\t\tif (this.needReload)\n\t\t{\n\t\t\tthis.displayEventListDebounce();\n\t\t}\n\t}\n\n\tdisplayEventList()\n\t{\n\t\tif (this.isDisplayingNow())\n\t\t{\n\t\t\tthis.showLoader();\n\t\t\tthis.getEventList()\n\t\t\t\t.then((entryList) => {\n\t\t\t\t\tthis.hideLoader();\n\t\t\t\t\tthis.renderList(entryList);\n\t\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.needReload = true;\n\t\t}\n\t}\n\n\tgetEventList()\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tBX.ajax.runAction('calendar.api.calendarentryajax.getnearestevents', {\n\t\t\t\tdata: {\n\t\t\t\t\townerId: this.ownerId,\n\t\t\t\t\ttype: this.type,\n\t\t\t\t\tfutureDaysAmount: 60,\n\t\t\t\t\tmaxEntryAmount: this.maxEntryAmount\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then((response) => {\n\t\t\t\tresolve(response?.data?.entries);\n\t\t\t});\n\t\t});\n\t}\n\n\tshowWidget()\n\t{\n\t\tthis.getOuterWrap().style.display = '';\n\t}\n\n\thideWidget()\n\t{\n\t\tthis.getOuterWrap().style.display = 'none';\n\t}\n\n\tshowLoader()\n\t{\n\t\tthis.hideLoader();\n\t\tthis.DOM.loader = this.getEventListWrap()\n\t\t\t.appendChild(Util.getLoader(40, 'next-events-loader'));\n\t}\n\n\thideLoader()\n\t{\n\t\tif(Type.isDomNode(this.DOM.loader))\n\t\t{\n\t\t\tDom.remove(this.DOM.loader);\n\t\t}\n\t}\n\n\trenderList(entryList = [])\n\t{\n\t\tif (!Type.isArray(entryList))\n\t\t{\n\t\t\tentryList = [];\n\t\t}\n\n\t\tentryList = entryList.slice(0, this.maxEntryAmount);\n\n\t\tDom.clean(this.getEventListWrap());\n\n\t\tconst wrap = this.getEventListWrap();\n\t\tentryList.forEach((entry, i) => {\n\t\t\tif (i === 0)\n\t\t\t{\n\t\t\t\tthis.setReloadTimeout(entry);\n\t\t\t}\n\n\t\t\twrap.appendChild(this.renderEntry(entry));\n\t\t});\n\n\t\tif (entryList.length)\n\t\t{\n\t\t\tthis.showWidget();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.hideWidget();\n\t\t}\n\n\t\tthis.needReload = false;\n\t}\n\n\trenderEntry(entry)\n\t{\n\t\tconst fromDate = BX.Calendar.Util.parseDate(entry['DATE_FROM']);\n\n\t\treturn Tag.render`\n\t\t\t<a href=\"${Text.encode(entry['~URL'])}\" class=\"sidebar-widget-item\">\n\t\t\t\t<span class=\"calendar-item-date\">${entry['~FROM_TO_HTML']}</span>\n\t\t\t\t<span class=\"calendar-item-text\">\n\t\t\t\t\t<span class=\"calendar-item-link\">${Text.encode(entry['NAME'])}</span>\n\t\t\t\t</span>\n\t\t\t\t<span class=\"calendar-item-icon\">\n\t\t\t\t\t<span class=\"calendar-item-icon-day\">${Text.encode(entry['~WEEK_DAY'])}</span>\n\t\t\t\t\t<span class=\"calendar-item-icon-date\">${fromDate.getDate()}</span>\n\t\t\t\t</span>\n\t\t\t</a>\n\t\t`;\n\t}\n\n\tgetOuterWrap()\n\t{\n\t\tif (!this.DOM.outerWrap)\n\t\t{\n\t\t\tthis.DOM.outerWrap = document.querySelector('.sidebar-widget.sidebar-widget-calendar');\n\t\t}\n\t\treturn this.DOM.outerWrap;\n\t}\n\n\tgetEventListWrap()\n\t{\n\t\tif (!this.DOM.listWrap)\n\t\t{\n\t\t\tthis.DOM.listWrap = this.getOuterWrap().querySelector('.calendar-events-wrap');\n\t\t}\n\t\treturn this.DOM.listWrap;\n\t}\n\n\tsetReloadTimeout(entry)\n\t{\n\t\tif (this.reloadTimeout)\n\t\t{\n\t\t\tclearTimeout(this.reloadTimeout);\n\t\t\tthis.reloadTimeout = null;\n\t\t}\n\n\t\tconst finishEventDate = BX.Calendar.Util.parseDate(entry['DATE_TO']);\n\t\tif (Type.isDate(finishEventDate))\n\t\t{\n\t\t\tconst currentDate = new Date();\n\t\t\tconst offset = Math.min(\n\t\t\t\tMath.max(\n\t\t\t\t\tfinishEventDate.getTime() - currentDate.getTime() + 60000,\n\t\t\t\t\t60000),\n\t\t\t\t86400000\n\t\t\t);\n\n\t\t\tthis.reloadTimeout = setTimeout(this.displayEventList.bind(this), offset);\n\t\t}\n\t}\n\n\tisDisplayingNow()\n\t{\n\t\treturn !document.hidden && !BX.SidePanel.Instance.getOpenSliders().length;\n\t}\n}\n\nReflection.namespace('BX.Calendar').NextEventList = NextEventList;"],"names":["NextEventList","options","maxEntryAmount","entries","renderList","displayEventList","displayEventListDebounce","Runtime","debounce","Event","bind","document","checkDisplayEventList","EventEmitter","subscribe","needReload","isDisplayingNow","showLoader","getEventList","then","entryList","hideLoader","Promise","resolve","BX","ajax","runAction","data","ownerId","type","futureDaysAmount","response","getOuterWrap","style","display","DOM","loader","getEventListWrap","appendChild","Util","getLoader","Type","isDomNode","Dom","remove","isArray","slice","clean","wrap","forEach","entry","i","setReloadTimeout","renderEntry","length","showWidget","hideWidget","fromDate","Calendar","parseDate","Tag","render","Text","encode","getDate","outerWrap","querySelector","listWrap","reloadTimeout","clearTimeout","finishEventDate","isDate","currentDate","Date","offset","Math","min","max","getTime","setTimeout","hidden","SidePanel","Instance","getOpenSliders","Reflection","namespace"],"mappings":"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"}