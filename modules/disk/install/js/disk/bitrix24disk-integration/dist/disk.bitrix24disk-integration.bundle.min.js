this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(e,s,i,t,a){"use strict";var l=babelHelpers.classPrivateFieldLooseKey("uid");var r=babelHelpers.classPrivateFieldLooseKey("canUsePull");var o=babelHelpers.classPrivateFieldLooseKey("answerWithPull");var n=babelHelpers.classPrivateFieldLooseKey("answerWithAjax");class c{constructor(e){Object.defineProperty(this,n,{value:u});Object.defineProperty(this,o,{value:d});Object.defineProperty(this,r,{value:b});Object.defineProperty(this,l,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,l)[l]=e}answer(){if(babelHelpers.classPrivateFieldLooseBase(this,r)[r]()){babelHelpers.classPrivateFieldLooseBase(this,o)[o]()}else{babelHelpers.classPrivateFieldLooseBase(this,n)[n]()}}}function b(){return t.Reflection.getClass("BX.PULL.isPublishingEnabled")&&BX.PULL.isPublishingEnabled()&&BX.PULL.isConnected()}function d(){BX.PULL.sendMessage([t.Loc.getMessage("USER_ID")],"disk","bdisk",{status:BXFileStorage.GetStatus().status,uidRequest:babelHelpers.classPrivateFieldLooseBase(this,l)[l]})}function u(){void t.ajax.runAction("disk.documentService.setStatusWorkWithLocalDocument",{data:{status:BXFileStorage.GetStatus().status,uidRequest:babelHelpers.classPrivateFieldLooseBase(this,l)[l]}})}var h=babelHelpers.classPrivateFieldLooseKey("objectId");var p=babelHelpers.classPrivateFieldLooseKey("url");var F=babelHelpers.classPrivateFieldLooseKey("name");var v=babelHelpers.classPrivateFieldLooseKey("handleAppLaunched");var P=babelHelpers.classPrivateFieldLooseKey("appLaunchedNotifyWasShown");class L{constructor({objectId:e,url:s,name:i}){Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,h)[h]=e;babelHelpers.classPrivateFieldLooseBase(this,p)[p]=s;babelHelpers.classPrivateFieldLooseBase(this,F)[F]=i;babelHelpers.classPrivateFieldLooseBase(this,v)[v]=this.handleAppLaunched.bind(this)}getObjectId(){return babelHelpers.classPrivateFieldLooseBase(this,h)[h]}getUrl(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p]}getName(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}subscribeToFileOpen(){void i.DesktopApi.subscribe("BXFileStorageLaunchApp",babelHelpers.classPrivateFieldLooseBase(this,v)[v])}unsubscribeToFileOpen(){babelHelpers.classPrivateFieldLooseBase(this,P)[P]=true;void i.DesktopApi.unsubscribe("BXFileStorageLaunchApp",babelHelpers.classPrivateFieldLooseBase(this,v)[v])}showNotification(e){a.Notifier.notify(e)}handleAppLaunched(e){if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]){return}this.unsubscribeToFileOpen();const s={id:"launchApp",title:e,text:t.Loc.getMessage("JS_B24DISK_LAUNCH_APP_DESCR")};this.showNotification(s)}showOpenNotification(){const e={id:"openFile",title:this.getName(),text:t.Loc.getMessage("JS_B24DISK_FILE_DOWNLOAD_STARTED_DESCR")};this.showNotification(e)}exists(){return new Promise(((e,s)=>{const i=BXFileStorage.FindPathByPartOfId(`|f${this.getObjectId()}`);BXFileStorage.FileExist(i,(t=>{if(t&&i){e(i)}else{s()}}))}))}getDownloadUrl(){return this.getUrl()}run(){this.exists().then((e=>{BXFileStorage.ObjectOpen(e,(()=>{}))})).catch((()=>{if(!this.getUrl()){return}this.showOpenNotification();this.subscribeToFileOpen();this.openFile()}))}openFile(){BXFileStorage.ViewFile(this.getDownloadUrl(),this.getName())}}var B=babelHelpers.classPrivateFieldLooseKey("handleFileUploadFinished");var g=babelHelpers.classPrivateFieldLooseKey("fileUploadFinishedWasShown");class f extends L{constructor({objectId:e,url:s,name:i}){super({objectId:e,url:s,name:i});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,g,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,B)[B]=this.handleFileUploadFinished.bind(this)}getDownloadUrl(){return t.Uri.addParam(this.getUrl(),{editIn:"l",action:"start"})}getUploadUrl(){return t.Uri.addParam(this.getUrl(),{editIn:"l",action:"commit",primaryAction:"commit"})}openFile(){BXFileStorage.EditFile(this.getDownloadUrl(),this.getUploadUrl(),this.getName())}handleFileUploadFinished(){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g]){return}this.unsubscribeToFinishUpload();const e={id:"uploadFinished",title:this.getName(),text:t.Loc.getMessage("JS_B24DISK_FILE_UPLOAD_FINISHED")};this.showNotification(e)}subscribeToFinishUpload(){void i.DesktopApi.subscribe("BXFileStorageSyncStatusFinalFile",babelHelpers.classPrivateFieldLooseBase(this,B)[B])}unsubscribeToFinishUpload(){babelHelpers.classPrivateFieldLooseBase(this,g)[g]=true;void i.DesktopApi.unsubscribe("BXFileStorageSyncStatusFinalFile",babelHelpers.classPrivateFieldLooseBase(this,B)[B])}}const H={openFile:"v2openFile",viewFile:"v2viewFile"};var w=babelHelpers.classPrivateFieldLooseKey("subscribeToBxProtocolEvent");class S{static init(){return new S}constructor(){Object.defineProperty(this,w,{value:U});babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}}function U(){i.DesktopApi.subscribe(s.EventType.desktop.onBxLink,((e,s)=>{const i=s!=null?s:{};Object.entries(i).forEach((([e,s])=>{i[e]=decodeURIComponent(s)}));const{objectId:t,url:a,name:l,uidRequest:r}=i;if(!t&&!a){return}if(r){new c(r).answer()}if(e===H.openFile){const e=new f({objectId:t,url:a,name:l});e.run()}else if(e===H.viewFile){const e=new L({objectId:t,url:a,name:l});e.run()}}))}e.BxLinkHandler=S})(this.BX.Disk.Bitrix24Disk=this.BX.Disk.Bitrix24Disk||{},BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX,BX.UI.NotificationManager);
//# sourceMappingURL=disk.bitrix24disk-integration.bundle.map.js