{"version":3,"file":"disk.bitrix24disk-integration.bundle.js","sources":["../src/responder.js","../src/scenarios/open-read-only-file.js","../src/scenarios/edit-file.js","../src/types.js","../src/bx-link-handler.js"],"sourcesContent":["import { ajax as Ajax, Loc, Reflection } from 'main.core';\n\nexport class Responder\n{\n\t#uid: string;\n\n\tconstructor(uid: string)\n\t{\n\t\tthis.#uid = uid;\n\t}\n\n\tanswer(): void\n\t{\n\t\tif (this.#canUsePull())\n\t\t{\n\t\t\tthis.#answerWithPull();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#answerWithAjax();\n\t\t}\n\t}\n\n\t#canUsePull(): boolean\n\t{\n\t\treturn Reflection.getClass('BX.PULL.isPublishingEnabled') && BX.PULL.isPublishingEnabled() && BX.PULL.isConnected();\n\t}\n\n\t#answerWithPull(): void\n\t{\n\t\tBX.PULL.sendMessage([Loc.getMessage('USER_ID')], 'disk', 'bdisk', {\n\t\t\t// eslint-disable-next-line no-undef\n\t\t\tstatus: BXFileStorage.GetStatus().status,\n\t\t\tuidRequest: this.#uid,\n\t\t});\n\t}\n\n\t#answerWithAjax(): void\n\t{\n\t\tvoid Ajax.runAction('disk.documentService.setStatusWorkWithLocalDocument', {\n\t\t\tdata: {\n\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\tstatus: BXFileStorage.GetStatus().status,\n\t\t\t\tuidRequest: this.#uid,\n\t\t\t},\n\t\t});\n\t}\n}\n","import { DesktopApi } from 'im.v2.lib.desktop-api';\nimport { Loc } from 'main.core';\nimport { Notifier, NotificationOptions } from 'ui.notification-manager';\n\nexport class OpenReadOnlyFile\n{\n\t#objectId: ?number;\n\t#url: string;\n\t#name: string;\n\t#handleAppLaunched: Function;\n\t#appLaunchedNotifyWasShown: boolean = false;\n\n\tconstructor({ objectId, url, name })\n\t{\n\t\tthis.#objectId = objectId;\n\t\tthis.#url = url;\n\t\tthis.#name = name;\n\n\t\tthis.#handleAppLaunched = this.handleAppLaunched.bind(this);\n\t}\n\n\tgetObjectId(): ?number\n\t{\n\t\treturn this.#objectId;\n\t}\n\n\tgetUrl(): string\n\t{\n\t\treturn this.#url;\n\t}\n\n\tgetName(): string\n\t{\n\t\treturn this.#name;\n\t}\n\n\tsubscribeToFileOpen(): void\n\t{\n\t\tvoid DesktopApi.subscribe('BXFileStorageLaunchApp', this.#handleAppLaunched);\n\t}\n\n\tunsubscribeToFileOpen(): void\n\t{\n\t\tthis.#appLaunchedNotifyWasShown = true;\n\t\tvoid DesktopApi.unsubscribe('BXFileStorageLaunchApp', this.#handleAppLaunched);\n\t}\n\n\tshowNotification(options: NotificationOptions): void\n\t{\n\t\tNotifier.notify(options);\n\t}\n\n\thandleAppLaunched(name: string): void\n\t{\n\t\tif (this.#appLaunchedNotifyWasShown)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.unsubscribeToFileOpen();\n\n\t\tconst notificationOptions = {\n\t\t\tid: 'launchApp',\n\t\t\ttitle: name,\n\t\t\ttext: Loc.getMessage('JS_B24DISK_LAUNCH_APP_DESCR'),\n\t\t};\n\n\t\tthis.showNotification(notificationOptions);\n\t}\n\n\tshowOpenNotification(): void\n\t{\n\t\tconst notificationOptions = {\n\t\t\tid: 'openFile',\n\t\t\ttitle: this.getName(),\n\t\t\ttext: Loc.getMessage('JS_B24DISK_FILE_DOWNLOAD_STARTED_DESCR'),\n\t\t};\n\t\tthis.showNotification(notificationOptions);\n\t}\n\n\texists(): Promise\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\t// eslint-disable-next-line no-undef\n\t\t\tconst filePath = BXFileStorage.FindPathByPartOfId(`|f${this.getObjectId()}`);\n\t\t\t// eslint-disable-next-line no-undef\n\t\t\tBXFileStorage.FileExist(filePath, (exist: boolean) => {\n\t\t\t\tif (exist && filePath)\n\t\t\t\t{\n\t\t\t\t\tresolve(filePath);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treject();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tgetDownloadUrl(): string\n\t{\n\t\treturn this.getUrl();\n\t}\n\n\trun(): void\n\t{\n\t\tthis\n\t\t\t.exists()\n\t\t\t.then((filePath) => {\n\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\tBXFileStorage.ObjectOpen(filePath, () => {});\n\t\t\t})\n\t\t\t.catch(() => {\n\t\t\t\tif (!this.getUrl())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.showOpenNotification();\n\t\t\t\tthis.subscribeToFileOpen();\n\n\t\t\t\tthis.openFile();\n\t\t\t});\n\t}\n\n\topenFile(): void\n\t{\n\t\t// eslint-disable-next-line no-undef\n\t\tBXFileStorage.ViewFile(\n\t\t\tthis.getDownloadUrl(),\n\t\t\tthis.getName(),\n\t\t);\n\t}\n}\n","import { DesktopApi } from 'im.v2.lib.desktop-api';\nimport { Loc, Uri } from 'main.core';\nimport { OpenReadOnlyFile } from './open-read-only-file';\n\nexport class EditFile extends OpenReadOnlyFile\n{\n\t#handleFileUploadFinished: Function;\n\t#fileUploadFinishedWasShown: boolean = false;\n\n\tconstructor({ objectId, url, name })\n\t{\n\t\tsuper({ objectId, url, name });\n\n\t\tthis.#handleFileUploadFinished = this.handleFileUploadFinished.bind(this);\n\t}\n\n\tgetDownloadUrl(): string\n\t{\n\t\treturn Uri.addParam(this.getUrl(), {\n\t\t\teditIn: 'l',\n\t\t\taction: 'start',\n\t\t});\n\t}\n\n\tgetUploadUrl(): string\n\t{\n\t\treturn Uri.addParam(this.getUrl(), {\n\t\t\teditIn: 'l',\n\t\t\taction: 'commit',\n\t\t\tprimaryAction: 'commit',\n\t\t});\n\t}\n\n\topenFile(): void\n\t{\n\t\t// eslint-disable-next-line no-undef\n\t\tBXFileStorage.EditFile(\n\t\t\tthis.getDownloadUrl(),\n\t\t\tthis.getUploadUrl(),\n\t\t\tthis.getName(),\n\t\t);\n\t}\n\n\thandleFileUploadFinished(): void\n\t{\n\t\tif (this.#fileUploadFinishedWasShown)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.unsubscribeToFinishUpload();\n\n\t\tconst notificationOptions = {\n\t\t\tid: 'uploadFinished',\n\t\t\ttitle: this.getName(),\n\t\t\ttext: Loc.getMessage('JS_B24DISK_FILE_UPLOAD_FINISHED'),\n\t\t};\n\n\t\tthis.showNotification(notificationOptions);\n\t}\n\n\tsubscribeToFinishUpload(): void\n\t{\n\t\tvoid DesktopApi.subscribe('BXFileStorageSyncStatusFinalFile', this.#handleFileUploadFinished);\n\t}\n\n\tunsubscribeToFinishUpload(): void\n\t{\n\t\tthis.#fileUploadFinishedWasShown = true;\n\t\tvoid DesktopApi.unsubscribe('BXFileStorageSyncStatusFinalFile', this.#handleFileUploadFinished);\n\t}\n}\n","export const Command = {\n\topenFile: 'v2openFile',\n\tviewFile: 'v2viewFile',\n};\n","import { EventType } from 'im.v2.const';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\nimport { Responder } from './responder';\nimport { EditFile } from './scenarios/edit-file';\nimport { OpenReadOnlyFile } from './scenarios/open-read-only-file';\nimport { Command } from './types';\n\nexport class BxLinkHandler\n{\n\tstatic init(): BxLinkHandler\n\t{\n\t\treturn new BxLinkHandler();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#subscribeToBxProtocolEvent();\n\t}\n\n\t#subscribeToBxProtocolEvent(): void\n\t{\n\t\tDesktopApi.subscribe(EventType.desktop.onBxLink, (command: $Keys<typeof Command>, rawParams) => {\n\t\t\tconst params = rawParams ?? {};\n\n\t\t\tObject.entries(params).forEach(([key, value]) => {\n\t\t\t\tparams[key] = decodeURIComponent(value);\n\t\t\t});\n\n\t\t\tconst { objectId, url, name, uidRequest } = params;\n\t\t\tif (!objectId && !url)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (uidRequest)\n\t\t\t{\n\t\t\t\t(new Responder(uidRequest)).answer();\n\t\t\t}\n\n\t\t\tif (command === Command.openFile)\n\t\t\t{\n\t\t\t\tconst editFileScenario = new EditFile({ objectId, url, name });\n\t\t\t\teditFileScenario.run();\n\t\t\t}\n\t\t\telse if (command === Command.viewFile)\n\t\t\t{\n\t\t\t\tconst readOnlyFileScenario = new OpenReadOnlyFile({ objectId, url, name });\n\t\t\t\treadOnlyFileScenario.run();\n\t\t\t}\n\t\t});\n\t}\n}\n"],"names":["Responder","constructor","uid","answer","Reflection","getClass","BX","PULL","isPublishingEnabled","isConnected","sendMessage","Loc","getMessage","status","BXFileStorage","GetStatus","uidRequest","Ajax","runAction","data","OpenReadOnlyFile","objectId","url","name","handleAppLaunched","bind","getObjectId","getUrl","getName","subscribeToFileOpen","DesktopApi","subscribe","unsubscribeToFileOpen","unsubscribe","showNotification","options","Notifier","notify","notificationOptions","id","title","text","showOpenNotification","exists","Promise","resolve","reject","filePath","FindPathByPartOfId","FileExist","exist","getDownloadUrl","run","then","ObjectOpen","catch","openFile","ViewFile","EditFile","handleFileUploadFinished","Uri","addParam","editIn","action","getUploadUrl","primaryAction","unsubscribeToFinishUpload","subscribeToFinishUpload","Command","viewFile","BxLinkHandler","init","EventType","desktop","onBxLink","command","rawParams","params","Object","entries","forEach","key","value","decodeURIComponent","editFileScenario","readOnlyFileScenario"],"mappings":"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"}