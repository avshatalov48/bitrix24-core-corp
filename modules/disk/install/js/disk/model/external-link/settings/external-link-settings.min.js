(function(){"use strict";BX.namespace("BX.Disk.Model.ExternalLink");BX.Disk.Model.ExternalLink.Settings=function(t){BX.Disk.Model.Item.apply(this,arguments);this.templateId=this.templateId||"external-link-setting-popup";this.initNewState()};BX.Disk.Model.ExternalLink.Settings.prototype={__proto__:BX.Disk.Model.Item.prototype,constructor:BX.Disk.Model.ExternalLink.Settings,getDefaultStateValues:function(){return{defaultValueForTime:10,getFormattedDeathTime:this.getFormattedDeathTime.bind(this)}},initNewState:function(){this.newState={};this.newState.deathTimeFactor=60;this.newState.deathTimeTimestamp=Math.floor(Date.now()/1e3)+this.newState.deathTimeFactor*this.state.defaultValueForTime},bindEvents:function(){var t=this.getContainer();var e=this.getEntity(t,"public-link-setting-checkbox-time-limit");var i=this.getEntity(t,"public-link-setting-checkbox-password");var a=this.getEntity(t,"public-link-setting-checkbox-can-edit");var n=this.getEntity(t,"public-link-setting-popup-password-show");var s=this.getEntity(t,"public-link-setting-popup-dropdown");var h=this.getEntity(this.getContainer(),"public-link-setting-popup-input-password");var d=this.getEntity(this.getContainer(),"public-link-setting-popup-input");BX.bind(e,"click",this.handleStateTimeInputBlock.bind(this));BX.bind(i,"click",this.handleStatePasswordInputBlock.bind(this));BX.bind(a,"click",this.handleStateCanEdit.bind(this));BX.bind(n,"mousedown",this.handleStatePasswordInput.bind(this));BX.bind(n,"mouseup",this.handleStatePasswordInput.bind(this));BX.bind(s,"click",this.showAccessTypePopup.bind(this));BX.bind(h,"bxchange",this.handlePasswordValue.bind(this));BX.bind(d,"bxchange",this.handleDeathTimeValue.bind(this))},save:function(t){var e=function(e){e.newState={};e.initNewState();BX.onCustomEvent("Disk.ExternalLink.Settings:onSave",[e]);t&&t(e.state,e)};if(typeof this.newState.hasDeathTime!="undefined"&&this.newState.hasDeathTime!=this.state.hasDeathTime){if(!this.newState.hasDeathTime){BX.ajax.runAction("disk.api.externalLink.revokeDeathTime",{data:{externalLinkId:this.state.id}}).then(function(t){this.state.hasDeathTime=false;this.state.deathTimeTimestamp=null;this.state.deathTime=null;return this}.bind(this)).then(e)}else{BX.ajax.runAction("disk.api.externalLink.setDeathTime",{data:{externalLinkId:this.state.id,deathTime:this.newState.deathTimeTimestamp}}).then(function(t){this.state.hasDeathTime=t.data.externalLink.hasDeathTime;this.state.deathTimeTimestamp=t.data.externalLink.deathTimeTimestamp;this.state.deathTime=t.data.externalLink.deathTime;return this}.bind(this)).then(e)}}if(typeof this.newState.hasPassword!="undefined"&&this.newState.hasPassword!=this.state.hasPassword){if(!this.newState.hasPassword){BX.ajax.runAction("disk.api.externalLink.revokePassword",{data:{externalLinkId:this.state.id}}).then(function(t){this.state.hasPassword=false;return this}.bind(this)).then(e)}}if(this.newState.newPassword){BX.ajax.runAction("disk.api.externalLink.setPassword",{data:{externalLinkId:this.state.id,newPassword:this.newState.newPassword}}).then(function(t){this.state.hasPassword=true;return this}.bind(this)).then(e)}if(typeof this.newState.canEditDocument!="undefined"&&this.newState.canEditDocument!=this.state.canEditDocument){if(!this.newState.canEditDocument){BX.ajax.runAction("disk.api.externalLink.disallowEditDocument",{data:{externalLinkId:this.state.id}}).then(function(t){this.state.canEditDocument=false;return this}.bind(this)).then(e)}else{BX.ajax.runAction("disk.api.externalLink.allowEditDocument",{data:{externalLinkId:this.state.id}}).then(function(t){this.state.canEditDocument=true;return this}.bind(this)).then(e)}}},handlePasswordValue:function(t){var e=BX.getEventTarget(t);if(e.value){this.newState.newPassword=e.value}},handleDeathTimeValue:function(t){this.updateNewDeathTimestamp(BX.getEventTarget(t).value)},updateNewDeathTimestamp:function(t){t=parseInt(t,10);if(t<=0){this.newState.hasDeathTime=false;return}var e=Math.floor(Date.now()/1e3);this.newState.deathTimeTimestamp=e+parseInt(t,10)*this.newState.deathTimeFactor;this.newState.hasDeathTime=true},getFormattedDeathTime:function(){if(!this.state.deathTime){return""}return BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),new Date(this.state.deathTime))},handleStatePasswordInput:function(t){var e=this.getEntity(this.getContainer(),"public-link-setting-popup-input-password");e.getAttribute("type")==="password"?e.setAttribute("type","text"):e.setAttribute("type","password")},handleStateTimeInputBlock:function(t){var e=BX.getEventTarget(t);var i=this.getEntity(this.getContainer(),"public-link-setting-time-limit");if(e.checked){i.classList.remove("disk-external-link-setting-popup-disabled");this.newState.hasDeathTime=true}else{i.classList.add("disk-external-link-setting-popup-disabled");this.newState.deathTimeTimestamp=null;this.newState.hasDeathTime=false}},handleStateCanEdit:function(t){var e=BX.getEventTarget(t);this.newState.canEditDocument=e.checked},handleStatePasswordInputBlock:function(t){var e=BX.getEventTarget(t);var i=this.getEntity(this.getContainer(),"public-link-setting-password");if(e.checked){i.classList.remove("disk-external-link-setting-popup-disabled");this.newState.hasPassword=true}else{i.classList.add("disk-external-link-setting-popup-disabled");this.newState.hasPassword=false}},showAccessTypePopup:function(t){var e=this;var i=BX.getEventTarget(t);var a=null;if(BX.getClass("BX.SidePanel.Instance")&&BX.SidePanel.Instance.isOpen()){a=BX.SidePanel.Instance.getTopSlider().getZindex()}var n=BX.PopupMenu.create("disk-detail-time-period",i,[{text:BX.message("DISK_JS_EL_SETTINGS_LINK_LABEL_MINUTE"),onclick:function(t,a){BX.adjust(i,{text:a.text});e.newState.deathTimeFactor=60;this.close()}},{text:BX.message("DISK_JS_EL_SETTINGS_LINK_LABEL_HOUR"),onclick:function(t,a){BX.adjust(i,{text:a.text});e.newState.deathTimeFactor=60*60;this.close()}},{text:BX.message("DISK_JS_EL_SETTINGS_LINK_LABEL_DAY"),onclick:function(t,a){BX.adjust(i,{text:a.text});e.newState.deathTimeFactor=60*60*24;this.close()}}],{angle:{offset:35},overlay:{backgroundColor:"rgba(0,0,0,0)"},autoHide:true,className:"disk-detail-time-period",offsetLeft:50,zIndex:a,events:{onPopupClose:function(){var t=this.getEntity(this.getContainer(),"public-link-setting-popup-input").value;this.updateNewDeathTimestamp(t);n.destroy()}.bind(this)}});n.show()}}})();
//# sourceMappingURL=external-link-settings.map.js