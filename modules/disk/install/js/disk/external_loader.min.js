BX.namespace("BX.Disk.ExternalLoader");BX.Disk.ExternalLoader=function(){var s=new BX.Disk.Queue;return{startLoad:function(t){var o=new BX.Disk.QueueItem(new BX.Disk.ExternalLoader.NewItemClass(t),(function(s){s.start()}),(function(s){return[s,"onFinish"]}));s.push(o).process()},reloadLoadAttachedObject:function(s){return new BX.Disk.ExternalLoader.AttachedItemClass(s)}}}();BX.Disk.ExternalLoader.NewItemClass=function(){var s=function(s){this.ajaxUrl="/bitrix/tools/disk/uf.php";this.file={id:s.file.id,service:s.file.service};this.cloudImport={};this.handlers={onStart:BX.Type.isFunction(s.onStart)?s.onStart:()=>{},onProgress:BX.Type.isFunction(s.onProgress)?s.onProgress:()=>{},onFinish:BX.Type.isFunction(s.onFinish)?s.onFinish:()=>{},onError:BX.Type.isFunction(s.onError)?s.onError:()=>{}};this.setEvents()};s.prototype.setEvents=function(){};s.prototype.onStart=function(){this.handlers.onStart()};s.prototype.onFinish=function(s){BX.onCustomEvent(this,"onFinish",[this]);this.handlers.onFinish(s.file)};s.prototype.onProgress=function(s){this.handlers.onProgress(s)};s.prototype.onError=function(s){BX.onCustomEvent(this,"onFinish",[this]);this.handlers.onError(s)};s.prototype.start=function(){this.onStart();BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","startUpload"),data:{fileId:this.file.id,service:this.file.service},onsuccess:s=>{if(s.status!="success"){s.errors=s.errors||[{}];this.onError(s.errors);BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return null}this.cloudImport={id:s.cloudImport.id};this.processChunkDownload()},onfailure:s=>{this.onError([s])}})};s.prototype.processChunkDownload=function(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","uploadChunk"),data:{cloudImportId:this.cloudImport.id},onsuccess:s=>{if(s.status!="success"){s.errors=s.errors||[{}];this.onError(s.errors);BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return null}this.onProgress(parseInt(s.downloadedContentSize/s.contentSize*100,10));if(s.step=="finish"){this.saveAsNewFile()}else{this.processChunkDownload()}},onfailure:s=>{this.onError([s])}})};s.prototype.saveAsNewFile=function(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","saveAsNewFile"),data:{cloudImportId:this.cloudImport.id},onsuccess:s=>{if(s.status!="success"){s.errors=s.errors||[{}];this.onError(s.errors);BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return null}this.onFinish(s)},onfailure:s=>{this.onError([s])}})};return s}();BX.Disk.ExternalLoader.AttachedItemClass=function(){var s=function(s){this.ajaxUrl="/bitrix/tools/disk/uf.php";this.attachedObject={id:s.attachedObject.id,service:s.attachedObject.service};this.cloudImport={};this.handlers={onFinish:s.onFinish,onProgress:s.onProgress};this.setEvents()};s.prototype.setEvents=function(){};s.prototype.onFinish=function(s){this.handlers.onFinish(s)};s.prototype.onProgress=function(s){this.handlers.onProgress(s)};s.prototype.start=function(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","reloadAttachedObject"),data:{attachedId:this.attachedObject.id,service:this.attachedObject.service},onsuccess:BX.delegate((function(s){if(s.status!="success"){s.errors=s.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return}if(!s.hasNewVersion){this.onFinish(s);return}this.cloudImport={id:s.cloudImport.id};this.processChunkDownload()}),this)})};s.prototype.processChunkDownload=function(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","uploadChunk"),data:{cloudImportId:this.cloudImport.id},onsuccess:BX.delegate((function(s){if(s.status!="success"){s.errors=s.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return null}this.onProgress(parseInt(s.downloadedContentSize/s.contentSize*100,10));if(s.step=="finish"){this.updateFile()}else{this.processChunkDownload()}}),this)})};s.prototype.updateFile=function(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","updateAttachedObject"),data:{attachedId:this.attachedObject.id,cloudImportId:this.cloudImport.id},onsuccess:BX.delegate((function(s){if(s.status!="success"){s.errors=s.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:s.errors.pop().message});return null}this.onFinish(s)}),this)})};return s}();
//# sourceMappingURL=external_loader.map.js