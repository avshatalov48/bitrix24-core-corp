{"version":3,"file":"google-drive-picker.bundle.js","sources":["../src/google-drive-picker.js"],"sourcesContent":["import { Dom, Extension, Loc } from 'main.core';\n\nimport './style.css';\n\ntype DocType = {\n\tmodifyDateInt: number,\n\tsizeInt: number,\n\tmodifyBy: string,\n\tsize: number,\n\tmodifyDate: string,\n\tprovider: string,\n\tname: string,\n\tid: string,\n\ttype: string\n}\n\ntype PickerData = {\n\taction: string,\n\tdocs: GoogleDocType[]\n}\n\ntype GoogleDocType = {\n\tid: string;\n\tname: string;\n\ttype: string;\n\tlastEditedUtc: string;\n\tsizeBytes: number;\n}\n\nexport class GoogleDrivePicker\n{\n\tscopes = Extension.getSettings('disk.google-drive-picker').get('scopes');\n\tprovider = 'gdrive';\n\n\tconstructor(clientId: string, appId: string, apiKey: string, oauthToken: string, saveCallback: string)\n\t{\n\t\tthis.clientId = clientId;\n\t\tthis.appId = appId;\n\t\tthis.apiKey = apiKey;\n\t\tthis.saveCallback = saveCallback;\n\t\tthis.oauthToken = oauthToken;\n\t}\n\n\tasync loadAndShowPicker(): Promise<void>\n\t{\n\t\tif (!this.oauthToken)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait this.#loadGis();\n\t\t\tawait this.#verifyGoogleOAuthToken(this.oauthToken);\n\t\t\tthis.#createPicker();\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\t// debug\n\t\t\tthrow new Error(`Error: ${error}`);\n\t\t}\n\t}\n\n\tasync #loadGis(): Promise<void>\n\t{\n\t\tconst scripts = [\n\t\t\t'https://apis.google.com/js/api.js',\n\t\t\t'https://accounts.google.com/gsi/client',\n\t\t];\n\n\t\tawait Promise.all(scripts.map((script) => this.#loadScript(script)));\n\t}\n\n\t#loadScript(url: string): Promise<void>\n\t{\n\t\treturn new Promise((resolve, reject): void => {\n\t\t\tconst script = document.createElement('script');\n\t\t\tscript.src = url;\n\t\t\tscript.onload = () => resolve(url);\n\t\t\tscript.onerror = () => reject(new Error(`Failed to load script ${url}`));\n\t\t\tDom.append(script, document.head);\n\t\t});\n\t}\n\n\t#createPicker(): void\n\t{\n\t\twindow.gapi.load('client:auth2:picker', this.#showPicker);\n\t}\n\n\t#showPicker = (): void => {\n\t\tif (this.oauthToken)\n\t\t{\n\t\t\tconst googleViewId = window.google.picker.ViewId.DOCS;\n\t\t\tconst docsView = new window.google.picker.DocsView(googleViewId)\n\t\t\t\t.setParent('root')\n\t\t\t\t.setMode(window.google.picker.DocsViewMode.LIST)\n\t\t\t\t.setIncludeFolders(true);\n\n\t\t\tconst picker = new window.google.picker.PickerBuilder()\n\t\t\t\t.enableFeature(window.google.picker.Feature.NAV_HIDDEN)\n\t\t\t\t.setLocale(Loc.getMessage('LANGUAGE_ID'))\n\t\t\t\t.addView(docsView)\n\t\t\t\t.setOAuthToken(this.oauthToken)\n\t\t\t\t.setDeveloperKey(this.apiKey)\n\t\t\t\t.setAppId(this.appId)\n\t\t\t\t.setCallback((data) => this.#pickerCallback(data))\n\t\t\t\t.enableFeature(window.google.picker.Feature.MULTISELECT_ENABLED)\n\t\t\t\t.build();\n\n\t\t\tpicker.setVisible(true);\n\t\t}\n\t};\n\n\t#pickerCallback(data: PickerData): void\n\t{\n\t\tif (data.action === window.google.picker.Action.PICKED)\n\t\t{\n\t\t\tconst documents = data.docs.map((doc): DocType => this.#convertItem(doc));\n\t\t\tthis.saveCallback.saveButton(this.provider, '/', documents);\n\t\t}\n\n\t\tswitch (data.action)\n\t\t{\n\t\t\tcase 'loaded':\n\t\t\t\tdocument.body.style.setProperty('overflow', 'hidden');\n\t\t\t\tbreak;\n\t\t\tcase 'cancel':\n\t\t\tcase 'picked':\n\t\t\t\tdocument.body.style.removeProperty('overflow');\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t#convertItem(document: GoogleDocType): DocType\n\t{\n\t\tconst modifyDate = new Date(document.lastEditedUtc);\n\n\t\treturn {\n\t\t\tid: document.id,\n\t\t\tname: document.name,\n\t\t\ttype: 'file',\n\t\t\tsize: document.sizeBytes,\n\t\t\tsizeInt: document.sizeBytes,\n\t\t\tmodifyBy: '',\n\t\t\tmodifyDate: this.#formatDate(modifyDate),\n\t\t\tmodifyDateInt: modifyDate.getTime(),\n\t\t\tprovider: this.provider,\n\t\t};\n\t}\n\n\t#formatDate(date: Date): string\n\t{\n\t\treturn `${date.getDay()}.${date.getMonth()}.${date.getFullYear()}`;\n\t}\n\n\tasync #verifyGoogleOAuthToken(token: string): Promise<any>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst url = `https://oauth2.googleapis.com/tokeninfo?access_token=${token}`;\n\t\t\tconst response = await fetch(url);\n\n\t\t\tif (!response.ok)\n\t\t\t{\n\t\t\t\tnew Error(`Error verifying token: ${response.statusText}`);\n\t\t\t}\n\n\t\t\treturn await response.json();\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tthrow new Error(`Error verifying token: ${error.message}`);\n\t\t}\n\t}\n}\n"],"names":["GoogleDrivePicker","constructor","clientId","appId","apiKey","oauthToken","saveCallback","scopes","Extension","getSettings","get","provider","googleViewId","window","google","picker","ViewId","DOCS","docsView","DocsView","setParent","setMode","DocsViewMode","LIST","setIncludeFolders","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setLocale","Loc","getMessage","addView","setOAuthToken","setDeveloperKey","setAppId","setCallback","data","MULTISELECT_ENABLED","build","setVisible","loadAndShowPicker","error","Error","scripts","Promise","all","map","script","url","resolve","reject","document","createElement","src","onload","onerror","Dom","append","head","gapi","load","action","Action","PICKED","documents","docs","doc","saveButton","body","style","setProperty","removeProperty","modifyDate","Date","lastEditedUtc","id","name","type","size","sizeBytes","sizeInt","modifyBy","modifyDateInt","getTime","date","getDay","getMonth","getFullYear","token","response","fetch","ok","statusText","json","message"],"mappings":"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"}