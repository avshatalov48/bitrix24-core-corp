{"version":3,"file":"google-drive-picker.bundle.js","sources":["../src/google-drive-picker.js"],"sourcesContent":["import { Dom, Extension, Loc } from 'main.core';\nexport class GoogleDrivePicker\n{\n\tscopes = Extension.getSettings('disk.google-drive-picker').get('scopes');\n\tprovider = 'gdrive';\n\n\tconstructor(clientId, appId, apiKey, oauthToken, saveCallback)\n\t{\n\t\tthis.clientId = clientId;\n\t\tthis.appId = appId;\n\t\tthis.apiKey = apiKey;\n\t\tthis.saveCallback = saveCallback;\n\t\tthis.oauthToken = oauthToken;\n\t}\n\n\tasync loadAndOpenPicker()\n\t{\n\t\tif (!this.oauthToken)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait this.loadGis();\n\t\t\tawait this.verifyGoogleOAuthToken(this.oauthToken);\n\t\t\tthis.createPicker();\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\t// debug\n\t\t\tthrow new Error(`Error: ${error}`);\n\t\t}\n\t}\n\n\tasync loadGis() {\n\t\tconst scripts = [\n\t\t\t'https://apis.google.com/js/api.js',\n\t\t\t'https://accounts.google.com/gsi/client',\n\t\t];\n\n\t\tawait Promise.all(scripts.map((script) => this.loadScript(script)));\n\t}\n\n\tloadScript(url) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst script = document.createElement('script');\n\t\t\tscript.src = url;\n\t\t\tscript.onload = () => resolve(url);\n\t\t\tscript.onerror = () => reject(new Error(`Failed to load script ${url}`));\n\t\t\tDom.append(script, document.head);\n\t\t});\n\t}\n\n\tcreatePicker()\n\t{\n\t\twindow.gapi.load('client:auth2:picker', this.showPicker);\n\t}\n\n\tshowPicker = () => {\n\t\tif (this.oauthToken)\n\t\t{\n\t\t\tconst googleViewId = window.google.picker.ViewId.DOCS;\n\t\t\tconst docsView = new window.google.picker.DocsView(googleViewId)\n\t\t\t\t.setParent('root')\n\t\t\t\t.setMode(window.google.picker.DocsViewMode.LIST)\n\t\t\t\t.setIncludeFolders(true);\n\n\t\t\tconst picker = new window.google.picker.PickerBuilder()\n\t\t\t\t.enableFeature(window.google.picker.Feature.NAV_HIDDEN)\n\t\t\t\t.setLocale(Loc.getMessage('LANGUAGE_ID'))\n\t\t\t\t.addView(docsView)\n\t\t\t\t.setOAuthToken(this.oauthToken)\n\t\t\t\t.setDeveloperKey(this.apiKey)\n\t\t\t\t.setAppId(this.appId)\n\t\t\t\t.setCallback((data) => this.pickerCallback(data))\n\t\t\t\t.enableFeature(window.google.picker.Feature.MULTISELECT_ENABLED)\n\t\t\t\t.build();\n\n\t\t\tpicker.setVisible(true);\n\t\t}\n\t};\n\n\tpickerCallback(data)\n\t{\n\t\tif (data.action === window.google.picker.Action.PICKED)\n\t\t{\n\t\t\tconst documents = data.docs.map((doc) => this.convertItem(doc));\n\t\t\tthis.saveCallback.saveButton(this.provider, '/', documents);\n\t\t}\n\t}\n\n\tconvertItem(document)\n\t{\n\t\tconst modifyDate = new Date(document.lastEditedUtc);\n\n\t\treturn {\n\t\t\tid: document.id,\n\t\t\tname: document.name,\n\t\t\ttype: 'file',\n\t\t\tsize: document.sizeBytes,\n\t\t\tsizeInt: document.sizeBytes,\n\t\t\tmodifyBy: '',\n\t\t\tmodifyDate: this.formatDate(modifyDate),\n\t\t\tmodifyDateInt: modifyDate.getTime(),\n\t\t\tprovider: this.provider,\n\t\t};\n\t}\n\n\tformatDate(date)\n\t{\n\t\treturn `${date.getDay()}.${date.getMonth()}.${date.getFullYear()}`;\n\t}\n\n\tasync verifyGoogleOAuthToken(token)\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst url = `https://oauth2.googleapis.com/tokeninfo?access_token=${token}`;\n\t\t\tconst response = await fetch(url);\n\n\t\t\tif (!response.ok)\n\t\t\t{\n\t\t\t\tthrow new Error(`Error verifying token: ${response.statusText}`);\n\t\t\t}\n\n\t\t\treturn await response.json();\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tthrow new Error(`Error verifying token: ${error.message}`);\n\t\t}\n\t}\n}\n"],"names":["GoogleDrivePicker","clientId","appId","apiKey","oauthToken","saveCallback","Extension","getSettings","get","googleViewId","window","google","picker","ViewId","DOCS","docsView","DocsView","setParent","setMode","DocsViewMode","LIST","setIncludeFolders","PickerBuilder","enableFeature","Feature","NAV_HIDDEN","setLocale","Loc","getMessage","addView","setOAuthToken","setDeveloperKey","setAppId","setCallback","data","pickerCallback","MULTISELECT_ENABLED","build","setVisible","loadGis","verifyGoogleOAuthToken","createPicker","Error","scripts","Promise","all","map","script","loadScript","url","resolve","reject","document","createElement","src","onload","onerror","Dom","append","head","gapi","load","showPicker","action","Action","PICKED","documents","docs","doc","convertItem","saveButton","provider","modifyDate","Date","lastEditedUtc","id","name","type","size","sizeBytes","sizeInt","modifyBy","formatDate","modifyDateInt","getTime","date","getDay","getMonth","getFullYear","token","fetch","response","ok","statusText","json","message"],"mappings":"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"}