(function(){"use strict";BX.namespace("BX.Disk.Viewer");BX.Disk.Viewer.DocumentItem=function(e){e=e||{};BX.UI.Viewer.Item.apply(this,arguments);this.contentNode=null;this.iframeNode=null;this.justErrorInGoogle=false;this.viewUrl=e.viewUrl;this.neededCheckView=e.neededCheckView;this.neededDelete=e.neededDelete;this.objectId=e.objectId;this.attachedObjectId=e.attachedObjectId};BX.Disk.Viewer.DocumentItem.prototype={__proto__:BX.UI.Viewer.Item.prototype,constructor:BX.UI.Viewer.Item,setPropertiesByNode:function(e){BX.UI.Viewer.Item.prototype.setPropertiesByNode.apply(this,arguments);this.objectId=e.dataset.objectId;this.attachedObjectId=e.dataset.attachedObjectId},buildUrlToShow:function(){return this.buildUrlToAction("show")},buildUrlToAction:function(e){var t="/bitrix/tools/disk/document.php";if(this.attachedObjectId){t="/bitrix/tools/disk/uf.php";t=BX.util.add_url_param(t,{attachedId:this.attachedObjectId})}else{t=BX.util.add_url_param(t,{objectId:this.objectId})}t=BX.util.add_url_param(t,{document_action:e,primaryAction:e,service:null});return t},loadData:function(){var e=new BX.Promise;if(this.justErrorInGoogle){console.log("this.justErrorInGoogle",this.justErrorInGoogle);e.reject({item:this,type:"error"});return e}BX.ajax.promise({url:this.buildUrlToShow(),method:"POST",dataType:"json",data:{SITE_ID:BX.message("SITE_ID"),sessid:BX.bitrix_sessid()}}).then(function(t){if(t&&t.authUrlOpenerMode){this.runAuth=t}else{if(!t||t.status!=="success"){e.reject({item:this,type:"error"});return}this.viewId=t.id;this.viewUrl=t.viewUrl;this.neededCheckView=t.neededCheckView;this.neededDelete=t.neededDelete;this.service=t.service}e.fulfill(this)}.bind(this));return e},buildNodeWithAuthMessage:function(){return BX.create("div",{props:{className:"ui-viewer-error"},children:[BX.create("div",{props:{className:"ui-viewer-info-title"},html:BX.message("JS_VIEWER_DOCUMENT_ITEM_SHOW_FILE_DIALOG_OAUTH_NOTICE").replace("#SERVICE#",this.runAuth.serviceName)})]})},renderStubForOfiice365:function(){return BX.create("div",{props:{className:"ui-viewer-unsupported"},children:[BX.create("div",{props:{className:"ui-viewer-unsupported-title"},text:BX.message("JS_VIEWER_DOCUMENT_ITEM_OPEN_DESCR_OFFICE365")}),BX.create("div",{props:{className:"ui-viewer-unsupported-text disk-viewer-office365-text"},html:BX.message("JS_VIEWER_DOCUMENT_ITEM_OPEN_HELP_HINT_OFFICE365")}),BX.create("a",{props:{className:"ui-btn ui-btn-light-border ui-btn-themes",href:this.viewUrl,target:"_blank"},text:BX.message("JS_VIEWER_DOCUMENT_ITEM_OPEN_FILE_OFFICE365")})]})},render:function(){var e=document.createDocumentFragment();if(this.runAuth){e.appendChild(this.buildNodeWithAuthMessage())}else{this.iframeNode=BX.create("iframe",{props:{src:this.viewUrl},events:{load:this.handleOnLoadIframe.bind(this)},style:{maxWidth:"1024px",width:"100%",height:"100%",border:"none"}});e.appendChild(this.iframeNode);this.register204Checker()}return e},getContentWidth:function(){var e=new BX.Promise;e.fulfill(this.iframeNode.offsetWidth);return e},register204Checker:function(){setTimeout(function(){if(this.iframeNode&&this.iframeNode.contentDocument&&this.iframeNode.contentDocument.URL==="about:blank"){console.log("google 204Checker");this.controller.reload(this,{justErrorInGoogle:true})}}.bind(this),12e3)},handleOnLoadIframe:function(){if(!BX.browser.IsChrome()||!this.neededCheckView){return}BX.ajax.promise({url:this.buildUrlToAction("checkView"),method:"POST",dataType:"json",data:{id:this.viewId,SITE_ID:BX.message("SITE_ID"),sessid:BX.bitrix_sessid()}}).then(function(e){if(!e||(e.viewed===undefined&&!e.viewByGoogle||e.viewByGoogle===undefined&&!e.viewed)){this.controller.reload(this,{justErrorInGoogle:true})}}.bind(this))},applyReloadOptions:function(e){if(e.justErrorInGoogle){this.justErrorInGoogle=true}},afterRender:function(){if(this.runAuth){BX.bind(BX("bx-js-disk-run-oauth-modal"),"click",function(e){BX.util.popup(this.runAuth.authUrlOpenerMode,1030,700);e.preventDefault()}.bind(this));BX.bind(window,"hashchange",BX.proxy((function(){var e=document.location.hash.match(/external-auth-(\w+)/);if(!e){return}this.controller.reload(this)}),this))}else if(this.iframeNode){this.controller.showLoading()}}}})();
//# sourceMappingURL=item.map.js