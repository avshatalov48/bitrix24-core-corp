(function(){"use strict";BX.namespace("BX.Disk.Document");BX.Disk.Document.EditProcess=function(i){this.objectId=i.objectId;this.attachedObjectId=i.attachedObjectId;this.serviceCode=i.serviceCode;this.service=null;this.popupConfirm=null;this.onAfterSave=null;this.modalWindow=i.modalWindow;if(BX.type.isFunction(i.onAfterSave)){this.onAfterSave=i.onAfterSave}};BX.Disk.Document.EditProcess.prototype={start:function(){this.modalWindow=this.buildModalWindow();this.loadServiceDescription().then(function(i){this.openEditConfirm()}.bind(this))},buildModalWindow:function(){return this.openModal(BX.util.add_url_param("/bitrix/services/main/ajax.php",{action:"disk.api.documentService.goToEdit",serviceCode:this.serviceCode,objectId:this.objectId||0,attachedObjectId:this.attachedObjectId||0}))},isActive:function(){return this.popupConfirm&&this.popupConfirm.isShown()},openModal:function(i,e,t){e=e||1030;t=t||700;if(this.modalWindow){this.modalWindow.location=i}var o=this.modalWindow||BX.util.popup(i,e,t);window.addEventListener("message",function(i){if(i.origin!=window.location.origin){return}if(i.data.reason==="disk-work-with-document"){this.setDataForCommit(i.data)}else if(i.data.reason==="disk-work-close-edit-document"){this.closeEditConfirm()}}.bind(this),false);return o},closeModal:function(){if(this.modalWindow){try{this.modalWindow.close()}catch(i){}}},getDataForCommit:function(){return this.dataForCommit},setDataForCommit:function(i){this.dataForCommit=i},getService:function(){return this.service},loadServiceDescription:function(){var i=new BX.Promise;if(this.service){i.fulfill(this.service);return i}BX.ajax.runAction("disk.api.documentService.get",{data:{serviceCode:this.serviceCode}}).then(function(e){this.service=e.data.documentService;i.fulfill(this.service)}.bind(this));return i},buildLinkToCommit:function(){var i=this.objectId?this.service.links.edit:this.service.links.uf.edit;i=i.replace("FILE_ID",this.objectId);i=i.replace("ATTACHED_ID",this.attachedObjectId);i=BX.util.remove_url_param(i,"document_action");i=BX.util.add_url_param(i,{document_action:"commit"});return i},save:function(){return this.commit().then(function(i){console.log("commit",i);if(i.originalIsLocked){BX.UI.Viewer.Instance.close();BX.Disk.InformationPopups.showWarningLockedDocument({link:BX.Disk.getUrlToShowObjectInGrid(i.forkedObject.id)})}else{this.onAfterSave.call(this,i)}return i}.bind(this))},commit:function(){console.log("commit");var i=new BX.Promise;var e=this.getDataForCommit()||{};var t=e.idDoc||e.id;if(!t){console.log("There is no parameters for commit");i.fulfill({status:"error"});return i}return BX.ajax.promise({method:"POST",dataType:"json",url:this.buildLinkToCommit(),data:{commit:1,editSessionId:e.editSessionId,id:t,sessid:BX.bitrix_sessid()}})},buildLinkToDiscard:function(){return this.urlHelper().getUrlDiscardFile(this.buildLinkToCommit())},discard:function(){console.log("discard");var i=new BX.Promise;var e=this.getDataForCommit()||{};var t=e.idDoc||e.id;if(!t){console.log("There is no parameters for commit");i.fulfill({status:"error"});return i}BX.ajax({method:"POST",dataType:"json",url:this.buildLinkToDiscard(),data:{discard:1,editSessionId:e.editSessionId,id:t,sessid:BX.bitrix_sessid()},onsuccess:function(i){console.log("discard",i)}})},getViewerZindex:function(){if(BX.getClass("BX.UI.Viewer.Instance")){return BX.UI.Viewer.Instance.getZindex()}return null},closeEditConfirm:function(){this.popupConfirm&&this.popupConfirm.close()},getConfirmMessages:function(){return{title:BX.message("JS_DISK_DOC_PROCESS_NOW_EDITING_IN_SERVICE").replace("#SERVICE#",this.service.name),text:BX.message("JS_DISK_DOC_PROCESS_IFRAME_DESCR_SAVE_DOC_F").replace("#SAVE_DOC#",BX.message("JS_DISK_DOC_PROCESS_SAVE")),saveButton:BX.message("DISK_JS_BTN_SAVE")}},openEditConfirm:function(){var i=BX.create("div",{props:{className:"bx-disk-document-edit-confirm"},children:[BX.create("div",{props:{className:"bx-disk-document-edit-confirm-title"},text:this.getConfirmMessages().title,children:[]}),BX.create("div",{props:{className:"bx-disk-document-edit-confirm-text-wrap"},children:[BX.create("span",{props:{className:"bx-disk-document-edit-confirm-text-alignment"}}),BX.create("span",{props:{className:"bx-disk-document-edit-confirm-text"},text:this.getConfirmMessages().text})]})]});this.popupConfirm=BX.PopupWindowManager.create("document-edit-confirm",null,{content:i,overlay:true,buttons:[new BX.PopupWindowCustomButton({text:this.getConfirmMessages().saveButton,className:"ui-btn ui-btn-success",events:{click:function(){var i=BX.Disk.showActionModal({text:BX.message("JS_DISK_DOC_PROCESS_IFRAME_PROCESS_SAVE_DOC"),showLoaderIcon:true,autoHide:false});this.popupConfirm.close();this.closeModal();window.onbeforeunload=null;this.save().then(function(){console.log("actionModal.close");i.close()})}.bind(this)}}),new BX.PopupWindowCustomButton({text:BX.message("DISK_JS_BTN_CANCEL"),className:"ui-btn ui-btn-link",events:{click:function(){this.discard();this.popupConfirm.close();this.closeModal()}.bind(this)}})],autoHide:false,closeByEsc:false,zIndex:this.getViewerZindex(),events:{onPopupClose:function(){this.destroy()}}});this.popupConfirm.show()},urlHelper:function(){var i=this.serviceCode;return{ajaxDocUrl:"/bitrix/tools/disk/document.php",ajaxUfDocUrl:"/bitrix/tools/disk/uf.php",normalizeServiceName:function(i){switch(i.toLowerCase()){case"g":case"google":case"gdrive":i="gdrive";break;case"s":case"skydrive":case"sky-drive":case"onedrive":i="onedrive";break;case"office365":i="office365";break;case"myoffice":i="myoffice";break;case"l":case"local":i="l";break;default:i="gdrive";break}return i},getUrlViewFile:function(i){i=this.addToLinkParam(i,"service","gvdrive");i=this.addToLinkParam(i,"document_action","show");return i},getUrlCheckView:function(i){i=this.addToLinkParam(i,"service","gvdrive");i=this.addToLinkParam(i,"document_action","checkView");return i},getUrlStartPublishBlank:function(e,t){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"type",t);return e},getUrlCommitBlank:function(e,t,o){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"document_action","saveBlank");e=this.addToLinkParam(e,"type",t);if(o){e=this.addToLinkParam(e,"targetFolderId",o)}return e},getUrlRenameFile:function(e){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"document_action","rename");return e},getUrlCopyToMe:function(i){i=this.addToLinkParam(i,"action","copyToMe");return i},getUrlEditFile:function(e,t){e=this.addToLinkParam(e,"service",i);return e},getUrlCommitFile:function(e){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"document_action","commit");return e},getUrlDiscardFile:function(e){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"document_action","discard");return e},getUrlDiscardBlankFile:function(e){e=this.addToLinkParam(e,"service",i);e=this.addToLinkParam(e,"document_action","discardBlank");return e},addToLinkParam:function(i,e,t){if(!i.length){return"?"+e+"="+t}i=BX.util.remove_url_param(i,e);if(i.indexOf("?")!=-1){return i+"&"+e+"="+t}return i+"?"+e+"="+t}}}}})();
//# sourceMappingURL=editprocess.map.js