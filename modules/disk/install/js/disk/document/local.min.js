(function(){"use strict";BX.namespace("BX.Disk.Document");BX.Disk.Document.Local=function(e){this.secondsToWaitDesktop=17;this.fallbacks={};this.disableLocalEdit=false;this.bindEvents()};BX.Disk.Document.Local.prototype={bindEvents:function(){BX.addCustomEvent("BX.UI.Viewer.Controller:onItemError",this.handleViewerItemError.bind(this));BX.addCustomEvent("BX.UI.Viewer.Controller:onAfterProcessItemError",this.handleAfterViewerItemError.bind(this));BX.addCustomEvent("onPullEvent-disk",this.handlePullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-disk",this.handlePullEvent.bind(this))},handleAfterViewerItemError:function(e,t,o){if(t.idViewFileLink){BX.bind(BX(t.idViewFileLink),"click",function(e){e.preventDefault();this.viewFile({url:o.src,name:o.getTitle()})}.bind(this))}},handleViewerItemError:function(e,t,o){if(!this.isSetWorkWithLocalBDisk()){return}var i="runLocal"+(Math.floor(Math.random()*1e4)+1);t.message=BX.message("JS_DISK_DOC_TRY_TO_OPEN_BY_LOCAL_PROGRAM_TITLE").replace("#ID#",i);t.description=BX.message("JS_DISK_DOC_TRY_TO_OPEN_BY_LOCAL_PROGRAM_OR_DOWNLOAD").replace("#DOWNLOAD_LINK#",o.getSrc());t.idViewFileLink=i},handlePullEvent:function(e,t){if(e==="bdisk"&&t.uidRequest){this.stopWaiting(t.uidRequest)}},isSetWorkWithLocalBDisk:function(){return BX.Disk.getDocumentService()==="l"&&this.isEnabled()},disable:function(){this.disableLocalEdit=true},isEnabled:function(){if(this.disableLocalEdit){return false}return true},editFile:function(e){e=this.prepareParametersToWorkWithFile(e);this.goToBx("v2openFile",{objectId:e.objectId,url:e.url,name:e.name})},createFile:function(e){var t=new BX.Promise;var o="/bitrix/tools/disk/document.php";o=BX.util.add_url_param(o,{service:"l",type:e.type,document_action:"publishBlank",primaryAction:"publishBlank",action:""});BX.Disk.ajaxPromise({method:"POST",dataType:"json",url:o,data:{targetFolderId:e.targetFolderId||""}}).then(function(e){if(!e||e.status!=="success"){t.reject({status:"error"});return}t.fulfill(e);this.editFile({objectId:e.object.id,url:e.link,name:e.object.name})}.bind(this));return t},viewFile:function(e){e=this.prepareParametersToWorkWithFile(e);this.goToBx("v2viewFile",{objectId:e.objectId,url:e.url,name:e.name})},prepareParametersToWorkWithFile:function(e){if(!e.objectId&&!e.attachedObjectId&&!e.url){return}e.name=e.name||"Unknown document";e.objectId=e.objectId||0;e.attachedObjectId=e.attachedObjectId||0;var t=e.url;if(!t){t=e.objectId?"/bitrix/tools/disk/document.php":"/bitrix/tools/disk/uf.php";t=BX.util.add_url_param(t,{objectId:e.objectId,attachedId:e.attachedObjectId,service:"l",document_action:"download",primaryAction:"download",action:""})}if(t.substring(0,1)==="/"){t=(window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""))+t}e.url=t;return e},goToBx:function(e,t){console.log("waiting for GoToBx",e,t);var o="bx://"+e;t=BX.type.isPlainObject(t)?t:{};t.uidRequest=BX.util.getRandomString(16);if(BX.type.isPlainObject(t)){for(var i in t){if(!t.hasOwnProperty(i)){continue}o+="/"+i+"/"+encodeURIComponent(t[i])}}if(typeof BXFileStorage=="undefined"){console.log("BXFileStorage is undefined");if(BX.Reflection.getClass("top.BX.Messenger.v2.Lib.DesktopManager")){console.log("v2.Lib.DesktopManager start checkStatusInDifferentContext");const e=top.BX.Messenger.v2.Lib.DesktopManager.getInstance();e.checkStatusInDifferentContext().then((i=>{console.log("v2.Lib.DesktopManager checkStatusInDifferentContext result",i,o);if(i){e.openBxLink(o)}else{this.registerFallback(t.uidRequest);e.openBxLink(o)}}))}else if(BX.getClass("top.BX.desktopUtils")){console.log("desktopUtils start runningCheck");top.BX.desktopUtils.runningCheck((()=>{console.log("desktopUtils successful check",o);top.BX.desktopUtils.goToBx(o)}),(()=>{console.log("desktopUtils failed check",o);this.registerFallback(t.uidRequest);top.BX.desktopUtils.goToBx(o)}))}}else{console.log("BXFileStorage is defined; inside Desktop",o);if(BX.Reflection.getClass("top.BX.Messenger.v2.Lib.DesktopManager")){console.log("v2.Lib.DesktopManager openBxLink",o);const e=top.BX.Messenger.v2.Lib.DesktopManager.getInstance();e.openBxLink(o)}else if(BX.getClass("top.BX.desktopUtils")){console.log("desktopUtils goToBx",o);top.BX.desktopUtils.goToBx(o)}}},registerFallback:function(e){top.BX.loadExt("disk").then(function(){top.BX.Disk.showLoader({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP")});var t=setTimeout(function(){top.BX.Disk.hideLoader();var e=new BX.PopupWindow("b24-desktop",null,{titleBar:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_TITLE"),content:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_DESCR"),closeIcon:true,closeByEsc:true,width:500,overlay:{backgroundColor:"rgba(0,0,0,0.5)"},buttons:[new BX.PopupWindowCustomButton({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_DOWNLOAD"),className:"ui-btn ui-btn-primary",events:{click:function(e){document.location.href=BX.Intranet.DesktopDownload.getLinkForCurrentUser()}}}),new BX.PopupWindowCustomButton({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_HELP"),className:"ui-btn ui-btn-link",events:{click:function(t){if(top.BX.Helper)top.BX.Helper.show("redirect=detail&code=8626407");e.destroy()}}})]});e.show()}.bind(this),this.secondsToWaitDesktop*1e3);this.fallbacks[e]={timeoutId:t}}.bind(this))},stopWaiting:function(e){if(BX.getClass("top.BX.Disk")){top.BX.Disk.hideLoader()}if(this.fallbacks.hasOwnProperty(e)){clearTimeout(this.fallbacks[e].timeoutId);delete this.fallbacks[e]}}};var e=null;Object.defineProperty(BX.Disk.Document.Local,"Instance",{enumerable:false,get:function(){if(e===null){e=new BX.Disk.Document.Local({})}return e}});BX.Disk.Document.Local.Instance.isEnabled()})();
//# sourceMappingURL=local.map.js