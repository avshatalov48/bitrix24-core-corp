(function(){"use strict";BX.namespace("BX.Disk.Document");BX.Disk.Document.Local=function(t){this.secondsToWaitDesktop=17;this.fallbacks={};this.disableLocalEdit=false;this.bindEvents()};BX.Disk.Document.Local.prototype={bindEvents:function(){BX.addCustomEvent("BX.UI.Viewer.Controller:onItemError",this.handleViewerItemError.bind(this));BX.addCustomEvent("BX.UI.Viewer.Controller:onAfterProcessItemError",this.handleAfterViewerItemError.bind(this));BX.addCustomEvent("onPullEvent-disk",this.handlePullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-disk",this.handlePullEvent.bind(this))},handleAfterViewerItemError:function(t,e,i){if(e.idViewFileLink){BX.bind(BX(e.idViewFileLink),"click",function(t){t.preventDefault();this.viewFile({url:i.src,name:i.getTitle()})}.bind(this))}},handleViewerItemError:function(t,e,i){if(!this.isSetWorkWithLocalBDisk()){return}var o="runLocal"+(Math.floor(Math.random()*1e4)+1);e.message=BX.message("JS_DISK_DOC_TRY_TO_OPEN_BY_LOCAL_PROGRAM_TITLE").replace("#ID#",o);e.description=BX.message("JS_DISK_DOC_TRY_TO_OPEN_BY_LOCAL_PROGRAM_OR_DOWNLOAD").replace("#DOWNLOAD_LINK#",i.getSrc());e.idViewFileLink=o},handlePullEvent:function(t,e){if(t==="bdisk"&&e.uidRequest){this.stopWaiting(e.uidRequest)}},isSetWorkWithLocalBDisk:function(){return BX.Disk.getDocumentService()==="l"&&this.isEnabled()},disable:function(){this.disableLocalEdit=true},isEnabled:function(){if(this.disableLocalEdit){return false}return true},editFile:function(t){t=this.prepareParametersToWorkWithFile(t);this.goToBx("v2openFile",{objectId:t.objectId,url:t.url,name:t.name})},createFile:function(t){var e=new BX.Promise;var i="/bitrix/tools/disk/document.php";i=BX.util.add_url_param(i,{service:"l",type:t.type,document_action:"publishBlank",primaryAction:"publishBlank",action:""});BX.Disk.ajaxPromise({method:"POST",dataType:"json",url:i,data:{targetFolderId:t.targetFolderId||""}}).then(function(t){if(!t||t.status!=="success"){e.reject({status:"error"});return}e.fulfill(t);this.editFile({objectId:t.object.id,url:t.link,name:t.object.name})}.bind(this));return e},viewFile:function(t){t=this.prepareParametersToWorkWithFile(t);this.goToBx("v2viewFile",{objectId:t.objectId,url:t.url,name:t.name})},prepareParametersToWorkWithFile:function(t){if(!t.objectId&&!t.attachedObjectId&&!t.url){return}t.name=t.name||"Unknown document";t.objectId=t.objectId||0;t.attachedObjectId=t.attachedObjectId||0;var e=t.url;if(!e){e=t.objectId?"/bitrix/tools/disk/document.php":"/bitrix/tools/disk/uf.php";e=BX.util.add_url_param(e,{objectId:t.objectId,attachedId:t.attachedObjectId,service:"l",document_action:"download",primaryAction:"download",action:""})}if(e.substring(0,1)==="/"){e=(window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""))+e}t.url=e;return t},goToBx:function(t,e){var i="bx://"+t;e=BX.type.isPlainObject(e)?e:{};e.uidRequest=BX.util.getRandomString(16);if(BX.type.isPlainObject(e)){for(var o in e){if(!e.hasOwnProperty(o)){continue}i+="/"+o+"/"+encodeURIComponent(e[o])}}if(typeof BXFileStorage=="undefined"){top.BX.desktopUtils.runningCheck((function(){top.BX.desktopUtils.goToBx(i)}),function(){this.registerFallback(e.uidRequest);top.BX.desktopUtils.goToBx(i)}.bind(this))}else{top.BX.desktopUtils.goToBx(i)}},registerFallback:function(t){top.BX.loadExt("disk").then(function(){top.BX.Disk.showLoader({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP")});var e=setTimeout(function(){top.BX.Disk.hideLoader();var t=new BX.PopupWindow("b24-desktop",null,{titleBar:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_TITLE"),content:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_DESCR"),closeIcon:true,closeByEsc:true,width:500,overlay:{backgroundColor:"rgba(0,0,0,0.5)"},buttons:[new BX.PopupWindowCustomButton({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_DOWNLOAD"),className:"ui-btn ui-btn-primary",events:{click:function(t){document.location.href=BX.browser.IsMac()?"https://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"https://dl.bitrix24.com/b24/bitrix24_desktop.exe"}}}),new BX.PopupWindowCustomButton({text:BX.message("JS_DISK_DOC_WAITING_FOR_BITRIX24_DESKTOP_HELP"),className:"ui-btn ui-btn-link",events:{click:function(e){if(top.BX.Helper)top.BX.Helper.show("redirect=detail&code=8626407");t.destroy()}}})]});t.show()}.bind(this),this.secondsToWaitDesktop*1e3);this.fallbacks[t]={timeoutId:e}}.bind(this))},stopWaiting:function(t){if(BX.getClass("top.BX.Disk")){top.BX.Disk.hideLoader()}if(this.fallbacks.hasOwnProperty(t)){clearTimeout(this.fallbacks[t].timeoutId);delete this.fallbacks[t]}}};var t=null;Object.defineProperty(BX.Disk.Document.Local,"Instance",{enumerable:false,get:function(){if(t===null){t=new BX.Disk.Document.Local({})}return t}});BX.Disk.Document.Local.Instance.isEnabled()})();
//# sourceMappingURL=local.map.js