{"version":3,"file":"disk.b24-documents-client-registration.bundle.js","sources":["../src/client-registration.js","../src/client-unregistration.js"],"sourcesContent":["import {ClientRegistrationOptions} from \"./types\";\nimport {ajax as Ajax, Tag, Loc, Extension} from \"main.core\";\nimport {Popup} from \"main.popup\";\nimport {SaveButton} from \"ui.buttons\";\n\nconst DEFAULT_LANGUAGE_ID = 'en';\n\nexport default class ClientRegistration\n{\n\n\toptions: ClientRegistrationOptions;\n\tpopupContainerId = 'content-register-modal';\n\n\tconstructor(options: ClientRegistrationOptions)\n\t{\n\t\tthis.options = options;\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents()\n\t{}\n\n\tstart()\n\t{\n\t\tconst allowedServerPromise = Ajax.runAction('disk.api.integration.b24documents.listAllowedServers')\n\t\t\t.then(response => {\n\t\t\t\treturn response.data.servers;\n\t\t\t}\n\t\t);\n\n\t\tconst warning = Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_WARNING', {'#NAME#' : this.#getServiceName()});\n\n\t\tconst popupContent = Tag.render`\n\t\t\t<div class=\"ui-form\" id=\"${this.popupContainerId}\" style=\"padding-top: 20px\">\n\t\t\t\t<div class=\"ui-form-row\" style=\"display: none\">\n\t\t\t\t\t<div class=\"ui-alert ui-alert-danger\">\n\t\t\t\t\t\t<span class=\"ui-alert-message\"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">${Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_SELECT_SERVER_LABEL')}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-after-icon ui-ctl-dropdown\">\n\t\t\t\t\t\t\t<div class=\"ui-ctl-after ui-ctl-icon-angle\"></div>\n\t\t\t\t\t\t\t<select class=\"ui-ctl-element\"></select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">${warning}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tconst popup = new Popup({\n\t\t\toverlay: true,\n\t\t\theight: 280,\n\t\t\twidth: 350,\n\t\t\tcontent: popupContent,\n\t\t\tcloseIcon: true,\n\t\t\tevents: {\n\t\t\t\tonAfterClose: () => popup.destroy(),\n\t\t\t},\n\t\t\tbuttons: [\n\t\t\t\tnew SaveButton({\n\t\t\t\t\ttext: Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_BUTTON'),\n\t\t\t\t\tonclick: this.handleClickRegister.bind(this),\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t\tpopup.show();\n\n\t\tallowedServerPromise.then(servers => {\n\t\t\tconst select = popupContent.querySelector('select');\n\t\t\tservers.forEach(server => {\n\t\t\t\tconst regionSuffix = server.region ? ` (${server.region})` : '';\n\t\t\t\tselect.add(Tag.render`<option value=\"${server.proxy}\">${server.proxy}${regionSuffix}</option>`);\n\t\t\t})\n\t\t})\n\t}\n\n\t#getSelectedServer(): string\n\t{\n\t\tconst selectNode = document.querySelector(`#${this.popupContainerId} select`);\n\t\tif (!selectNode)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn selectNode.value;\n\t}\n\n\t#getLanguageId(): string\n\t{\n\t\treturn Loc.hasMessage('LANGUAGE_ID') ? Loc.getMessage('LANGUAGE_ID') : DEFAULT_LANGUAGE_ID;\n\t}\n\n\t#getServiceName(): string\n\t{\n\t\treturn Extension.getSettings('disk.b24-documents-client-registration').get('serviceName');\n\t}\n\n\t#showOnlyErrorRowInPopup(message: string): void\n\t{\n\t\tconst rows = document.querySelectorAll(`#${this.popupContainerId} .ui-form-row`);\n\t\trows.forEach(row => {\n\t\t\trow.style.display = 'none';\n\t\t});\n\n\t\trows[0].style.display = '';\n\t\trows[0].querySelector('.ui-alert-message').textContent = message;\n\t}\n\n\thandleClickRegister(button: SaveButton, event: MouseEvent)\n\t{\n\t\tbutton.setDisabled();\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: button.getContainer(),\n\t\t\tsize: 45,\n\t\t});\n\t\tloader.show();\n\n\t\tAjax.runAction('disk.api.integration.b24documents.registerCloudClient', {\n\t\t\tdata: {\n\t\t\t\tserviceUrl: this.#getSelectedServer(),\n\t\t\t\tlanguageId: this.#getLanguageId(),\n\t\t\t}\n\t\t}).then(() => {\n\t\t\tdocument.location.reload();\n\t\t}).catch((response) => {\n\t\t\tconsole.warn('Registration error', response);\n\n\t\t\tloader.hide();\n\t\t\tthis.#showOnlyErrorRowInPopup(\n\t\t\t\tthis.#buildUsefulErrorText(response.errors || [])\n\t\t\t);\n\t\t});\n\t}\n\n\t#buildUsefulErrorText(errors: Array): string\n\t{\n\t\tfor (const error of errors)\n\t\t{\n\t\t\tif (error.code === 'tariff_restriction')\n\t\t\t{\n\t\t\t\treturn Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_ERROR_AFTER_REG', {'#NAME#' : this.#getServiceName()});\n\t\t\t}\n\t\t\tif (error.code === 'should_show_in_ui')\n\t\t\t{\n\t\t\t\treturn error.message;\n\t\t\t}\n\t\t\tif (error.code === 'domain_verification')\n\t\t\t{\n\t\t\t\treturn Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_ERROR_DOMAIN_VERIFICATION', {\n\t\t\t\t\t'#NAME#' : this.#getServiceName(),\n\t\t\t\t\t'#DOMAIN#' : error.customData.domain,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_REGISTRATION_ERROR_COMMON');\n\t}\n};","import {ClientRegistrationOptions} from \"./types\";\nimport {ajax as Ajax, Loc, Extension} from \"main.core\";\nimport {MessageBox} from \"ui.dialogs.messagebox\";\n\nconst DEFAULT_LANGUAGE_ID = 'en';\n\nexport default class ClientUnRegistration\n{\n\tmessageBox: MessageBox;\n\toptions: ClientRegistrationOptions;\n\tpopupContainerId = 'content-register-modal';\n\n\tconstructor(options: ClientRegistrationOptions)\n\t{\n\t\tthis.options = options;\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents()\n\t{}\n\n\tstart()\n\t{\n\t\tthis.messageBox = MessageBox.create({\n\t\t\ttitle: Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_UNREGISTRATION_TITLE', {'#NAME#' : this.#getServiceName()}),\n\t\t\tmessage: Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_UNREGISTRATION_MSG', {'#NAME#' : this.#getServiceName()}),\n\t\t\tbuttons: BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,\n\t\t\tokCaption: Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_UNREGISTRATION_UNREGISTER_BTN'),\n\t\t\tonOk: () => {\n\t\t\t\tconsole.log(this);\n\t\t\t\tthis.handleClickUnregister();\n\t\t\t},\n\t\t});\n\t\tthis.messageBox.show();\n\t}\n\n\t#getLanguageId(): string\n\t{\n\t\treturn Loc.hasMessage('LANGUAGE_ID') ? Loc.getMessage('LANGUAGE_ID') : DEFAULT_LANGUAGE_ID;\n\t}\n\n\t#getServiceName(): string\n\t{\n\t\treturn Extension.getSettings('disk.b24-documents-client-registration').get('serviceName');\n\t}\n\n\thandleClickUnregister()\n\t{\n\t\tAjax.runAction('disk.api.integration.b24documents.unregisterCloudClient', {\n\t\t\tdata: {\n\t\t\t\tlanguageId: this.#getLanguageId(),\n\t\t\t}\n\t\t}).then(() => {\n\t\t\tdocument.location.reload();\n\t\t}).catch((response) => {\n\t\t\tconsole.warn('Unregistration error', response);\n\n\t\t\tthis.messageBox.setMessage(this.#buildUsefulErrorText(response.errors || []));\n\t\t});\n\t}\n\n\t#buildUsefulErrorText(errors: Array): string\n\t{\n\t\tfor (const error of errors)\n\t\t{\n\t\t\tif (error.code === 'should_show_in_ui')\n\t\t\t{\n\t\t\t\treturn error.message;\n\t\t\t}\n\t\t}\n\n\t\treturn Loc.getMessage('JS_B24_DOCUMENTS_CLIENT_UNREGISTRATION_ERROR_COMMON');\n\t}\n};"],"names":["DEFAULT_LANGUAGE_ID","ClientRegistration","options","bindEvents","allowedServerPromise","Ajax","runAction","then","response","data","servers","warning","Loc","getMessage","popupContent","Tag","render","popupContainerId","popup","Popup","overlay","height","width","content","closeIcon","events","onAfterClose","destroy","buttons","SaveButton","text","onclick","handleClickRegister","bind","show","select","querySelector","forEach","server","regionSuffix","region","add","proxy","button","event","setDisabled","loader","BX","Loader","target","getContainer","size","serviceUrl","languageId","document","location","reload","console","warn","hide","errors","selectNode","value","hasMessage","Extension","getSettings","get","message","rows","querySelectorAll","row","style","display","textContent","error","code","customData","domain","ClientUnRegistration","messageBox","MessageBox","create","title","UI","Dialogs","MessageBoxButtons","OK_CANCEL","okCaption","onOk","log","handleClickUnregister","setMessage"],"mappings":"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"}