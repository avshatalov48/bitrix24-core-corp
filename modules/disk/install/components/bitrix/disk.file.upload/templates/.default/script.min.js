(function(){if(BX.DiskUpload)return;var e=[];BX.DiskUpload=function(e){this.bp=e["bp"];this.bpParameters=e["bpParameters"];this.bpParametersRequired=e["bpParametersRequired"];this.storageId=e["storageId"];this.ajaxUrl="/bitrix/components/bitrix/disk.folder.list/ajax.php";this.CID=e["CID"];this.nodeContent=BX.create("DIV",{style:{display:"none"},attrs:{id:e["CID"]+"ContentNode"},html:BX.message("DFU_TEMPLATE").replace(/#id#/gi,this.CID)+'<div class="wduf-uploader area">'+BX.message("DFU_DND_TEMPLATE")+"</div>"});document.body.appendChild(this.nodeContent);this.counter={all:[],uploaded:[],uploading:[]};this.init(e);return this};BX.DiskUpload.prototype={_camelToSNAKE:function(e){var t={},i,s;for(i in e){if(e.hasOwnProperty(i)){s=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[s]=e[i];t[i]=e[i]}}return t},initAttempt:0,init:function(e){this.initAttempt++;if(this.initAttempt>10||this.agent)return;this.placeHolder=BX(this.CID+"PlaceHolder");if(this.placeHolder){this.templates={new:BX.message("DFU_NODE_TEMPLATE"),done:BX.message("DFU_NODE_TEMPLATE_DONE"),canceled:BX.message("DFU_NODE_TEMPLATE_CANCELED"),error:BX.message("DFU_NODE_TEMPLATE_ERROR"),error_double:BX.message("DFU_NODE_TEMPLATE_ERROR_DOUBLE")};var t,i,s,o,r,a;for(t in this.templates){o={};if(this.templates.hasOwnProperty(t)){i=this.templates[t];if(/^<tr(.*?)>/gi.test(i)){s=/^<tr(.*?)>/gi.exec(i);s=s[1].split(" ");if(s&&s.length>0){for(r=0;r<s.length;r++){a=s[r].split("=");if(a&&a.length==2){a[0]=a[0].replace(/['"]/gi,"");a[1]=a[1].replace(/['"]/gi,"");o[a[0]]=a[1]}}}}this.templates[t]={node:"TR",attrs:o,text:i.replace(/^<tr(.*?)>/i,"").replace(/<\/tr>$/i,"")}}}this.agent=BX.Uploader.getInstance({id:this.CID,streams:1,allowUpload:"A",uploadFormData:"Y",uploadMethod:this.bp?this.bpParameters?"deferred":"immediate":"immediate",uploadFileUrl:e["urlUpload"],showImage:false,sortItems:false,input:e["input"],dropZone:e["dropZone"],placeHolder:this.placeHolder,phpMaxFileUploads:1,queueFields:{thumb:{tagName:"TR",className:"bxu-item"}},fields:{thumb:{tagName:"",template:this.templates["new"].text}}});this._onItemIsAdded=BX.delegate(this.onItemIsAdded,this);this._onFileIsInited=BX.delegate(this.onFileIsInited,this);this._onStart=BX.delegate(this.onStart,this);this._onError=BX.delegate(this.onError,this);if(BX(this.agent.fileInput)&&!this.agent.fileInput.hasAttribute("id"))this.agent.fileInput.setAttribute("id","diskUbloadFileInput"+this.CID);BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.addCustomEvent(this.agent,"onFileIsInited",this._onFileIsInited);BX.addCustomEvent(this.agent,"onStart",this._onStart);BX.addCustomEvent(this.agent,"onError",this._onError);BX.addCustomEvent("Disk.Page:onChangeFolder",function(e,t){this.changeTargetFolderId(t.id)}.bind(this));this._onFileIsAppended=BX.delegate(this.onFileIsAppended,this);this._onUploadStart=BX.delegate(this.onUploadStart,this);this._onUploadProgress=BX.delegate(this.onUploadProgress,this);this._onUploadDone=BX.delegate(this.onUploadDone,this);this._onUploadError=BX.delegate(this.onUploadError,this);this._onUploadWindowClose=BX.delegate(this.onUploadWindowClose,this);this._onUploadWindowFirstShow=BX.delegate(this.onUploadWindowFirstShow,this);this._onStartBizproc=BX.delegate(this.onStartBizproc,this);if(BX(e["dropZone"])){var n=BX.create("DIV",{attrs:{className:"wduf-uploader area"},html:BX.message("DFU_DND_TEMPLATE")}),d=BX.pos(e["dropZone"]);BX.adjust(e["dropZone"],{style:{position:"relative"},children:[n]});BX.addCustomEvent(this.agent.dropZone,"dragEnter",function(){var e=BX.GetWindowInnerSize(),t=BX.GetWindowScrollPos();d["height"]=e["innerHeight"]-(d["top"]-t["scrollTop"]);n.style.height=d["height"]+"px"})}}else{setTimeout(BX.delegate(function(){this.init(e)},this),500)}},changeTargetFolderId:function(e){if(this.agent.form&&this.agent.form.targetFolderId){this.agent.form.targetFolderId.value=e;var t=this.agent.getItems().items;for(var i in t){if(!t.hasOwnProperty(i)){continue}var s=t[i];var o=this.agent.getItem(s.id);if(o.node){BX.remove(o.node)}}}},onItemIsAdded:function(){if(this.popup)this.popup.show();else if(this.bp&&this.bpParameters){var e=BX.findChildren(this.nodeContent);e.unshift(BX("parametersFormBp"));this.popup=BX.Disk.modalWindow({modalId:"bx-dfu-upload-"+this.CID,closeIcon:false,title:BX.message("DFU_UPLOAD_TITLE1"),contentClassName:" tac bx-disk-upload-file",withoutWindowManager:true,content:e,events:{onPopupFirstShow:this._onUploadWindowFirstShow,onPopupClose:function(){BX.reload()}},zIndex:-200,htmlButtons:[BX.create("A",{text:BX.message("DFU_SAVE_BP"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0"},events:{click:this._onStartBizproc},attrs:{id:"bx-disk-savebp-button"}}),BX.create("LABEL",{text:BX.message("DFU_UPLOAD"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0 bx-hide-button"},attrs:{id:"bx-disk-upload-button",for:this.agent.fileInput.getAttribute("id")}}),BX.create("A",{text:BX.message("DFU_CLOSE"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-gray mb0"},attrs:{id:this.CID+"ButtonClose",disabled:true},events:{click:this._onUploadWindowClose}})]})}else{this.popup=BX.Disk.modalWindow({modalId:"bx-dfu-upload-"+this.CID,closeIcon:false,title:BX.message("DFU_UPLOAD_TITLE1"),contentClassName:" tac bx-disk-upload-file",content:BX.findChildren(this.nodeContent),events:{onPopupFirstShow:this._onUploadWindowFirstShow,onPopupClose:BX.delegate(function(){BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded)},this)},htmlButtons:[BX.create("LABEL",{text:BX.message("DFU_UPLOAD"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0"},attrs:{for:this.agent.fileInput.getAttribute("id")}}),BX.create("A",{text:BX.message("DFU_CLOSE"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-gray mb0"},attrs:{id:this.CID+"ButtonClose",disabled:true},events:{click:this._onUploadWindowClose}})]})}this.popup.destroy=BX.DoNothing;BX.removeCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded)},onStartBizproc:function(){if(BX("formPostAjax").getElementsByTagName("div").length){BX("formPostAjax").removeChild(BX("divStartBizProc"))}var e=BX("divStartBizProc").cloneNode(true),t=BX("parametersFormBp").querySelectorAll("textarea"),i=BX("parametersFormBp").querySelectorAll("select"),s=e.querySelectorAll("textarea"),o=e.querySelectorAll("select"),r;if(t.length){for(r in t){if(t.hasOwnProperty(r)){s[r].value=t[r].value}}}if(i.length){for(r in i){if(i.hasOwnProperty(r)){o[r].value=i[r].value}}}BX("formPostAjax").appendChild(e);var a=BX.ajax.prepareForm(BX("formPostAjax")),n=this.agent;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","validateParameterAutoloadBizProc"),data:{required:this.bpParametersRequired,data:a,storageId:this.storageId},onsuccess:function(e){if(e.status=="success"){n.submit();BX("formPostAjax").removeChild(BX("divStartBizProc"));BX("errorTd").innerHTML="";if(!BX.hasClass(BX("bx-disk-savebp-button"),"bx-hide-button")){BX.toggleClass(BX("bx-disk-upload-button"),"bx-hide-button");BX.toggleClass(BX("bx-disk-savebp-button"),"bx-hide-button")}}else{if(BX("formPostAjax").getElementsByTagName("div").length){BX("formPostAjax").removeChild(BX("divStartBizProc"))}for(r in e["errors"]){if(e["errors"].hasOwnProperty(r)){BX("errorTd").innerHTML=e["errors"][r].message}}if(BX.hasClass(BX("bx-disk-savebp-button"),"bx-hide-button")){BX.toggleClass(BX("bx-disk-upload-button"),"bx-hide-button");BX.toggleClass(BX("bx-disk-savebp-button"),"bx-hide-button")}}}})},onFileIsInited:function(e,t){this.counter.all.push(e);BX.addCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.addCustomEvent(t,"onUploadStart",this._onUploadStart);BX.addCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.addCustomEvent(t,"onUploadDone",this._onUploadDone);BX.addCustomEvent(t,"onUploadError",this._onUploadError);this.__checkButton();if(this.bp&&this.bpParameters&&this.popup){this.onStartBizproc()}},onFileIsAppended:function(e,t){var i=this.agent.getItem(e);this.__bindEventsToNode(i.node,t)},onUploadStart:function(e){this.counter.uploading.push(e.id);e.__progressBar=BX(e.id+"Progress");e.__progressBarWidth=5;if(e.__progressBar)e.__progressBar.style.width=e.__progressBarWidth+"%"},onUploadProgress:function(e,t){t=Math.min(t,96);if(t>e.__progressBarWidth){e.__progressBarWidth=Math.ceil(t);e.__progressBarWidth=e.__progressBarWidth>100?100:e.__progressBarWidth;if(e.__progressBar)e.__progressBar.style.width=e.__progressBarWidth+"%"}},onUploadDone:function(e,t){if(e.__progressBar)e.__progressBar.style.width="100%";this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,BX.util.array_search(e.id,this.counter.uploading));this.counter.uploaded.push(e.id);e.fileId=t["file"]["fileId"];var i=this.agent.getItem(e.id).node,s=this._camelToSNAKE(t["file"]);if(BX(i)){var o=this.templates.done.text;for(var r in s){if(s.hasOwnProperty(r)){o=o.replace(new RegExp("#"+r.toLowerCase()+"#","gi"),BX.util.htmlspecialchars(s[r])).replace(new RegExp("#"+r.toUpperCase()+"#","gi"),BX.util.htmlspecialchars(s[r]))}}var a;if(BX.browser.IsIE8()){a=i;while(a.cells.length>0){a.deleteCell(0)}var n=0;o.replace(/<\/td>/gi,"\x02").replace(/<td([^>]+)>([^\002]+)\002/gi,function(e,t,i){var s=a.insertCell(n);s.innerHTML=i;t.replace(/class=["']([a-z\-\s]+)['"]/,function(e,t){s.className=t});n++;return""})}else{a=BX.create("TR",{attrs:this.templates.done.attrs,html:o});a.setAttribute("id",i.getAttribute("id"));i.parentNode.replaceChild(a,i)}}else{this.onUploadError(e,t)}this.__bindEventsToNode(i,e);this.__checkButton()},onUploadError:function(e,t,i){this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,BX.util.array_search(e.id,this.counter.uploading));t=typeof t=="object"&&t?t:{};var s=this.agent.getItem(e.id).node,o=this._camelToSNAKE(t);if(BX(s)&&(i==true||!BX(s).hasAttribute("bx-disk-error"))){o=!!o&&typeof o=="object"?o:{};var r=o["file"]&&o["file"]["isNotUnique"]?this.templates.error_double:this.templates.error,a=r.text,n;for(n in e){if(e.hasOwnProperty(n)&&typeof e[n]=="string"){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),BX.util.htmlspecialchars(e[n])).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),BX.util.htmlspecialchars(e[n]))}}if(o){for(n in o){if(o.hasOwnProperty(n)){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),BX.util.htmlspecialchars(o[n])).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),BX.util.htmlspecialchars(o[n]))}}if(o["file"]){for(n in o["file"]){if(o["file"].hasOwnProperty(n)){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),BX.util.htmlspecialchars(o["file"][n])).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),BX.util.htmlspecialchars(o["file"][n]))}}}}var d=BX.create("TR",{attrs:r.attrs,html:a});d.setAttribute("id",s.getAttribute("id"));d.setAttribute("bx-disk-error","Y");s.parentNode.replaceChild(d,s);this.__bindEventsToNode(d,e);this.__checkButton();if(this.uploadParams.errored<=0){var l=BX.pos(d),p=BX.pos(this.placeHolder);this.placeHolder.parentNode.scrollTop=l.top-p.top}this.uploadParams.errored++}else{BX.debug("BX.Disk.Upload: node for error does not exist.")}},uploadParams:{errored:0},onStart:function(){this.uploadParams.errored=0},onError:function(e,t,i){if(i&&i.status==="restriction"&&BX("bx-bitrix24-business-tools-info")){BX.PopupWindowManager.create("bx-disk-business-tools-info",null,{content:BX("bx-bitrix24-business-tools-info"),closeIcon:true,onPopupClose:function(){this.destroy()},autoHide:true}).show()}var s="Uploading error.",o=s,r,a;if(i){if(i["error"]&&typeof i["error"]=="string")o=i["error"];else if(i["message"]&&typeof i["message"]=="string")o=i["message"];else if(BX.type.isArray(i["errors"])&&i["errors"].length>0){o=[];for(var n=0;n<i["errors"].length;n++){if(typeof i["errors"][n]=="object"&&i["errors"][n]["message"])o.push(i["errors"][n]["message"])}if(o.length<=0)o.push(s);o=o.join(" ")}}e["files"]=e.files||{};for(a in e["files"]){if(e["files"].hasOwnProperty(a)){r=this.agent.queue.items.getItem(a);this.onUploadError(r,{error:o},o!=s)}}},deleteFile:function(e,t){BX.addClass(e,"bx-disk-popup-upload-file-delete-event");var i=BX.findChild(e,{className:"file-delete"},true),s=BX.util.array_search(t.id,this.counter.uploaded);if(s>=0)this.counter.uploaded=BX.util.deleteFromArray(this.counter.uploaded,s);s=BX.util.array_search(t.id,this.counter.uploading);if(s>=0)this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,s);this.counter.all=BX.util.deleteFromArray(this.counter.all,BX.util.array_search(t.id,this.counter.all));delete t.hash;setTimeout(function(){t.deleteFile("deleteFile")},400);if(!!i&&i.getAttribute("href").length>0)BX.ajax.post(i.href,{sessid:BX.bitrix_sessid()});this.__checkButton()},replaceFile:function(e,t){if(BX(e)){var i=this.templates["new"].text;for(var s in t){if(t.hasOwnProperty(s)){i=i.replace(new RegExp("#"+s.toLowerCase()+"#","gi"),BX.util.htmlspecialchars(t[s])).replace(new RegExp("#"+s.toUpperCase()+"#","gi"),BX.util.htmlspecialchars(t[s]))}}var o=BX.create("TR",{attrs:this.templates["new"].attrs,html:i});o.setAttribute("id",e.getAttribute("id"));e.parentNode.replaceChild(o,e);this.__bindEventsToNode(e,t);this.__checkButton();var r=t.file.uploadStatus;this.agent.queue.restoreFiles(new BX.UploaderUtils.Hash(t.id,t),true);t.file.uploadStatus=r;if(this.agent.post){this.agent.post.data["REPLACE_FILE"]=this.agent.post.data["REPLACE_FILE"]||[];this.agent.post.data["REPLACE_FILE"].push(t.id)}var a;if(this.agent.form){a=BX.create("INPUT",{attrs:{id:"input"+t.id},props:{name:"REPLACE_FILE[]",value:t.id}});this.agent.form.appendChild(a)}this.agent.submit();if(this.agent.post){this.agent.post.data["REPLACE_FILE"].pop()}if(this.agent.form){BX.remove(a)}}},__checkButton:function(){var e=BX(this.CID+"ButtonClose"),t=BX(this.CID+"Number"),i=BX(this.CID+"Count");if(e)BX.adjust(e,{props:{disabled:this.counter.uploading.length>0}});if(t)t.innerHTML=this.counter.uploaded.length;if(i)i.innerHTML=this.counter.all.length},__bindEventsToNode:function(e,t){var i=BX.delegate(function(){this.deleteFile(e,t)},this),s=BX.delegate(function(i){BX.PreventDefault(i);this.replaceFile(e,t);return false},this),o=BX.findChild(e,{attribute:{id:t.id+"Cancel"}},true),r=BX.findChild(e,{attribute:{id:t.id+"Replace"}},true);if(o&&!o.hasAttribute("bx-bound")){o.setAttribute("bx-bound","Y");BX.bind(o,"click",i)}if(r&&!r.hasAttribute("bx-bound")){r.setAttribute("bx-bound","Y");BX.bind(r,"click",s)}},onUploadWindowFirstShow:function(e){this.agent.initDropZone(e.contentContainer);if(this.bp&&this.bpParameters){var t=BX.findChildrenByClassName(BX("parametersFormBp"),"bx-html-editor"),i;for(var s in t){if(t.hasOwnProperty(s)){i=t[s].getAttribute("id").replace("bx-html-editor-","");window["BXHtmlEditor"].editors[i].CheckAndReInit()}}}},onUploadWindowClose:function(){if(this.popup&&this.counter.uploading.length<=0){this.popup.close();if(this.counter.uploaded.length>0){var e,t;var i=this.counter.uploaded.length;while((t=this.agent.getItem(this.counter.uploaded.pop()))&&t&&t["item"]&&(t=t["item"])){if(t["fileId"]){e=BX.Disk.getUrlToShowObjectInGrid(t["fileId"]);break}}if(i===1&&BX.SidePanel.Instance.getSliderByWindow(window)){document.location.reload();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onNewVersionUploaded",{objectId:t["fileId"]})}else{BX.onCustomEvent("onPopupFileUploadClose",[this,t["fileId"]])}}}}};BX.DiskUpload.initialize=function(t){t["CID"]=t["CID"]?t["CID"]:"DiskUpload";var i=BX.create("INPUT",{attrs:{id:"inputContainer"+t["CID"]},props:{type:"file",multiple:true,title:BX.message("DFU_UPLOAD_TITLE1")}});var s=BX.create("FORM",{attrs:{id:"formPostAjax"},style:{display:"none"},children:[i,t["targetFileId"]?BX.create("INPUT",{props:{type:"hidden",name:"targetFileId",value:t["targetFileId"]}}):BX.create("INPUT",{props:{type:"hidden",name:"targetFolderId",value:t["targetFolderId"]}})]});var o=BX.create("LABEL",{attrs:{id:"inputContainerLabel"+t["CID"],title:BX.message("DFU_UPLOAD_TITLE1"),for:"inputContainer"+t["CID"]},children:[]});var r=BX.create("DIV",{style:{display:"none"}});document.body.appendChild(r);if(t["inputContainer"]){var a=BX(t["inputContainer"]);BX.adjust(o,{attrs:{className:a.className,id:a.id,title:BX.message("DFU_UPLOAD_TITLE1"),for:"inputContainer"+t["CID"]},html:a.innerHTML});o.appendChild(s);a.parentNode.replaceChild(o,a)}else{o.appendChild(s);r.appendChild(o);BX.addCustomEvent(window,"onDiskUploadPopupShow",function(e){e.appendChild(o)});BX.addCustomEvent(window,"onDiskUploadPopupClose",function(e){r.appendChild(o)})}t["input"]=i;if(!e[t["CID"]]){e[t["CID"]]=new BX.DiskUpload(t)}return e[t["CID"]]};BX.DiskUpload.getObj=function(t){return e[t]}})();
//# sourceMappingURL=script.map.js