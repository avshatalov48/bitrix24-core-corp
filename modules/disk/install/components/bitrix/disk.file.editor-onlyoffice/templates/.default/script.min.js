this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(exports,main_popup,disk_users,main_core_events,disk_sharingLegacyPopup,disk_externalLink,disk_onlyofficePromoPopup,ui_buttons,main_core_cache,main_core,pull_client){"use strict";function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var ALLOWED_ATTEMPTS_TO_GET_USER_INFO=3;var SECONDS_TO_ACTUALIZE_ONLINE=25;var _makeLinkAbsolute=new WeakSet;var UserManager=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_makeLinkAbsolute);babelHelpers.defineProperty(this,"userBoxNode",null);babelHelpers.defineProperty(this,"context",null);babelHelpers.defineProperty(this,"alreadySaidHi",false);this.users=new BX.Disk.Users([]);this.badAttempts=new Map;this.context=t.context;this.userBoxNode=t.userBoxNode;this.alreadySaidHi=false;this.add(this.context.currentUser);this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){var t=this;main_core_events.EventEmitter.subscribe("onPullStatus",(function(e){if(e.getData()[0]==="online"){t.handleWhenPullConnected()}}))}},{key:"handleWhenPullConnected",value:function e(){if(!this.sentGreetings()){this.sendHiToUsers();setInterval(this.actualizeOnline.bind(this),1e3*SECONDS_TO_ACTUALIZE_ONLINE)}}},{key:"actualizeOnline",value:function e(){this.refineUsersByOnline();if(!this.sentGreetings()){this.sendHiToUsers()}else{this.sendPingToUsers()}}},{key:"sentGreetings",value:function e(){return this.alreadySaidHi}},{key:"sendHiToUsers",value:function e(){if(!pull_client.PULL.isConnected()){return}pull_client.PULL.sendMessageToChannels([this.context.object.publicChannel],"disk","hiToDocument",{user:{id:this.context.currentUser.id,name:this.context.currentUser.name,avatar:_classPrivateMethodGet(this,_makeLinkAbsolute,_makeLinkAbsolute2).call(this,this.context.currentUser.avatar)}});this.alreadySaidHi=true}},{key:"sendWelcomeToUser",value:function e(){if(!pull_client.PULL.isConnected()){return}pull_client.PULL.sendMessageToChannels([this.context.object.publicChannel],"disk","welcomeToDocument",{user:{id:this.context.currentUser.id,name:this.context.currentUser.name,avatar:_classPrivateMethodGet(this,_makeLinkAbsolute,_makeLinkAbsolute2).call(this,this.context.currentUser.avatar)}})}},{key:"sendPingToUsers",value:function e(){if(!pull_client.PULL.isConnected()){return}pull_client.PULL.sendMessageToChannels([this.context.object.publicChannel],"disk","pingDocument",{fromUserId:this.context.currentUser.id,infoToken:this.context.currentUser.infoToken})}},{key:"add",value:function e(t){if(!this.users.hasUser(t.id)){this.users.addUser(t);console.log("Hi new user!",t.id)}this.updateOnline(t.id);this.renderBox()}},{key:"updateOnline",value:function e(t){if(this.users.hasUser(t)){this.users.getUser(t).onlineAt=Date.now()}}},{key:"getUserInfo",value:function e(t,n){var i=this;if(this.badAttempts.get(t)>=ALLOWED_ATTEMPTS_TO_GET_USER_INFO){return new Promise((function(e,t){t({status:"blocked"})}))}return new Promise((function(e,o){main_core.ajax.runComponentAction("bitrix:disk.file.editor-onlyoffice","getUserInfo",{mode:"ajax",json:{documentSessionId:i.context.documentSession.id,documentSessionHash:i.context.documentSession.hash,userId:t,infoToken:n}}).then((function(n){if(n.status==="success"){i.badAttempts["delete"](t);e(n.data.user)}}),(function(e){var n=i.badAttempts.get(t)||0;i.badAttempts.set(t,n+1);console.log(i.badAttempts);o(e)}))}))}},{key:"has",value:function e(t){return this.users.hasUser(t)}},{key:"remove",value:function e(t){if(t===this.context.currentUser.id){return}this.users.deleteUser(t);this.renderBox()}},{key:"refineUsersByOnline",value:function e(){var t=this;var n=1e3*(SECONDS_TO_ACTUALIZE_ONLINE+1)*2;var i=Date.now();this.users.forEach((function(e){if(i-e.onlineAt>n){t.remove(e.id)}}))}},{key:"renderBox",value:function e(){if(!this.userBoxNode.childElementCount){this.userBoxNode.appendChild(this.users.getContainer())}}}]);return e}();function _makeLinkAbsolute2(e){if(e.includes("http://")||e.includes("https://")){return e}return document.location.origin+e}var BaseCommandHandler=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"options",null);babelHelpers.defineProperty(this,"onlyOffice",null);babelHelpers.defineProperty(this,"userManager",null);this.options=t;this.userManager=t.userManager;this.context=t.context;this.onlyOffice=t.onlyOffice}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"disk"}},{key:"getSubscriptionType",value:function e(){return pull_client.PullClient.SubscriptionType.Server}},{key:"filterCurrentObject",value:function e(t){var n=this;return function(e){if(n.context.object.id!==e.object.id){return}return t(e)}}},{key:"isCurrentUser",value:function e(t){return this.context.currentUser.id===t}}]);return e}();var ClientCommandHandler=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getSubscriptionType",value:function e(){return pull_client.PullClient.SubscriptionType.Client}},{key:"getMap",value:function e(){return{exitDocument:this.handleExitDocument.bind(this),pingDocument:this.handlePingDocument.bind(this),hiToDocument:this.handleHiToDocument.bind(this),welcomeToDocument:this.handleWelcomeToDocument.bind(this)}}},{key:"handleExitDocument",value:function e(t){console.log("exitDocument",t);var n=t.fromUserId;if(!this.isCurrentUser(n)){this.userManager.remove(n)}}},{key:"handleWelcomeToDocument",value:function e(t){console.log("handleWelcomeToDocument",t);this.processNewbieInDocument(t)}},{key:"handleHiToDocument",value:function e(t){console.log("handleHiToDocument",t);var n=this.processNewbieInDocument(t);if(n){this.userManager.sendWelcomeToUser()}}},{key:"processNewbieInDocument",value:function e(t){var n=t.user.id;if(this.isCurrentUser(n)){return false}if(this.userManager.has(n)){this.userManager.updateOnline(n);return false}this.userManager.add(t.user);return true}},{key:"handlePingDocument",value:function e(t){var n=this;console.log("handlePingDocument",t);var i=t.fromUserId;if(this.isCurrentUser(i)){return}if(this.userManager.has(i)){this.userManager.updateOnline(i)}else{if(this.userManager.sentGreetings()){this.userManager.getUserInfo(t.fromUserId,t.infoToken).then((function(e){n.userManager.add(e)}),(function(){}))}}}}]);return t}(BaseCommandHandler);var _templateObject,_templateObject2;function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$1(e,t);t.add(e)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var _handleClickToRefreshEditor=new WeakSet;var ServerCommandHandler=function(e){babelHelpers.inherits(t,e);function t(){var e;var n;babelHelpers.classCallCheck(this,t);for(var i=arguments.length,o=new Array(i),s=0;s<i;s++){o[s]=arguments[s]}n=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(o)));_classPrivateMethodInitSpec$1(babelHelpers.assertThisInitialized(n),_handleClickToRefreshEditor);return n}babelHelpers.createClass(t,[{key:"getMap",value:function e(){return{onlyoffice:this.filterCurrentObject(this.handleSavedDocument.bind(this)),contentUpdated:this.filterCurrentObject(this.handleContentUpdated.bind(this))}}},{key:"handleSavedDocument",value:function e(t){console.log("handleSavedDocument",t);if(t.documentSessionInfo.wasFinallySaved){BX.UI.Notification.Center.notify({autoHide:false,content:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_SAVED_AFTER_IDLE")})}}},{key:"handleContentUpdated",value:function e(t){var n=this;console.log("handleContentUpdated",t);if(!t.object.updatedBy||this.isCurrentUser(t.object.updatedBy)){return}if(this.onlyOffice.wasDocumentChanged()){this.userManager.getUserInfo(t.object.updatedBy,t.updatedBy.infoToken).then((function(e){BX.UI.Notification.Center.notify({content:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_SAVED_WHILE_EDITING",{"#NAME#":main_core.Text.encode(t.object.name),"#USER_NAME#":main_core.Text.encode(e.name)})})}),(function(){}))}else if(this.onlyOffice.isViewMode()){this.userManager.getUserInfo(t.object.updatedBy,t.updatedBy.infoToken).then((function(e){var i=main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_VIEW_NON_ACTUAL_VERSION",{"#NAME#":main_core.Text.encode(t.object.name),"#USER_NAME#":main_core.Text.encode(e.name)});i=main_core.Tag.render(_templateObject||(_templateObject=babelHelpers.taggedTemplateLiteral(["<span>","</span>"])),i);var o=i.querySelector("[data-refresh-btn]");if(o){main_core.Tag.style(o)(_templateObject2||(_templateObject2=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t"])));o.addEventListener("click",_classPrivateMethodGet$1(n,_handleClickToRefreshEditor,_handleClickToRefreshEditor2).bind(n))}BX.UI.Notification.Center.notify({content:i})}),(function(){}))}}}]);return t}(BaseCommandHandler);function _handleClickToRefreshEditor2(){this.onlyOffice.reloadView()}var _templateObject$1,_templateObject2$1;var CustomErrorControl=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"showWhenTooLarge",value:function e(t,n,i,o){this.showCommonWarning({container:n,targetNode:i,title:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_LARGE_FILE_TITLE"),description:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_LARGE_FILE_DESCR"),fileName:t,linkToDownload:o})}},{key:"showWhenNotFound",value:function e(t,n){this.showCommonWarning({container:t,targetNode:n,title:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_FILE_TITLE"),description:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_RIGHTS_OR_NOT_FOUND_DESCR")})}},{key:"showCommonWarning",value:function e(t){var n="disk-fe-office-warning--popup";var i="";if(t.fileName){i=main_core.Tag.render(_templateObject$1||(_templateObject$1=babelHelpers.taggedTemplateLiteral(['<div class="disk-fe-office-warning-file-name">',"</div>"])),main_core.Text.encode(t.fileName))}var o="";if(t.linkToDownload){var s=new ui_buttons.Button({text:main_core.Loc.getMessage("DISK_FILE_EDITOR_ONLYOFFICE_HEADER_BTN_DOWNLOAD"),round:true,tag:ui_buttons.Button.Tag.LINK,link:t.linkToDownload,color:ui_buttons.Button.Color.SUCCESS,className:"disk-fe-office-warning-btn",props:{target:"_blank"}});o=s.render()}var a=main_core.Tag.render(_templateObject2$1||(_templateObject2$1=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-fe-office-warning-wrap">\n\t\t\t\t<div class="disk-fe-office-warning-overlay"></div>\n\t\t\t\t<div class="disk-fe-office-warning-box">\n\t\t\t\t\t<div class="disk-fe-office-warning-icon"></div>\n\t\t\t\t\t<div class="disk-fe-office-warning-title">',"</div>\n\t\t\t\t\t",'\n\t\t\t\t\t<div class="disk-fe-office-warning-desc">',"</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),t.title,i,t.description,o);main_core.Dom.addClass(t.container,n);main_core.Dom.prepend(a,t.targetNode)}}]);return e}();function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var SECONDS_TO_MARK_AS_STILL_WORKING=60;var cache=new main_core_cache.LocalStorageCache;var _trackWork=new WeakSet;var OnlyOffice=function(){function OnlyOffice(e){babelHelpers.classCallCheck(this,OnlyOffice);_classPrivateMethodInitSpec$2(this,_trackWork);babelHelpers.defineProperty(this,"editor",null);babelHelpers.defineProperty(this,"editorJson",null);babelHelpers.defineProperty(this,"userBoxNode",null);babelHelpers.defineProperty(this,"editorNode",null);babelHelpers.defineProperty(this,"editorWrapperNode",null);babelHelpers.defineProperty(this,"targetNode",null);babelHelpers.defineProperty(this,"documentSession",null);babelHelpers.defineProperty(this,"linkToEdit",null);babelHelpers.defineProperty(this,"linkToView",null);babelHelpers.defineProperty(this,"linkToDownload",null);babelHelpers.defineProperty(this,"pullConfig",null);babelHelpers.defineProperty(this,"editButton",null);babelHelpers.defineProperty(this,"setupSharingButton",null);babelHelpers.defineProperty(this,"documentWasChanged",false);babelHelpers.defineProperty(this,"dontEndCurrentDocumentSession",false);babelHelpers.defineProperty(this,"context",null);babelHelpers.defineProperty(this,"usersInDocument",null);babelHelpers.defineProperty(this,"sharingControlType",null);babelHelpers.defineProperty(this,"brokenDocumentOpened",false);var t=main_core.Type.isPlainObject(e)?e:{};this.pullConfig=t.pullConfig;this.documentSession=t.documentSession;this.linkToEdit=t.linkToEdit;this.linkToView=t.linkToView;this.linkToDownload=t.linkToDownload;this.targetNode=t.targetNode;this.userBoxNode=t.userBoxNode;this.editorNode=t.editorNode;this.editorWrapperNode=t.editorWrapperNode;this.editButton=ui_buttons.ButtonManager.createByUniqId(e.panelButtonUniqIds.edit);this.setupSharingButton=ui_buttons.ButtonManager.createByUniqId(e.panelButtonUniqIds.setupSharing);this.sharingControlType=e.sharingControlType;this.context={currentUser:t.currentUser,documentSession:this.documentSession,object:t.object,attachedObject:t.attachedObject};this.context.object.publicChannel=t.publicChannel;this.usersInDocument=new UserManager({context:this.context,userBoxNode:this.userBoxNode});this.sendTelemetryEvent("load");this.initializeEditor(t.editorJson);var n=BX.SidePanel.Instance.getSliderByWindow(window);if(n){n.getData().set("documentSession",this.documentSession)}this.loadDiskExtensionInTopWindow();this.initPull();this.bindEvents();if(this.isEditMode()){this.registerTimerToTrackWork()}if(disk_onlyofficePromoPopup.PromoPopup.shouldShowViewPromo()){disk_onlyofficePromoPopup.PromoPopup.showViewPromo()}}babelHelpers.createClass(OnlyOffice,[{key:"registerTimerToTrackWork",value:function e(){setInterval(_classPrivateMethodGet$2(this,_trackWork,_trackWork2).bind(this),SECONDS_TO_MARK_AS_STILL_WORKING*1e3)}},{key:"initPull",value:function e(){if(this.pullConfig){BX.PULL=new pull_client.PullClient({skipStorageInit:true});BX.PULL.start(this.pullConfig)}}},{key:"sendTelemetryEvent",value:function e(t,n){n=n||{};var i=BX.SidePanel.Instance.getSliderByWindow(window);if(!i){return}var o=i.getData();n.action=t;n.uid=o.get("uid");n.documentSessionId=this.context.documentSession.id;n.documentSessionHash=this.context.documentSession.hash;n.fileSize=this.context.object.size;BX.Disk.sendTelemetryEvent(n)}},{key:"bindEvents",value:function e(){var t=this;main_core_events.EventEmitter.subscribe("SidePanel.Slider:onClose",this.handleSliderClose.bind(this));window.addEventListener("beforeunload",this.handleClose.bind(this));if(window.top!==window){window.addEventListener("message",(function(e){if(e.data==="closeIframe"){t.handleClose()}}))}if(this.editorJson.document.permissions.edit===true&&this.editButton){if(this.editButton.hasOwnProperty("mainButton")){this.editButton.getMainButton().bindEvent("click",this.handleClickEditButton.bind(this));var n=this.editButton.getMenuWindow();var i=main_core.Runtime.clone(n.getMenuItems());for(var o=0;o<i.length;o++){var s=i[o];var a=main_core.Runtime.clone(s.options);a.onclick=this.handleClickEditSubItems.bind(this);n.removeMenuItem(s.getId());n.addMenuItem(a)}}else{this.editButton.bindEvent("click",this.handleClickEditButton.bind(this))}}if(this.setupSharingButton){var r=this.setupSharingButton.getMenuWindow();var l=r.getMenuItem("ext-link").options;l.onclick=this.handleClickSharingByExternalLink.bind(this);r.removeMenuItem("ext-link");r.addMenuItem(l);var c=r.getMenuItem("sharing").options;c.onclick=this.handleClickSharing.bind(this);r.removeMenuItem("sharing");r.addMenuItem(c)}pull_client.PULL.subscribe(new ClientCommandHandler({onlyOffice:this,context:this.context,userManager:this.usersInDocument}));pull_client.PULL.subscribe(new ServerCommandHandler({onlyOffice:this,context:this.context,userManager:this.usersInDocument}))}},{key:"initializeEditor",value:function e(t){t.events={onDocumentStateChange:this.handleDocumentStateChange.bind(this),onDocumentReady:this.handleDocumentReady.bind(this),onMetaChange:this.handleMetaChange.bind(this),onInfo:this.handleInfo.bind(this),onWarning:this.handleWarning.bind(this),onError:this.handleError.bind(this),onRequestClose:this.handleRequestClose.bind(this)};if(t.document.permissions.rename){t.events.onRequestRename=this.handleRequestRename.bind(this)}this.editorJson=t;this.editor=new DocsAPI.DocEditor(this.editorNode.id,t)}},{key:"loadDiskExtensionInTopWindow",value:function e(){if(window.top!==window&&!BX.getClass("window.top.BX.Disk.endEditSession")){top.BX.loadExt("disk")}}},{key:"emitEventOnSaved",value:function e(){var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){BX.SidePanel.Instance.postMessageAll(window,"Disk.OnlyOffice:onSaved",{documentSession:this.documentSession,object:this.context.object})}main_core_events.EventEmitter.emit("Disk.OnlyOffice:onSaved",{documentSession:this.documentSession,object:this.context.object})}},{key:"emitEventOnClosed",value:function e(){var t=BX.SidePanel.Instance.getSliderByWindow(window);var n="edit";if(t){n=t.getData().get("process")||"edit";BX.SidePanel.Instance.postMessageAll(window,"Disk.OnlyOffice:onClosed",{documentSession:this.documentSession,object:this.context.object,process:n})}main_core_events.EventEmitter.emit("Disk.OnlyOffice:onClosed",{documentSession:this.documentSession,object:this.context.object,process:n})}},{key:"handleClickEditButton",value:function e(){if(disk_onlyofficePromoPopup.PromoPopup.shouldShowEditPromo()){disk_onlyofficePromoPopup.PromoPopup.showEditPromo();return}this.handleRequestEditRights()}},{key:"handleClickSharing",value:function e(){switch(this.sharingControlType){case disk_sharingLegacyPopup.SharingControlType.WITH_CHANGE_RIGHTS:(new disk_sharingLegacyPopup.LegacyPopup).showSharingDetailWithChangeRights({object:this.context.object});break;case disk_sharingLegacyPopup.SharingControlType.WITH_SHARING:(new disk_sharingLegacyPopup.LegacyPopup).showSharingDetailWithChangeRights({object:this.context.object});break;case disk_sharingLegacyPopup.SharingControlType.WITHOUT_EDIT:(new disk_sharingLegacyPopup.LegacyPopup).showSharingDetailWithoutEdit({object:this.context.object});break;case disk_sharingLegacyPopup.SharingControlType.BLOCKED_BY_FEATURE:BX.UI.InfoHelper.show("limit_office_files_access_permissions");break}}},{key:"handleClickSharingByExternalLink",value:function handleClickSharingByExternalLink(event,menuItem){if(menuItem.dataset.shouldBlockExternalLinkFeature){eval(menuItem.dataset.blockerExternalLinkFeature);return}disk_externalLink.ExternalLink.showPopup(this.context.object.id)}},{key:"handleClickEditSubItems",value:function e(t,n){var i=n.getId();if(i==="onlyoffice"){this.handleClickEditButton();return}BX.Disk.Viewer.Actions.runActionEdit({name:this.context.object.name,objectId:this.context.object.id,attachedObjectId:this.context.attachedObject.id,serviceCode:i})}},{key:"handleSaveButtonClick",value:function e(){var t=this;pull_client.PULL.subscribe({moduleId:"disk",command:"onlyoffice",callback:function e(n){if(n.hash===t.documentSession.hash){t.emitEventOnSaved();window.BX.Disk.showModalWithStatusAction();BX.SidePanel.Instance.close()}}})}},{key:"handleRequestClose",value:function e(){console.log("handleRequestClose");var t=BX.SidePanel.Instance.getSliderByWindow(window);if(!t){return}t.getData().set("dontInvokeRequestClose",true);this.handleClose();t.close()}},{key:"isDocumentReadyToEdit",value:function e(){if(this.brokenDocumentOpened){return false}if(!this.caughtDocumentReady){return false}return true}},{key:"handleSliderClose",value:function e(t){console.log("handleSliderClose");var n=BX.SidePanel.Instance.getSliderByWindow(window);if(!n){return}var i=n.getData();var o=i.get("uid");var s=t.getData(),a=babelHelpers.slicedToArray(s,1),r=a[0];if(r.getSlider().getData().get("uid")!==o){return}if(this.isViewMode()||!this.isDocumentReadyToEdit()){this.handleClose();return}if(this.editor.hasOwnProperty("requestClose")){if(i.get("dontInvokeRequestClose")){return}this.editor.requestClose();r.denyAction()}else{this.handleClose()}}},{key:"handleClose",value:function e(){console.log("handleClose");pull_client.PULL.sendMessageToChannels([this.context.object.publicChannel],"disk","exitDocument",{fromUserId:this.context.currentUser.id});this.sendTelemetryEvent("exit");this.emitEventOnClosed();if(this.dontEndCurrentDocumentSession){return}top.BX.Disk.endEditSession({id:this.documentSession.id,hash:this.documentSession.hash,documentWasChanged:this.documentWasChanged})}},{key:"handleDocumentStateChange",value:function e(t){if(!this.caughtDocumentReady||!this.caughtInfoEvent){return}if(Date.now()-Math.max(this.caughtDocumentReady,this.caughtInfoEvent)<500){return}this.documentWasChanged=true}},{key:"wasDocumentChanged",value:function e(){return this.documentWasChanged}},{key:"isEditMode",value:function e(){return this.editorJson.editorConfig.mode==="edit"}},{key:"isViewMode",value:function e(){return!this.isEditMode()}},{key:"reloadView",value:function e(){if(this.isViewMode()){document.location=this.linkToView}}},{key:"handleInfo",value:function e(){this.caughtInfoEvent=Date.now()}},{key:"handleWarning",value:function e(t){console.log("onlyoffice warning:",t.data)}},{key:"handleError",value:function e(t){var n=this;console.log("onlyoffice error:",t.data);if(t.data.errorCode===-82){this.brokenDocumentOpened=true;this.processBrokenDocument()}else if(t.data.errorCode===-84){setTimeout((function(){(new CustomErrorControl).showWhenTooLarge(n.context.object.name,n.getEditorWrapperNode(),n.getContainer(),n.linkToDownload)}),100)}}},{key:"processBrokenDocument",value:function e(){if(!this.context.documentSession.id||!this.brokenDocumentOpened){return}var t="oo_broken_doc_".concat(this.context.documentSession.id);var n=cache.get(t);if(n&&Date.now()-n<1e3*60){return}main_core.ajax.runAction("disk.api.onlyoffice.recoverSessionWithBrokenFile",{mode:"ajax",json:{force:true,sessionId:this.documentSession.id,documentSessionHash:this.documentSession.hash}}).then((function(e){if(e.status==="success"){document.location.href=e.data.link}}));cache.set(t,Date.now())}},{key:"handleRequestRename",value:function e(t){var n=t.data;main_core.ajax.runAction("disk.api.onlyoffice.renameDocument",{mode:"ajax",json:{documentSessionId:this.context.documentSession.id,documentSessionHash:this.context.documentSession.hash,newName:n}})}},{key:"handleMetaChange",value:function e(t){}},{key:"handleDocumentReady",value:function e(){this.sendTelemetryEvent("ready");this.caughtDocumentReady=Date.now()}},{key:"handleRequestEditRights",value:function e(){this.dontEndCurrentDocumentSession=true;var t=BX.util.add_url_param("/bitrix/services/main/ajax.php",{action:"disk.api.documentService.goToEdit",serviceCode:"onlyoffice",documentSessionId:this.documentSession.id,documentSessionHash:this.documentSession.hash});if(this.linkToEdit){t=this.linkToEdit}var n=BX.SidePanel.Instance.getSliderByWindow(window);if(!n){window.location=t;return}var i=n.getCustomLeftBoundary();n.close();BX.SidePanel.Instance.open(t,{width:"100%",customLeftBoundary:i,cacheable:false,allowChangeHistory:false,data:{documentEditor:true}})}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorNode",value:function e(){return this.editorNode}},{key:"getEditorWrapperNode",value:function e(){return this.editorWrapperNode}},{key:"getContainer",value:function e(){return this.targetNode}}]);return OnlyOffice}();function _trackWork2(){main_core.ajax.runComponentAction("bitrix:disk.file.editor-onlyoffice","markAsStillWorkingSession",{mode:"ajax",json:{documentSessionId:this.context.documentSession.id,documentSessionHash:this.context.documentSession.hash}})}var Waiting=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"documentSession",null);babelHelpers.defineProperty(this,"object",null);var n=main_core.Type.isPlainObject(t)?t:{};this.documentSession=n.documentSession;this.object=n.object;var i=new BX.Loader({target:n.targetNode});i.show();this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){pull_client.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"disk",command:"onlyoffice",callback:this.handleSavedDocument.bind(this)})}},{key:"handleSavedDocument",value:function e(t){console.log("handleSavedDocument",t);main_core.ajax.runAction("disk.api.onlyoffice.continueWithNewSession",{mode:"ajax",json:{sessionId:this.documentSession.id,documentSessionHash:this.documentSession.hash}}).then((function(e){if(e.status==="success"){document.location.href=e.data.documentSession.link}}))}}]);return e}();exports.OnlyOffice=OnlyOffice;exports.Waiting=Waiting;exports.CustomErrorControl=CustomErrorControl})(this.BX.Disk.Editor=this.BX.Disk.Editor||{},BX.Main,BX.Disk,BX.Event,BX.Disk.Sharing,BX.Disk,BX.Disk.OnlyOfficePromo,BX.UI,BX.Cache,BX,BX);
//# sourceMappingURL=script.map.js