{"version":3,"file":"script.js","sources":["src/onlyoffice.js"],"sourcesContent":["import {Type, ajax as Ajax} from \"main.core\";\nimport { EventEmitter } from 'main.core.events';\nimport {PULL} from \"pull.client\";\nimport type {EditorOptions, DocumentSession} from \"./types\";\n\nexport default class OnlyOffice\n{\n\teditor: any = null;\n\teditorJson: any = null;\n\teditorNode: HTMLElement = null;\n\teditorWrapperNode: HTMLElement = null;\n\ttargetNode: HTMLElement = null;\n\tdocumentSession: DocumentSession = null;\n\tobject: BaseObject = null;\n\tdocumentWasChanged: boolean = false;\n\tdontEndCurrentDocumentSession: boolean = false;\n\n\tconstructor(editorOptions: EditorOptions)\n\t{\n\t\tconst options = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.object = options.object;\n\t\tthis.targetNode = options.targetNode;\n\t\tthis.editorNode = options.editorNode;\n\t\tthis.editorWrapperNode = options.editorWrapperNode;\n\n\t\tthis.initializeEditor(options.editorJson);\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tcurrentSlider.getData().set('documentSession', this.documentSession);\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe(\"SidePanel.Slider:onClose\", this.handleClose.bind(this));\n\t}\n\n\tinitializeEditor(options): void\n\t{\n\t\tthis.adjustEditorHeight(options);\n\t\toptions.events = {\n\t\t\tonDocumentStateChange: this.handleDocumentStateChange.bind(this),\n\t\t\tonDocumentReady: this.handleDocumentReady.bind(this),\n\t\t\tonInfo: this.handleInfo.bind(this),\n\t\t\t// onRequestClose: this.handleClose.bind(this),\n\t\t}\n\n\t\tif (options.document.permissions.edit === true)\n\t\t{\n\t\t\t//in that case we will show Edit button\n\t\t\toptions.events.onRequestEditRights = this.handleRequestEditRights.bind(this);\n\t\t}\n\n\t\tthis.editorJson = options;\n\t\tthis.editor = new DocsAPI.DocEditor(this.editorNode.id, options);\n\t}\n\n\tadjustEditorHeight(options): void\n\t{\n\t\toptions.height = (document.body.clientHeight) + 'px';\n\t}\n\n\temitEventOnSaved(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onSaved', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.object,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onSaved', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.object,\n\t\t});\n\t}\n\n\temitEventOnClosed(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tlet process = 'edit';\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tprocess = sliderByWindow.getData().get('process') || 'edit';\n\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onClosed', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.object,\n\t\t\t\tprocess: process,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onClosed', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.object,\n\t\t\tprocess: process,\n\t\t});\n\t}\n\n\thandleSaveButtonClick(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: (data) => {\n\t\t\t\tif (data.hash === this.documentSession.hash)\n\t\t\t\t{\n\t\t\t\t\tthis.emitEventOnSaved();\n\n\t\t\t\t\twindow.BX.Disk.showModalWithStatusAction();\n\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\thandleClose(): void\n\t{\n\t\tthis.emitEventOnClosed();\n\n\t\tif (this.dontEndCurrentDocumentSession)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttop.BX.Disk.endEditSession({\n\t\t\tid: this.documentSession.id,\n\t\t\thash: this.documentSession.hash,\n\t\t\tdocumentWasChanged: this.documentWasChanged,\n\t\t});\n\t}\n\n\thandleDocumentStateChange(event): void\n\t{\n\t\tif (!this.caughtDocumentReady || !this.caughtInfoEvent)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() - Math.max(this.caughtDocumentReady, this.caughtInfoEvent) < 500)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.documentWasChanged = true;\n\t}\n\n\thandleInfo(): void\n\t{\n\t\tthis.caughtInfoEvent = Date.now();\n\t}\n\n\thandleDocumentReady(): void\n\t{\n\t\tthis.caughtDocumentReady = Date.now();\n\t}\n\n\thandleRequestEditRights(): void\n\t{\n\t\tthis.dontEndCurrentDocumentSession = true;\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tlet customLeftBoundary = currentSlider.getCustomLeftBoundary();\n\t\tcurrentSlider.close();\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tBX.util.add_url_param(\n\t\t\t\t'/bitrix/services/main/ajax.php',\n\t\t\t\t{\n\t\t\t\t\taction: 'disk.api.documentService.goToEdit',\n\t\t\t\t\tserviceCode: 'onlyoffice',\n\t\t\t\t\tdocumentSessionId: this.documentSession.id,\n\t\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t\t}\n\t\t), {\n\t\t\twidth: '100%',\n\t\t\tcustomLeftBoundary: customLeftBoundary,\n\t\t\tcacheable: false,\n\t\t\tallowChangeHistory: false,\n\t\t\tdata: {\n\t\t\t\tdocumentEditor: true\n\t\t\t}\n\t\t});\n\t}\n\n\tgetEditor()\n\t{\n\t\treturn this.editor;\n\t}\n\n\tgetEditorNode(): HTMLElement\n\t{\n\t\treturn this.editorNode;\n\t}\n\n\tgetEditorWrapperNode(): HTMLElement\n\t{\n\t\treturn this.editorWrapperNode;\n\t}\n\n\tgetContainer(): HTMLElement\n    {\n    \treturn this.targetNode;\n    }\n}"],"names":["OnlyOffice","editorOptions","options","Type","isPlainObject","documentSession","object","targetNode","editorNode","editorWrapperNode","initializeEditor","editorJson","currentSlider","BX","SidePanel","Instance","getSliderByWindow","window","getData","set","bindEvents","EventEmitter","subscribe","handleClose","bind","adjustEditorHeight","events","onDocumentStateChange","handleDocumentStateChange","onDocumentReady","handleDocumentReady","onInfo","handleInfo","document","permissions","edit","onRequestEditRights","handleRequestEditRights","editor","DocsAPI","DocEditor","id","height","body","clientHeight","sliderByWindow","postMessageAll","emit","process","get","PULL","moduleId","command","callback","data","hash","emitEventOnSaved","Disk","showModalWithStatusAction","close","emitEventOnClosed","dontEndCurrentDocumentSession","top","endEditSession","documentWasChanged","event","caughtDocumentReady","caughtInfoEvent","Date","now","Math","max","customLeftBoundary","getCustomLeftBoundary","open","util","add_url_param","action","serviceCode","documentSessionId","documentSessionHash","width","cacheable","allowChangeHistory","documentEditor"],"mappings":"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"}