var disk_token="";var disk_path="";var isInstalledPull=true;var urlToDiskAjax="";var alreadyDiskInstall=false;BX.ready(function(){BX.addCustomEvent(window,"onImInit",function(e){if(!window.BXFileStorage)return;ReloadWindow();updateDiskUsage();e.desktop.addCustomEvent("BXProtocolUrl",function(e,t){t=t||{};e=e.toLowerCase();var i,s,a;var n=function(e){console.debug("checkBDiskIsConnected",BXFileStorage.GetStatus().status);if(BXFileStorage.GetStatus().status==="inactive"){BitrixDisk.showSwitchOnBDisk()}if(BX.getClass("BX.PULL.isPublishingEnabled")&&BX.PULL.isPublishingEnabled()&&BX.PULL.isConnected()){BX.PULL.sendMessage([BX.message("USER_ID")],"disk","bdisk",{status:BXFileStorage.GetStatus().status,uidRequest:e})}else{BX.ajax.runAction("disk.documentService.setStatusWorkWithLocalDocument",{data:{status:BXFileStorage.GetStatus().status,uidRequest:e}})}};switch(e){case"v2openfile":n(t.uidRequest);console.debug("v2openfile",t);if(t.objectId){i=BXFileStorage.FindPathByPartOfId("|f"+decodeURIComponent(t.objectId));console.debug("Object path",i,decodeURIComponent(t.objectId))}BXFileStorage.FileExist(i,function(e){if(e&&i){BXFileStorage.ObjectOpen(i,function(){})}else if(t.url){s=decodeURIComponent(t.url);a=s=addToLinkParam(s,"editIn","l");s=addToLinkParam(s,"action","start");a=addToLinkParam(s,"action","commit");a=addToLinkParam(s,"primaryAction","commit");console.debug(t,t.name,decodeURIComponent(t.name));BitrixDisk.onStartEditingFile(decodeURIComponent(t.name),{},null,true,true);BXFileStorage.EditFile(s,a,decodeURIComponent(t.name))}});break;case"v2viewfile":n();console.debug("v2viewFile",t);if(t.objectId){i=BXFileStorage.FindPathByPartOfId("|f"+decodeURIComponent(t.objectId));console.debug("Object path",i,decodeURIComponent(t.objectId))}if(i){BXFileStorage.ObjectOpen(i,function(){})}else if(t.url){s=decodeURIComponent(t.url);console.debug(t,t.name,decodeURIComponent(t.name));BitrixDisk.onStartViewingFile(decodeURIComponent(t.name),{},null,true,true);BXFileStorage.ViewFile(s,decodeURIComponent(t.name))}break;case"opendisktab":console.debug("openDisktab Start",t);BXDesktopSystem.GetMainWindow().ExecuteCommand("show");BX.desktop.setActiveWindow(TAB_CP);BX.desktop.onCustomEvent("main","BXChangeTab",["disk"]);break;case"openfolder":console.debug("openFolder Start",t);if(t&&t.path){BXFileStorage.Refresh(function(){t.path=decodeURIComponent(t.path);BXFileStorage.FolderExist("/"+t.path,function(e){if(!e){return}BXFileStorage.ObjectOpen("/"+t.path,function(e){if(e.Error){return}})})})}break;case"openfile":console.debug("openFile Start",t);if(!t||!t.externalId){return false}if(!("GetObjectDataById"in BXFileStorage)){console.debug("Implement please GetObjectDataById!");break}var o=BXFileStorage.GetObjectDataById(decodeURIComponent(t.externalId));console.debug("Object Data",o,decodeURIComponent(t.externalId));if(o.path){BXFileStorage.FileExist(o.path,function(e){if(e){BXFileStorage.ObjectOpen(o.path,function(){})}else{console.debug("Object not exists",o)}})}break;case"createfile":console.debug("CreateFile Start",t);var s="";var a="";if(t&&t.url){s=decodeURIComponent(t.url);a=s=addToLinkParam(s,"editIn","local");s=addToLinkParam(s,"action","start");a=addToLinkParam(s,"action","commit");a=addToLinkParam(s,"primaryAction","commit")}else{console.debug("Mistake in params!")}if("EditFile"in BXFileStorage){console.debug(t,t.name,decodeURIComponent(t.name));BitrixDisk.onStartEditingFile(decodeURIComponent(t.name),{},null,true,true,true);BXFileStorage.EditFile(s,a,decodeURIComponent(t.name))}else{console.debug("Implement please EditFile!")}break;case"editfile":console.debug("EditFile Start",t);var s="";var a="";if(t&&t.url){s=decodeURIComponent(t.url);a=s=addToLinkParam(s,"editIn","local");s=addToLinkParam(s,"action","start");a=addToLinkParam(s,"action","commit");a=addToLinkParam(s,"primaryAction","commit")}else{console.debug("Mistake in params!")}if(BX.type.isString(t.externalId)&&t.externalId.length>2){if(!("GetObjectDataById"in BXFileStorage)){console.debug("Implement please GetObjectDataById!")}else{var o=BXFileStorage.GetObjectDataById(decodeURIComponent(t.externalId));console.debug("Object Data",o,decodeURIComponent(t.externalId));if(o.path){BXFileStorage.ObjectOpen(o.path,function(){});break}}}if(BX.type.isString(t.objectId)&&t.objectId!=="0"){if(!("FindPathByPartOfId"in BXFileStorage)){console.debug("Implement please FindPathByPartOfId!")}else{var i=BXFileStorage.FindPathByPartOfId("|f"+decodeURIComponent(t.objectId));console.debug("Object path",i,decodeURIComponent(t.objectId));if(!!i){BXFileStorage.ObjectOpen(i,function(){});break}}}if("EditFile"in BXFileStorage){console.debug(t,t.name,decodeURIComponent(t.name));BitrixDisk.onStartEditingFile(decodeURIComponent(t.name),{},null,true,true);BXFileStorage.EditFile(s,a,decodeURIComponent(t.name))}else{console.debug("Implement please EditFile!")}break;case"viewfile":console.debug("ShowFile Start",t);var s="";if(t&&t.url){s=decodeURIComponent(t.url)}else{console.debug("Mistake in params!")}if(BX.type.isString(t.externalId)&&t.externalId.length>2){if(!("GetObjectDataById"in BXFileStorage)){console.debug("Implement please GetObjectDataById!")}else{var o=BXFileStorage.GetObjectDataById(decodeURIComponent(t.externalId));console.debug("Object Data",o,decodeURIComponent(t.externalId));if(o.path){BXFileStorage.ObjectOpen(o.path,function(){});break}}}if(BX.type.isString(t.objectId)&&t.objectId!=="0"){if(!("FindPathByPartOfId"in BXFileStorage)){console.debug("Implement please FindPathByPartOfId!")}else{var i=BXFileStorage.FindPathByPartOfId("|f"+decodeURIComponent(t.objectId));console.debug("Object path",i,decodeURIComponent(t.objectId));if(!!i){BXFileStorage.ObjectOpen(i,function(){});break}}}if("ViewFile"in BXFileStorage){console.debug(t,t.name,decodeURIComponent(t.name));BitrixDisk.onStartViewingFile(decodeURIComponent(t.name),{},null,true,true);BXFileStorage.ViewFile(s,decodeURIComponent(t.name))}else{console.debug("Implement please ViewFile!")}break}})});BX.addCustomEvent("onImSettingsTabShow",function(e){if(e!="disk")return;if(!window.BXFileStorage)return;if(window.name!="settings")return;setTimeout(function(){BitrixDiskSettings=new BX.Disk.Desktop.Settings({bxim:BXIM,diskEnabled:typeof BXFileStorage=="undefined"?false:BXFileStorage.GetStatus().status=="online"});BitrixDiskSettings.fillFolderList();BX.desktop.resize()},120)});if(!BX.desktop.enableInVersion(42)){BX.addCustomEvent(window,"prepareSettingsView",function(){if(!window.BXFileStorage)return;if(window.name!="settings")return;BitrixDiskSettings=new BX.Disk.Desktop.Settings({bxim:BXIM,diskEnabled:typeof BXFileStorage=="undefined"?false:BXFileStorage.GetStatus().status=="online"});BitrixDiskSettings.prepareSettingsView()})}});function updateDiskUsage(){if(BXDesktopSystem&&BXDesktopSystem.GetAccountData){var e=BXDesktopSystem.GetAccountData(BXDesktopWindow.GetBDiskServer(),BXDesktopWindow.GetLogin(),"bxd_st_size");BX.ajax.post("/desktop_app/storage.php?action=updateDiskUsage",{size:e,sessid:BX.bitrix_sessid()})}}function addToLinkParam(e,t,i){if(!e.length){return"?"+t+"="+i}e=BX.util.remove_url_param(e,t);if(e.indexOf("?")!=-1){return e+"&"+t+"="+i}return e+"?"+t+"="+i}function setInstalledDisk(){if(alreadyDiskInstall||!urlToDiskAjax){return}BX.ajax.post(urlToDiskAjax,{installDisk:true,SITE_ID:BX.message("SITE_ID"),sessid:BX.bitrix_sessid()},function(e){if(e&&e.status=="success"){alreadyDiskInstall=true}})}function setUninstalledDisk(){if(!urlToDiskAjax){return}alreadyDiskInstall=false;BX.ajax.post(urlToDiskAjax,{SITE_ID:BX.message("SITE_ID"),uninstallDisk:true,sessid:BX.bitrix_sessid()},function(e){})}function ReloadWindow(){if(!isInstalledPull){NotInstalledPushAndPull();return}var e=BXFileStorage.GetStatus();logDisk(e.status);switch(e.status){case"disposed":case"disposing":case"inactive":UnshowLoading("disk_connectbutton");UnshowLoading("disk_disconnectbutton");ShowConnectCont();break;case"activating":ShowLoading("disk_connectbutton");break;case"active":UnshowLoading("disk_connectbutton");ShowAlreadyConnectCont();logDisk("another user?");break;case"deactivating":case"connecting":ShowLoading("disk_disconnectbutton");break;case"online":UnshowLoading("disk_connectbutton");UnshowLoading("disk_disconnectbutton");ShowAlreadyConnectCont();break;case"disconnecting":ShowLoading("disk_disconnectbutton");break}if(e&&e.error){ShowErrorDisk(e.error)}else{HideErrorDisk()}}function NotInstalledPushAndPull(){isInstalledPull=false;HideConnectCont();HideAlreadyConnectCont();ShowErrorDisk("not_installed_pull")}function SetDefaultTargetFolder(){BXFileStorage.SetDefaultTargetFolder(function(e){if(!e){return}if(!e.Error){disk_path=e.Path;disk_token=e.Token}else{ShowErrorDisk(e.Kind);logDisk(e.Kind);if(e.Message)logDisk(e.Message)}})}function HideAlreadyConnectCont(){SetDefaultTargetFolder()}function HideConnectCont(){}function ShowConnectCont(){SetDefaultTargetFolder();HideAlreadyConnectCont();return false}function ShowAlreadyConnectCont(){HideConnectCont();return false}function OpenFolder(){BXFileStorage.OpenFolder();return false}function SelectDisk(e){e=e||function(){};BXFileStorage.SelectTargetFolder(function(t){if(!t){return}if(!t.Error){BX("attach_disk_path").innerHTML=t.Path;disk_path=t.Path;disk_token=t.Token;e()}else{ShowErrorDisk(t.Kind);logDisk(t.Kind);if(t.Message)logDisk(t.Message)}})}function ReAttachDisk(e){BXFileStorage.Detach();setTimeout(function(){BXFileStorage.Attach(disk_token);BX.ajax.post(urlToDiskAjax,{SITE_ID:BX.message("SITE_ID"),reInstallDisk:true,sessid:BX.bitrix_sessid()},function(t){if(t&&t.status=="success"){alreadyDiskInstall=true}if(BX.type.isFunction(e)){e(t)}})},1500)}function AttachDisk(){if(disk_path){BXFileStorage.SetTargetFolder(disk_path)}BXFileStorage.Attach(disk_token);setInstalledDisk()}function DetachDisk(){BXFileStorage.Detach();setUninstalledDisk()}function HideErrorDisk(){}function ShowErrorDisk(e,t){logDisk(e);if(e=="user_cancelled"){return false}t=t||BX.message("disk_default");var i=BX("disk_error_container");var s=BX("disk_error_text");var a=BX.message("disk_"+e);if(a!=undefined){t=a}if(e=="not_empty"||e=="attach_directory_is_not_empty"){logDisk(t);t=t.replace("#PATH#",disk_path)+" "+'<a onclick="SelectDisk(function(){HideErrorDisk(); AttachDisk();}); return false;" href="">'+BX.message("disk_change_dir")+"</a>"}}function ShowLoading(e){BX.addClass(e,"wait")}function UnshowLoading(e){BX.removeClass(e,"wait")}function logDisk(e){console.log("BXDISK: "+e)}function DiskFormatDate(e){if(!BX.isAmPmMode())var t=[["tommorow","tommorow, H:i"],["today","today, H:i"],["yesterday","yesterday, H:i"],["",BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"))]];else var t=[["tommorow","tommorow, g:i a"],["today","today, g:i a"],["yesterday","yesterday, g:i a"],["",BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"))]];return BX.date.format(t,parseInt(e))}function formatNotifyString(e,t,i){switch(e){case"add":case"update":case"delete":break;default:return""}var s="";if(t&&i){s=BX.message("disk_notify_action_"+e+"_f_d")}else if(t){s=BX.message("disk_notify_action_"+e+"_f")}else if(i){s=BX.message("disk_notify_action_"+e+"_d")}if(t){s=s.replace("#FILE#",GetNumericCase(t,BX.message("disk_notify_file_numeral_1"),BX.message("disk_notify_file_numeral_21"),BX.message("disk_notify_file_numeral_2_4"),BX.message("disk_notify_file_numeral_5_20"))).replace("#COUNT#",t)}if(i){s=s.replace("#DIR#",GetNumericCase(i,BX.message("disk_notify_dir_numeral_1"),BX.message("disk_notify_dir_numeral_21"),BX.message("disk_notify_dir_numeral_2_4"),BX.message("disk_notify_dir_numeral_5_20"))).replace("#COUNT#",i)}return s}function GetNumericCase(e,t,i,s,a){if(e==1){return t}if(e<0){e=-e}e%=100;if(e>=5&&e<=20){return a}e%=10;if(e==1){return i}if(e>=2&&e<=4){return s}return a}var BitrixDisk={revision:-1,needToReAttach:false,enabled:false,chart:null,pathToImages:"",mySpace:0,diskSpace:0,freeSpace:0,storageCmdPath:"",pathTemplateToRestoreObject:"",bxim:null,mySlice:null,companySlice:null,freeSlice:null,layout:{status:null,history:null,chart:null,freeSpace:null,companySpace:null,mySpace:null,usedSpace:null,fullSpace:null,spaceStatus:null,diskStatus:null,connectButton:null,lastSync:null,lastSyncDate:null,lastSyncComment:null,diskLoading:null,historyContainer:null,historyHelp:null,historyEmpty:null,changeTargetDir:null},chartData:null,chartLoaded:false,lastSyncTimestamp:null,historyItems:[],progressCheckPointByFile:{},notifyData:{badgeCount:0,firstInitializeSnapshot:false,numberOfFilesLastPackage:null,singleFileData:null},currentUserId:null,localEditFiles:{},init:function(e){this.revision=parseInt(e.revision,10);this.needToReAttach=!!parseInt(e.needToReAttach,10);this.layout.wrap=BX("disk-wrap");if(typeof BX.desktop=="undefined"||!BX.desktop.ready())return false;this.layout.status=BX("disk-status");this.layout.history=BX("disk-history");this.layout.chart=BX("disk-chart");this.layout.chartDefault=BX("disk-chart-default");this.layout.diskWorkarea=BX("disk-workarea");this.layout.freeSpace=BX("disk-free-space");this.layout.companySpace=BX("disk-company-space");this.layout.mySpace=BX("disk-my-space");this.layout.usedSpace=BX("disk-used-space");this.layout.fullSpace=BX("disk-full-space");this.layout.spaceStatus=BX("disk-space-status");this.layout.diskStatus=BX("disk-status");this.layout.connectButton=BX("disk-connect-button");this.layout.lastSync=BX("disk-last-sync");this.layout.lastSyncDate=BX("disk-last-sync-date");this.layout.lastSyncComment=BX("disk-last-sync-comment");this.layout.diskLoading=BX("disk-loading");this.layout.historyContainer=BX("disk-history-container");this.layout.historyHelp=BX("disk-history-help");this.layout.historyEmpty=BX("disk-history-empty");this.layout.syncFilesText=BX("disk-number-of-files-text");this.layout.syncContainerFilesText=BX("disk-current-file-nums-container");this.layout.syncProgress=BX("disk-progress-bar");this.layout.syncCurrentFile=BX("disk-current-file-num");this.layout.syncNumberOfFiles=BX("disk-number-of-files");this.layout.syncSpeed=BX("disk-progress-speed");this.layout.syncEstimatedTime=BX("disk-progress-estimated-time");this.layout.syncStopButton=BX("disk-btn-sync-stop");this.layout.syncContainerButton=BX("disk-btn-sync-container");this.layout.syncStartButton=BX("disk-btn-sync-start");this.layout.changeTargetDir=BX("disk-change-target-folder");this.pathToImages=e.pathToImages;this.pathTemplateToRestoreObject=e.pathTemplateToRestoreObject;this.storageCmdPath=e.storageCmdPath||"";this.bxim=e.bxim;this.bxim.desktopDisk=this;this.enableShowingNotify=e.enableShowingNotify;this.currentUserId=e.currentUserId;if(BX.type.isArray(e.historyItems)){this.historyItems=e.historyItems;for(var t=0,i=this.historyItems.length;t<i;t++){this.addHistoryItem(this.historyItems[t])}}this.setLastSync(e.lastSyncTimestamp,true);this.mySpace=e.mySpace&&e.mySpace>0?e.mySpace:0;this.diskSpace=e.diskSpace&&e.diskSpace>0?e.diskSpace:0;this.freeSpace=e.freeSpace&&e.freeSpace>0?e.freeSpace:0;if(this.diskSpace>0){this.showChart(true)}else{this.updateChart();this.hideChart()}this.enabled=BX.type.isBoolean(e.enabled)?e.enabled:this.enabled;if(this.enabled){this.switchOn()}else{this.switchOff()}BX.desktop.addTab({id:"disk",title:BX.message("disk_name"),order:130,events:{open:BX.proxy(function(){if(!this.chartLoaded&&this.diskSpace>0){this.showChart()}},this),init:BX.proxy(function(){BX.desktop.setTabContent("disk",this.layout.wrap)},this),close:function(){}}});this.setEvents();if(!BX.desktop.enableInVersion(42)){this.bxim.settingsView.disk={title:BX.message("disk_settings_title"),settings:[{title:BX.message("disk_settings_label_enable"),type:"checkbox",name:"diskEnabled",checked:this.enabled,callback:function(){}},{title:BX.message("disk_settings_label_file_click_action"),type:"select",value:this.getFileClickActionName(),name:"fileClickAction",items:[{title:BX.message("disk_settings_label_file_click_action_open_folder"),value:"openFolder"},{title:BX.message("disk_settings_label_file_click_action_open_file"),value:"openFile"}],callback:function(){}}]}}if(this.needToReAttach){this.reAttach()}BXFileStorage.StartSync()},isEmptyObject:function(e){if(e==null)return true;if(e.length&&e.length>0)return false;if(e.length===0)return true;for(var t in e){if(hasOwnProperty.call(e,t))return false}return true},reAttach:function(){ReAttachDisk(BX.delegate(function(){BX.desktop.windowReload()},this))},checkRevision:function(e){e=parseInt(e);if(typeof e=="number"&&this.revision<e){console.debug("NOTICE: Window reload, because REVISION UP ("+this.revision+" -> "+e+")");switch(e){case 2:this.revision=e;BX.desktop.windowReload();break;default:this.revision=e;BX.desktop.windowReload();break}return false}return true},setEvents:function(){window.addEventListener("BXFileStorageStatusChanged",function(){var e=BXFileStorage.GetStatus();switch(e.status){case"disposed":case"disposing":case"inactive":BitrixDisk.switchOff();break;case"activating":case"active":case"deactivating":case"connecting":break;case"online":BitrixDisk.switchOn();break;case"disconnecting":break}});BX.bind(BX(this.layout.syncStopButton),"click",BX.delegate(this.onSyncManipulateButtonClick,this));BX.bind(BX(this.layout.syncStartButton),"click",BX.delegate(this.onSyncManipulateButtonClick,this));BX.addCustomEvent(window,"onDesktopSyncPause",BX.proxy(this.onSyncPauseEventFromDesktop,this));BX.bindDelegate(this.layout.historyContainer,"dblclick",{className:"history_error_container"},BX.delegate(this.onClickErrorEntry,this));this.bxim.desktop.addCustomEvent("BXFileStorageStatusSync",BX.proxy(this.onChangeStatusSync,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusStartPackage",BX.proxy(this.onStartPackage,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusStartFile",BX.proxy(this.onStartFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusProgressFile",BX.proxy(this.onProgressFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusFinalFile",BX.proxy(this.onFinalFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusFinalPackage",BX.proxy(this.onFinalPackage,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusErrorFile",BX.proxy(this.onErrorFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusConflict",BX.proxy(this.onConflictFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusDeleteFile",BX.proxy(this.onDeleteFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusRenameFile",BX.proxy(this.onRenameFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusStartPackage",BX.proxy(this.onStartPackageNotify,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusFinalFile",BX.proxy(this.onFinalFileNotify,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusFinalPackage",BX.proxy(this.onFinalPackageNotify,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusDeleteFile",BX.proxy(this.onDeleteFileNotify,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusStartFile",BX.proxy(this.onStartEditingFile,this));this.bxim.desktop.addCustomEvent("BXFileStorageSyncStatusFinalFile",BX.proxy(this.onFinalEditingFile,this));this.bxim.desktop.addCustomEvent("BXFileStoragePublicLinkStart",BX.proxy(this.onStartExternalLink,this));this.bxim.desktop.addCustomEvent("BXFileStoragePublicLinkFinal",BX.proxy(this.onFinalExternalLink,this));this.bxim.desktop.addCustomEvent("BXFileStorageLaunchApp",BX.proxy(this.onLaunchApp,this));this.bxim.desktop.addCustomEvent("bxSaveSettings",BX.proxy(this.onSaveSettings,this));BX.addCustomEvent("onPullEvent-disk",BX.delegate(function(e,t){t=t||{};if(e!=="bdisk"){return}console.debug(this.getSyncTime(),"onPullEvent:  ","command: ",e+"  ","params: ",t);switch(t.action){case"repair":case"check":break}},this))},onClickErrorEntry:function(e){var t=e.srcElement;if(!t||t.tagName.toUpperCase()!=="SPAN"){return}if(!e.ctrlKey){return}var i=t.getAttribute("bx-disk-error-data");if(i){var s=new BX.PopupWindow("bx-disk-error-data",t,{content:i,closeByEsc:true,closeIcon:false,autoHide:true,events:{onPopupClose:function(){this.destroy()}}});s.show()}},onSyncPauseEventFromDesktop:function(e){var t;if(!e){t=BX("disk-btn-sync-stop");this.layout.lastSyncComment.innerHTML=BX.message("disk_last_sync_paused_comment");this.showContainerWithSyncButtons();this.setPauseTabIcon()}else{t=BX("disk-btn-sync-start");this.layout.lastSyncComment.innerHTML="";this.resetTabIcon()}if(t.id==="disk-btn-sync-stop"){BX("disk-btn-sync-start").style.display="inline-block"}else if(t.id==="disk-btn-sync-start"){BX("disk-btn-sync-stop").style.display="inline-block"}BX.hide(t);console.debug(this.getSyncTime(),"onSyncPauseEventFromDesktop:  ",e)},onSyncManipulateButtonClick:function(e){var t=e.currentTarget;if(!t){return}BX.hide(t);if(t.id==="disk-btn-sync-stop"){BX.desktop.syncPause(true,true)}else if(t.id==="disk-btn-sync-start"){BX.desktop.syncPause(false,true)}},onStartPackage:function(e,t,i){if(e<=0){return}i=i||{};this.bxim.setLocalConfig("currentSyncFile",0);this.bxim.setLocalConfig("numberOfSyncFiles",e);this.bxim.setLocalConfig("syncPackageSize",t);this.bxim.setLocalConfig("syncPackageSizeDynamic",0);this.bxim.setLocalConfig("startPackageTime",(new Date).getTime());this.setProgress(0,e,null,null);this.setWorkingTabIcon(i.upload);console.debug(this.getSyncTime(),"StartPackage:  ","numberOfFiles: ",e+"  ","detailedData: ",i,"packageSize: ",BitrixDisk.formatSize(t)+" ("+t+")")},onStartFile:function(e,t,i,s){if(this.isEmptyObject(t)){return}var a=this.bxim.getLocalConfig("currentSyncFile",0);a=a+1;this.bxim.setLocalConfig("currentSyncFile",a);this.bxim.setLocalConfig("currentSyncSize",0);var n=this.bxim.getLocalConfig("numberOfSyncFiles",null);var o=this.bxim.getLocalConfig("syncPackageSize",null);this.setProgress(a,n,this.getProgressPercent(a,n,0,o),null);this.addHistoryItem(this.prepareDataToHistoryItem({path:e,snapshot:t,fileSize:i,isDownloaded:s,withProgressBar:true}));this.storeProgressCheckPointByFile(e,{size:i});console.debug(this.getSyncTime(),"StartFile:  ",e+"  ",t,BitrixDisk.formatSize(i)+" ("+i+")"+"  ","isDownloaded: "+s)},onProgressFile:function(e,t,i,s){BX.desktop.onCustomEvent("sub-BXFileStorageSyncStatusProgressFile",[e,t,i,s]);if(this.localEditFiles.hasOwnProperty(e)){return}var a=this.bxim.getLocalConfig("currentSyncFile",null);var n=this.bxim.getLocalConfig("numberOfSyncFiles",null);var o=this.bxim.getLocalConfig("syncPackageSize",null);this.setProgress(a,n,this.getProgressPercent(a,n,t,o),i);var r=t-this.bxim.getLocalConfig("currentSyncSize",0);this.bxim.setLocalConfig("currentSyncSize",t);var d=this.bxim.getLocalConfig("syncPackageSizeDynamic")+r;this.bxim.setLocalConfig("syncPackageSizeDynamic",d);var l=this.setHistoryItemProgress(e,this.getHistoryFileProgressBarIdFromPath(e),this.getProgressPercent(a,1,t,this.getProgressCheckPointByFile(e).size),i);this.setEstimatedTime(Math.floor(d/this.bxim.getLocalConfig("syncPackageSize",0)*100),l);console.debug(this.getSyncTime(),"ProgressFile:  ",e+"  ",BitrixDisk.formatSize(t)+" ("+t+")  ",BitrixDisk.formatSize(i)+"/"+BX.message("disk_speed_seconds")+" ("+i+")")},onFinalFile:function(e,t){if(this.isEmptyObject(t)){return}var i=this.getHistoryFileProgressBarIdFromPath(e);this.setHistoryItemProgress(e,i,100);this.deleteProgressCheckPointByFile(e);setTimeout(function(e){return function(){var t=BX(e);if(t){BX.hide(t)}}}(i),200);var s=t.size-this.bxim.getLocalConfig("currentSyncSize",0);var a=this.bxim.getLocalConfig("syncPackageSizeDynamic")+s;this.bxim.setLocalConfig("syncPackageSizeDynamic",a);this.setEstimatedTime(Math.floor(a/this.bxim.getLocalConfig("syncPackageSize",0)*100));var n=BX(i);if(t.version&&n){var o=BX.findChild(n.parentNode,{className:"history-file-date"},4);if(o){o.innerHTML=DiskFormatDate((t.originalTimestamp||t.version)/1e3)}}if(t.id&&n){var r=BX(n.parentNode);r.id=this.getFileId(t.id)}if(t.modifiedBy==this.currentUserId&&this.notifyData.badgeCount>0){this.notifyData.badgeCount--;if(this.notifyData.badgeCount>=0){BX.desktop.setTabBadge("disk",this.notifyData.badgeCount)}}console.debug(this.getSyncTime(),"FinalFile:  ",t)},onFinalPackage:function(){if(BX.desktop.getSyncStatus())this.resetTabIcon();this.setLastSync((new Date).getTime()/1e3);this.updateSpaces();console.debug(this.getSyncTime(),"FinalPackage")},onErrorFile:function(e,t){console.debug(BX.date.format("H:i:s")+"   ","ErrorFile:  ",arguments);this.setHistoryItemError(e,t);this.logError(t,null,e)},onConflictFile:function(e,t,i){console.debug(BX.date.format("H:i:s")+"   ","Conflict:  ",arguments);try{i=JSON.parse(i);if(!i||typeof i!=="object"){return}}catch(e){return}this.showConflictBetweenFiles({forkedFileData:t,originFileData:i})},onDeleteFile:function(e,t,i){console.debug("DeleteFile:",e,t,i);t.isDeleted=true;t.version=(new Date).getTime();if(i){t.deletedBy=t.deletedBy=="0"?this.currentUserId:t.deletedBy;t.modifiedBy=t.deletedBy}this.addHistoryItem(t);this.setLastSync((new Date).getTime()/1e3)},onRenameFile:function(e,t,i,s){console.debug("RenameFile:",e,i,s);if(i.old_name!=i.name){i.isRenamed=true}else{i.isMoved=true}this.addHistoryItem(i);this.setLastSync((new Date).getTime()/1e3)},onChangeStatusSync:function(e,t){console.debug("onChangeStatusSync",e,t);console.debug("firstInitializeSnapshot",this.notifyData.firstInitializeSnapshot);if(this.notifyData.firstInitializeSnapshot){this.notifyData.firstInitializeSnapshot=false;this.showNotifyChangedObjects({add:e.add,update:e.update,delete:e.delete},{add:t.add,update:t.update,delete:t.delete});return}if(!this.canShowNotify()){return}if(e.hasOwnProperty("nonSelfAdd")){if(!e.nonSelfAdd&&!e.nonSelfUpdate&&!e.nonSelfDelete){return}if(e.nonSelfAdd==1||e.nonSelfUpdate==1){return}this.showNotifyChangedObjects({add:e.nonSelfAdd,update:e.nonSelfUpdate,delete:e.nonSelfDelete},{add:t.nonSelfAdd,update:t.nonSelfUpdate,delete:t.nonSelfDelete});return}this.showNotifyChangedObjects(e,t)},onStartPackageNotify:function(e,t){this.notifyData.numberOfFilesLastPackage=e;console.debug("onStartPackageNotify")},onFinalFileNotify:function(e,t){if(this.isEmptyObject(t)){return}if(this.notifyData.numberOfFilesLastPackage==1){this.notifyData.singleFileData=t}console.debug("onFinalFileNotify ")},onFinalPackageNotify:function(){if(this.notifyData.numberOfFilesLastPackage==1&&this.notifyData.singleFileData){if(!this.canShowNotify()){return}this.showNotifySingleFile(this.notifyData.singleFileData)}this.notifyData.numberOfFilesLastPackage=null;this.notifyData.singleFileData=null;console.debug("FinalPackageNotify")},onDeleteFileNotify:function(){console.debug("onDeleteFileNotify")},onSaveSettings:function(e){e=e||{};if(e.diskEnabled){if(!this.enabled){this.switchOn(true)}}else{this.switchOff(true)}BitrixDiskSettings=new BX.Disk.Desktop.Settings({bxim:BXIM,diskEnabled:typeof BXFileStorage=="undefined"?false:BXFileStorage.GetStatus().status=="online"});BitrixDiskSettings.saveSettings(e)},createChart:function(){if(this.chart){return}this.chart=new AmCharts.AmPieChart;this.chart.radius=100;this.chart.valueField="value";this.chart.titleField="title";this.chart.pulledField="pulled";this.chart.patternField="pattern";this.chart.labelsEnabled=false;this.chart.startDuration=.3;this.chart.startEffect="easeOutSine";this.chart.balloonText="";this.chart.depth3D=5;this.chart.outlineColor="#000000";this.chart.outlineThickness=1;this.chart.outlineAlpha=.2;this.chart.colors=["#4a9be8","#98ca00","#FFFFFF"];this.mySlice={value:this.mySpace,pattern:{url:this.pathToImages+"/texture-blue.png",width:250,height:250}};var e=this.diskSpace-this.freeSpace-this.mySpace;e=e<0?0:e;this.companySlice={value:e,pattern:{url:this.pathToImages+"/texture-green.png",width:250,height:250}};this.freeSlice={value:this.freeSpace,pattern:{url:this.pathToImages+"/texture.png",width:250,height:250}};this.chartData=[this.mySlice,this.companySlice,this.freeSlice];this.chart.dataProvider=this.chartData},showChart:function(e){BX.removeClass(this.layout.diskWorkarea,"unlimited");if(!this.chart){this.createChart();this.updateChart()}if(this.chartLoaded===false&&this.chart&&e!==true){this.chart.write(this.layout.chart);this.chartLoaded=true}},hideChart:function(){BX.addClass(this.layout.diskWorkarea,"unlimited")},updateChart:function(){BXFileStorage.GetStorageSize(BX.proxy(function(e){if(e.Error){return}this.mySpace=e.size;this.layout.mySpace.innerHTML=BitrixDisk.formatSize(this.mySpace);if(this.chart){var t=this.diskSpace-this.freeSpace-this.mySpace;t=t<0?0:t;var i=this.diskSpace-this.freeSpace;i=i<0?0:i;this.companySlice.value=t;this.mySlice.value=this.mySpace;this.freeSlice.value=this.freeSpace;this.layout.freeSpace.innerHTML=BitrixDisk.formatSize(this.freeSpace);this.layout.companySpace.innerHTML=BitrixDisk.formatSize(t);this.layout.usedSpace.innerHTML=BitrixDisk.formatSize(i);this.layout.fullSpace.innerHTML=BitrixDisk.formatSize(this.diskSpace);this.chart.validateData()}},this))},updateSpaces:function(){},getTargetFolder:function(){var e=BXFileStorage.GetTargetFolder();e=e||{};return e.Path},changeTargetFolder:function(){SelectDisk()},switchOn:function(e){this.layout.connectButton.style.display="none";this.layout.historyHelp.style.display="none";if(this.historyItems.length>0){this.layout.historyContainer.style.display="block";this.layout.historyEmpty.style.display="none"}else{this.layout.historyContainer.style.display="none";this.layout.historyEmpty.style.display="block"}this.layout.lastSync.style.display="block";this.layout.spaceStatus.style.display="block";this.layout.changeTargetDir.style.display="none";this.layout.diskStatus.innerHTML=BX.message("disk_status_enabled");BX.addClass(this.layout.diskStatus.parentNode,"good");this.enabled=true;if(e===true){this.notifyData.firstInitializeSnapshot=true;AttachDisk()}},switchOff:function(e){this.hideContainerWithSyncButtons();this.layout.connectButton.style.display="block";this.layout.historyHelp.style.display="block";this.layout.historyContainer.style.display="none";this.layout.historyEmpty.style.display="none";this.layout.lastSync.style.display="none";this.layout.spaceStatus.style.display="none";this.layout.diskLoading.style.display="none";this.layout.changeTargetDir.style.display="block";this.layout.diskStatus.innerHTML=BX.message("disk_status_disabled");BX.removeClass(this.layout.diskStatus.parentNode,"good");this.enabled=false;BX("attach_disk_path").innerHTML=this.getTargetFolder();if(e===true){DetachDisk()}},logError:function(e,t,i){return;t=t||"";i=i||"";if(e==="Operation was aborted by an application callback")return;BX.ajax({method:"POST",dataType:"json",url:"https://www.bitrix24.ru/bx24_disk_logging",data:BX.ajax.prepareData({c:t,h:document.location.host,u:this.currentUserId,v:navigator.userAgent,vv:BXDesktopSystem.GetProperty("version"),p:i,e:e}),onsuccess:function(e){}})},setProgress:function(e,t,i,s){if(!this.enabled){return}if(e==0){this.showContainerWithSyncButtons()}if(BX.type.isNumber(e)){this.layout.syncCurrentFile.innerHTML=e}if(BX.type.isNumber(t)){if(t==1){this.layout.syncContainerFilesText.style.display="none"}else{this.layout.syncContainerFilesText.style.display="inline"}this.layout.syncFilesText.innerHTML=GetNumericCase(t,BX.message("disk_notify_file_numeral_1"),BX.message("disk_notify_file_numeral_21"),BX.message("disk_notify_file_numeral_2_4"),BX.message("disk_notify_file_numeral_5_20")).replace("#COUNT#",t);this.layout.syncNumberOfFiles.innerHTML=t}if(BX.type.isNumber(i)){this.layout.syncProgress.style.width=i+"%"}if(s){this.layout.syncSpeed.innerHTML=" "+BitrixDisk.formatSize(s)+"/"+BX.message("disk_speed_seconds")}this.layout.lastSync.style.display="none";this.layout.diskLoading.style.display="block"},setHistoryItemError:function(e,t){var i=BX(this.getHistoryFileProgressBarIdFromPath(e));if(!i){return}if(!BX.desktop.getSyncStatus()||typeof t==="string"&&t==="Operation was aborted by an application callback"){var s=BX.findParent(i,{tagName:"li"},4);if(s){new BX.easing({duration:400,start:{opacity:0,height:0},finish:{opacity:100,height:s.offsetHeight},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(e){s.style.height=e.height+"px"},this),complete:BX.delegate(function(){BX.cleanNode(s,true)},this)}).animate();return}}BX.cleanNode(i);if(BX.desktop.getSyncStatus()){i.appendChild(BX.create("span",{text:this.getErrorTextByErrorData(t),attrs:{"bx-disk-error-data":t}}));var a=this.getLocalAccessDeniedData(t);if(a&&a.application){this.showLockedByProgram({fileData:{name:this.baseName(e),path:e},program:a.application})}}BX.addClass(i,"history_error_container");BX.removeClass(i,"history_progress_bar_container")},baseName:function(e){var t=new String(e).substring(e.lastIndexOf("/")+1);if(t.lastIndexOf(".")!=-1){t=t.substring(0,t.lastIndexOf("."))}return t},getLocalAccessDeniedData:function(e){try{var t=JSON.parse(e);if(t&&typeof t==="object"&&t.status==="local_access_denied"){if(t.application){return{application:t.application}}return{}}}catch(e){}return null},getErrorTextByErrorData:function(e){var t=BX.message("disk_history_error_base");try{var i=JSON.parse(e);if(i&&typeof i==="object"){if(i.status==="denied"&&i.message&&i.message.indexOf("name should not have")>-1){t=BX.message("disk_history_error_bad_name")}else if(i.status==="access_denied"){t=BX.message("disk_history_error_access_denied")}else if(i.status==="not_found"){t=BX.message("disk_history_error_not_found")}else if(i.status==="local_access_denied"){t=BX.message("disk_history_error_blocked_by_unknown");if(i.application){t=BX.message("disk_history_error_blocked_by_program").replace("#PROGRAM#",i.application)}}else if(i.errors||i.detail){var s=i.errors||i.detail;for(var a in s){if(!s.hasOwnProperty(a)){continue}var n=s[a];if(n.code==="SC_FF_22001"){this.showWarningLockedDocument({link:n.message});t=BX.message("disk_bdisk_storage_controller_document_was_locked")}else if(n.code==="DISK_FILE_22006"){t=BX.message("disk_bdisk_file_error_size_restriction")}}}}}catch(e){}return t},setEstimatedTime:function(e,t){t=t||0;var i=(new Date).getTime()/1e3;var s=this.bxim.getLocalConfig("startPackageTime",null);if(s&&e>0){var a=(i-s/1e3)/e*(100-e);var n=this.getTextForEstimatedTime(Math.max(a,t));if(n){BX.adjust(this.layout.syncEstimatedTime,{text:n});BX("bx-desktop-tab-disk").title=BX.message("disk_name")+"\n"+n}}},setHistoryItemProgress:function(e,t,i,s){if(!this.enabled){return}if(!BX.type.isNumber(i)){return}var a=BX(t);if(!a){return}var n=BX.findChild(a,{className:"progress_bar_p"},true);if(!n){return}n.style.width=i+"%";if(s&&i>0){var o=BX.findChild(a,{className:"progress_text"},true);if(!o){return}var r=(new Date).getTime()/1e3;var d=this.getProgressCheckPointByFile(e);var l=(r-d.startTime)/i*(100-i);BX.adjust(o,{text:this.getTextForEstimatedTime(l)});return l}},getTextForEstimatedTime:function(e){var t="";var i="";if(e<60){t=BX.message("disk_estimate_time_second");i=Math.max(Math.floor(e),1)}else if(e<3600){t=BX.message("disk_estimate_time_minute");i=Math.max(Math.floor(e/60),1)}else{t=BX.message("disk_estimate_time_hour");i=Math.max(Math.floor(e/3600),1)}if(isNaN(i)){return""}return BX.message("disk_estimate_time_per_file").replace("#TIME#",t.replace("#DATA#",i))},getRandomNumber:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},getProgressPercent:function(e,t,i,s){var a=0;if(t==1){a=Math.floor(i/s*100)}else{a=Math.floor(e/t*100)}return Math.min(Math.max(a,0),94)},setLastSync:function(e,t){t=t||false;if(BX.type.isNumber(e)){this.lastSyncTimestamp=e;this.layout.lastSyncDate.innerHTML=DiskFormatDate(this.lastSyncTimestamp)}else{this.layout.lastSyncDate.innerHTML=BX.message("disk_sync_no_date")}if(!BX.desktop.getSyncStatus()){this.layout.lastSyncComment.innerHTML=BX.message("disk_last_sync_paused_comment")}else if(!t){this.hideContainerWithSyncButtons()}this.layout.lastSync.style.display="block";this.layout.diskLoading.style.display="none";this.bxim.setLocalConfig("lastSyncTimestamp",(new Date).getTime()/1e3)},showContainerWithSyncButtons:function(){BX.show(this.layout.syncContainerButton,"block");new BX.easing({duration:600,start:{top:105},finish:{top:155},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(e){if(this.layout.historyContainer.style.top==="155px"){return}this.layout.historyContainer.style.top=parseInt(e.top,10)+"px"},this),complete:BX.delegate(function(){},this)}).animate()},hideContainerWithSyncButtons:function(){BX.cleanNode(this.layout.lastSyncComment);new BX.easing({duration:600,start:{top:155},finish:{top:105},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(e){if(this.layout.historyContainer.style.top==="105px"){return}this.layout.historyContainer.style.top=parseInt(e.top,10)+"px"},this),complete:BX.delegate(function(){BX.hide(this.layout.syncContainerButton)},this)}).animate()},resetTabIcon:function(){var e=BX.findChild(BX("bx-desktop-tab-disk"),{className:"bx-desktop-tab-icon"},true);if(e){e.style.cssText="";this.notifyData.badgeCount=0;BX.desktop.setTabBadge("disk",0);BX("bx-desktop-tab-disk").title=BX.message("disk_name")}},setWorkingTabIcon:function(e){var t=BX.findChild(BX("bx-desktop-tab-disk"),{className:"bx-desktop-tab-icon"},true);if(t){t.style.background='url("/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/icon-working.gif") no-repeat';t.style.width="19px";t.style.marginTop="8px";if(e&&e>0){this.notifyData.badgeCount=parseInt(e,10);BX.desktop.setTabBadge("disk",e)}}},setPauseTabIcon:function(e){var t=BX.findChild(BX("bx-desktop-tab-disk"),{className:"bx-desktop-tab-icon"},true);if(t){t.style.background='url("/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/icon-pause.png") no-repeat';t.style.width="19px";t.style.marginTop="8px"}},getFileId:function(e){return e.replace(/\|/g,"_")},getHistoryFileProgressBarIdFromPath:function(e){return"id-"+e.replace(/\\/g,"_")},storeProgressCheckPointByFile:function(e,t){t=t||{};this.progressCheckPointByFile[this.getHistoryFileProgressBarIdFromPath(e)]={startTime:(new Date).getTime()/1e3,size:t.size||0}},deleteProgressCheckPointByFile:function(e){delete this.progressCheckPointByFile[this.getHistoryFileProgressBarIdFromPath(e)]},getProgressCheckPointByFile:function(e){return this.progressCheckPointByFile[this.getHistoryFileProgressBarIdFromPath(e)]||{startTime:0,size:0}},prepareDataToHistoryItem:function(e){var t=Object.create(null);t.path=e.path;t.size=e.fileSize;if(e.snapshot.name){t.name=e.snapshot.name}else{t.name=t.path.split("/").pop()}if(e.snapshot.id){t.id=e.snapshot.id}if(e.snapshot.version){t.version=e.snapshot.version}if(e.snapshot.originalTimestamp){t.originalTimestamp=e.snapshot.originalTimestamp}if(!t.id){t.id="b"+(new Date).getTime()/100}t.isDeleted=false;if(!e.snapshot.id){t.isNew=true}else if(e.snapshot.id){t.isNew=e.snapshot.isNew}if(e.snapshot.modifiedBy){t.modifiedBy=e.snapshot.modifiedBy}else{t.modifiedBy=this.currentUserId}t.progressBarId=this.getHistoryFileProgressBarIdFromPath(t.path);t.withProgressBar=!!e.withProgressBar;return t},addHistoryItem:function(e,t){if(!e||!e.name||!e.path){return}var i=e.withProgressBar||false;var s=e.name.split(".").pop().replace(/[^a-z0-9]/gi,"");s=s.length>0&&s.length<5?" history-file-icon-"+s:"";var a=this.getFileId(e.id);var n=this.bxim.messenger.users[e.modifiedBy];var o=null;if(n&&BX.type.isNotEmptyString(n.avatar)&&n.avatar.indexOf("blank.gif")==-1){o=BX.create("span",{props:{className:"history-author-avatar"},style:{backgroundImage:"url('"+n.avatar+"')"}})}var r="";var d="";if(e.isDeleted){r=BX.message("disk_file_deleted");d="status-deleted"}else if(e.isNew){r=BX.message("disk_file_created");d="status-created"}else if(e.isRenamed){r=BX.message("disk_file_renamed");d="status-renamed"}else if(e.isMoved){r=BX.message("disk_file_moved");d="status-moved"}else{r=BX.message("disk_file_updated");d="status-updated"}var l=null;if(n&&BX.type.isNotEmptyString(n.name)){l=BX.create("span",{props:{className:"history-author-name"},html:n.name})}var c=(new Date).getTime()/1e3;if(e.originalTimestamp){c=e.originalTimestamp/1e3}else if(e.version){c=e.version/1e3}if(BX(a,false)){BX.remove(BX(a,false))}var u=e.id.split(/f([0-9]+)/)[1];var m=BX.create("li",{props:{id:a},children:[BX.create("div",{props:{className:"history-file"+" "+d},children:[BX.create("div",{props:{className:"history-file-icon"+s,id:a+"_icon"}}),BX.create("div",{props:{className:"history-file-name"},children:[e.isDeleted?BX.create("span",{props:{className:"history-file-title"},html:e.name}):BX.create("a",{props:{className:"history-file-title",href:e.path,title:e.path},html:e.name,events:{click:BX.delegate(function(t){var i=this.getFileClickAction();var s=BXFileStorage.GetObjectDataById(e.id);if(!s||!s.path){s={path:e.path}}i(s);return BX.PreventDefault(t)},this)}}),BX.create("span",{props:{className:"history-file-status"},html:"("+r+")"}),e.isDeleted&&e.modifiedBy==this.currentUserId&&u?BX.create("a",{text:BX.message("disk_restore_deleted_object"),props:{className:"history-link-to-restore",href:this.pathTemplateToRestoreObject.replace("placeForObjectId",u),target:"_blank"}}):null]})]}),BX.create("div",{props:{className:"history-info"},children:[o,l,BX.create("span",{props:{className:"history-file-size"},html:BitrixDisk.formatSize(e.size)}),BX.create("span",{props:{className:"history-file-date"},html:DiskFormatDate(c)})]}),e.isDeleted||!i?null:BX.create("div",{props:{id:e.progressBarId,className:"history_progress_bar_container"},children:[BX.create("div",{props:{className:"progress_bar_container history_progress_bar"},children:[BX.create("div",{props:{className:"progress_bar_p"}})]}),BX.create("span",{props:{className:"progress_text"}})]})]});this.layout.historyContainer.style.display="block";this.layout.historyEmpty.style.display="none";if(this.layout.history.firstChild){this.layout.history.insertBefore(m,this.layout.history.firstChild)}else{this.layout.history.appendChild(m)}},formatSize:function(e){var t=["b","Kb","Mb","Gb","Tb"];var i=0;e=parseInt(e,10);while(e>=1e3&&i<4){e/=1024;i++}return(i==0?e:e.toFixed(1))+" "+BX.message("FILE_SIZE_"+t[i])},getSyncTime:function(){var e=(new Date).getTime();var t=this.bxim.getLocalConfig("startPackageTime",null);if(t){return BX.date.format("H:i:s",e/1e3)+" ("+BX.date.format("i:s",(e-t)/1e3)+")"+"   "}else{return BX.date.format("H:i:s",e/1e3)+"   "}},getFileClickAction:function(){var e=this.getFileClickActionName();switch(e){case"openFolder":return function(e){BXFileStorage.FileExist(e.path,function(t){if(t){BXFileStorage.OpenFileFolder(e.path,function(){})}})};case"openFile":return function(e){BXFileStorage.FileExist(e.path,function(t){if(t){BXFileStorage.FileOpen(e.path,function(){})}})}}return function(){}},getFileClickActionStringJs:function(e){var t=this.getFileClickActionName();switch(t){case"openFolder":return'BXFileStorage.FileExist("'+e.path+'", function(exist){'+"if(exist)"+'BXFileStorage.OpenFileFolder("'+e.path+'", function(){});'+"})";case"openFile":return'BXFileStorage.FileExist("'+e.path+'", function(exist){'+"if(exist)"+'BXFileStorage.FileOpen("'+e.path+'", function(){});'+"})"}return""},getFileClickActionName:function(){var e=this.bxim.getLocalConfig("fileClickAction",{name:"openFolder"});return e.name},setFileClickActionName:function(e){this.bxim.setLocalConfig("ww",e);switch(e){case"openFolder":case"openFile":break;default:e="openFolder"}this.bxim.setLocalConfig("fileClickAction",{name:e})},canShowNotify:function(){if(!this.enableShowingNotify){return false}return this.bxim.settings.status!="dnd"},showNotifySingleFile:function(e){if(e.isDirectory||e.modifiedBy==this.currentUserId){return}var t=this.bxim.messenger.users[e.modifiedBy];var i=null;if(t&&BX.type.isNotEmptyString(t.avatar)&&t.avatar.indexOf("blank.gif")==-1){i=t.avatar}var s=BX.message("disk_notify_single_file").replace("#FILENAME#",e.name);var a='BX.desktop.windowCommand("close");';if(e.isDeleted){s=s.replace("#OPERATION#",BX.message("disk_notify_single_file_operation_deleted"));a='BX.desktop.windowCommand("main", "show");'+'BX.desktop.onCustomEvent("main", "BXChangeTab", ["disk"]);'+'BX.desktop.windowCommand("close");'}else if(e.isNew){s=s.replace("#OPERATION#",BX.message("disk_notify_single_file_operation_created"));a=this.getFileClickActionStringJs(e)+'; BX.desktop.windowCommand("close");'}else{s=s.replace("#OPERATION#",BX.message("disk_notify_single_file_operation_updated"));a=this.getFileClickActionStringJs(e)+'; BX.desktop.windowCommand("close");'}var n={date:(new Date).getTime()/1e3,id:"bd-file-"+this.getFileId(e.id),text:s,userLink:t.profile,userAvatar:t.avatar||"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:t.name,type:"2"};var o=BX.create("div",{attrs:{"data-notifyId":n.id,"data-notifyType":n.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:n.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":n.id,"data-notifyType":n.type},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:DiskFormatDate(n.date)}),BX.create("span",{props:{className:"bx-notifier-item-name"},html:'<a href="'+n.userLink+'">'+(typeof BX.MessengerCommon!="undefined"?BX.MessengerCommon.prepareText(n.userName):BX.IM.prepareText(n.userName))+"</a>"}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:n.text})]})]});var r='var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ '+a+" });"+'BX.bind(notify, "contextmenu", function(){ '+a+" });";BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(o,r,false))},showWarningLockedDocument:function(e){var t=BX.create("div",{attrs:{"data-notifyId":(new Date).getTime()/100,"data-notifyType":"2"},props:{className:"bx-notifier-item"},children:[BX.create("div",{html:BX.Disk.InformationPopups.getContentWarningLockedDocumentDesktop({link:e.link})})]});var i='var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);';BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(t,i,false))},showConflictBetweenFiles:function(e){var t=BX.create("div",{attrs:{"data-notifyId":(new Date).getTime()/100,"data-notifyType":"2"},props:{className:"bx-notifier-item"},children:[BX.create("div",{html:BX.Disk.InformationPopups.getContentConflictBetweenFiles(e.forkedFileData,e.originFileData)})]});console.log(t);var i='BX.desktop.windowCommand("freeze");'+'var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bindDelegate(notify, "click", {className: "js-disk-open-filefolder"}, function(event){ '+"BX.PreventDefault(event);"+'var path = event.target.getAttribute("data-href");'+"BXFileStorage.FileExist(path, function(exist){"+"if(exist)"+"BXFileStorage.OpenFileFolder(path, function(){});"+"})"+" });"+"";BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(t,i,false))},showLockedByProgram:function(e){var t=BX.create("div",{attrs:{"data-notifyId":(new Date).getTime()/100,"data-notifyType":"2"},props:{className:"bx-notifier-item"},children:[BX.create("div",{html:BX.Disk.InformationPopups.getContentLockedByProgram(e.fileData,e.program)})]});console.log(t);var i='BX.desktop.windowCommand("freeze");'+'var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bindDelegate(notify, "click", {className: "js-disk-open-filefolder"}, function(event){ '+"BX.PreventDefault(event);"+'var path = event.target.getAttribute("data-href");'+"BXFileStorage.FileExist(path, function(exist){"+"if(exist)"+"BXFileStorage.OpenFileFolder(path, function(){});"+"})"+" });"+"";BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(t,i,false))},showSwitchOnBDisk:function(){var e=BX.create("div",{attrs:{"data-notifyId":(new Date).getTime()/100,"data-notifyType":"2"},props:{className:"bx-notifier-item"},children:[BX.create("div",{html:BX.Disk.InformationPopups.getContentSwitchOnBDisk()})]});var t='BX.desktop.windowCommand("freeze");'+'var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+"var tab_index = BXDesktopSystem.MyTabNumber()-1;"+'var link = BX("bx-open-bdisk-settings");'+'BX.bind(link, "click", function(event){ '+"BX.PreventDefault(event);"+"window.open('http://bxd-internal/bdisk_settings_window.html#bdisk_settings_'+tab_index,'bdisk_settings_'+tab_index,'width=540,height=320')"+" });"+"";BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(e,t,false))},notifyProgressEdit:function(e){e=e||{};var t=!!e.isUpload;var i=!!e.isCreate;var s='BX.desktop.windowCommand("close");';var a="";if(i){a=BX.message("disk_progress_start_create")}else{a=BX.message(t?"disk_progress_start_edit_upload":"disk_progress_start_edit");this.localEditFiles[e.name]={}}var n={date:(new Date).getTime()/1e3,id:"bd-file-edit-"+(new Date).getTime()/1e3,text:a,userAvatar:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:BX.message("disk_name"),type:"2"};var o=BX.create("div",{attrs:{"data-notifyId":n.id,"data-notifyType":n.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:n.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":n.id,"data-notifyType":n.type},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-text"},text:e.name}),BX.create("div",{style:{marginLeft:"-7px"},html:'<div class="bx-disk-loader-popup-progress-continer">'+'<div class="bx-disk-loader-popup-progress-track">'+'<div id="bx-disk-loader-popup-progress-line" class="bx-disk-loader-popup-progress-line" style="width:1%"></div>'+"</div>"+'<div class="bx-disk-loader-popup-speed"><span id="disk-speed"></span></div>'+"</div>"}),BX.create("div",{props:{id:"bx-notifier-item-text",className:"bx-notifier-item-text"},html:a})]})]});var r='BX.desktop.windowCommand("freeze");'+'window.name = "notifyProgressEdit";'+'window.filePath = "'+BX.util.jsencode(e.name)+'";'+'window.disk_speed_seconds = "'+BX.message("disk_speed_seconds")+'";'+"window.lastPortion = 0;"+"window.anim = null;"+"setTimeout(function(){ if(window.lastPortion)return; "+"window.lastPortion = (Math.floor(Math.random() * (12 - 4)) + 4);"+'BX.adjust(BX("disk-speed"), {text: window.lastPortion + "%"});'+"window.anim = new BX.easing({"+"duration : 400,"+"start : { width : 0},"+"finish : { width : window.lastPortion},"+"transition : BX.easing.makeEaseOut(BX.easing.transitions.quad),"+"step : function(state) {"+"window.lastPortion = state.width;"+'BX("bx-disk-loader-popup-progress-line").style.width = state.width + "%";'+"},"+"complete : BX.delegate(function() {"+"}, this)"+"});"+"window.anim.animate();"+" }, 230);"+'BX.desktop.addCustomEvent("sub-BXFileStorageSyncStatusProgressFile", function(path, bytes, speed, fileSize){'+"if(path !== window.filePath)"+"return;"+"var portion = Math.floor((bytes/fileSize)*100);"+"if(window.lastPortion > portion) { return; };"+"if(!!window.anim) { window.anim.stop(); }"+"window.anim = new BX.easing({"+"duration : 400,"+"start : { width : window.lastPortion},"+"finish : { width : portion},"+"transition : BX.easing.makeEaseOut(BX.easing.transitions.quad),"+"step : function(state) {"+"window.lastPortion = state.width;"+'BX("bx-disk-loader-popup-progress-line").style.width = state.width + "%";'+"},"+"complete : BX.delegate(function() {"+"}, this)"+"});"+"window.anim.animate();"+"window.lastPortion = portion;"+'BX.adjust(BX("disk-speed"), {text: portion + "%" + " " + (!!speed? "(" + BitrixDisk.formatSize(speed) + "/" + disk_speed_seconds + ")" : "")});'+'BX.style(BX("bx-disk-loader-popup-progress-line"), "width", portion + "%");'+"});"+'BX.desktop.addCustomEvent("onLaunchApp", function(){ setTimeout(function(){BX.desktop.windowCommand("close");}, 2000);   BX.adjust(BX("bx-notifier-item-text"), {text: "'+BX.message("disk_progress_start_launch_app")+'"})});'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ '+s+" });"+'BX.bind(notify, "contextmenu", function(){ '+s+" });"+"";this.currentNotifyWindow=BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(o,r,false))},notifyProgressView:function(e){e=e||{};var t='BX.desktop.windowCommand("close");';var i={date:(new Date).getTime()/1e3,id:"bd-file-view-"+(new Date).getTime()/1e3,text:BX.message("disk_progress_start_view"),userAvatar:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:BX.message("disk_name"),type:"2"};var s=BX.create("div",{attrs:{"data-notifyId":i.id,"data-notifyType":i.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:i.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":i.id,"data-notifyType":i.type},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-text"},text:e.name}),BX.create("div",{style:{marginLeft:"-7px"},html:'<div class="bx-disk-loader-popup-progress-continer">'+'<div class="bx-disk-loader-popup-progress-track">'+'<div id="bx-disk-loader-popup-progress-line" class="bx-disk-loader-popup-progress-line" style="width:1%"></div>'+"</div>"+'<div class="bx-disk-loader-popup-speed"><span id="disk-speed"></span></div>'+"</div>"}),BX.create("div",{props:{id:"bx-notifier-item-text",className:"bx-notifier-item-text"},html:BX.message("disk_progress_start_view")})]})]});var a='BX.desktop.windowCommand("freeze");'+'window.name = "notifyProgressEdit";'+'window.filePath = "'+BX.util.jsencode(e.name)+'";'+'window.disk_speed_seconds = "'+BX.message("disk_speed_seconds")+'";'+"window.lastPortion = 0;"+"window.anim = null;"+"setTimeout(function(){ if(window.lastPortion)return; "+"window.lastPortion = (Math.floor(Math.random() * (12 - 4)) + 4);"+'BX.adjust(BX("disk-speed"), {text: window.lastPortion + "%"});'+"window.anim = new BX.easing({"+"duration : 400,"+"start : { width : 0},"+"finish : { width : window.lastPortion},"+"transition : BX.easing.makeEaseOut(BX.easing.transitions.quad),"+"step : function(state) {"+"window.lastPortion = state.width;"+'BX("bx-disk-loader-popup-progress-line").style.width = state.width + "%";'+"},"+"complete : BX.delegate(function() {"+"}, this)"+"});"+"window.anim.animate();"+" }, 230);"+'BX.desktop.addCustomEvent("sub-BXFileStorageSyncStatusProgressFile", function(path, bytes, speed, fileSize){'+"if(path !== window.filePath)"+"return;"+"var portion = Math.floor((bytes/fileSize)*100);"+"if(window.lastPortion > portion) { return; };"+"if(!!window.anim) { window.anim.stop(); }"+"window.anim = new BX.easing({"+"duration : 400,"+"start : { width : window.lastPortion},"+"finish : { width : portion},"+"transition : BX.easing.makeEaseOut(BX.easing.transitions.quad),"+"step : function(state) {"+"window.lastPortion = state.width;"+'BX("bx-disk-loader-popup-progress-line").style.width = state.width + "%";'+"},"+"complete : BX.delegate(function() {"+"}, this)"+"});"+"window.anim.animate();"+"window.lastPortion = portion;"+'BX.adjust(BX("disk-speed"), {text: portion + "%" + " " + (!!speed? "(" + BitrixDisk.formatSize(speed) + "/" + disk_speed_seconds + ")" : "")});'+'BX.style(BX("bx-disk-loader-popup-progress-line"), "width", portion + "%");'+"});"+'BX.desktop.addCustomEvent("onLaunchApp", function(){setTimeout(function(){BX.desktop.windowCommand("close");}, 2000);  BX.adjust(BX("bx-notifier-item-text"), {text: "'+BX.message("disk_progress_start_launch_app")+'"})});'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ '+t+" });"+'BX.bind(notify, "contextmenu", function(){ '+t+" });"+"";this.currentNotifyWindow=BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(s,a,false))},notifyProgressLaunchApp:function(e){e=e||{};var t='BX.desktop.windowCommand("close");';var i={date:(new Date).getTime()/1e3,id:"bd-file-view-"+(new Date).getTime()/1e3,text:BX.message("disk_progress_start_launch_app"),userAvatar:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:BX.message("disk_name"),type:"2"};var s=BX.create("div",{attrs:{"data-notifyId":i.id,"data-notifyType":i.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:i.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":i.id,"data-notifyType":i.type},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-text"},text:e.name}),BX.create("div",{style:{marginLeft:"50px"},children:[BX.create("img",{props:{src:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/popups-alert-mov.gif"}})]}),BX.create("div",{props:{className:"bx-notifier-item-text"},html:BX.message("disk_progress_start_launch_app")})]})]});var a='window.name = "notifyProgressLaunchApp";'+'var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'setTimeout(function(){BX.desktop.windowCommand("close");}, 1000);'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ '+t+" });"+'BX.bind(notify, "contextmenu", function(){ '+t+" });";this.currentNotifyWindow=BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(s,a,false))},notifyProgressExtLink:function(e){e=e||{};var t=!!e.isFinish;var i='BX.desktop.windowCommand("close");';var s={date:(new Date).getTime()/1e3,id:"bd-file-edit-"+(new Date).getTime()/1e3,text:BX.message(t?"disk_progress_finish_extlink":"disk_progress_start_extlink"),userAvatar:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:BX.message("disk_name"),type:"2"};var a=BX.create("div",{attrs:{"data-notifyId":s.id,"data-notifyType":s.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:s.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":s.id,"data-notifyType":s.type},props:{className:"bx-notifier-item-delete"}}),t?null:BX.create("div",{style:{marginLeft:"50px"},children:[BX.create("img",{props:{src:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/popups-alert-mov.gif"}})]}),!t?null:BX.create("span",{props:{className:"bx-notifier-item-name"},html:'<a href="'+s.userLink+'">'+s.userName+"</a>"}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:s.text})]})]});var n='window.name = "notifyProgressExtLink";'+(t?'setTimeout(function(){BX.desktop.windowCommand("close");}, 2500);':'BX.desktop.windowCommand("freeze");')+'var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ '+i+" });"+'BX.bind(notify, "contextmenu", function(){ '+i+" });";this.currentNotifyWindow=BXDesktopSystem.ExecuteCommand("notification.show.html",this.bxim.desktop.getHtmlPage(a,n,false))},onStartViewingFile:function(e,t,i,s,a){console.debug(arguments);a=a||false;console.debug(this.getSyncTime(),"StartViewingFile:  ",e+"  ");if(!this.isEmptyObject(t)){return}var n=this.getLastWindow("notifyProgressView");if(n){BX.desktop.windowCommand(n,"close")}this.notifyProgressView({name:e})},getLastWindow:function(e){try{var t=BXWindows.slice(-1);if(!!t){if(!!t[0]){if(t[0].name==e){return t[0]}for(var i in BXWindows){if(!BXWindows.hasOwnProperty(i)){continue}if(BXWindows[i].name==e){return BXWindows[i]}}}}}catch(e){}return false},getLastWindowByPrefix:function(e){try{var t=BXWindows.slice(-1);if(!!t){if(!!t[0]){if(t[0].name.search(e)!=-1){return t[0]}for(var i in BXWindows){if(!BXWindows.hasOwnProperty(i)){continue}if(BXWindows[i].name.search(e)!=-1){return BXWindows[i]}}}}}catch(e){}return false},onStartEditingFile:function(e,t,i,s,a,n){console.debug(arguments);a=a||false;console.debug(this.getSyncTime(),"StartEditingFile:  ",e+"  ");var o=typeof BXFileStorage=="undefined"?false:BXFileStorage.GetStatus().status=="online";if(!o){console.debug(this.getSyncTime(),"Disk is disabled");return}if(!this.isEmptyObject(t)){return}if(!!n){var r=this.getLastWindow("notifyProgressEdit");if(r){BX.desktop.windowCommand(r,"close")}this.notifyProgressEdit({name:e,isCreate:true});return}if(!a&&!s){var r=this.getLastWindow("notifyProgressEdit");if(r){BX.desktop.windowCommand(r,"close")}this.notifyProgressEdit({name:e,isUpload:!s})}if(a&&s){var r=this.getLastWindow("notifyProgressEdit");if(r){BX.desktop.windowCommand(r,"close")}this.notifyProgressEdit({name:e,isUpload:!s})}},onLaunchApp:function(){console.debug(this.getSyncTime(),"LaunchApp:  ");BX.desktop.onCustomEvent("onLaunchApp",[])},onFinalEditingFile:function(e,t){if(this.isEmptyObject(t)){delete this.localEditFiles[e]}BX.desktop.onCustomEvent("sub-BXFileStorageSyncStatusProgressFile",[e,100,0,100]);setTimeout(BX.delegate(function(){var e=this.getLastWindow("notifyProgressEdit");if(e){BX.desktop.windowCommand(e,"close")}e=this.getLastWindow("notifyProgressView");if(e){BX.desktop.windowCommand(e,"close")}},this),1e3);console.debug(this.getSyncTime(),"FinalEditingFile:  ",e+"  ")},onStartExternalLink:function(){var e=this.getLastWindow("notifyProgressExtLink");if(e){BX.desktop.windowCommand(e,"close")}this.notifyProgressExtLink();console.debug(this.getSyncTime(),"StartExternalLink:  ")},onFinalExternalLink:function(){setTimeout(BX.delegate(function(){var e=this.getLastWindow("notifyProgressExtLink");if(e){BX.desktop.windowCommand(e,"close")}this.notifyProgressExtLink({isFinish:true});console.debug(this.getSyncTime(),"FinalExternalLink:  ")},this),300)},showNotifyChangedObjects:function(e,t){var i="";if(e.add&&e.add>0||t.add&&t.add>0){i+=formatNotifyString("add",e.add||0,t.add||0)+"<br>"}if(e.update&&e.update>0||t.update&&t.update>0){i+=formatNotifyString("update",e.update||0,t.update||0)+"<br>"}if(e.delete&&e.delete>0||t.delete&&t.delete>0){i+=formatNotifyString("delete",e.delete||0,t.delete||0)+"<br>"}var s={date:(new Date).getTime()/1e3,id:"bd"+(new Date).getTime()/1e3,text:i,userAvatar:"/bitrix/components/bitrix/disk.bitrix24disk/templates/.default/images/disk_34x34.png",userName:BX.message("disk_name"),type:"2"};var a=BX.create("div",{attrs:{"data-notifyId":s.id,"data-notifyType":s.type},props:{className:"bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"},attrs:{src:s.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":s.id,"data-notifyType":s.type},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:DiskFormatDate(s.date)}),BX.create("span",{props:{className:"bx-notifier-item-name"},html:'<a href="'+s.userLink+'">'+s.userName+"</a>"}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:s.text})]})]});var n='var notifyClose = BX.findChild(document.body, {className : "bx-notifier-item-delete"}, true);'+'BX.bind(notifyClose, "click", function(event){ BX.desktop.windowCommand("close"); return BX.PreventDefault(event) });'+'var notify = BX.findChild(document.body, {className : "bx-notifier-item"}, true);'+'BX.bind(notify, "click", function(event){ BXDesktopSystem.GetMainWindow().ExecuteCommand("show"); BX.desktop.setActiveWindow(TAB_CP); BX.desktop.onCustomEvent("main", "BXChangeTab", [\'disk\']); BX.desktop.windowCommand("close");  });'+'BX.bind(notify, "contextmenu", function(){ BXDesktopSystem.GetMainWindow().ExecuteCommand("show"); BX.desktop.windowCommand("close"); });';BXDesktopSystem.ExecuteCommand("notification.show.html",BXIM.desktop.getHtmlPage(a,n,false))}};
//# sourceMappingURL=disk.map.js