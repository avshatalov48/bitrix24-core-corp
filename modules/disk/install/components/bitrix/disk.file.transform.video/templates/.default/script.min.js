(function(){BX.namespace("BX.Disk");BX.Disk.FileTransformVideo=function(e){this.runGenerationPreviewData=e.runGenerationPreviewData;this.runGeneratePreviewLinkClass=e.runGeneratePreviewLinkClass;this.downloadLink=e.downloadLink;this.pullTag=e.pullTag;this.layout=e.layout;this.video={width:null,height:null,sources:null};this.bindEvents();if(this.pullTag){this.registerPullEvent(this.pullTag)}};BX.Disk.FileTransformVideo.prototype={bindEvents:function(){console.log("bindEvents",this.layout.containerId);BX.bindDelegate(BX(this.layout.containerId),"click",{className:this.runGeneratePreviewLinkClass},this.handleClickToRunTransformation.bind(this))},handleClickToRunTransformation:function(e){e.preventDefault();var t={};if(this.runGenerationPreviewData.attachedObjectId){t.attachedObjectId=this.runGenerationPreviewData.attachedObjectId}if(this.runGenerationPreviewData.attachedObjectId){t.fileId=this.runGenerationPreviewData.fileId}BX.ajax.runAction(this.runGenerationPreviewData.action,{data:t}).then(function(t){var i=t.data.previewGeneration;var a=BX.getEventTarget(e);var r=BX(this.layout.containerId);if(!r){return}var n=r.querySelector(".disk-file-transform-file-loader-title");var s=r.querySelector(".disk-file-transform-file-loader-desc");var o=r.querySelector(".disk-file-transform-file-loader-inner");if(i.status==="success"){this.registerPullEvent(i.data.pullTag);BX.adjust(n,{text:BX.message("DISK_FILE_TRANSFORM_VIDEO_IN_PROCESS_TITLE")});if(s){BX.adjust(s,{text:BX.message("DISK_FILE_TRANSFORM_VIDEO_IN_PROCESS_DESC")})}if(o){BX.adjust(o,{html:this.getDummyLoaderHtml()})}}else{BX.adjust(n,{text:BX.message("DISK_FILE_TRANSFORM_VIDEO_ERROR_TITLE")});if(s){var l=this.getErrorMessageByCode(i.status);if(l){BX.adjust(s,{text:l})}}this.showError()}BX(a).remove()}.bind(this))},registerPullEvent:function(e){if(this.isRegisteredPullEvent){return}this.isRegisteredPullEvent=true;console.log("registerPullEvent",e);BX.addCustomEvent("onPullEvent-main",function(e,t){if(e==="transformationComplete"){console.log("transformationComplete");this.loadVideo().then(function(){var e=new BX.Fileman.Player("playerId_"+Math.floor(Math.random()*Math.floor(1e5)),{width:Math.min(this.width,800),height:Math.min(this.width,800)*9/16,sources:this.sources});if(BX(this.layout.containerId)){BX.replace(BX(this.layout.containerId),e.createElement());e.init()}}.bind(this),function(){this.showError()}.bind(this))}}.bind(this));BX.PULL.extendWatch(e)},loadVideo:function(){var e=new BX.Promise;BX.ajax.promise({url:BX.util.add_url_param(this.downloadLink,{ts:"bxviewer"}),method:"GET",dataType:"json",headers:[{name:"BX-Viewer-src",value:this.downloadLink},{name:"BX-Viewer",value:"video"}]}).then(function(t){if(t.data.data){this.width=t.data.data.width;this.height=t.data.data.height;this.sources=t.data.data.sources}if(t.data.html){var i=BX.processHTML(t.data.html);BX.load(i.STYLE,function(){BX.ajax.processScripts(i.SCRIPT,undefined,function(){e.fulfill(this)}.bind(this))}.bind(this))}}.bind(this));return e},getDummyLoaderHtml:function(){return'<svg class="disk-file-transform-file-circular hidden" viewBox="25 25 50 50"><circle class="disk-file-transform-file-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/><circle class="disk-file-transform-file-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/></svg>'},showError:function(){var e=BX(this.layout.containerId);if(!e){return}BX.adjust(e.querySelector(".disk-file-transform-file-loader-inner"),{html:this.getDummyErrorHtml()})},getDummyErrorHtml:function(){return'<div class="disk-file-transform-file-loader-button disk-file-transform-file-loader-button-sad"></div>'},getErrorMessageByCode:function(e){switch(e){case"not allowed":return BX.message("DISK_FILE_TRANSFORM_VIDEO_ERROR_TRANSFORM_NOT_ALLOWED");case"no module":return BX.message("DISK_FILE_TRANSFORM_VIDEO_ERROR_TRANSFORM_NOT_INSTALLED");case"was transformed":return BX.message("DISK_FILE_TRANSFORM_VIDEO_ERROR_TRANSFORM_TRANSFORMED")}return""}}})(window);
//# sourceMappingURL=script.map.js