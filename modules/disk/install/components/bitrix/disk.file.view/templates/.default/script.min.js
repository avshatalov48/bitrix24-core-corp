BX.namespace("BX.Disk");BX.Disk.FileViewClass=function(){var e=false;var t=false;var i=function(e){this.componentName=e.componentName;this.signedParameters=e.signedParameters;this.selectorId=e.selectorId;this.object=e.object||{};this.uf=e.uf||{};this.canDelete=!!e.canDelete;if(e.externalLinkInfo){this.buildExternalLinkByState(e.externalLinkInfo)}this.layout=e.layout;this.urls=e.urls;this.gridId=e.gridId;this.grid=this.gridId?BX.Main.gridManager.getById(this.gridId):null;this.ajaxUrl="/bitrix/components/bitrix/disk.file.view/ajax.php";this.ajaxCurrentPageUrl=document.location.href;this.popupOuterLink=null;this.selectorInitialized=false;if(!e.withoutEventBinding)this.setEvents();this.render();this.workWithLocationHash();BX.ajax.runAction("disk.api.file.showSharingEntities",{analyticsLabel:"file.view",data:{fileId:this.object.id}}).then(function(e){if(BX.type.isArray(e.data)){e.data.forEach(function(e){var t=new BX.Disk.Model.SharingItem({state:{entity:e.entity,sharing:e.sharing,object:{id:this.object.id}}});t.render();document.querySelector(".disk-detail-sidebar-user-access-section").appendChild(t.getContainer());var i=BX.UI.SelectorManager.instances[this.selectorId];if(i){i.itemsSelected[e.entity.id]=BX.UI.SelectorManager.convertEntityType(e.entity.type)}BX.onCustomEvent("Disk.FileView:onShowSharingEntities",[{id:this.selectorId,openDialogWhenInit:false}]);this.selectorInitialized=true}.bind(this))}}.bind(this))};i.prototype.buildExternalLinkByState=function(e){this.externalLink=new BX.Disk.Model.ExternalLink.Input({state:e,data:{objectId:this.object.id},models:{externalLinkSettings:new BX.Disk.Model.ExternalLink.Settings({state:e}),externalLinkDescription:new BX.Disk.Model.ExternalLink.Description({state:e})}})};i.prototype.setUrlToAjaxCurrentPage=function(e){this.ajaxCurrentPageUrl=e};i.prototype.getUrlToAjaxCurrentPage=function(){return this.ajaxCurrentPageUrl.replace(document.location.hash,"")};i.prototype.render=function(){if(this.externalLink&&this.layout.externalLink){this.externalLink.render();this.layout.externalLink.parentNode.replaceChild(this.externalLink.getContainer(),this.layout.externalLink);this.adjustExternalLinkBlockHeight()}};i.prototype.setEvents=function(){BX.bind(BX("disk-detail-sidebar-public-link-copy-link"),"click",this.copyInternalLink.bind(this));if(this.layout.deleteButton){BX.bind(this.layout.deleteButton,"click",this.openDeleteConfirm.bind(this))}if(this.layout.restoreButton){BX.bind(this.layout.restoreButton,"click",this.openConfirmRestoreFromTrash.bind(this))}if(this.layout.addSharingButton){BX.bind(this.layout.addSharingButton,"click",this.openSelector.bind(this))}if(this.layout.editUf){BX.bind(this.layout.editUf,"click",this.editUf.bind(this))}BX.bind(this.layout.moreActionsButton,"click",this.openFileActions.bind(this));BX.bind(window,"popstate",this.onPopState.bind(this));BX.addCustomEvent("onIframeElementLoadDataToView",BX.proxy(this.onIframeElementLoadDataToView,this));BX.addCustomEvent("onIframeElementConverted",BX.proxy(this.onIframeElementConverted,this));BX.addCustomEvent("onBeforeElementShow",BX.proxy(this.onBeforeElementShow,this));BX.addCustomEvent(this.externalLink.externalLinkDescription,"Disk.Model.Item:afterRender",this.handleAfterRenderExternalLinkSettings.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",this.onSliderMessage.bind(this));BX.addCustomEvent("onPopupFileUploadClose",this.onPopupFileUploadClose.bind(this));if(!!this.uf){BX.bind(this.uf.editButton,"click",BX.delegate(this.onClickEditUfButton,this))}};i.prototype.onSliderMessage=function(e){var t=e.getData();if(e.getEventId()==="Disk.File:onRestoredFromVersion"||e.getEventId()==="Disk.Version:onDeleted"||e.getEventId()==="Disk.OnlyOffice:onSaved"){window.location.reload()}if(e.getEventId()==="Disk.File:onNewVersionUploaded"){if(e.getData().object.id==this.object.id){window.location.reload()}}if(e.getEventId()==="Disk.File.Uf:onUpdated"){this.reloadUf()}};i.prototype.onPopupFileUploadClose=function(e,t){if(t==this.object.id){document.location.reload()}};i.prototype.onBeforeElementShow=function(e,t,i){if(t.hasOwnProperty("image")||!BX.message("disk_restriction")){return}i.prevent=true;BX.PopupWindowManager.create("bx-disk-business-tools-info",null,{content:BX("bx-bitrix24-business-tools-info"),closeIcon:true,onPopupClose:function(){this.destroy()},autoHide:true,zIndex:11e3}).show()};i.prototype.handleAfterRenderExternalLinkSettings=function(){this.adjustExternalLinkBlockHeight()};i.prototype.onIframeElementConverted=function(e,t,i){this.setUrlToAjaxCurrentPage(this.ajaxCurrentPageUrl.replace(encodeURIComponent(i),encodeURIComponent(t)))};i.prototype.onIframeElementLoadDataToView=function(e,t){if(t&&t.status==="restriction"&&BX("bx-bitrix24-business-tools-info")){setTimeout(function(){if(BX.CViewer&&BX.CViewer.objNowInShow){if(e.currentModalWindow){e.currentModalWindow.close()}BX.CViewer.objNowInShow.close()}},100);BX.PopupWindowManager.create("bx-disk-business-tools-info",null,{content:BX("bx-bitrix24-business-tools-info"),closeIcon:true,onPopupClose:function(){this.destroy()},autoHide:true,zIndex:11e3}).show()}};i.prototype.onClickEditUfButton=function(e){BX.PreventDefault(e);BX.Disk.ajax({url:BX.Disk.addToLinkParam(document.location.href.replace(document.location.hash,""),"action","editUserField"),method:"POST",dataType:"html",data:{},onsuccess:BX.delegate(function(e){var t=BX.findChild(this.uf.contentContainer,{className:"bx-disk-uf-show-content"});var i=BX.findChild(this.uf.contentContainer,{className:"bx-disk-uf-edit-content"});if(t){BX.hide(t)}BX.adjust(i,{html:e})},this)})};i.prototype.openConfirmRestoreFromTrash=function(){var e=this.object.name;var t=this.object.id;var i=BX.message("DISK_FILE_TRASH_RESTORE_FILE_CONFIRM_1");var o=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_FILE_RESTORE"),className:"popup-window-button-accept",events:{click:function(e){this.addClassName("popup-window-button-wait");BX.ajax.runAction("disk.api.file.restore",{analyticsLabel:"file.view",data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var i=BX.SidePanel.Instance.getSliderByWindow(window);if(i){i.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onRestore",{objectId:t})}else if(e.data.file.id){document.location.href=BX.Disk.getUrlToShowObjectInGrid(e.data.ID)}})}}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close()}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_TRASHCAN_TRASH_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:i.replace("#NAME#",e),buttons:o})};i.prototype.openConfirmRestore=function(e){var t=e.object.name;var i=e.object.id;var o=e.version.id;var n=BX.message("DISK_FILE_VIEW_VERSION_RESTORE_CONFIRM_1");var s=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","restoreFromVersion"),data:{objectId:i,versionId:o},onsuccess:BX.delegate(function(e){if(!e){return}this.grid.instance.reload();BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:n.replace("#NAME#",t),buttons:s})};i.prototype.openDeleteConfirm=function(){var e=this.object.name;var t=this.object.id;var i=this.canDelete?BX.message("DISK_FILE_VIEW_TRASH_DELETE_DESTROY_FILE_CONFIRM"):BX.message("DISK_FILE_VIEW_TRASH_DELETE_FILE_CONFIRM");if(this.object.isDeleted){i=BX.message("DISK_FILE_VIEW_TRASH_DELETE_DESTROY_DELETED_FILE_CONFIRM")}var o=[];if(!this.object.isDeleted){o.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_TRASH_DELETE_BUTTON"),className:"ui-btn ui-btn-success",events:{click:function(e){this.addClassName("ui-btn-clock");BX.ajax.runAction("disk.api.file.markDeleted",{analyticsLabel:"file.view",data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var i=BX.SidePanel.Instance.getSliderByWindow(window);if(i){i.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onMarkDeleted",{objectId:t})}})}}}))}if(this.canDelete){var n=this;o.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_TRASH_DESTROY_BUTTON"),className:"ui-btn ui-btn-light-border",events:{click:function(e){this.addClassName("ui-btn-clock");BX.ajax.runAction("disk.api.file.delete",{analyticsLabel:"file.view",data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var i=BX.SidePanel.Instance.getSliderByWindow(window);if(i){i.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onDelete",{objectId:t})}else{document.location.href=n.urls.trashcanList}})}}}))}o.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),className:"ui-btn ui-btn-link",events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close()}}}));BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_TITLE"),contentClassName:"disk-popup-text-content",content:i.replace("#NAME#",e),buttons:o})};i.prototype.openConfirmDeleteVersion=function(e){var t=e.object.name;var i=e.object.id;var o=e.version.id;var n=BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_CONFIRM");var s=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteVersion"),data:{objectId:i,versionId:o},onsuccess:BX.delegate(function(e){if(!e){return}this.grid.instance.removeRow(o);BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:n.replace("#NAME#",t),buttons:s})};i.prototype.deleteBizProc=function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteBizProc"),data:{idBizProc:e,fileId:this.object.id},onsuccess:BX.delegate(function(t){if(t){BX.remove(BX(e))}},this)})};i.prototype.stopBizProc=function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","stopBizProc"),data:{idBizProc:e,fileId:this.object.id},onsuccess:BX.delegate(function(e){if(e.status=="success"){var t=document.location.href.replace("#tab-bp","");t+="#tab-bp";document.location.href=t;location.reload()}else{e.errors=e.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:e.errors.pop().message})}},this)})};i.prototype.openSlider=function(e){BX.SidePanel.Instance.open(e,{allowChangeHistory:false})};i.prototype.showLogBizProc=function(e){this.openSlider(BX.Disk.addToLinkParam(this.urls.fileShowBp,"log_workflow",e))};i.prototype.sortBizProcLog=function(){var e=BX.findChildByClassName(BX("workarea-content"),"bx-sortable").getAttribute("onclick").replace("log_sort=1&","");e=e.replace("?log_workflow","?log_sort=1&log_workflow");e=e.replace("&action=showBp","");BX.findChildByClassName(BX("workarea-content"),"bx-sortable").setAttribute("onclick",e)};i.prototype.fixUrlForSort=function(){var e=document.location.href.replace("&log_sort=1","");e+="#tab-bp";document.location.href=e};i.prototype.copyInternalLink=function(){var e=BX("disk-detail-sidebar-public-link-copy-link");var t=e.getAttribute("for");var i=document.getElementById(t);i.select();document.execCommand("copy");this.popupOuterLink?null:this.showCopyLinkPopup(e,BX.message("DISK_FILE_VIEW_INTERNAL_LINK_COPIED"))};i.prototype.showCopyLinkPopup=function(e,t){this.popupOuterLink=new BX.PopupWindow("disk-popup-copy-link",e,{className:"disk-popup-copy-link",bindPosition:{position:"top"},offsetLeft:-10,darkMode:true,angle:true,content:t});this.popupOuterLink.show();setTimeout(function(){BX.addClass(BX(this.popupOuterLink.uniquePopupId),"disk-popup-copy-link-hide")}.bind(this),2e3);setTimeout(function(){this.popupOuterLink.destroy();this.popupOuterLink=null}.bind(this),2200)};i.prototype.adjustExternalLinkBlockHeight=function(){this.externalLink.adjustHeight()};i.prototype.onPopState=function(e){var t=e.state;if(t&&t.disk){window.location.reload()}};i.prototype.openFileActions=function(e){var t=BX.getEventTarget(e);var i=this;var o=[{text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_HISTORY"),onclick:function(){if(i.object.isHistoryBlocked){top.BX.UI.InfoHelper.show("limit_office_version_storage")}else{BX.SidePanel.Instance.open(i.urls.fileHistory)}this.close()}}];if(this.object.hasUf){o.push({text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_SHOW_USERFIELDS"),onclick:function(){BX.SidePanel.Instance.open(i.urls.fileShowUf,{allowChangeHistory:false});this.close()}})}if(this.object.hasBp){o.push({text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_SHOW_BP"),onclick:function(){BX.SidePanel.Instance.open(i.urls.fileShowBp,{allowChangeHistory:false});this.close()}})}BX.PopupMenu.show("disk-file-view-actions",BX(t),o,{className:"disk-file-view-actions-popup",angle:true,autoHide:true,offsetLeft:20,overlay:{opacity:.01},events:{onPopupClose:function(){BX.PopupMenu.destroy("disk-file-view-actions")}}})};i.prototype.editUf=function(){BX.SidePanel.Instance.open(this.urls.fileEditUf,{allowChangeHistory:false})};i.prototype.reloadUf=function(){BX.ajax.runComponentAction("bitrix:disk.file.view","showUfSidebar",{mode:"class",data:{fileId:this.object.id}}).then(function(e){BX.cleanNode(this.layout.sidebarUfValuesSection);this.layout.sidebarUfValuesSection.innerHTML=e.data.html}.bind(this))};i.prototype.openSelector=function(){if(!this.selectorInitialized){BX.onCustomEvent("Disk.FileView:onShowSharingEntities",[{id:this.selectorId,openDialogWhenInit:true}]);this.selectorInitialized=true}else{BX.onCustomEvent("Disk.FileView:openSelector",[{id:this.selectorId}])}};i.prototype.onUnSelectSelectorItem=function(e){BX.onCustomEvent("Disk.FileView:onUnSelectSelectorItem",[e])};i.prototype.onSelectSelectorItem=function(e){if(e.state!=="select")return;BX.Main.selectorManagerV2.getById(this.selectorId).closeDialog();var t=new BX.Disk.Model.DraftSharingItem({state:{entity:{id:e.item.id,name:e.item.name,link:e.item.link,avatar:e.item.avatar},object:{id:this.object.id}}});t.render();t.save();document.querySelector(".disk-detail-sidebar-user-access-section").appendChild(t.getContainer())};i.prototype.workWithLocationHash=function(){setTimeout(BX.delegate(function(){this.onHashChange()},this),350)};i.prototype.onHashChange=function(){var e=document.location.hash.match(/hl-([0-9]+)/g);if(e){var t=(document.location.hash.match(/!([a-zA-Z]+)/g)||[]).pop();for(var i in e){if(!e.hasOwnProperty(i)){continue}var o=e[i];var n=o.match(/hl-([0-9]+)/);if(n&&n[1]&&t){switch(t.toLowerCase()){case"!history":this.openSlider(this.urls.fileHistory);break}}}}};return i}();
//# sourceMappingURL=script.map.js