BX.namespace("BX.Iblock");BX.Iblock.IblockElementSelector=function(){var e=function(e){this.jsObject=e.jsObject;this.selectorId=e.selectorId;this.searchInputId=e.searchInputId;this.panelSelectedValues=e.panelSelectedValues==="Y";this.popup=e.popup==="Y";this.multiple=e.multiple==="Y";this.iblockId=e.iblockId;this.onChange=e.onChange;this.onSelect=e.onSelect;this.onUnSelect=e.onUnSelect;this.currentElements=e.currentElements;this.lastElements=e.lastElements;this.inputName=e.inputName;this.onlyRead=e.onlyRead==="Y";this.adminSection=e.admin==="Y"?"Y":"N";this.init()};e.prototype.init=function(){if(!this.selectorId){return false}this.ajaxUrl="/bitrix/components/bitrix/iblock.element.selector/ajax.php";this.listElementsData={};this.selectedElements=[];this.popupWindow=null;var e;if(this.currentElements.length){BX.addClass(BX(this.selectorId+"_search"),"ies-content-find-content-selected");var t=[];for(e in this.currentElements){if(this.currentElements.hasOwnProperty(e)){this.selectedElements[this.currentElements[e].ID]={id:this.currentElements[e].ID,name:this.currentElements[e].NAME};t.push({id:this.currentElements[e].ID,name:this.currentElements[e].NAME})}}this.setSelected(t)}if(this.lastElements.length){for(e in this.lastElements){if(this.lastElements.hasOwnProperty(e)){this.listElementsData[this.lastElements[e].ID]={id:this.lastElements[e].ID,name:this.lastElements[e].NAME}}}}if(BX(this.searchInputId)){this.searchInput=BX(this.searchInputId)}else{this.searchInput=BX(this.selectorId+"_search_input")}if(this.searchInput){BX.bind(this.searchInput,"keyup",BX.proxy(this.search,this));BX.bind(this.searchInput,"focus",BX.proxy(this._onFocus,this))}if(this.popup){BX.bind(BX(this.selectorId+"_select_button"),"click",BX.proxy(this.showSelector,this))}if(this.panelSelectedValues){this.onChange=BX.proxy(this.setToSelectedValues,this)}if(this.onChange){this.onChange(this.selectedElements)}};e.prototype.search=function(){this.requestTimeout=clearTimeout(this.requestTimeout);if(typeof this.searchRequest==="object"){this.searchRequest.abort();this.searchRequest=false}if(this.searchInput.value.length>0){this.displayTab("search");BX.addClass(BX(this.selectorId+"_search"),"ies-content-find-content-selected");this.url=this.ajaxUrl+"?sessid="+BX.bitrix_sessid()+"&mode=search&iblockId="+this.iblockId+"&admin="+this.adminSection+"&string="+encodeURIComponent(this.searchInput.value);this.requestTimeout=setTimeout(BX.proxy(this.request,this),400)}};e.prototype.displayTab=function(e){BX.removeClass(BX(this.selectorId+"_last"),"ies-content-tab-content-selected");BX.removeClass(BX(this.selectorId+"_search"),"ies-content-tab-content-selected");BX.addClass(BX(this.selectorId+"_"+e),"ies-content-tab-content-selected");BX.removeClass(BX(this.selectorId+"_tab_last"),"ies-content-tab-selected");BX.removeClass(BX(this.selectorId+"_tab_search"),"ies-content-tab-selected");BX.addClass(BX(this.selectorId+"_tab_"+e),"ies-content-tab-selected");if(e==="search")this.searchInput.focus()};e.prototype._onFocus=function(){this.searchInput.value=""};e.prototype.showResult=function(e){var t=BX(this.selectorId+"_search");if(!e||!e.length){t.innerHTML="";return}var s=e;if(t){t.innerHTML="";var i=BX.create("table",{props:{className:"ies-content-columns",cellspacing:"0"},children:[BX.create("tbody")]});var n=BX.create("tr");i.firstChild.appendChild(n);var l=BX.create("td");n.appendChild(l);t.appendChild(i);for(var c=0;c<s.length;c++){var a;var r=false;this.listElementsData[s[c].ID]={id:s[c].ID,name:s[c].NAME};var o=BX.create("input",{props:{className:"ies-hidden-input"}});if(this.multiple){o.name=this.selectorId+"[]";o.type="checkbox"}else{o.name=this.selectorId;o.type="radio"}var h=document.getElementsByName(o.name);var d=0;while(!r&&d<h.length){if(h[d].value===s[c].ID&&h[d].checked){r=true}d++}o.value=s[c].ID;var p=s[c].NAME;a=BX.create("div",{props:{className:"ies-content-item"+(r?" ies-content-item-selected":""),id:"ies-anchor_element_id_"+parseInt(s[c].ID)},events:{click:BX.proxy(this.select,this)},children:[o,BX.create("div",{props:{className:"ies-content-item-text"},text:p}),BX.create("div",{props:{className:"ies-content-item-icon"}})]});l.appendChild(a);if(c===Math.ceil(s.length/2)-1){l=BX.create("td");i.firstChild.appendChild(l)}}}};e.prototype.select=function(e){var t=null;if(e.currentTarget){t=e.currentTarget}var s=BX.findChild(t,{tag:"input"});var i,n,l;if(!this.multiple){n=document.getElementsByName(this.selectorId);for(l=0;l<n.length;l++){if(n[l].value!==s.value){BX.removeClass(n[l].parentNode,"ies-content-item-selected")}else{BX.addClass(n[l].parentNode,"ies-content-item-selected")}}s.checked=true;BX.addClass(t,"ies-content-item-selected");this.searchInput.value=this.listElementsData[s.value].name;this.selectedElements=[];this.selectedElements[s.value]={id:s.value,name:this.listElementsData[s.value].name};if(BX(this.selectorId+"_hidden_values")){BX(this.selectorId+"_hidden_values").innerHTML=""}}else{n=document.getElementsByName(this.selectorId+"[]");for(l=0;l<n.length;l++){if(n[l].value===s.value){n[l].checked=false;BX.toggleClass(n[l].parentNode,"ies-content-item-selected")}}if(BX.hasClass(s.parentNode,"ies-content-item-selected")){s.checked=true}if(s.checked){var c=BX.findChild(BX(this.selectorId+"_selected_elements"),{className:"ies-content-selected-items"});if(!BX(this.selectorId+"_element_selected_"+parseInt(s.value))){var a=BX.findChild(t,{tag:"div",className:"ies-content-item-text"},true);var r=BX.create("div",{props:{className:"ies-content-selected-item",id:this.selectorId+"_element_selected_"+parseInt(s.value)},children:[BX.create("div",{props:{id:this.selectorId+"-element-unselect-"+parseInt(s.value),className:"ies-content-selected-item-icon"},attrs:{onclick:'BX.Iblock["'+this.jsObject+'"].unselect("'+parseInt(s.value)+'");'}}),BX.create("span",{props:{className:"ies-content-selected-item-text"},text:a.innerHTML})]});c.appendChild(r);i=BX(this.selectorId+"_current_count");i.innerHTML=parseInt(i.innerHTML)+1;this.selectedElements[s.value]={id:s.value,name:this.listElementsData[s.value].name}}}else{BX.remove(BX(this.selectorId+"_element_selected_"+parseInt(s.value)));BX.remove(BX(this.selectorId+"_selected_value_"+parseInt(s.value)));i=BX(this.selectorId+"_current_count");i.innerHTML=parseInt(i.innerHTML)-1;this.selectedElements[s.value]=null}}if(this.onSelect){if(this.multiple){this.onSelect(this.selectedElements)}else{var o=this.selectedElements.pop();this.selectedElements.push(o);this.onSelect(o)}}BX.onCustomEvent(this,"on-change",[this.toObject(this.selectedElements)]);if(this.onChange){this.onChange(this.selectedElements)}};e.prototype.unselect=function(e,t){var s=BX(this.selectorId+"-element-unselect-"+e);var i=document.getElementsByName(this.selectorId+(this.multiple?"[]":""));for(var n=0;n<i.length;n++){if(i[n].value===e){i[n].checked=false;BX.removeClass(i[n].parentNode,"ies-content-item-selected")}}if(this.multiple){if(s){BX.remove(s.parentNode)}var l=BX(this.selectorId+"_current_count");l.innerHTML=parseInt(l.innerHTML)-1}this.selectedElements[e]=null;BX.onCustomEvent(this,"un-select",[this.toObject(this.selectedElements)]);if(this.onChange){this.onChange(this.selectedElements)}if(this.onUnSelect&&!t){this.onUnSelect(this.selectedElements)}if(BX(this.selectorId+"_selected_value_"+parseInt(e))){BX(this.selectorId+"_selected_value_"+parseInt(e)).value=0}if(this.searchInput&&!this.multiple){this.searchInput.value=""}};e.prototype.getSelected=function(){return this.selectedElements};e.prototype.setSelected=function(e){var t,s;for(t=0,s=this.selectedElements.length;t<s;t++){if(this.selectedElements[t]&&this.selectedElements[t].id){this.unselect(this.selectedElements[t].id,true)}}if(!e.length){return}this.selectedElements=[];for(t=0,s=e.length;t<s;t++){if(!e[t]||!e[t].id)continue;this.selectedElements[e[t].id]=e[t];if(this.multiple){var i=BX.findChild(BX(this.selectorId+"_selected_elements"),{className:"ies-content-selected-items"});var n=BX.create("div",{props:{className:"ies-content-selected-item",id:this.selectorId+"_element_selected_"+parseInt(e[t].id)},children:[BX.create("div",{props:{id:this.selectorId+"-element-unselect-"+parseInt(e[t].id),className:"ies-content-selected-item-icon"},attrs:{onclick:'BX.Iblock["'+this.jsObject+'"].unselect("'+parseInt(e[t].id)+'");'}}),BX.create("span",{props:{className:"ies-content-selected-item-text"},text:BX.util.htmlspecialchars(e[t].name)})]});i.appendChild(n)}var l=document.getElementsByName(this.selectorId+(this.multiple?"[]":""));for(var c=0;c<l.length;c++){if(l[c].value===e[t].id){if(l[c].parentNode.className==="")continue;BX.toggleClass(l[c].parentNode,"ies-content-item-selected")}}}if(this.multiple){BX.adjust(BX(this.selectorId+"_current_count"),{text:this.getCountElements(e).toString()})}};e.prototype.toObject=function(e){var t={},s;for(s in e){if(e.hasOwnProperty(s)){s=parseInt(s);if(typeof s==="number"&&e[s]!==null){t[s]=BX.clone(e[s])}}}return t};e.prototype.request=function(){var e=(new Date).getTime();this.lastSearchTime=e;this.searchRequest=BX.ajax.loadJSON(this.url,BX.proxy(function(t){if(this.lastSearchTime===e){this.showResult(t)}},this))};e.prototype.showSelector=function(){if(!this.popupWindow){this.popupWindow=new BX.PopupWindow(this.selectorId+"popup-window",BX(this.selectorId+"_select_button"),{offsetTop:1,autoHide:true,content:BX(this.selectorId),zIndex:3e3})}else{this.popupWindow.setBindElement(this)}if(this.popupWindow.popupContainer.style.display!=="block"){this.popupWindow.show()}};e.prototype.setToSelectedValues=function(e){var t="";for(var s=0;s<e.length;s++){var i=e[s];if(i){if(!BX(this.selectorId+"_selected_value_"+i.id)){BX(this.selectorId+"_hidden_values").appendChild(BX.create("input",{props:{id:this.selectorId+"_selected_value_"+parseInt(i.id)},attrs:{type:"hidden",value:parseInt(i.id),name:this.inputName+(this.multiple?"[]":"")}}))}t+=BX.util.htmlspecialchars(i.name);if(!this.multiple&&!this.onlyRead){t+='<span class="ies-content-delete-icon" onclick="BX.Iblock[\''+this.jsObject+"'].unselect('"+parseInt(i.id)+"')\"></span>"}t+="<br>"}}BX(this.selectorId+"_visible_values").innerHTML=t};e.prototype.getCountElements=function(e){var t=0,s;for(s=0;s<e.length;s++){if(BX.type.isNotEmptyObject(e[s]))t++}return t};return e}();
//# sourceMappingURL=script.map.js