this.BX=this.BX||{};this.BX.Sale=this.BX.Sale||{};this.BX.Sale.Checkout=this.BX.Sale.Checkout||{};(function(t,e,n,s,r){"use strict";var i=function(){function t(){babelHelpers.classCallCheck(this,t);this.pool=new r.Pool;this.timer=new r.Timer}babelHelpers.createClass(t,[{key:"setStore",value:function t(e){this.store=e;return this}},{key:"setProvider",value:function t(e){this.provider=e;return this}},{key:"executeRestAnswer",value:function t(e,n,s){return this.provider.execute(e,n,s)}},{key:"getItem",value:function t(e){return this.store.getters["basket/get"](e)}},{key:"getBasket",value:function t(){return this.store.getters["basket/getBasket"]}},{key:"changeItem",value:function t(e){this.store.dispatch("basket/changeItem",{index:e.index,fields:e.fields})}},{key:"setQuantity",value:function t(e,n){var r=this.getItem(e);r.quantity=n;r.baseSum=this.round(r.basePrice*r.quantity);r.sum=this.round(r.price*r.quantity);r.discount.sum=this.round(r.discount.price*r.quantity);this.pool.add(s.Pool.action.quantity,e,{id:r.id,value:r.quantity});this.changeItem({index:e,fields:r});this.shelveCommit()}},{key:"removeItem",value:function t(e){return this.store.dispatch("basket/removeItem",{index:e.index})}},{key:"round",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var s=Math.pow(10,n);return Math.round(e*s)/s}},{key:"handlerOrderSuccess",value:function t(){BX.onCustomEvent("OnBasketChange")}},{key:"handlerRemove",value:function t(e){var n=e.getData().index;var r=this.getItem(n);r.deleted="Y";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action.delete,n,{id:r.id,fields:{value:"Y"}});this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerSuccessRemove",value:function t(e){var n=this;var r=e.getData().index;this.timer.create(5e3,r+"_DELETE",function(){return n.removeItem({index:r}).then(function(){if(n.getBasket().length===0){n.store.dispatch("application/setStage",{stage:s.Application.stage.empty})}})})}},{key:"handlerRestore",value:function t(e){var n=e.getData().index;var r=this.getItem(n);this.timer.clean({index:n+"_DELETE"});r.deleted="N";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action.restore,n,r);this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerQuantityPlus",value:function t(e){var n=e.getData().index;var s=this.getItem(n);var i=s.quantity;var a=s.product.ratio;var u=s.product.availableQuantity;i=i+a;if(u>0&&i>u){i=u}i=r.Basket.toFixed(i,a,u);if(s.quantity<i){this.setQuantity(n,i)}}},{key:"handlerQuantityMinus",value:function t(e){var n=e.getData().index;var s=this.getItem(n);var i=s.quantity;var a=s.product.ratio;var u=s.product.availableQuantity;i=i-a;if(a>0&&i<a){i=a}if(u>0&&i>u){i=u}i=r.Basket.toFixed(i,a,u);if(i>=a){this.setQuantity(n,i)}}},{key:"commit",value:function t(){var n=this;return new Promise(function(t,r){var i={};if(n.pool.isEmpty()===false){i=n.pool.get();n.pool.clean();var a=s.Component.bitrixSaleOrderCheckout;var u=s.RestMethod.saleEntityRecalculateBasket;e.ajax.runComponentAction(a,u,{data:{actions:i},signedParameters:n.store.getters["application/getSignedParameters"]}).then(function(e){return n.executeRestAnswer(u,e,n.pool.get()).then(function(){return n.commit().then(function(){return t()})})}).catch()}else{t()}})}},{key:"shelveCommit",value:function t(){var e=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"BASKET";if(this.getStatus()===s.Loader.status.none){this.timer.create(300,n,function(){e.setStatusWait();e.commit().then(function(){return e.setStatusNone()})})}}},{key:"getStatus",value:function t(){return this.store.getters["basket/getStatus"]}},{key:"setStatusWait",value:function t(){var e={status:s.Loader.status.wait};return this.store.dispatch("basket/setStatus",e)}},{key:"setStatusNone",value:function t(){var e={status:s.Loader.status.none};return this.store.dispatch("basket/setStatus",e)}}]);return t}();var a=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t);this.init(e).then(function(){return n.initProvider()}).then(function(){return n.iniController()}).then(function(){return n.subscribeToEvents()}).then(function(){return n.subscribeToStoreChanges()})}babelHelpers.createClass(t,[{key:"init",value:function t(e){this.store=e.store;this.timer=new r.Timer;return new Promise(function(t,e){return t()})}},{key:"initProvider",value:function t(){this.provider=n.BasketRestHandler.create({store:this.store});return new Promise(function(t,e){return t()})}},{key:"iniController",value:function t(){this.basket=(new i).setStore(this.store).setProvider(this.provider);return new Promise(function(t,e){return t()})}},{key:"executeRestAnswer",value:function t(e,n,s){return this.provider.execute(e,n,s)}},{key:"subscribeToEvents",value:function t(){var n=this;e.Event.EventEmitter.subscribe(s.EventType.order.success,function(t){return n.basket.handlerOrderSuccess(t)});e.Event.EventEmitter.subscribe(s.EventType.basket.buttonRemoveProduct,e.Runtime.debounce(function(t){return n.basket.handlerRemove(t)},500,this));e.Event.EventEmitter.subscribe(s.EventType.basket.buttonPlusProduct,function(t){return n.basket.handlerQuantityPlus(t)});e.Event.EventEmitter.subscribe(s.EventType.basket.buttonMinusProduct,function(t){return n.basket.handlerQuantityMinus(t)});e.Event.EventEmitter.subscribe(s.EventType.basket.buttonRestoreProduct,e.Runtime.debounce(function(t){return n.basket.handlerRestore(t)},500,this));e.Event.EventEmitter.subscribe(s.EventType.consent.refused,function(){return n.handlerConsentRefused()});e.Event.EventEmitter.subscribe(s.EventType.consent.accepted,function(){return n.handlerConsentAccepted()});e.Event.EventEmitter.subscribe(s.EventType.element.buttonCheckout,e.Runtime.debounce(function(){return n.handlerCheckout()},1e3,this));e.Event.EventEmitter.subscribe(s.EventType.element.buttonShipping,e.Runtime.debounce(function(){return n.handlerShipping()},1e3,this));e.Event.EventEmitter.subscribe(s.EventType.paysystem.beforeInitList,function(){return n.paySystemSetStatusWait()});e.Event.EventEmitter.subscribe(s.EventType.paysystem.afterInitList,function(){return n.paySystemSetStatusNone()});return new Promise(function(t,e){return t()})}},{key:"subscribeToStoreChanges",value:function t(){this.store.subscribe(function(t,e){});return new Promise(function(t,e){return t()})}},{key:"paySystemSetStatusWait",value:function t(){var e={status:s.Loader.status.wait};return this.store.dispatch("pay-system/setStatus",e)}},{key:"paySystemSetStatusNone",value:function t(){var e={status:s.Loader.status.none};return this.store.dispatch("pay-system/setStatus",e)}},{key:"appSetStatusWait",value:function t(){var e={status:s.Loader.status.wait};return this.store.dispatch("application/setStatus",e)}},{key:"appSetStatusNone",value:function t(){var e={status:s.Loader.status.none};return this.store.dispatch("application/setStatus",e)}},{key:"handlerConsentAccepted",value:function t(){this.store.dispatch("consent/setStatus",s.Consent.status.accepted)}},{key:"handlerConsentRefused",value:function t(){this.store.dispatch("consent/setStatus",s.Consent.status.refused)}},{key:"handlerCheckout",value:function t(){var e=this;BX.onCustomEvent(s.Consent.validate.submit,[]);var n=this.store.getters["consent/get"];var i=this.store.getters["consent/getStatus"];var a=n.id>0?i===s.Consent.status.accepted:true;if(a){this.appSetStatusWait();this.saveOrder().then(function(){e.appSetStatusNone().then(function(){var t=e.store.getters["order/getOrder"];if(t.id>0){var n=r.History.pushState(e.store.getters["application/getPathLocation"],{accountNumber:t.accountNumber,access:t.hash});e.store.dispatch("application/setPathLocation",n)}})}).catch(function(){return e.appSetStatusNone()})}}},{key:"handlerShipping",value:function t(){this.store.dispatch("application/setStage",{stage:s.Application.stage.view});delete BX.UserConsent}},{key:"saveOrder",value:function t(){var n=this;var r=s.Component.bitrixSaleOrderCheckout;var i=s.RestMethod.saleEntitySaveOrder;return e.ajax.runComponentAction(r,i,{data:{fields:{siteId:this.store.getters["application/getSiteId"],personTypeId:this.store.getters["application/getPersonTypeId"],tradingPlatformId:this.store.getters["application/getTradingPlatformId"],properties:this.preparePropertyFields(this.getPropertyList())}},signedParameters:this.store.getters["application/getSignedParameters"]}).then(function(t){return n.executeRestAnswer(i,t)}).catch(function(t){return n.executeRestAnswer(i,{error:t.errors})})}},{key:"getPropertyList",value:function t(){var e=[];var n=this.store.getters["property/getProperty"];try{for(var s in n){if(!n.hasOwnProperty(s)){continue}e[n[s].id]=n[s]}}catch(t){}return e}},{key:"preparePropertyFields",value:function t(e){var n={};e.forEach(function(t,e){n[e]=t.value});return n}}]);return t}();t.Basket=i;t.Application=a})(this.BX.Sale.Checkout.Controller=this.BX.Sale.Checkout.Controller||{},BX,BX.Sale.Checkout.Provider,BX.Sale.Checkout.Const,BX.Sale.Checkout.Lib);
//# sourceMappingURL=controller.bundle.map.js