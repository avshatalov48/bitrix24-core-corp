this.BX=this.BX||{};this.BX.Sale=this.BX.Sale||{};this.BX.Sale.Checkout=this.BX.Sale.Checkout||{};(function(e,t,n,s,r,a){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.pool=this.getPool();this.timer=this.getTimer();this.running="N"}babelHelpers.createClass(e,[{key:"getPool",value:function e(){return new a.Pool}},{key:"getTimer",value:function e(){return new a.Timer}},{key:"isRunning",value:function e(){return this.running==="Y"}},{key:"setRunningY",value:function e(){this.running="Y"}},{key:"setRunningN",value:function e(){this.running="N"}},{key:"setStore",value:function e(t){this.store=t;return this}},{key:"setProvider",value:function e(t){this.provider=t;return this}},{key:"executeRestAnswer",value:function e(t,n,s){return this.provider.execute(t,n,s)}},{key:"getItem",value:function e(t){return this.store.getters["basket/get"](t)}},{key:"getBasket",value:function e(){return this.store.getters["basket/getBasket"]}},{key:"getBasketCollection",value:function e(){return this.getBasket().filter(function(e){return e.deleted==="N"})}},{key:"changeItem",value:function e(t){this.store.dispatch("basket/changeItem",{index:t.index,fields:t.fields})}},{key:"setQuantity",value:function e(t,n){var s=this.getItem(t);s.quantity=n;s.baseSum=this.round(s.basePrice*s.quantity);s.sum=this.round(s.price*s.quantity);s.discount.sum=this.round(s.discount.price*s.quantity);this.refreshDiscount();this.refreshTotal();this.pool.add(r.Pool.action.quantity,t,{id:s.id,value:s.quantity});this.changeItem({index:t,fields:s});this.shelveCommit()}},{key:"refreshDiscount",value:function e(){var t=this.getBasket();if(t.length>0){this.store.dispatch("basket/setDiscount",{sum:t.reduce(function(e,t){return e+t.discount.sum},0)})}}},{key:"refreshTotal",value:function e(){var t=this.getBasketCollection();if(t.length>0){this.store.dispatch("basket/setTotal",{price:t.reduce(function(e,t){return e+t.sum},0),basePrice:t.reduce(function(e,t){return e+t.baseSum},0)})}}},{key:"removeItem",value:function e(t){return this.store.dispatch("basket/removeItem",{index:t.index})}},{key:"round",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var s=Math.pow(10,n);return Math.round(t*s)/s}},{key:"emitOnBasketChange",value:function e(){BX.onCustomEvent("OnBasketChange")}},{key:"handlerOrderSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemoveProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRestoreProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemove",value:function e(t){var n=t.getData().index;var s=this.getItem(n);s.deleted="Y";s.status=r.Loader.status.wait;this.pool.add(r.Pool.action.delete,n,{id:s.id,fields:{value:"Y"}});this.changeItem({index:n,fields:s});this.shelveCommit()}},{key:"handlerSuccessRemove",value:function e(t){var n=this;var s=t.getData().index;this.timer.create(5e3,s+"_DELETE",function(){return n.removeItem({index:s}).then(function(){if(n.getBasket().length===0){n.store.dispatch("application/setStage",{stage:r.Application.stage.empty})}})})}},{key:"handlerRestore",value:function e(t){var n=t.getData().index;var s=this.getItem(n);this.timer.clean({index:n+"_DELETE"});s.deleted="N";s.status=r.Loader.status.wait;this.pool.add(r.Pool.action.restore,n,{basePrice:s.basePrice,baseSum:s.baseSum,currency:s.currency,discount:s.discount,id:s.id,measureText:s.measureText,module:s.module,name:s.name,price:s.price,product:s.product,productProviderClass:s.productProviderClass,props:s.props,quantity:s.quantity,sum:s.sum});this.changeItem({index:n,fields:s});this.shelveCommit()}},{key:"handlerChangeQuantity",value:function e(t){var n=t.getData().index;var s=this.getItem(n);var r=s.quantity;var i=s.product.ratio;var u=s.product.availableQuantity;r=a.Basket.roundValue(r);i=a.Basket.roundValue(i);r=isNaN(r)?0:r;if(i>0&&r<i){r=i}if(u>0&&r>u){r=u}r=a.Basket.toFixed(r,i,u);if(s.quantity!==r){this.setQuantity(n,r)}}},{key:"handlerQuantityPlus",value:function e(t){var n=t.getData().index;var s=this.getItem(n);var r=s.quantity;var i=s.product.ratio;var u=s.product.availableQuantity;r=a.Basket.roundValue(r);i=a.Basket.roundValue(i);r=r+i;if(a.Basket.isValueFloat(r)){r=a.Basket.roundFloatValue(r)}if(u>0&&r>u){r=u}r=a.Basket.toFixed(r,i,u);if(s.quantity<r){this.setQuantity(n,r)}}},{key:"handlerQuantityMinus",value:function e(t){var n=t.getData().index;var s=this.getItem(n);var r=s.quantity;var i=s.product.ratio;var u=s.product.availableQuantity;r=a.Basket.roundValue(r);i=a.Basket.roundValue(i);var o=r=r-i;if(a.Basket.isValueFloat(r)){r=a.Basket.roundFloatValue(r);o=a.Basket.roundFloatValue(o)}if(i>0&&r<i){r=i}if(u>0&&r>u){r=u}r=a.Basket.toFixed(r,i,u);if(o>=i){this.setQuantity(n,r)}}},{key:"commit",value:function e(){var n=this;return new Promise(function(e,s){var a={};if(n.pool.isEmpty()===false){a=n.pool.get();n.pool.clean();var i=r.Component.bitrixSaleOrderCheckout;var u=r.RestMethod.saleEntityRecalculateBasket;t.ajax.runComponentAction(i,u,{data:{actions:a},signedParameters:n.store.getters["application/getSignedParameters"]}).then(function(t){return n.executeRestAnswer(u,t,n.pool).then(function(){return n.commit().then(function(){return e()})})}).catch()}else{e()}})}},{key:"shelveCommit",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"BASKET";if(this.isRunning()===false){this.timer.create(300,n,function(){t.setRunningY();t.commit().then(function(){return t.setRunningN()})})}}},{key:"getStatus",value:function e(){return this.store.getters["basket/getStatus"]}},{key:"setStatusWait",value:function e(){var t={status:r.Loader.status.wait};return this.store.dispatch("basket/setStatus",t)}},{key:"setStatusNone",value:function e(){var t={status:r.Loader.status.none};return this.store.dispatch("basket/setStatus",t)}},{key:"handlerNeedRefreshY",value:function e(){this.setNeedRefreshY();this.setStatusWait()}},{key:"handlerNeedRefreshN",value:function e(){this.setNeedRefreshN();this.setStatusNone()}},{key:"setNeedRefreshY",value:function e(){var t={needRefresh:"Y"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"setNeedRefreshN",value:function e(){var t={needRefresh:"N"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"handlerChangeSku",value:function e(t){var n=t.getData().data[0].ID;var s=t.getData().index;var a=this.getItem(s);a.status=r.Loader.status.wait;this.pool.add(r.Pool.action.offer,s,{id:a.id,fields:{offerId:n}});this.changeItem({index:s,fields:a});this.shelveCommit()}}]);return e}();var u=function(){function e(t){var n=this;babelHelpers.classCallCheck(this,e);this.init(t).then(function(){return n.initProvider()}).then(function(){return n.iniController()}).then(function(){return n.subscribeToEvents()}).then(function(){return n.subscribeToStoreChanges()})}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.store=t.store;return new Promise(function(e,t){return e()})}},{key:"initProvider",value:function e(){this.provider=s.BasketRestHandler.create({store:this.store});return new Promise(function(e,t){return e()})}},{key:"iniController",value:function e(){this.basket=(new i).setStore(this.store).setProvider(this.provider);return new Promise(function(e,t){return e()})}},{key:"executeRestAnswer",value:function e(t,n,s){return this.provider.execute(t,n,s)}},{key:"subscribeToEvents",value:function e(){var s=this;n.EventEmitter.subscribe(r.EventType.order.success,function(e){return s.basket.handlerOrderSuccess(e)});n.EventEmitter.subscribe(r.EventType.basket.removeProduct,function(e){return s.basket.handlerRemoveProductSuccess(e)});n.EventEmitter.subscribe(r.EventType.basket.restoreProduct,function(e){return s.basket.handlerRestoreProductSuccess(e)});n.EventEmitter.subscribe(r.EventType.basket.buttonRemoveProduct,t.Runtime.debounce(function(e){return s.basket.handlerRemove(e)},500,this));n.EventEmitter.subscribe(r.EventType.basket.buttonPlusProduct,function(e){return s.basket.handlerQuantityPlus(e)});n.EventEmitter.subscribe(r.EventType.basket.buttonMinusProduct,function(e){return s.basket.handlerQuantityMinus(e)});n.EventEmitter.subscribe(r.EventType.basket.inputChangeQuantityProduct,function(e){return s.basket.handlerChangeQuantity(e)});n.EventEmitter.subscribe(r.EventType.basket.buttonRestoreProduct,t.Runtime.debounce(function(e){return s.basket.handlerRestore(e)},500,this));n.EventEmitter.subscribe(r.EventType.basket.needRefresh,function(e){return s.basket.handlerNeedRefreshY(e)});n.EventEmitter.subscribe(r.EventType.basket.refreshAfter,function(e){return s.basket.handlerNeedRefreshN(e)});n.EventEmitter.subscribe(r.EventType.basket.changeSku,function(e){return s.basket.handlerChangeSku(e)});n.EventEmitter.subscribe(r.EventType.consent.refused,function(){return s.handlerConsentRefused()});n.EventEmitter.subscribe(r.EventType.consent.accepted,function(){return s.handlerConsentAccepted()});n.EventEmitter.subscribe(r.EventType.element.buttonCheckout,t.Runtime.debounce(function(){return s.handlerCheckout()},1e3,this));n.EventEmitter.subscribe(r.EventType.element.buttonShipping,t.Runtime.debounce(function(){return s.handlerShipping()},1e3,this));n.EventEmitter.subscribe(r.EventType.paysystem.beforeInitList,function(){return s.paySystemSetStatusWait()});n.EventEmitter.subscribe(r.EventType.paysystem.afterInitList,function(){return s.paySystemSetStatusNone()})}},{key:"subscribeToStoreChanges",value:function e(){return new Promise(function(e,t){return e()})}},{key:"paySystemSetStatusWait",value:function e(){var t={status:r.Loader.status.wait};return this.store.dispatch("pay-system/setStatus",t)}},{key:"paySystemSetStatusNone",value:function e(){var t={status:r.Loader.status.none};return this.store.dispatch("pay-system/setStatus",t)}},{key:"appSetStatusWait",value:function e(){var t={status:r.Loader.status.wait};return this.store.dispatch("application/setStatus",t)}},{key:"appSetStatusNone",value:function e(){var t={status:r.Loader.status.none};return this.store.dispatch("application/setStatus",t)}},{key:"handlerConsentAccepted",value:function e(){this.store.dispatch("consent/setStatus",r.Consent.status.accepted)}},{key:"handlerConsentRefused",value:function e(){this.store.dispatch("consent/setStatus",r.Consent.status.refused)}},{key:"handlerCheckout",value:function e(){var t=this;BX.onCustomEvent(r.Consent.validate.submit,[]);var n=this.store.getters["consent/get"];var s=this.store.getters["consent/getStatus"];var i=n.id>0?s===r.Consent.status.accepted:true;if(i){this.appSetStatusWait();this.saveOrder().then(function(){t.appSetStatusNone().then(function(){var e=t.store.getters["order/getOrder"];if(e.id>0){var n=a.History.pushState(t.store.getters["application/getPathLocation"],{accountNumber:e.accountNumber,access:e.hash});t.store.dispatch("application/setPathLocation",n)}})}).catch(function(){return t.appSetStatusNone()})}}},{key:"handlerShipping",value:function e(){this.store.dispatch("application/setStage",{stage:r.Application.stage.view});delete BX.UserConsent;var n=this.store.getters["order/getOrder"];if(n.id>0){var s=r.Component.bitrixSaleOrderCheckout;var a=r.RestMethod.saleEntityPaymentPay;return t.ajax.runComponentAction(s,a,{data:{fields:{orderId:n.id,accessCode:n.hash}},signedParameters:this.store.getters["application/getSignedParameters"]})}}},{key:"saveOrder",value:function e(){var n=this;var s=r.Component.bitrixSaleOrderCheckout;var a=r.RestMethod.saleEntitySaveOrder;return t.ajax.runComponentAction(s,a,{data:{fields:{siteId:this.store.getters["application/getSiteId"],personTypeId:this.store.getters["application/getPersonTypeId"],tradingPlatformId:this.store.getters["application/getTradingPlatformId"],properties:this.preparePropertyFields(this.getPropertyList())}},signedParameters:this.store.getters["application/getSignedParameters"]}).then(function(e){return n.executeRestAnswer(a,e)}).catch(function(e){return n.executeRestAnswer(a,{error:e.errors})})}},{key:"getPropertyList",value:function e(){var t=[];var n=this.store.getters["property/getProperty"];try{for(var s in n){if(!n.hasOwnProperty(s)){continue}t[n[s].id]=n[s]}}catch(e){}return t}},{key:"preparePropertyFields",value:function e(t){var n={};t.forEach(function(e,t){n[t]=e.value});return n}}]);return e}();e.Basket=i;e.Application=u})(this.BX.Sale.Checkout.Controller=this.BX.Sale.Checkout.Controller||{},BX,BX.Event,BX.Sale.Checkout.Provider,BX.Sale.Checkout.Const,BX.Sale.Checkout.Lib);
//# sourceMappingURL=controller.bundle.map.js