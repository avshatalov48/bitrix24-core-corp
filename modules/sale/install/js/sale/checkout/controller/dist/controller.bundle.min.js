this.BX=this.BX||{};this.BX.Sale=this.BX.Sale||{};this.BX.Sale.Checkout=this.BX.Sale.Checkout||{};(function(e,t,n,r,s,i){"use strict";var a=function(){function e(){babelHelpers.classCallCheck(this,e);this.pool=this.getPool();this.timer=this.getTimer();this.running="N"}babelHelpers.createClass(e,[{key:"getPool",value:function e(){return new i.Pool}},{key:"getTimer",value:function e(){return new i.Timer}},{key:"isRunning",value:function e(){return this.running==="Y"}},{key:"setRunningY",value:function e(){this.running="Y"}},{key:"setRunningN",value:function e(){this.running="N"}},{key:"setStore",value:function e(t){this.store=t;return this}},{key:"setProvider",value:function e(t){this.provider=t;return this}},{key:"executeRestAnswer",value:function e(t,n,r){return this.provider.execute(t,n,r)}},{key:"getItem",value:function e(t){return this.store.getters["basket/get"](t)}},{key:"getBasket",value:function e(){return this.store.getters["basket/getBasket"]}},{key:"getBasketCollection",value:function e(){return this.getBasket().filter((function(e){return e.deleted==="N"}))}},{key:"changeItem",value:function e(t){this.store.dispatch("basket/changeItem",{index:t.index,fields:t.fields})}},{key:"setQuantity",value:function e(t,n){var r=this.getItem(t);r.quantity=n;r.baseSum=this.round(r.basePrice*r.quantity);r.sum=this.round(r.price*r.quantity);r.discount.sum=this.round(r.discount.price*r.quantity);this.refreshDiscount();this.refreshTotal();this.pool.add(s.Pool.action.quantity,t,{id:r.id,value:r.quantity});this.changeItem({index:t,fields:r});this.shelveCommit()}},{key:"refreshDiscount",value:function e(){var t=this.getBasket();if(t.length>0){this.store.dispatch("basket/setDiscount",{sum:t.reduce((function(e,t){return e+t.discount.sum}),0)})}}},{key:"refreshTotal",value:function e(){var t=this.getBasketCollection();if(t.length>0){this.store.dispatch("basket/setTotal",{price:t.reduce((function(e,t){return e+t.sum}),0),basePrice:t.reduce((function(e,t){return e+t.baseSum}),0)})}}},{key:"removeItem",value:function e(t){return this.store.dispatch("basket/removeItem",{index:t.index})}},{key:"round",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var r=Math.pow(10,n);return Math.round(t*r)/r}},{key:"emitOnBasketChange",value:function e(){BX.onCustomEvent("OnBasketChange")}},{key:"handlerOrderSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemoveProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRestoreProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemove",value:function e(t){var n=t.getData().index;var r=this.getItem(n);r.deleted="Y";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action["delete"],n,{id:r.id,fields:{value:"Y"}});this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerSuccessRemove",value:function e(t){var n=this;var r=t.getData().index;this.timer.create(5e3,r+"_DELETE",(function(){return n.removeItem({index:r}).then((function(){if(n.getBasket().length===0){n.store.dispatch("application/setStage",{stage:s.Application.stage.empty})}}))}))}},{key:"handlerRestore",value:function e(t){var n=t.getData().index;var r=this.getItem(n);this.timer.clean({index:n+"_DELETE"});r.deleted="N";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action.restore,n,{basePrice:r.basePrice,baseSum:r.baseSum,currency:r.currency,discount:r.discount,id:r.id,measureText:r.measureText,module:r.module,name:r.name,price:r.price,product:r.product,productProviderClass:r.productProviderClass,props:r.props,quantity:r.quantity,sum:r.sum});this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerChangeQuantity",value:function e(t){var n=t.getData().index;var r=this.getItem(n);var s=r.quantity;var a=r.product.ratio;var u=r.product.availableQuantity;s=i.Basket.roundValue(s);a=i.Basket.roundValue(a);s=isNaN(s)?0:s;if(a>0&&s<a){s=a}if(i.Product.isService(r));else{if(i.Product.isLimitedQuantity(r)){if(u>0&&s>u){s=u}}}s=i.Basket.toFixed(s,a,u);if(r.quantity!==s){this.setQuantity(n,s)}}},{key:"handlerQuantityPlus",value:function e(t){var n=t.getData().index;var r=this.getItem(n);var s=r.quantity;var a=r.product.ratio;var u=r.product.availableQuantity;s=i.Basket.roundValue(s);a=i.Basket.roundValue(a);s=s+a;if(i.Basket.isValueFloat(s)){s=i.Basket.roundFloatValue(s)}if(i.Product.isService(r));else{if(i.Product.isLimitedQuantity(r)){if(u>0&&s>u){s=u}}}s=i.Basket.toFixed(s,a,u);if(r.quantity<s){this.setQuantity(n,s)}}},{key:"handlerQuantityMinus",value:function e(t){var n=t.getData().index;var r=this.getItem(n);var s=r.quantity;var a=r.product.ratio;var u=r.product.availableQuantity;s=i.Basket.roundValue(s);a=i.Basket.roundValue(a);var o=s=s-a;if(i.Basket.isValueFloat(s)){s=i.Basket.roundFloatValue(s);o=i.Basket.roundFloatValue(o)}if(a>0&&s<a){s=a}if(i.Product.isService(r));else{if(i.Product.isLimitedQuantity(r)){if(u>0&&s>u){s=u}}}s=i.Basket.toFixed(s,a,u);if(o>=a){this.setQuantity(n,s)}}},{key:"commit",value:function e(){var n=this;return new Promise((function(e,r){var i={};if(n.pool.isEmpty()===false){i=n.pool.get();n.pool.clean();var a=s.Component.bitrixSaleOrderCheckout;var u=s.RestMethod.saleEntityRecalculateBasket;t.ajax.runComponentAction(a,u,{data:{actions:i},signedParameters:n.store.getters["application/getSignedParameters"]}).then((function(t){return n.executeRestAnswer(u,t,n.pool).then((function(){return n.commit().then((function(){return e()}))}))}))["catch"]()}else{e()}}))}},{key:"shelveCommit",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"BASKET";if(this.isRunning()===false){this.timer.create(300,n,(function(){t.setRunningY();t.commit().then((function(){return t.setRunningN()}))}))}}},{key:"getStatus",value:function e(){return this.store.getters["basket/getStatus"]}},{key:"setStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("basket/setStatus",t)}},{key:"setStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("basket/setStatus",t)}},{key:"handlerNeedRefreshY",value:function e(){this.setNeedRefreshY();this.setStatusWait()}},{key:"handlerNeedRefreshN",value:function e(){this.setNeedRefreshN();this.setStatusNone()}},{key:"setNeedRefreshY",value:function e(){var t={needRefresh:"Y"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"setNeedRefreshN",value:function e(){var t={needRefresh:"N"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"handlerChangeSku",value:function e(t){var n=t.getData().data[0].ID;var r=t.getData().index;var i=this.getItem(r);i.status=s.Loader.status.wait;this.pool.add(s.Pool.action.offer,r,{id:i.id,fields:{offerId:n}});this.changeItem({index:r,fields:i});this.shelveCommit()}}]);return e}();var u=function(){function e(t){var n=this;babelHelpers.classCallCheck(this,e);this.init(t).then((function(){return n.initProvider()})).then((function(){return n.iniController()})).then((function(){return n.subscribeToEvents()})).then((function(){return n.subscribeToStoreChanges()}))}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.store=t.store;return new Promise((function(e,t){return e()}))}},{key:"initProvider",value:function e(){this.provider=r.BasketRestHandler.create({store:this.store});return new Promise((function(e,t){return e()}))}},{key:"iniController",value:function e(){this.basket=(new a).setStore(this.store).setProvider(this.provider);return new Promise((function(e,t){return e()}))}},{key:"executeRestAnswer",value:function e(t,n,r){return this.provider.execute(t,n,r)}},{key:"subscribeToEvents",value:function e(){var r=this;n.EventEmitter.subscribe(s.EventType.order.success,(function(e){return r.basket.handlerOrderSuccess(e)}));n.EventEmitter.subscribe(s.EventType.basket.removeProduct,(function(e){return r.basket.handlerRemoveProductSuccess(e)}));n.EventEmitter.subscribe(s.EventType.basket.restoreProduct,(function(e){return r.basket.handlerRestoreProductSuccess(e)}));n.EventEmitter.subscribe(s.EventType.basket.buttonRemoveProduct,t.Runtime.debounce((function(e){return r.basket.handlerRemove(e)}),500,this));n.EventEmitter.subscribe(s.EventType.basket.buttonPlusProduct,(function(e){return r.basket.handlerQuantityPlus(e)}));n.EventEmitter.subscribe(s.EventType.basket.buttonMinusProduct,(function(e){return r.basket.handlerQuantityMinus(e)}));n.EventEmitter.subscribe(s.EventType.basket.inputChangeQuantityProduct,(function(e){return r.basket.handlerChangeQuantity(e)}));n.EventEmitter.subscribe(s.EventType.basket.buttonRestoreProduct,t.Runtime.debounce((function(e){return r.basket.handlerRestore(e)}),500,this));n.EventEmitter.subscribe(s.EventType.basket.needRefresh,(function(e){return r.basket.handlerNeedRefreshY(e)}));n.EventEmitter.subscribe(s.EventType.basket.refreshAfter,(function(e){return r.basket.handlerNeedRefreshN(e)}));n.EventEmitter.subscribe(s.EventType.basket.changeSku,(function(e){return r.basket.handlerChangeSku(e)}));n.EventEmitter.subscribe(s.EventType.consent.refused,(function(){return r.handlerConsentRefused()}));n.EventEmitter.subscribe(s.EventType.consent.accepted,(function(){return r.handlerConsentAccepted()}));n.EventEmitter.subscribe(s.EventType.property.validate,(function(e){return r.handlerValidateProperty(e)}));n.EventEmitter.subscribe(s.EventType.element.buttonCheckout,t.Runtime.debounce((function(){return r.handlerCheckout()}),1e3,this));n.EventEmitter.subscribe(s.EventType.element.buttonShipping,t.Runtime.debounce((function(){return r.handlerShipping()}),1e3,this));n.EventEmitter.subscribe(s.EventType.paysystem.beforeInitList,(function(){return r.paySystemSetStatusWait()}));n.EventEmitter.subscribe(s.EventType.paysystem.afterInitList,(function(){return r.paySystemSetStatusNone()}))}},{key:"subscribeToStoreChanges",value:function e(){return new Promise((function(e,t){return e()}))}},{key:"paySystemSetStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("pay-system/setStatus",t)}},{key:"paySystemSetStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("pay-system/setStatus",t)}},{key:"appSetStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("application/setStatus",t)}},{key:"appSetStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("application/setStatus",t)}},{key:"handlerConsentAccepted",value:function e(){this.store.dispatch("consent/setStatus",s.Consent.status.accepted)}},{key:"handlerConsentRefused",value:function e(){this.store.dispatch("consent/setStatus",s.Consent.status.refused)}},{key:"handlerCheckout",value:function e(){var t=this;BX.onCustomEvent(s.Consent.validate.submit,[]);var n=this.store.getters["consent/get"];var r=this.store.getters["consent/getStatus"];var a=n.id>0?r===s.Consent.status.accepted:true;if(a){this.appSetStatusWait();this.saveOrder().then((function(){t.appSetStatusNone().then((function(){var e=t.store.getters["order/getOrder"];if(e.id>0){var n=i.History.pushState(t.store.getters["application/getPathLocation"],{accountNumber:e.accountNumber,access:e.hash});t.store.dispatch("application/setPathLocation",n)}}))}))["catch"]((function(){return t.appSetStatusNone()}))}}},{key:"handlerShipping",value:function e(){this.store.dispatch("application/setStage",{stage:s.Application.stage.view});delete BX.UserConsent;var n=this.store.getters["order/getOrder"];if(n.id>0){var r=s.Component.bitrixSaleOrderCheckout;var i=s.RestMethod.saleEntityPaymentPay;return t.ajax.runComponentAction(r,i,{data:{fields:{orderId:n.id,accessCode:n.hash}},signedParameters:this.store.getters["application/getSignedParameters"]})}}},{key:"saveOrder",value:function e(){var n=this;var r=s.Component.bitrixSaleOrderCheckout;var i=s.RestMethod.saleEntitySaveOrder;return t.ajax.runComponentAction(r,i,{data:{fields:{siteId:this.store.getters["application/getSiteId"],personTypeId:this.store.getters["application/getPersonTypeId"],tradingPlatformId:this.store.getters["application/getTradingPlatformId"],properties:this.preparePropertyFields(this.getPropertyList())}},signedParameters:this.store.getters["application/getSignedParameters"]}).then((function(e){return n.executeRestAnswer(i,e)}))["catch"]((function(e){return n.executeRestAnswer(i,{error:e.errors})}))}},{key:"handlerValidateProperty",value:function e(t){var n={};n.index=t.getData().index;n.fields=this.getPropertyItem(n.index);this.changeValidatedProperty(n)}},{key:"getPropertyItem",value:function e(t){return this.store.getters["property/get"](t)}},{key:"changeValidatedProperty",value:function e(t){var n=t.fields;var r=this.store.getters["property/getErrors"];if(this.propertyDataValidate(n)){r=this.deletePropertyError(n,r)}else{r=this.addPropertyError(n,r)}this.provider.setModelPropertyError(r)}},{key:"propertyDataValidate",value:function e(t){return!(t.required==="Y"&&t.value==="")}},{key:"deletePropertyError",value:function e(t,n){for(var r in n){if(n[r]["propertyId"]===t.id){n.splice(r,1)}}return n}},{key:"addPropertyError",value:function e(t,n){var r=n.map((function(e){return e.propertyId}));if(!r.includes(t.id)){n.push({propertyId:t.id})}return n}},{key:"getPropertyList",value:function e(){var t=[];var n=this.store.getters["property/getProperty"];try{for(var r in n){if(!n.hasOwnProperty(r)){continue}t[n[r].id]=n[r]}}catch(e){}return t}},{key:"preparePropertyFields",value:function e(t){var n={};t.forEach((function(e,t){n[t]=e.value}));return n}}]);return e}();e.Basket=a;e.Application=u})(this.BX.Sale.Checkout.Controller=this.BX.Sale.Checkout.Controller||{},BX,BX.Event,BX.Sale.Checkout.Provider,BX.Sale.Checkout.Const,BX.Sale.Checkout.Lib);
//# sourceMappingURL=controller.bundle.map.js