this.BX=this.BX||{};this.BX.Sale=this.BX.Sale||{};this.BX.Sale.Checkout=this.BX.Sale.Checkout||{};(function(e,t,n,s,r){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.pool=new r.Pool;this.timer=new r.Timer;this.running="N"}babelHelpers.createClass(e,[{key:"isRunning",value:function e(){return this.running==="Y"}},{key:"setRunningY",value:function e(){this.running="Y"}},{key:"setRunningN",value:function e(){this.running="N"}},{key:"setStore",value:function e(t){this.store=t;return this}},{key:"setProvider",value:function e(t){this.provider=t;return this}},{key:"executeRestAnswer",value:function e(t,n,s){return this.provider.execute(t,n,s)}},{key:"getItem",value:function e(t){return this.store.getters["basket/get"](t)}},{key:"getBasket",value:function e(){return this.store.getters["basket/getBasket"]}},{key:"changeItem",value:function e(t){this.store.dispatch("basket/changeItem",{index:t.index,fields:t.fields})}},{key:"setQuantity",value:function e(t,n){var r=this.getItem(t);r.quantity=n;r.baseSum=this.round(r.basePrice*r.quantity);r.sum=this.round(r.price*r.quantity);r.discount.sum=this.round(r.discount.price*r.quantity);this.pool.add(s.Pool.action.quantity,t,{id:r.id,value:r.quantity});this.changeItem({index:t,fields:r});this.shelveCommit()}},{key:"removeItem",value:function e(t){return this.store.dispatch("basket/removeItem",{index:t.index})}},{key:"round",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var s=Math.pow(10,n);return Math.round(t*s)/s}},{key:"handlerOrderSuccess",value:function e(){BX.onCustomEvent("OnBasketChange")}},{key:"handlerRemove",value:function e(t){var n=t.getData().index;var r=this.getItem(n);r.deleted="Y";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action.delete,n,{id:r.id,fields:{value:"Y"}});this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerSuccessRemove",value:function e(t){var n=this;var r=t.getData().index;this.timer.create(5e3,r+"_DELETE",function(){return n.removeItem({index:r}).then(function(){if(n.getBasket().length===0){n.store.dispatch("application/setStage",{stage:s.Application.stage.empty})}})})}},{key:"handlerRestore",value:function e(t){var n=t.getData().index;var r=this.getItem(n);this.timer.clean({index:n+"_DELETE"});r.deleted="N";r.status=s.Loader.status.wait;this.pool.add(s.Pool.action.restore,n,r);this.changeItem({index:n,fields:r});this.shelveCommit()}},{key:"handlerQuantityPlus",value:function e(t){var n=t.getData().index;var s=this.getItem(n);var i=s.quantity;var a=s.product.ratio;var u=s.product.availableQuantity;i=i+a;if(u>0&&i>u){i=u}i=r.Basket.toFixed(i,a,u);if(s.quantity<i){this.setQuantity(n,i)}}},{key:"handlerQuantityMinus",value:function e(t){var n=t.getData().index;var s=this.getItem(n);var i=s.quantity;var a=s.product.ratio;var u=s.product.availableQuantity;i=i-a;if(a>0&&i<a){i=a}if(u>0&&i>u){i=u}i=r.Basket.toFixed(i,a,u);if(i>=a){this.setQuantity(n,i)}}},{key:"commit",value:function e(){var n=this;return new Promise(function(e,r){var i={};if(n.pool.isEmpty()===false){i=n.pool.get();n.pool.clean();var a=s.Component.bitrixSaleOrderCheckout;var u=s.RestMethod.saleEntityRecalculateBasket;t.ajax.runComponentAction(a,u,{data:{actions:i},signedParameters:n.store.getters["application/getSignedParameters"]}).then(function(t){return n.executeRestAnswer(u,t,n.pool).then(function(){return n.commit().then(function(){return e()})})}).catch()}else{e()}})}},{key:"shelveCommit",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"BASKET";if(this.isRunning()===false){this.timer.create(300,n,function(){t.setRunningY();t.commit().then(function(){return t.setRunningN()})})}}},{key:"getStatus",value:function e(){return this.store.getters["basket/getStatus"]}},{key:"setStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("basket/setStatus",t)}},{key:"setStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("basket/setStatus",t)}},{key:"handlerNeedRefreshY",value:function e(){this.setNeedRefreshY();this.setStatusWait()}},{key:"handlerNeedRefreshN",value:function e(){this.setNeedRefreshN();this.setStatusNone()}},{key:"setNeedRefreshY",value:function e(){var t={needRefresh:"Y"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"setNeedRefreshN",value:function e(){var t={needRefresh:"N"};return this.store.dispatch("basket/setNeedRefresh",t)}}]);return e}();var a=function(){function e(t){var n=this;babelHelpers.classCallCheck(this,e);this.init(t).then(function(){return n.initProvider()}).then(function(){return n.iniController()}).then(function(){return n.subscribeToEvents()}).then(function(){return n.subscribeToStoreChanges()})}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.store=t.store;this.timer=new r.Timer;return new Promise(function(e,t){return e()})}},{key:"initProvider",value:function e(){this.provider=n.BasketRestHandler.create({store:this.store});return new Promise(function(e,t){return e()})}},{key:"iniController",value:function e(){this.basket=(new i).setStore(this.store).setProvider(this.provider);return new Promise(function(e,t){return e()})}},{key:"executeRestAnswer",value:function e(t,n,s){return this.provider.execute(t,n,s)}},{key:"subscribeToEvents",value:function e(){var n=this;t.Event.EventEmitter.subscribe(s.EventType.order.success,function(e){return n.basket.handlerOrderSuccess(e)});t.Event.EventEmitter.subscribe(s.EventType.basket.buttonRemoveProduct,t.Runtime.debounce(function(e){return n.basket.handlerRemove(e)},500,this));t.Event.EventEmitter.subscribe(s.EventType.basket.buttonPlusProduct,function(e){return n.basket.handlerQuantityPlus(e)});t.Event.EventEmitter.subscribe(s.EventType.basket.buttonMinusProduct,function(e){return n.basket.handlerQuantityMinus(e)});t.Event.EventEmitter.subscribe(s.EventType.basket.buttonRestoreProduct,t.Runtime.debounce(function(e){return n.basket.handlerRestore(e)},500,this));t.Event.EventEmitter.subscribe(s.EventType.basket.needRefresh,function(e){return n.basket.handlerNeedRefreshY(e)});t.Event.EventEmitter.subscribe(s.EventType.basket.refreshAfter,function(e){return n.basket.handlerNeedRefreshN(e)});t.Event.EventEmitter.subscribe(s.EventType.consent.refused,function(){return n.handlerConsentRefused()});t.Event.EventEmitter.subscribe(s.EventType.consent.accepted,function(){return n.handlerConsentAccepted()});t.Event.EventEmitter.subscribe(s.EventType.element.buttonCheckout,t.Runtime.debounce(function(){return n.handlerCheckout()},1e3,this));t.Event.EventEmitter.subscribe(s.EventType.element.buttonShipping,t.Runtime.debounce(function(){return n.handlerShipping()},1e3,this));t.Event.EventEmitter.subscribe(s.EventType.paysystem.beforeInitList,function(){return n.paySystemSetStatusWait()});t.Event.EventEmitter.subscribe(s.EventType.paysystem.afterInitList,function(){return n.paySystemSetStatusNone()});return new Promise(function(e,t){return e()})}},{key:"subscribeToStoreChanges",value:function e(){return new Promise(function(e,t){return e()})}},{key:"paySystemSetStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("pay-system/setStatus",t)}},{key:"paySystemSetStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("pay-system/setStatus",t)}},{key:"appSetStatusWait",value:function e(){var t={status:s.Loader.status.wait};return this.store.dispatch("application/setStatus",t)}},{key:"appSetStatusNone",value:function e(){var t={status:s.Loader.status.none};return this.store.dispatch("application/setStatus",t)}},{key:"handlerConsentAccepted",value:function e(){this.store.dispatch("consent/setStatus",s.Consent.status.accepted)}},{key:"handlerConsentRefused",value:function e(){this.store.dispatch("consent/setStatus",s.Consent.status.refused)}},{key:"handlerCheckout",value:function e(){var t=this;BX.onCustomEvent(s.Consent.validate.submit,[]);var n=this.store.getters["consent/get"];var i=this.store.getters["consent/getStatus"];var a=n.id>0?i===s.Consent.status.accepted:true;if(a){this.appSetStatusWait();this.saveOrder().then(function(){t.appSetStatusNone().then(function(){var e=t.store.getters["order/getOrder"];if(e.id>0){var n=r.History.pushState(t.store.getters["application/getPathLocation"],{accountNumber:e.accountNumber,access:e.hash});t.store.dispatch("application/setPathLocation",n)}})}).catch(function(){return t.appSetStatusNone()})}}},{key:"handlerShipping",value:function e(){this.store.dispatch("application/setStage",{stage:s.Application.stage.view});delete BX.UserConsent}},{key:"saveOrder",value:function e(){var n=this;var r=s.Component.bitrixSaleOrderCheckout;var i=s.RestMethod.saleEntitySaveOrder;return t.ajax.runComponentAction(r,i,{data:{fields:{siteId:this.store.getters["application/getSiteId"],personTypeId:this.store.getters["application/getPersonTypeId"],tradingPlatformId:this.store.getters["application/getTradingPlatformId"],properties:this.preparePropertyFields(this.getPropertyList())}},signedParameters:this.store.getters["application/getSignedParameters"]}).then(function(e){return n.executeRestAnswer(i,e)}).catch(function(e){return n.executeRestAnswer(i,{error:e.errors})})}},{key:"getPropertyList",value:function e(){var t=[];var n=this.store.getters["property/getProperty"];try{for(var s in n){if(!n.hasOwnProperty(s)){continue}t[n[s].id]=n[s]}}catch(e){}return t}},{key:"preparePropertyFields",value:function e(t){var n={};t.forEach(function(e,t){n[t]=e.value});return n}}]);return e}();e.Basket=i;e.Application=a})(this.BX.Sale.Checkout.Controller=this.BX.Sale.Checkout.Controller||{},BX,BX.Sale.Checkout.Provider,BX.Sale.Checkout.Const,BX.Sale.Checkout.Lib);
//# sourceMappingURL=controller.bundle.map.js