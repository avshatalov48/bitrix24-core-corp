{"version":3,"file":"controller.bundle.js","sources":["../src/form-helper.js","../src/controller.js"],"sourcesContent":["export class FormHelper\n{\n\t/**\n\t * @private\n\t * @param {HTMLFormElement|null} form\n\t */\n\tconstructor(form) {\n\t\tthis.form = form || null;\n\t}\n\n\t/**\n\t * @public\n\t * @param {string} html\n\t * @returns {FormHelper}\n\t */\n\tstatic createFromHtml(html) {\n\t\tconst tempNode = document.createElement('div');\n\t\ttempNode.innerHTML = html;\n\t\ttempNode.style.display = 'none';\n\n\t\tconst form = tempNode.querySelector('form');\n\t\treturn new FormHelper(form);\n\t}\n\n\t/**\n\t * @public\n\t * @param {HTMLElement} node\n\t * @returns {FormHelper}\n\t */\n\tstatic createFromNode(node) {\n\t\tif (node instanceof HTMLFormElement) {\n\t\t\treturn new FormHelper(node);\n\t\t}\n\t\tconst form = node.querySelector('form');\n\t\treturn new FormHelper(form);\n\t}\n\n\t/**\n\t * @public\n\t * @returns {void}\n\t */\n\tsubmit() {\n\t\tif (!this.canSubmit()) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isVirtual()) {\n\t\t\tdocument.body.appendChild(this.form.parentNode);\n\t\t}\n\n\t\tHTMLFormElement.prototype.submit.call(this.form);\n\t}\n\n\t/**\n\t * @public\n\t * @returns {boolean}\n\t */\n\tcanSubmit() {\n\t\treturn this.isValidFormObject() && this.containsAllowedInputTypesOnly();\n\t}\n\n\t/**\n\t * @private\n\t * @returns {boolean}\n\t */\n\tisValidFormObject() {\n\t\treturn this.form instanceof HTMLFormElement;\n\t}\n\n\t/**\n\t * @private\n\t * @returns {boolean}\n\t */\n\tcontainsAllowedInputTypesOnly() {\n\t\tif (!this.form || !this.form.elements) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// eslint-disable-next-line no-plusplus\n\t\tfor (let i = 0; i < this.form.elements.length; i++) {\n\t\t\tif (!FormHelper.elementAllowed(this.form.elements[i])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @private\n\t * @param element\n\t * @returns {boolean}\n\t */\n\tstatic elementAllowed(element) {\n\t\tconst allowedTypes = FormHelper.getAllowedInputTypes();\n\t\tif (element instanceof HTMLInputElement) {\n\t\t\treturn allowedTypes.indexOf(element.type) !== -1;\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * @private\n\t * @returns {string[]}\n\t */\n\tstatic getAllowedInputTypes() {\n\t\treturn ['hidden', 'submit'];\n\t}\n\n\t/**\n\t * @public\n\t * @returns {boolean}\n\t */\n\tisVirtual() {\n\t\tif (this.form) {\n\t\t\treturn !document.body.contains(this.form);\n\t\t}\n\t\treturn true;\n\t}\n}","import {EventEmitter} from 'main.core.events';\nimport {EventType, Api} from 'sale.payment-pay.const';\nimport {FormHelper} from './form-helper';\n\nexport class Controller\n{\n\tconstructor(options)\n\t{\n\t\tthis.options = options || {};\n\t\tthis.url = this.option('url', this.getDefaultAjaxController());\n\t\tthis.allowPaymentRedirect = this.option('allowPaymentRedirect', true);\n\t\tthis.returnUrl = this.option('returnUrl', this.getCurrentUrl());\n\t\tthis.orderId = this.option('orderId', null);\n\t\tthis.paymentId = this.option('paymentId', null);\n\t\tthis.accessCode = this.option('accessCode', null);\n\t\tthis.response = null;\n\t}\n\n\t/**\n\t * @public\n\t * @param {object} params\n\t * @returns {Error|void}\n\t */\n\tinitPayment(params)\n\t{\n\t\tif (!params.paySystemId)\n\t\t{\n\t\t\tthrow new Error('Payment system undefined');\n\t\t}\n\n\t\tBX.ajax({\n\t\t\tmethod: 'POST',\n\t\t\tdataType: 'json',\n\t\t\turl: this.url,\n\t\t\tdata: {\n\t\t\t\tsessid: BX.bitrix_sessid(),\n\t\t\t\tpaysystemId: params.paySystemId,\n\t\t\t\treturnUrl: this.returnUrl,\n\t\t\t\torderId: this.orderId,\n\t\t\t\tpaymentId: this.paymentId,\n\t\t\t\taccess: this.accessCode,\n\t\t\t},\n\t\t\tonsuccess: (response) => {\n\t\t\t\tthis.response = response;\n\t\t\t\tthis.handleResponse();\n\t\t\t},\n\t\t});\n\t}\n\n\t/**\n\t * @private\n\t */\n\thandleResponse()\n\t{\n\t\tif (this.isResponseSucceed()) {\n\t\t\tthis.tryToRedirectUserOnPaymentGate();\n\t\t\tEventEmitter.emit(EventType.payment.success, this.response);\n\t\t} else {\n\t\t\tEventEmitter.emit(EventType.payment.error, this.response);\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t * @returns {boolean}\n\t */\n\tisResponseSucceed()\n\t{\n\t\treturn BX.type.isObject(this.response) && this.response.status === 'success';\n\t}\n\n\t/**\n\t * @private\n\t */\n\ttryToRedirectUserOnPaymentGate()\n\t{\n\t\tconst url = BX.type.isString(this.response.url) ? this.response.url : '';\n\t\tconst html = BX.type.isString(this.response.html) ? this.response.html : '';\n\n\t\tif (this.allowPaymentRedirect) {\n\t\t\tif (url.length > 0) {\n\t\t\t\twindow.location.href = url;\n\t\t\t} else if (html.length > 0) {\n\t\t\t\tthis.tryToAutoSubmitHtmlChunk(html);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @public\n\t * @param {string} html\n\t * @returns {void}\n\t */\n\ttryToAutoSubmitHtmlChunk(html)\n\t{\n\t\tFormHelper.createFromHtml(html).submit();\n\t}\n\n\t/**\n\t * @public\n\t * @param {HTMLElement} node\n\t * @returns {void}\n\t */\n\ttryToAutoSubmitDomNode(node)\n\t{\n\t\tFormHelper.createFromNode(node).submit();\n\t}\n\n\t/**\n\t * @private\n\t * @returns {string}\n\t */\n\tgetDefaultAjaxController()\n\t{\n\t\treturn Api.controller.initPayment;\n\t}\n\n\t/**\n\t * @private\n\t * @returns {string}\n\t */\n\tgetCurrentUrl()\n\t{\n\t\treturn window.location.href;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} name\n\t * @param {*} defaultValue\n\t * @returns {*}\n\t */\n\toption(name, defaultValue)\n\t{\n\t\treturn this.options.hasOwnProperty(name) ? this.options[name] : defaultValue;\n\t}\n}"],"names":["FormHelper","form","canSubmit","isVirtual","document","body","appendChild","parentNode","HTMLFormElement","prototype","submit","call","isValidFormObject","containsAllowedInputTypesOnly","elements","i","length","elementAllowed","contains","html","tempNode","createElement","innerHTML","style","display","querySelector","node","element","allowedTypes","getAllowedInputTypes","HTMLInputElement","indexOf","type","Controller","options","url","option","getDefaultAjaxController","allowPaymentRedirect","returnUrl","getCurrentUrl","orderId","paymentId","accessCode","response","params","paySystemId","Error","BX","ajax","method","dataType","data","sessid","bitrix_sessid","paysystemId","access","onsuccess","handleResponse","isResponseSucceed","tryToRedirectUserOnPaymentGate","EventEmitter","emit","EventType","payment","success","error","isObject","status","isString","window","location","href","tryToAutoSubmitHtmlChunk","createFromHtml","createFromNode","Api","controller","initPayment","name","defaultValue","hasOwnProperty"],"mappings":";;;;;KAAaA,UAAb;CAEC;CACD;CACA;CACA;CACC,sBAAYC,IAAZ,EAAkB;CAAA;CACjB,SAAKA,IAAL,GAAYA,IAAI,IAAI,IAApB;CACA;CAED;CACD;CACA;CACA;CACA;;;CAdA;CAAA;;CAqCC;CACD;CACA;CACA;CAxCA,6BAyCU;CACR,UAAI,CAAC,KAAKC,SAAL,EAAL,EAAuB;CACtB;CACA;;CAED,UAAI,KAAKC,SAAL,EAAJ,EAAsB;CACrBC,QAAAA,QAAQ,CAACC,IAAT,CAAcC,WAAd,CAA0B,KAAKL,IAAL,CAAUM,UAApC;CACA;;CAEDC,MAAAA,eAAe,CAACC,SAAhB,CAA0BC,MAA1B,CAAiCC,IAAjC,CAAsC,KAAKV,IAA3C;CACA;CAED;CACD;CACA;CACA;;CAxDA;CAAA;CAAA,gCAyDa;CACX,aAAO,KAAKW,iBAAL,MAA4B,KAAKC,6BAAL,EAAnC;CACA;CAED;CACD;CACA;CACA;;CAhEA;CAAA;CAAA,wCAiEqB;CACnB,aAAO,KAAKZ,IAAL,YAAqBO,eAA5B;CACA;CAED;CACD;CACA;CACA;;CAxEA;CAAA;CAAA,oDAyEiC;CAC/B,UAAI,CAAC,KAAKP,IAAN,IAAc,CAAC,KAAKA,IAAL,CAAUa,QAA7B,EAAuC;CACtC,eAAO,KAAP;CACA,OAH8B;;;CAM/B,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKd,IAAL,CAAUa,QAAV,CAAmBE,MAAvC,EAA+CD,CAAC,EAAhD,EAAoD;CACnD,YAAI,CAACf,UAAU,CAACiB,cAAX,CAA0B,KAAKhB,IAAL,CAAUa,QAAV,CAAmBC,CAAnB,CAA1B,CAAL,EAAuD;CACtD,iBAAO,KAAP;CACA;CACD;;CAED,aAAO,IAAP;CACA;CAED;CACD;CACA;CACA;CACA;;CA5FA;CAAA;;CA6GC;CACD;CACA;CACA;CAhHA,gCAiHa;CACX,UAAI,KAAKd,IAAT,EAAe;CACd,eAAO,CAACG,QAAQ,CAACC,IAAT,CAAca,QAAd,CAAuB,KAAKjB,IAA5B,CAAR;CACA;;CACD,aAAO,IAAP;CACA;CAtHF;CAAA;CAAA,mCAeuBkB,IAfvB,EAe6B;CAC3B,UAAMC,QAAQ,GAAGhB,QAAQ,CAACiB,aAAT,CAAuB,KAAvB,CAAjB;CACAD,MAAAA,QAAQ,CAACE,SAAT,GAAqBH,IAArB;CACAC,MAAAA,QAAQ,CAACG,KAAT,CAAeC,OAAf,GAAyB,MAAzB;CAEA,UAAMvB,IAAI,GAAGmB,QAAQ,CAACK,aAAT,CAAuB,MAAvB,CAAb;CACA,aAAO,IAAIzB,UAAJ,CAAeC,IAAf,CAAP;CACA;CAED;CACD;CACA;CACA;CACA;;CA5BA;CAAA;CAAA,mCA6BuByB,IA7BvB,EA6B6B;CAC3B,UAAIA,IAAI,YAAYlB,eAApB,EAAqC;CACpC,eAAO,IAAIR,UAAJ,CAAe0B,IAAf,CAAP;CACA;;CACD,UAAMzB,IAAI,GAAGyB,IAAI,CAACD,aAAL,CAAmB,MAAnB,CAAb;CACA,aAAO,IAAIzB,UAAJ,CAAeC,IAAf,CAAP;CACA;CAnCF;CAAA;CAAA,mCA6FuB0B,OA7FvB,EA6FgC;CAC9B,UAAMC,YAAY,GAAG5B,UAAU,CAAC6B,oBAAX,EAArB;;CACA,UAAIF,OAAO,YAAYG,gBAAvB,EAAyC;CACxC,eAAOF,YAAY,CAACG,OAAb,CAAqBJ,OAAO,CAACK,IAA7B,MAAuC,CAAC,CAA/C;CACA;;CACD,aAAO,IAAP;CACA;CAED;CACD;CACA;CACA;;CAxGA;CAAA;CAAA,2CAyG+B;CAC7B,aAAO,CAAC,QAAD,EAAW,QAAX,CAAP;CACA;CA3GF;CAAA;CAAA;;KCIaC,UAAb;CAEC,sBAAYC,OAAZ,EACA;CAAA;CACC,SAAKA,OAAL,GAAeA,OAAO,IAAI,EAA1B;CACA,SAAKC,GAAL,GAAW,KAAKC,MAAL,CAAY,KAAZ,EAAmB,KAAKC,wBAAL,EAAnB,CAAX;CACA,SAAKC,oBAAL,GAA4B,KAAKF,MAAL,CAAY,sBAAZ,EAAoC,IAApC,CAA5B;CACA,SAAKG,SAAL,GAAiB,KAAKH,MAAL,CAAY,WAAZ,EAAyB,KAAKI,aAAL,EAAzB,CAAjB;CACA,SAAKC,OAAL,GAAe,KAAKL,MAAL,CAAY,SAAZ,EAAuB,IAAvB,CAAf;CACA,SAAKM,SAAL,GAAiB,KAAKN,MAAL,CAAY,WAAZ,EAAyB,IAAzB,CAAjB;CACA,SAAKO,UAAL,GAAkB,KAAKP,MAAL,CAAY,YAAZ,EAA0B,IAA1B,CAAlB;CACA,SAAKQ,QAAL,GAAgB,IAAhB;CACA;CAED;CACD;CACA;CACA;CACA;;;CAlBA;CAAA;CAAA,gCAmBaC,MAnBb,EAoBC;CAAA;;CACC,UAAI,CAACA,MAAM,CAACC,WAAZ,EACA;CACC,cAAM,IAAIC,KAAJ,CAAU,0BAAV,CAAN;CACA;;CAEDC,MAAAA,EAAE,CAACC,IAAH,CAAQ;CACPC,QAAAA,MAAM,EAAE,MADD;CAEPC,QAAAA,QAAQ,EAAE,MAFH;CAGPhB,QAAAA,GAAG,EAAE,KAAKA,GAHH;CAIPiB,QAAAA,IAAI,EAAE;CACLC,UAAAA,MAAM,EAAEL,EAAE,CAACM,aAAH,EADH;CAELC,UAAAA,WAAW,EAAEV,MAAM,CAACC,WAFf;CAGLP,UAAAA,SAAS,EAAE,KAAKA,SAHX;CAILE,UAAAA,OAAO,EAAE,KAAKA,OAJT;CAKLC,UAAAA,SAAS,EAAE,KAAKA,SALX;CAMLc,UAAAA,MAAM,EAAE,KAAKb;CANR,SAJC;CAYPc,QAAAA,SAAS,EAAE,mBAACb,QAAD,EAAc;CACxB,UAAA,KAAI,CAACA,QAAL,GAAgBA,QAAhB;;CACA,UAAA,KAAI,CAACc,cAAL;CACA;CAfM,OAAR;CAiBA;CAED;CACD;CACA;;CA/CA;CAAA;CAAA,qCAiDC;CACC,UAAI,KAAKC,iBAAL,EAAJ,EAA8B;CAC7B,aAAKC,8BAAL;CACAC,QAAAA,6BAAY,CAACC,IAAb,CAAkBC,+BAAS,CAACC,OAAV,CAAkBC,OAApC,EAA6C,KAAKrB,QAAlD;CACA,OAHD,MAGO;CACNiB,QAAAA,6BAAY,CAACC,IAAb,CAAkBC,+BAAS,CAACC,OAAV,CAAkBE,KAApC,EAA2C,KAAKtB,QAAhD;CACA;CACD;CAED;CACD;CACA;CACA;;CA7DA;CAAA;CAAA,wCA+DC;CACC,aAAOI,EAAE,CAAChB,IAAH,CAAQmC,QAAR,CAAiB,KAAKvB,QAAtB,KAAmC,KAAKA,QAAL,CAAcwB,MAAd,KAAyB,SAAnE;CACA;CAED;CACD;CACA;;CArEA;CAAA;CAAA,qDAuEC;CACC,UAAMjC,GAAG,GAAGa,EAAE,CAAChB,IAAH,CAAQqC,QAAR,CAAiB,KAAKzB,QAAL,CAAcT,GAA/B,IAAsC,KAAKS,QAAL,CAAcT,GAApD,GAA0D,EAAtE;CACA,UAAMhB,IAAI,GAAG6B,EAAE,CAAChB,IAAH,CAAQqC,QAAR,CAAiB,KAAKzB,QAAL,CAAczB,IAA/B,IAAuC,KAAKyB,QAAL,CAAczB,IAArD,GAA4D,EAAzE;;CAEA,UAAI,KAAKmB,oBAAT,EAA+B;CAC9B,YAAIH,GAAG,CAACnB,MAAJ,GAAa,CAAjB,EAAoB;CACnBsD,UAAAA,MAAM,CAACC,QAAP,CAAgBC,IAAhB,GAAuBrC,GAAvB;CACA,SAFD,MAEO,IAAIhB,IAAI,CAACH,MAAL,GAAc,CAAlB,EAAqB;CAC3B,eAAKyD,wBAAL,CAA8BtD,IAA9B;CACA;CACD;CACD;CAED;CACD;CACA;CACA;CACA;;CAxFA;CAAA;CAAA,6CAyF0BA,IAzF1B,EA0FC;CACCnB,MAAAA,UAAU,CAAC0E,cAAX,CAA0BvD,IAA1B,EAAgCT,MAAhC;CACA;CAED;CACD;CACA;CACA;CACA;;CAlGA;CAAA;CAAA,2CAmGwBgB,IAnGxB,EAoGC;CACC1B,MAAAA,UAAU,CAAC2E,cAAX,CAA0BjD,IAA1B,EAAgChB,MAAhC;CACA;CAED;CACD;CACA;CACA;;CA3GA;CAAA;CAAA,+CA6GC;CACC,aAAOkE,yBAAG,CAACC,UAAJ,CAAeC,WAAtB;CACA;CAED;CACD;CACA;CACA;;CApHA;CAAA;CAAA,oCAsHC;CACC,aAAOR,MAAM,CAACC,QAAP,CAAgBC,IAAvB;CACA;CAED;CACD;CACA;CACA;CACA;CACA;;CA/HA;CAAA;CAAA,2BAgIQO,IAhIR,EAgIcC,YAhId,EAiIC;CACC,aAAO,KAAK9C,OAAL,CAAa+C,cAAb,CAA4BF,IAA5B,IAAoC,KAAK7C,OAAL,CAAa6C,IAAb,CAApC,GAAyDC,YAAhE;CACA;CAnIF;CAAA;CAAA;;;;;;;;"}