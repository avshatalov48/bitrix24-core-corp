{"version":3,"file":"lib.bundle.js","sources":["../src/abstract-backend-provider.js","../src/virtual-form.js","../src/payment-process.js"],"sourcesContent":["export class AbstractBackendProvider\n{\n\tconstructor(options) {\n\t\tthis.options = options || {};\n\t}\n\n\t/**\n\t * @public\n\t * @returns {Promise} Resolve when backend responds, reject if there was 4** or 5** HTTP errors\n\t */\n\tinitiatePayment() {}\n\n\t/**\n\t * @public\n\t * @returns {object|string|*} Plain response from backend\n\t */\n\tgetResponse() {}\n\n\t/**\n\t * Returns true if payment inited and user can be redirected to payment gate.\n\t * @public\n\t * @returns {boolean}\n\t */\n\tisResponseSucceed() {}\n\n\t/**\n\t * Returns url of payment gate which user can be redirected to, or null.\n\t * @public\n\t * @returns {string|null}\n\t */\n\tgetPaymentGateUrl() {}\n\n\t/**\n\t * Returns HTML-chunk with payment form which can be displayed to user, or null.\n\t * @public\n\t * @returns {string|null}\n\t */\n\tgetPaymentFormHtml() {}\n\n\t/**\n\t * @protected\n\t * @param {string} name\n\t * @param {*} defaultValue\n\t * @returns {*}\n\t */\n\toption(name, defaultValue) {\n\t\treturn this.options.hasOwnProperty(name) ? this.options[name] : defaultValue;\n\t}\n}","export class VirtualForm\n{\n\t/**\n\t * @private\n\t * @param {HTMLFormElement|null} form\n\t */\n\tconstructor(form) {\n\t\tthis.form = form || null;\n\t}\n\n\t/**\n\t * @public\n\t * @param {string} html\n\t * @returns {VirtualForm}\n\t */\n\tstatic createFromHtml(html) {\n\t\tconst tempNode = document.createElement('div');\n\t\ttempNode.innerHTML = html;\n\t\ttempNode.style.display = 'none';\n\n\t\tconst form = tempNode.querySelector('form');\n\t\treturn new VirtualForm(form);\n\t}\n\n\t/**\n\t * @public\n\t * @param {HTMLElement} node\n\t * @returns {VirtualForm}\n\t */\n\tstatic createFromNode(node) {\n\t\tif (node instanceof HTMLFormElement) {\n\t\t\treturn new VirtualForm(node);\n\t\t}\n\t\tconst form = node.querySelector('form');\n\t\treturn new VirtualForm(form);\n\t}\n\n\t/**\n\t * @public\n\t * @returns {void}\n\t */\n\tsubmit() {\n\t\tif (!this.canSubmit()) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isVirtual()) {\n\t\t\tdocument.body.appendChild(this.form.parentNode);\n\t\t}\n\n\t\tHTMLFormElement.prototype.submit.call(this.form);\n\t}\n\n\t/**\n\t * @public\n\t * @returns {boolean}\n\t */\n\tcanSubmit() {\n\t\treturn this.isValidFormObject() && this.containsAllowedInputTypesOnly();\n\t}\n\n\t/**\n\t * @private\n\t * @returns {boolean}\n\t */\n\tisValidFormObject() {\n\t\treturn this.form instanceof HTMLFormElement;\n\t}\n\n\t/**\n\t * @private\n\t * @returns {boolean}\n\t */\n\tcontainsAllowedInputTypesOnly() {\n\t\tif (!this.form || !this.form.elements) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// eslint-disable-next-line no-plusplus\n\t\tfor (let i = 0; i < this.form.elements.length; i++) {\n\t\t\tif (!VirtualForm.elementAllowed(this.form.elements[i])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @private\n\t * @param element\n\t * @returns {boolean}\n\t */\n\tstatic elementAllowed(element) {\n\t\tconst allowedTypes = VirtualForm.getAllowedInputTypes();\n\t\tif (element instanceof HTMLInputElement) {\n\t\t\treturn allowedTypes.indexOf(element.type) !== -1;\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * @private\n\t * @returns {string[]}\n\t */\n\tstatic getAllowedInputTypes() {\n\t\treturn ['hidden', 'submit'];\n\t}\n\n\t/**\n\t * @public\n\t * @returns {boolean}\n\t */\n\tisVirtual() {\n\t\tif (this.form) {\n\t\t\treturn !document.body.contains(this.form);\n\t\t}\n\t\treturn true;\n\t}\n}","import {EventEmitter} from 'main.core.events';\nimport {EventType} from 'sale.payment-pay.const';\nimport {VirtualForm} from './virtual-form';\nimport {AbstractBackendProvider} from './abstract-backend-provider';\n\nexport class PaymentProcess\n{\n\tconstructor(options)\n\t{\n\t\tthis.options = options || {};\n\n\t\tthis.backendProvider = this.option('backendProvider', null);\n\n\t\tif (!this.backendProvider || !this.backendProvider instanceof AbstractBackendProvider) {\n\t\t\tthrow new Error('Invalid backend provider');\n\t\t}\n\n\t\tthis.allowPaymentRedirect = this.option('allowPaymentRedirect', true);\n\t}\n\n\t/**\n\t * @public\n\t * @returns {void}\n\t */\n\tstart()\n\t{\n\t\tthis.backendProvider.initiatePayment().then(() => {this.handleResponse()});\n\t}\n\n\t/**\n\t * @private\n\t */\n\thandleResponse()\n\t{\n\t\tif (this.backendProvider.isResponseSucceed()) {\n\t\t\tthis.tryToRedirectUserOnPaymentGate();\n\t\t\tEventEmitter.emit(EventType.payment.success, this.backendProvider.getResponse());\n\t\t} else {\n\t\t\tEventEmitter.emit(EventType.payment.error, this.backendProvider.getResponse());\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t */\n\ttryToRedirectUserOnPaymentGate()\n\t{\n\t\tconst url = this.backendProvider.getPaymentGateUrl();\n\t\tconst html = this.backendProvider.getPaymentFormHtml();\n\n\t\tif (this.allowPaymentRedirect) {\n\t\t\tif (url) {\n\t\t\t\twindow.location.href = url;\n\t\t\t} else if (html) {\n\t\t\t\tthis.tryToAutoSubmitHtmlChunk(html);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} html\n\t * @returns {void}\n\t */\n\ttryToAutoSubmitHtmlChunk(html)\n\t{\n\t\tVirtualForm.createFromHtml(html).submit();\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} name\n\t * @param {*} defaultValue\n\t * @returns {*}\n\t */\n\toption(name, defaultValue)\n\t{\n\t\treturn this.options.hasOwnProperty(name) ? this.options[name] : defaultValue;\n\t}\n}"],"names":["AbstractBackendProvider","options","name","defaultValue","hasOwnProperty","VirtualForm","form","canSubmit","isVirtual","document","body","appendChild","parentNode","HTMLFormElement","prototype","submit","call","isValidFormObject","containsAllowedInputTypesOnly","elements","i","length","elementAllowed","contains","html","tempNode","createElement","innerHTML","style","display","querySelector","node","element","allowedTypes","getAllowedInputTypes","HTMLInputElement","indexOf","type","PaymentProcess","backendProvider","option","Error","allowPaymentRedirect","initiatePayment","then","handleResponse","isResponseSucceed","tryToRedirectUserOnPaymentGate","EventEmitter","emit","EventType","payment","success","getResponse","error","url","getPaymentGateUrl","getPaymentFormHtml","window","location","href","tryToAutoSubmitHtmlChunk","createFromHtml"],"mappings":"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"}