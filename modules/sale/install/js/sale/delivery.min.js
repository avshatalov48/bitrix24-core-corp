(function(e){if(!BX.Sale)BX.Sale={};if(BX.Sale.Delivery)return;BX.Sale.Delivery={ajaxUrl:"sale_delivery_ajax.php",showGroupsDialog:function(t,i){var r=new BX.CDialog({title:BX.message("SALE_DSE_CHOOSE_GROUP_TITLE"),head:BX.message("SALE_DSE_CHOOSE_GROUP_HEAD"),content_url:this.ajaxUrl,content_post:"currentGroup="+i+"&action=get_group_dialog_content&selectedGroupId="+i+"&sessid="+BX.bitrix_sessid(),width:350,height:300,resizable:false,draggable:false});var a=[{title:BX.message("SALE_DSE_CHOOSE_GROUP_SAVE"),id:"GROUP_SAVE",action:function(){var i=BX.util.remove_url_param(t,"PARENT_ID"),r=BX.Sale.Delivery.getGroupFromDialog();if(r)i=BX.util.add_url_param(i,{PARENT_ID:r});BX.showWait();e.location.href=i}},BX.CDialog.btnCancel];r.ClearButtons();r.SetButtons(a);r.Show()},getGroupFromDialog:function(){return BX("sale_delivery_group_choose").value},setLHEClass:function(e){BX.ready(function(){var t=BX(e);if(t)BX.addClass(t,"adm-sale-lhe-frame-dlvrs-dscr")})},createFlagFieldChanged:function(e,t){if(t.parentNode.lastChild.name&&t.parentNode.lastChild.name=="CHANGED_FIELDS[]")return;t.parentNode.appendChild(BX.create("input",{props:{type:"hidden",name:"CHANGED_FIELDS[]",value:e}}))},toggleStores:function(){var e=BX("sale-admin-delivery-stores");if(!e)return;if(e.style.display=="none")e.style.display="";else e.style.display="none"},createGroup:function(){var e=new BX.CDialog({content:BX.message("SALE_DSE_GROUP_NAME")+': <input type="text" id="sale_delivery_group_add">',title:BX.message("SALE_DSE_GROUP_CREATE_G"),width:350,height:55});e.ClearButtons();e.SetButtons([{title:BX.message("SALE_DSE_GROUP_CREATE"),action:function(){var e=BX("sale_delivery_group_choose"),t=BX("sale_delivery_group_add"),i=BX.create("option"),r=BX("GROUP_NAME");r.value=t.value;i.text=t.value;i.value="new";e.add(i);e.value="new";this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);e.Show()},getRestrictionParamsHtml:function(t){if(!t.class)return;t.params=t.params||{};t.restrictionId=t.restrictionId||0;t.sort=t.sort||100;ShowWaitWindow();var i={action:"get_restriction_params_html",className:t.class,params:t.params,deliveryId:t.deliveryId,sort:t.sort,lang:t.lang,sessid:BX.bitrix_sessid()};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(i){CloseWaitWindow();if(i&&i.RESTRICTION_HTML&&!i.ERROR){var r=BX.processHTML(i.RESTRICTION_HTML);BX.Sale.Delivery.showRestrictionParamsDialog(r["HTML"],t);e["deliveryGetRestrictionHtmlScriptsLoadingStarted"]=false;var a=function(t){if(!t)BX.removeCustomEvent("deliveryGetRestrictionHtmlScriptsReady",a);for(var i in r["SCRIPT"]){if(!r["SCRIPT"].hasOwnProperty(i))continue;BX.evalGlobal(r["SCRIPT"][i]["JS"]);delete r["SCRIPT"][i];if(t&&e["deliveryGetRestrictionHtmlScriptsLoadingStarted"])return}};BX.addCustomEvent("deliveryGetRestrictionHtmlScriptsReady",a);a(true);BX.loadCSS(r["STYLE"])}else if(i&&i.ERROR){BX.debug("Error receiving restriction params html: "+i.ERROR)}else{BX.debug("Error receiving restriction params html!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error adding restriction!")}})},showRestrictionParamsDialog:function(e,t){if(t.class=="\\Bitrix\\Sale\\Delivery\\Restrictions\\ByLocation"||t.class=="\\Bitrix\\Sale\\Delivery\\Restrictions\\ExcludeLocation"){var i=1030}else{i=600}var r=new BX.CDialog({content:'<form id="sale-delivery-restriction-edit-form">'+e+"</form>",title:BX.message("SALE_RDL_RESTRICTION")+" "+t.title,width:i,height:600,resizable:true});r.ClearButtons();r.SetButtons([{title:BX.message("SALE_RDL_SAVE"),action:function(){var e=BX("sale-delivery-restriction-edit-form"),i=BX.ajax.prepareForm(e),r=!!i&&i.data?i.data:{};BX.Sale.Delivery.saveRestriction(t,r);this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);BX.addCustomEvent(r,"onWindowClose",function(e){e.DIV.parentNode.removeChild(e.DIV)});r.Show();r.adjustSizeEx()},saveRestriction:function(e,t){if(!e.class||!e.deliveryId)return;ShowWaitWindow();var i=t.RESTRICTION||{},r={action:"save_restriction",params:i,sort:t.SORT,className:e.class,deliveryId:e.deliveryId,restrictionId:e.restrictionId,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:r,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Delivery.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error saving restriction: "+e.ERROR)}else{BX.debug("Error saving restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},deleteRestriction:function(e,t){if(!e)return;ShowWaitWindow();var i={action:"delete_restriction",restrictionId:e,deliveryId:t,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Delivery.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error deleting restriction: "+e.ERROR)}else{BX.debug("Error deleting restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},insertAjaxRestrictionHtml:function(e){var t=BX.processHTML(e),i=BX("sale-delivery-restriction-container");if(!i)return;BX.loadCSS(t["STYLE"]);i.innerHTML=t["HTML"];for(var r in t["SCRIPT"])if(t["SCRIPT"].hasOwnProperty(r))BX.evalGlobal(t["SCRIPT"][r]["JS"])},resetRusPostSettings:function(){e.location.href.search("RESET_HANDLER_SETTINGS")!=-1?e.location.reload(true):e.location.href+="&RESET_HANDLER_SETTINGS=Y"},resetRusPostTarifSettings:function(){e.location.href.search("RESET_TARIF_SETTINGS")!=-1?e.location.reload(true):e.location.href+="&RESET_TARIF_SETTINGS=Y"},addRestrictionProductSection:function(e,t){t=BX.util.htmlspecialcharsback(t);t=t.replace(/&#039;/g,"'").replace(/&nbsp;/g," ");var i=BX("sale-admin-delivery-restriction-cat-"+e);if(i)return;var r=BX.create("tr",{props:{id:"sale-admin-delivery-restriction-cat-"+e,className:"adm-s-delivery-restriction-delcat"},children:[BX.create("td",{children:[BX.create("span",{html:" - "+BX.util.htmlspecialchars(t)}),BX.create("input",{props:{type:"hidden",name:"RESTRICTION[CATEGORIES][]",value:e}})]}),BX.create("td",{props:{align:"right"},children:[BX.create("text",{html:"&nbsp;"}),BX.create("a",{props:{href:"javascript:void(0);",className:"adm-s-bus-morelinkqhsw"},html:BX.message("SALE_DELIVERY_INP_DELETE"),events:{click:function(){BX.Sale.Delivery.deleteRestrictionProductSection(e)}}})]})]});BX("sale-admin-delivery-restriction-cat-content").appendChild(r)},deleteRestrictionProductSection:function(e){var t=BX("sale-admin-delivery-restriction-cat-"+e);if(t)t.parentNode.removeChild(t)}}})(window);