(function(e){if(!BX.Sale)BX.Sale={};if(BX.Sale.PaySystem)return;BX.Sale.PaySystem={ajaxUrl:"sale_pay_system_ajax.php",setLHEClass:function(e){BX.ready(function(){var t=BX(e);if(t)BX.addClass(t,"adm-sale-lhe-frame-dlvrs-dscr")})},getRestrictionParamsHtml:function(t){if(!t.class)return;t.params=t.params||{};t.restrictionId=t.restrictionId||0;t.sort=t.sort||100;ShowWaitWindow();var i={action:"get_restriction_params_html",className:t.class,params:t.params,paySystemId:t.paySystemId,sort:t.sort,lang:t.lang,sessid:BX.bitrix_sessid()};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(i){CloseWaitWindow();if(i&&i.RESTRICTION_HTML&&!i.ERROR){var a=BX.processHTML(i.RESTRICTION_HTML);BX.Sale.PaySystem.showRestrictionParamsDialog(a["HTML"],t);e["paySystemGetRestrictionHtmlScriptsLoadingStarted"]=false;var n=function(t){if(!t)BX.removeCustomEvent("paySystemGetRestrictionHtmlScriptsReady",n);for(var i in a["SCRIPT"]){BX.evalGlobal(a["SCRIPT"][i]["JS"]);delete a["SCRIPT"][i];if(t&&e["paySystemGetRestrictionHtmlScriptsLoadingStarted"])return}};BX.addCustomEvent("paySystemGetRestrictionHtmlScriptsReady",n);n(true);BX.loadCSS(a["STYLE"])}else if(i&&i.ERROR){BX.debug("Error receiving restriction params html: "+i.ERROR)}else{BX.debug("Error receiving restriction params html!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error adding restriction!")}})},showRestrictionParamsDialog:function(e,t){var i=t.class=="\\Bitrix\\Sale\\PaySystem\\Restrictions\\ByLocation"?1030:420,a=new BX.CDialog({content:'<form id="sale-paysystem-restriction-edit-form">'+e+"</form>",title:BX.message("SALE_RDL_RESTRICTION")+" "+t.title,width:i,height:500,resizable:true});a.ClearButtons();a.SetButtons([{title:BX.message("SALE_RDL_SAVE"),action:function(){var e=BX("sale-paysystem-restriction-edit-form"),i=BX.ajax.prepareForm(e),a=!!i&&i.data?i.data:{};BX.Sale.PaySystem.saveRestriction(t,a);this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);BX.addCustomEvent(a,"onWindowClose",function(e){e.DIV.parentNode.removeChild(e.DIV)});a.Show();a.adjustSizeEx()},saveRestriction:function(e,t){ShowWaitWindow();var i=t.RESTRICTION||{},a={action:"save_restriction",params:i,sort:t.SORT,className:e.class,paySystemId:e.paySystemId,restrictionId:e.restrictionId,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.PaySystem.insertAjaxRestrictionHtml(e.HTML)}else{alert(e.ERROR)}},onfailure:function(){CloseWaitWindow()}})},deleteRestriction:function(e,t){if(!e)return;ShowWaitWindow();var i={action:"delete_restriction",restrictionId:e,paySystemId:t,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.PaySystem.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error deleting restriction: "+e.ERROR)}else{BX.debug("Error deleting restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},insertAjaxRestrictionHtml:function(e){var t=BX.processHTML(e),i=BX("sale-paysystem-restriction-container");if(!i)return;BX.loadCSS(t["STYLE"]);i.innerHTML=t["HTML"];for(var a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"])},getHandlerOptions:function(e){var t=e.value,i;if(t==="")return;if(BX("PS_MODE")){i=BX("PS_MODE").value}ShowWaitWindow();var a={action:"getHandlerDescription",handler:t,paySystemId:BX("ID").value,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};if(i!==undefined){a.PS_MODE=i}BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.BUS_VAL){var t=BX.processHTML(e.BUS_VAL);var i=BX("paysystem-business-value-settings");if(!i)return;BX.loadCSS(t["STYLE"]);i.innerHTML=t["HTML"];for(var a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"])}var n=BX("pay_system_tariff");if(e.TARIF){t=BX.processHTML(e.TARIF);if(!n)return;BX.loadCSS(t["STYLE"]);n.innerHTML=t["HTML"];for(a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"]);BX.Sale.PaySystem.initTariffLoad()}else{n.innerHTML=""}var r=BX("pay_system_ps_mode");var s=BX("ACTION_FILE").value==="orderdocument";if(e.PAYMENT_MODE||s){var o=BX.create("tr",{props:{width:"40%"}});o.setAttribute("valign","top");var l=BX.create("td",{props:{width:"40%"}});BX.addClass(l,"adm-detail-content-cell-l");l.innerHTML=e.PAYMENT_MODE_TITLE+":";var d=BX.create("td",{props:{width:"60%"}});BX.addClass(d,"adm-detail-content-cell-r");if(e.PAYMENT_MODE){d.innerHTML=e.PAYMENT_MODE}if(s){var c=BX.create("span",{text:BX.message("SALE_TEMPLATE_DOCUMENT_ADD"),attrs:{class:"bx-button-add-template",style:"margin-left: 5px"}});BX.bind(c,"click",function(){BX.SidePanel.Instance.open(e.ORDER_DOC_ADD_LINK,{width:930,events:{onCloseComplete:function(){BX.Sale.PaySystem.getHandlerOptions(BX("ACTION_FILE"))}}})});d.appendChild(c)}o.appendChild(l);o.appendChild(d);r.innerHTML="";r.appendChild(o)}else{r.innerHTML=""}var f=BX("pay_system_ps_description");if(f)f.innerHTML="";if(e.DESCRIPTION){var m=BX.create("tr",{children:[BX.create("td",{props:{width:"40%",className:"adm-detail-content-cell-l"}}),BX.create("td",{props:{width:"60%",className:"adm-detail-content-cell-r"},html:e.DESCRIPTION})]});f.appendChild(m)}if(e.NAME!==undefined)BX("NAME").value=e.NAME;if(e.PSA_NAME!==undefined)BX("PSA_NAME").value=e.PSA_NAME;if(e.SORT)BX("SORT").value=e.SORT;var S=BX("ID").value;var B=BX("LOGOTIP");var p=BX.findParent(B,{tag:"div"});var u=BX.findChild(p.parentNode,{tag:"img"});if(e.LOGOTIP){if(e.LOGOTIP.NAME)B.previousElementSibling.innerHTML=e.LOGOTIP.NAME;if(u){if(e.LOGOTIP.PATH)u.src=e.LOGOTIP.PATH}else{u=BX.create("img",{attrs:{src:e.LOGOTIP.PATH}});u.style.maxHeight="55px";BX.insertAfter(u,p);BX.insertAfter(BX.create("br"),p)}}else if(S<=0){if(u)BX.remove(u);B.previousElementSibling.innerHTML=BX.message("JSADM_FILE")}this.updateVerificationBlock(e.DOMAIN_VERIFICATION)}else{BX.debug(e.ERROR)}}.bind(this),onfailure:function(){CloseWaitWindow();var e=BX("pay_system_ps_description");if(e)e.innerHTML="";var t=BX("pay_system_ps_mode");if(t)t.innerHTML="";BX.debug("Error")}})},toggleNextSiblings:function(e,t,i){if(!e.nextElementSibling)return false;var a=e.nextElementSibling;for(var n=0;n<t;n++){if(a.style.display=="none"&&!i)a.style.display="";else a.style.display="none";if(a.nextElementSibling)a=a.nextElementSibling;else break}return true},deleteObjectAndNextSiblings:function(e,t,i){if(!e)return false;var a;var n=e;if(i&&i>0){for(a=0;a<i;a++){if(n.parentNode)n=n.parentNode;else return false}}var r=false;var s=n;for(a=0;a<=t;a++){if(s.nextElementSibling)r=s.nextElementSibling;s.parentNode.removeChild(s);if(r)s=r;else break}return true},initTariffLoad:function(){var t;var i=BX("tabControl_layout");if(i){var a=e.parent.BX.findChildren(i,{tag:"tr",class:"ps-admin-hide"},true);for(t in a)BX.Sale.PaySystem.toggleNextSiblings(a[t],4,true)}e.parent.BX.onCustomEvent("onAdminTabsChange")},updateVerificationBlock:function(e){var t=BX("pay_system_validation_domain");t.style.display=e.NEED_VERIFICATION?"":"none";if(e.NEED_VERIFICATION){var i=BX("domain-verification-link");i.setAttribute("onclick","BX.Sale.PaySystem.openVerificationForm('"+e.FORM_LINK+"')")}},openVerificationForm:function(e){BX.SidePanel.Instance.open(e,{width:750})}}})(window);
//# sourceMappingURL=pay_system.map.js