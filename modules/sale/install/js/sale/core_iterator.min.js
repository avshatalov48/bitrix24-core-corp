BX.iterator=function(t,e){this.parentConstruct(BX.iterator,t);BX.merge(this,{opts:{source:"/somewhere.php",interval:1e3,dataType:"json",method:"post",loader:null,waitAjaxOnStop:false,whenHit:function(){return true}},vars:{status:"S",running:false,timeTag:false,ajaxTag:false,step:0,fields:{},lastRequest:null,lastResponce:null,wasAborted:false},ctrls:{},sys:{code:"iterator",statuses:{stopped:"S",stopping:"I",running:"R"}}});this.handleInitStack(e,BX.iterator,t)};BX.extend(BX.iterator,BX.ui.widget);BX.merge(BX.iterator.prototype,{init:function(){var t=this.vars,e=this.opts;t.loader=typeof e.loader!="object"?{show:BX.DoNothing,hide:BX.DoNothing}:e.loader;this.fireEvent("set-status",[t.status])},start:function(t){var e=this.vars;if(e.running)return;e.running=true;e.status=this.sys.statuses.running;e.fields=BX.clone(t);this.fireEvent("set-status",[e.status]);this.query()},stop:function(){var t=this.vars,e=this.opts;clearInterval(t.timeTag);if(e.waitAjaxOnStop){t.status=this.sys.statuses.stopping;this.fireEvent("set-status",[t.status])}else{if(typeof t.ajaxTag!="undefined"&&t.ajaxTag.readyState<4){t.wasAborted=true;t.ajaxTag.abort()}this.stopIterator()}},refineRequest:function(t){return t},refineResponce:function(t,e){return t},getStatus:function(){return this.vars.status},getIsRunning:function(){return this.vars.status==this.sys.statuses.running||this.vars.status==this.sys.statuses.stopping},stopIterator:function(t){var e=this.vars;e.step=0;e.running=false;e.status=this.sys.statuses.stopped;this.fireEvent("set-status",[e.status,t])},query:function(){var t=this,e=this.opts,s=this.vars;s.loader.show();this.fireEvent("before-ajax-call");var r=BX.clone(s.fields);r.step=s.step;r.csrf=BX.bitrix_sessid();s.lastRequest=r;s.ajaxTag=BX.ajax({url:e.source,method:e.method,dataType:e.dataType,async:true,processData:true,emulateOnload:true,start:true,data:t.refineRequest(r),onsuccess:function(a){s.loader.hide();if(s.wasAborted)return;if(s.status==t.sys.statuses.stopping){t.stopIterator();return}a=t.refineResponce(a,r);s.lastResponce=a;if(a.result){s.step++;if(!e.whenHit.apply(t,[a,r])){t.stopIterator(a)}else if(s.running)s.timeTag=setTimeout(function(){t.query()},e.interval);t.fireEvent("ajax-success")}else{t.stopIterator();var n=[];if(typeof a.errors!="undefined"){for(var i in a.errors)if(a.errors.hasOwnProperty(i))n.push({message:a.errors[i]})}t.fireEvent("server-error",[n])}t.fireEvent("ajax-complete")},onfailure:function(e,r){s.loader.hide();if(s.wasAborted)return;t.stopIterator();t.fireEvent("ajax-error",[{message:e,detail:r}]);t.fireEvent("ajax-complete")}})}});
//# sourceMappingURL=core_iterator.map.js