BX.namespace("BX.Sale.Admin.OrderBuyer");BX.Sale.Admin.OrderBuyer={propertyCollection:null,savedPropsCollections:{},profilesData:null,oldBuyerId:0,isFeatureSaleAccountsEnabled:false,getFieldsUpdaters:function(){return{BUYER_USER_NAME:BX.Sale.Admin.OrderBuyer.setBuyerName,BUYER_PROFILES_LIST:BX.Sale.Admin.OrderBuyer.setBuyerProfilesList,PROPERTIES_ARRAY:BX.Sale.Admin.OrderBuyer.setOrderPropsArray,PROPERTIES:BX.Sale.Admin.OrderBuyer.setOrderProps,BUYER_PROFILES_DATA:BX.Sale.Admin.OrderBuyer.setProfilesData}},setProfilesData:function(e){BX.Sale.Admin.OrderBuyer.profilesData=e;BX.Sale.Admin.OrderBuyer.onBuyerProfileChange()},setBuyerName:function(e){var r=BX("BUYER_USER_NAME"),a=BX("sale-order-buyer-find-button-wrap"),d=BX("sale-order-buyer-name-wrap");if(r)r.innerHTML=BX.util.htmlspecialchars(e);if(e){a.style.display="none";d.style.display=""}else{a.style.display="";d.style.display="none"}},setBuyerProfilesList:function(e){var r=BX("BUYER_PROFILE_ID"),a=0;if(!r){var d=BX("BUYER_PROFILE_ID_CONTAINER");r=BX.create("select",{props:{name:"BUYER_PROFILE_ID",id:"BUYER_PROFILE_ID"}});BX.bind(r,"change",BX.Sale.Admin.OrderBuyer.onBuyerProfileChange);d.appendChild(r)}if(r.length>0)for(var l=0,i=r.length;l<i;l++)r.remove(r[l]);if(!e){r.add(BX.create("option",{props:{value:"",text:BX.message("SALE_ORDER_BUYER_CREATE_NEW")}}));return}for(var t in e){if(!e.hasOwnProperty(t))continue;r.add(BX.create("option",{props:{value:t,text:e[t]}}));if(t>0&&a==0)a=t}BX.Sale.Admin.OrderBuyer.setBuyerProfileId(a);BX.Sale.Admin.OrderBuyer.showBuyerProfilesList()},setBuyerProfileId:function(e){var r=BX("BUYER_PROFILE_ID");if(r)r.value=e},showBuyerProfilesList:function(){var e=BX("sale-order-buyer-profiles-list-row");if(e)e.style.display=""},hideBuyerProfilesList:function(){var e=BX("sale-order-buyer-profiles-list-row");if(e)e.style.display="none"},setOrderProps:function(e){for(var r in e){if(!e.hasOwnProperty(r))continue;var a=BX.Sale.Admin.OrderBuyer.propertyCollection.getById(r);if(a)a.setValue(e[r])}BX.Sale.Admin.OrderBuyer.callPropertiesUpdaters()},showChooseBuyerWindow:function(e){window.open("/bitrix/admin/user_search.php?lang="+e+"&FN="+BX.Sale.Admin.OrderEditPage.formId+"&FC=USER_ID","","scrollbars=yes,resizable=yes,width=840,height=500,top="+Math.floor((screen.height-840)/2-14)+",left="+Math.floor((screen.width-760)/2-5))},clearBuyer:function(){BX.Sale.Admin.OrderBuyer.setBuyerName("");BX.Sale.Admin.OrderBuyer.setBuyerId(0);BX.Sale.Admin.OrderBuyer.hideBuyerProfilesList();BX.Sale.Admin.OrderBuyer.setBuyerProfilesList(false);BX.Sale.Admin.OrderBuyer.onBuyerIdChange(BX("USER_ID"))},onBuyerIdChange:function(e){BX.Sale.Admin.OrderBuyer.updateBuyerProfileLink(e.value);BX("OLD_USER_ID").value=BX.Sale.Admin.OrderBuyer.oldBuyerId;BX.Sale.Admin.OrderBuyer.oldBuyerId=e.value;BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getOrderFields({givenFields:{USER_ID:e.value,PERSON_TYPE_ID:this.getBuyerTypeId(),CURRENCY:BX.Sale.Admin.OrderEditPage.currency,ORDER_ID:BX.Sale.Admin.OrderEditPage.orderId,SITE_ID:BX.Sale.Admin.OrderEditPage.siteId,BUYER_ID_CHANGED:"Y"},demandFields:["BUYER_PROFILES_LIST","BUYER_PROFILES_DATA","BUYER_USER_NAME","BUYER_BUDGET","PROPERTIES"]}),false,true)},onBuyerTypeChange:function(e){var r=["BUYER_PROFILES_LIST","BUYER_PROFILES_DATA"];if(!BX.Sale.Admin.OrderBuyer.savedPropsCollections[e]){r.push("PROPERTIES_ARRAY")}else{BX.Sale.Admin.OrderBuyer.setOrderPropsArray()}BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({demandFields:r,operation:"BUYER_CHANGED",givenFields:{USER_ID:this.getBuyerId(),PERSON_TYPE_ID:e,SITE_ID:BX.Sale.Admin.OrderEditPage.siteId}}))},onBuyerProfileChange:function(){var e=BX.Sale.Admin.OrderBuyer.getBuyerProfileId(),r=BX.Sale.Admin.OrderBuyer.getBuyerTypeId(),a=BX.Sale.Admin.OrderBuyer.profilesData;if(a&&a[r]&&a[r][e]){BX.Sale.Admin.OrderBuyer.setOrderProps(a[r][e]);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"BUYER_PROFILE_CHANGED"}))}else if(e!=0){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getOrderFields({givenFields:{USER_ID:this.getBuyerId(),BUYER_PROFILE_ID:this.getBuyerProfileId()},demandFields:["PROPERTIES"]}),true)}},getBuyerProfileId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("BUYER_PROFILE_ID")},getBuyerTypeId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("PERSON_TYPE_ID")},getBuyerId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("USER_ID")},setBuyerId:function(e){BX("USER_ID").value=e;BX.Sale.Admin.OrderBuyer.updateBuyerProfileLink(e)},updateBuyerProfileLink:function(e){if(BX.Sale.Admin.OrderBuyer.isFeatureSaleAccountsEnabled)BX("BUYER_USER_NAME").href="/bitrix/admin/sale_buyers_profile.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&USER_ID="+e;else BX("BUYER_USER_NAME").href="/bitrix/admin/user_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&ID="+e},setOrderPropsArray:function(e){var r=BX.Sale.Admin.OrderBuyer.getBuyerTypeId();if(!BX.Sale.Admin.OrderBuyer.savedPropsCollections[r])BX.Sale.Admin.OrderBuyer.savedPropsCollections[r]=new BX.Sale.PropertyCollection(e);BX.Sale.Admin.OrderBuyer.propertyCollection=BX.Sale.Admin.OrderBuyer.savedPropsCollections[r];if(!BX.Sale.Admin.OrderBuyer.propertyCollection){BX.debug("Error! Can't initialize property collection!");return}BX.Sale.Admin.OrderBuyer.callPropertiesUpdaters();var a,d,l,i;if(a=BX.Sale.Admin.OrderBuyer.propertyCollection.getUserEmail())a.addEvent("change",function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_EMAIL",a.getValue())});if(d=BX.Sale.Admin.OrderBuyer.propertyCollection.getPhone())d.addEvent("change",function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_PHONE",d.getValue())});if(l=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation())l.addEvent("change",function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("LOCATION",l.getValue())});if(i=BX.Sale.Admin.OrderBuyer.propertyCollection.getPayerName())i.addEvent("change",function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_FIO",i.getValue())});var t=BX("order_properties_container"),n,o,B=BX.Sale.Admin.OrderBuyer.propertyCollection.getGroupIterator();for(var s=0,p=t.children.length;s<p;s++)t.removeChild(t.children[0]);while(n=B()){var u=n.getName()?BX.util.htmlspecialchars(n.getName()):BX.message("SALE_ORDER_BUYER_UNKNOWN_GROUP"),c=BX.create("DIV",{props:{className:"adm-bus-table-container caption border sale-order-props-group"}}),y=BX.create("DIV",{props:{className:"adm-bus-table-caption-title"},html:u}),m=BX.create("TABLE",{props:{className:"adm-detail-content-table edit-table"}}),E=n.getIterator();m.border=0;m.cellspacing=0;m.cellpadding=0;m.width="100%";o=E();if(!o)continue;while(o){var X=BX.create("tr"),O=BX.create("td",{props:{className:"adm-detail-content-cell-l"},html:BX.util.htmlspecialchars(o.getName())+":"}),A=BX.create("td",{props:{className:"adm-detail-content-cell-r"}});O.style.verticalAlign="top";O.style.paddingTop="0.8em";if(o.isRequired())BX.addClass(O,"fwb");O.width="40%";o.appendTo(A);X.appendChild(O);X.appendChild(A);m.appendChild(X);o=E()}c.appendChild(y);c.appendChild(m);t.appendChild(c)}},setOrderRelPropsArray:function(e){var r=BX.Sale.Admin.OrderBuyer.getBuyerTypeId();BX.Sale.Admin.OrderBuyer.savedPropsCollections[r+"_rel"]=new BX.Sale.PropertyCollection(e);BX.Sale.Admin.OrderBuyer.propertyLocCollection=BX.Sale.Admin.OrderBuyer.savedPropsCollections[r+"_rel"];if(!BX.Sale.Admin.OrderBuyer.propertyLocCollection){BX.debug("Error! Can't initialize property collection!");return}var a=BX("order_properties_container_add"),d,l,i=BX.Sale.Admin.OrderBuyer.propertyLocCollection.getGroupIterator();for(var t=0,n=a.children.length;t<n;t++)a.removeChild(a.children[0]);var o=BX.findParent(a,{attr:"data-id"},true);var B=BX("nav_relprops").parentNode;if(e.properties.length>0){BX.show(o);BX.style(B,"display","inline-block")}else{BX.hide(o);BX.hide(B)}while(d=i()){var s=BX.create("DIV",{props:{className:"adm-bus-table-container caption border sale-order-props-group"}}),p=BX.create("DIV",{props:{className:"adm-bus-table-caption-title"},html:BX.util.htmlspecialchars(d.getName())}),u=BX.create("TABLE",{props:{className:"adm-detail-content-table edit-table"}}),c=d.getIterator();u.border=0;u.cellspacing=0;u.cellpadding=0;u.width="100%";while(l=c()){var y=BX.create("tr"),m=BX.create("td",{props:{className:"adm-detail-content-cell-l"},html:BX.util.htmlspecialchars(l.getName())+":"}),E=BX.create("td",{props:{className:"adm-detail-content-cell-r"}});if(l.isRequired())BX.addClass(m,"fwb");m.width="40%";l.appendTo(E);y.appendChild(m);y.appendChild(E);u.appendChild(y)}s.appendChild(p);s.appendChild(u);a.appendChild(s)}},callPropertiesUpdaters:function(){var e;if(e=BX.Sale.Admin.OrderBuyer.propertyCollection.getPhone())BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_PHONE",e.getValue());if(e=BX.Sale.Admin.OrderBuyer.propertyCollection.getUserEmail())BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_EMAIL",e.getValue());if(e=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation())BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("LOCATION",e.getValue());if(e=BX.Sale.Admin.OrderBuyer.propertyCollection.getPayerName())BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_FIO",e.getValue())}};