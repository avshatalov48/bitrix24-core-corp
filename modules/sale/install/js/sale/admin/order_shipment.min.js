BX.namespace("BX.Sale.Admin.OrderShipment");BX.Sale.Admin.OrderShipment=function(e){this.index=e.index;this.id=e.id;this.shipment_statuses=e.shipment_statuses;this.isAjax=!!e.isAjax;this.srcList=e.src_list;this.allowAvailable=!!e.canAllow;this.deductAvailable=!!e.canDeduct;this.changeStatusAvailable=!!e.canChangeStatus;this.discounts=e.discounts||{};this.discountsMode=e.discountsMode||"edit";this.weightKoeff=e.weightKoeff||1;this.weightUnit=e.weightUnit||"";if(this.allowAvailable)this.initFieldChangeAllowDelivery();if(this.deductAvailable)this.initFieldChangeDeducted();if(this.changeStatusAvailable)this.initFieldChangeStatus();if(!!e.active&&e.templateType=="view")this.initUpdateTrackingNumber();this.initFieldUpdateSum();this.initFieldUpdateWeight();this.initChangeProfile();this.initCustomEvent();this.initToggle();this.initDeleteShipment();if(this.discounts)this.setDiscountsList(this.discounts);var i=[];if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){i["DELIVERY_PRICE_DISCOUNT"]={callback:this.setDeliveryPrice,context:this};i["DELIVERY_WEIGHT"]={callback:this.setDeliveryWeight,context:this}}if(!!e.calculated_price)this.setCalculatedPriceDelivery(e.calculated_price);if(!!e.calculated_weight)this.setCalculatedWeightDelivery(e.calculated_weight);i["DEDUCTED_"+this.id]={callback:this.updateDeductedStatus,context:this};i["ALLOW_DELIVERY_"+this.id]={callback:this.updateAllowDeliveryStatus,context:this};i["SHIPMENT_STATUS_LIST_"+this.id]={callback:this.setShipmentStatusList,context:this};i["SHIPMENT_STATUS_"+this.id]={callback:this.setDeliveryStatus,context:this};if(e.templateType=="edit"){i["BASE_PRICE_DELIVERY"]={callback:this.setDeliveryBasePrice,context:this};i["CALCULATED_PRICE"]={callback:this.setCalculatedPriceDelivery,context:this};i["CALCULATED_WEIGHT"]={callback:this.setCalculatedWeightDelivery,context:this};i["DELIVERY_ERROR"]={callback:BX.Sale.Admin.OrderEditPage.showDialog,context:this};i["MAP"]={callback:this.updateMap,context:this};i["PROFILES"]={callback:this.updateProfiles,context:this};i["EXTRA_SERVICES"]={callback:this.updateExtraService,context:this};i["DELIVERY_SERVICE_LIST"]={callback:this.updateDeliveryList,context:this};i["SHIPMENT_COMPANY_ID"]={callback:this.updateCompany,context:this};if(!!BX.Sale.Admin.OrderBuyer&&!!BX.Sale.Admin.OrderBuyer.propertyCollection){var t=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation();if(t){t.addEvent("change",function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData(),true)})}}}i["DISCOUNTS_LIST"]={callback:this.setDiscountsList,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(i)};BX.Sale.Admin.OrderShipment.prototype.updateCompany=function(e){var i=BX("SHIPMENT_COMPANY_ID_"+this.index);if(i)i.innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.updateDeductedStatus=function(e){this.setDeducted({status:e})};BX.Sale.Admin.OrderShipment.prototype.updateAllowDeliveryStatus=function(e){this.setAllowDelivery({status:e})};BX.Sale.Admin.OrderShipment.prototype.initUpdateTrackingNumber=function(){var e="";var i=BX("TRACKING_NUMBER_"+this.index+"_EDIT");var t=BX("TRACKING_NUMBER_"+this.index+"_VIEW");var a=BX("TRACKING_NUMBER_PENCIL_"+this.index);if(a){BX.bind(a,"click",function(){BX.toggle(this);if(i){BX.toggle(i);BX.toggle(t);i.focus()}});BX.bind(i,"blur",BX.proxy(function(){BX.toggle(a);BX.toggle(i);t.innerHTML=i.value;BX.toggle(t);if(i.value!=e){var n={action:"saveTrackingNumber",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,trackingNumber:i.value};BX.Sale.Admin.OrderAjaxer.sendRequest(n)}},this));BX.bind(i,"focus",function(){e=i.value})}};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryList=function(e){var i=BX("DELIVERY_"+this.index);if(!i){return}var t=0;if(i.options[i.selectedIndex]){t=i.options[i.selectedIndex].value}i.innerHTML=e;for(var a in i.options){if(i.options[a].value==t){i.options[a].selected=true;break}}};BX.Sale.Admin.OrderShipment.prototype.setDiscountsList=function(e){this.discounts=e;var i=BX("sale-order-shipment-discounts-container-"+this.index),t=BX("sale-order-shipment-discounts-row-"+this.index),a="none";if(i){i=BX.cleanNode(i,false);if(e&&e.RESULT&&e.RESULT.DELIVERY&&e.RESULT.DELIVERY.length>0){i.appendChild(this.createDiscountsNode(e.RESULT.DELIVERY));a=""}}if(t&&t.previousElementSibling){t.style.display=a;t.previousElementSibling.style.display=a}};BX.Sale.Admin.OrderShipment.prototype.createDiscountsNode=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DELIVERY",e,this.discounts,this.discountsMode=="edit"?"EDIT":"VIEW")};BX.Sale.Admin.OrderShipment.prototype.updateProfiles=function(e){var i=null;var t=BX("BLOCK_DELIVERY_SERVICE_"+this.index);var a=BX("BLOCK_PROFILES_"+this.index);var n=BX("PROFILE_"+this.index);if(n)i=n.options[n.selectedIndex].value;if(a)BX.remove(a);var r=BX.create("tr",{props:{id:"BLOCK_PROFILES_"+this.index},children:[BX.create("td",{text:BX.message("SALE_ORDER_SHIPMENT_PROFILE")+":",style:{width:"40%"},props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{html:e,props:{id:" PROFILE_SELECT_"+this.index,className:"adm-detail-content-cell-r"}})]});t.parentNode.appendChild(r);n=r.lastChild.firstChild;if(i){for(var s in n.options){if(n.options[s].value==i){n.options[s].selected=true;break}}}BX.bind(n,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData());this.updateDeliveryLogotip()}else{this.updateDeliveryInfo()}},this))};BX.Sale.Admin.OrderShipment.prototype.updateExtraService=function(e){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.updateShipmentStatus=function(e,i,t){var a={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:e,status:i,callback:BX.proxy(function(a){this.callbackUpdateShipmentStatus(a,e,i,t)},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(a)};BX.Sale.Admin.OrderShipment.prototype.callbackUpdateShipmentStatus=function(e,i,t,a){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else if(e.NEED_CONFIRM&&e.NEED_CONFIRM===true){var n=false;var r=false;if(e.WARNING&&e.WARNING.length>0){r=e.WARNING}if(e.CONFIRM_TITLE&&e.CONFIRM_TITLE.length>0){n=e.CONFIRM_TITLE}if(e.CONFIRM_MESSAGE&&e.CONFIRM_MESSAGE.length>0){r=r+"<br/>"+e.CONFIRM_MESSAGE}BX.Sale.Admin.OrderEditPage.showConfirmDialog(r,n,BX.proxy(function(){this.sendStrictUpdateShipmentStatus(i,t,a)},this),function(){return})}else{this[a.callback](a.args);if(e.RESULT)BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);if(e.WARNING&&e.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.WARNING)}if(typeof e.MARKERS!="undefined"){var s=BX("sale-adm-order-problem-block");if(s)s.innerHTML=e.MARKERS}}};BX.Sale.Admin.OrderShipment.prototype.sendStrictUpdateShipmentStatus=function(e,i,t){var a={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:e,status:i,strict:true,callback:BX.proxy(function(a){this.callbackUpdateShipmentStatus(a,e,i,t)},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(a)};BX.Sale.Admin.OrderShipment.prototype.updateMap=function(e){var i=BX.processHTML(e);var t=BX("section_map_"+this.index);t.innerHTML=i["HTML"];for(var a in i["SCRIPT"])BX.evalGlobal(i["SCRIPT"][a]["JS"]);BX.loadCSS(i["STYLE"])};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryLogotip=function(){var e=BX("DELIVERY_"+this.index);var i=BX.findParent(e,{tag:"tbody"},true);if(i.children.length>1)e=BX("PROFILE_"+this.index);var t="";var a="";var n=0;if(this.srcList[BX(e).value])n=BX(e).value;t=this.srcList[n]["MAIN"];a=this.srcList[n]["SHORT"];var r=BX("delivery_service_logo_"+this.index);if(!!r)r.style.background="url("+t+")";var s=BX("delivery_service_short_logo_"+this.index);if(!!s)s.style.background="url("+a+")"};BX.Sale.Admin.OrderShipment.prototype.initChangeProfile=function(){var e=BX("DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";var a=BX("BLOCK_PROFILES_"+this.index);if(a)BX.remove(a);var n=BX("sale-order-shipment-discounts-row-"+this.index);if(n){BX.hide(n.previousElementSibling);BX.hide(n)}var r=BX(e).value;if(r>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this));var i=BX("PROFILE_"+this.index);if(i){BX.bind(i,"change",BX.proxy(function(){var e=BX("DELIVERY_INFO_"+this.index);e.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";var a=BX("sale-order-shipment-discounts-row-"+this.index);if(a){BX.hide(a.previousElementSibling);BX.hide(a)}var n=BX(i).value;if(n>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this))}};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeDeducted=function(){var e=BX("STATUS_DEDUCTED_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var a=BX("BUTTON_DEDUCTED_"+i[t]);if(!a)continue;var n=[];if(e.value=="N"){n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","Y",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}else{n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","N",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}var r=new BX.COpener({DIV:a.parentNode,MENU:n})}};BX.Sale.Admin.OrderShipment.prototype.setDeducted=function(e){var i=e.status=="Y"?"YES":"NO";var t=BX("STATUS_DEDUCTED_"+this.index);var a=["SHORT_"+this.index,this.index];t.value=e.status;for(var n in a){var r=BX("BUTTON_DEDUCTED_"+a[n]);if(!r)continue;BX.html(r,BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_"+i));if(e.status=="Y")BX.removeClass(r,"notdeducted");else BX.addClass(r,"notdeducted")}this.initFieldChangeDeducted()};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeStatus=function(){var e=["SHORT_"+this.index,this.index];var i=BX("STATUS_SHIPMENT_"+this.index);for(var t in e){var a=BX("BUTTON_SHIPMENT_"+e[t]);var n=[];for(var r in this.shipment_statuses){if(this.shipment_statuses[r].ID==i.value)continue;function s(e,i){var t={name:e.NAME,id:e.ID};var a={TEXT:e.NAME,ONCLICK:function(){i.updateShipmentStatus("STATUS_ID",e.ID,{callback:"setDeliveryStatus",args:t})}};n.push(a)}s(this.shipment_statuses[r],this)}if(a){if(n.length>0){var d=new BX.COpener({DIV:a.parentNode,MENU:n})}else{var l=BX.create("span",{children:[BX.create("span",{attrs:{id:a.getAttribute("id"),className:"not_active"},text:a.textContent})]});a.parentNode.parentNode.appendChild(l);BX.remove(a.parentNode)}}}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryStatus=function(e){var i=BX("STATUS_SHIPMENT_"+this.index);i.value=e.id;var t=["SHORT_"+this.index,this.index];for(var a in t){var n=BX("BUTTON_SHIPMENT_"+t[a]);BX.html(n,e.name)}this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.setDeliveryBasePrice=function(e){if(BX("BASE_PRICE_DELIVERY_"+this.index))BX("BASE_PRICE_DELIVERY_"+this.index).value=e;if(BX("BASE_PRICE_DELIVERY_T_"+this.index))BX("BASE_PRICE_DELIVERY_T_"+this.index).innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.setDeliveryWeight=function(e){var i=BX("WEIGHT_DELIVERY_"+this.index);if(!i){return}if(i.tagName==="INPUT"){i.value=e}else if(i.tagName==="TD"){i.innerHTML=e+" "+this.weightUnit}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryPrice=function(e){var i=BX("PRICE_DELIVERY_"+this.index);if(!i){return}if(i.tagName==="INPUT"){i.value=e}else if(i.tagName==="TD"){i.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(e)}};BX.Sale.Admin.OrderShipment.prototype.setCalculatedPriceDelivery=function(e){var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(i.value!="Y"&&BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")return;var t=BX("PRICE_DELIVERY_"+this.index);if(t){var a=BX.findParent(t,{tag:"tbody"},true);var n=BX.findChildByClassName(a,"row_set_new_delivery_price");if(n)BX.remove(n)}BX("CALCULATED_PRICE_"+this.index).value=e;var r=BX.create("tr",{children:[BX.create("td",{html:BX.message("SALE_ORDER_SHIPMENT_NEW_PRICE_DELIVERY")+": ",props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(e)}),BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_APPLY"),props:{onclick:BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_SET_NEW_PRICE"))){BX("PRICE_DELIVERY_"+this.index).value=e;BX("BASE_PRICE_DELIVERY_"+this.index).value=e;var t=BX.findChildByClassName(a,"row_set_new_delivery_price");BX.remove(t);i.value="N";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}},this),className:"new_delivery_price_button"}})],props:{className:"adm-detail-content-cell-r"}})],props:{className:"row_set_new_delivery_price"}});a.appendChild(r)};BX.Sale.Admin.OrderShipment.prototype.setCalculatedWeightDelivery=function(e){var i=BX("CUSTOM_WEIGHT_DELIVERY_"+this.index);if(i.value!=="Y"&&BX.Sale.Admin.OrderEditPage.formId!=="order_shipment_edit_info_form")return;var t=BX("WEIGHT_DELIVERY_"+this.index);if(t){var a=BX.findParent(t,{tag:"tbody"},true);var n=BX.findChildByClassName(a,"row_set_new_delivery_weight");if(n){BX.remove(n)}}BX("CALCULATED_WEIGHT_"+this.index).value=e;var r=BX.create("tr",{children:[BX.create("td",{html:BX.message("SALE_ORDER_SHIPMENT_NEW_WEIGHT_DELIVERY")+": ",props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{children:[BX.create("span",{text:e+" "+this.weightUnit}),BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_APPLY"),props:{onclick:BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_SET_NEW_WEIGHT"))){BX("WEIGHT_DELIVERY_"+this.index).value=e;var t=BX.findChildByClassName(a,"row_set_new_delivery_weight");BX.remove(t);i.value="N";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}},this),className:"new_delivery_price_button"}})],props:{className:"adm-detail-content-cell-r"}})],props:{className:"row_set_new_delivery_weight"}});a.appendChild(r)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryInfo=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"changeDeliveryService",formData:e,index:this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.SHIPMENT_DATA);this.updateDeliveryLogotip();if(e.WARNING&&e.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.WARNING)}}},this)};if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,true);else BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,false)};BX.Sale.Admin.OrderShipment.prototype.getDeliveryPrice=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"getDefaultDeliveryPrice",formData:e,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);if(e.WARNING&&e.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.WARNING)}}},this)};var t=BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form";BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,t)};BX.Sale.Admin.OrderShipment.prototype.initCustomEvent=function(){BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(function(e){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{this.getDeliveryPrice()}},this))};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeAllowDelivery=function(){var e=BX("STATUS_ALLOW_DELIVERY_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var a=BX("BUTTON_ALLOW_DELIVERY_"+i[t]);if(!a)continue;var n=[];if(e.value=="Y"){n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","N",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e)},this)})}else{n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","Y",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e);this.initFieldChangeAllowDelivery()},this)})}var r=new BX.COpener({DIV:a.parentNode,MENU:n})}};BX.Sale.Admin.OrderShipment.prototype.setAllowDelivery=function(e){var i=e.status=="Y"?"YES":"NO";var t=["SHORT_"+this.index,this.index];var a=BX("STATUS_ALLOW_DELIVERY_"+this.index);a.value=e.status;for(var n in t){var r=BX("BUTTON_ALLOW_DELIVERY_"+t[n]);if(!r)continue;BX.html(r,BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_"+i));if(e.status=="Y")BX.removeClass(r,"notdelivery");else BX.addClass(r,"notdelivery")}this.initFieldChangeAllowDelivery()};BX.Sale.Admin.OrderShipment.prototype.setShipmentStatusList=function(e){this.shipment_statuses=e;this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.initFieldUpdateSum=function(){var e=BX("PRICE_DELIVERY_"+this.index);var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){i.value="Y";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{var t=BX("sale-order-shipment-discounts-row-"+this.index);if(t){BX.hide(t.previousElementSibling);BX.hide(t)}BX("CUSTOM_PRICE_DELIVERY_"+this.index).value="Y";BX("BASE_PRICE_DELIVERY_"+this.index).value=e.value}},this))};BX.Sale.Admin.OrderShipment.prototype.initFieldUpdateWeight=function(){var e=BX("WEIGHT_DELIVERY_"+this.index);var i=BX("CUSTOM_WEIGHT_DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){i.value="Y";if(BX.Sale.Admin.OrderEditPage.formId!=="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{BX("CUSTOM_WEIGHT_DELIVERY_"+this.index).value="Y"}},this))};BX.Sale.Admin.OrderShipment.prototype.initToggle=function(){var e=BX("SHIPMENT_SECTION_"+this.index);var i=BX("SHIPMENT_SECTION_SHORT_"+this.index);var t=BX("SHIPMENT_SECTION_"+this.index+"_TOGGLE");BX.bind(t,"click",BX.proxy(function(){t.innerHTML=i.style.display!="none"?BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE"):BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE_UP");BX.toggle(e);BX.toggle(i)},this))};BX.Sale.Admin.OrderShipment.prototype.initDeleteShipment=function(){var e=BX("SHIPMENT_SECTION_"+this.index+"_DELETE");BX.bind(e,"click",BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_DELETE_SHIPMENT"))){var e=BX("ID")?BX("ID").value:0;var i=BX("SHIPMENT_ID_"+this.index)?BX("SHIPMENT_ID_"+this.index).value:0;if(e>0&&i>0){var t={action:"deleteShipment",order_id:e,shipment_id:i,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);BX.cleanNode(BX("shipment_container_"+this.index));if(e.WARNING&&e.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.WARNING)}}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(t)}}},this))};BX.Sale.Admin.OrderShipment.prototype.showCreateCheckWindow=function(e){ShowWaitWindow();var i={action:"addCheckShipment",shipmentId:e,callback:BX.proxy(function(i){CloseWaitWindow();if(i.ERROR&&i.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(i.ERROR)}else{var t=i.HTML;var a=new BX.CAdminDialog({content:t,title:BX.message("SALE_ORDER_SHIPMENT_CASHBOX_CHECK_ADD_WINDOW_TITLE"),resizable:false,draggable:false,height:"100",width:"516",buttons:[{title:window.BX.message("JS_CORE_WINDOW_SAVE"),id:"saveCheckBtn",name:"savebtn",className:window.BX.browser.IsIE()&&window.BX.browser.IsDoctype()&&!window.BX.browser.IsIE10()?"":"adm-btn-save"},{title:window.BX.message("JS_CORE_WINDOW_CANCEL"),id:"cancelCheckBtn",name:"cancel"}]});a.Show();BX.bind(BX("checkTypeSelect"),"change",function(){var e=this.value;var i=e.indexOf("credit")!==-1;var t=BX.findParent(this,{tag:"tr"});var a=t.nextElementSibling;var n=BX.findChildren(a,{tag:"input"},true);for(var r in n){if(n.hasOwnProperty(r)){var s=n[r].nextElementSibling;if(i){BX.addClass(s,"bx-admin-service-restricted")}else{BX.removeClass(s,"bx-admin-service-restricted")}if(n[r].checked)n[r].click();n[r].disabled=i}}});BX.bind(BX("cancelCheckBtn"),"click",BX.delegate(function(){a.Close();a.DIV.parentNode.removeChild(a.DIV)}),this);BX.bind(BX("saveCheckBtn"),"click",BX.delegate(function(){ShowWaitWindow();var i=BX("check_shipment");var t={formData:BX.ajax.prepareForm(i),action:"saveCheck",sessid:BX.bitrix_sessid()};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:t,onsuccess:function(i){CloseWaitWindow();if(i.ERROR&&i.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(i.ERROR)}else{BX("SHIPMENT_CHECK_LIST_ID_"+e).innerHTML=i.CHECK_LIST_HTML;if(BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+e)!==undefined&&BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+e)!==null){BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+e).innerHTML=i.CHECK_LIST_HTML}a.Close();a.DIV.parentNode.removeChild(a.DIV)}},onfailure:function(e){CloseWaitWindow()}})}),this)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(i,true)};BX.Sale.Admin.OrderShipment.prototype.onCheckEntityChoose=function(e){var i=e.checked;var t=BX(e.id+"_type");if(t)t.disabled=!i};BX.Sale.Admin.OrderShipment.prototype.sendQueryCheckStatus=function(e){ShowWaitWindow();var i={action:"sendQueryCheckStatus",checkId:e,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}var i=e.SHIPMENT_ID;BX("SHIPMENT_CHECK_LIST_ID_"+i).innerHTML=e.CHECK_LIST_HTML;if(BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+i)!==undefined&&BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+i)!==null){BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+i).innerHTML=e.CHECK_LIST_HTML}CloseWaitWindow()},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(i,true)};BX.namespace("BX.Sale.Admin.GeneralShipment");BX.Sale.Admin.GeneralShipment={getIds:function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())},createNewShipment:function(e,i){i=i?i:{};addParams=BX.prop.getObject(i,"addParams",{});var t=BX("ID").value;url="/bitrix/admin/sale_order_shipment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+t+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search);if(addParams)url=BX.util.add_url_param(url,addParams);window.location=url},findProductByBarcode:function(e){BX.hide(e.parentNode);BX.show(e.parentNode.nextElementSibling)},refreshTrackingStatus:function(e,i,t){var a="";if(t){var n=BX("order_shipment_edit_info_form");if(n){var r=n.elements["SHIPMENT["+e+"][TRACKING_NUMBER]"];if(r&&r.value)a=r.value}}else{var s=BX("TRACKING_NUMBER_"+e+"_VIEW");if(s)a=s.innerHTML}if(!a){alert(BX.message("SALE_ORDER_SHIPMENT_TRACKING_S_EMPTY"));return}var d={action:"refreshTrackingStatus",shipmentId:i,trackingNumber:a,callback:function(i){if(i&&!i.ERROR){if(i.TRACKING_STATUS){var t=BX("sale-order-shipment-tracking-status-"+e);if(t)t.innerHTML=i.TRACKING_STATUS}if(i.TRACKING_DESCRIPTION){var a=BX("sale-order-shipment-tracking-description-"+e);if(a)a.innerHTML=i.TRACKING_DESCRIPTION}if(i.TRACKING_LAST_CHANGE){var n=BX("sale-order-shipment-tracking-last-change-"+e);if(n)n.innerHTML=i.TRACKING_LAST_CHANGE}if(i.WARNING&&i.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(i.WARNING)}}else if(i&&i.ERROR){BX.Sale.Admin.OrderEditPage.showDialog(i.ERROR)}else{BX.debug("Error refreshing tracking status!")}}};BX.Sale.Admin.OrderAjaxer.sendRequest(d)}};
//# sourceMappingURL=order_shipment.map.js