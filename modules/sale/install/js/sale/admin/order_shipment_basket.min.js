BX.Sale.Admin.ShipmentBasket=function(e){this.products=e.products;BX.Sale.Admin.OrderBasketEdit.apply(this,arguments);if(Object.keys(this.products).length==0){var t=BX(this.tableId);t.appendChild(this.createEmptyFooter())}};BX.Sale.Admin.ShipmentBasket.prototype=Object.create(BX.Sale.Admin.OrderBasketEdit.prototype);BX.Sale.Admin.ShipmentBasket.prototype.getProductBasketCode=function(e){return e.BASKET_ID};BX.Sale.Admin.ShipmentBasket.prototype.createEmptyFooter=function(){var e=BX.message("SALE_ORDER_SHIPMENT_VIEW_BASKET_NO_PRODUCTS");var t=Object.keys(this.visibleColumns).length+1;var a=BX.create("tbody",{props:{id:this.idPrefix+"_empty_footer"}});var r=BX.create("tr");var i=BX.create("td",{text:e});i.style.textAlign="center";i.style.fontSize="1.4em";i.colSpan=t;r.appendChild(i);a.appendChild(r);return a};BX.Sale.Admin.ShipmentBasket.prototype.createProductRow=function(e,t){var a,r={},i=this,s=BX.create("tbody",{props:{id:this.createProductRowId(e,t)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),n=BX.create("tr",{style:{"vertical-align":"top"}});if(t.IS_SET_ITEM!="Y"){s.setAttribute("data-basket-code",e);if(t.IS_SET_PARENT=="Y"&&t.OLD_PARENT_ID)s.setAttribute("data-old-parent-id-parent",t.OLD_PARENT_ID)}else{BX.addClass(s,"bundle-child-"+t.OLD_PARENT_ID);BX.addClass(s,"basket-bundle-child-hidden");BX.addClass(s,"bundle-child")}n.setAttribute("data-index",1);for(var d in this.visibleColumns){if(!this.visibleColumns.hasOwnProperty(d))continue;a=this.createProductCell(e,t,d,1);if(a)n.appendChild(a)}s.appendChild(n);return s};BX.Sale.Admin.ShipmentBasket.prototype.createSkuPropsTable=BX.Sale.Admin.OrderBasket.prototype.createSkuPropsTable;BX.Sale.Admin.ShipmentBasket.prototype.createProductCell=function(e,t,a,r){var i=null,s=[],n=this,d=t[a],o="",l=null,p=0,c=null;switch(a){case"NUMBER":s.push(BX.create("span",{props:{id:this.idPrefix+"sale_order_product_"+e+"_number"},text:this.index}));break;case"NAME":var h;if(t.IS_SET_PARENT=="Y"&&t.SET_ITEMS){var B=BX.create("a",{props:{href:"javascript:void(0);",className:"dashed-link show-set-link"},html:BX.message("SALE_ORDER_BASKET_EXPAND")});BX.bind(B,"click",function(e){var a=e.target||e.srcElement;n.onToggleBundleChildren(t.OLD_PARENT_ID,a)});s.push(BX.create("div",{children:[B]}))}if(t.EDIT_PAGE_URL)h=BX.create("a",{props:{href:t.EDIT_PAGE_URL,target:"_blank"},text:d});else h=BX.create("span",{text:d});s.push(h);break;case"QUANTITY":if(!!t.MEASURE_TEXT)s.push(document.createTextNode(" "+t.MEASURE_TEXT+" "));s.push(BX.create("span",{props:{},text:t.QUANTITY}));s.push(BX.create("input",{props:{id:e+"_quantity",type:"hidden",value:t.QUANTITY}}));break;case"AVAILABLE":s.push(BX.create("span",{text:d}));break;case"PRICE":s.push(BX.create("span",{text:" "+BX.Sale.Admin.OrderEditPage.currencyLang+" "}));var u=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"PRICE"),value:t.PRICE}});u.style.width="40px";s.push(u);break;case"SUM":s.push(BX.create("strong",{props:{id:this.idPrefix+"sale_order_edit_product_"+e+"_summ"},text:BX.Sale.Admin.OrderEditPage.currencyFormat(t.PRICE*t.QUANTITY)}));break;case"IMAGE":s.push(this.createFieldImage(e,t,a));o="adm-s-order-table-ddi-table-img";break;case"STORE":if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0){for(p in t.BARCODE_INFO){if(!t.BARCODE_INFO.hasOwnProperty(p))continue;for(l in t.STORES){if(!t.STORES.hasOwnProperty(l))continue;if(p==t.STORES[l].STORE_ID){s.push(BX.create("br"));s.push(BX.create("span",{text:t.STORES[l].STORE_NAME}));break}}}}else{s.push(BX.create("span"))}s.push(BX.create("span"));break;case"AMOUNT":if(!!t.MEASURE_TEXT){s.push(BX.create("span",{text:t.AMOUNT+" "+t.MEASURE_TEXT+" "}))}else{s.push(BX.create("span",{text:t.AMOUNT}))}break;case"CUR_AMOUNT":if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0){for(p in t.BARCODE_INFO){if(!t.BARCODE_INFO.hasOwnProperty(p))continue;var E=0;for(l in t.BARCODE_INFO[p]){if(t.BARCODE_INFO[p].hasOwnProperty(l))E+=parseFloat(t.BARCODE_INFO[p][l].QUANTITY)}var _=!!t.MEASURE_TEXT?t.MEASURE_TEXT:"";s.push(BX.create("br"));s.push(BX.create("span",{text:E+" "+_}))}}else{s.push(BX.create("span"))}break;case"REMAINING_QUANTITY":if(!!t.MEASURE_TEXT){s.push(BX.create("span",{text:" "+t.MEASURE_TEXT+" "}))}c=BX.create("span",{props:{id:e+"_store_remaining_quantity_"+r,className:e+"_store_remaining_quantity"},text:t.STORES.length>0&&t.STORES[0].hasOwnProperty("AMOUNT")?t.STORES[0].AMOUNT:"0"});s.push(c);break;case"BARCODE":if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0){for(l in t.BARCODE_INFO){if(!t.BARCODE_INFO.hasOwnProperty(l))continue;if(t.BARCODE_MULTI=="Y"){c=BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE"),style:{cursor:"pointer","border-bottom":"1px dashed"}});var S=BX.create("div");var m=true;for(var f in t.BARCODE_INFO[l]){if(!t.BARCODE_INFO[l].hasOwnProperty(f))continue;if(t.BARCODE_INFO[l][f].BARCODE=="")continue;m=false;var v=BX.create("div",{props:{className:"barcode_record"}});v.style.marginTop="5px";v.style.marginLeft="16px";v.appendChild(BX.create("span",{props:{class:"barcode"},text:BX.util.htmlspecialchars(t.BARCODE_INFO[l][f].BARCODE)}));S.appendChild(v)}if(m)S=BX.create("div",{text:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE_EMPTY")});var O=function(e,t){BX.bind(t,"click",BX.proxy(function(){var t=new BX.CDialog({content:e,title:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE"),width:180,height:220,resizable:false,buttons:[new BX.CWindowButton({title:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE_CLOSE"),action:function(){BX.WindowManager.Get().Close()},className:"btnCloseBarcodeDialog"})]});t.Show()},this))};O(S,c);s.push(BX.create("br"));s.push(c)}else{s.push(BX.create("span",{html:BX.util.htmlspecialchars(t.BARCODE_INFO[l][0].BARCODE)+"<br>"}))}}}else{s.push(BX.create("span"))}break;case"PROPS":var A=this.createFieldSkuProps(e,t,a);if(A)s.push(A);else s.push(BX.create("span"));break}if(a.indexOf("PROPERTY_")===0){var X;if(t.PRODUCT_PROPS_VALUES&&t.PRODUCT_PROPS_VALUES[a+"_VALUE"])X=t.PRODUCT_PROPS_VALUES[a+"_VALUE"];else X="";s.push(BX.create("span",{html:X}))}if(s.length>0){i=BX.create("td");BX.addClass(i,a);switch(a){case"IMAGE":i.style.textAlign="center";break;case"NUMBER":i.style.textAlign="center";i.style.width="30px";break;case"NAME":i.style.textAlign="left";break;case"QUANTITY":case"REMAINING_QUANTITY":case"CUR_AMOUNT":case"AMOUNT":i.style.textAlign="right";break;case"BARCODE":case"STORE":i.style.paddingLeft="20px"}if(o)BX.addClass(i,o);while(s.length>0){var C=s.pop();if(!!C)i.appendChild(C)}}return i};BX.Sale.Admin.ShipmentBasket.prototype.createFieldImage=function(e,t,a){var r,i;if(t.PICTURE_URL){r=BX.create("img",{props:{src:t.PICTURE_URL}})}else{r=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}i=BX.create("span",{children:[r]});return i};BX.Sale.Admin.ShipmentBasketEdit=function(e){this.link=e.link;this.shipment=null;this.products=e.products;this.isShipped=!!e.isShipped;this.useStoreControl=e.useStoreControl||false;BX.Sale.Admin.OrderBasketEdit.apply(this,arguments);this.index=0;this.basket=null;this.productsOrder=e.productsOrder;this.updateShipmentTimer=null;this.removeEmptyFooter(this.idPrefix);if(Object.keys(this.products).length==0){var t=BX(this.tableId);t.appendChild(this.createEmptyFooter())}this.initGroupActions()};BX.Sale.Admin.ShipmentBasketEdit.prototype=Object.create(BX.Sale.Admin.OrderBasketEdit.prototype);BX.Sale.Admin.ShipmentBasketEdit.prototype.createProductCell=function(e,t,a,r){var i=null,s=[],n=this,d=t[a],o="",l=[],p=null,c=this.useStoreControl&&!!t.STORES&&t.STORES.length>0;switch(a){case"NUMBER":if(t.IS_SET_PARENT=="Y"&&t.SET_ITEMS>0||t.IS_SET_PARENT&&t.IS_SET_ITEM=="N"||!t.MODULE){s.push(BX.create("span",{props:{id:this.idPrefix+"sale_order_product_"+e+"_number"},text:this.index}))}else{s.push(BX.create("span"))}break;case"NAME":var h;if(t.IS_SET_PARENT=="Y"&&t.SET_ITEMS){var B=BX.create("a",{props:{href:"javascript:void(0);",className:"dashed-link show-set-link"},html:BX.message("SALE_ORDER_BASKET_EXPAND")});BX.bind(B,"click",function(e){var a=e.target||e.srcElement;n.onToggleBundleChildren(t.OLD_PARENT_ID,a)});s.push(BX.create("div",{children:[B]}))}if(t.EDIT_PAGE_URL)h=BX.create("a",{props:{href:t.EDIT_PAGE_URL,target:"_blank"},text:d});else h=BX.create("span",{text:d});s.push(h);break;case"QUANTITY":if(!!t.MEASURE_TEXT)s.push(document.createTextNode(" "+t.MEASURE_TEXT+" "));s.push(BX.create("span",{props:{},text:t.QUANTITY}));s.push(BX.create("input",{props:{id:e+"_quantity",name:this.getFieldName(e,"QUANTITY"),type:"hidden",value:t.QUANTITY}}));break;case"AVAILABLE":s.push(BX.create("span",{text:d}));break;case"IMAGE":s.push(this.createFieldImage(e,t,a));o="adm-s-order-table-ddi-table-img";break;case"AMOUNT":s=this.createFieldAmount(s,t);break;case"STORE":if(t.IS_SET_PARENT!="Y"&&c){l=[this.createBlockStore(e,t,r)];if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0)l=this.recoveryDeliveryStore(t,l[0]);if(this.isShipped){for(p in l){if(!l.hasOwnProperty(p))continue;var u=BX.findChild(l[p],{tag:"select"},true);u.parentNode.appendChild(BX.create("input",{props:{type:"hidden",name:u.getAttribute("name"),value:u.options[u.selectedIndex].value}}))}}if(t.STORES){var E=BX.create("span",{props:{className:"adm-bus-shipment-basket-store-add"},text:BX.message("SALE_ORDER_SHIPMENT_BASKET_ADD_NEW_STORE")});var _=t.STORES.length;if(_<2||l.length==_)BX.hide(E);BX.bind(E,"click",BX.proxy(function(){if(this.isShipped){BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_ERROR_ALREADY_SHIPPED"));return}var e=BX.findParent(E,{tag:"tr"},true);var a=BX.findChildByClassName(e,"STORE");var r=BX.findChildren(a,{tag:"div"});var i=r.length+1;for(var s in r){if(!r.hasOwnProperty(s))continue;var n=r[s].getAttribute("data-index");if(n==i)i++}var d=this.createBlockStore(this.getProductBasketCode(t),t,i);a.insertBefore(d,E);var o=BX.findChildByClassName(e,"CUR_AMOUNT");var l=this.createBlockCurAmount(this.getProductBasketCode(t),t,i);o.appendChild(l);var p=BX.findChildByClassName(e,"REMAINING_QUANTITY");var c=this.createBlockRemainingQuantity(this.getProductBasketCode(t),t,i);p.appendChild(c);var h=BX.findChildByClassName(e,"BARCODE");var B=this.createBlockBarcode(this.getProductBasketCode(t),t,i);h.appendChild(B);if(t["STORES"].length<i+1)BX.hide(E)},this));l.push(E)}for(p in l){if(l.hasOwnProperty(p))s.unshift(l[p])}}else{s.push(BX.create("span"))}break;case"CUR_AMOUNT":if(t.IS_SET_PARENT!="Y"&&c){l=[this.createBlockCurAmount(e,t,r)];if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0)l=this.recoveryDeliveryCurAmount(t,l[0]);for(p in l){if(l.hasOwnProperty(p))s.unshift(l[p])}}else{s.push(BX.create("span"))}break;case"REMAINING_QUANTITY":if(t.IS_SET_PARENT!="Y"&&t.MODULE&&c){l=[this.createBlockRemainingQuantity(e,t,r)];if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0)l=this.recoveryRemainingQuantity(t,l[0]);for(p in l){if(l.hasOwnProperty(p))s.unshift(l[p])}}else{s.push(BX.create("span"))}break;case"BARCODE":if(t.IS_SET_PARENT!="Y"&&c){l=[this.createBlockBarcode(e,t,r)];if(!!t.BARCODE_INFO&&Object.keys(t.BARCODE_INFO).length>0)l=this.recoveryBarcode(t,l[0]);for(p in l){if(l.hasOwnProperty(p))s.unshift(l[p])}}else{s.push(BX.create("span"))}break;case"PROPS":var S=this.createFieldSkuProps(e,t,a);if(S)s.push(S);else s.push(BX.create("span"));break}if(a.indexOf("PROPERTY_")===0){if(t.PRODUCT_PROPS_VALUES&&t.PRODUCT_PROPS_VALUES[a+"_VALUE"])s.push(BX.create("span",{html:t.PRODUCT_PROPS_VALUES[a+"_VALUE"]}))}if(s.length>0){i=BX.create("td");BX.addClass(i,a);switch(a){case"NUMBER":i.style.width="45px";i.style.textAlign="center";break;case"NAME":case"STORE":i.style.textAlign="left";break;case"QUANTITY":case"REMAINING_QUANTITY":case"AMOUNT":case"CUR_AMOUNT":i.style.textAlign="right";break;case"IMAGE":case"BARCODE":i.style.textAlign="center";break}if(o)BX.addClass(i,o);while(s.length>0){var m=s.pop();if(!!m)i.appendChild(m)}}return i};BX.Sale.Admin.ShipmentBasketEdit.prototype.createFieldAmount=function(e,t){var a=this.getProductBasketCode(t);if(!!t.MEASURE_TEXT){e.push(BX.create("span",{text:" "+t.MEASURE_TEXT+" "}))}var r=BX.create("input",{props:{type:"text",name:this.getFieldName(a,"AMOUNT"),value:t.AMOUNT,id:a+"_amount",autocomplete:"off"},attrs:{readOnly:this.isShipped},style:{width:"25px"}});BX.bind(r,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)r.blur()});if(t.IS_SET_ITEM=="Y")r.readOnly=true;BX.bind(r,"change",BX.proxy(function(){if(t.IS_SET_PARENT=="Y"){var e=t.SET_ITEMS;for(var a in e){if(!e.hasOwnProperty(a))continue;var i=this.getProductBasketCode(e[a]);var s=BX(i+"_"+"amount");s.value=t.BASE_ELEMENTS_QUANTITY[e[a].OFFER_ID]*r.value}}var n=BX.findParent(r,{tag:"tr"},true);var d=BX.findChildrenByClassName(n,this.getProductBasketCode(t)+"_cur_amount",true);if(!!t.STORES&&t.STORES.length==1)d[0].value=r.value;this.updateShipment()},this));e.push(r);return e};BX.Sale.Admin.ShipmentBasketEdit.prototype.recoveryDeliveryStore=function(e,t){var a=[t];var r=1;for(var i in e.BARCODE_INFO){if(!e.BARCODE_INFO.hasOwnProperty(i))continue;var s=a[a.length-1];var n=BX.findChild(s,{tag:"select"},true);if(n){for(var d in n.options){if(!n.options.hasOwnProperty(d))continue;var o=n.options[d];if(o.value==i){n.options[d].selected=true;break}}if(Object.keys(e.BARCODE_INFO).length>r){var l=this.createBlockStore(this.getProductBasketCode(e),e,++r);a.push(l)}}}return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.recoveryDeliveryCurAmount=function(e,t){var a=[t];var r=1;var i=this.getProductBasketCode(e);for(var s in e.BARCODE_INFO){if(!e.BARCODE_INFO.hasOwnProperty(s))continue;var n=a[a.length-1];var d=e["BARCODE_INFO"][s];for(var o in d){if(!d.hasOwnProperty(o))continue;var l=BX.findChildByClassName(n,i+"_cur_amount",true);if(e.BARCODE_MULTI=="N"){l.value=d[o].QUANTITY}else{if(o==0)l.value=0;l.value=parseFloat(l.value)+parseFloat(d[o].QUANTITY)}}if(Object.keys(e.BARCODE_INFO).length>r){var p=this.createBlockCurAmount(this.getProductBasketCode(e),e,++r);a.push(p)}}return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.recoveryRemainingQuantity=function(e,t){var a=[t];var r=1;var i=this.getProductBasketCode(e);for(var s in e.BARCODE_INFO){if(!e.BARCODE_INFO.hasOwnProperty(s))continue;var n=a[a.length-1];var d=BX.findChildByClassName(n,i+"_store_remaining_quantity");for(var o in e["STORES"]){if(!e["STORES"].hasOwnProperty(o))continue;if(e["STORES"][o].STORE_ID==s){d.innerHTML=e["STORES"][o].AMOUNT;break}}if(Object.keys(e.BARCODE_INFO).length>r)a.push(this.createBlockRemainingQuantity(this.getProductBasketCode(e),e,++r))}return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.recoveryBarcode=function(e,t){var a=[t];var r=1;var i=this.getProductBasketCode(e);for(var s in e["BARCODE_INFO"]){if(!e["BARCODE_INFO"].hasOwnProperty(s))continue;console.log("recoveryBarcode");var n=a[a.length-1];var d=e["BARCODE_INFO"][s];var o=BX.findChildByClassName(n,"hidden_barcode_block_"+r);if(o)BX.remove(o);if(e.BARCODE_MULTI=="Y"){o=BX.create("div",{props:{className:"hidden_barcode_block_"+r},style:{display:"none"}})}for(var l in d){if(!d.hasOwnProperty(l))continue;if(e.BARCODE_MULTI=="N"){var p=BX.findChildByClassName(n,i+"_barcode_value");p.value=!!d[l].BARCODE?d[l].BARCODE:"";var c=BX.findChildByClassName(n,i+"_barcode_id");c.value=!!d[l].ID?d[l].ID:0}else{var h=BX.create("input",{props:{type:"hidden",name:this.getFieldName(i,"BARCODE_INFO")+"["+r+"][BARCODE]["+l+"][VALUE]",className:i+"_barcode_value",value:!!d[l].BARCODE?d[l].BARCODE:""}});var B=BX.create("input",{props:{type:"hidden",name:this.getFieldName(i,"BARCODE_INFO")+"["+r+"][BARCODE]["+l+"][ID]",className:i+"_barcode_id",value:!!d[l].ID?d[l].ID:0}});o.appendChild(B);o.appendChild(h)}}if(e.BARCODE_MULTI=="Y")n.appendChild(o);if(Object.keys(e.BARCODE_INFO).length>r)a.push(this.createBlockBarcode(this.getProductBasketCode(e),e,++r))}return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.createEmptyFooter=function(){var e=BX.message("SALE_ORDER_SHIPMENT_BASKET_NO_PRODUCTS");var t=Object.keys(this.visibleColumns).length+2;var a=BX.create("tbody",{props:{id:this.idPrefix+"_empty_footer"},children:[BX.create("tr",{children:[BX.create("td",{text:e,attrs:{colspan:t},style:{"text-align":"center","font-size":"1.4em"}})]})]});return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.moveToSystemBasket=function(e){if(this.isShipped){BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_ERROR_ALREADY_SHIPPED"));return}var t=null;this.link.products[e]=this.products[e];delete this.products[e];var a=BX(this.idPrefix+"sale-order-basket-product-"+e);if(a){t=a.parentNode;if(t)t.removeChild(a)}var r=a.getAttribute("data-old-parent-id-parent");if(r){var i=BX.findChildrenByClassName(t,"bundle-child-"+r,false);for(var s in i){if(!i.hasOwnProperty(s))continue;i[s].parentNode.removeChild(i[s])}}this.removeEmptyFooter(this.idPrefix);if(Object.keys(this.products).length==0){var n=BX(this.tableId);n.appendChild(this.createEmptyFooter())}this.setRowNumbers();this.updateCountBasketItems();this.updateShipment()};BX.Sale.Admin.ShipmentBasketEdit.prototype.updateShipment=function(){var e=this;if(this.updateShipmentTimer)clearTimeout(this.updateShipmentTimer);this.updateShipmentTimer=setTimeout(BX.proxy(function(){e.shipment.updateDeliveryInfo()},this),2e3)};BX.Sale.Admin.ShipmentBasketEdit.prototype.removeEmptyFooter=function(e){var t=BX(e+"_empty_footer");if(t)BX.remove(t)};BX.Sale.Admin.ShipmentBasketEdit.prototype.productSet=function(e,t){var a=BX(this.tableId);var r=this.getProductBasketCode(e);a.appendChild(this.productAdd(e));if(e.IS_SET_ITEM!="Y")this.setProductsCount(++this.productsCount);if(e.SET_ITEMS&&e.SET_ITEMS.length)for(var i=e.SET_ITEMS.length-1;i>=0;i--)this.productSet(e.SET_ITEMS[i],true);this.setRowNumbers();this.updateCountBasketItems()};BX.Sale.Admin.ShipmentBasketEdit.prototype.productAdd=function(e){var t=this.getProductBasketCode(e);var a=BX(this.createProductRowId(t,e));if(a)BX.remove(a);return this.createProductRow(t,e)};BX.Sale.Admin.ShipmentBasketEdit.prototype.createDivWrapper=function(e,t,a){var r=this.getDivWrapperClassName(e,t,a);var i=BX.create("div",{props:{className:r},style:{height:"29px"}});i.setAttribute("data-index",a);if(a>1)i.style.marginTop="5px";return i};BX.Sale.Admin.ShipmentBasketEdit.prototype.getDivWrapperClassName=function(e,t,a){var r=this.getProductBasketCode(e);var i=t+"-"+r+"-"+a;if(e.OLD_PARENT_ID)i+="-"+e.OLD_PARENT_ID;return i};BX.Sale.Admin.ShipmentBasketEdit.prototype.createBlockStore=function(e,t,a){if(!!t.STORES&&t.STORES.length>0){var r=this.createDivWrapper(t,"store",a);BX.addClass(r,"barcode_record");var i=BX.create("select",{props:{name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][STORE_ID]",className:"store_select, "+e+"_select_store_"+a},attrs:{disabled:this.isShipped},style:{width:"175px"}});for(var s in t.STORES){if(!t.STORES.hasOwnProperty(s))continue;var n=BX.create("option",{props:{value:t.STORES[s].STORE_ID},text:t.STORES[s].STORE_NAME});i.appendChild(n)}BX.bind(i,"change",BX.proxy(function(){var r=i.options[i.selectedIndex].value;var s=BX(e+"_store_remaining_quantity_"+a);for(var n in t.STORES){if(!t.STORES.hasOwnProperty(n))continue;if(t.STORES[n].STORE_ID==r)s.innerHTML=t.STORES[n].AMOUNT}},this));r.appendChild(i);if(Object.keys(t.STORES).length>1){var d=BX.create("div",{props:{className:"btdel"}});BX.bind(d,"click",BX.proxy(function(){var e=BX.findParent(d,{tag:"div"});var a=e.getAttribute("data-index");var r=BX.findParent(d,{tag:"tr"},true);var i=BX.findChildrenByClassName(r,"barcode_record",true);if(i.length<=1)return;if(t["STORES"].length<a+1){var s=BX.findChildByClassName(r,"adm-bus-shipment-basket-store-add");s.style.display="inline"}var n=["store","remaining_quantity","cur_amount","barcode"];for(var o in n){if(!n.hasOwnProperty(o))continue;var l=BX.findChildByClassName(r,this.getDivWrapperClassName(t,n[o],a),true);if(l)BX.remove(l)}var p=0;var c=BX.findChildrenByClassName(r,this.getProductBasketCode(t)+"_cur_amount",true);for(o in c){if(c.hasOwnProperty(o))p+=parseFloat(c[o].value)}var h=BX(this.getProductBasketCode(t)+"_amount");if(p>parseFloat(h.value)){for(o in c){if(c.hasOwnProperty(o))BX.addClass(c[o],"adm-bus-shipment-basket-error")}}else{for(o in c){if(c.hasOwnProperty(o)&&BX.hasClass(c[o],"adm-bus-shipment-basket-error"))BX.removeClass(c[o],"adm-bus-shipment-basket-error")}}},this));r.appendChild(d)}return r}else{return BX.create("span")}};BX.Sale.Admin.ShipmentBasketEdit.prototype.createBlockRemainingQuantity=function(e,t,a){var r=this.createDivWrapper(t,"remaining_quantity",a);var i=null;if(!!t.MEASURE_TEXT){i=BX.create("span",{text:" "+t.MEASURE_TEXT+" "})}var s=BX.create("span",{props:{id:e+"_store_remaining_quantity_"+a,className:e+"_store_remaining_quantity"},text:!!t.STORES&&t.STORES.length>0&&t.STORES[0].hasOwnProperty("AMOUNT")?t.STORES[0].AMOUNT:"0"});r.appendChild(s);if(i)r.appendChild(i);return r};BX.Sale.Admin.ShipmentBasketEdit.prototype.createBlockCurAmount=function(e,t,a){if(!t.MODULE)return BX.create("span");var r=this.createDivWrapper(t,"cur_amount",a);var i=null;if(!!t.MEASURE_TEXT)i=BX.create("span",{text:" "+t.MEASURE_TEXT+" "});var s=BX(e+"_amount");if(!!s){var n=BX.findParent(s,{tag:"tr"},true);var d=BX.findChildrenByClassName(n,e+"_cur_amount",true);var o=parseFloat(s.value);var l=0;for(var p in d){if(d.hasOwnProperty(p))l+=parseFloat(d[p].value)}var c=l>=o?0:o-l}else{c=t.AMOUNT}var h=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][QUANTITY]",value:c,className:e+"_cur_amount",id:e+"_cur_amount_"+a,autocomplete:"off"},attrs:{readOnly:this.isShipped},style:{width:"25px"}});BX.bind(h,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)h.blur()});BX.bind(h,"change",BX.proxy(function(){var a=BX.findParent(h,{tag:"tr"},true);var r=BX.findChildrenByClassName(a,e+"_cur_amount",true);var i=BX(e+"_amount");if(!!t.STORES&&t.STORES.length==1&&t.IS_SET_ITEM!="Y")i.value=r[0].value},this));r.appendChild(h);if(i)r.appendChild(i);return r};BX.Sale.Admin.ShipmentBasketEdit.prototype.createBlockBarcode=function(e,t,a){if(!!t.IS_SET_PARENT&&t.IS_SET_PARENT!="Y"&&!!t.MODULE){var r=this.createDivWrapper(t,"barcode",a);if(t.BARCODE_MULTI=="N"){var i=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][BARCODE][1][VALUE]",className:e+"_barcode_value",value:""},attrs:{readOnly:this.isShipped}});BX.bind(i,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)i.blur()});var s=BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][BARCODE][1][ID]",className:e+"_barcode_id",value:0},attrs:{readOnly:this.isShipped}});BX.bind(i,"change",BX.proxy(function(){var e=i.value;if(e.length==0){i.style.borderColor="";return}var r=BX.findParent(i,{tag:"tr"},true);var s=BX.findChildByClassName(r,this.getDivWrapperClassName(t,"store",a),true);var n=s.firstChild;var d=t.BARCODE_MULTI=="Y"?n.value:0;var o={action:"checkProductBarcode",basketId:t.BASKET_ID,storeId:d,orderId:BX("order_id").value,barcode:i.value,callback:function(e){i.style.borderColor=e.ERROR&&e.ERROR.length>0?"#f00":"#0f0"}};BX.Sale.Admin.OrderAjaxer.sendRequest(o,true,false)},this));r.appendChild(i);r.appendChild(s)}else{var n=BX.create("input",{props:{type:"button",value:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE")}});r.appendChild(n);var d=BX.create("div",{props:{id:"block_barcode_"+e+"_"+a}});BX.bind(n,"click",BX.proxy(function(){var r=BX.findChildren(d,{tag:"div"});for(var i in r)BX.remove(r[i]);var s=BX(e+"_cur_amount_"+a);var o=s.value;var l=0;var p=BX.findParent(n,{tag:"tr"},true);var c=BX.findChildByClassName(p,"hidden_barcode_block_"+a,true);if(c){var h=BX.findChildrenByClassName(c,e+"_barcode_id");l=h.length}if(o>l)l=o;var B=BX.findParent(n,{tag:"td"});B=BX.findChildByClassName(B,"hidden_barcode_block_"+a);var u=BX.findChildrenByClassName(B,e+"_barcode_id");var E=BX.findChildrenByClassName(B,e+"_barcode_value");var _=1;if(l==0)l=1;while(_<=l){var S=BX.create("div",{props:{className:"barcode_record"}});S.style.marginTop="5px";S.style.marginLeft="36px";var m=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][BARCODE]["+_+"][VALUE]",className:e+"_barcode_value",value:E&&E[_-1]?E[_-1].value:""},attrs:{readOnly:this.isShipped}});BX.bind(m,"keydown",function(t){if(!t)t=window.event;if(!t)return;if(t.keyCode==13){var a=this.parentElement.nextElementSibling;if(a){var r=BX.findChildByClassName(a,e+"_barcode_value");r.focus()}}});if(E&&E[_-1])m.style.borderColor=E[_-1].style.borderColor;var f=function(r,i){BX.bind(r,"change",function(){var s=r.value;if(s.length==0){r.style.borderColor="";return}var o=BX.findChildrenByClassName(d,e+"_barcode_value",true);var l=0;for(var p in o){if(o.hasOwnProperty(p)&&o[p].value==s)l++}if(l>=2){r.style.borderColor="#f00";BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE_ALREADY_USED"));return}var c=BX.findParent(n,{tag:"tr"},true);var h=BX.findChildByClassName(c,i.getDivWrapperClassName(t,"store",a),true);var B=h.firstChild;var u={action:"checkProductBarcode",basketId:t.BASKET_ID,storeId:BX(B).value,orderId:BX("order_id").value,barcode:r.value,callback:function(e){if(e.ERROR&&e.ERROR.length>0)r.style.borderColor="#f00";else r.style.borderColor="#0f0"}};BX.Sale.Admin.OrderAjaxer.sendRequest(u,true,false)});BX.bind(r,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)r.blur()})};f(m,this);var v=BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,"BARCODE_INFO")+"["+a+"][BARCODE]["+_+"][ID]",className:e+"_barcode_id",value:u&&u[_-1]?u[_-1].value:0},style:{width:"135px"}});var O=BX.create("span",{props:{class:"barcode"}});var A=BX.create("div",{props:{className:"btdel"}});var X=function(t,a){BX.bind(t,"click",function(){var t=BX.findChildrenByClassName(d,e+"_barcode_id",true);if(parseInt(o)<t.length){BX.remove(a)}else{var r=BX.findChildren(a,{tag:r},true);r[0].value="";r[1].value=""}})};X(A,S);S.appendChild(O);S.appendChild(m);S.appendChild(v);S.appendChild(A);d.appendChild(S);_++}var C=this.barcodeDialog=new BX.CDialog({content:d,title:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE_ENTER"),width:280,height:250,resizable:false,buttons:[new BX.CWindowButton({title:BX.message("SALE_ORDER_SHIPMENT_BASKET_BARCODE_CLOSE"),action:BX.proxy(function(){var t=BX("block_barcode_"+e+"_"+a);var r=BX.findChildren(t,{tag:"input"},true);var i=BX.create("div",{props:{className:"hidden_barcode_block_"+a}});i.style.display="none";for(var s in r){if(r.hasOwnProperty(s)){var d=r[s].cloneNode(false);i.appendChild(d)}}var o=BX.findParent(n,{tag:"div"});var l=BX.findChildByClassName(o,"hidden_barcode_block_"+a);if(l)l.remove();o.appendChild(i);BX.WindowManager.Get().Close()},this),className:"btnCloseBarcodeDialog"})]});this.barcodeDialog.Show()},this))}return r}else{return BX.create("span")}};BX.Sale.Admin.ShipmentBasketEdit.prototype.createProductMenuContent=function(e){return[{ICON:"delete",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_DELETE"),ACTION:this.objName+'.moveToSystemBasket("'+e+'")'}]};BX.Sale.Admin.ShipmentBasketEdit.prototype.createProductRow=function(e,t){var a,r={},i=this,s=BX.create("tbody",{props:{id:this.createProductRowId(e,t)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),n=this.createMenuCell(e,t),d=BX.create("tr",{style:{"vertical-align":"top"}});if(t.IS_SET_ITEM!="Y"){var o=this.createHiddenFields(e,t);s.setAttribute("data-basket-code",e);if(t.IS_SET_PARENT=="Y"&&t.OLD_PARENT_ID)s.setAttribute("data-old-parent-id-parent",t.OLD_PARENT_ID)}else{BX.addClass(s,"bundle-child-"+t.OLD_PARENT_ID);BX.addClass(s,"basket-bundle-child-hidden");BX.addClass(s,"bundle-child")}d.setAttribute("data-index",1);if(this.createProductBasement)n.rowSpan=2;d.appendChild(n);d.appendChild(this.createCheckboxField(t));for(var l in this.visibleColumns){if(!this.visibleColumns.hasOwnProperty(l))continue;a=this.createProductCell(e,t,l,1);if(a)d.appendChild(a)}s.appendChild(d);return s};BX.Sale.Admin.ShipmentBasketEdit.prototype.createCheckbox=function(e,t){var a=BX.create("input",{props:{type:"checkbox",className:"checkboxForDelete"},style:{margin:"0"}});a.readOnly=this.isShipped;a.setAttribute("data-basket-code",e);BX.bind(a,"click",BX.proxy(function(){var e=BX(this.idPrefix+"_selected_count");if(!e)return;var t=parseInt(e.innerHTML);var r=BX("action_delete_button");if(!!a.checked)e.innerHTML=++t;else e.innerHTML=--t;if(t<=0)BX.addClass(r,"adm-edit-disable");else BX.removeClass(r,"adm-edit-disable")},this));return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.createCheckboxField=function(e){var t=this.getProductBasketCode(e);var a=BX.create("td");if(e.IS_SET_PARENT=="Y"&&e.SET_ITEMS>0||e.IS_SET_PARENT&&e.IS_SET_ITEM=="N"||!e.MODULE){a.appendChild(this.createCheckbox(t,e))}var r=["MODULE","PRODUCT_ID","OFFER_ID","ORDER_DELIVERY_BASKET_ID","BASKET_ID"];for(var i in r){if(!r.hasOwnProperty(i))continue;if(e[r[i]]){a.appendChild(BX.create("input",{props:{type:"hidden",name:this.getFieldName(t,r[i]),value:e[r[i]]}}))}}return a};BX.Sale.Admin.ShipmentBasketEdit.prototype.createMenuCell=function(e,t){var a,r=this.createProductMenuContent(e);if(r.length<=0)return false;if(t.IS_SET_ITEM!="Y"){a=BX.create("span",{props:{className:"adm-s-order-item-title-icon"}});BX.bind(a,"click",BX.proxy(function(e){a.blur();BX.adminList.ShowMenu(a,r)},this))}else{a=BX.create("span",{html:"&nbsp;"})}return BX.create("td",{props:{className:"tac",id:this.idPrefix+"sale-order-basket-product-"+e+"-menu"},children:[a]})};BX.Sale.Admin.ShipmentBasketEdit.prototype.updateCountBasketItems=function(){var e=BX(this.idPrefix+"_count");var t=BX(this.tableId);var a=0;var r=null;if(e){for(var i=0,s=t.tBodies.length;i<s;i++){if(BX.hasClass(t.tBodies[i],"bundle-child"))continue;if(r=t.tBodies[i].getAttribute("data-basket-code"))a++}e.innerHTML=a}};BX.Sale.Admin.ShipmentBasketEdit.prototype.getProductBasketCode=function(e){return e.BASKET_ID};BX.Sale.Admin.ShipmentBasketEdit.prototype.groupMoveToSystemBasket=function(e){var t=BX("action_target");var a=null;if(t.checked){if(confirm(BX.message("SALE_ORDER_SHIPMENT_BASKET_ALL_PRODUCTS_DEL"))){for(a in this.products){if(this.products.hasOwnProperty(a)&&!!this.products[a]){var r=this.getProductBasketCode(this.products[a]);this.moveToSystemBasket(r);var i=BX(this.createProductRowId(r,this.products[a]));BX.remove(i)}}BX.addClass(e,"adm-edit-disable")}}else{var s=BX(this.tableId);var n=BX.findChildrenByClassName(s,"checkboxForDelete",true);if(!BX.hasClass(e,"adm-edit-disable")&&confirm(BX.message("SALE_ORDER_SHIPMENT_BASKET_SELECTED_PRODUCTS_DEL"))){var d=BX(this.idPrefix+"_selected_count");for(a in n){if(n.hasOwnProperty(a)&&!!n[a].checked)this.moveToSystemBasket(n[a].getAttribute("data-basket-code"))}BX.html(d,"0");BX.addClass(e,"adm-edit-disable")}}};BX.Sale.Admin.ShipmentBasketEdit.prototype.getFieldName=function(e,t){return"SHIPMENT[1][PRODUCT]["+e+"]["+t+"]"};BX.Sale.Admin.ShipmentBasketEdit.prototype.initGroupActions=function(){var e=BX("action_target");BX.bind(e,"change",function(){var e=BX("action_delete_button");if(!this.checked)BX.addClass(e,"adm-edit-disable");else BX.removeClass(e,"adm-edit-disable")})};BX.Sale.Admin.ShipmentBasketEdit.prototype.addRowEmptyBasket=function(){var e=BX.create("tbody",{props:{id:"row_empty_basket"}});var t=0;BX.appendChild(e,BX.create("tr"));for(var a in this.visibleColumns){++t;BX.append(tr,BX.create("td"))}tr.colspan=t;return tr};BX.Sale.Admin.ShipmentBasketEdit.prototype.createFieldImage=function(e,t,a){var r,i;if(t.PICTURE_URL){r=BX.create("img",{props:{src:t.PICTURE_URL}})}else{r=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}i=BX.create("span",{children:[r]});return i};BX.Sale.Admin.ShipmentBasketEdit.prototype.checkProductByBarcode=function(e){if(this.isShipped){BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_ERROR_ALREADY_SHIPPED"));return}var t=e.previousElementSibling.value;var a={action:"getProductIdByBarcode",barcode:t,callback:BX.proxy(function(t){if(t.ERROR&&t.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(t.ERROR)}else{var a=parseInt(t.RESULT.PRODUCT_ID);var r=false;for(var i in this.link.products){if(!this.link.products.hasOwnProperty(i))continue;if(this.link.products[i].OFFER_ID==a){this.products[i]=this.link.products[i];delete this.link.products[i];this.productSet(this.products[i],false);this.removeEmptyFooter(this.idPrefix);this.updateCountBasketItems();r=true;break}}if(!r)BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_ERROR_NOT_FOUND"))}e.previousElementSibling.value=""},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(a)};BX.Sale.Admin.SystemShipmentBasketEdit=function(e){this.products=e.products;this.tableId=e.tableId;this.objName=e.objName;this.idPrefix=e.idPrefix;this.productsOrder=e.productsOrder;this.visibleColumns=e.visibleColumns};BX.Sale.Admin.SystemShipmentBasketEdit.prototype=Object.create(BX.Sale.Admin.ShipmentBasketEdit.prototype);BX.Sale.Admin.SystemShipmentBasketEdit.prototype.addProductSearch=function(){if(this.link.isShipped){BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_SHIPMENT_BASKET_ERROR_ALREADY_SHIPPED"));return}var e='<thead><tr><td><span class="adm-s-order-table-title-icon"></span></td><td></td>';var t=null;for(t in this.visibleColumns){if(this.visibleColumns.hasOwnProperty(t))e+="<td>"+this.visibleColumns[t]+"</td>"}e+="</thead></tr>";if(BX(this.tableId))BX.remove(BX(this.tableId));this.addProductDialog=new BX.CDialog({content:'<table id="'+this.tableId+'" class="adm-s-order-table-ddi-table" width="100%">'+e+"<tbody></tbody></table>",title:BX.message["PAYMENT_WINDOW_VOUCHER_TITLE"],width:1100,height:400,resizable:false,buttons:[new BX.CWindowButton({title:BX.message("SALE_ORDER_SHIPMENT_BASKET_ADD"),action:BX.proxy(function(){this.groupAdd()},this),className:"adm-btn-save"}),new BX.CWindowButton({title:BX.message("SALE_ORDER_SHIPMENT_BASKET_CLOSE"),action:function(){BX.WindowManager.Get().Close()}})]});if(this.productsOrder&&this.productsOrder.length)for(t=0,l=this.productsOrder.length-1;t<=l;t++)if(!!this.products[this.productsOrder[t]])this.productSet(this.products[this.productsOrder[t]],true);if(Object.keys(this.products).length==0){var a=BX(this.tableId);a.appendChild(this.createEmptyFooter())}this.addProductDialog.Show()};BX.Sale.Admin.SystemShipmentBasketEdit.prototype.createProductMenuContent=function(e){return[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_ADD"),ACTION:this.objName+'.moveToBasket("'+e+'")',DEFAULT:true}]};BX.Sale.Admin.SystemShipmentBasketEdit.prototype.createFieldAmount=function(e,t){if(!!t.MEASURE_TEXT){e.push(BX.create("span",{text:" "+t.MEASURE_TEXT+" "}))}e.push(BX.create("span",{text:t.AMOUNT}));return e};BX.Sale.Admin.SystemShipmentBasketEdit.prototype.moveToBasket=function(e){var t=null;this.link.products[e]=this.products[e];this.link.productSet(this.products[e],false);var a=BX(this.createProductRowId(e,this.products[e]));if(a){t=a.parentNode;if(t)t.removeChild(a)}var r=a.getAttribute("data-old-parent-id-parent");if(r){var i=BX.findChildrenByClassName(t,"bundle-child-"+r,false);for(var s in i){if(i.hasOwnProperty(s))i[s].parentNode.removeChild(i[s])}}delete this.products[e];if(Object.keys(this.products).length==0){var n=BX(this.tableId);n.appendChild(this.createEmptyFooter())}this.removeEmptyFooter(this.link.idPrefix);this.link.updateCountBasketItems();this.link.updateShipment()};BX.Sale.Admin.SystemShipmentBasketEdit.prototype.groupAdd=function(){var e=BX(this.tableId);var t=BX.findChildrenByClassName(e,"checkboxForDelete",true);for(var a in t){if(t.hasOwnProperty(a)&&!!t[a].checked)this.moveToBasket(t[a].getAttribute("data-basket-code"))}};BX.Sale.Admin.SystemShipmentBasketEdit.prototype.productAdd=function(e){var t=BX.Sale.Admin.ShipmentBasketEdit.prototype.productAdd.apply(this,[e]);if(e.IS_SET_ITEM!="Y"){BX.bind(t,"dblclick",BX.proxy(function(){this.moveToBasket(this.getProductBasketCode(e))},this))}return t};