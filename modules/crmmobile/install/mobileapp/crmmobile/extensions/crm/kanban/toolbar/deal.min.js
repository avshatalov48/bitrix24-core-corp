jn.define("crm/kanban/toolbar/deal",((t,e,s)=>{const{isEqual:o,mergeImmutable:a}=t("utils/object");const{NavigationLoader:n}=t("navigation-loader");const{StageToolbar:r}=t("crm/stage-toolbar");const{CategoryStorage:i}=t("crm/storage/category");const{CategoryCountersStoreManager:l}=t("crm/state-storage");const d=1e9;const g="plus";const u="minus";class h extends LayoutComponent{constructor(t){super(t);this.stages=null;this.columns=null;this.state={category:this.getCategoryByProps(t,true),categoryCounters:this.getCategoryCounters(),activeStageId:null,showValues:false};this.stageToolbarRef=null;this.clickToolbarHandler=this.handleToolbarClick.bind(this);this.onItemMovedHandler=this.handleOnItemMoved.bind(this);this.onItemDeletedHandler=this.handleOnItemDeleted.bind(this);this.onItemUpdatedHandler=this.handleOnItemUpdated.bind(this);this.onSimpleListRefreshHandler=this.handleOnSimpleListRefresh.bind(this);this.updateCountersHandler=this.updateCounters.bind(this);this.blinkItem=BX.prop.getFunction(t,"blinkItem",(()=>{}));this.toolbarRef=null}getCategoryByProps(t,e=false){const{filter:s,entityTypeId:o,filterParams:{CATEGORY_ID:a}}=t;const n=i.getCategory(o,a,s,e);if(e){this.clearCaches()}return n}getCategoryCounters(){return l.getStages()}updateCounters(){const t={categoryCounters:l.getStages(),showValues:true};this.setState(t)}componentWillReceiveProps(t){this.state.category=this.getCategoryByProps(t);this.clearCaches()}clearCaches(){this.stages=null;this.columns=null}componentDidMount(){this.subscribeStoreEvents();i.setEventId("crm.dealToolbar").subscribeOnChange((()=>this.reloadCategory())).subscribeOnLoading((({status:t})=>n.setLoading(t))).markReady();BX.addCustomEvent("UI.SimpleList::onUpdateItem",this.onItemUpdatedHandler);BX.addCustomEvent("UI.SimpleList::onDeleteItem",this.onItemDeletedHandler);BX.addCustomEvent("UI.Kanban::onItemMoved",this.onItemMovedHandler);BX.addCustomEvent("UI.SimpleList::onRefresh",this.onSimpleListRefreshHandler);layout.enableNavigationBarBorder(false)}subscribeStoreEvents(){l.subscribe("categoryCountersModel/init",this.updateCountersHandler).subscribe("categoryCountersModel/updateStage",this.updateCountersHandler)}componentWillUnmount(){BX.removeCustomEvent("UI.SimpleList::onUpdateItem",this.onItemUpdatedHandler);BX.removeCustomEvent("UI.SimpleList::onDeleteItem",this.onItemDeletedHandler);BX.removeCustomEvent("UI.Kanban::onItemMoved",this.onItemMovedHandler);BX.removeCustomEvent("UI.SimpleList::onRefresh",this.onSimpleListRefreshHandler);i.unsubscribe("crm.dealToolbar");l.unsubscribe("categoryCountersModel/init",this.updateCountersHandler).unsubscribe("categoryCountersModel/updateStage",this.updateCountersHandler);this.clearCaches()}handleOnItemUpdated(t){const e=t.oldItem.data?t.oldItem.data.price:0;const s=t.item.data.price;if(e===s){return}const o=t.item.columnId;this.addToStageCounters(o,s-e,0)}handleOnItemDeleted(t){const e=t.oldItem.data?t.oldItem.data.price:0;const s=t.oldItem.data.columnId;this.removeFromStageCounters(s,e)}handleOnItemMoved(t){const e=t.oldItem.data.columnId;const s=t.item.data.columnId;if(e===s){return}const o=t.item.data.price;this.addToStageCounters(s,o);this.removeFromStageCounters(e,o);this.blinkItem(t.item.id)}addToStageCounters(t,e,s=1){this.modifyCountersByColumnId(g,t,e,s)}removeFromStageCounters(t,e,s=1){this.modifyCountersByColumnId(u,t,e,s)}modifyCountersByColumnId(t,e,s=0,o=1){if(t!==g&&t!==u){throw new Error(`ModifyCounters action type ${t} is not known`)}const a=this.getStageByStatusId(e);if(!a){return}const n=this.getCountersByStageId(a.id);const r=t===g?n.total+s:n.total-s;o=t===g?n.count+o:n.count-o;const i={total:r,count:o};this.updateStageCounters(a.id,i)}handleOnSimpleListRefresh(){void this.reload(this.state.activeStageId)}reloadCategory(){const t=this.getCategoryByProps(this.props);this.changeCategory(t)}changeCategory(t){if(t&&!o(this.state.category,t)){const e=!this.state.category||this.state.category.id!==t.id;this.setState({category:t,categoryCounters:this.getCategoryCounters()},(()=>{if(e){this.props.reloadColumn()}}))}}handleToolbarClick(){if(this.stageToolbarRef){this.stageToolbarRef.handleSelectorClick()}}getActiveStageId(){return this.state.activeStageId}getStages(t=true){if(!this.state.category){return[]}if(this.stages===null||!t){this.stages=[...this.state.category.processStages,...this.state.category.successStages,...this.state.category.failedStages]}return this.stages}updateStageCounters(t,e){l.updateStage(t,e)}getActiveStage(){const t=this.getStages();if(t.length===0||!this.getActiveStageId()){return null}return this.getStage(this.getActiveStageId())}getStage(t){const e=this.getStages(false);return e.find((e=>e.id===t))}getFirstStage(){return this.getStages()[0]}getStageByStatusId(t){const e=this.getStages(false);return e.find((e=>e.statusId===t))}getCountersById(t){return this.state.categoryCounters.find((e=>e.id===t))}getFormattedMoneyText(t){if(!t){return null}return t.amount>=d?Math.floor(t.amount*10/d)/10+" "+BX.message("M_CRM_MAX_FORMATTED_SUM"):t.formattedAmount}getActiveStageTotalMoney(){const{categoryCounters:t}=this.state;if(t.length===0){return 0}const e=this.getActiveStage();if(e){const t=this.getCountersByStageId(e.id);if(!t){return 0}return Math.round(t.total)}return Math.round(t.reduce(((t,e)=>t+parseFloat(e.total,10)),0))}getCountersByStageId(t){const{categoryCounters:e}=this.state;if(!e.length){return null}return e.find((e=>e.id===t))||null}getCurrency(){const t=this.getActiveStage()||this.getFirstStage();if(!t){return""}const e=this.getCountersByStageId(t.id);if(!e){return""}return e.currency}getColumns(){if(this.columns===null||!this.columns.size){const t=new Map;this.getStages().map((e=>{t.set(e.statusId,e)}));this.columns=t}return this.columns}updateCurrentColumnId(t){if(this.state.activeStageId!==t){this.setState({activeStageId:t},(()=>{this.props.changeColumn(t)}))}}reload(t=0,e=false){return new Promise((s=>{if(this.state.activeStageId!==t||e){this.setState({activeStageId:t},(()=>s(this.getColumns())))}else{s(this.getColumns())}}))}getAdditionalParamsForItem(){return{entityTypeId:this.props.entityTypeId,categoryId:this.state.category&&this.state.category.id,activeStageId:this.state.activeStageId,onChange:this.props.changeItemStage,columns:this.getColumns()}}getStyles(){return a(c,BX.prop.getObject(this.props,"style",{}))}getTotalMoney(){const t=this.state.categoryCounters;if(t.length===0){return null}const e=this.getActiveStageTotalMoney();const s=this.getCurrency();return new Money({amount:e,currency:s})}render(){const{entityTypeId:t}=this.props;const{activeStageId:e,category:s}=this.state;const o=this.getStyles();const a=this.getTotalMoney();const n=a?`, ${a.formattedCurrency}`:"";return View({style:o.rootWrapper,onClick:this.clickToolbarHandler},Shadow(o.shadow,View({style:o.mainWrapper},View({style:o.toolbarWrapper},new r({ref:t=>this.stageToolbarRef=t,entityTypeId:t,category:s,activeStageId:e,showAllStages:true,onStageSelect:({id:t})=>this.updateCurrentColumnId(t),stageParams:{showTotal:true,showCount:true,showCounters:true,showAllStagesItem:true,renderStageCountFiller:this.renderFiller,useRenderStageCountFiller:!this.state.showValues}})),View({style:o.moneyWrapper},Text({style:o.moneyTitle,text:BX.message("M_UI_KANBAN_TOOLBAR_DEAL_SUM")+n,ellipsize:"end",numberOfLines:1}),this.state.showValues?this.renderFormattedMoney(a):this.renderFiller(78)))))}renderFormattedMoney(t){const e=this.getStyles();return Text({style:e.money,text:this.getFormattedMoneyText(t),ellipsize:"end",numberOfLines:1})}renderFiller(t,e){e=a({height:6,width:t,marginTop:Application.getPlatform()==="android"?10:8},e);return Image({style:e,svg:{content:`<svg width="${t}" height="6" viewBox="0 0 ${t} 6" fill="none" xmlns="http://www.w3.org/2000/svg">\n`+`<rect width="${t}" height="6" rx="2" fill="#DFE0E3"/>\n`+`</svg>`}})}}const c={rootWrapper:{position:"absolute",left:0,right:0,top:0},shadow:{color:"#e6e6e6",radius:3,offset:{y:3},inset:{left:3,right:3},style:{borderBottomLeftRadius:12,borderBottomRightRadius:12}},mainWrapper:{flexDirection:"row",height:60,paddingHorizontal:10,paddingTop:9,backgroundColor:"#ffffff",borderBottomLeftRadius:12,borderBottomRightRadius:12,justifyContent:"space-between",alignItems:"flex-start"},toolbarWrapper:{flex:10,paddingRight:10},moneyWrapper:{flex:4,paddingRight:10},moneyTitle:{color:"#a8adb4",fontSize:14,fontWeight:"500",marginBottom:Application.getPlatform()==="android"?0:2},money:{color:"#525c69",fontSize:14,fontWeight:"500",marginTop:Application.getPlatform()==="android"?1:3}};s.exports={DealToolbar:h}}));
//# sourceMappingURL=deal.map.js