jn.define("crm/category-list-view",((t,e,o)=>{const{mergeImmutable:s,isEqual:r}=t("utils/object");const{NotifyManager:i}=t("notify-manager");const{CategoryStorage:a}=t("crm/storage/category");const{CategoryList:n}=t("crm/category-list");const{StageSelectActions:g}=t("crm/stage-list/actions");const{NavigationLoader:c}=t("navigation-loader");const{StageListView:l}=t("crm/stage-list-view");const{throttle:d}=t("utils/function");const y="crm_clr_cfg_deal_category";class p extends LayoutComponent{static open(t,e={},o=PageManager){return new Promise((r=>{const{selectAction:i}=t;const a={modal:true,title:this.getNavigationTitle(i),backdrop:{showOnTop:true,forceDismissOnSwipeDown:true,horizontalSwipeAllowed:false,swipeContentAllowed:true,navigationBarColor:"#eef2f4"}};o.openWidget("layout",s(a,e)).then((e=>{e.showComponent(new this({...t,layout:e}));r(e)}))}))}static getNavigationTitle(t){if(t===g.SelectTunnelDestination||t===g.CreateTunnel){return BX.message("M_CRM_CATEGORY_LIST_NAVIGATION_TITLE_ON_CHANGE_TUNNEL2")}return BX.message("M_CRM_CATEGORY_LIST_NAVIGATION_TITLE2")}constructor(t){super(t);this.layout=t.layout||layout;this.state={categoryList:this.getCategoryListFromStorage(t.entityTypeId)};this.createCategoryHandler=d(this.createCategory,500,this);this.editCategoryHandler=d(this.openEditCategory,500,this);this.openStageListHandler=d(this.openStageList,500,this)}componentWillReceiveProps(t){this.state.categoryList=this.getCategoryListFromStorage(t.entityTypeId)}componentDidMount(){BX.addCustomEvent("Crm.CategoryDetail::onDeleteCategory",(()=>this.getCategoryListFromStorage(this.props.entityTypeId)));this.layout.enableNavigationBarBorder(false);a.subscribeOnChange((()=>this.reloadCategoryList())).subscribeOnLoading((({status:t})=>c.setLoading(t,this.layout))).markReady()}getCategoryListFromStorage(t){return a.getCategoryList(t)}reloadCategoryList(){const t=this.getCategoryListFromStorage(this.props.entityTypeId);if(!r(this.state.categoryList,t)){this.setState({categoryList:t})}}getCategories(){if(!this.state.categoryList){return[]}return this.state.categoryList.categories}getRestrictions(){if(!this.state.categoryList){return[]}return this.state.categoryList.restrictions}canUserEditCategory(){if(!this.state.categoryList){return false}return this.state.categoryList.canUserEditCategory}render(){return View({style:{flexDirection:"column",backgroundColor:"#eef3f5"}},this.state.categoryList===null?this.renderLoader():this.renderContent())}renderLoader(){return new LoadingScreenComponent}renderContent(){const t=BX.prop.getBoolean(this.props,"showCounters",true);const e=BX.prop.getBoolean(this.props,"showTunnels",true);return new n({entityTypeId:this.props.entityTypeId,currentCategoryId:this.props.currentCategoryId,needSaveCurrentCategoryId:this.props.needSaveCurrentCategoryId,categories:this.getCategories(),onCreateCategory:this.createCategoryHandler,onEditCategory:this.editCategoryHandler,canUserEditCategory:this.canUserEditCategory(),readOnly:this.props.readOnly,selectAction:this.props.selectAction,onSelectCategory:this.props.onSelectCategory,layout:this.layout,openStageListHandler:this.openStageListHandler,enableSelect:this.props.enableSelect,uid:this.props.uid,disabledCategoryIds:this.props.disabledCategoryIds,showCounters:t,showTunnels:e})}openEditCategory(t,e=null){e=e||this.getCategories();ComponentHelper.openLayout({name:"crm:crm.category.detail",componentParams:{entityTypeId:this.props.entityTypeId,categoryId:t,categories:e},widgetParams:{modal:true,backdrop:{showOnTop:true,forceDismissOnSwipeDown:true,swipeContentAllowed:false,horizontalSwipeAllowed:false}}},this.layout)}openStageList(t){void l.open({entityTypeId:this.props.entityTypeId,categoryId:t.id,activeStageId:this.props.activeStageId,selectAction:this.props.selectAction,uid:this.props.uid,enableStageSelect:true,disabledStageIds:this.props.disabledStageIds,stageParams:{showTunnels:true},onViewHidden:({stageAction:t})=>{if(t===g.SelectTunnelDestination||t===g.CreateTunnel){this.layout.close()}}},{},this.layout)}createCategory(t){const e=t[t.length-1].sort+100;const o=this.getDealCategoryLimitRestriction();if(this.getRestrictions()&&o.isExceeded){helpdesk.openHelpSection(o.id)}else{const{entityTypeId:t}=this.props;i.showLoadingIndicator();a.createCategory(t,{name:BX.message("M_CRM_CATEGORY_LIST_DEFAULT_CATEGORY_NAME2"),sort:e}).then((t=>{i.hideLoadingIndicator(true,BX.message("M_CRM_CATEGORY_LIST_SUCCESS_CREATION2"),1e3);setTimeout((()=>this.openEditCategory(t)),1300)})).catch((t=>i.showErrors(t.errors)))}}getDealCategoryLimitRestriction(){return this.getRestrictions().find((t=>t.name===y))}}o.exports={CategoryListView:p}}));
//# sourceMappingURL=extension.map.js