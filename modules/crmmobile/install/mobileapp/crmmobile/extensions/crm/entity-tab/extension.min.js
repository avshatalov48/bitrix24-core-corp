jn.define("crm/entity-tab",((t,e,n)=>{const{TypeFactory:i}=t("crm/entity-tab/type");const{Filter:s}=t("crm/entity-tab/filter");const{TypeSort:r}=t("crm/entity-tab/sort");const{TypeId:o}=t("crm/type");const{getEntityMessage:a}=t("crm/loc");const{EntitySvg:l}=t("crm/assets/entity");const{Alert:u}=t("alert");const{EntityDetailOpener:c}=t("crm/entity-detail/opener");const{PullManager:d}=t("crm/entity-tab/pull-manager");const{EmptyScreen:h}=t("layout/ui/empty-screen");const{ViewMode:m}=t("layout/ui/simple-list/view-mode");const{TabType:p}=t("layout/ui/detail-card/tabs/factory/type");const{clone:C,get:g}=t("utils/object");const{capitalize:y}=t("utils/string");const I="#767c87";const T={[o.Lead]:l.lead(I),[o.Deal]:l.deal(I),[o.Contact]:l.contact(I),[o.Company]:l.company(I)};const f="crm";const E="ITEMUPDATED";const M="ITEMDELETED";const w=500;class B extends LayoutComponent{constructor(t){super(t);this.deleteItemConfirm=this.deleteItemConfirmHandler.bind(this);this.onSearchHandler=this.onSearch.bind(this);this.onSearchHideHandler=this.onSearchHide.bind(this);this.checkIsEmptyHandler=this.checkIsEmpty.bind(this);this.floatingButtonMenu=null;this.isEmpty=true;this.viewComponent=null;this.pullManager=new d;this.pullQueue=new Map;this.pullQueueTimer=null;this.entityTypeName=t.entityTypeName;this.state.isLoading=false;this.state.searchButtonBackgroundColor=null;this.filter=new s}componentDidMount(){BX.addCustomEvent("UI.StatefulList::onDrawListFromAjax",this.checkIsEmptyHandler);BX.addCustomEvent("Crm.EntityTab::onSearch",this.onSearchHandler);BX.addCustomEvent("Crm.EntityTab::onSearchHide",this.onSearchHideHandler)}componentWillUnmount(){BX.removeCustomEvent("UI.StatefulList::onDrawListFromAjax",this.checkIsEmptyHandler);BX.removeCustomEvent("Crm.EntityTab::onSearch",this.onSearchHandler);BX.removeCustomEvent("Crm.EntityTab::onSearchHide",this.onSearchHideHandler)}onSearch(t){const{data:e}=t;this.state.searchButtonBackgroundColor=e&&e.background?e.background:null;if(t.isCancel){this.filter.unsetWasShown()}if(t.counter&&t.counter.id){this.setCounterFilter(t);return}this.setPresetFilter(t)}onSearchHide(){if(this.getCurrentStatefulList().getSimpleList().getViewMode()===m.empty){this.filter.unsetWasShown();this.setState({})}}getCounterLongClickHandler(){const t=this.getItemActions().find((t=>t.id==="activity"));if(t&&!t.isDisabled){return t.onClickCallback}return null}setCounterFilter(t){const{id:e,code:n}=t.counter;const{text:i}=t;const{filter:s}=this;if(s.currentFilterId===n){s.clear()}else{s.set({counterId:e,presetId:"tmp_filter",currentFilterId:n,tmpFields:{ASSIGNED_BY_ID:[env.userId],ACTIVITY_COUNTER:[e]},search:i})}this.reload(this.getReloadParamsByFilter())}setPresetFilter(t){const{preset:e,text:n}=t;const i=e?e.id:null;this.filter.set({presetId:i,search:n,currentFilterId:i});this.reload(this.getReloadParamsByFilter())}getReloadParamsByFilter(){return{skipFillSlides:true,menuButtons:this.getMenuButtons(),force:true}}checkIsEmpty(t){const{blockPage:e,items:n,params:i}=t;if(e!==1||i.extra&&i.extra.filterParams&&i.extra.filterParams.stageId){return}this.isEmpty=!Boolean(n.length)}reload(t={}){this.getViewComponent().reload(t)}getViewConfig(){return{resizableByKeyboard:true,style:{backgroundColor:"#f5f7f8",flex:1}}}getMenuActions(){return[{type:UI.Menu.Types.DESKTOP,showHint:false,data:{qrUrl:this.getEntityType(this.props.entityTypeId).link}}]}getMenuButtons(){return[{type:"search",badgeCode:"search",callback:()=>this.showSearchBar(),svg:this.getSearchButtonSvg()}]}getSearchButtonSvg(){let t="";let e="#c5c8d0";if(this.state.searchButtonBackgroundColor){t=`<rect y="0.5" width="31" height="31" rx="15.5" fill="${this.state.searchButtonBackgroundColor}"/>`;e="#ffffff"}return{content:`<svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">\n`+`${t}\n`+`<rect x="4" y="15.5" width="12" height="2" rx="1" fill="${e}"/>\n`+`<rect x="4" y="19.5" width="12" height="2" rx="1" fill="${e}"/>\n`+`<rect x="4" y="23.5" width="12" height="2" rx="1" fill="${e}"/>\n`+`<path fill-rule="evenodd" clip-rule="evenodd" d="M17.6118 21.292C17.9359 21.1366 18.248 20.9601 18.5462 20.7642L21.9831 24.2011C22.3736 24.5916 23.0067 24.5916 23.3973 24.2011L24.1669 23.4315C24.5574 23.041 24.5574 22.4078 24.1669 22.0173L20.7545 18.605C21.6456 17.3131 22.1673 15.7469 22.1673 14.0588C22.1673 9.63117 18.578 6.04187 14.1504 6.04187C9.82439 6.04187 6.29868 9.46828 6.1391 13.7552H8.12876C8.28687 10.5665 10.9224 8.02967 14.1504 8.02967C17.4801 8.02967 20.1795 10.729 20.1795 14.0588C20.1795 16.1005 19.1646 17.9051 17.6118 18.9958Z" fill="${e}"/>`+`</svg>`}}showSearchBar(){let t=this.filter.presetId;if(!t&&!this.filter.wasShown){const e=this.getCurrentEntityType();t=e.data.presetId}const e=this.filter.counterId;if(e){t=null}this.filter.set({presetId:t,search:this.filter.search}).setWasShown();BX.postComponentEvent("Crm.EntityTab::onSearchShow",[{presetId:t,counterId:e,search:this.filter.search}])}getAdditionalParamsForItem(){return{}}prepareActionParams(){return C(this.props.actionParams)}getEmptyListComponent(){const t=this.getEntityTypeModel();let e;if(this.filter.isActive()){e=t.getEmptySearchScreenConfig()}else{e=this.isEmpty?t.getEmptyEntityScreenConfig():this.getEmptyColumnScreenConfig(t)}e.onRefresh=()=>{this.getCurrentStatefulList().getSimpleList().reloadList()};return new h(e)}getEmptyColumnScreenConfig(t){return t.getEmptyColumnScreenConfig()}getCurrentEntityType(){if(!this.props.entityTypes||!this.entityTypeName){return null}return this.props.entityTypes.find((t=>t.typeName===this.entityTypeName))}getPullConfig(){return{moduleId:f,callback:(t,e)=>{if(this.isWrongPullContext(e)){return Promise.reject()}return new Promise(((n,i)=>{if(this.isNeedProcessPull(t,e)){const{item:s,eventName:r}=t.params;const o=this.getCurrentStatefulList().getItemComponent(s.id);const a=this.getViewComponent();if(r===E&&this.hasColumnChangesInItem(s,o)&&this.hasItemInCurrentColumn(s.data.id)&&!this.isCurrentSlideName(s.data.columnId,e.slideName)){if(a.getSlideName()===e.slideName){this.updateItemColumn(s.id,s.data.columnId)}else{a.deleteItemFromStatefulList(s.id)}BX.postComponentEvent("UI.Kanban::onItemMoved",[{item:s,oldItem:o.props.item}]);i();return}const l=Number(s.id);this.pullQueue.set(l,{id:l,columnId:s.data.columnId,categoryId:s.data.categoryId,eventName:r});this.processPullQueue().then((t=>{n(t)})).catch((()=>{i()}))}else{i()}}))}}}isWrongPullContext(t={}){return false}isNeedProcessPull(t,e){this.abstract()}hasColumnChangesInItem(t,e){const n=this.getViewComponent();return e&&e.state.columnId&&e.state.columnId!==n.getColumnIdByName(t.data.columnId)}getPullCommand(t){this.abstract()}hasItemInCurrentColumn(t){return this.getCurrentStatefulList().hasItem(t)}getCurrentStatefulList(){this.abstract()}isCurrentSlideName(t,e){this.abstract()}processPullQueue(){return new Promise(((t,e)=>{if(this.pullQueueTimer){e();return}this.pullQueueTimer=setTimeout((()=>{const n=this.getCurrentStatefulList();const i=C(this.pullQueue);this.pullQueueTimer=null;this.pullQueue=new Map;const s=[];const r={};i.forEach(((t,e)=>{if(t.eventName!==E){t.eventName=this.getPreparedItemEventName(t.eventName);if(r[t.eventName]===undefined){r[t.eventName]=[]}r[t.eventName].push(t)}else{s.push(e)}}));n.loadItemsByIds(s).then((e=>{e.map((t=>{const e=i.get(t.id);e.eventName=this.getPreparedItemEventName(e.eventName);if(r[e.eventName]===undefined){r[e.eventName]=[]}r[e.eventName].push({...e,data:t.data,config:this.getPullItemConfig(t)})}));t({isBatchMode:true,data:r})})).catch((()=>{e()}))}),w)}))}getPreparedItemEventName(t){if(t.indexOf("ITEM")===0){t=t.replace("ITEM","")}return t}getPullItemConfig(t){if(this.getCurrentTypeSort===r.Id){return{}}let e=false;const n=this.getCurrentStatefulList().getItem(t.id);if(!n){e=true;return{showReloadListNotification:e}}const{data:{counters:{lastActivity:i}}}=n;const{data:{counters:{lastActivity:s}}}=t;if(!s){return{}}if(s>i){const n=this.getCurrentStatefulList().getItemPosition(t.id);if(!n||n.index!==1){e=true}}return{showReloadListNotification:e}}getCurrentTypeSort(){return r.Id}getLayoutOptions(){return{useSearch:false,useOnViewLoaded:false}}getItemLayoutOptions(){return{useConnectsBlock:true,useCountersBlock:true,useItemMenu:true,useStatusBlock:true}}getCategoryId(t){const e=this.getEntityType(t);if(!e||!e.data||!e.canUseCategoryId){return null}return BX.prop.getInteger(e.data,"currentCategoryId",null)}handleItemDetailOpen(t,e,n={}){const i=this.props.entityTypeId;const s=this.getCategoryId(i);const r={text:e.name};if(e.subTitleText){r.detailText=y(e.subTitleText)}let o=null;const a=g(e,["counters","activityCounterTotal"],null);if(a){o={[p.TIMELINE]:{label:String(a)}}}c.open({...n,entityTypeId:i,entityId:t,categoryId:s,tabs:o},{titleParams:r})}showForbiddenCreateNotification(t=null){const e=this.getEntityMessage("M_CRM_ENTITY_TAB_FORBIDDEN_CREATE_TITLE",t);const n=BX.message("M_CRM_ENTITY_TAB_FORBIDDEN_TEXT");Notify.showUniqueMessage(n,e,{time:3})}handleNewItemOpen(t){const e=this.getEntityType(t);if(!e){return}if(!e.permissions.add){this.showForbiddenCreateNotification();return}if(e.selectable){const n=e.canUseCategoryId?this.getCategoryId(t):null;c.open({entityTypeId:t,categoryId:n})}else if(e.link){qrauth.open({title:e.titleInPlural||e.title,redirectUrl:e.link})}}getEntityType(t){return this.props.entityTypes.find((e=>e.id===t))}itemDetailOpen(t,e){t=t||{};e=e||{};ComponentHelper.openLayout({name:"crm:crm.entity.details",componentParams:{payload:t},widgetParams:{titleParams:e}})}handleFloatingButtonClick(){const t=this.getFloatingButtonMenu();if(t){void t.show()}}handleFloatingButtonLongClick(){this.handleNewItemOpen(this.props.entityTypeId)}onDetailCardUpdate(t){}onDetailCardCreate(t){}getFloatingButtonMenu(){if(!this.floatingButtonMenu){this.floatingButtonMenu=this.createFloatingMenu()}return this.floatingButtonMenu}isShowFloatingButton(){return this.props.entityTypes.some((t=>t.permissions&&t.permissions.add))}createFloatingMenu(){const t=this.props.entityTypes.map((t=>({id:t.id,title:t.name,data:{svgIcon:T[t.id]?T[t.id]:null,svgIconAfter:!t.selectable&&t.link&&{type:ContextMenuItem.ImageAfterTypes.WEB}},onClickCallback:this.handleFloatingMenuClick.bind(this),onDisableClick:this.showForbiddenCreateNotification.bind(this),isDisabled:!t.permissions.add})));return new ContextMenu({testId:"CRM_ENTITY_TAB_"+this.entityTypeName,actions:t,params:{showCancelButton:true,showActionLoader:false,title:BX.message("M_CRM_ENTITY_TAB_ADD_ENTITY_TEXT2")}})}handleFloatingMenuClick(t){if(this.floatingButtonMenu){this.floatingButtonMenu.close((()=>{this.handleNewItemOpen(t)}))}return Promise.resolve({closeMenu:false})}getEntityMessage(t,e=null){e=e||this.props.entityTypeId;return a(t,e)}getItemActions(){const t=Boolean(this.getCurrentEntityType().permissions.update);const e=[{id:"open",showActionLoader:false,title:t?this.getEntityMessage("M_CRM_ENTITY_TAB_ITEM_ACTION_EDIT"):this.getEntityMessage("M_CRM_ENTITY_TAB_ITEM_ACTION_OPEN"),onClickCallback:(t,e,{parentWidget:n,parent:i})=>{n.close((()=>this.handleItemDetailOpen(e,i.data)))},data:{svgIcon:t?N:_}}];e.push(...this.getItemActionsByEntityType());e.push({id:"delete",title:this.getEntityMessage("M_CRM_ENTITY_TAB_ITEM_ACTION_DELETE"),type:"delete",onClickCallback:this.deleteItemConfirm,onDisableClick:this.showForbiddenDeleteNotification.bind(this),isDisabled:!this.getCurrentEntityType().permissions.delete});e.push({id:"showActivityDetailTab",title:BX.message("M_CRM_ENTITY_TAB_ITEM_ACTION_ACTIVITIES"),onClickCallback:(t,e,{parentWidget:n,parent:i})=>{const s={activeTab:p.TIMELINE};n.close((()=>this.handleItemDetailOpen(e,i.data,s)))},sectionCode:"additional",data:{svgIcon:v}});return e}getItemActionsByEntityType(){const t=this.getEntityTypeModel();return t?t.getItemActions(this.props.permissions):[]}getEntityTypeModel(t={}){t.categoryId=this.getCategoryId(this.props.entityTypeId);t.categoriesCount=this.getCurrentEntityType().data.categoriesCount||0;const e=new i(this.entityTypeName);return e.getEntity(t)}deleteItemConfirmHandler(t,e){return new Promise(((t,n)=>{u.confirm(this.getEntityMessage("M_CRM_ENTITY_TAB_ITEM_ACTION_DELETE"),BX.message("M_CRM_ENTITY_TAB_ITEM_ACTION_DELETE_CONFIRMATION"),[{type:"cancel",onPress:n},{text:BX.message("M_CRM_ENTITY_TAB_ITEM_ACTION_DELETE_CONFIRMATION_OK"),type:"destructive",onPress:()=>{this.deleteItem(e);t({action:"delete",id:e})}}])}))}deleteItem(){this.abstract()}updateItemColumn(t,e){this.abstract()}abstract(){throw new Error("Must be implemented in subclass")}getViewComponent(){return this.viewComponent}showForbiddenDeleteNotification(){const t=BX.message("M_CRM_ENTITY_TAB_FORBIDDEN_DELETE_TITLE");const e=BX.message("M_CRM_ENTITY_TAB_FORBIDDEN_TEXT");Notify.showUniqueMessage(e,t,{time:3})}getCounters(){const t=this.getCurrentEntityType();return t.data.counters||[]}setIsLoading(){if(this.state.isLoading){return Promise.resolve()}return new Promise((t=>this.setState({isLoading:true},t)))}scrollToTop(){this.abstract()}scrollSimpleListToTop(t){if(t){const e=t.listView;if(e){e.scrollToBegin(true)}}}}const _='<svg width="17" height="21" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.4234 17.7238C14.4234 17.8825 14.2934 18.01 14.1346 18.01H2.56338C2.40338 18.01 2.27463 17.8825 2.27463 17.7238V2.2875C2.27463 2.13 2.40338 2.00125 2.56338 2.00125H8.05963C8.21963 2.00125 8.34838 2.13 8.34838 2.2875V7.72C8.34838 7.8775 8.47838 8.005 8.63838 8.005H14.1346C14.2934 8.005 14.4234 8.13375 14.4234 8.29125V17.7238ZM10.3734 3.09C10.3734 3.0325 10.4221 2.98375 10.4821 2.98375C10.5109 2.98375 10.5384 2.995 10.5584 3.015L13.3984 5.82125C13.4409 5.8625 13.4409 5.93 13.3984 5.9725C13.3771 5.9925 13.3509 6.00375 13.3209 6.00375H10.4821C10.4221 6.00375 10.3734 5.955 10.3734 5.89625V3.09ZM16.0234 5.585L10.6909 0.31375C10.4884 0.11375 10.2121 0 9.92338 0H1.33463C0.734634 0 0.249634 0.48 0.249634 1.0725V18.94C0.249634 19.5313 0.734634 20.0113 1.33463 20.0113H15.3634C15.9609 20.0113 16.4471 19.5313 16.4471 18.94V6.59625C16.4471 6.21625 16.2946 5.8525 16.0234 5.585ZM12.0359 10.0063H4.65963C4.46088 10.0063 4.29838 10.1663 4.29838 10.3638V11.65C4.29838 11.8463 4.46088 12.0075 4.65963 12.0075H12.0359C12.2359 12.0075 12.3984 11.8463 12.3984 11.65V10.3638C12.3984 10.1663 12.2359 10.0063 12.0359 10.0063ZM4.73338 8.005H5.88963C6.12963 8.005 6.32338 7.8125 6.32338 7.575V6.4325C6.32338 6.195 6.12963 6.00375 5.88963 6.00375H4.73338C4.49338 6.00375 4.29838 6.195 4.29838 6.4325V7.575C4.29838 7.8125 4.49338 8.005 4.73338 8.005ZM12.0359 14.0087H4.65963C4.46088 14.0087 4.29838 14.1675 4.29838 14.365V15.6525C4.29838 15.8488 4.46088 16.01 4.65963 16.01H12.0359C12.2359 16.01 12.3984 15.8488 12.3984 15.6525V14.365C12.3984 14.1675 12.2359 14.0087 12.0359 14.0087Z" fill="#767c87"/></svg>';const N='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.0242 3.54235C17.2203 3.34691 17.5378 3.34801 17.7326 3.54479L20.6219 6.46453C20.8156 6.66031 20.8145 6.97592 20.6195 7.17036L9.43665 18.3165L5.84393 14.686L17.0242 3.54235ZM4.1756 19.5286C4.14163 19.6572 4.17803 19.7931 4.27024 19.8877C4.36488 19.9823 4.50078 20.0187 4.62939 19.9823L8.64557 18.9003L5.25791 15.5137L4.1756 19.5286Z" fill="#767C87"/></svg>';const v='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.70785 3.97461C3.24153 3.97461 2.8635 4.35264 2.8635 4.81897V5.79497C1.97592 6.13038 1.3457 6.9791 1.3457 7.9731C1.3457 8.96711 1.97592 9.81583 2.8635 10.1512V13.0186C1.97592 13.354 1.3457 14.2027 1.3457 15.1967C1.3457 16.1907 1.97592 17.0395 2.8635 17.3749V18.8377C2.8635 19.304 3.24153 19.6821 3.70785 19.6821C4.17418 19.6821 4.55221 19.304 4.55221 18.8377V17.3749C5.43981 17.0395 6.07006 16.1908 6.07006 15.1967C6.07006 14.2027 5.43981 13.354 4.55221 13.0186V10.1513C5.43981 9.81586 6.07006 8.96713 6.07006 7.9731C6.07006 6.97908 5.43981 6.13034 4.55221 5.79495V4.81897C4.55221 4.35264 4.17418 3.97461 3.70785 3.97461ZM7.94922 6.37598C7.94922 5.82369 8.39693 5.37598 8.94922 5.37598H21.619C22.1713 5.37598 22.619 5.82369 22.619 6.37598V9.57077C22.619 10.1231 22.1713 10.5708 21.619 10.5708H8.94922C8.39693 10.5708 7.94922 10.1231 7.94922 9.57077V6.37598ZM7.94922 13.5986C7.94922 13.0463 8.39693 12.5986 8.94922 12.5986H21.619C22.1713 12.5986 22.619 13.0463 22.619 13.5986V16.7934C22.619 17.3457 22.1713 17.7934 21.619 17.7934H8.94922C8.39693 17.7934 7.94922 17.3457 7.94922 16.7934V13.5986Z" fill="#767c87"/></svg>';n.exports={EntityTab:B}}));
//# sourceMappingURL=extension.map.js