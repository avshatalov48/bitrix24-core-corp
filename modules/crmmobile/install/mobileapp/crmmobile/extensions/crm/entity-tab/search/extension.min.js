jn.define("crm/entity-tab/search",((e,t,s)=>{const{debounce:r}=e("utils/function");const{clone:n,isEqual:i,mergeImmutable:a}=e("utils/object");const{Preset:o}=e("crm/entity-tab/search/preset");const{Counter:h}=e("crm/entity-tab/search/counter");const c=3;const l="#2fc6f6";class d extends LayoutComponent{constructor(e){super(e);this.entityTypeName=e.entityTypeName;this.categoryId=e.categoryId;this.wrapperRef=null;this.isApiGreaterThen44=Application.getApiVersion()>44;this.nameOfClickEnterEvent=this.isApiGreaterThen44?"clickEnter":"clickSearch";this.state=this.getInitialState();this.show=this.showHandler.bind(this);this.onHide=this.onHideHandler.bind(this);this.onDone=this.onDoneHandler.bind(this);this.onCancel=this.onCancelHandler.bind(this);this.onItemClick=this.onItemClickHandler.bind(this);this.onTextChanged=this.onTextChangedHandler.bind(this);this.debounceSearch=r((e=>this.search(e,false)),500,this)}getInitialState(){return{visible:false,counters:null,presets:null,search:"",presetId:this.props.presetId||null,counterId:this.props.counterId||null}}componentWillReceiveProps(e){this.entityTypeName=e.entityTypeName;this.categoryId=e.categoryId}componentDidMount(){BX.addCustomEvent("Crm.EntityTab::onSearchShow",this.show);const{layout:e}=this.props;e.search.on("hide",(()=>this.onHide()));e.search.on("textChanged",(e=>this.onTextChanged(e)));e.search.on("cancel",(()=>this.onCancel()));e.search.on(this.nameOfClickEnterEvent,(()=>this.onDone()));if(this.isApiGreaterThen44){e.search.setReturnKey("done")}}showHandler(e){this.fetchPresetsAndCounters();const t=e.search||"";const{search:s}=this.props.layout;s.mode="bar";s.text=t;s.show();this.setState({visible:true,presetId:e.presetId||null,counterId:e.counterId||null,search:t})}onHideHandler(){if(!this.state.visible){return}this.setState({visible:false},(()=>BX.postComponentEvent("Crm.EntityTab::onSearchHide")))}onDoneHandler(){this.close();this.onHide()}onCancelHandler(){const e=a(this.state,{search:"",counterId:null,presetId:this.getDefaultPresetId()});if(i(this.state,e)){return}const t={counter:{id:e.counterId},preset:{id:e.presetId},isCancel:true};this.setState(e,(()=>BX.postComponentEvent("Crm.EntityTab::onSearch",[t])))}getDefaultPresetId(){if(!Array.isArray(this.state.presets)){return null}const e=this.state.presets.find((e=>e.default===true));return e?e.id:null}onTextChangedHandler(e){if(this.state.presetId){e.preset={id:this.state.presetId}}if(this.state.counterId){e.counter={id:this.state.counterId}}this.debounceSearch(e)}arePresetsLoaded(){return Array.isArray(this.state.presets)}fetchPresetsAndCounters(){if(this.arePresetsLoaded()){return null}const e=this.getCacheId();const t={entityTypeName:this.entityTypeName,categoryId:this.categoryId};new RunActionExecutor(this.props.getSearchDataAction,t).setCacheId(e).setCacheHandler((e=>this.setSearchDataFromResponse(e))).setHandler((e=>this.setSearchDataFromResponse(e))).call(true)}getCacheId(){return`Crm.SearchBar.${this.entityTypeName}.${this.categoryId}.${env.userId}`}setSearchDataFromResponse(e){if(e.data&&(!i(this.state.counters,e.data.counters)||!i(this.state.presets,e.data.presets))){const{counters:t,presets:s}=e.data;this.setState({counters:t,presets:s,visible:true})}}render(){const{visible:e}=this.state;const t=e?this.getPreparedPresets():[];return View({style:u.wrapper(e),ref:e=>this.wrapperRef=e},e&&View({},ScrollView({horizontal:true,style:u.presetsScrollView},View({style:u.presetsWrapper},this.renderLoader(),this.renderDefaultPreset(t),...this.renderCounters(),...this.renderPresets(t),this.renderMoreButton()))))}renderLoader(){if(!this.arePresetsLoaded()){return Loader({style:{width:50,height:50},tintColor:"#82888f",animating:true,size:"small"})}return null}renderDefaultPreset(e){return e[0]}renderCounters(){if(!Array.isArray(this.state.counters)){return[]}const e=n(this.state.counters);return e.map((e=>{e.active=this.state.counterId===e.typeId;e.onClick=this.onItemClick;return new h(e)}))}renderPresets(e){return e.slice(1,e.length)}getPreparedPresets(){if(!this.arePresetsLoaded()){return[]}const e=n(this.state.presets);return e.map((e=>{e.active=this.state.presetId===e.id;e.onClick=this.onItemClick;return new o(e)}))}onItemClickHandler(e,t){const s=t?e:{};this.search(s,false)}search(e={},t=true){if(t){this.close()}if(e.text&&e.text.length<c){return}e.text=e.text===undefined?this.state.search:e.text;if(e.text.length&&this.props.restrictions.isExceeded){this.props.layout.search.text="";helpdesk.openHelpSection(this.props.restrictions.infoHelperId);return}const s={search:e.text,counterId:null,presetId:null};const{preset:r,counter:n}=e;if(r){s.presetId=r.id||null}else if(n){s.counterId=n.id||null}e.data=e.data||{};if(s.search&&!e.data.background){e.data.background=l}this.setState(s,(()=>BX.postComponentEvent("Crm.EntityTab::onSearch",[e])))}renderMoreButton(){return View({style:u.moreButtonView,onClick:()=>{this.showFilterSettings()}},Image({style:u.moreButtonImage,svg:{content:p}}))}showFilterSettings(){const e=currentDomain+"/bitrix/mobileapp/crmmobile/extensions/crm/entity-tab/search/";const t=e+"images/settings.png";this.menu=new ContextMenu({banner:{featureItems:[BX.message("M_CRM_ENTITY_TAB_SEARCH_FILTER_SETTINGS_CREATE_FILTER"),BX.message("M_CRM_ENTITY_TAB_SEARCH_FILTER_SETTINGS_MORE_SETTINGS"),BX.message("M_CRM_ENTITY_TAB_SEARCH_FILTER_SETTINGS_RESPONSIBLE"),BX.message("M_CRM_ENTITY_TAB_SEARCH_FILTER_SETTINGS_DEAL_SETTINGS")],imagePath:t,qrauth:{redirectUrl:this.props.link,type:"crm"}},params:{title:BX.message("M_CRM_ENTITY_TAB_SEARCH_FILTER_SETTINGS_TITLE")}});this.menu.show(PageManager)}fadeOut(){return new Promise((e=>{this.wrapperRef.animate({opacity:0,duration:300},e)}))}isVisible(){return this.state.visible}close(){this.props.layout.search.close()}}const u={wrapper:e=>({top:3,position:e?"absolute":"relative",zIndex:10,height:e?44:0,width:"100%",backgroundColor:"#f5f7f8"}),moreButtonView:{width:50,borderColor:"#c3f2ff",borderRadius:20,borderWidth:2,height:34,justifyContent:"center",alignItems:"center",marginHorizontal:10},moreButtonImage:{width:16,height:4},presetsScrollView:{height:44},presetsWrapper:{flexDirection:"row",alignItems:"center",marginTop:-6},contentWrapper:{borderTopLeftRadius:20,borderTopRightRadius:20,backgroundColor:"#fff"},listWrapper:{width:"100%",height:600},emptyResultsWrapper:{justifyContent:"center",alignItems:"center",width:"100%",height:"100%"},emptyResultsIcon:{width:86,height:86,marginTop:-86},searchContentTitle:{fontSize:13,color:"#525c69",marginBottom:10,marginLeft:20}};const p='<svg width="16" height="4" viewBox="0 0 16 4" fill="none" xmlns="http://www.w3.org/2000/svg">\n'+'<path d="M2 4C3.10457 4 4 3.10457 4 2C4 0.89543 3.10457 0 2 0C0.89543 0 0 0.89543 0 2C0 3.10457 0.89543 4 2 4Z" fill="#82888F"/>\n'+'<path d="M8 4C9.10457 4 10 3.10457 10 2C10 0.89543 9.10457 0 8 0C6.89543 0 6 0.89543 6 2C6 3.10457 6.89543 4 8 4Z" fill="#82888F"/>\n'+'<path d="M16 2C16 3.10457 15.1046 4 14 4C12.8954 4 12 3.10457 12 2C12 0.89543 12.8954 0 14 0C15.1046 0 16 0.89543 16 2Z" fill="#82888F"/>\n'+"</svg>";s.exports={Search:d}}));
//# sourceMappingURL=extension.map.js