jn.define("crm/entity-detail/toolbar/deal",((t,e,s)=>{const{isEqual:a,mergeImmutable:i}=t("utils/object");const{FadeView:r}=t("animation/components/fade-view");const{Alert:o}=t("alert");const{NavigationLoader:n}=t("navigation-loader");const{TypeId:l}=t("crm/type");const{StageToolbar:d}=t("crm/stage-toolbar");const{CategoryStorage:g}=t("crm/storage/category");const{connectionComponent:h}=t("communication/connection");class c extends LayoutComponent{constructor(t){super(t);const{detailCard:e,model:s}=t;if(e){this.setDetailCard(e)}if(s){this.setModel(s)}this.state=this.state||{};this.state.readOnly=true;this.state.category=this.loadCategory();this.state.activeStageId=this.getActiveStageId();this.readOnly=true;this.needDetailModel=true;this.handleStageSelect=this.handleStageSelect.bind(this);this.processStageChange=this.processStageChange.bind(this)}setDetailCard(t){this.detailCard=t;return this}setModel(t){this.model=t;return this}componentDidMount(){g.subscribeOnChange((()=>this.reloadCategory())).subscribeOnLoading((({status:t})=>n.setLoading(t))).markReady();layout.enableNavigationBarBorder(false)}loadCategory(){const t=this.getCategoryId();return this.loadCategoryById(t)}getCategoryId(){const t=this.getCategoryIdByModel();if(t){return t}if(this.props.hasOwnProperty("categoryId")){return this.props.categoryId}return null}getCategoryIdByModel(){if(!this.model||!this.model.hasOwnProperty("CATEGORY_ID")){return null}return this.model["CATEGORY_ID"]}loadCategoryById(t){if(t!==null){return g.getCategory(l.Deal,t)}return null}getActiveStageId(){const t=this.model&&this.model["STAGE_ID"];const e=this.getStageIdByStatusId(t);if(e!==null){return e}if(!this.isExistingEntity()){return this.findFirstStageId()}return null}reloadCategory(){const t=this.loadCategory();if(!a(this.state.category,t)){this.setState({category:t})}}refresh(){const t=this.readOnly;const e=this.loadCategory();const s=this.getActiveStageId();if(this.state.readOnly!==t||this.state.activeStageId!==s||!a(this.state.category,e)){this.setState({readOnly:t,category:e,activeStageId:s})}}setReadOnly(t){this.readOnly=Boolean(t);return this}getAllStages(){const{category:t}=this.state;if(t===null){return[]}return[...t.processStages,...t.successStages,...t.failedStages]}findFirstStageId(){const t=this.getAllStages();return t[0]&&t[0].id}getStageIdByStatusId(t){const e=this.getAllStages().find((e=>e.statusId===t));if(e){return e.id}return null}getStatusIdByStageId(t){const e=this.getAllStages().find((e=>e.id===t));if(e){return e.statusId}return null}isExistingEntity(){if(this.model){return this.model["ID"]>0}if(this.props.hasOwnProperty("entityId")){return this.props.entityId>0}return false}showHint(){Notify.showUniqueMessage(BX.message("M_CRM_E_D_TOOLBAR_DISABLED_HINT"),BX.message("M_CRM_E_D_TOOLBAR_DISABLED_TITLE"))}handleStageSelect({id:t}){if(this.state.readOnly){return}if(this.state.activeStageId!==t){this.lastStageId=this.state.activeStageId;this.setState({activeStageId:t})}}rollbackStageChange(){if(this.state.activeStageId!==this.lastStageId){this.setState({activeStageId:this.lastStageId})}}processStageChange(){if(this.state.readOnly){return}if(this.state.activeStageId===this.getActiveStageId()){return}Keyboard.dismiss();let t=Promise.resolve();if(this.detailCard.isToolPanelVisible()){t=t.then((()=>this.askToSaveAllData()))}t.then((()=>this.processSaveDetailCard())).catch((()=>this.rollbackStageChange()))}askToSaveAllData(){return new Promise(((t,e)=>{o.confirm(BX.message("M_CRM_E_D_TOOLBAR_CHANGE_STAGE_TITLE"),BX.message("M_CRM_E_D_TOOLBAR_CHANGE_STAGE_DESCRIPTION"),[{text:BX.message("M_CRM_E_D_TOOLBAR_CHANGE_STAGE_CANCEL"),type:"cancel",onPress:()=>e()},{text:BX.message("M_CRM_E_D_TOOLBAR_CHANGE_STAGE_SAVE"),type:"default",onPress:()=>t()}])}))}processSaveDetailCard(){return this.detailCard.handleSave({STAGE_ID:this.getStatusIdByStageId(this.state.activeStageId)})}getStyles(){return i(S,BX.prop.getObject(this.props,"style",{}))}render(){const{readOnly:t,category:e,activeStageId:s}=this.state;if(!e){return View()}const a=this.isExistingEntity();const i=this.getStyles();return View({style:i.rootWrapper,onClick:!a&&(()=>this.showHint())},new r({visible:false,fadeInOnMount:true,style:{},slot:()=>Shadow(i.shadow,View({style:{opacity:a?1:.3,...i.mainWrapper}},View({style:i.toolbarWrapper},new d({entityTypeId:l.Deal,category:e,activeStageId:s,showAllStages:false,isStageIconFaded:!a,isSelectorEnabled:a&&!t,onStageSelect:this.handleStageSelect,onViewHidden:this.processStageChange})),View({style:i.connectionWrapper},h({data:this.props.connections||{},options:{horizontal:true}}))))}))}}const S={rootWrapper:{position:"absolute",left:0,right:0,top:0},shadow:{color:"#e6e6e6",radius:3,offset:{y:3},inset:{left:3,right:3},style:{borderBottomLeftRadius:12,borderBottomRightRadius:12}},mainWrapper:{flexDirection:"row",height:60,paddingHorizontal:10,paddingTop:9,backgroundColor:"#ffffff",borderBottomLeftRadius:12,borderBottomRightRadius:12,justifyContent:"space-between",alignItems:"flex-start"},toolbarWrapper:{flex:2,marginRight:19},connectionWrapper:{marginTop:3}};s.exports={DealDetailToolbar:c}}));
//# sourceMappingURL=deal.map.js