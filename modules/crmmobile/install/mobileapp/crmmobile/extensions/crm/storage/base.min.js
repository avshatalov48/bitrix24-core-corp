jn.define("crm/storage/base",((t,e,s)=>{const{get:n,set:r,isEqual:a}=t("utils/object");const{BaseAjax:i}=t("crm/ajax/base");const h={OnChange:"onChange",OnLoading:"onLoading",OnReady:"onReady",NotifyAnotherContexts:"notifyAnotherContexts"};const o="data";const l="ttl";class u{constructor(){this.ready=false;this.fetchingSet=new Set;this.subscribers=new Map;this.eventId=null;BX.addCustomEvent(`${this.getEventNamespace()}::${h.NotifyAnotherContexts}`,this.publish.bind(this))}markReady(){if(this.ready){return}this.ready=true;this.publish(h.OnReady);return this}subscribeOnChange(t=null){const e=this.eventId?this.eventId+".onChange":null;return this.subscribe(h.OnChange,t,e)}subscribeOnLoading(t=null){const e=this.eventId?this.eventId+".onLoading":null;return this.subscribe(h.OnLoading,t,e)}subscribe(t,e,s=null){s=s||Symbol("eventId");this.subscribers.set(s,{event:t,handler:e});return this}unsubscribe(t){this.subscribers.delete(t);return this}publish(t,e={},s=true){Array.from(this.subscribers.values()).filter((e=>e.event===t)).forEach((({handler:t})=>t(e)));if(t===h.OnChange&&s){BX.postComponentEvent(`${this.getEventNamespace()}::${h.NotifyAnotherContexts}`,[t,{},false])}}publishOnChange(t={},e=true){this.publish(h.OnChange,t,e)}getDefaultTtl(){return 600}getCurrentTimeInSeconds(){return Math.floor(Date.now()/1e3)}cacheExpired(t){const e=this.getTtlValue(t);const s=this.getCurrentTimeInSeconds();return s>e+this.getDefaultTtl()}getAjax(){return null}getEventNamespace(){throw new Error("Abstract method must be implemented in child class")}getStorageKey(){throw new Error("Abstract method must be implemented in child class")}getStorageId(){return`crm/storage/${this.getStorageKey()}`}getStorage(){return Application.storageById(this.getStorageId())}getPathTo(...t){return t.join(".")}getTtlObject(){return this.getStorage().getObject(l,{})}getTtlValue(t){t+="."+l;return n(this.getTtlObject(),t,0)}setTtlValue(t,e){t+="."+l;const s=r(this.getTtlObject(),t,e);this.getStorage().setObject(l,s)}clearTtlValue(t){this.setTtlValue(t,0)}getDataObject(){return this.getStorage().getObject(o,{})}getDataValue(t,e=null){return n(this.getDataObject(),t,e)}setDataValue(t,e){const s=r(this.getDataObject(),t,e);this.getStorage().setObject(o,s)}emitLoading(t,e){this.publish(h.OnLoading,{status:e})}markRequestIsFetching(t,e){if(e){this.fetchingSet.add(t)}else{this.fetchingSet.delete(t)}}handleAjaxResponse(t,e){if(e.error||e.errors&&e.errors.length){console.warn(`Fetch error for ${this.getStorageId()} {${t}}.`,e);return}this.setTtlValue(t,this.getCurrentTimeInSeconds());this.updateDataInStorage(t,e.data)}updateDataInStorage(t,e,s=false){const n=this.getDataValue(t);if(!a(n,e)){this.setDataValue(t,e);if(!s){this.publishOnChange()}}}isFetching(t){return this.fetchingSet.has(t)}fetch(t,e,s=null){if(!this.getAjax()||this.isFetching(t)){return}this.markRequestIsFetching(t,true);if(this.ready){this.fetchInternal(t,e,s)}else{this.subscribe(h.OnReady,(()=>this.fetchInternal(t,e,s)))}}fetchInternal(t,e,s){this.emitLoading(t,true);this.getAjax().fetch(e,s).then((e=>this.handleAjaxResponse(t,e))).finally((()=>{this.emitLoading(t,false);this.markRequestIsFetching(t,false)}))}setEventId(t){this.eventId=t;return this}}s.exports={BaseStorage:u}}));
//# sourceMappingURL=base.map.js