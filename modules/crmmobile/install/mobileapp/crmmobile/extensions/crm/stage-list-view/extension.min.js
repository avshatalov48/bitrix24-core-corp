jn.define("crm/stage-list-view",((e,t,a)=>{const{isEqual:s,get:n,mergeImmutable:i}=e("utils/object");const{NavigationLoader:o}=e("navigation-loader");const{CategoryStorage:r}=e("crm/storage/category");const{StageList:l}=e("crm/stage-list");const{edit:g}=e("crm/assets/common");const{CategorySvg:c}=e("crm/assets/category");const{StageSelectActions:d}=e("crm/stage-list/actions");const{throttle:h}=e("utils/function");const{stringify:S}=e("utils/string");class u extends LayoutComponent{static open(e,t={},a=PageManager){return new Promise((s=>{const n={modal:true,backdrop:{showOnTop:true,forceDismissOnSwipeDown:true,horizontalSwipeAllowed:false,swipeContentAllowed:false,navigationBarColor:"#eef2f4"}};a.openWidget("layout",i(n,t)).then((t=>{t.showComponent(new this({...e,layout:t}));s(t)}))}))}constructor(e){super(e);this.layout=e.layout||layout;const t=this.getCategoryByProps(e);this.state={category:t};this.selectedStage=null;this.onSelectedStage=this.handlerOnSelectedStage.bind(this);this.onOpenStageDetail=this.handlerOnOpenStageDetail.bind(this);this.saveOnCreateTunnelHandler=h(this.saveOnCreateTunnel,1e3,this);this.saveOnChangeTunnelDestinationHandler=h(this.saveOnChangeTunnelDestination,1e3,this)}getCategoryByProps(e){const{entityTypeId:t,categoryId:a}=e;return r.getCategory(t,a)}getSelectStageAction(){return this.props.selectAction||d.ChangeEntityStage}componentDidMount(){r.subscribeOnChange((()=>this.reloadCategory())).subscribeOnLoading((({status:e})=>o.setLoading(e,this.layout))).markReady();this.layout.setListener((e=>{if(e==="onViewHidden"||e==="onViewRemoved"){this.handleOnViewHidden()}}));this.bindEvents();this.initNavigation()}reloadCategory(){const e=this.getCategoryByProps(this.props);if(!s(this.state.category,e)){this.setState({category:e},(()=>this.initNavigation()))}}handleOnViewHidden(){const{onViewHidden:e}=this.props;if(typeof e==="function"){e({stageAction:this.selectedStage?this.getSelectStageAction():null})}}bindEvents(){BX.addCustomEvent("Crm.CategoryDetail::onClose",(e=>{this.setState({category:e})}));BX.addCustomEvent("Crm.StageDetail::onUpdateStage",(e=>{this.setState((t=>{if(!this.hasStageChanged(t.category,"processStages",e)&&!this.hasStageChanged(t.category,"failedStages",e)&&!this.hasStageChanged(t.category,"successStages",e)){return}return{category:t.category}}),(()=>{BX.postComponentEvent("Crm.StageList::onStageInCategoryUpdated",[this.state.category,e])}))}))}getTitleForNavigation(){const{category:e}=this.state;if(!e){return BX.message("CRM_STAGE_LIST_VIEW_FUNNEL_NOT_LOADED_TITLE2")}return S(e.name)!==""?BX.message("CRM_STAGE_LIST_VIEW_FUNNEL_TITLE2").replace("#CATEGORY_NAME#",e.name):BX.message("CRM_STAGE_LIST_VIEW_FUNNEL_EMPTY_TITLE2")}isEditable(){return Boolean(n(this.state.category,"editable",false))}initNavigation(){this.layout.enableNavigationBarBorder(false);this.layout.setTitle({text:this.getTitleForNavigation(),svg:{content:c.funnelForTitle()}});if(this.isEditable()&&this.getSelectStageAction()===d.ChangeEntityStage){this.layout.setRightButtons([{type:"edit",svg:{content:g()},callback:()=>this.handlerCategoryEditOpen()}])}}saveOnCreateTunnel(){BX.postComponentEvent("Crm.TunnelList::onCreateTunnel",[])}saveOnChangeTunnelDestination(e){BX.postComponentEvent(`Crm.TunnelListItem::onChangeTunnelDestination-${e}`,[])}refreshTitle(){if(this.state.category){this.layout.setTitle({text:this.state.category.name},true)}}hasStageChanged(e,t,a){const s=e[t].find((e=>e.id===a.id));if(!s){return false}const n=e[t].indexOf(s);e[t][n]=a;return true}componentWillReceiveProps(e){this.state.category=this.getCategoryByProps(e)}handlerOnSelectedStage(e){const{category:t}=this.state;const{data:a,uid:s}=this.props;switch(this.getSelectStageAction()){case d.ChangeEntityStage:const{onStageSelect:n}=this.props;if(typeof n==="function"){n(e,t,a,s)}this.layout.close();break;case d.CreateTunnel:this.selectedStage=e;BX.postComponentEvent("Crm.TunnelList::selectStageOnCreateTunnel",[e]);if(this.selectedStage){this.saveOnCreateTunnelHandler()}this.layout.close();break;case d.SelectTunnelDestination:this.selectedStage=e;BX.postComponentEvent(`Crm.TunnelListItem::selectTunnelDestinationStage-${s}`,[e]);if(this.selectedStage){this.saveOnChangeTunnelDestinationHandler(s)}this.layout.close();break}}handlerCategoryEditOpen(){const{entityTypeId:e}=this.props;const{category:t}=this.state;ComponentHelper.openLayout({name:"crm:crm.category.detail",componentParams:{entityTypeId:e,categoryId:t.id},widgetParams:{modal:true,backdrop:{showOnTop:true,swipeContentAllowed:false,horizontalSwipeAllowed:false}}},this.layout)}render(){this.refreshTitle();const{category:e}=this.state;const{stageParams:t,canMoveStages:a,activeStageId:s}=this.props;return ScrollView({resizableByKeyboard:true,safeArea:{bottom:true,top:true,left:true,right:true},style:{flexDirection:"column",backgroundColor:"#eef3f5"}},e===null?new LoadingScreenComponent:new l({title:this.getStageListTitle(),readOnly:this.getStageReadOnly(),canMoveStages:a,stageParams:t,category:e,activeStageId:s,processStages:e.processStages,finalStages:[...e.successStages,...e.failedStages],onSelectedStage:this.onSelectedStage,onOpenStageDetail:this.onOpenStageDetail,enableStageSelect:this.props.enableStageSelect,disabledStageIds:this.getDisabledStageIdsByCategory(e)}))}getDisabledStageIdsByCategory(e){const t=this.getSelectStageAction();const a=[d.SelectTunnelDestination,d.CreateTunnel];if(a.includes(t)){const t=[...e.processStages,...e.successStages,...e.failedStages];const a=[];t.map((e=>{if(this.hasSameDstStage(e.tunnels,this.disabledStageIds)){a.push(e.id)}}));return a}return[]}hasSameDstStage(e,t){const a=e.filter((e=>t.includes(e.dstStageId)));return Boolean(a.length)}get disabledStageIds(){return BX.prop.getArray(this.props,"disabledStageIds",[])}getStageListTitle(){if(this.getSelectStageAction()===d.SelectTunnelDestination||this.getSelectStageAction()===d.CreateTunnel){return BX.message("CRM_STAGE_LIST_VIEW_BACKDROP_TUNNEL_TITLE")}return BX.message("CRM_STAGE_LIST_VIEW_STAGES_TITLE")}getStageReadOnly(){if(this.getSelectStageAction()===d.SelectTunnelDestination||this.getSelectStageAction()===d.CreateTunnel){return true}return this.props.readOnly}handlerOnOpenStageDetail(e){ComponentHelper.openLayout({name:"crm:crm.stage.detail",componentParams:{entityTypeId:this.props.entityTypeId,stage:e},widgetParams:{modal:true,backdrop:{showOnTop:true,forceDismissOnSwipeDown:true,horizontalSwipeAllowed:false,swipeContentAllowed:true}}})}}a.exports={StageListView:u}}));
//# sourceMappingURL=extension.map.js