jn.define("crm/product-grid/components/stateful-product-card",((t,e,o)=>{const{Loc:s}=t("loc");const{isEmpty:n}=t("utils/object");const{ProductCard:a}=t("layout/ui/product-grid/components/product-card");const{InlineSkuTree:i}=t("layout/ui/product-grid/components/inline-sku-tree");const{ProductRow:r}=t("crm/product-grid/model");const{ProductPricing:c}=t("crm/product-grid/components/product-pricing");const{ProductCalculator:u}=t("crm/product-calculator");const{ProductDetails:l}=t("crm/product-grid/components/product-details");const{SkuSelector:d}=t("crm/product-grid/components/sku-selector");const{ProductContextMenu:h}=t("crm/product-grid/menu/product-context-menu");const{Haptics:p}=t("haptics");class g extends LayoutComponent{constructor(t){super(t);this.statelessProductCardRef=null;this.state=this.buildState(t)}getProps(){return this.props}buildState(t){return{productRow:t.productRow}}componentWillReceiveProps(t){this.state=this.buildState(t)}hasVariations(){const t=this.state.productRow.getSkuTree();if(t&&t.OFFERS_PROP&&!n(t.OFFERS_PROP)){return true}return false}render(){return View({style:{backgroundColor:"#eef2f4",paddingTop:this.getProps().index===0?12:0}},new a({ref:t=>this.statelessProductCardRef=t,index:this.getProps().index+1,name:this.state.productRow.getProductName(),gallery:this.state.productRow.getPhotos(),renderInnerContent:()=>View({},this.hasVariations()&&new i({...this.state.productRow.getSkuTree(),editable:this.getProps().editable,onChangeSku:()=>this.showSkuSelector()}),new c({editable:this.getProps().editable,productRow:this.state.productRow,onChangePrice:t=>this.onChangePrice(t),onChangeSum:t=>this.onChangeSum(t),onChangeQuantity:t=>this.onChangeQuantity(t),onChangeDiscountValue:t=>this.onChangeDiscountValue(t),onChangeDiscountType:(t,e)=>this.onChangeDiscountType(t,e)})),onNameClick:()=>this.showProductDetailsBackdrop(),onImageClick:()=>this.showProductDetailsBackdrop(),onLongClick:()=>this.showProductContextMenu(),onContextMenuClick:()=>this.showProductContextMenu(),onRemove:this.getProps().editable?this.onRemove.bind(this):null}))}onRemove(){if(this.props.onRemove){this.props.onRemove(this.state.productRow)}}onChangePrice(t){this.recalculate((e=>e.calculateBasePrice(t)))}onChangeSum(t){this.recalculate((e=>e.calculateRowSum(t)))}onChangeQuantity(t){this.recalculate((e=>e.calculateQuantity(t)))}onChangeDiscountValue(t){this.recalculate((e=>e.calculateDiscount(t)))}onChangeDiscountType(t,e){if(e===false){this.recalculate((e=>e.calculateDiscountType(t)))}else{this.recalculate((o=>o.pipe((e=>e.calculateDiscountType(t))).pipe((t=>t.calculateDiscount(e))).getFields()))}}onChangeVariation({variationData:t,quantity:e,skuTree:o}){const s=this.state.productRow;const n=s.getRawValues();const a={PRODUCT_NAME:t.NAME,GALLERY:t.GALLERY,PRODUCT_ID:t.ID,TAX_RATE:t.TAX_RATE,TAX_INCLUDED:t.TAX_INCLUDED?"Y":"N",SKU_TREE:o,BARCODE:t.BARCODE};s.setFields({...n,...a});const i=t.TAX_INCLUDED?t.PRICE:t.PRICE_BEFORE_TAX;const r=new u(s.getRawValues());const c=r.pipe((t=>t.calculateQuantity(e))).pipe((t=>t.calculateBasePrice(i))).getFields();s.setFields(c);this.setState({productRow:s},(()=>{this.blink();this.onChange()}))}onChange(){if(this.props.onChange){this.props.onChange(this.state.productRow)}}recalculate(t,e){const o=this.state.productRow;const s=new u(o.getRawValues());const n=t(s);o.setFields(n);const a=e?e(o):{productRow:o};this.setState(a,(()=>this.onChange()))}showProductDetailsBackdrop(){const t=this.state.productRow;PageManager.openWidget("layout",{modal:true,backdrop:{onlyMediumPosition:false,mediumPositionPercent:80,navigationBarColor:"#EEF2F4",swipeAllowed:true,swipeContentAllowed:false,horizontalSwipeAllowed:false},onReady:e=>{e.showComponent(new l({layout:e,productData:t.getRawValues(),editable:this.getProps().editable,iblockId:this.getProps().iblockId,measures:this.getProps().measures,vatRates:this.getProps().vatRates,inventoryControlEnabled:this.getProps().inventoryControlEnabled,entityDetailPageUrl:this.getProps().entityDetailPageUrl,onChange:e=>{t.setFields(e);this.setState({productRow:t},(()=>{this.blink();this.onChange()}))}}))}})}showSkuSelector(){const t=this.state.productRow;const e={onlyMediumPosition:true,swipeAllowed:true,swipeContentAllowed:true,mediumPositionPercent:80,navigationBarColor:"#EEF2F4"};PageManager.openWidget("layout",{backdrop:e}).then((e=>{e.showComponent(new d({layout:e,selectedVariationId:t.getProductId(),quantity:t.getQuantity(),currencyId:t.getCurrency(),skuTree:t.getSkuTree(),measureName:t.getMeasureName(),saveButtonCaption:s.getMessage("PRODUCT_GRID_PRODUCT_CARD_SELECT_SKU"),onSave:t=>this.onChangeVariation(t)}))}))}showProductContextMenu(){p.impactLight();const t=new h({editable:this.getProps().editable,hasVariations:this.hasVariations(),onChooseEdit:()=>this.showProductDetailsBackdrop(),onChooseOpen:()=>this.showProductDetailsBackdrop(),onChooseRemove:()=>this.onRemove(),onChooseChangeSku:()=>this.showSkuSelector()});t.show()}blink(){if(this.statelessProductCardRef){this.statelessProductCardRef.blink()}}}o.exports={StatefulProductCard:g}}));
//# sourceMappingURL=extension.map.js