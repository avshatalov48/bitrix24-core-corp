jn.define("crm/product-grid/components/product-details",((e,t,i)=>{const{Alert:s}=e("alert");const{Loc:o}=e("loc");const{ProductRow:a}=e("crm/product-grid/model");const{ProductCalculator:n,DiscountType:l}=e("crm/product-calculator");const{Container:r,Island:d,Title:u,FormGroup:c}=e("layout/ui/islands");const{BarcodeField:R}=e("layout/ui/fields/barcode");const{BooleanField:D}=e("layout/ui/fields/boolean");const{CombinedField:_}=e("layout/ui/fields/combined");const{DateTimeField:T}=e("layout/ui/fields/datetime");const{FileField:g}=e("layout/ui/fields/file");const{EntitySelectorField:h}=e("layout/ui/fields/entity-selector");const{MoneyField:p}=e("layout/ui/fields/money");const{NumberField:O,NumberPrecision:I}=e("layout/ui/fields/number");const{SelectField:E}=e("layout/ui/fields/select");const{StringField:y}=e("layout/ui/fields/string");const{notify:C}=e("layout/ui/product-grid/components/hint");const{debounce:P}=e("utils/function");const{isObjectLike:F,isArray:m,clone:U}=e("utils/object");class S extends LayoutComponent{constructor(e){super(e);this.state={productRow:new a(U(this.props.productData)),reservedQuantity:null,reserveEndDate:null};this.photoFieldRef=null;this.layout=e.layout;this.initLayout()}get productRow(){return this.state.productRow}getProps(){return this.props}initLayout(){const e=this.isReadonly()?o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_CLOSE"):o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_DONE");this.layout.setTitle({text:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_BACKDROP_TITLE")});this.layout.setRightButtons([{name:e,type:"text",color:"#0b66c3",callback:()=>this.close()}]);this.layout.enableNavigationBarBorder(false)}close(){if(this.isReadonly()){this.layout.close()}else if(this.hasUploadingFiles()){this.showAlertToWaitUploading()}else if(this.validate()){this.onChange();this.layout.close()}}hasUploadingFiles(){if(!this.photoFieldRef){return false}return this.photoFieldRef.hasUploadingFiles()}showAlertToWaitUploading(){s.alert(BX.message("PRODUCT_GRID_PRODUCT_DETAILS_PHOTOS_UPLOADING"),BX.message("PRODUCT_GRID_PRODUCT_DETAILS_PHOTOS_UPLOADING_DESC"),null,BX.message("PRODUCT_GRID_PRODUCT_DETAILS_PHOTOS_UPLOADING_BUTTON"))}isReadonly(){return!this.getProps().editable}validate(){return!this.nameFieldRef||this.nameFieldRef.validate()}onChange(){if(this.props.onChange){this.props.onChange(this.productRow.getRawValues())}}render(){return r(d(u(o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_TITLE_ABOUT")),c(this.nameField(),this.sectionsField(),this.barcodeField(),this.galleryField())),d(u(o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_TITLE_PRICING")),c(this.priceField(),this.quantityField(),this.discountField(),this.taxField(),this.totalSumField())),this.getProps().inventoryControlEnabled&&UI.BannerButton({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_INVENTORY_CONTROL_INTEGRATION_TITLE"),description:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_INVENTORY_CONTROL_INTEGRATION_BODY"),onClick:()=>this.openEntityDesktopPage()}))}nameField(){return y({ref:e=>this.nameFieldRef=e,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_NAME"),value:this.productRow.getProductName(),readOnly:this.isReadonly(),required:true,onChange:e=>this.setField("PRODUCT_NAME",e)})}sectionsField(){return h({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_SECTIONS"),value:this.productRow.getSections().map((e=>e.ID)),readOnly:this.isReadonly(),multiple:true,config:{selectorType:EntitySelectorFactory.Type.SECTION,enableCreation:true,provider:{options:{iblockId:this.getProps().iblockId}},entityList:this.productRow.getSections().map((e=>({title:e.NAME,id:e.ID,type:"section"}))),parentWidget:this.layout},onChange:(e,t)=>{const i=t.map((e=>({ID:e.id,NAME:e.title})));this.setField("SECTIONS",i)}})}barcodeField(){return R({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_BARCODE"),value:this.productRow.getBarcode(),readOnly:this.isReadonly(),config:{parentWidget:this.layout},onChange:e=>{this.setField("BARCODE",e)}})}galleryField(){const e=this.productRow.getField("GALLERY",[]);const t={};const i=e.map((e=>{if(e.id&&Number.isInteger(parseInt(e.id))){t[e.id]=U(e);return e.id}return U(e)}));return g({ref:e=>this.photoFieldRef=e,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_PHOTOS"),multiple:true,value:i,config:{fileInfo:t,mediaType:"image",parentWidget:this.layout,controller:{entityId:"catalog-product",options:{productId:this.productRow.getProductId()}}},readOnly:this.isReadonly(),onChange:e=>{const i=[];e=m(e)?e:[];e.map((e=>{if(F(e)){i.push(e)}else if(t[e]){i.push(t[e])}}));this.setField("GALLERY",i)}})}priceField(){return p({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_PRICE"),value:{amount:this.productRow.getBasePrice(),currency:this.productRow.getCurrency()},readOnly:!this.productRow.isPriceEditable()||this.isReadonly(),config:{currencyReadOnly:true,selectionOnFocus:true},onChange:e=>{this.recalculate((t=>t.calculateBasePrice(e.amount)))},onContentClick:!this.productRow.isPriceEditable()&&(()=>{const e=o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_PRICE_CHANGE_DISABLED_TITLE");const t=o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_PRICE_CHANGE_DISABLED_BODY2");const i=5;C({title:e,message:t,seconds:i})})})}quantityField(){return _({value:{amount:this.productRow.getQuantity(),measureCode:this.productRow.getMeasureCode()},onChange:e=>{const{amount:t,measureCode:i}=e;const s=this.getProps().measures.find((e=>String(e.code)===String(i)));this.recalculate((e=>e.calculateQuantity(t)));if(s){this.setField("MEASURE_CODE",s.code);this.setField("MEASURE_NAME",s.name)}},config:{primaryField:{id:"amount",renderField:O,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_QUANTITY"),placeholder:"0",readOnly:this.isReadonly(),config:{type:I.INTEGER,selectionOnFocus:true}},secondaryField:{id:"measureCode",renderField:E,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_MEASURE"),readOnly:this.isReadonly(),required:true,showRequired:false,config:{items:this.getProps().measures.map((e=>({name:e.name,value:e.code})))}}}})}discountField(){const e=new Money({amount:0,currency:this.productRow.getCurrency()});const t=this.productRow.getDiscountType();const i=t===l.MONETARY?this.productRow.getDiscountSum():this.productRow.getDiscountRate();return _({value:{discountValue:String(i),discountType:t},onChange:P((e=>{const i=Number(e.discountType);const s=Number(e.discountValue);if(i!==t){this.recalculate((e=>e.calculateDiscountType(i)))}else{this.recalculate((e=>e.calculateDiscount(s)))}}),300),config:{primaryField:{id:"discountValue",renderField:O,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_DISCOUNT"),placeholder:"0",readOnly:this.isReadonly(),config:{type:I.DOUBLE,precision:2,selectionOnFocus:true}},secondaryField:{id:"discountType",renderField:E,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_DISCOUNT_TYPE"),readOnly:this.isReadonly(),required:true,showRequired:false,config:{items:[{name:e.formattedCurrency,value:l.MONETARY},{name:"%",value:l.PERCENTAGE}]}}}})}taxField(){if(this.productRow.isTaxMode()){return null}let e=this.getProps().vatRates;let t=this.isReadonly();if(!e.length){e=[{id:0,name:`${this.productRow.getTaxRate()}%`,value:this.productRow.getTaxRate()}];t=true}const i=t=>{const i=e.find((e=>e.value===t));return i?String(i.id):""};const s=t=>{t=Number(t);const i=e.find((e=>e.id===t));return i?i.value:0};return _({value:{taxRate:i(this.productRow.getTaxRate()),taxIncluded:this.productRow.isTaxIncluded()},onChange:e=>{const t=s(e.taxRate);const i=e.taxIncluded?"Y":"N";this.recalculate((e=>e.pipe((e=>e.calculateTaxIncluded(i))).pipe((e=>e.calculateTax(t))).getFields()))},config:{primaryField:{id:"taxRate",renderField:E,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_TAX_RATE"),placeholder:"0",readOnly:t,required:true,showRequired:false,config:{items:e.map((e=>({name:e.name,value:e.id})))}},secondaryField:{id:"taxIncluded",renderField:D,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_TAX_INCLUDED"),readOnly:this.isReadonly(),required:false}}})}totalSumField(){return p({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_SUM"),value:{amount:this.productRow.getSum(),currency:this.productRow.getCurrency()},readOnly:this.isReadonly(),config:{currencyReadOnly:true,selectionOnFocus:true},onChange:e=>{this.recalculate((t=>t.calculateRowSum(e.amount)))}})}storeField(){let e=null;const t=[];return h({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_STORE"),value:e,readOnly:this.isReadonly(),multiple:false,config:{selectorType:EntitySelectorFactory.Type.STORE,enableCreation:true,entityList:t,provider:{options:{useAddressAsTitle:true}},parentWidget:this.layout},onChange:(e,t)=>{console.log(e,t)}})}storeBalanceField(){const e=`17 ${this.productRow.getMeasureName()}`;return y({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_STORE_BALANCE"),value:e,readOnly:true,required:false})}storeReservedField(){const e=`3 ${this.productRow.getMeasureName()}`;return y({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_STORE_RESERVED"),value:e,readOnly:true,required:false})}reserveQuantityField(){return _({value:{amount:this.state.reservedQuantity,measure:this.productRow.getMeasureCode()},onChange:e=>{const{amount:t}=e;this.setState({reservedQuantity:t})},config:{primaryField:{id:"amount",renderField:O,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_RESERVE"),placeholder:"0",readOnly:this.isReadonly(),config:{type:I.INTEGER,selectionOnFocus:true}},secondaryField:{id:"measure",renderField:E,title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_MEASURE"),readOnly:true,required:true,showRequired:false,config:{items:this.getProps().measures.map((e=>({name:e.name,value:e.code})))}}}})}reserveDateField(){return T({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_FIELD_RESERVE_TILL"),value:this.state.reserveEndDate,readOnly:this.isReadonly(),required:false,config:{enableTime:false},onChange:e=>{this.setState({reserveEndDate:e})}})}setField(e,t){const i=this.state.productRow;i.setField(e,t);this.setState({productRow:i})}recalculate(e){const t=this.state.productRow;const i=new n(t.getRawValues());const s=e(i);t.setFields(s);this.setState({productRow:t})}openEntityDesktopPage(){qrauth.open({title:o.getMessage("PRODUCT_GRID_PRODUCT_DETAILS_DESKTOP_VERSION"),redirectUrl:this.getProps().entityDetailPageUrl,layout:this.layout})}}i.exports={ProductDetails:S}}));
//# sourceMappingURL=extension.map.js