jn.define("crm/product-grid",((t,e,r)=>{const{Loc:o}=t("loc");const{clone:s}=t("utils/object");const{ProductGrid:d}=t("layout/ui/product-grid");const{Alert:c}=t("alert");const{ProductSelector:i}=t("layout/ui/product-grid/services/product-selector");const{BarcodeScanner:a}=t("layout/ui/product-grid/services/barcode-scanner");const{CurrencyConverter:n}=t("crm/product-grid/services/currency-converter");const{ProductWizard:u}=t("crm/product-grid/services/product-wizard");const{ProductRow:l}=t("crm/product-grid/model");const{StatefulProductCard:h}=t("crm/product-grid/components/stateful-product-card");const{ProductModelLoader:m}=t("crm/product-grid/services/product-model-loader");const{ProductAddMenu:p}=t("crm/product-grid/menu/product-add");const{ProductCalculator:y}=t("crm/product-calculator");class g extends d{constructor(t){super(t);this.itemRefs={};this.delayedRefHandlers={}}componentDidMount(){super.componentDidMount();const{totalCost:t,currency:e,totalRows:r}=this.getSummary();this.customEventEmitter.emit(CatalogStoreEvents.ProductList.TotalChanged,[{count:r,total:{amount:t,currency:e}}])}getProps(){return this.props}buildState(t){return{products:s(t.products).map((t=>l.createRecalculated(t))),summary:s(t.summary),currencyId:t.entity.currencyId}}initServices(){const{catalog:t,entity:e}=this.getProps();this.productSelector=new i({iblockId:t.id,basePriceId:t.basePriceId,currency:this.state.currencyId,onSelect:t=>this.addExistedProductById(t),onCreate:(t,e)=>this.productWizard.open(t,e)});this.barcodeScanner=new a({onSelect:t=>this.addExistedProductById(t)});this.productModelLoader=new m({entityId:e.id,entityTypeName:e.typeName,categoryId:e.categoryId,ajaxErrorHandler:this.props.ajaxErrorHandler});this.productWizard=new u({currencyId:this.state.currencyId,onFinish:t=>this.addCreatedProductFromWizard(t)});this.currencyConverter=new n;this.cache=Application.storageById("CrmProductGrid")}getItems(){return this.state.products}setItems(t,e){this.setStateWithNotification({products:t},e)}getSummary(){return this.state.summary}isEditable(){return Boolean(this.getProps().entity.editable)}renderSingleItem(t,e){const{catalog:r,measures:o,inventoryControl:s,entity:d,taxes:c}=this.getProps();return new h({ref:e=>{this.itemRefs[t.getId()]=e;if(e&&this.delayedRefHandlers[t.getId()]){const r=this.delayedRefHandlers[t.getId()];delete this.delayedRefHandlers[t.getId()];r(e)}},productRow:t,index:e,measures:o,editable:this.isEditable(),vatRates:c.vatRates,iblockId:r.id,inventoryControlEnabled:s.enabled,entityDetailPageUrl:d.detailPageUrl,onChange:t=>{this.unifyTaxIncludedByRow(t);this.notifyGridChanged();this.fetchTotals()},onRemove:t=>this.removeItem(t)})}removeItem(t){c.confirm("",o.getMessage("PRODUCT_GRID_REMOVE_PRODUCT_ROW"),[{type:"cancel"},{text:o.getMessage("PRODUCT_GRID_REMOVE_CONFIRM_OK"),type:"destructive",onPress:()=>{const e=this.getItems().filter((e=>e.getId()!==t.getId()));this.setItems(e,(()=>this.fetchTotals()))}}])}addExistedProductById(t){this.loadProductModel(t).then((({productRow:t})=>{this.addItem(t)}))}addCreatedProductFromWizard(t){const e=Number(t.ID);this.loadProductModel(e).then((({productRow:t})=>{t.setPriceEditable(true).forceSavePrice(true);this.addItem(t)}))}loadProductModel(t){const e={};if(this.taxIncludedFlagMustBeUnified()){const t=this.getItems()[0];if(t){e.TAX_INCLUDED=t.getField("TAX_INCLUDED")}}return this.productModelLoader.load(t,this.state.currencyId,e)}addItem(t){const e=this.getItems();e.push(t);this.setStateWithNotification({products:e},(()=>{this.fetchTotals();this.scrollListToTheEnd();const e=t=>{if(t.hasVariations()){t.showSkuSelector()}else{t.blink()}};const r=this.itemRefs[t.getId()];if(r){e(r)}else{this.delayedRefHandlers[t.getId()]=e}}))}fetchTotals(){if(this.getItems().length===0){this.customEventEmitter.emit(CatalogStoreEvents.ProductList.TotalChanged,[{count:0,total:{amount:0,currency:this.state.currencyId}}]);return}const{entity:t}=this.getProps();const e="crmmobile.ProductGrid.loadProductGridSummary";const r={json:{entityId:t.id,entityTypeName:t.typeName,categoryId:t.categoryId,currencyId:this.state.currencyId,products:this.getItems().map((t=>t.getRawValues()))}};this.forceUpdateSummary((()=>new Promise(((t,s)=>{BX.ajax.runAction(e,r).then((e=>{this.state.summary=e.data;const{totalCost:r,currency:o,totalRows:s}=e.data;this.customEventEmitter.emit(CatalogStoreEvents.ProductList.TotalChanged,[{count:s,total:{amount:r,currency:o}}]);t(e.data)})).catch((t=>{if(this.props.ajaxErrorHandler){return this.props.ajaxErrorHandler(t)}console.error(t);void ErrorNotifier.showError(o.getMessage("M_CRM_PRODUCT_GRID_SUM_LOADING_ERROR"));s(t)}))}))))}onAddItemButtonClick(){return this.showProductAddMenu()}onAddItemButtonLongClick(){return this.replayLastProductAddAction()}showProductAddMenu(){const{entity:t}=this.getProps();const e=new p({analytics:{entityTypeName:t.typeName},onChooseBarcode:()=>{this.cache.set("last_product_add_action","barcode");this.barcodeScanner.open()},onChooseDb:()=>{this.cache.set("last_product_add_action","db");this.productSelector.open()}});e.show()}replayLastProductAddAction(){const t="db";const e=this.cache.get("last_product_add_action",t);const r=e==="barcode"?this.barcodeScanner:this.productSelector;r.open()}unifyTaxIncludedByRow(t){if(this.taxIncludedFlagMustBeUnified()){let e=false;const r=this.getItems().map((r=>{if(r.isTaxIncluded()===t.isTaxIncluded()){return r}e=true;const o=t.isTaxIncluded()?"Y":"N";const s=new y(r.getRawValues());return r.setFields(s.calculateTaxIncluded(o))}));if(e){Keyboard.dismiss();this.setItems(r)}}}taxIncludedFlagMustBeUnified(){return Boolean(this.getProps().taxes.productRowTaxUniform)}notifyGridChanged(){const{tabId:t}=this.getProps();this.customEventEmitter.emit(CatalogStoreEvents.Document.TabChange,[t])}setCurrency(t){if(this.state.currencyId!==t){this.currencyConverter.convert(this.getItems(),t).then((e=>{this.setStateWithNotification({products:e,currencyId:t},(()=>this.fetchTotals()))}))}}getEmptyScreenTitle(){return o.getMessage("M_CRM_PRODUCT_GRID_EMPTY_TITLE")}getEmptyScreenDescription(){return o.getMessage("M_CRM_PRODUCT_GRID_EMPTY_DESCRIPTION")}}r.exports={CrmProductGrid:g}}));
//# sourceMappingURL=extension.map.js