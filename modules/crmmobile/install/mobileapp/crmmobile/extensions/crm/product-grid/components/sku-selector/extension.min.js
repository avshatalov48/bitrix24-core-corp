jn.define("crm/product-grid/components/sku-selector",((e,t,r)=>{const{Loc:i}=e("loc");const{isArray:s,get:o,clone:n,mergeImmutable:a,isEqual:l}=e("utils/object");const{debounce:c}=e("utils/function");const{ProductGridStringField:u}=e("layout/ui/product-grid/components/string-field");const{PriceDetails:d}=e("layout/ui/product-grid/components/price-details");const{FocusContext:h}=e("layout/ui/product-grid/services/focus-context");const{BottomPanel:p,Price:E,ProductInfo:R,Scrollable:y,SkuTreeContainer:T,SkuTreeProperty:V,SkuTreePropertyValue:P}=e("crm/product-grid/components/sku-selector/elements");class S extends LayoutComponent{constructor(e){super(e);this.layout=e.layout;this.state={loading:true};this.productVariations=null;this.wrapperRef=null;this.preloadSkuCollection().then((()=>{const t=this.buildState(e);this.setState(t,(()=>this.fadeIn()))}));this.initLayout()}buildState(e){return{loading:false,selectedVariationId:e.selectedVariationId,quantity:e.quantity}}initLayout(){this.layout.setTitle({text:i.getMessage("PRODUCT_GRID_CONTROL_SKU_SELECTOR_CHOOSE_VARIATION")});this.layout.enableNavigationBarBorder(false)}preloadSkuCollection(){return new Promise(((e,t)=>{if(this.productVariations===null){const r=this.props.selectedVariationId;const s=this.props.currencyId;const o="crmmobile.ProductGrid.loadSkuCollection";const n={json:{variationId:r,currencyId:s}};BX.ajax.runAction(o,n).then((t=>{this.productVariations=t.data.variations;e(this.productVariations)})).catch((e=>{void ErrorNotifier.showError(i.getMessage("PRODUCT_GRID_CONTROL_SKU_SELECTOR_LOADING_ERROR"));console.error(e);t(e)}))}else{e(this.productVariations)}}))}get skuTree(){return this.props.skuTree}get selectedVariation(){return this.productVariations[this.state.selectedVariationId]}get selectedPropertyValues(){const e=this.skuTree.OFFERS.find((e=>e.ID===this.state.selectedVariationId));return e?e.TREE:{}}render(){return this.wrap((()=>[y(R({name:this.selectedVariation.NAME,images:this.selectedVariation.GALLERY.map((e=>e.previewUrl))}),this.renderSkuTree()),this.renderSavePanel()]))}wrap(e){const t=this.state.loading?[new LoadingScreenComponent]:e();return View({ref:e=>this.wrapperRef=e,style:{flexDirection:"column",opacity:this.state.loading?1:0},resizableByKeyboard:true,onClick:()=>h.blur()},...t)}renderSkuTree(){const e=Object.values(this.skuTree.OFFERS_PROP||{});return T(...e.map(((e,t)=>V(e.NAME,...this.renderPropertyValues(e,t)))))}renderPropertyValues(e,t){const r=e.VALUES||[];const i=this.filterAllowedToChoosePropertyValues(e,t);const n=this.selectedPropertyValues[e.ID]||[];const a=e=>s(n)?n.includes(e):n===e;return r.map((t=>{if(!i.includes(t.ID)){return null}if(!t.NAME.length){return null}return P({onClick:()=>this.toggleSelection(e.ID,t.ID),selected:a(t.ID),picture:o(t,"PICT.SRC",null),name:t.NAME})}))}renderSavePanel(){const e=this.props.saveButtonCaption||i.getMessage("PRODUCT_GRID_CONTROL_SKU_SELECTOR_SAVE");return p({saveButtonCaption:e,price:this.renderBottomPanelPrice(),quantity:this.renderBottomPanelQuantity(),onSave:()=>this.save()})}renderBottomPanelPrice(){return E({amount:this.selectedVariation.PRICE,currency:this.selectedVariation.CURRENCY,emptyPrice:this.selectedVariation.EMPTY_PRICE,taxMode:this.selectedVariation.TAX_MODE,onClick:()=>this.showPriceInfo()})}renderBottomPanelQuantity(){const e=e=>this.setState({quantity:e.value});return View({style:{width:150}},new u({value:this.state.quantity,placeholder:"0",keyboardType:"decimal-pad",useIncrement:true,useDecrement:true,min:1,step:1,label:this.props.measureName,labelAlign:"center",textAlign:"center",onBlur:e,onIncrement:c(e,300),onDecrement:c(e,300)}))}filterAllowedToChoosePropertyValues(e,t){const r=(e,t)=>{for(let r in e){if(!Object.keys(t).includes(r))return false;if(t[r]!==e[r])return false}return true};const i=e=>this.skuTree.OFFERS.find((t=>r(e,t.TREE)));const s=()=>{const t=this.skuTree.OFFERS.map((t=>t.TREE[e.ID]));return[...new Set(t)]};const o=this.selectedPropertyValues;const n=[];const a=Object.values(this.skuTree.OFFERS_PROP||{});const l={};a.map(((e,r)=>{if(r<t){l[e.ID]=o[e.ID]}}));s().forEach((t=>{l[e.ID]=t;if(i(l)){n.push(t)}}));return n}toggleSelection(e,t){const r=this.preparePropertyValue(e,t);const s=a(this.selectedPropertyValues,{[e]:r});const o=this.findNextVariation(e,r,s);if(o!==null&&this.productVariations[o.ID]){this.setState({selectedVariationId:o.ID});return}void ErrorNotifier.showError(i.getMessage("PRODUCT_GRID_CONTROL_SKU_SELECTOR_CHOOSE_VARIATION_ERROR"))}preparePropertyValue(e,t){let r=n(this.selectedPropertyValues[e]);if(s(r)){const e=r.indexOf(t);if(e>-1){r.splice(e,1)}else{r.push(t)}}else{r=t}return r}findNextVariation(e,t,r){let i=null;const s=[];this.skuTree.OFFERS.map((o=>{if(l(o.TREE,r)){i=o}if(o.TREE[e]&&l(o.TREE[e],t)){s.push(o)}}));if(i===null&&s.length){i=s.shift()}return i}showPriceInfo(){const e={onlyMediumPosition:true,swipeAllowed:true,mediumPositionHeight:250,navigationBarColor:"#EEF2F4"};this.layout.openWidget("layout",{backdrop:e}).then((e=>{e.showComponent(new d({layout:e,title:i.getMessage("PRODUCT_GRID_CONTROL_SKU_SELECTOR_BASE_PRICE_INFO"),priceBeforeTax:this.selectedVariation.PRICE_BEFORE_TAX,taxRate:this.selectedVariation.TAX_RATE,taxValue:this.selectedVariation.TAX_VALUE,taxName:this.selectedVariation.TAX_NAME,finalPrice:this.selectedVariation.PRICE,currency:this.selectedVariation.CURRENCY}))}))}save(){if(this.props.onSave){const e=n(this.skuTree);e.SELECTED_VALUES=n(this.selectedPropertyValues);this.props.onSave({skuTree:e,variationId:this.state.selectedVariationId,variationData:this.selectedVariation,quantity:this.state.quantity})}this.layout.close()}fadeIn(){if(this.wrapperRef){this.wrapperRef.animate({duration:300,opacity:1})}}}r.exports={SkuSelector:S}}));
//# sourceMappingURL=extension.map.js