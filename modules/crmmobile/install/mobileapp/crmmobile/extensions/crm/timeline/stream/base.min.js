jn.define("crm/timeline/stream/base",((e,t,i)=>{const{Loc:s}=e("loc");const{TimelineItemModel:o,TimelineItemFactory:n}=e("crm/timeline/item");const{isArray:r}=e("utils/object");const{mapPromise:m}=e("utils/function");const{TimelineItemBackground:l}=e("crm/timeline/item/ui/styles");const{Patch:a}=e("crm/timeline/stream/utils/patch");class h{constructor(e){const{items:t,timelineScopeEventBus:i,isEditable:s,onChange:o,onItemAction:n}=e;this.items=[];this.setItems(t);this.timelineScopeEventBus=i;this.isEditable=s;this.onChangeHandler=o;this.onItemActionHandler=n;this.itemRefs={};this.listViewRef=null;this.itemPositionCalculator=null}exportToListView(){}getId(){}getItemSortDirection(){}registerListViewRef(e){if(e)this.listViewRef=e}setItemPositionCalculator(e){this.itemPositionCalculator=e}makeItemModel(e){return new o({...e,isEditable:this.isEditable})}setItems(e){this.items=e.map((e=>this.makeItemModel(e)))}getItems(){return this.items}hasItem(e){if(this.findItem(e)){return true}return false}findItem(e){return this.items.find((t=>t.id==e))}findItemIndex(e){return this.items.findIndex((t=>t.id==e))}findItemRef(e){return this.itemRefs[e]||null}makePatch(e){const t=this.exportToListView();e();const i=this.exportToListView();return new a(t,i)}animateAddRemove(e,t="automatic"){const i=()=>m(e.getRemovedItems(),(e=>new Promise((i=>{const{section:s,index:o}=this.listViewRef.getElementPosition(e.key);this.listViewRef.deleteRow(s,o,t,i)}))));const s=()=>m(e.getAddedItems(),(e=>{const i=this.itemPositionCalculator.calculateByKey(e.key);if(i>-1){this.listViewRef.insertRows([e],0,i,t).then((()=>Promise.resolve()))}else{return Promise.resolve()}}));return i().then((()=>s()))}addItem(e){const t=this.makePatch((()=>{const t=this.makeItemModel(e);this.items.push(t);this.resort()}));return this.animateAddRemove(t)}updateItem(e,t,i=true){const s=this.makeItemModel(t);const o=this.findItemIndex(e);if(o<0){return Promise.resolve()}const n=this.makePatch((()=>{this.items.splice(o,1,s);this.resort()}));const r=this.prepareItemKey(s);const m=this.exportItem(s);return this.animateAddRemove(n,i?"automatic":"none").then((()=>this.listViewRef.updateRows([m]))).then((()=>{if(n.isItemMoved(r)){const e=this.itemPositionCalculator.calculateByKey(r);return this.listViewRef.moveRow(m,0,e,i)}return Promise.resolve()}))}deleteItem(e){const t=this.makePatch((()=>{const t=this.findItemIndex(e);if(t>-1){this.items.splice(t,1)}}));return this.animateAddRemove(t)}resort(){const e=this.getItemSortDirection();this.items.sort(((t,i)=>{for(let s=0;s<t.sort.length;s++){const o=t.sort[s];const n=i.sort[s]||0;if(o===n){continue}return e==="asc"?o-n:n-o}return 0}))}exportCollapsibleGroup(e){let t=[];let i=[];e.forEach((e=>{if(e.isCompatible){t.push(e)}else{if(t.length){i.push(t);t=[]}i.push(e)}}));if(t.length){i.push(t)}return i.map((e=>r(e)?this.exportCollapsedRecords(e):this.exportItem(e)))}exportCollapsedRecords(e){const t=e[0];if(e.length===1){return{type:"RecordNotSupported",key:`RecordNotSupported_${t.id}`,props:{title:s.getMessage("CRM_TIMELINE_ITEM_NOT_SUPPORTED_TITLE"),description:s.getMessage("CRM_TIMELINE_ITEM_NOT_SUPPORTED_DESCRIPTION"),style:{marginBottom:16,innerOpacity:.6,backgroundColor:l.getByModel(t)}}}}const i={"#NUM#":e.length};return{type:"RecordsNotSupported",key:`RecordsNotSupported_${t.id}`,props:{title:s.getMessagePlural("CRM_TIMELINE_ITEM_NOT_SUPPORTED_MULTIPLE_TITLE",e.length,i),description:s.getMessage("CRM_TIMELINE_ITEM_NOT_SUPPORTED_MULTIPLE_DESCRIPTION"),style:{marginBottom:16,innerOpacity:.6,backgroundColor:l.getByModel(t)}}}}exportItem(e){return{type:`TimelineItem:${this.getId()}`,key:this.prepareItemKey(e),props:e.props}}prepareItemKey(e){return`${this.getId()}_${e.id}`}renderItem(e){const t=this.findItem(e);if(t){return n.make(t.type,{model:t,timelineScopeEventBus:this.timelineScopeEventBus,ref:t=>this.itemRefs[e]=t,onAction:this.onItemAction.bind(this)})}return null}onChange(){return new Promise((e=>{if(this.onChangeHandler){this.onChangeHandler(this).then(e)}e()}))}onItemAction(e){if(this.onItemActionHandler){this.onItemActionHandler(e)}}}i.exports={TimelineStreamBase:h}}));
//# sourceMappingURL=base.map.js