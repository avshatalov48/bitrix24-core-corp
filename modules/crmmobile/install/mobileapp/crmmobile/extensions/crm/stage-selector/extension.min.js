jn.define("crm/stage-selector",((t,e,s)=>{const{Haptics:i}=t("haptics");const{NavigationLoader:a}=t("navigation-loader");const{isEqual:n}=t("utils/object");const{throttle:r}=t("utils/function");const{getStageIcon:o}=t("crm/assets/stage");const{CategoryStorage:g}=t("crm/storage/category");const{StageListView:c}=t("crm/stage-list-view");const l=device.screen.width*.48;const h=8;const d=16;class S extends LayoutComponent{constructor(t){super(t);const{activeStageId:e}=t;this.state={category:this.getCategoryByProps(t),activeStageId:e};this.uid=t.uid||Random.getString(10);this.handleStageClick=r(this.handleStageClick,500,this);this.prevActiveStageId=null}getCategoryByProps(t){const{entityTypeId:e,categoryId:s}=t;return g.getCategory(e,s)}componentDidMount(){g.subscribeOnChange((()=>this.reloadCategory())).subscribeOnLoading((({status:t})=>a.setLoading(t))).markReady()}reloadCategory(){const t=this.getCategoryByProps(this.props);if(!n(this.state.category,t)){this.setState({category:t})}}componentWillReceiveProps(t){const{activeStageId:e}=t;if(this.props.categoryId!==t.categoryId){this.prevActiveStageId=null}this.state.category=this.getCategoryByProps(t);this.state.activeStageId=e}isReadonly(){return BX.prop.getBoolean(this.props,"readOnly",false)}isReadonlyNotificationEnabled(){return BX.prop.getBoolean(this.props,"showReadonlyNotification",false)}getStagesFromCategory(){const{category:t}=this.state;if(!t){return[]}const{successStages:e,failedStages:s,processStages:i}=t;return[...i,...e,...s]}componentDidUpdate(t,e){}getStageIndexById(t,e){return Math.max(t.findIndex((({id:t})=>t===e)),0)}getCurrentSliderPosition(t,e){if(e===0){return this.props.hasHiddenEmptyView?d:h+d}else{return e*(-l-h)+d+2*h}}openStageList(t){const{entityTypeId:e,categoryId:s,data:i}=this.props;return c.open({entityTypeId:e,categoryId:s,activeStageId:t,data:i,readOnly:true,canMoveStages:false,enableStageSelect:true,onStageSelect:({id:t},e,s)=>this.changeActiveStageId(t,e,s),uid:this.uid})}handleStageClick(t,e,s,a){if(this.isReadonly()){return}if(t){void this.openStageList(e)}else{i.impactLight();this.changeActiveStageId(e,s,a)}}openStageChangeMenu(t,e,s){const{id:i,name:a,color:n}=t;const r=new ContextMenu({actions:[{id:"change-stage",title:a,data:{svgIcon:o(n)},onClickCallback:()=>this.handleStageClick(false,i,e,s)}],params:{title:BX.message("CRM_STAGE_SELECTOR_CHANGE_STAGE_TITLE"),showCancelButton:true,showActionLoader:false}});r.show()}notifyAboutReadOnlyStatus(){if(this.isReadonlyNotificationEnabled()){Notify.showUniqueMessage(BX.message("CRM_STAGE_SELECTOR_NOTIFY_READONLY_TEXT"),BX.message("CRM_STAGE_SELECTOR_NOTIFY_READONLY_TITLE"),{time:4})}}changeActiveStageId(t,e,s){if(this.isReadonly()||this.state.activeStageId===t){return}this.prevActiveStageId=this.state.activeStageId;const{onStageSelect:i}=this.props;if(typeof i==="function"){i(t,e,s).then((e=>{this.setState({activeStageId:e.columnId||t})}))}else{this.setState({activeStageId:t})}}render(){this.animate();return View({style:{width:"100%",flexDirection:"row",height:50}},this.renderStageSlider())}animate(){if(this.prevActiveStageId&&this.state.activeStageId!==this.prevActiveStageId){setTimeout((()=>{const t=this.getStageIndexById(this.currentStages,this.state.activeStageId);this.stageSliderRef.animate({delay:100,duration:500,left:this.getCurrentSliderPosition(this.currentStages,t)})}),100)}}renderStageSlider(){this.currentStages=this.getSliderStages();const t=this.getStageIndexById(this.currentStages,this.state.activeStageId);let e;if(this.prevActiveStageId&&this.prevActiveStageId!==this.state.activeStageId){const t=this.getStageIndexById(this.currentStages,this.prevActiveStageId);e=this.getCurrentSliderPosition(this.currentStages,t)}else{e=this.getCurrentSliderPosition(this.currentStages,t)}const s=this.currentStages.map(((e,s)=>this.renderStage(e,s,t,this.state.activeStageId)));return View({style:{width:(l+h)*this.currentStages.length+d,flexDirection:"row",height:50,position:"absolute",top:0,left:this.state.activeStageId%2?e:e+.1},ref:t=>this.stageSliderRef=t},...s)}getSliderStages(){const t=this.getStagesFromCategory();const e=this.getStageIndexById(t,this.state.activeStageId);if(!this.prevActiveStageId){return this.getInitialSliderStages(t,e)}const s=this.getStageIndexById(t,this.prevActiveStageId);if(s===e){return this.getInitialSliderStages(t,e)}let i=Math.min(e,s);const a=Math.max(s,e);if(i!==0){i=i-1}if(t[e].semantics!=="P"){if(t[s].semantics==="P"){return[...this.state.category.processStages.slice(i),t[e]]}else{return[this.state.category.processStages[this.state.category.processStages.length-1],t[e]]}}else{if(t[s].semantics==="S"){return[...this.state.category.processStages.slice(i),t[s]]}else if(t[s].semantics==="F"){return[...this.state.category.processStages.slice(i),...this.state.category.successStages,t[s]]}}return t.slice(i,a+2)}getInitialSliderStages(t,e){let s=0;let i=0;if(e===0){return t.slice(e,2)}if(t[e-1]){s=e-1}if(t[e].semantics!=="P"){return[this.state.category.processStages[this.state.category.processStages.length-1],t[e]]}else if(t[e+1]){if(t[e+1].semantics==="P"){i=3}else{i=2}}return t.slice(s,e+i)}renderStage(t,e,s,i){const{color:a,name:n,id:r}=t;const{category:o,data:g,useStageChangeMenu:c}=this.props;const h=e>s?"#eef2f4":a;const d=this.isReadonly();return View({style:{height:50,width:l,marginRight:8,paddingTop:8,paddingBottom:8,flexDirection:"row"},onClick:()=>{if(d){this.notifyAboutReadOnlyStatus()}else if(c&&i!==r){this.openStageChangeMenu(t,o,g)}else{this.handleStageClick(i===r,r,o,g)}},onLongClick:()=>{if(d){this.notifyAboutReadOnlyStatus()}else if(c&&i!==r){this.handleStageClick(i===r,r,o,g)}}},View({style:{width:l-10,height:"100%",borderRadius:5,backgroundColor:e>s?"#eef2f4":h,flexDirection:"column",borderBottomWidth:3,borderBottomColor:a}},View({style:{flexDirection:"row",alignItems:"center",justifyContent:"space-between",height:"100%",paddingLeft:8}},Text({numberOfLines:1,ellipsize:"end",style:{height:"auto",color:e>s?"#a8adb4":this.calculateTextColor(h),fontWeight:"500",flexShrink:2},text:n}),!d&&i===r?Image({style:{width:8,height:5,margin:5},svg:{content:u.stageSelectArrow()}}):null)),Image({style:{width:15,height:34,marginLeft:-5},resizeMode:"contain",svg:{content:u.arrow(h,a)}}))}calculateTextColor(t){let e,s,i;if(t>7){let a=t.split("(")[1].split(")")[0];a=a.split(",");e=parseInt(a[0]);s=parseInt(a[1]);i=parseInt(a[2])}else if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){let a=t.substring(1).split("");if(a.length===3){a=[a[0],a[0],a[1],a[1],a[2],a[2]]}a="0x"+a.join("");e=a>>16&255;s=a>>8&255;i=a&255}const a=.21*e+.72*s+.07*i;return a<145?"#fff":"#333"}}const u={stageSelectArrow:()=>`<svg width="8" height="5" viewBox="0 0 8 5" fill="none" xmlns="http://www.w3.org/2000/svg"><path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M7.48524 0.949718L3.94971 4.48525L0.414173 0.949718H7.48524Z" fill="white"/></svg>`,arrow:(t,e)=>`<svg width="15" height="34" viewBox="0 0 15 34" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0H0.314926C2.30669 0 4.16862 0.9884 5.28463 2.63814L13.8629 15.3191C14.5498 16.3344 14.5498 17.6656 13.8629 18.6809L5.28463 31.3619C4.16863 33.0116 2.30669 34 0.314926 34H0V0Z" fill="${t}"/><path d="M0 31H5.5L5.2812 31.3282C4.1684 32.9974 2.29502 34 0.288897 34H0V31Z" fill="${e}"/></svg>`};s.exports={StageSelector:S}}));
//# sourceMappingURL=extension.map.js