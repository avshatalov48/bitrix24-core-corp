(()=>{const t="S";const{Alert:e}=jn.require("alert");const{NotifyManager:s}=jn.require("notify-manager");const{throttle:n}=jn.require("utils/function");const{stringify:o}=jn.require("utils/string");const{getStageNavigationIcon:a}=jn.require("crm/assets/stage");const{EntityName:r}=jn.require("crm/entity-name");const{TunnelList:i}=jn.require("crm/tunnel-list");const{StageStorage:l}=jn.require("crm/storage/stage");class g extends LayoutComponent{constructor(t){super(t);this.stage=BX.prop.get(this.props,"stage",{});this.stageName=BX.prop.getString(this.stage,"name","");this.state={stage:this.props.stage,color:this.props.stage.color};this.tunnels=this.props.stage.tunnels;this.isChanged=false;this.isTunnelsChanged=false;this.deleteStageHandler=n(this.deleteStage,500,this)}componentDidMount(){layout.enableNavigationBarBorder(false);this.updateNavigationTitleAndIcon();layout.setRightButtons([{name:BX.message("M_CRM_STAGE_DETAIL_SAVE"),type:"text",color:"#0065a3",callback:()=>this.saveAndClose()}]);BX.addCustomEvent("Crm.TunnelList::onUpdateTunnels",(t=>{this.tunnels=t;this.isChanged=true;this.isTunnelsChanged=true}))}saveAndClose(){if(this.isChanged){this.updateStage().then((()=>{layout.close()}))}else{layout.close()}}prepareTunnelStageColors(){this.tunnels=this.tunnels.map((t=>{t.srcStageColor=this.state.color||t.srcStageColor;return t}))}render(){this.prepareTunnelStageColors();return View({style:{flex:1}},ScrollView({resizableByKeyboard:true,safeArea:{bottom:true,top:true,left:true,right:true},style:d.container},this.renderContent()))}renderContent(){return View({style:{flexDirection:"column"}},this.renderStageName(),this.renderTunnelList(),this.renderColorPicker(),this.renderDeleteButton())}renderStageName(){return View({style:d.nameFieldContainer},new r({title:BX.message("M_CRM_STAGE_DETAIL_NAME"),name:this.stageName,placeholder:BX.message("M_CRM_STAGE_DETAIL_DEFAULT_STAGE_NAME"),required:true,showRequired:false,config:{deepMergeStyles:d.nameField,selectionOnFocus:this.stageName===BX.message("M_CRM_STAGE_DETAIL_DEFAULT_STAGE_DEFAULT_NAME")},onChange:t=>{this.isChanged=true;this.stageName=t;this.updateNavigationTitle()}}))}renderTunnelList(){const{entityTypeId:t}=this.props;return View({style:{marginBottom:18}},new i({tunnels:this.tunnels,categoryId:this.props.categoryId,documentFields:this.props.documentFields,entityTypeId:t,stageId:this.state.stage.id,stageStatusId:this.state.stage.statusId,stageColor:this.state.color}))}renderColorPicker(){return View({style:{marginBottom:18}},new UI.ColorPicker({currentColor:this.state.stage.color,onChangeColor:t=>this.onChangeColor(t)}))}onChangeColor(t){if(this.state.color!==t){this.isChanged=true;this.setState({color:t},(()=>{this.updateNavigationTitleAndIcon()}))}}getTitleForNavigation(){return o(this.stageName)!==""?BX.message("M_CRM_STAGE_DETAIL_FUNNEL").replace("#STAGE_NAME#",this.stageName):BX.message("M_CRM_STAGE_DETAIL_FUNNEL_EMPTY")}updateNavigationTitle(){const t=this.getTitleForNavigation();layout.setTitle({text:t},true)}updateNavigationTitleAndIcon(){layout.setTitle({text:this.getTitleForNavigation(),svg:{content:a(this.state.color)}})}renderDeleteButton(){const{stage:e}=this.state;if(e.semantics===t){return null}return new BaseButton({style:{...d.deleteButton},icon:u.deleteIcon,text:BX.message("M_CRM_STAGE_DETAIL_DELETE"),onClick:()=>this.openAlertOnDelete(e.id)})}openAlertOnDelete(t){e.confirm("",BX.message("M_CRM_STAGE_DETAIL_DELETE_TEXT"),[{type:"cancel"},{text:BX.message("M_CRM_STAGE_DETAIL_DELETE_OK"),type:"destructive",onPress:()=>{this.deleteStageHandler(t).then((()=>{layout.close()}))}}])}updateStage(){const{entityTypeId:t,categoryId:e}=this.props;const{stage:{statusId:n}}=this.state;return new Promise(((o,a)=>{s.showLoadingIndicator();l.updateStage(t,e,{statusId:n,name:this.stageName,color:this.state.color,tunnels:this.prepareTunnelsBeforeSave()}).then((()=>{s.hideLoadingIndicatorWithoutFallback();const t={...this.state.stage,name:this.stageName,color:this.state.color,tunnels:this.tunnels};BX.postComponentEvent("Crm.StageDetail::onUpdateStage",[t]);if(this.isTunnelsChanged){BX.postComponentEvent("Crm.StageDetail::onUpdateTunnels",[this.tunnels,e])}o()})).catch((t=>{s.hideLoadingIndicatorWithoutFallback();ErrorNotifier.showErrors(t.errors);a()}))}))}deleteStage(){const{entityTypeId:t,categoryId:e}=this.props;const{statusId:n}=this.state.stage;return new Promise(((o,a)=>{s.showLoadingIndicator();l.deleteStage(t,e,n).then((()=>{s.hideLoadingIndicatorWithoutFallback();BX.postComponentEvent("Crm.StageDetail::onDeleteStage",[this.state.stage]);o()})).catch((t=>{s.hideLoadingIndicatorWithoutFallback();void ErrorNotifier.showErrors(t.errors);a()}))}))}prepareTunnelsBeforeSave(){if(!Array.isArray(this.tunnels)){return[]}return this.tunnels.map((t=>{if(t.isNewTunnel){return{srcCategory:t.srcCategoryId,srcStage:t.srcStageStatusId,dstCategory:t.dstCategoryId,dstStage:t.dstStageStatusId}}return{srcCategory:t.srcCategoryId,srcStage:t.srcStageStatusId,dstCategory:t.dstCategoryId,dstStage:t.dstStageStatusId,robot:{Name:t.robot.name}}}))}}const d={container:{backgroundColor:"#eef3f5",flexDirection:"column",flex:1},nameFieldContainer:{marginBottom:18},nameField:{wrapper:{paddingTop:0,paddingBottom:0},title:{marginBottom:0}},deleteButton:{button:{padding:20,borderRadius:12,backgroundColor:"#fff",borderColor:"#fff",flexDirection:"row",alignItems:"center",height:"auto",justifyContent:"flex-start",marginBottom:8},icon:{width:15,height:20,marginRight:16},text:{color:"#333",fontSize:18,fontWeight:"normal"}}};const u={deleteIcon:`<svg width="16" height="21" viewBox="0 0 16 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.22602 0H6.15062V1.54677H1.43631C0.64306 1.54677 0 2.18983 0 2.98309V4.64037H15.377V2.98309C15.377 2.18983 14.7339 1.54677 13.9407 1.54677H9.22602V0Z" fill="#828B95"/><path d="M1.53777 6.18721H13.8394L12.6864 19.2351C12.6427 19.7294 12.2287 20.1084 11.7326 20.1084H3.64459C3.14842 20.1084 2.73444 19.7294 2.69077 19.2351L1.53777 6.18721Z" fill="#828B95"/></svg>`};BX.onViewLoaded((()=>{layout.showComponent(new g({entityTypeId:BX.componentParameters.get("entityTypeId"),stage:BX.componentParameters.get("stage"),categoryId:BX.componentParameters.get("categoryId"),documentFields:BX.componentParameters.get("documentFields")}))}))})();
//# sourceMappingURL=component.map.js