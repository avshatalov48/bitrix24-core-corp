(()=>{const{KanbanTab:t}=jn.require("crm/entity-tab/kanban");const{ListTab:e}=jn.require("crm/entity-tab/list");const{clone:a,get:s,isEqual:i,merge:n,mergeImmutable:r}=jn.require("utils/object");const{throttle:o}=jn.require("utils/function");const{Search:c}=jn.require("crm/entity-tab/search");const l="99+";class h extends LayoutComponent{constructor(t){super(t);this.kanbanTabRef=null;this.listTabRef=null;this.searchRef=null;this.tabsCacheName="crm:crm.tabs.list."+env.userId;this.tabViewRef=null;this.pullUnsubscribe=null;const e=this.getTabsFromCache();const a=e.tabs||[];this.prepareTabs(t,a);const s=a.find((t=>t.active));const i=e.permissions||{};this.onPanBySearch=this.onPanBySearchHandler.bind(this);this.state={tabs:a,activeTabTypeName:s&&s.typeName,activeTabId:s&&s.id,permissions:i};this.currentMoneyFormats=Money.formats;this.rightButtonsIsSetted=false;this.loadTabs();this.onTabsReSelected=this.onTabsReSelected.bind(this);this.onMoneyLoad=this.onMoneyLoad.bind(this);this.scrollOnTop=o(this.scrollOnTop,500,this)}componentDidMount(){this.pullUnsubscribe=BX.PULL.subscribe({moduleId:"main",callback:t=>{if(t.command==="user_counter"){this.updateTabCounters(t.params)}}});BX.addCustomEvent("onTabsReSelected",this.onTabsReSelected);BX.addCustomEvent("Money::onLoad",this.onMoneyLoad)}componentWillUnmount(){if(this.pullUnsubscribe){this.pullUnsubscribe()}BX.removeCustomEvent("onTabsReSelected",this.onTabsReSelected);BX.removeCustomEvent("Money::onLoad",this.onMoneyLoad)}onTabsReSelected(t){if(t==="crm"){this.scrollOnTop()}}onMoneyLoad(){if(!i(this.currentMoneyFormats,Money.formats)){this.currentMoneyFormats=Money.formats;this.setState({})}}updateTabCounters(t){const e=t[env.siteId]||null;if(!e){return}this.state.tabs.forEach((t=>{const a="crm_"+t.typeName.toLowerCase()+"_all";if(t.label===l){return}if(e.hasOwnProperty(a)&&e[a]>=0&&e[a]!==Number(t.label)){const s=this.getTab(t.typeName);s.label=this.getPreparedLabel(e[a]);const i=this.getPreparedTabItem(s);this.updateTabItem(i);this.modifyCache({label:s.label},t.id)}}))}updateTabItem(t){this.tabViewRef.updateItem(t.id,t)}getTabsFromCache(){const t=Application.storage.getObject(this.tabsCacheName,{});return s(t,"data",[])}modifyCache(t,e=null){const a=this.tabsCacheName;const s=Application.storage.getObject(a,null);if(!(s&&s.data&&s.data.tabs)){return null}if(e===null){e=this.state.activeTabId}const i=s.data.tabs.find((t=>t.id===e));if(i===null){return}n(i,t);Application.storage.setObject(a,s)}render(){const t=this.getActiveTab();if(!t&&this.state.tabs[0]){qrauth.open({title:this.state.tabs[0].title,redirectUrl:this.getDesktopPageLink(this.state.tabs[0].typeName)});return}return View({resizableByKeyboard:true},TabView({style:{height:44,backgroundColor:"#f5f7f8"},ref:t=>this.tabViewRef=t,params:{styles:{tabTitle:{underlineColor:"#2985E2"}},items:this.getTabItems()},onTabSelected:(t,e)=>this.handleTabSelected(t,e)}),this.state.activeTabTypeName&&this.renderTab(),this.state.activeTabTypeName&&new c({entityTypeName:t.typeName,categoryId:t.data.currentCategoryId,getSearchDataAction:result.actions.getSearchData,link:t.link,restrictions:BX.prop.getObject(t.restrictions,"search",{}),layout:layout,ref:t=>{if(t){this.searchRef=t}}}))}getActiveTab(){return this.getTabById(this.state.activeTabId)}getTabById(t){return this.state.tabs.find((e=>e.id===t))}onPanBySearchHandler(){if(this.searchRef&&this.searchRef.isVisible()){this.searchRef.fadeOut().then((()=>{layout.search.close();this.searchRef.onHide()}))}}handleTabSelected(t,e){if(e){this.rightButtonsIsSetted=false;const e=this.getTab(t.id).id;let a;if(this.state.activeTabTypeName!==t.id){a=new Promise((a=>{this.setState({activeTabTypeName:t.id,activeTabId:e},a)}))}else{a=Promise.resolve()}a.then((()=>{this.searchRef.setState(this.searchRef.getInitialState());const t={clearFilter:true};this.kanbanTabRef&&this.kanbanTabRef.reload(t);this.listTabRef&&this.listTabRef.reload(t)}))}else if(t.selectable===false){const e=this.getTab(t.id);if(e.pageUrl){PageManager.openPage({url:e.pageUrl})}else{qrauth.open({title:t.title,redirectUrl:this.getDesktopPageLink(t.typeName)})}}else{this.scrollOnTop()}}scrollOnTop(){if(this.kanbanTabRef){this.kanbanTabRef.scrollToTop()}else if(this.listTabRef){this.listTabRef.scrollToTop()}}loadTabs(){new RunActionExecutor(result.actions.loadTabs).setCacheId(this.tabsCacheName).setCacheHandler((t=>this.setTabs(t))).setHandler((t=>this.setTabs(t))).call(true)}setTabs(t){if(t.data.tabs&&!i(t.data.tabs,this.state.tabs)){const{data:e}=t;this.prepareTabs(this.props,e.tabs);const a=e.tabs.find((t=>t.active));this.setState({tabs:e.tabs,activeTabTypeName:a.typeName,activeTabId:a.id,permissions:e.permissions})}else if(t.data.permissions&&!i(t.data.permissions,this.state.permissions)){this.setState({permissions:t.data.permissions})}}prepareTabs(t,e){if(t.activeTabName){e.forEach((e=>e.active=e.typeName===t.activeTabName))}}getDesktopPageLink(t){const e=this.getTab(t);if(e){return e.link}return null}renderTab(){return this.isUseColumns()?this.createKanban():this.createList()}isUseColumns(){const{activeTabTypeName:t}=this.state;const e=this.getTab(t);return e.isStagesEnabled}getTab(t){return this.state.tabs.find((e=>e.typeName===t))}createKanban(){this.listTabRef=null;return new t(this.getEntityTabConfig((t=>this.kanbanTabRef=t)))}createList(){this.kanbanTabRef=null;return new e(this.getEntityTabConfig((t=>this.listTabRef=t)))}getTabItems(){return this.state.tabs.map((t=>this.getPreparedTabItem(t)))}getPreparedTabItem(t){return{id:t.typeName,title:t.titleInPlural,active:t.hasOwnProperty("active")?t.active:undefined,selectable:t.hasOwnProperty("selectable")?t.selectable:undefined,label:this.getPreparedLabel(t.label,t.id)}}getPreparedLabel(t,e){if(!t){return""}let a=Number(t);if(isNaN(a)){return String(t)}a=a>99?l:String(a);this.modifyCache({label:a},e);return a}getEntityTypes(){return this.state.tabs.map((t=>({...t,name:t.title})))}getEntityTabConfig(t){const e=this.rightButtonsIsSetted;this.rightButtonsIsSetted=true;return{entityTypeName:this.state.activeTabTypeName,entityTypeId:this.state.activeTabId,entityTypes:this.getEntityTypes(),updateEntityTypeData:this.updateEntityTypeData.bind(this),actions:result.actions||{},actionParams:{loadItems:{entityType:this.state.activeTabTypeName}},permissions:this.getPermissions(),itemParams:this.getItemParams(),cacheName:"crm:crm.kanban."+env.userId+"."+this.state.activeTabTypeName,layout:layout,needInitMenu:!e,onPanList:this.onPanBySearch,ref:t}}getPermissions(){return r(this.state.permissions,this.getTab(this.state.activeTabTypeName).permissions)}getItemParams(){return{entityTypeName:this.state.activeTabTypeName,entityTypeId:this.state.activeTabId}}updateEntityTypeData(t,e,s=null){const n=a(this.state.tabs);const r=n.find((e=>e.id===t));let o=false;const c={};if(e.permissions&&!i(r.permissions,e.permissions)){const{permissions:t}=e;r.permissions=t;o=true;c.permissions=t}if(e.link&&r.link!==e.link){const{link:t}=e;r.link=t;o=true;c.link=t}if(!isNaN(Number(e.categoryId))&&r.data.currentCategoryId!==e.categoryId){const{categoryId:t}=e;r.data.currentCategoryId=t;c.data=c.data||{};c.data.currentCategoryId=t}if(e.counters&&r.data.counters!==e.counters){const{counters:t}=e;r.data.counters=t;c.data=c.data||{};c.data.counters=t}if(e.sortType&&r.data.sortType!==e.sortType){const{sortType:t}=e;r.data.sortType=t;c.data=c.data||{};c.data.sortType=t;this.rightButtonsIsSetted=false;o=true}if(!i(r.restrictions,e.restrictions)){const{restrictions:t}=e;r.restrictions=t;o=true;c.restrictions=t}if(Object.keys(c).length){this.modifyCache(c,r.id)}if(o){this.setState({tabs:n},(()=>{if(s){s()}}))}}}BX.onViewLoaded((()=>{layout.enableNavigationBarBorder(false);layout.showComponent(new h({activeTabName:BX.componentParameters.get("activeTabName",null)}))}))})();
//# sourceMappingURL=component.map.js