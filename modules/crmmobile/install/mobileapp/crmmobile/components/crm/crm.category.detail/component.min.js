(()=>{const{isEqual:t,isEmpty:e}=jn.require("utils/object");const{NavigationLoader:s}=jn.require("navigation-loader");const{NotifyManager:o}=jn.require("notify-manager");const{CategoryStorage:n}=jn.require("crm/storage/category");const{CategorySvg:r}=jn.require("crm/assets/category");const{CategoryPermissions:a}=jn.require("crm/category-permissions");const{StageStorage:i}=jn.require("crm/storage/stage");const{StageList:g}=jn.require("crm/stage-list");const{Alert:c}=jn.require("alert");const{Haptics:l}=jn.require("haptics");const{throttle:d}=jn.require("utils/function");const{stringify:h}=jn.require("utils/string");const{EntityName:u}=jn.require("crm/entity-name");const y="#ace9fb";const C="#ff5752";const p={PROCESS:"P",SUCCESS:"S",FAILED:"F"};class m extends LayoutComponent{constructor(t){super(t);this.state={category:this.getCategoryByProps(t)};this.changedFields={};this.layoutClose=this.onLayoutClose.bind(this);this.onOpenStageDetail=d(this.openStageDetail,500,this);this.deleteCategoryHandler=d(this.deleteCategory,500,this);this.createStageAndOpenStageDetail=d((t=>{this.createStage(t).then((t=>{this.openStageDetail(t)}))}),500,this)}getCategoryByProps(t){const{entityTypeId:e,categoryId:s}=t;return n.getCategory(e,s)}componentDidMount(){layout.enableNavigationBarBorder(false);layout.setRightButtons([{name:BX.message("M_CRM_CATEGORY_DETAIL_SAVE"),type:"text",color:"#0065a3",callback:()=>this.saveAndClose()}]);layout.setTitle({text:this.getTitleForNavigation(),svg:{content:r.funnelForTitle()}});this.bindEvents();n.subscribeOnChange((()=>this.reloadCategory())).subscribeOnLoading((({status:t})=>s.setLoading(t))).markReady()}bindEvents(){BX.addCustomEvent("Crm.StageDetail::onUpdateStage",this.onUpdateStage.bind(this));BX.addCustomEvent("Crm.StageDetail::onDeleteStage",this.onDeleteStage.bind(this))}reloadCategory(){const t=this.getCategoryByProps(this.props);return this.changeCategory(t)}changeCategory(e){return new Promise((s=>{if(!t(this.state.category,e)){this.setState({category:e},(()=>s()))}else{s()}}))}getCategoryFields(){return{...this.state.category||{},...this.changedFields}}saveAndClose(){const e=this.getCategoryFields();if(t(this.state.category,e)){this.layoutClose()}else{this.save().then(this.layoutClose)}}save(){return new Promise(((t,e)=>{const{entityTypeId:s}=this.props;const r=this.getCategoryFields();o.showLoadingIndicator();n.updateCategory(s,r.id,this.getCategoryFields()).then((()=>{o.hideLoadingIndicator(true);t()})).catch((t=>{o.showErrors(t.errors);e()}))}))}onLayoutClose(){const{category:t}=this.state;BX.postComponentEvent("Crm.CategoryDetail::onClose",[t]);layout.close()}getTitleForNavigation(){const t=this.getCategoryFields();if(e(t)){return BX.message("M_CRM_CATEGORY_DETAIL_FUNNEL_NOT_LOADED2")}return h(t.name)!==""?BX.message("M_CRM_CATEGORY_DETAIL_FUNNEL2").replace("#CATEGORY_NAME#",t.name):BX.message("M_CRM_CATEGORY_DETAIL_FUNNEL_EMPTY2")}updateLayoutTitle(){const t=this.getTitleForNavigation();layout.setTitle({text:t},true)}render(){return View({resizableByKeyboard:true,style:{flexDirection:"column",backgroundColor:"#eef3f5"}},this.state.category===null?this.renderLoader():this.renderContent())}renderLoader(){return new LoadingScreenComponent}renderContent(){this.updateLayoutTitle();return ScrollView({resizableByKeyboard:true,safeArea:{bottom:true,top:true,left:true,right:true},style:{flex:1}},View({},this.renderCategoryName(),this.renderPermissions(),this.renderStageList(),this.renderStageButtons(),this.renderDeleteButton()))}renderCategoryName(){const{name:t}=this.getCategoryFields();return View({style:T.categoryNameContainer},new u({title:BX.message("M_CRM_CATEGORY_DETAIL_NAME_FIELD_TITLE2"),name:t,placeholder:BX.message("M_CRM_CATEGORY_DETAIL_DEFAULT_CATEGORY_NAME2"),required:true,showRequired:false,config:{deepMergeStyles:T.categoryNameField,selectionOnFocus:t===BX.message("M_CRM_CATEGORY_DETAIL_DEFAULT_CATEGORY_NAME2")},onChange:t=>{this.changedFields.name=t;this.updateLayoutTitle()}}))}renderPermissions(){const{access:t}=this.getCategoryFields();return new a({access:t,entityTypeId:this.props.entityTypeId,categoryId:this.props.categoryId,onChange:t=>{this.changedFields.access=t}})}renderStageList(){const t=this.getCategoryFields();const{processStages:e,successStages:s,failedStages:o}=t;return new g({category:t,processStages:e,finalStages:[...s,...o],onOpenStageDetail:this.onOpenStageDetail,readOnly:false,canMoveStages:true,onStageMove:t=>{this.changedFields.processStages=t;this.setState({})},stageParams:{showTunnels:true}})}renderDeleteButton(){const{category:t}=this.state;return new BaseButton({style:{button:T.deleteButtonContainer(t.isDefault),icon:T.deleteButtonIcon,text:T.buttonText},icon:_.deleteIcon,text:BX.message("M_CRM_CATEGORY_DETAIL_DELETE2"),onClick:()=>this.openAlertOnDeleteCategory()})}renderStageButtons(){return View({style:{borderRadius:12,marginBottom:8}},this.renderCreateStageButton({buttonText:BX.message("M_CRM_CATEGORY_DETAIL_CREATE_PROCESS_STAGE"),onClick:()=>{this.createStageAndOpenStageDetail(p.PROCESS)}}),this.renderCreateStageButton({buttonText:BX.message("M_CRM_CATEGORY_DETAIL_CREATE_FAILED_STAGE"),onClick:()=>{this.createStageAndOpenStageDetail(p.FAILED)}}))}renderCreateStageButton({buttonText:t,onClick:e}){return new BaseButton({style:{button:T.createButtonContainer,icon:T.createButtonIcon,text:T.buttonText},icon:_.createIcon,text:t,onClick:e})}createStage(t){const e=new S({semantics:t});e.sort=this.getDefaultNewSort(e.type);const{name:s,sort:n,semantics:r,color:a}=e;return new Promise(((t,e)=>{o.showLoadingIndicator();i.createStage(this.props.entityTypeId,this.state.category.id,{name:s,sort:n,semantics:r,color:a}).then((e=>{o.hideLoadingIndicator(true,BX.message("M_CRM_CATEGORY_DETAIL_SUCCESS_CREATION"),1e3);setTimeout((()=>t(e)),1300)})).catch((t=>{o.showErrors(t.errors);e()}))}))}deleteCategory(t){return new Promise(((e,s)=>{const{entityTypeId:r}=this.props;o.showLoadingIndicator();n.deleteCategory(r,this.state.category.id).then((()=>{BX.postComponentEvent("Crm.CategoryDetail::onDeleteCategory",[t]);o.hideLoadingIndicator(true);e()})).catch((t=>{o.showErrors(t.errors);s()}))}))}openStageDetail(t){ComponentHelper.openLayout({name:"crm:crm.stage.detail",componentParams:{entityTypeId:this.props.entityTypeId,stage:t,categoryId:this.state.category.id,documentFields:this.state.category.documentFields},widgetParams:{modal:true,backdrop:{showOnTop:true,forceDismissOnSwipeDown:true,horizontalSwipeAllowed:false,swipeContentAllowed:true}}})}getDefaultNewSort(t){const e=this.state.category[t].length-1;return this.state.category[t][e].sort+1}openAlertOnDeleteCategory(){const{category:t}=this.state;if(t.isDefault){const t=BX.message("M_CRM_CATEGORY_DETAIL_IS_DEFAULT_TITLE2");const e=BX.message("M_CRM_CATEGORY_DETAIL_IS_DEFAULT_TEXT");l.notifyWarning();Notify.showUniqueMessage(e,t,{time:5})}else{c.confirm("",BX.message("M_CRM_CATEGORY_DETAIL_DELETE_CATEGORY2"),[{type:"cancel"},{text:BX.message("M_CRM_CATEGORY_DETAIL_DELETE_CATEGORY_OK"),type:"destructive",onPress:()=>this.deleteCategoryHandler(t.id).then(this.layoutClose)}])}}onUpdateStage(t){const e=new S(t);const s=this.state.category[e.type].findIndex((t=>t.id===e.id));if(s!==-1){const t=[...this.state.category[e.type]];t[s]=e.toStorageJson();this.setState({category:{...this.state.category,[e.type]:[...t]}},(()=>this.getCategoryByProps(this.props)))}}onDeleteStage(t){const e=new S(t);const s=this.state.category[e.type].findIndex((t=>t.id===e.id));const o=[...this.state.category[e.type]];o.splice(s,1);this.setState({category:{...this.state.category,[e.type]:o}},(()=>this.getCategoryByProps(this.props)))}}const E={PROCESS_STAGES:"processStages",SUCCESS_STAGES:"successStages",FAILED_STAGES:"failedStages"};class S{constructor({id:t,name:e,sort:s,color:o,semantics:n,type:r,tunnels:a,statusId:i,total:g,currency:c,count:l}){this.id=t;this.name=e||BX.message("M_CRM_CATEGORY_DETAIL_DEFAULT_STAGE_NAME2");this.sort=s||0;this.semantics=n||p.PROCESS;this.color=this.getColorByProps(o)||this.getColorBySemantics(n);this.type=r!==undefined?r:S.getType(this.semantics);this.tunnels=a||[];this.statusId=i||null;this.total=g;this.currency=c||null;this.count=l}static getType(t){if(t===p.FAILED){return E.FAILED_STAGES}if(t===p.SUCCESS){return E.SUCCESS_STAGES}return E.PROCESS_STAGES}getColorByProps(t){return t&&t.length!==0?t:null}getColorBySemantics(t){return t===p.PROCESS?y:C}toStorageJson(){return{id:this.id,name:this.name,semantics:this.semantics,color:this.color,statusId:this.statusId,sort:this.sort,count:this.count,total:this.total,currency:this.currency,tunnels:this.tunnels}}}const T={categoryNameContainer:{marginBottom:8},categoryNameField:{wrapper:{paddingTop:0,paddingBottom:0},title:{marginBottom:0}},deleteButtonContainer:t=>({paddingTop:18,paddingBottom:18,paddingLeft:25,paddingRight:25,borderRadius:12,backgroundColor:"#fff",borderColor:"#fff",flexDirection:"row",alignItems:"center",height:"auto",justifyContent:"flex-start",marginBottom:8,opacity:t?.6:1}),deleteButtonIcon:{width:15,height:20,marginRight:16},buttonText:{color:"#333",fontSize:18,fontWeight:"normal"},createButtonContainer:{paddingTop:18,paddingBottom:18,paddingLeft:25,paddingRight:25,borderRadius:0,backgroundColor:"#fff",borderColor:"#fff",flexDirection:"row",alignItems:"center",height:"auto",justifyContent:"flex-start"},createButtonIcon:{width:12,height:12,marginRight:22}};const _={deleteIcon:`<svg width="16" height="21" viewBox="0 0 16 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.22602 0H6.15062V1.54677H1.43631C0.64306 1.54677 0 2.18983 0 2.98309V4.64037H15.377V2.98309C15.377 2.18983 14.7339 1.54677 13.9407 1.54677H9.22602V0Z" fill="#828B95"/><path d="M1.53777 6.18721H13.8394L12.6864 19.2351C12.6427 19.7294 12.2287 20.1084 11.7326 20.1084H3.64459C3.14842 20.1084 2.73444 19.7294 2.69077 19.2351L1.53777 6.18721Z" fill="#828B95"/></svg>`,createIcon:`<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 0H7V12H5V0Z" fill="#525C69"/><path d="M12 5V7L0 7L1.19209e-07 5L12 5Z" fill="#525C69"/></svg>`};BX.onViewLoaded((()=>{layout.showComponent(new m({entityTypeId:BX.componentParameters.get("entityTypeId"),categoryId:BX.componentParameters.get("categoryId"),sort:BX.componentParameters.get("sort"),categories:BX.componentParameters.get("categories")}))}))})();
//# sourceMappingURL=component.map.js