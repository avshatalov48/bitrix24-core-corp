(function(){"use strict";BX.namespace("BX.Timeman.Component.Schedule.Edit");BX.Timeman.Component.Schedule.Edit=function(e){BX.Timeman.Component.BaseComponent.apply(this,arguments);this.calendarExclusionsFormName=e.calendarExclusionsFormName;this.scheduleIdFormName=e.scheduleIdFormName;this.scheduleId=e.scheduleId;this.isSlider=e.isSlider;this.options=e;var t=e.assignmentsMap;this.assignmentsMap={};var i=Object.keys(t);for(var s=0;s<i.length;s++){this.fillSchedulesAssignmentsMap(t,i[s])}this.assignmentsLoading={};this.scheduleFormName=e.scheduleFormName;this.scheduleNamePostfix=e.scheduleNamePostfix;this.addShiftBtn=this.selectOneByRole("timeman-schedule-form-shift-add");this.typeSelector=this.selectOneByRole("timeman-schedule-type-select");this.reportPeriodSelector=this.selectOneByRole("timeman-report-period-select");this.reportPeriodStartWeekDayBlock=this.selectOneByRole("timeman-report-period-start-week-day-block");this.cancelButton=this.selectOneByRole("timeman-schedule-btn-cancel");this.saveButton=this.selectOneByRole("timeman-schedule-btn-save");this.assignmentsWrapper=this.selectOneByRole("assignments-wrapper");this.scheduleForm=this.selectOneByRole("timeman-schedule-form");this.assignmentsErrorBlock=this.selectOneByRole("timeman-schedule-assignments-error-block");this.excludedUsersToggle=this.selectOneByRole("timeman-excluded-users-show-btn");this.excludedContainer=this.selectOneByRole("excluded-container");this.controlledActionsSelector=this.selectOneByRole("controlled-actions");this.errorBlock=this.selectOneByRole("timeman-schedule-edit-error-block");this.errorMsgTemplate=this.selectOneByRole("timeman-schedule-error-msg-block");this.shifts=[];this.scheduleNameInput=this.selectOneByRole("schedule-name");this.calendarExclusions=new BX.Timeman.Component.Schedule.Edit.Calendar.Exclusions(e);this.violations=new BX.Timeman.Component.Schedule.Edit.Violations(e);this.setScheduleNameFromTypeOption(0);this.addEventHandlers(e);var n=document.querySelectorAll('[data-role^="timeman-schedule-shift-form-container"]');for(var s=0;s<n.length;s++){this.createShift('[data-role="'+n[s].dataset.role+'"]',{visible:s!==0})}this.redrawFormByScheduleType(this.typeSelector.value,this.controlledActionsSelector.value)};BX.Timeman.Component.Schedule.Edit.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Schedule.Edit,addEventHandlers:function(){BX.bind(this.scheduleNameInput,"focus",BX.delegate(this.onScheduleInputFocus,this));BX.bind(this.excludedUsersToggle,"click",BX.delegate(this.onExcludedUsersToggleClick,this));BX.bind(this.addShiftBtn,"click",BX.delegate(this.onAddShiftBtnClick,this));BX.bind(this.typeSelector,"change",BX.delegate(this.onTypeSelectorChange,this));BX.bind(this.reportPeriodSelector,"change",BX.delegate(this.onReportPeriodChange,this));BX.bind(this.controlledActionsSelector,"change",BX.delegate(this.onControlledActionsChange,this));BX.bind(this.saveButton,"click",BX.delegate(this.onSaveClick,this));BX.bind(this.cancelButton,"click",BX.delegate(this.onCancelClick,this));BX.bind(this.cancelButton,"click",BX.delegate(this.onCancelClick,this));BX.addCustomEvent("BX.Main.User.SelectorController:select",BX.delegate(this.onAssignmentSelected,this));BX.addCustomEvent("BX.Main.User.SelectorController:unSelect",BX.delegate(this.onAssignmentUnselected,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(e){if(e.getEventId()==="BX.Timeman.Schedule.Update::Success"){this.assignmentsMap={};this.updateAssignmentsWarnings()}}.bind(this)));var e=document.querySelectorAll('[data-role^="startTimeAllowedDevice"]');for(var t=0;t<e.length;t++){BX.bind(e[t],"click",BX.delegate(this.onAllowDeviceClick,this))}},updateAssignmentsWarnings:function(){this.clearErrors(this.assignmentsErrorBlock);var e=this.assignmentsWrapper.querySelectorAll('[data-role="tile-item"][data-bx-id]');for(var t=0;t<e.length;t++){if(!e[t].dataset.bxId){continue}this.drawUserAssignmentsWarning(e[t].dataset.bxId)}},drawUserAssignmentsWarning:function(e){if(this.assignmentsMap[e]===undefined){if(!this.assignmentsLoading[e]){this.assignmentsLoading[e]=true;this.disableSaveBtn();BX.ajax.runAction("timeman.schedule.getSchedulesForEntity",{data:{entityCode:e,checkNestedEntities:true,currentScheduleId:this.scheduleId}}).then(function(e,t){this.assignmentsLoading[e]=false;this.enableSaveBtn();this.assignmentsMap[e]=[];this.fillSchedulesAssignmentsMap(t.data,e);this.drawUserAssignmentsWarning(e)}.bind(this,e),function(e,t){this.assignmentsLoading[e]=false;this.showErrors(t.errors);this.enableSaveBtn()}.bind(this,e))}return}var t=this.assignmentsMap[e];if(t&&t.length>0){for(var i=0;i<t.length;i++){var s=t[i];var n=s.id+s.entityCode;if(this.assignmentsErrorBlock.querySelector('[data-role="timeman-schedule-error-msg-block"][data-unique-id="'+n+'"]')){continue}var l=this.errorMsgTemplate.cloneNode(true);l.dataset.uniqueId=n;var a='&nbsp;<a class="timeman-schedule-form-error-link" data-role="schedule-link" data-id="'+parseInt(s.id)+'" target="_blank"'+'" href="'+s.link+'">'+BX.util.htmlspecialchars(s.name)+"</a>";if(s.entityCode.substr(0,2)==="DR"){l.dataset.department=true;l.dataset.name=s.entityName;l.dataset.scheduleName=s.name;this.selectOneByRole("timeman-schedule-error-msg",l).innerHTML=BX.message("TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_DEPARTMENT_WARNING").replace("#SCHEDULE_NAME#",a).replace("#ASSIGNMENT_NAME#",BX.util.htmlspecialchars(s.entityName))+". "+BX.message("TIMEMAN_SCHEDULE_EDIT_DEPARTMENT_WILL_BE_EXCLUDED")}else if(s["forAllUsers"]&&s.entityCode==="UA"){this.selectOneByRole("timeman-schedule-error-msg",l).innerHTML=BX.message("TIMEMAN_SCHEDULE_FOR_ALL_USERS_WARNING").replace("#SCHEDULE_NAME#",a+"&nbsp;")}else{var o="TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_MALE_WARNING";if(s.entityGender==="F"){o="TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_FEMALE_WARNING"}this.selectOneByRole("timeman-schedule-error-msg",l).innerHTML=BX.message(o).replace("#SCHEDULE_NAME#",a).replace("#ASSIGNMENT_NAME#",BX.util.htmlspecialchars(s.entityName));l.classList.remove("ui-alert-danger");l.classList.add("ui-alert-success")}this.assignmentsErrorBlock.appendChild(l);BX.bind(this.selectOneByRole("schedule-link",l),"click",BX.delegate(this.onScheduleLinkClick,this));this.showElement(l)}}},fillSchedulesAssignmentsMap:function(e,t){var i=Object.keys(e);for(var s=0;s<i.length;s++){for(var n=0;n<Object.keys(e[i[s]]).length;n++){var l=e[i[s]][Object.keys(e[i[s]])[n]];if(parseInt(this.scheduleId)!==parseInt(l.ID)){var a=l.entityName;if(!a){var o=this.container.querySelector('[data-role="tile-item"][data-bx-id="'+i[s]+'"]');if(o&&o.querySelector('[data-role="tile-item-name"]')){a=o.querySelector('[data-role="tile-item-name"]').textContent}}var r=l.entityCode?l.entityCode:i[s];var c={id:l.ID,name:l.NAME,link:l.LINKS.DETAIL,forAllUsers:l.IS_FOR_ALL_USERS,entityName:a,entityCode:r,entityGender:l.entityGender};if(this.assignmentsMap[t]===undefined){this.assignmentsMap[t]=[]}this.assignmentsMap[t].push(c)}}}},onScheduleLinkClick:function(e){e.stopPropagation();e.preventDefault();var t=BX.util.add_url_param("/bitrix/components/bitrix/timeman.schedule.edit/slider.php",{SCHEDULE_ID:e.currentTarget.dataset.id});window.top.BX.SidePanel.Instance.open(t,{width:1200,cacheable:false})},onAssignmentUnselected:function(e){this.updateAssignmentsWarnings()},onAssignmentSelected:function(e){this.updateAssignmentsWarnings()},onExcludedUsersToggleClick:function(){this.toggleElementVisibility(this.excludedContainer)},onAllowDeviceClick:function(e){var t=document.querySelectorAll('[data-role^="startTimeAllowedDevice"]:checked');if(t.length===0){e.stopPropagation();e.preventDefault()}},onControlledActionsChange:function(){this.controlledActionsSelector.dataset.autoaction=false;this.violations.redrawFormByScheduleType(this.typeSelector.value,this.controlledActionsSelector.value)},onScheduleInputFocus:function(){this.scheduleNameInput.dataset.autoname=false},setScheduleNameFromTypeOption:function(e){if(this.scheduleNameInput.dataset.autoname==="false"){return}if(this.isFixedSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_FIXED"))}else if(this.isShiftedSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_SHIFT"))}else if(this.isFlextimeSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_FLEXTIME"))}},onReportPeriodChange:function(e){var t=e.currentTarget.querySelectorAll("option")[e.currentTarget.selectedIndex];if(t.value==="WEEK"||t.value==="TWO_WEEKS"){this.showElement(this.reportPeriodStartWeekDayBlock)}else{this.hideElement(this.reportPeriodStartWeekDayBlock)}},onTypeSelectorChange:function(e){this.setScheduleNameFromTypeOption(e.currentTarget.selectedIndex);var t=e.currentTarget.querySelectorAll("option")[e.currentTarget.selectedIndex];this.redrawFormByScheduleType(t.value)},redrawFormByScheduleType:function(e){this.showElement(this.selectOneByRole("timeman-schedule-calendars-container"));this.showElement(this.selectOneByRole("work-time-block"));this.violations.redrawFormByScheduleType(e,this.controlledActionsSelector.value);if(this.isShiftedSchedule(e)){this.addShiftBtn.textContent=BX.message("TIMEMAN_SCHEDULE_EDIT_ADD_WORK_SHIFT_TITLE");this.hideElement(this.selectOneByRole("timeman-schedule-calendars-container"));if(this.controlledActionsSelector.dataset.autoaction==="true"){this.controlledActionsSelector.value=this.options.controlledStart}}else if(this.isFlextimeSchedule(e)){this.hideElement(this.selectOneByRole("timeman-schedule-calendars-container"));this.hideElement(this.selectOneByRole("work-time-block"))}else{this.addShiftBtn.textContent=BX.message("TIMEMAN_SCHEDULE_EDIT_ADD_WORK_TIME_TITLE");if(this.isFixedSchedule(e)&&this.controlledActionsSelector.dataset.autoaction==="true"){this.controlledActionsSelector.value=this.options.controlledStartEnd}}for(var t=0;t<this.shifts.length;t++){this.shifts[t].onScheduleTypeSelected(e)}},createShift:function(e,t){var i=new BX.Timeman.Component.Schedule.ShiftEdit.Multiple(Object.assign({},this.options,{containerSelector:e,uniqueIndex:t&&t.uniqueIndex!==undefined?t.uniqueIndex:undefined,visible:t&&t.visible!==undefined?t.visible:undefined,prevShiftEnd:t&&t.prevShiftEnd!==undefined?t.prevShiftEnd:undefined,prevShiftStart:t&&t.prevShiftStart!==undefined?t.prevShiftStart:undefined,isSlider:this.isSlider}));i.attachOnDeleteEvent(this);this.addDaysEventHandlers(i.container);this.shifts.push(i)},addDaysEventHandlers:function(e){var t=this.selectAllByRole("timeman-schedule-shift-work-day-item",e);for(var i=0;i<t.length;i++){BX.bind(t[i],"click",BX.delegate(this.onWorkDayClick,this))}},onWorkDayClick:function(e){var t=this.selectAllByRole("timeman-schedule-shift-work-day-item",this.container);for(var i=0;i<t.length;i++){if(t[i].checked===true){if(t[i]!==e.currentTarget&&t[i].value===e.currentTarget.value){e.preventDefault();e.stopPropagation()}}}},updateOnShiftEvent:function(e){for(var t=0;t<this.shifts.length;t++){if(this.shifts[t]===e.shift){this.shifts.splice(t,1)}}},isFixedSchedule:function(e){return e===this.options.fixedScheduleTypeName},isFlextimeSchedule:function(e){return e===this.options.flextimeScheduleTypeName},isShiftedSchedule:function(e){return e===this.options.shiftedScheduleTypeName},onAddShiftBtnClick:function(){var e=document.querySelector('[data-role^="timeman-schedule-shift-form-container"]');var t=e.cloneNode(true);var i=document.querySelectorAll('[data-role^="timeman-schedule-shift-form-container"]');var s=i.length;var n=null;var l=null;if(this.isShiftedSchedule(this.typeSelector.value)){n=i[i.length-1].querySelector('[data-role="timeman-shift-link-end-time"]').value;l=i[i.length-1].querySelector('[data-role="timeman-shift-link-start-time"]').value}t.dataset.role="timeman-schedule-shift-form-container-"+s;this.selectOneByRole("timeman-shifts-wrapper").appendChild(t);this.createShift('[data-role="'+t.dataset.role+'"]',{uniqueIndex:s,visible:true,prevShiftEnd:n,prevShiftStart:l})},disableSaveBtn:function(){this.saveButtonDisabled=true;if(this.saveButton){this.saveButton.classList.add("timeman-schedule-disabled")}},enableSaveBtn:function(){this.saveButtonDisabled=false;if(this.saveButton){this.saveButton.classList.remove("timeman-schedule-disabled")}},onCancelClick:function(e){e.preventDefault();this.closeSlider()},onSaveClick:function(e){e.stopPropagation();e.preventDefault();if(this.saveButtonDisabled){return}this.disableSaveBtn();this.clearErrors(this.errorBlock);for(var t=0;t<this.shifts.length;t++){this.shifts[t].processBeforeCollectFormData()}var i=new FormData(this.scheduleForm);i.append(this.calendarExclusionsFormName,JSON.stringify(this.calendarExclusions.exclusionsData));var s=i.get(this.scheduleIdFormName)?"timeman.schedule.update":"timeman.schedule.add";this.lastActionName=s;this.processSave(s,i)},processSave:function(e,t){BX.ajax.runAction(e,{data:t,analyticsLabel:{type:t.get("ScheduleForm[type]")}}).then(function(e){this.onSuccess(e,this.lastActionName);this.enableSaveBtn()}.bind(this),function(e){this.showErrors(e.errors);this.enableSaveBtn()}.bind(this))},onSuccess:function(e,t){if(this.isSlider&&this.getSlider()){this.getSlider().postMessageAll(window,t==="timeman.schedule.add"?"BX.Timeman.Schedule.Add::Success":"BX.Timeman.Schedule.Update::Success",{schedule:e.data.schedule})}if(this.isSlider){this.closeSlider()}else{document.location.reload()}},getSlider:function(){if(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){return window.top.BX.SidePanel.Instance}return null},closeSlider:function(){if(this.isSlider&&this.getSlider()){this.getSlider().getTopSlider().close()}},clearErrors:function(e){if(e.childNodes){for(var t=e.childNodes.length-1;t>=0;t--){e.childNodes[t].remove()}}},showErrors:function(e){for(var t=0;t<e.length;t++){var i=this.errorMsgTemplate.cloneNode(true);i.textContent=BX.util.htmlspecialchars(e[t].message);this.errorBlock.appendChild(i);this.showElement(i)}if(e.length>0){window.scrollTo(0,0)}}}})();
//# sourceMappingURL=script.map.js