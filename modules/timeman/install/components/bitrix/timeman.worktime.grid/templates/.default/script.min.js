(function(){BX.namespace("BX.Timeman.Component.Worktime");BX.Timeman.Component.Worktime.Grid=function(t){this.isSlider=t.isSlider;BX.ajax.UpdatePageData=function(){};this.flexibleScheduleTypeName=t.flexibleScheduleTypeName;this.gridId=t.gridId;this.filterId=t.filterId;t.container=this.container=document.querySelector(this.isSlider?"body":"#content-table");BX.Timeman.Component.BaseComponent.apply(this,arguments);this.todayWord=t.todayWord;this.usersIds=t.usersIds;this.canManageSettings=t.canManageSettings;this.departmentsIds=t.departmentsIds;this.departmentsData=t.departmentsData;this.scheduleCreateBtn=this.selectOneByRole("timeman-add-schedule-btn");this.todayLink=this.selectOneByRole("tm-navigation-today");this.canReadSchedules=t.canReadSchedules;this.highlightDepartmentRows();this.schedules={};this.scrollToToday();this.addEventHandlers()};BX.Timeman.Component.Worktime.Grid.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Worktime.Grid,addEventHandlersInsideGrid:function(){var t=this.selectAllByRole("navigation-period");for(var e=0;e<t.length;e++){BX.bind(t[e],"click",BX.delegate(this.onNavigationArrowClick,this))}var i=this.selectAllByRole("timeman-settings-toggle");for(var e=0;e<i.length;e++){BX.bind(i[e],"click",BX.delegate(this.onTimemanSettingsToggleClick,this))}BX.bind(this.selectOneByRole("dates-calendar-toggle"),"click",BX.delegate(this.onNavigationCalendarToggleClick,this))},addEventHandlers:function(){BX.bind(this.scheduleCreateBtn,"click",BX.delegate(this.onScheduleCreateBtnClick,this));BX.bind(this.todayLink,"click",BX.delegate(this.onTodayLinkClick,this));this.onGridUpdated();BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this));BX.addCustomEvent("Grid::updated",this.onGridUpdated.bind(this))},onNavigationCalendarToggleClick:function(t){BX.calendar({node:t.currentTarget,field:this.selectOneByRole("month-navigation"),bTime:false,bHideTime:true,callback:function(t){var e=new Date(t.getFullYear(),t.getMonth(),1);var i=new Date(t.getFullYear(),t.getMonth()+1,0);e=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),e);i=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),i);var n=this.selectOneByRole("navigation-period").href.replace(new RegExp("REPORT_PERIOD_from"+"=[^&]*(&*)","gi"),"REPORT_PERIOD_from="+e+"$1");n=n.replace(new RegExp("REPORT_PERIOD_to"+"=[^&]*(&*)","gi"),"REPORT_PERIOD_to="+i+"$1");this.applyFilterFromUrlData({href:n,dataset:{startTo:i,startFrom:e,startDatesel:"RANGE"}})}.bind(this)})},onApplyFilter:function(t,e,i,n,a){if(t!==this.filterId){return}this.initHints();this.highlightDepartmentRows();this.scrollToToday()},onNavigationArrowClick:function(t){t.preventDefault();t.stopPropagation();this.applyFilterFromUrlData(t.currentTarget)},onTimemanSettingsToggleClick:function(t){if(this.settingsLoading===true){return}if(!this.settingsData){this.settingsLoading=true;var e={DEPARTMENTS:this.departmentsIds,USERS:this.usersIds};BX.timeman_query("admin_data_settings",e,function(t,e){this.settingsData=e;this.settingsLoading=false;this.onTimemanSettingsToggleClick(t)}.bind(this,t));return}var i=this.buildEntityCode(t.target.dataset);if(this.schedules[i]===undefined){this.settingsLoading=true;BX.ajax.runAction("timeman.schedule.getSchedulesForEntity",{data:{entityCode:i}}).then(function(t,e){this.schedules[e.data.entityCode]=e.data.schedules;this.settingsLoading=false;if(this.loader){this.showSchedulesListMenu(t.target.dataset)}}.bind(this,t),function(t,e){this.settingsLoading=false}.bind(this,t))}if(this.timemanSettingsMenu){this.timemanSettingsMenu.close();this.timemanSettingsMenu.destroy()}var n=[];if(this.canManageSettings){n=[new BX.PopupWindowCustomButton({text:BX.message("JS_CORE_WINDOW_SAVE"),className:"ui-btn ui-btn-primary",events:{click:function(t){var e=this.getSettingsOption(t.type,t.id,"UF_TIMEMAN");var i=this.timemanSettingsMenu.getContentContainer().querySelector('[name="UF_TIMEMAN"]').value;var n=this.getSettingsOption(t.type,t.id,"UF_TM_REPORT_REQ");var a=this.timemanSettingsMenu.getContentContainer().querySelector('[name="UF_TM_REPORT_REQ"]').value;if(e===i&&n===a){this.timemanSettingsMenu.close();return}var s={ID:t.id,source:t.type,UF_TIMEMAN:i,UF_TM_REPORT_REQ:a};BX.timeman_query("admin_data_settings",s,function(t,e){if(t.type==="user"){for(var i=0;i<this.settingsData.USERS.length;i++){if(this.settingsData.USERS[i].ID===e.ID){this.settingsData.USERS[i]=e;break}}}else if(t.type==="department"){for(var i=0;i<this.settingsData.DEPARTMENTS.length;i++){if(this.settingsData.DEPARTMENTS[i].ID===e.ID){this.settingsData.DEPARTMENTS[i]=e;break}}}this.timemanSettingsMenu.close()}.bind(this,t))}.bind(this,t.target.dataset)}}),new BX.PopupWindowCustomButton({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"ui-btn ui-btn-link",events:{click:function(){if(this.timemanSettingsMenu){this.timemanSettingsMenu.close()}}.bind(this)}})]}this.timemanSettingsMenu=new BX.PopupWindow("tm-setting_form_"+t.target.dataset.id+t.target.dataset.type,t.target,{width:320,closeIcon:{right:"12px",top:"10px"},autoHide:true,content:BX("tm-settings-popup-menu").innerHTML,events:{onPopupShow:function(t){var e=this.timemanSettingsMenu.getContentContainer().querySelector('[name="UF_TM_REPORT_REQ"]');var i=this.timemanSettingsMenu.getContentContainer().querySelector('[name="UF_TIMEMAN"]');this.showElement(i.querySelector('option[value=""]'));this.showElement(e.querySelector('option[value=""]'));var n=t.type==="department"&&this.departmentsData[t.id]&&this.departmentsData[t.id].TOP_SECTION===true;this.selectOptionBySettings("UF_TIMEMAN",t,n);this.selectOptionBySettings("UF_TM_REPORT_REQ",t,n);BX.bind(i,"change",BX.proxy(this.onSettingOptionChange,this));BX.bind(this.selectOneByRole("schedules-list-toggle",this.timemanSettingsMenu.getContentContainer()),"click",this.showSchedulesListMenu.bind(this,t));if(n){this.hideElement(i.querySelector('option[value=""]'));this.hideElement(e.querySelector('option[value=""]'))}}.bind(this,t.target.dataset)},buttons:n});this.timemanSettingsMenu.show()},selectOptionBySettings:function(t,e,i){var n=this.getSettingsOption(e.type,e.id,t,i);var a=this.timemanSettingsMenu.getContentContainer().querySelector('[name="'+t+'"]');var s=a.querySelector('option[value="'+n+'"]');if(s){s.selected=true;if(t==="UF_TIMEMAN"){this.showViolationMenuBlock(n)}}},onSettingOptionChange:function(t){this.showViolationMenuBlock(t.currentTarget.value)},showSchedulesListMenu:function(t,e){var i=[];var n=this.schedules[this.buildEntityCode(t)];if(!(n&&n.length>0)){if(this.settingsLoading===true&&!this.loader){this.loader=new BX.Loader({target:e.currentTarget});this.loader.show()}return}for(var a=0;a<n.length;a++){var s={text:BX.message("TIMEMAN_GRID_MENU_SCHEDULE_PERSONAL_VIOLATIONS_PREFIX")+' "'+BX.util.htmlspecialchars(n[a].NAME)+'"',dataset:{url:n[a].LINKS.DETAIL,entityCode:this.buildEntityCode(t),isFlexible:this.isScheduleFlexible(n[a].SCHEDULE_TYPE)}};s.onclick=function(t,e){if(!e.dataset.isFlexible&&this.canReadSchedules){var i=BX.util.add_url_param(e.dataset.url,{IFRAME:"Y",VIOLATIONS_ONLY:"Y",ENTITY_CODE:e.dataset.entityCode});BX.SidePanel.Instance.open(i,{width:1400,cacheable:false})}e.menuWindow.close()}.bind(this);i.push(s)}var r=BX.PopupMenu.create({items:i,maxHeight:450,id:"tmSettingsScheduleViolations"+this.buildEntityCode(t)+BX.util.getRandomString(20),bindElement:e?e.currentTarget?e.currentTarget:e.target:this.loader?this.loader.currentTarget:null,angle:{position:"top"},closeByEsc:true,autoHide:true});r.show();if(this.loader){this.loader.hide();this.loader=null}},showViolationMenuBlock:function(t){var e=this.selectOneByRole("schedule-personal-violations",this.timemanSettingsMenu.getContentContainer());if(t==="N"){this.hideElement(e)}else{this.showElement(e)}},isScheduleFlexible:function(t){return t===this.flexibleScheduleTypeName},getSettingsOption:function(t,e,i,n){var a=[];if(t==="user"){a=this.settingsData.USERS}else if(t==="department"){a=this.settingsData.DEPARTMENTS}for(var s=0;s<a.length;s++){if(a[s].ID==e){var r=[];r.push(a[s].SETTINGS[i]);if(n){r.push(this.settingsData.DEFAULTS[i])}for(var o=0;o<r.length;o++){if(r[o]===true||r[o]==="Y"){return"Y"}if(r[o]===false||r[o]==="N"){return"N"}if(r[o]!==""){return r[o]}}return""}}},buildEntityCode:function(t){return(t.type==="user"?"U":"DR")+t.id},applyFilterFromUrlData:function(t){if(!this.filterId){window.location.href=t.href;return}var e=t.dataset;var i=BX.Main.filterManager.getById(this.filterId);var n={};if(e.startFrom){n.REPORT_PERIOD_from=e.startFrom}if(e.startTo){n.REPORT_PERIOD_to=e.startTo}if(e.startDatesel){n.REPORT_PERIOD_datesel=e.startDatesel}i.getApi().extendFilter(n,true)},onTodayLinkClick:function(t){t.preventDefault();t.stopPropagation();if(this.getTodayColumnHeader()){this.scrollToToday();return}if(!this.filterId){window.location.href=t.target.href;return}this.applyFilterFromUrlData(t.currentTarget)},onScheduleCreateBtnClick:function(t){t.stopPropagation();t.preventDefault();BX.SidePanel.Instance.open("/bitrix/components/bitrix/timeman.schedule.edit/slider.php",{width:1200,cacheable:false})},getTodayColumnHeader:function(){return document.querySelector(".js-tm-header-today")},highlightDepartmentRows:function(){var t=document.querySelectorAll(".tm-department-name");for(var e=0;e<t.length;e++){if(t[e].closest("tr")){t[e].closest("tr").classList.add("tm-department-name-row")}}},scrollToToday:function(){if(!this.getTodayColumnHeader()){return}if(!BX.Main.gridManager.getById(this.gridId)&&BX.Main.gridManager.getById(this.gridId).instance){return}if(!BX.Main.gridManager.getById(this.gridId).instance.getScrollContainer().scrollTo||typeof BX.Main.gridManager.getById(this.gridId).instance.getScrollContainer().scrollTo!=="function"){return}var t=BX.Main.gridManager.getById(this.gridId).instance.getScrollContainer().clientWidth;var e=document.querySelectorAll(".main-grid-cell-head");var i=0;var n=null;var a=0;var s=0;for(var r=0;r<e.length;r++){var o=e[r];if(o.classList.contains("js-tm-fixed-columns")&&o.classList.contains("main-grid-fixed-column")){a++;s+=o.offsetWidth}if(!o.classList.contains("js-tm-fixed-columns")&&i===0){i=o.offsetWidth}if(o===this.getTodayColumnHeader()&&n===null){n=r}}if(i<=0||n===null){return}t=t-s;var l=parseInt(t/i);var d=n-a-l+3;if(i*d>0){BX.Main.gridManager.getById(this.gridId).instance.getScrollContainer().scrollTo(i*d-s,0)}},onGridUpdated:function(){this.addEventHandlersInsideGrid();this.initHints();this.highlightDepartmentRows();this.scrollToToday()},initHints:function(){BX.UI.Hint.init(this.container)}}})();
//# sourceMappingURL=script.map.js