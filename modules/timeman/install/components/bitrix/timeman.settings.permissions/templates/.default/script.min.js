(function(){BX.namespace("BX.Timeman.Component.Settings");BX.Timeman.Component.Settings.Permissions=function(e){BX.Timeman.Component.BaseComponent.apply(this,arguments);this.accessTable=this.selectOneByRole("tm-role-access-table");this.addTaskAccessBtn=this.selectOneByRole("add-role-access-mapping");this.accessTableBody=this.accessTable.querySelector("tbody");this.accessTableLastRow=this.accessTable.querySelector("tr.tm-access-table-last-row");this.tasksTableLastRow=this.container.querySelector("tr.tm-roles-table-last-row");this.rolesTableBody=this.container.querySelector("table.tm-roles-table tbody");this.saveBtn=this.selectOneByRole("tm-save-task-to-access-code-map");BX.Access.Init({other:{disabled:true}});if(window===window.top){BX.SidePanel.Instance.bindAnchors({rules:[{condition:[new RegExp("/timeman/settings/permissions/($|\\?)","i")],options:{cacheable:false,allowChangeHistory:false,width:1200}}]})}this.addEventHandlers()};BX.Timeman.Component.Settings.Permissions.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Settings.Permissions,addEventHandlers:function(){BX.bind(this.saveBtn,"click",BX.delegate(this.onSaveBtnClick,this));BX.bind(this.addTaskAccessBtn,"click",BX.delegate(this.onAddTaskAccessBtnClick,this));BX.bindDelegate(this.container,"click",{className:"tm-delete-access"},BX.proxy(this.onDeleteAccess,this));BX.bindDelegate(this.container,"click",{className:"tm-delete-role"},BX.proxy(this.onDeleteRole,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy(function(e){if(e.getEventId()==="timeman-add-task"){var t=e.getData();var s=t.task;if(BX.type.isNotEmptyObject(s)){var a=BX("tm-new-role-row").innerHTML;a=this.replaceTemplateData(a,{ID:s.id,NAME:BX.util.htmlspecialchars(s.name),EDIT_URL:this.getEditTaskUrl(s.id)});var n=BX.create("tr",{html:a});n.dataset.taskId=s.id;this.rolesTableBody.insertBefore(n,this.tasksTableLastRow);var i,o=this.accessTableBody.querySelectorAll(".tm-select-role");for(var r=0,c=o.length;r<c;r++){i=BX.create("option",{attrs:{title:s.name,value:s.id,"data-task-id":s.id},text:s.name});o[r].appendChild(i)}}}},this))},getEditTaskUrl:function(e){var t=this.rolesTableBody.querySelector(".tm-edit-task a").href;return BX.util.add_url_param(t,{taskId:e})},onDeleteRole:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.taskId;var a=document.querySelectorAll('*[data-task-id="'+s+'"]');this.confirm(BX.message("TIMEMAN_SETTINGS_PERMS_ROLE_DELETE"),BX.util.htmlspecialchars(BX.message("TIMEMAN_SETTINGS_PERMS_ROLE_DELETE_CONFIRM")),function(e){if(!e.confirmed){return}BX.showWait();BX.ajax.runAction("timeman.permissions.deleteTask",{data:{id:s}}).then(function(){BX.closeWait();for(var e=0;e<a.length;e++){BX.remove(a[e])}},function(e){BX.closeWait()})})},confirm:function(e,t,s){var a={confirmed:false};var n="tm-delete-task-confirm-popup";var i=new BX.PopupWindow(n,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("TIMEMAN_SETTINGS_PERMS_ROLE_OK"),className:"popup-window-button-accept",events:{click:function(){i.close();a.confirmed=true;if(BX.type.isFunction(s)){s(a)}}}}),new BX.PopupWindowButtonLink({text:BX.message("TIMEMAN_SETTINGS_PERMS_ROLE_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){i.close();a.confirmed=false;if(BX.type.isFunction(s)){s(a)}}}})]});i.show()},onSaveBtnClick:function(){if(this.saveBtn.disabled){return}this.saveBtn.disabled=true;BX.showWait();var e=[];var t=this.accessTable.querySelectorAll("tr");var s=t.length;for(var a=0;a<s-1;a++){if(!t[a].dataset.accessCode){continue}e.push({accessCode:t[a].dataset.accessCode,taskId:t[a].querySelector("select").value})}BX.ajax.runAction("timeman.permissions.addTaskToAccessCode",{data:{accesses:e}}).then(function(e){BX.reload()}.bind(this),function(e){this.saveBtn.disabled=false}.bind(this))},onDeleteAccess:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.accessCode;var a=this.accessTable.querySelectorAll('tr[data-access-code="'+s+'"]');for(var n=0;n<a.length;n++){BX.remove(a[n])}},onAddTaskAccessBtnClick:function(){var e={};var t=this.accessTable.rows.length;for(var s=0;s<t;s++){if(this.accessTable.rows[s].dataset.accessCode){e[this.accessTable.rows[s].dataset.accessCode]=true}}BX.Access.SetSelected(e,"timemanPerms");BX.Access.ShowForm({bind:"timemanPerms",callback:function(e){var t;var s;for(var a in e){for(var n in e[a]){t=BX.Access.GetProviderName(e[a][n].provider);s=e[a][n].name;this.renderNewAccessCode(n,t,s,1)}}}.bind(this)})},renderNewAccessCode:function(e,t,s,a){var n=BX("tm-new-access-row").innerHTML;n=this.replaceTemplateData(n,{PROVIDER:t,NAME:s,ACCESS_CODE:e});var i=BX.create("tr",{html:n});i.dataset.taskId=a;i.dataset.accessCode=e;i.querySelector("select").value=a;this.accessTableBody.insertBefore(i,this.accessTableLastRow)},replaceTemplateData:function(e,t){if(!BX.type.isPlainObject(t)){return e}var s=e.replace(/#(\w+?)#/g,function(e,s,a){if(t.hasOwnProperty(s)){return t[s]}else{return e}});return s}};BX.Timeman.Component.Settings.Permissions.Role=function(e){BX.Timeman.Component.BaseComponent.apply(this,arguments);this.form=this.selectOneByRole("task-form");this.isSystem=e.isSystem;this.saveBtn=document.querySelector("#tm-save-task");if(this.isSystem){this.saveBtn.disabled=true}this.addEventHandlers()};BX.Timeman.Component.Settings.Permissions.Role.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Settings.Permissions.Role,addEventHandlers:function(){BX.bind(this.saveBtn,"click",BX.delegate(this.onSaveBtnClick,this))},onSaveBtnClick:function(){if(this.saveBtn.disabled){return}this.saveBtn.disabled=true;var e=new FormData(this.form);BX.ajax.runAction("timeman.permissions.saveTask",{data:e}).then(function(t){this.saveBtn.disabled=false;if(BX.SidePanel&&e.get("TaskForm[id]")===""){var s=BX.SidePanel.Instance.getTopSlider();if(s){BX.SidePanel.Instance.postMessageAll(s,"timeman-add-task",{task:t.data.task})}}this.closeSlider()}.bind(this),function(e){this.saveBtn.disabled=false;this.showError(e.errors.pop().message);BX("tm-save-task").disabled=false;setTimeout(function(){BX("tm-save-task").classList.remove("ui-btn-wait")}.bind(this),100)}.bind(this))},showError:function(e){var t=new BX.UI.Alert({color:BX.UI.Alert.Color.DANGER,icon:BX.UI.Alert.Icon.DANGER,text:e});BX.adjust(BX("role-alert-container"),{html:""});BX.append(t.getContainer(),BX("role-alert-container"))},closeSlider:function(){if(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){var e=window.top.BX.SidePanel.Instance.getTopSlider();if(e){e.close()}}}}})();
//# sourceMappingURL=script.map.js