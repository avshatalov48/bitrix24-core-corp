this.BX=this.BX||{};(function(e,t,i){"use strict";var n=function(){function e(){babelHelpers.classCallCheck(this,e);this.storageKey="bx-timeman-monitor-logger-enabled";this.enabled=null}babelHelpers.createClass(e,[{key:"start",value:function e(){if(!v.isEnabled()){return}this.enabled=true;if(typeof window.localStorage!=="undefined"){try{window.localStorage.setItem(this.storageKey,"Y")}catch(e){}}return this.enabled}},{key:"stop",value:function e(){this.enabled=false;if(typeof window.localStorage!=="undefined"){try{window.localStorage.removeItem(this.storageKey)}catch(e){}}return this.enabled}},{key:"isEnabled",value:function e(){if(!v.isEnabled()){return false}if(this.enabled===null){if(typeof window.localStorage!=="undefined"){try{this.enabled=window.localStorage.getItem(this.storageKey)==="Y"}catch(e){}}}return this.enabled===true}},{key:"log",value:function e(){if(this.isEnabled()){var t;(t=console).log.apply(t,arguments)}}},{key:"info",value:function e(){if(this.isEnabled()){var t;(t=console).info.apply(t,arguments)}}},{key:"warn",value:function e(){if(this.isEnabled()){var t;(t=console).warn.apply(t,arguments)}}},{key:"error",value:function e(){var t;(t=console).error.apply(t,arguments)}},{key:"trace",value:function e(){var t;(t=console).trace.apply(t,arguments)}}]);return e}();var s=new n;var a=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"isEnabled",value:function e(){return v.isEnabled()}},{key:"log",value:function e(){if(!this.isEnabled()){return}var t=this.getLogMessage.apply(this,arguments);BX.desktop.log(BX.message("USER_ID")+".monitor.log",t.substr(3))}},{key:"space",value:function e(){if(!this.isEnabled()){return}BX.desktop.log(BX.message("USER_ID")+".monitor.log"," ")}},{key:"getLogMessage",value:function e(){if(!this.isEnabled()){return}var t="";for(var i=0;i<arguments.length;i++){if(arguments[i]instanceof Error){t=arguments[i].message+"\n"+arguments[i].stack}else{try{t=t+" | "+(babelHelpers.typeof(arguments[i])=="object"?JSON.stringify(arguments[i]):arguments[i])}catch(e){t=t+" | (circular structure)"}}}return t}}]);return e}();var r=new a;var o=function(){function e(t,i,n){babelHelpers.classCallCheck(this,e);this.appName=t;this.appCode=e.createCode(this.appName);this.desktopCode=e.createCode(BXDesktopSystem.UserAccount(),BXDesktopSystem.UserOsMark());if(n!==""){var a;try{a=new URL(n).host}catch(e){a=n}this.host=a;this.siteUrl=n;this.siteTitle=i;this.code=e.createCode(this.appCode,this.host,this.desktopCode);this.pageCode=e.createCode(this.appCode,this.siteUrl,this.desktopCode);this.siteCode=e.createCode(this.host);s.log("New browser activity "+n);r.log("Started NEW site","Host: ".concat(this.host),"title: ".concat(this.siteTitle),"URL: ".concat(this.siteUrl))}else{this.code=e.createCode(this.appCode,this.desktopCode);s.log("New program activity "+this.appName);r.log("Started NEW app","Name: ".concat(this.appName))}this.time=[{start:new Date,finish:null}]}babelHelpers.createClass(e,null,[{key:"createCode",value:function e(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++){i[n]=arguments[n]}return BX.md5(i.join(""))}}]);return e}();var l=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.bounceTimeout=t;this.history=this.loadHistory();this.removeUnfinishedEvents()}},{key:"add",value:function e(t,i,n){var a=this.getDateForHistoryKey();if(!this.history[a]){this.history[a]=[new o(t,i,n)];s.log("Created history for: "+a);return}var r=this.findByAppNameAndSiteUrl(this.history[a],t,n);var l=this.findByAppName(this.history[a],t);this.finishLastInterval();if(r!==undefined){this.startInterval(r);this.saveHistory();s.log("Started interval for host: "+r.siteUrl+" | URL: "+r.appName);return}else if(l!==undefined&&n===""){this.startInterval(l);this.saveHistory();s.log("Started interval for app "+l.appName);return}this.history[a].push(new o(t,i,n));this.saveHistory();s.log(this.history)}},{key:"getDateForHistoryKey",value:function e(){var t=new Date;var i=function e(t){return t>=0&&t<=9?"0"+t:t};return t.getFullYear()+"-"+i(t.getMonth()+1)+"-"+i(t.getDate())}},{key:"findByAppName",value:function e(t,i){return t.find(function(e){return e.appName===i})}},{key:"findByAppNameAndSiteUrl",value:function e(t,i,n){return t.find(function(e){return e.appName===i&&e.siteUrl===n})}},{key:"startInterval",value:function e(t){t.time.push({start:new Date,finish:null});s.log(this.history);if(t.siteTitle){r.log("Started site","Host: ".concat(t.host),"title: ".concat(t.siteTitle),"URL: ".concat(t.siteUrl))}else{r.log("Started app","Name: ".concat(t.appName))}}},{key:"finishLastInterval",value:function e(){for(var t in this.history){this.history[t].forEach(function(e){e.time.forEach(function(t){if(t.finish===null){t.finish=new Date;if(e.siteTitle){r.log("Finished site","Host: ".concat(e.host),"title: ".concat(e.siteTitle),"URL: ".concat(e.siteUrl))}else{r.log("Finished app","Name: ".concat(e.appName))}}})})}}},{key:"getGroupedHistory",value:function e(){var t=BX.util.objectClone(this.history);var i=Math.round(this.bounceTimeout/1e3);var n={};for(var s in t){n[s]=t[s].map(this.calculateTimeInProgram).filter(function(e){return e.time>i})}return n}},{key:"calculateTimeInProgram",value:function e(t){t.time=t.time.map(function(e){var t=e.finish?new Date(e.finish):new Date;return t-new Date(e.start)}).reduce(function(e,t){return e+t},0);t.time=Math.round(t.time/1e3);return t}},{key:"loadHistory",value:function e(){return BX.desktop.getLocalConfig("bx_timeman_monitor_history","{}")}},{key:"saveHistory",value:function e(){BX.desktop.setLocalConfig("bx_timeman_monitor_history",this.history)}},{key:"removeHistoryBeforeDate",value:function e(t){if(!t){return}var i=new Date(t+" 00:00:00");for(var n in this.history){var a=new Date(n+" 00:00:00");if(a<i){delete this.history[n];this.saveHistory();s.warn("History for the "+n+" has been deleted")}}}},{key:"removeUnfinishedEvents",value:function e(){for(var t in this.history){this.history[t]=this.history[t].map(function(e){e.time=e.time.filter(function(e){return e.finish!==null});return e})}this.saveHistory()}}]);return e}();var u=new l;var d=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(){this.enabled=false;this.lastApp={name:null,url:null}}},{key:"catch",value:function e(t,i,n,s){if(!this.enabled||!t){return}if(i===""){i=this.getNameByProcess(t)}if(!this.isNewEvent(i,s)){return}u.add(i,n,s);this.lastApp={name:i,url:s}}},{key:"getNameByProcess",value:function e(t){var i=t.includes("/")?"/":"\\";var n=t.split(i);return n[n.length-1]}},{key:"isNewEvent",value:function e(t,i){if(this.url===""){if(this.lastApp.name===t){return false}}else{if(this.lastApp.name===t&&this.lastApp.url===i){return false}}return true}},{key:"start",value:function e(){var t=this;if(this.enabled){s.warn("EventHandler already started");return}this.enabled=true;BX.desktop.addCustomEvent("BXUserApp",function(e,i,n,s){return t.catch(e,i,n,s)});BXDesktopSystem.ListScreenMedia(function(e){for(var t=1;t<e.length;t++){if(e[t].id.includes("screen")){continue}u.add(e[t].process,"","");return true}});s.log("EventHandler started")}},{key:"stop",value:function e(){if(!this.enabled){s.warn("EventHandler already stopped");return}this.enabled=false;u.finishLastInterval();BX.desktop.setLocalConfig("bx_timeman_monitor_history",u.history);s.log("EventHandler stopped")}}]);return e}();var c=new d;var h=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:5e3;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:5e3;this.enabled=false;this.sendTimeout=t;this.resendTimeout=i;this.sendTimeoutId=null;this.attempt=0}},{key:"send",value:function e(){var t=this;if(!this.enabled){return}var i=this.immediatelySendHistoryOnce();s.warn("Trying to send history...");i.then(function(e){if(e.status==="success"){var i=e.data;s.warn("SUCCESS!");t.saveLastSuccessfulSendDate();u.removeHistoryBeforeDate(t.getLastSuccessfulSendDate());t.attempt=0;t.startSendingTimer();if(i.state===v.getStateStop()){s.warn("Stopped after server response");r.log("Stopped after server response");v.setState(i.state);v.stop()}if(i.enabled===v.getStatusDisabled()){s.warn("Disabled after server response");r.log("Disabled after server response");v.disable()}}else{s.error("ERROR!");t.attempt++;t.startSendingTimer()}}).catch(function(){s.error("CONNECTION ERROR!");t.attempt++;t.startSendingTimer()})}},{key:"immediatelySendHistoryOnce",value:function e(){var t=JSON.stringify(u.getGroupedHistory());r.log("History sent");return BX.ajax.runAction("bitrix:timeman.api.monitor.recordhistory",{data:{history:t}})}},{key:"startSendingTimer",value:function e(){this.sendTimeoutId=setTimeout(this.send.bind(this),this.getSendingDelay());s.log("Next send in ".concat(this.getSendingDelay()/1e3," seconds..."))}},{key:"getSendingDelay",value:function e(){return this.attempt===0?this.sendTimeout:this.resendTimeout}},{key:"saveLastSuccessfulSendDate",value:function e(){BX.desktop.setLocalConfig("bx_timeman_monitor_last_successful_send_date",u.getDateForHistoryKey())}},{key:"getLastSuccessfulSendDate",value:function e(){return BX.desktop.getLocalConfig("bx_timeman_monitor_last_successful_send_date")}},{key:"start",value:function e(){if(this.enabled){s.warn("Sender already started");return}this.enabled=true;this.attempt=0;this.startSendingTimer();s.log("Sender started")}},{key:"stop",value:function e(){if(!this.enabled){s.warn("Sender already stopped");return}this.enabled=false;this.attempt=0;clearTimeout(this.sendTimeoutId);this.immediatelySendHistoryOnce();s.log("Immediately send request sent");s.log("Sender stopped")}}]);return e}();var f=new h;var p=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"timeman"}},{key:"handleChangeDayState",value:function e(t){v.setState(t.state);if(!v.isEnabled()){s.warn("Ignore day state, monitor is disabled!");r.log("Ignore day state, monitor is disabled!");return}if(t.state===v.getStateStart()){v.start()}else if(t.state===v.getStateStop()){v.stop()}}},{key:"handleChangeMonitorEnabled",value:function e(t){if(t.enabled===v.getStatusEnabled()){s.warn("Enabled via API");r.log("Enabled via API");v.enable();if(v.isWorkingDayStarted()){v.start()}}else{v.stop();v.disable();s.warn("Disabled via API");r.log("Disabled via API")}}}]);return e}();var y=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(t){var n=this;this.enabled=t.enabled;this.state=t.state;this.bounceTimeout=t.bounceTimeout;this.sendTimeout=t.sendTimeout;this.resendTimeout=t.resendTimeout;r.space();r.log("Desktop launched!");if(this.isEnabled()&&s.isEnabled()){BXDesktopSystem.LogInfo=function(){};s.start()}r.log("Enabled: ".concat(this.enabled));i.PULL.subscribe(new p);u.init(this.bounceTimeout);c.init();f.init(this.sendTimeout,this.resendTimeout);BX.desktop.addCustomEvent("BXUserAway",function(e){return n.onAway(e)});if(this.isEnabled()){if(this.isWorkingDayStarted()){this.start()}else{s.warn("Monitor: Zzz...")}}else{s.warn("Monitor is disabled")}}},{key:"start",value:function e(){if(!this.isEnabled()){s.warn("Can't start, monitor is disabled!");r.log("Can't start, monitor is disabled!");return}if(!this.isWorkingDayStarted()){s.warn("Can't start monitor, working day is stopped!");r.log("Can't start monitor, working day is stopped!");return}r.log("Monitor started");r.space();c.start();f.start();s.warn("Monitor started")}},{key:"stop",value:function e(){c.stop();f.stop();s.warn("Monitor stopped");r.log("Monitor stopped")}},{key:"onAway",value:function e(t){if(!this.isEnabled()){return}if(t){r.space();r.log("User AWAY");this.stop()}else{r.space();if(this.isWorkingDayStarted()){r.log("User RETURNED, continue monitoring...");this.start()}else{r.log("User RETURNED, but working day is stopped")}}}},{key:"isWorkingDayStarted",value:function e(){return this.getState()===this.getStateStart()}},{key:"setState",value:function e(t){this.state=t}},{key:"getState",value:function e(){return this.state}},{key:"isEnabled",value:function e(){return this.enabled===this.getStatusEnabled()}},{key:"enable",value:function e(){this.enabled=this.getStatusEnabled()}},{key:"disable",value:function e(){this.stop();this.enabled=this.getStatusDisabled()}},{key:"getStatusEnabled",value:function e(){return"Y"}},{key:"getStatusDisabled",value:function e(){return"N"}},{key:"getStateStart",value:function e(){return"start"}},{key:"getStateStop",value:function e(){return"stop"}}]);return e}();var v=new y;e.Monitor=v})(this.BX.Timeman=this.BX.Timeman||{},BX,BX);
//# sourceMappingURL=monitor.bundle.map.js