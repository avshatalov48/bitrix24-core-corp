this.BX=this.BX||{};(function(e,t,n,i,r,a,o,s,l,u,c){"use strict";var p=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createPublic",value:function e(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++){i[r]=arguments[r]}return n.md5(i.join(""))}},{key:"createPrivate",value:function e(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++){n[r]=arguments[r]}return i.sha1(n.join(""))}},{key:"createSecret",value:function t(){if(typeof BXDesktopSystem==="undefined"){return null}return e.createPrivate(BXDesktopSystem.UserAccount(),BXDesktopSystem.UserOsMark(),+Date.now())}},{key:"getDesktopCode",value:function t(){if(typeof BXDesktopSystem==="undefined"){return null}return e.createPublic(BXDesktopSystem.UserAccount(),BXDesktopSystem.UserOsMark())}}]);return e}();var f=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"calculateInEntityOnADate",value:function t(n,i,r){return n.history.filter(function(e){return e.privateCode===i.privateCode&&e.dateLog===r}).map(e.calculateInEntry).reduce(function(e,t){return e+t},0)}},{key:"calculateInEntry",value:function e(t){var n=t.time.map(function(e){var t=e.finish?new Date(e.finish):new Date;return t-new Date(e.start)}).reduce(function(e,t){return e+t},0);return Math.round(n/1e3)}},{key:"formatDateToTime",value:function e(t){var n=function e(t){return t>=0&&t<=9?"0"+t:t};var i=t.getHours();var r=n(t.getMinutes());return i+":"+r}},{key:"msToSec",value:function e(t){return t/1e3}}]);return e}();var y=function(){function e(){babelHelpers.classCallCheck(this,e);this.storageKey="bx-timeman-monitor-logger-enabled";this.enabled=null}babelHelpers.createClass(e,[{key:"start",value:function e(){if(!H.isEnabled()){return}this.enabled=true;if(typeof window.localStorage!=="undefined"){try{window.localStorage.setItem(this.storageKey,"Y")}catch(e){}}return this.enabled}},{key:"stop",value:function e(){this.enabled=false;if(typeof window.localStorage!=="undefined"){try{window.localStorage.removeItem(this.storageKey)}catch(e){}}return this.enabled}},{key:"isEnabled",value:function e(){if(!H.isEnabled()){return false}if(this.enabled===null){if(typeof window.localStorage!=="undefined"){try{this.enabled=window.localStorage.getItem(this.storageKey)==="Y"}catch(e){}}}return this.enabled===true}},{key:"log",value:function e(){if(this.isEnabled()){var t;(t=console).log.apply(t,arguments)}}},{key:"info",value:function e(){if(this.isEnabled()){var t;(t=console).info.apply(t,arguments)}}},{key:"warn",value:function e(){if(this.isEnabled()){var t;(t=console).warn.apply(t,arguments)}}},{key:"error",value:function e(){var t;(t=console).error.apply(t,arguments)}},{key:"trace",value:function e(){var t;(t=console).trace.apply(t,arguments)}}]);return e}();var d=new y;var g=function(){function e(){babelHelpers.classCallCheck(this,e);this.enabled=false}babelHelpers.createClass(e,[{key:"isEnabled",value:function e(){return this.enabled}},{key:"enable",value:function e(){this.enabled=true}},{key:"disable",value:function e(){this.enabled=false}},{key:"log",value:function e(){if(!this.isEnabled()){return}var t=this.getLogMessage.apply(this,arguments);BX.desktop.log(c.Loc.getMessage("USER_ID")+".monitor.log",t.substr(3))}},{key:"space",value:function e(){if(!this.isEnabled()){return}BX.desktop.log(c.Loc.getMessage("USER_ID")+".monitor.log"," ")}},{key:"getLogMessage",value:function e(){if(!this.isEnabled()){return}var t="";for(var n=0;n<arguments.length;n++){if(arguments[n]instanceof Error){t=arguments[n].message+"\n"+arguments[n].stack}else{try{t=t+" | "+(babelHelpers.typeof(arguments[n])=="object"?JSON.stringify(arguments[n]):arguments[n])}catch(e){t=t+" | (circular structure)"}}}return t}}]);return e}();var h=new g;var m=function(){function e(){babelHelpers.classCallCheck(this,e);this.actionsCollection={}}babelHelpers.createClass(e,[{key:"start",value:function e(t){this.actionsCollection[t]={};this.actionsCollection[t].start=Date.now()}},{key:"finish",value:function e(t){if(!this.actionsCollection[t]||!this.actionsCollection[t].start||this.actionsCollection[t].finish){return}this.actionsCollection[t].finish=Date.now()}},{key:"getDuration",value:function e(t){if(!this.actionsCollection[t]||!this.actionsCollection[t].start||!this.actionsCollection[t].finish){return}var n=(this.actionsCollection[t].finish-this.actionsCollection[t].start)/1e3;return"ACTION: ".concat(t,", TIME: ").concat(n.toFixed(2),"s")}}]);return e}();var v=new m;var b=function(){function e(t,n,i){babelHelpers.classCallCheck(this,e);this.title=t.toString();this.text=n.toString();if(c.Type.isFunction(i)){this.callback=i}return this}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;BXIM.playSound("newMessage1");var n=BXIM.notify.createNotify({id:0,type:4,date:new Date,params:{},title:this.title,text:this.text},true);var i='\n\t\t\tvar notify = BX.findChildByClassName(document.body, "bx-notifier-item");\n\t\t\t\n\t\t\tnotify.style.cursor = "pointer";\n\t\t\t\n\t\t\tBX.bind(notify, "click", function() {\n\t\t\t\tBX.desktop.onCustomEvent("main", "bxImClickPwtMessage", []);\n\t\t\t\tBX.desktop.windowCommand("close")\n\t\t\t});\n\t\t\t\n\t\t\tBX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event) { \n\t\t\t\tBX.desktop.windowCommand("close"); \n\t\t\t\tBX.MessengerCommon.preventDefault(event); \n\t\t\t});\n\t\t\t\n\t\t\tBX.bind(notify, "contextmenu", function() {\n\t\t\t\tBX.desktop.windowCommand("close")\n\t\t\t});\n\t\t';BXIM.desktop.openNewMessage("pwt"+new Date,n,i);BX.desktop.addCustomEvent("bxImClickPwtMessage",function(){return t.click()})}},{key:"click",value:function e(){if(c.Type.isFunction(this.callback)){this.callback()}BX.desktop.removeCustomEvents("bxImClickPwtMessage")}}]);return e}();var T=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return"monitor"}},{key:"getSaveTimeout",value:function e(){return 1e3}},{key:"getLoadTimeout",value:function e(){return false}},{key:"getState",value:function e(){return{config:{secret:p.createSecret(),desktopCode:p.getDesktopCode(),otherTime:this.getVariable("config.otherTime",18e5),shortAbsenceTime:this.getVariable("config.shortAbsenceTime",18e5),pausedUntil:null,lastSuccessfulSendDate:null,lastRemindDate:null,grantingPermissionDate:null,deferredGrantingPermissionShowDate:null},reportState:{dateLog:this.getDateLog(),comments:[]},personal:[],strictlyWorking:[],entity:[],history:[],sentQueue:[]}}},{key:"getEntityState",value:function e(){return{type:r.EntityType.unknown,title:"",publicCode:"",privateCode:"",comments:[],extra:{}}}},{key:"getHistoryState",value:function e(){return{dateLog:this.getDateLog(),privateCode:"",time:[{start:new Date,preFinish:null,finish:null}]}}},{key:"getSentQueueState",value:function e(){return{dateLog:this.getDateLog(),comment:"",historyPackage:[],chartPackage:[],desktopCode:""}}},{key:"getActions",value:function e(){var n=this;return{setDateLog:function e(t,n){if(c.Type.isString(n)){var i=new Date(n);if(c.Type.isDate(i)&&!isNaN(i)&&n.length===10){t.commit("setDateLog",n)}}},refreshDateLog:function e(t){if(c.Type.isArrayFilled(t.state.history)){var i=t.state.history[0].dateLog;n.getActions().setDateLog(t,i);d.log("Report date is set for ".concat(i));h.log("Report date is set for ".concat(i))}else{var r=n.getDateLog();n.getActions().setDateLog(t,r);d.log("Report date is set for ".concat(r));h.log("Report date is set for ".concat(r))}},setLastRemindDate:function e(t,n){t.commit("setLastRemindDate",n)},grantPermission:function e(t){t.commit("setGrantingPermissionDate",new Date)},showGrantingPermissionLater:function e(n){var i=new Date;i.setDate(i.getDate()+1);var r=t.prototype.formatDateLog(i);n.commit("setDeferredGrantingPermissionShowDate",r)},setLastSuccessfulSendDate:function e(t,n){if(c.Type.isDate(n)&&!isNaN(n)){t.commit("setLastSuccessfulSendDate",n)}},addPersonal:function e(t,i){t.commit("addPersonal",n.validatePersonal(i))},removePersonal:function e(t,i){t.commit("removePersonal",n.validatePersonal(i))},addToStrictlyWorking:function e(t,n){t.commit("addToStrictlyWorking",n)},removeFromStrictlyWorking:function e(t,n){t.commit("removeFromStrictlyWorking",n)},clearStrictlyWorking:function e(t){t.commit("clearStrictlyWorking")},clearPersonal:function e(t){t.commit("clearPersonal")},addEntity:function e(t,i){var a=n.validateEntity(babelHelpers.objectSpread({},i));if(a.type!==r.EntityType.absence&&a.type!==r.EntityType.custom){a.publicCode=p.createPublic(a.title);a.privateCode=p.createPrivate(a.title,t.state.config.secret)}else{var o=new Date;var s=+o;a.publicCode=p.createPublic(a.title,s);a.privateCode=p.createPrivate(a.title,s,t.state.config.secret);if(a.type===r.EntityType.absence){a.extra={timeStart:o};a.title+=" "+c.Loc.getMessage("TIMEMAN_PWT_REPORT_ABSENCE_FROM_TIME")+" "+f.formatDateToTime(a.extra.timeStart)}}t.commit("addEntity",babelHelpers.objectSpread({},n.getEntityState(),a));if(!t.state.strictlyWorking.find(function(e){return e===a.privateCode})){var l=a.type===r.EntityType.site&&a.title===location.host;var u=a.type===r.EntityType.app&&i.isBitrix24Desktop;if(l||u||a.type===r.EntityType.custom){t.commit("addToStrictlyWorking",a.privateCode)}}return a},removeEntityByPrivateCode:function e(t,n){t.commit("removeEntityByPrivateCode",n)},clearEntities:function e(t){t.commit("clearEntities")},addHistory:function e(t,i){t.commit("finishLastInterval");var a=n.validateHistory(babelHelpers.objectSpread({},i));var o;var s;var l=null;if(a.type===r.EntityType.app||a.type===r.EntityType.site||a.type===r.EntityType.unknown||a.type===r.EntityType.incognito){o=n.getEntityByTitle(t,a.title);s=o?o.privateCode:null;if(!s){s=n.getActions().addEntity(t,i).privateCode}l=o&&o.type===r.EntityType.site?n.getHistoryEntryBySiteUrl(t,a.siteUrl):n.getHistoryEntryByPrivateCode(t,s)}else if(a.type===r.EntityType.absence||a.type===r.EntityType.custom){o=n.getActions().addEntity(t,i);s=o.privateCode}var u={type:a.type,title:a.title};if(!l){delete a.title;t.commit("addHistory",babelHelpers.objectSpread({},n.getHistoryState(),a,{privateCode:s}));v.finish("CATCH_ENTITY");h.log("Caught new:",u,v.getDuration("CATCH_ENTITY"));d.log("Caught new:",u,v.getDuration("CATCH_ENTITY"));return}if(a.type!==r.EntityType.custom){t.commit("startIntervalForHistoryEntry",l)}var p=t.state.config.lastRemindDate;var f=new Date(p)<new Date(n.getDateLog());var y=n.getGetters().isHistorySent(t.state);if(!p||f&&!y){if(n.getGetters().getWorkingTimeForToday(t.state)>=32400){new b(c.Loc.getMessage("TIMEMAN_PWT_REPORT_NOTIFICATION_REMINDER_TITLE"),c.Loc.getMessage("TIMEMAN_PWT_REPORT_NOTIFICATION_REMINDER_TEXT"),function(){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");BX.MessengerWindow.changeTab("timeman-pwt")}).show();t.commit("setLastRemindDate",n.getDateLog())}}v.finish("CATCH_ENTITY");h.log("Caught:",u,v.getDuration("CATCH_ENTITY"));d.log("Caught:",u,v.getDuration("CATCH_ENTITY"))},preFinishLastInterval:function e(t){t.commit("preFinishLastInterval")},finishLastInterval:function e(t){t.commit("finishLastInterval")},clearHistory:function e(t){t.commit("clearHistory")},createSentQueue:function e(t){if(t.state.history.length===0){return}var i=n.collectSentQueue(t);var r=t.state.reportState.comments.find(function(e){return e.dateLog===t.state.reportState.dateLog});var a=n.validateSentQueue({dateLog:t.state.reportState.dateLog,comment:r?r.text:"",historyPackage:i.history,chartPackage:i.chart,desktopCode:t.state.config.desktopCode});t.commit("createSentQueue",babelHelpers.objectSpread({},n.getSentQueueState(),a))},clearSentQueue:function e(t){t.commit("clearSentQueue")},clearSentHistory:function e(t){var i=t.state.config.lastSuccessfulSendDate;if(!i){return}if(new Date(n.getDateLog())>new Date(i)){t.commit("clearStorageBeforeDate",new Date(i))}},clearStorageBeforeDate:function e(t,n){t.commit("clearStorageBeforeDate",new Date(n))},setComment:function e(t,n){var i=t.state.entity.find(function(e){return e.privateCode===n.privateCode});if(i&&(c.Type.isString(n.comment)||c.Type.isNumber(n.comment))){t.commit("setComment",{entity:i,comment:n.comment.toString()})}},setPausedUntil:function e(t,n){if(c.Type.isDate(n)&&c.Type.isNumber(n.getTime())&&n>new Date){t.commit("setPausedUntil",n);d.warn("Monitor paused until ",n.toString());h.log("Monitor paused until ",n.toString())}},clearPausedUntil:function e(t){t.commit("clearPausedUntil")},setReportComment:function e(t,n){t.commit("setReportComment",n.toString())},processUnfinishedEvents:function e(t){t.commit("processUnfinishedEvents")},migrateHistory:function e(t){t.commit("migrateHistory")}}}},{key:"getMutations",value:function e(){var n=this;return{setDateLog:function e(i,r){i.reportState.dateLog=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setLastSuccessfulSendDate:function e(i,r){i.config.lastSuccessfulSendDate=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setLastRemindDate:function e(i,r){i.config.lastRemindDate=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setGrantingPermissionDate:function e(i,r){i.config.grantingPermissionDate=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setDeferredGrantingPermissionShowDate:function e(i,r){i.config.deferredGrantingPermissionShowDate=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},addPersonal:function e(i,r){i.personal.push(r);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},removePersonal:function e(i,r){i.personal=i.personal.filter(function(e){return e!==r});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},addToStrictlyWorking:function e(i,r){i.strictlyWorking.push(r);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},removeFromStrictlyWorking:function e(i,r){i.strictlyWorking=i.strictlyWorking.filter(function(e){return e!==r});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearStrictlyWorking:function e(i){i.strictlyWorking=[];babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearPersonal:function e(i){i.personal=[];babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},addEntity:function e(i,r){i.entity.push(r);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},removeEntityByPrivateCode:function e(i,r){i.entity=i.entity.filter(function(e){return e.privateCode!==r});i.history=i.history.filter(function(e){return e.privateCode!==r});i.strictlyWorking=i.strictlyWorking.filter(function(e){return e!==r});i.personal=i.personal.filter(function(e){return e!==r});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearEntities:function e(i){i.entity=[];babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},addHistory:function e(i,r){i.history.push(r);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},startIntervalForHistoryEntry:function e(i,r){r.time.push({start:new Date,finish:null});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},finishLastInterval:function e(i){var a=false;i.history.map(function(e){e.time=e.time.map(function(n){if(n.finish===null){n.finish=new Date;n.preFinish=null;if(new Date(n.start).getDate()!==n.finish.getDate()){a=true;n.markedForDeletion=true;d.warn("Interval marked for deletion");h.log("Interval marked for deletion")}if(e.type!==r.EntityType.absence){return n}var o=f.msToSec(i.config.shortAbsenceTime);i.entity.filter(function(e){if(!i.personal.includes(e.privateCode)){return e}}).map(function(e){return babelHelpers.objectSpread({},e,{time:f.calculateInEntityOnADate(i,e,i.reportState.dateLog)})}).sort(function(e,t){return e.time-t.time}).forEach(function(e){if(i.strictlyWorking.includes(e.privateCode)||e.type!==r.EntityType.absence){return}if(t.prototype.getCommentByEntity(i,e).trim()===""){if(o-e.time>=0){o-=e.time;return}i.personal.push(e.privateCode)}})}return n}).filter(function(e){return!e.markedForDeletion});return e});if(a){i.history=i.history.filter(function(e){return c.Type.isArrayFilled(e.time)})}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},preFinishLastInterval:function e(i){i.history=i.history.map(function(e){e.time=e.time.map(function(t){if(t.finish===null){t.preFinish=new Date;d.log("Last interval for ",e.privateCode," preFinished")}return t});return e});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearHistory:function e(i){i.history=[];babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},createSentQueue:function e(i,r){i.sentQueue.push(r);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearSentQueue:function e(i){i.sentQueue=[];babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearStorageBeforeDate:function e(i,a){i.history=i.history.filter(function(e){return new Date(e.dateLog)>a});var o=function e(t){var n=i.entity.find(function(e){return e.privateCode===t});if(c.Type.isObject(n)&&n.hasOwnProperty("type")){if(n.type!==r.EntityType.absence){return true}var a=i.history.find(function(e){return e.privateCode===t});if(a){return true}d.warn("".concat(n.title," has been removed from personal"));h.log("".concat(n.title," has been removed from personal"))}return false};i.personal=i.personal.filter(o);i.strictlyWorking=i.strictlyWorking.filter(o);if(c.Type.isArrayFilled(i.history)){var l=[];i.history.forEach(function(e){if(!l.includes(e.privateCode)){l.push(e.privateCode)}});i.entity=i.entity.filter(function(e){return l.includes(e.privateCode)});i.entity=i.entity.map(function(e){e.comments=e.comments.filter(function(e){return new Date(e.dateLog)>a});return e})}else{i.entity=[]}i.sentQueue=[];i.reportState.comments=i.reportState.comments.filter(function(e){return new Date(e.dateLog)>a});d.log("Local history before ".concat(s.DateFormatter.toString(a)," cleared"));h.space();h.log("Local history before ".concat(s.DateFormatter.toString(a)," cleared"));babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setComment:function e(i,r){var a=i.reportState.dateLog;var o=r.entity.comments.find(function(e){return e.dateLog===a});if(o){o.text=r.comment}else{r.entity.comments.push({dateLog:a,text:r.comment})}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setReportComment:function e(i,r){var a=i.reportState.dateLog;var o=i.reportState.comments.find(function(e){return e.dateLog===a});if(o){o.text=r}else{i.reportState.comments.push({dateLog:a,text:r})}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},setPausedUntil:function e(i,r){i.config.pausedUntil=r;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},clearPausedUntil:function e(i){i.config.pausedUntil=null;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},processUnfinishedEvents:function e(i){i.history.map(function(e){e.time=e.time.map(function(e){if(e.finish===null&&e.preFinish!==null){e.finish=e.preFinish;e.preFinish=null;d.log("Unfinished interval closed based on preFinish time");h.space();h.log("Unfinished interval closed based on preFinish time")}return e});e.time=e.time.filter(function(e){if(e.finish!=null){return true}else{d.log("Unfinished interval has been removed");h.space();h.log("Unfinished interval has been removed");return false}});return e});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)},migrateHistory:function e(i){i.entity.map(function(e){if(!e.hasOwnProperty("comments")){e.comments=[];if(e.comment){e.comments.push({dateLog:i.reportState.dateLog,text:e.comment})}}delete e.comment;return e});if(!i.reportState.hasOwnProperty("comments")){i.reportState.comments=[];if(i.reportState.comment){i.reportState.comments.push({dateLog:i.reportState.dateLog,text:i.reportState.comment})}delete i.reportState.comment}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"saveState",n).call(n,i)}}}},{key:"getGetters",value:function e(){return{getWorkingEntities:function e(n){var i=n.entity.filter(function(e){if(!n.personal.includes(e.privateCode)){return e}});i=i.map(function(e){var t=e.comments.find(function(e){return e.dateLog===n.reportState.dateLog});var i=babelHelpers.objectSpread({},e,{time:f.calculateInEntityOnADate(n,e,n.reportState.dateLog),comment:t?t.text:""});if(i.type===r.EntityType.unknown){i.hint=r.EntityGroup.unknown.hint}return i}).filter(function(e){return e.time>0});var a=f.msToSec(n.config.otherTime);var o=i.sort(function(e,t){return e.time-t.time}).filter(function(e){if(n.strictlyWorking.includes(e.privateCode)||e.type===r.EntityType.absence){return false}if(a-e.time>=0){a-=e.time;return true}else{return false}});var s=f.msToSec(n.config.shortAbsenceTime);var l=i.sort(function(e,t){return e.time-t.time}).filter(function(e){if(n.strictlyWorking.includes(e.privateCode)||e.type!==r.EntityType.absence){return false}if(t.prototype.getCommentByEntity(n,e).trim()===""){if(s-e.time>=0){s-=e.time;return true}return false}});var u=o.map(function(e){return e.privateCode});var p=l.map(function(e){return e.privateCode});var y=u.concat(p);i=i.filter(function(e){return!y.includes(e.privateCode)}).sort(function(e,t){return t.time-e.time});if(c.Type.isArrayFilled(o)){i.push({type:r.EntityType.group,title:r.EntityGroup.other.title,time:f.msToSec(n.config.otherTime)-a,allowedTime:f.msToSec(n.config.otherTime),hint:r.EntityGroup.other.hint,privateCode:r.EntityGroup.other.value})}if(c.Type.isArrayFilled(l)){i.push({type:r.EntityType.group,title:r.EntityGroup.absence.title,time:l.reduce(function(e,t){return e+t.time},0),allowedTime:f.msToSec(n.config.shortAbsenceTime),hint:r.EntityGroup.absence.hint,privateCode:r.EntityGroup.absence.value})}return i},getPersonalEntities:function e(t){var n=t.entity.filter(function(e){if(t.personal.includes(e.privateCode)){return e}});return n.map(function(e){var n=e.comments.find(function(e){return e.dateLog===t.reportState.dateLog});return babelHelpers.objectSpread({},e,{time:f.calculateInEntityOnADate(t,e,t.reportState.dateLog),comment:n?n.text:""})}).filter(function(e){return e.time>0}).sort(function(e,t){return t.time-e.time})},getSiteDetailByPrivateCode:function e(t){return function(e){var n=BX.util.objectClone(t.history);var i=n.filter(function(n){return n.privateCode===e&&n.dateLog===t.reportState.dateLog});i.map(function(e){e.time=f.calculateInEntry(e)});return i}},getChartData:function e(n){var i=[];var a=new Date(n.reportState.dateLog);var o=[{start:new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0),finish:new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59),type:r.EntityGroup.inactive.value,clickable:true,clickableHint:c.Loc.getMessage("TIMEMAN_PWT_REPORT_INTERVAL_CLICKABLE_HINT"),stretchable:true}];if(!c.Type.isArrayFilled(n.history)){return o}var s=n.history.filter(function(e){return e.dateLog===n.reportState.dateLog});var l=6e4;s.forEach(function(e){var a;if(n.personal.includes(e.privateCode)){a=r.EntityGroup.personal.value}else if(e.type===r.EntityType.custom){a=r.EntityGroup.workingCustom.value}else if(e.type===r.EntityType.absence){var o=n.entity.find(function(t){return t.privateCode===e.privateCode});var s=t.prototype.getCommentByEntity(n,o);a=s?r.EntityGroup.workingCustom.value:r.EntityGroup.working.value}else{a=r.EntityGroup.working.value}e.time.forEach(function(e){var t=new Date(e.start);var n=e.finish?new Date(e.finish):new Date;i.push({type:a,start:t,finish:n})})});if(!c.Type.isArrayFilled(i)){return o}i=i.sort(function(e,t){return e.start-t.start});var u=i[0].start;if(u.getHours()+u.getMinutes()>0){i.unshift({start:new Date(u.getFullYear(),u.getMonth(),u.getDate(),0,0),finish:u,type:r.EntityGroup.inactive.value})}i.forEach(function(e,t){if(t>0&&e.start-i[t-1].finish>=l*3){var n=i[t-1].finish;var a=e.start;n.setMinutes(n.getMinutes()+1);a.setMinutes(a.getMinutes()-1);i.push({start:n,finish:a,type:r.EntityGroup.inactive.value})}});i=i.sort(function(e,t){return e.start-t.start});var p=i[i.length-1].finish;if(p.getHours()+p.getMinutes()<82){p.setMinutes(p.getMinutes()+1);i.push({start:p,finish:new Date(p.getFullYear(),p.getMonth(),p.getDate(),23,59),type:r.EntityGroup.inactive.value})}i=i.filter(function(e){return e.finish-e.start>=l});var f=[];var y=null;i.forEach(function(e,t){if(t>0&&e.type!==r.EntityGroup.inactive.value){f[f.length-1].finish=e.start}if(e.type!==y){y=e.type;f.push({start:e.start,finish:e.finish,type:e.type,clickable:e.type===r.EntityGroup.inactive.value&&e.start<new Date,clickableHint:e.type===r.EntityGroup.inactive.value?c.Loc.getMessage("TIMEMAN_PWT_REPORT_INTERVAL_CLICKABLE_HINT"):""})}else if(e.type!==r.EntityGroup.inactive.value){f[f.length-1].finish=e.finish}});return f},getOverChartData:function e(n){return function(e){var i=[];var a=[];if(e===r.EntityGroup.other.value||e===r.EntityGroup.absence.value){a=n.entity.filter(function(e){if(!n.personal.includes(e.privateCode)){return e}}).map(function(e){var t=babelHelpers.objectSpread({},e,{time:f.calculateInEntityOnADate(n,e,n.reportState.dateLog)});if(t.type===r.EntityType.unknown){t.hint=r.EntityGroup.unknown.hint}return t}).filter(function(e){return e.time>0})}if(e===r.EntityGroup.other.value){var o=f.msToSec(n.config.otherTime);var s=a.sort(function(e,t){return e.time-t.time}).filter(function(e){if(n.strictlyWorking.includes(e.privateCode)||e.type===r.EntityType.absence){return false}if(o-e.time>=0){o-=e.time;return true}else{return false}});s.forEach(function(e){return i.push(e.privateCode)})}else if(e===r.EntityGroup.absence.value){var l=f.msToSec(n.config.shortAbsenceTime);var u=a.sort(function(e,t){return e.time-t.time}).filter(function(e){if(n.strictlyWorking.includes(e.privateCode)||e.type!==r.EntityType.absence){return false}if(t.prototype.getCommentByEntity(n,e).trim()===""){if(l-e.time>=0){l-=e.time;return true}return false}});u.forEach(function(e){return i.push(e.privateCode)})}else{i=[e]}var c=[];var p=BX.util.objectClone(n.history).filter(function(e){return e.dateLog===n.reportState.dateLog});var y=6e4;p.forEach(function(e){var t=n.personal.includes(e.privateCode)?r.EntityGroup.personal.value:r.EntityGroup.working.value;e.display=i.includes(e.privateCode)?"selected":"transparent";e.time.forEach(function(n){var i=new Date(n.start);var r=n.finish?new Date(n.finish):new Date;c.push({type:t,start:i,finish:r,display:e.display})})});c=c.sort(function(e,t){return e.start-t.start});var d=c[0].start;if(d.getHours()+d.getMinutes()>0){c.unshift({start:new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0),finish:d,type:r.EntityGroup.inactive.value,display:"transparent"})}c.forEach(function(e,t){if(t>0&&e.start-c[t-1].finish>=y*3){var n=c[t-1].finish;var i=e.start;n.setMinutes(n.getMinutes()+1);i.setMinutes(i.getMinutes()-1);c.push({start:n,finish:i,type:r.EntityGroup.inactive.value,display:"transparent"})}});c=c.sort(function(e,t){return e.start-t.start});var g=c[c.length-1].finish;if(g.getHours()+g.getMinutes()<82){g.setMinutes(g.getMinutes()+1);c.push({start:g,finish:new Date(g.getFullYear(),g.getMonth(),g.getDate(),23,59),type:r.EntityGroup.inactive.value,display:"transparent"})}return c}},isHistorySent:function e(n){var i=n.config.lastSuccessfulSendDate;var r=c.Type.isArrayFilled(n.history)&&new Date(n.history[0].dateLog)<new Date(t.prototype.getDateLog());if(!i){return!r}i=new Date(i);i.setHours(0);i.setMinutes(0);i.setSeconds(0);i.setMilliseconds(0);var a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a-i<=864e5||!r},getWorkingTimeForToday:function e(n){var i=n.entity.filter(function(e){if(!n.personal.includes(e.privateCode)){return e}});return i.map(function(e){return babelHelpers.objectSpread({},e,{time:f.calculateInEntityOnADate(n,e,t.prototype.getDateLog())})}).reduce(function(e,t){return e+t.time},0)},getReportComment:function e(t){var n=t.reportState.comments.find(function(e){return e.dateLog===t.reportState.dateLog});return n?n.text:""},hasActivityOtherThanBitrix24:function e(t){var n=false;var i=t.entity.filter(function(e){return e.type===r.EntityType.app||e.type===r.EntityType.site});if(c.Type.isArrayFilled(i)&&i.length>1){n=true}return n}}}},{key:"validatePersonal",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var n="";if(t&&(c.Type.isString(t)||c.Type.isNumber(t))){n=t.toString()}return n}},{key:"validateEntity",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n={};if(c.Type.isObject(t)&&t){if(c.Type.isString(t.type)){n.type=t.type}if(c.Type.isString(t.title)||c.Type.isNumber(t.title)){n.title=t.title.toString()}if(c.Type.isArrayFilled(t.comments)){n.comments=t.comments}}return n}},{key:"validateHistory",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n={};if(c.Type.isObject(t)&&t){if(c.Type.isString(t.dateLog)&&c.Type.isDate(new Date(t.dateLog))&&!isNaN(new Date(t.dateLog))){n.dateLog=t.dateLog}if(c.Type.isString(t.title)||c.Type.isNumber(t.title)){n.title=t.title.toString()}if(c.Type.isString(t.type)&&r.EntityType.hasOwnProperty(t.type)){n.type=t.type;if(t.type===r.EntityType.site){n.siteUrl=t.siteUrl;n.siteTitle=t.siteTitle.toString()}}if(c.Type.isArrayFilled(t.time)){n.time=t.time}}return n}},{key:"validateSentQueue",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n={};if(c.Type.isObject(t)&&t){if(c.Type.isString(t.dateLog)){n.dateLog=t.dateLog}if(c.Type.isArrayFilled(t.historyPackage)){n.historyPackage=t.historyPackage}if(c.Type.isArrayFilled(t.chartPackage)){n.chartPackage=t.chartPackage}if(c.Type.isString(t.desktopCode)){n.desktopCode=t.desktopCode}if(c.Type.isString(t.comment)){n.comment=t.comment}}return n}},{key:"getHistoryEntryByPrivateCode",value:function e(t,n){var i=this;return t.state.history.find(function(e){return e.privateCode===n&&e.dateLog===i.getDateLog()})}},{key:"getHistoryEntryBySiteUrl",value:function e(t,n){var i=this;return t.state.history.find(function(e){return e.siteUrl===n&&e.dateLog===i.getDateLog()})}},{key:"getEntityByPrivateCode",value:function e(t,n){return t.state.entity.find(function(e){return e.privateCode===n})}},{key:"getEntityByTitle",value:function e(t,n){return t.state.entity.find(function(e){return e.title===n})}},{key:"getCommentByEntity",value:function e(t,n){var i=n.comments.find(function(e){return e.dateLog===t.reportState.dateLog});return i?i.text:""}},{key:"getDateLog",value:function e(){return this.formatDateLog(new Date)}},{key:"formatDateLog",value:function e(t){var n=function e(t){return t>=0&&t<=9?"0"+t:t};var i=t.getFullYear();var r=n(t.getMonth()+1);var a=n(t.getDate());return i+"-"+r+"-"+a}},{key:"collectSentQueue",value:function e(t){var n=BX.util.objectClone(this.getGetters().getWorkingEntities(t.state));n=n.map(function(e){if(e.type===r.EntityType.group&&e.title===r.EntityGroup.other.title){e.type=r.EntityType.other;e.publicCode=p.createPublic(r.EntityType.other);e.privateCode=p.createPrivate(r.EntityType.other);delete e.items}else if(e.type===r.EntityType.group&&e.title===r.EntityGroup.absence.title){e.type=r.EntityType.absenceShort;e.publicCode=p.createPublic(r.EntityType.absenceShort);e.privateCode=p.createPrivate(r.EntityType.absenceShort);delete e.items}else if(e.type===r.EntityType.absence){if(e.extra.hasOwnProperty("timeStart")){e.timeStart=e.extra.timeStart}e.title=c.Loc.getMessage("TIMEMAN_PWT_REPORT_ABSENCE");e.publicCode=p.createPublic(r.EntityType.absence);e.privateCode=p.createPrivate(r.EntityType.absence)}delete e.extra;delete e.hint;return e});d.log("History to send:",n);h.space();h.log("History to send:",n);var i=this.getGetters().getChartData(t.state).map(function(e){return{type:e.type,start:e.start,finish:e.finish}});d.log("ChartData to send:",i);return{history:n,chart:i}}}]);return t}(t.VuexBuilderModel);var S=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);switch(t.type){case r.EntityType.site:this.createSite(t);break;case r.EntityType.app:this.createApp(t);break;case r.EntityType.absence:this.createAbsence();break;case r.EntityType.unknown:this.createUnknown(t);break;case r.EntityType.incognito:this.createIncognito();break}}babelHelpers.createClass(e,[{key:"createSite",value:function e(t){this.type=r.EntityType.site;var n;try{n=new URL(t.url).host}catch(e){n=t.url}if(n===""){var i=t.url.split("/");n=i[i.length-1]!==""?i[i.length-1]:t.url}else if(n.split(".")[0]==="www"){n=n.substring(4)}this.title=n.toString();this.siteUrl=t.url.toString();this.siteTitle=t.title.toString()}},{key:"createApp",value:function e(t){this.type=r.EntityType.app;this.title=t.name.toString();if(t.isBitrix24Desktop){this.isBitrix24Desktop=t.isBitrix24Desktop}}},{key:"createAbsence",value:function e(){this.type=r.EntityType.absence;this.title=c.Loc.getMessage("TIMEMAN_PWT_REPORT_ABSENCE")}},{key:"createUnknown",value:function e(t){this.type=r.EntityType.unknown;this.title=c.Loc.getMessage("TIMEMAN_PWT_REPORT_UNKNOWN");this.pureName=t.name;this.pureTitle=t.title}},{key:"createIncognito",value:function e(){this.type=r.EntityType.incognito;this.title=c.Loc.getMessage("TIMEMAN_PWT_REPORT_INCOGNITO")}}]);return e}();var E=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.enabled=false;this.store=t;this.preFinishInterval=null;this.lastCaught={name:null,url:null}}},{key:"catch",value:function e(t,n,i,a){if(!this.enabled||!t){return}v.start("CATCH_ENTITY");var o=this.getEntityTypeByEvent({process:t,name:n,title:i,url:a});var s=false;if(o===r.EntityType.app){if(["Bitrix24.exe","Bitrix24"].includes(this.getNameByProcess(t))){s=true}}if(o!==r.EntityType.absence){if(o===r.EntityType.app){switch(n){case"Application Frame Host":n=i;break;case"StartMenuExperienceHost":case"Search application":n=c.Loc.getMessage("TIMEMAN_PWT_WINDOWS_START_ALIAS");break;case"Windows Shell Experience Host":n=c.Loc.getMessage("TIMEMAN_PWT_WINDOWS_NOTIFICATIONS_ALIAS");break}}if(n===""){n=this.getNameByProcess(t)}if(!this.isNewEvent(n,a)){return}this.lastCaught={name:n,url:a}}this.store.dispatch("monitor/addHistory",new S({type:o,name:n,title:i,url:a,isBitrix24Desktop:s}))}},{key:"catchAbsence",value:function e(t){if(t){this.store.dispatch("monitor/addHistory",new S({type:r.EntityType.absence}));this.lastCaught={name:r.EntityType.absence,url:null}}else{if(this.isWorkingDayStarted()&&this.isTrackerGetActiveAppAvailable()){BXDesktopSystem.TrackerGetActiveApp()}}}},{key:"catchAppClose",value:function e(){d.warn("Application shutdown recognized. The last interval is finished.");h.log("Application shutdown recognized. The last interval is finished.");this.store.dispatch("monitor/finishLastInterval")}},{key:"getEntityTypeByEvent",value:function e(t){var n=r.EntityType.unknown;if(t.url==="unknown"){n=r.EntityType.unknown}else if(t.url==="incognito"){n=r.EntityType.incognito}else if(t.url){n=r.EntityType.site}else if(t.process!==""){n=r.EntityType.app}return n}},{key:"getNameByProcess",value:function e(t){var n=t.includes("/")?"/":"\\";var i=t.split(n);return i[i.length-1]}},{key:"isNewEvent",value:function e(t,n){if(this.url===""){if(this.lastCaught.name===t){return false}}else{if(this.lastCaught.name===t&&this.lastCaught.url===n){return false}}return true}},{key:"isTrackerGetActiveAppAvailable",value:function e(){return BX.desktop.getApiVersion()>=56}},{key:"start",value:function e(){var t=this;if(this.enabled){d.warn("EventHandler already started");return}this.enabled=true;BX.desktop.addCustomEvent("BXUserApp",function(e,n,i,r){return t.catch(e,n,i,r)});BX.desktop.addCustomEvent("BXExitApplication",this.catchAppClose.bind(this));if(this.isTrackerGetActiveAppAvailable()){BXDesktopSystem.TrackerGetActiveApp()}this.preFinishInterval=setInterval(function(){return t.store.dispatch("monitor/preFinishLastInterval")},6e4);d.log("EventHandler started")}},{key:"stop",value:function e(){if(!this.enabled){d.warn("EventHandler already stopped");return}this.enabled=false;this.lastCaught={name:null,url:null};this.preFinishInterval=null;this.store.dispatch("monitor/finishLastInterval");d.log("EventHandler stopped")}}]);return e}();var k=new E;var C=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.enabled=false;this.store=t;this.attempt=0;this.resendTimeout=5e3;this.resendTimeoutId=null}},{key:"send",value:function e(){var t=this;d.warn("Trying to send history...");BX.ajax.runAction("bitrix:timeman.api.monitor.recordhistory",{data:{history:JSON.stringify(this.getSentQueue())}}).then(function(e){h.log("History sent");if(e.status==="success"){d.warn("SUCCESS!");t.attempt=0;t.afterSuccessSend();if(e.data.enabled===H.getStatusDisabled()){d.warn("Disabled after server response");h.log("Disabled after server response");H.disable()}}else{d.error("ERROR!");t.attempt++;t.startSendingTimer()}}).catch(function(){d.error("CONNECTION ERROR!");t.attempt++;t.startSendingTimer()})}},{key:"startSendingTimer",value:function e(){this.resendTimeoutId=setTimeout(this.send.bind(this),this.getSendingDelay());d.log("Next send in ".concat(this.getSendingDelay()/1e3," seconds..."))}},{key:"getSendingDelay",value:function e(){return this.attempt===0?this.resendTimeout:this.resendTimeout*this.attempt}},{key:"getSentQueue",value:function e(){return this.store.state.monitor.sentQueue}},{key:"start",value:function e(){if(this.enabled){d.warn("Sender already started");return}this.enabled=true;this.attempt=0;if(c.Type.isArrayFilled(this.getSentQueue())){d.log("Preparing to send old history...");this.startSendingTimer()}d.log("Sender started")}},{key:"stop",value:function e(){if(!this.enabled){d.warn("Sender already stopped");return}this.enabled=false;this.attempt=0;clearTimeout(this.resendTimeoutId);d.log("Sender stopped")}},{key:"afterSuccessSend",value:function e(){var t=this;d.warn("History sent");h.space();h.log("History sent");this.store.dispatch("monitor/setLastSuccessfulSendDate",new Date(this.store.state.monitor.reportState.dateLog)).then(function(){t.store.dispatch("monitor/clearSentHistory").then(function(){t.store.dispatch("monitor/refreshDateLog");t.store.dispatch("monitor/clearSentQueue");BX.SidePanel.Instance.close();a.UI.Notification.Center.notify({content:c.Loc.getMessage("TIMEMAN_PWT_REPORT_NOTIFICATION_REPORT_SENT"),autoHideDelay:5e3})})})}}]);return e}();var w=new C;var D=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"timeman"}},{key:"handleChangeMonitorEnabled",value:function e(t){if(t.enabled===H.getStatusEnabled()){d.warn("Enabled via API");h.log("Enabled via API");location.reload()}else{H.stop();H.disable();d.warn("Disabled via API");h.log("Disabled via API")}}},{key:"handleChangeMonitorDebugEnabled",value:function e(t){if(t.enabled){h.enable();d.warn("Debug mode enabled via API");h.log("Debug mode enabled via API")}else{d.warn("Debug mode disabled via API");h.log("Debug mode disabled via API");h.disable()}}}]);return e}();var P=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.enabled=t.enabled;this.playTimeout=null;this.isAway=false;this.vuex={};this.defaultStorageConfig={config:{otherTime:t.otherTime,shortAbsenceTime:t.shortAbsenceTime}};this.dateFormat=t.dateFormat;this.timeFormat=t.timeFormat;if(t.debugEnabled){h.enable()}h.space();h.log("Desktop launched!");if(this.isEnabled()&&d.isEnabled()){BXDesktopSystem.LogInfo=function(){};d.start()}h.log("Enabled: ".concat(this.enabled));if(this.isEnabled()){this.initApp()}u.PULL.subscribe(new D)}},{key:"initApp",value:function e(){var n=this;if(!this.isEnabled()){return}(new t.VuexBuilder).addModel(T.create().setVariables(this.defaultStorageConfig).useDatabase(true)).setDatabaseConfig({name:"timeman-pwt",type:t.VuexBuilder.DatabaseType.indexedDb,siteId:c.Loc.getMessage("SITE_ID"),userId:c.Loc.getMessage("USER_ID")}).build().then(function(e){n.vuex.store=e.store;n.getStorage().dispatch("monitor/processUnfinishedEvents").then(function(){return n.initTracker(n.getStorage())})}).catch(function(){var e="PWT: Storage initialization error";d.error(e);h.log(e)})}},{key:"initTracker",value:function e(t){var n=this;s.DateFormatter.init(this.dateFormat);l.TimeFormatter.init(this.timeFormat);k.init(t);w.init(t);BX.desktop.addCustomEvent("BXUserAway",function(e){return n.onAway(e)});BX.MessengerWindow.addTab({id:"timeman-pwt",title:c.Loc.getMessage("TIMEMAN_PWT_REPORT_SLIDER_TITLE"),order:540,target:false,events:{open:function e(){return n.openReport()}}});BX.desktop.addCustomEvent("BXProtocolUrl",function(e){if(e==="timemanpwt"){if(!BX.MessengerCommon.isDesktop()){return false}BX.MessengerWindow.changeTab("timeman-pwt",true);BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}});if(this.isEnabled()){this.launch()}else{d.warn("Monitor is disabled")}}},{key:"launch",value:function e(){var t=this;if(this.isAway){d.log("Pause is over, but computer is in sleep mode. Waiting for the return of the user.");h.log("Pause is over, but computer is in sleep mode. Waiting for the return of the user.");return}if(!this.getStorage().state.monitor.config.grantingPermissionDate){d.log("History access not provided. Monitor is not started.");h.log("History access not provided. Monitor is not started.");if(this.shouldShowGrantingPermissionWindow()){this.openReport();BXDesktopWindow.ExecuteCommand("show.active")}return}this.getStorage().dispatch("monitor/migrateHistory").then(function(){t.getStorage().dispatch("monitor/clearSentHistory").then(function(){t.getStorage().dispatch("monitor/refreshDateLog").then(function(){if(t.isPaused()){if(t.isPauseRelevant()){d.warn("Can't start, monitor is paused!");h.log("Can't start, monitor is paused!");t.setPlayTimeout();return}t.clearPausedUntil().then(function(){return t.start()});return}t.start()})})})}},{key:"start",value:function e(){if(!this.isEnabled()){d.warn("Can't start, monitor is disabled!");h.log("Can't start, monitor is disabled!");return}if(this.isPaused()){d.warn("Can't start, monitor is paused!");h.log("Can't start, monitor is paused!");return}h.log("Monitor started");h.space();if(this.isTrackerEventsApiAvailable()){d.log("Events started");BXDesktopSystem.TrackerStart()}k.start();w.start();d.warn("Monitor started")}},{key:"stop",value:function e(){if(this.isTrackerEventsApiAvailable()){d.log("Events stopped");BXDesktopSystem.TrackerStop()}k.stop();w.stop();d.warn("Monitor stopped");h.log("Monitor stopped")}},{key:"pause",value:function e(){this.stop();this.setPlayTimeout()}},{key:"onAway",value:function e(t){if(!this.isEnabled()||this.isPaused()){return}if(t&&!this.isAway){this.isAway=true;d.warn("User AWAY");h.space();h.log("User AWAY");this.stop();k.catchAbsence(t)}else if(!t&&this.isAway){this.isAway=false;d.warn("User RETURNED, continue monitoring...");h.space();h.log("User RETURNED, continue monitoring...");this.launch()}}},{key:"send",value:function e(){if(!this.vuex.hasOwnProperty("store")){d.warn("Unable to send report. Store is not initialized.");h.log("Unable to send report. Store is not initialized.");return}this.getStorage().dispatch("monitor/createSentQueue").then(function(){return w.send()})}},{key:"openReport",value:function e(){if(!this.isEnabled()){return}o.MonitorReport.open(this.getStorage())}},{key:"openReportPreview",value:function e(){if(!this.isEnabled()){return}o.MonitorReport.openPreview(this.getStorage())}},{key:"getPausedUntilTime",value:function e(){return this.getStorage().state.monitor.config.pausedUntil}},{key:"clearPausedUntil",value:function e(){return this.getStorage().dispatch("monitor/clearPausedUntil")}},{key:"isPaused",value:function e(){return!!this.getPausedUntilTime()}},{key:"isPauseRelevant",value:function e(){return this.getPausedUntilTime()-new Date>0}},{key:"setPlayTimeout",value:function e(){var t=this;d.warn("Monitor will be turned on at ".concat(this.getPausedUntilTime().toString()));h.log("Monitor will be turned on at ".concat(this.getPausedUntilTime().toString()));clearTimeout(this.playTimeout);this.playTimeout=setTimeout(function(){return t.clearPausedUntil().then(function(){return t.launch()})},this.getPausedUntilTime()-new Date)}},{key:"pauseUntil",value:function e(t){var n=this;if(c.Type.isDate(t)&&c.Type.isNumber(t.getTime())&&t>new Date){this.getStorage().dispatch("monitor/setPausedUntil",t).then(function(){return n.pause()})}else{throw Error("Pause must be set as a date in the future")}}},{key:"shouldShowGrantingPermissionWindow",value:function e(){var t=this.getStorage().state.monitor.config;if(!t){return false}if(t.grantingPermissionDate!==null){return false}var n=t.deferredGrantingPermissionShowDate;if(n===null){return true}return new Date(T.prototype.getDateLog())>=new Date(n)}},{key:"showGrantingPermissionLater",value:function e(){return this.getStorage().dispatch("monitor/showGrantingPermissionLater")}},{key:"play",value:function e(){var t=this;clearTimeout(this.playTimeout);this.playTimeout=null;this.clearPausedUntil().then(function(){return t.launch()})}},{key:"isEnabled",value:function e(){return this.enabled===this.getStatusEnabled()}},{key:"enable",value:function e(){this.enabled=this.getStatusEnabled()}},{key:"disable",value:function e(){this.stop();BX.MessengerWindow.hideTab("timeman-pwt");this.vuex={};this.enabled=this.getStatusDisabled()}},{key:"getStatusEnabled",value:function e(){return"Y"}},{key:"getStatusDisabled",value:function e(){return"N"}},{key:"isTrackerEventsApiAvailable",value:function e(){return BX.desktop.getApiVersion()>=55}},{key:"getStorage",value:function e(){return this.vuex.hasOwnProperty("store")?this.vuex.store:null}}]);return e}();var H=new P;e.Monitor=H})(this.BX.Timeman=this.BX.Timeman||{},BX,BX,BX,BX.Timeman.Const,BX,BX.Timeman,BX.Timeman,BX.Timeman,BX,BX);
//# sourceMappingURL=monitor.bundle.map.js