this.BX=this.BX||{};(function(t,e,s,n){"use strict";var o=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.states={intermediate:0,running:1,completed:2,stopped:3,error:4};return t}babelHelpers.createClass(e,[{key:"isRunning",value:function t(){return this.state===this.states.running}},{key:"setRunning",value:function t(){this.state=this.states.running;this.emit("running")}},{key:"setIntermediate",value:function t(){this.state=this.states.intermediate;this.emit("intermediate")}},{key:"setStopped",value:function t(){this.state=this.states.stopped;this.emit("stopped")}},{key:"setCompleted",value:function t(){this.state=this.states.completed;this.emit("completed")}},{key:"setError",value:function t(){this.state=this.states.error;this.emit("error")}}]);return e}(s.Event.EventEmitter);function r(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="timeman-export-content-final-buttons">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);r=function e(){return t};return t}function i(){var t=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);i=function e(){return t};return t}function a(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="timeman-export-progress-bar-container">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);a=function e(){return t};return t}var p=function(){function t(e){babelHelpers.classCallCheck(this,t);e=babelHelpers.objectSpread({},{exportManager:null,exportState:null},e);this.exportManager=e.exportManager instanceof u?e.exportManager:null;this.exportState=e.exportState instanceof o?e.exportState:new o;this.popup=null;this.popupIsShown=false;this.popupContentId="timeman-export-popup-content";this.createProgressBar();this.subscribeToState()}babelHelpers.createClass(t,[{key:"createPopup",value:function t(){this.popup=e.PopupManager.create(s.Text.getRandom(),null,{autoHide:false,bindOptions:{forceBindPosition:false},buttons:this.getPopupButtons(),closeByEsc:false,closeIcon:false,content:this.getPopupContent(),draggable:true,events:{onPopupClose:this.onPopupClose.bind(this)},offsetLeft:0,offsetTop:0,titleBar:s.Loc.getMessage("TIMEMAN_EXPORT_POPUP_TITLE_EXCEL"),overlay:true})}},{key:"showPopup",value:function t(){if(this.popupIsShown||!this.popup){return}this.popup.adjustPosition();if(!this.popup.isShown()){this.popup.show()}this.popupIsShown=this.popup.isShown()}},{key:"adjustPosition",value:function t(){if(this.popup){this.popup.adjustPosition()}}},{key:"createProgressBar",value:function t(){var e=this;BX.loadExt("ui.progressbar").then(function(){e.progressBar=new BX.UI.ProgressBar({statusType:BX.UI.ProgressBar.Status.COUNTER,size:BX.UI.ProgressBar.Size.LARGE,fill:true});e.progressBarContainer=s.Tag.render(a(),e.progressBar.getContainer());e.progressBarHide()})}},{key:"subscribeToState",value:function t(){var e=this;this.exportState.subscribe("running",function(){e.hideCloseButton()}).subscribe("intermediate",function(){e.showCloseButton()}).subscribe("stopped",function(){e.showCloseButton()}).subscribe("completed",function(){e.showCloseButton();e.progressBarHide()}).subscribe("error",function(){e.showCloseButton();e.progressBarSetDanger()})}},{key:"showCloseButton",value:function t(){if(this.buttons["close"]!=="undefined"){this.buttons["close"].button.style.display=""}}},{key:"hideCloseButton",value:function t(){if(this.buttons["close"]!=="undefined"){this.buttons["close"].button.style.display="none"}}},{key:"progressBarShow",value:function t(){if(this.progressBarContainer){this.progressBarContainer.style.display=""}}},{key:"progressBarHide",value:function t(){if(this.progressBarContainer){this.progressBarContainer.style.display="none"}}},{key:"progressBarSetDanger",value:function t(){if(this.progressBar){this.progressBar.setColor(BX.UI.ProgressBar.Color.DANGER)}}},{key:"getPopupButtons",value:function t(){this.buttons={};this.buttons["close"]=new n.Button({text:s.Loc.getMessage("TIMEMAN_EXPORT_POPUP_CLOSE"),color:n.Button.Color.LINK,events:{click:this.handleCloseButtonClick.bind(this)}});return[this.buttons["close"]]}},{key:"getDownloadButton",value:function t(e,s){return new n.Button({text:e,color:n.Button.Color.SUCCESS,icon:n.Button.Icon.DOWNLOAD,tag:n.Button.Tag.LINK,link:s})}},{key:"getDeleteButton",value:function t(e){var s=this;return new n.Button({text:e,icon:n.Button.Icon.REMOVE,onclick:function t(e,n){s.exportManager.clearRequest()}})}},{key:"setPopupContent",value:function t(e){var s=document.getElementById(this.popupContentId);s.innerHTML=e["SUMMARY_HTML"];if(e["DOWNLOAD_LINK"]){s.appendChild(this.renderFinalButtons(e))}}},{key:"getPopupContent",value:function t(){this.popupContent='<div id="'.concat(this.popupContentId,'"></div>');return s.Tag.render(i(),this.popupContent,this.progressBarContainer)}},{key:"renderFinalButtons",value:function t(e){return s.Tag.render(r(),this.getDownloadButton(e["DOWNLOAD_LINK_NAME"],e["DOWNLOAD_LINK"]).render(),this.getDeleteButton(e["CLEAR_LINK_NAME"]).render())}},{key:"onPopupClose",value:function t(){if(this.popup){this.popup.destroy();this.popup=null}this.popupIsShown=false}},{key:"handleCloseButtonClick",value:function t(){if(this.popup&&!this.exportState.isRunning()){this.popup.close()}}},{key:"setProgressBar",value:function t(e,s){if(s){if(this.progressBar){this.progressBarShow();this.progressBar.setMaxValue(s);this.progressBar.update(e)}}else{this.progressBarHide()}}}]);return t}();var u=function(){function t(e){babelHelpers.classCallCheck(this,t);e=babelHelpers.objectSpread({},{signedParameters:"",componentName:"",siteId:"",stExportId:"",managerId:"",sToken:""},e);this.signedParameters=e.signedParameters;this.componentName=e.componentName;this.siteId=e.siteId;this.stExportId=e.stExportId;this.managerId=e.managerId;this.sToken=e.sToken;this.cToken="c";this.exportState=new o;this.exportPopup=new p({exportManager:this,exportState:this.exportState});this.availableTypes=["excel","csv"]}babelHelpers.createClass(t,[{key:"startExport",value:function t(e){if(!this.availableTypes.includes(e)){throw'Export: parameter "exportType" has invalid value'}this.exportType=e;this.exportPopup.createPopup();this.exportPopup.showPopup();this.startRequest()}},{key:"getExcelExportType",value:function t(){return"excel"}},{key:"getCsvExportType",value:function t(){return"csv"}},{key:"startRequest",value:function t(){this.cToken+=Date.now();this.request("timeman.api.export.dispatcher")}},{key:"nextRequest",value:function t(){this.request("timeman.api.export.dispatcher")}},{key:"stopRequest",value:function t(){this.request("timeman.api.export.cancel")}},{key:"clearRequest",value:function t(){this.request("timeman.api.export.clear")}},{key:"request",value:function t(e){var n=this;this.exportState.setRunning();s.ajax.runAction(e,{data:{SITE_ID:this.siteId,PROCESS_TOKEN:this.sToken+this.cToken,EXPORT_TYPE:this.exportType,COMPONENT_NAME:this.componentName,signedParameters:this.signedParameters}}).then(function(t){n.handleResponse(t)}).catch(function(t){n.handleResponse(t)})}},{key:"handleResponse",value:function t(e){var n=this;if(e.errors.length){this.exportPopup.setPopupContent(e.errors.shift().message);this.exportState.setError()}else if(e.status==="success"){var o=e.data;switch(o["STATUS"]){case"COMPLETED":case"NOT_REQUIRED":this.exportState.setCompleted();break;case"PROGRESS":var r=s.Type.isInteger(o["PROCESSED_ITEMS"])?o["PROCESSED_ITEMS"]:0;var i=s.Type.isInteger(o["TOTAL_ITEMS"])?o["TOTAL_ITEMS"]:0;this.exportPopup.setProgressBar(r,i);setTimeout(function(){return n.nextRequest()},200);break}this.exportPopup.setPopupContent(o)}else{this.exportState.setError()}this.exportPopup.adjustPosition()}}]);return t}();t.Export=u})(this.BX.Timeman=this.BX.Timeman||{},BX.Main,BX,BX.UI);
//# sourceMappingURL=export.bundle.map.js