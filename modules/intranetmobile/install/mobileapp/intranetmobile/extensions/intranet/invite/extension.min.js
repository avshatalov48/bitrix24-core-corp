jn.define("intranet/invite",((t,i,e)=>{const{Type:n}=t("type");const{Notify:r}=t("notify");const{Alert:s}=t("alert");const{IntranetInviteAnalytics:o}=t("intranet/invite/src/analytics");class a{constructor(t){this.inviteWidget=t.inviteWidget;this.originator=t.originator;this.disableAdminConfirm=t.disableAdminConfirm;this.registerUrl=t.registerUrl;this.adminConfirm=t.adminConfirm;this.onInviteSentHandler=t.onInviteSentHandler;this.rootStructureSectionId=t.rootStructureSectionId;this.analytics=t.analytics;this.onViewHiddenWithoutInvitingHandler=t.onViewHiddenWithoutInvitingHandler;this.invitedUsers=[];this.subscribeOnEvents()}subscribeOnEvents(){this.inviteWidget.on("onSendInvite",this.onSendInvite.bind(this));this.inviteWidget.on("onUpdateLink",this.onUpdateLink.bind(this));this.inviteWidget.on("onAdminConfirm",this.onAdminConfirm.bind(this));this.inviteWidget.on("onShareLink",this.onShareLink.bind(this));this.inviteWidget.on("onAllowContactListAccess",this.onAllowContactListAccess.bind(this));this.inviteWidget.on("onCopyLink",this.onCopyLink.bind(this));this.inviteWidget.on("onHelpInvite",this.onHelpInvite.bind(this));this.inviteWidget.on("onHelpLink",this.onHelpLink.bind(this));this.inviteWidget.on("onViewHidden",this.onViewHidden.bind(this))}onViewHidden(){if(this.onViewHiddenWithoutInvitingHandler&&this.invitedUsers.length===0){this.onViewHiddenWithoutInvitingHandler()}}onCopyLink(){this.analytics.sendCopyLinkEvent()}onAllowContactListAccess(){this.analytics.sendAllowContactsEvent()}getInvitePreparedParams(t){const i={validParams:true};if(!n.isObject(t)||!Array.isArray(t.recipients)){i.validParams=false;i.error=new Error("invalid params");return i}i.countryCodeList=[];i.phoneList=[];t.recipients.forEach(((t,e)=>{i.countryCodeList.push(t.countryCode);i.phoneList.push(t.phone)}));if(i.phoneList.length<=0){i.validParams=false;i.error=new Error("phoneList is empty");return i}return i}sendInvite(t){return new Promise(((i,e)=>{const{validParams:n,phoneList:o,countryCodeList:d,error:h}=this.getInvitePreparedParams(t);if(!n){e(h);return}const c=o.length>1;this.analytics.sendSelectFromContactListEvent(c);r.showIndicatorLoading();BX.ajax.runAction("intranet.invite.register",{data:{fields:{PHONE:o,PHONE_COUNTRY:d,DEPARTMENT_ID:this.rootStructureSectionId,CONTEXT:"mobile"}}}).then((t=>{const n=t?.data?.userIdList;const o=t.errors;if(o&&o.length>0){this.analytics.sendInvitationFailedEvent(c,n);r.hideCurrentIndicator();s.alert("",a.getAjaxErrorText(o));e(t)}else{this.analytics.sendInvitationSuccessEvent(n);r.showIndicatorSuccess({hideAfter:2e3});i(t)}})).catch((t=>{const i=t?.data?.userIdList;this.analytics.sendInvitationFailedEvent(c,i);r.hideCurrentIndicator();const n=t.errors;if(n&&n.length>0){s.alert("",a.getAjaxErrorText(n))}e(t)}))}))}onSendInvite(t){if(!n.isObject(t)||!Array.isArray(t.recipients)){return}this.sendInvite(t).then((i=>{if(t.recipients.length===i.data.userIdList.length&&t.recipients.length===i.data.convertedPhoneNumbers.length){this.invitedUsers=t.recipients.map(((t,e)=>({...t,id:i.data.userIdList[e],phone:i.data.convertedPhoneNumbers[e]})));this.inviteWidget.close((()=>{if(this.onInviteSentHandler){this.onInviteSentHandler(this.invitedUsers)}}))}else{console.error("Incorrect data in server response")}})).catch(console.error)}onShareLink(){this.analytics.sendShareLinkEvent(this.adminConfirm);BX.ajax.runAction("intranet.invite.copyRegisterUrl",{data:{}}).then((t=>{})).catch(console.error)}onHelpInvite(){Application.openHelpArticle("mh_invite_user","invite_user")}onHelpLink(){Application.openHelpArticle("mh_invite_user","copy_link")}onUpdateLink(){BX.ajax.runAction("intranet.invite.setRegisterSettings",{data:{params:{SECRET:Utils.getRandom(8)}}}).then((t=>{const i=t.data.errors;if(i&&i.length>0){r.showIndicatorError({hideAfter:1e4,onTap:r.hideCurrentIndicator,text:a.getAjaxErrorText(i)})}else{this.initRegisterUrl({callback:function(t){this.updateLink(t)}.bind(this.inviteWidget)})}})).catch((t=>{const i=t.errors;if(i&&i.length>0){r.showIndicatorError({hideAfter:2e3,text:a.getAjaxErrorText(i)})}}))}onAdminConfirm(t){if(this.disableAdminConfirm){this.inviteWidget.setAdminConfirm(!t);this.setAdminConfirm(!t);return}this.setAdminConfirm(t);BX.ajax.runAction("intranet.invite.setRegisterSettings",{data:{params:{CONFIRM:t?"Y":"N"}}}).then((i=>{const e=i.data.errors;if(e&&e.length>0||i.data.result!=="success"){this.inviteWidget.setAdminConfirm(!t);this.setAdminConfirm(!t)}else{this.inviteWidget.setAdminConfirm(t)}if(e&&e.length>0){r.showIndicatorError({hideAfter:1e4,onTap:r.hideCurrentIndicator,text:a.getAjaxErrorText(e)})}})).catch((i=>{this.inviteWidget.setAdminConfirm(!t);this.setAdminConfirm(!t);const e=i.errors;if(e&&e.length>0){r.showIndicatorError({hideAfter:2e3,text:a.getAjaxErrorText(e)})}}))}static getAjaxErrorText(t){return t.map((t=>{if(t.message){return t.message.replace("<br/>:","\n").replace("<br/>","\n")}return t.replace("<br/>:","\n").replace("<br/>","\n")})).filter((t=>t.length>0)).join("\n")}initRegisterUrl(t){BX.ajax.runAction("intranet.invite.getRegisterUrl",{data:{}}).then((i=>{if(i.status==="success"){this.setRegisterUrl(i.data.result);if(n.isObject(t)&&n.isFunction(t.callback)){t.callback(i.data.result)}}})).catch(console.error)}setRegisterUrl(t){if(n.isStringFilled(t)){this.registerUrl=t}}setAdminConfirm(t){if(n.isBoolean(t)){this.adminConfirm=t}}router(t,i){if(this.handlersList[t]){this.handlersList[t].apply(this,[i])}else if(this.debug){console.info(`IntranetInviteInterface.event.router: skipped event - ${t} ${JSON.stringify(i)}`)}}}e.exports={IntranetInvite:a,IntranetInviteAnalytics:o}}));
//# sourceMappingURL=extension.map.js