jn.define("intranet/user-mini-profile-form",((e,t,i)=>{const{Color:s,Indent:n,Corner:o}=e("tokens");const{IconView:a,Icon:r}=e("ui-system/blocks/icon");const{Loc:l}=e("loc");const{isEmpty:h}=e("utils/object");const{trim:d}=e("utils/string");const{PureComponent:u}=e("layout/pure-component");const{StringInput:E,InputSize:c,InputMode:m,InputDesign:I}=e("ui-system/form/inputs/string");const{EmailInput:p,InputDomainIconPlace:L}=e("ui-system/form/inputs/email");const{PhoneInput:g}=e("ui-system/form/inputs/phone");const{Avatar:N,AvatarEntityType:f,AvatarShape:F}=e("ui-system/blocks/avatar");const{AvatarPicker:P}=e("avatar-picker");const{isPhoneNumber:A}=e("utils/phone");const{isValidEmail:M}=e("utils/email");const{AvaMenu:O}=e("ava-menu");const{phoneUtils:_}=e("native/phonenumber");class R extends u{constructor(e){super(e);const{ID:t,NAME:i="",LAST_NAME:s="",PERSONAL_MOBILE:n="",EMAIL:o="",PERSONAL_PHOTO:a=""}=e.profileData;this.state.profileData={ID:t,NAME:i,LAST_NAME:s,PERSONAL_MOBILE:n,EMAIL:o};this.state.photo=a;this.nameField=null;this.lastNameField=null;this.phoneField=null;this.emailField=null;this.scrollToInput=e.scrollToInput;this.avatarPicker=new P;this.focusedInputIndex=0}componentDidMount(){this.inputs=[this.nameField,this.lastNameField,this.phoneField,this.emailField];this.nameField.focus()}getProfileData=()=>{const{profileData:e}=this.state;return e};getAvatarButton(){return View({style:{marginRight:n.XL3.toNumber()}},N({testId:"MINI_PROFILE_AVATAR",type:F.CIRCLE,accent:true,size:84,entityType:env.isCollaber?f.COLLAB:f.USER,uri:this.state.newPhoto??this.state.photo,onClick:this.showImagePicker,withRedux:true,icon:a({testId:"MINI_PROFILE_AVATAR_ICON",size:47,color:env.isCollaber?s.collabAccentPrimary:s.accentMainPrimary,icon:r.CAMERA}),backgroundColor:env.isCollaber?s.collabBgContent1:s.accentSoftBlue3}))}showImagePicker=()=>{this.avatarPicker.open().then((e=>{if(e){this.setState({newPhoto:e.previewUrl});const t=["avatar.png",e.base64];this.onChange("PERSONAL_PHOTO",t)}})).catch((e=>{console.error(e)}))};getInvalidField=e=>{const{PERSONAL_MOBILE:t,EMAIL:i}=e;if(!(h(t)||this.isEmptyPhoneBody(t))&&!A(t)){return this.phoneField}if(!h(i)&&!M(i)){return this.emailField}return null};isEmptyPhoneBody=e=>h(e?.replace(`+${_.getPhoneCode(e)}`,""));getEmptyRequiredField=e=>{const{PERSONAL_MOBILE:t,EMAIL:i}=e;const s=this.props.profileData.PERSONAL_MOBILE;const n=this.props.profileData.EMAIL;if(!h(s)&&(h(t)||this.isEmptyPhoneBody(t))){return this.phoneField}if(!h(n)&&h(i)){return this.emailField}return null};getFieldToFocus=()=>{for(let e=this.focusedInputIndex+1;e<this.inputs.length;e++){const t=this.inputs[e];if(t?.isEmpty()||t===this.phoneField&&this.isEmptyPhoneBody(t.getValue())){return this.inputs[e]}}return null};onContinue=()=>{const e=this.getFieldToFocus();if(e){e?.focus()}else{this.focusedInputIndex=-1;Keyboard.dismiss()}};submitForm(){const e=this.getProfileData();if(!e.ID){return Promise.reject(new Error("id is null"))}const t=this.getInvalidField(e)??this.getEmptyRequiredField(e);if(t){t?.focus();return Promise.reject(new Error("invalid data"))}if(this.isEmptyPhoneBody(e.PERSONAL_MOBILE)){e.PERSONAL_MOBILE=""}const i=BX.ajax.runAction("intranetmobile.userprofile.saveProfile",{data:{data:e}});i.then(this.#e()).catch((e=>{this.onHandleSubmitErrors(e.errors??[]);throw e}));return i}onHandleSubmitErrors(e){const t={WRONG_EMAIL:{emailFieldError:true},WRONG_PHONE:{phoneFieldError:true},EMAIL_EXIST:{emailFieldError:true,emailFieldErrorMessage:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_EMAIL_EXIST")}};const i=e.reduce(((e,i)=>{const s=t[i.code??null];if(s){return{...e,...s}}return e}),{});this.setState(i)}async#e(){return BX.ajax.runAction("mobile.AvaMenu.getUserInfo",{data:{reloadFromDb:true}}).then((({data:e})=>{O.setUserInfo(e)})).catch(console.error)}onChange=(e,t)=>{this.setState({profileData:{...this.getProfileData(),[e]:d(t)}})};onChangeName=e=>{this.onChange("NAME",e)};onChangeLastName=e=>{this.onChange("LAST_NAME",e)};onChangeMobile=e=>{this.onChange("PERSONAL_MOBILE",e)};onChangeEmail=e=>{this.onChange("EMAIL",e)};setBlurPrimaryField=()=>{this.setState({primaryFieldSelected:false})};getNameField(){const e="NAME";return E({size:c.L,mode:m.NAKED,ref:this.handleOnSetNameRef,testId:`USER_MINI_PROFILE_${e}`,showTitle:false,id:e,placeholder:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_PLACEHOLDER_NAME")??"",value:this.getProfileData().NAME??"",onFocus:this.focusNameField,onBlur:this.setBlurPrimaryField,onChange:this.onChangeName})}focusNameField=()=>{this.setState({primaryFieldSelected:true},(()=>{this.focusedInputIndex=this.inputs.indexOf(this.nameField)}))};handleOnSetNameRef=e=>{this.nameField=e};getLastNameField(){const e="LAST_NAME";return E({size:c.L,mode:m.NAKED,ref:this.handleOnSetLastNameRef,testId:`USER_MINI_PROFILE_${e}`,showTitle:false,id:e,placeholder:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_PLACEHOLDER_LAST_NAME")??"",value:this.getProfileData().LAST_NAME??"",onFocus:this.focusLastNameField,onBlur:this.setBlurPrimaryField,onChange:this.onChangeLastName})}focusLastNameField=()=>{this.setState({primaryFieldSelected:true},(()=>{this.focusedInputIndex=this.inputs.indexOf(this.lastNameField)}))};handleOnSetLastNameRef=e=>{this.lastNameField=e};getPhoneField(){const e="PERSONAL_MOBILE";return g({style:{marginBottom:n.M.toNumber()},validation:true,id:e,size:c.L,design:I.LIGHT_GREY,ref:this.handleOnSetPhoneRef,testId:`USER_MINI_PROFILE_${e}`,showTitle:false,placeholder:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_PLACEHOLDER_PHONE")??"",value:this.getProfileData().PERSONAL_MOBILE??"",onChange:this.onChangeMobile,onFocus:this.focusPhoneField,onValid:this.handleOnValidationPhone,errorText:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_WRONG_PHONE")??"",error:this.state.phoneFieldError??false})}focusPhoneField=()=>{this.setState({phoneFieldError:false},(()=>{this.focusedInputIndex=this.inputs.indexOf(this.phoneField)}))};handleOnValidationPhone=e=>h(e)||A(e);handleOnSetPhoneRef=e=>{this.phoneField=e};focusEmailField=()=>{this.setState({emailFieldErrorMessage:null,emailFieldError:false},(()=>{this.scrollToInput(this.emailField);this.focusedInputIndex=this.inputs.indexOf(this.emailField)}))};getEmailField(){const e="EMAIL";return p({style:{marginBottom:n.M.toNumber()},validation:true,size:c.L,design:I.LIGHT_GREY,ref:this.handleOnSetEmailRef,testId:`USER_MINI_PROFILE_${e}`,showTitle:false,id:e,placeholder:l.getMessage("INTRANETMOBILE_USER_MINI_PROFILE_PLACEHOLDER_EMAIL")??"",value:this.getProfileData().EMAIL??"",errorText:this.state.emailFieldErrorMessage,error:this.state.emailFieldError,onFocus:this.focusEmailField,onValid:this.handleOnValidationEmail,domainIconPlace:L.LEFT,leftContent:r.MAIL,onChange:this.onChangeEmail})}handleOnValidationEmail=e=>h(e)||M(e);handleOnSetEmailRef=e=>{this.emailField=e};getDivider(){return View({style:{height:1,backgroundColor:s.bgSeparatorPrimary.toHex()}})}render(){return View({style:{paddingHorizontal:n.XL2.toNumber()}},View({style:{display:"flex",flexDirection:"row"}},this.getAvatarButton(),View({style:{flexGrow:1,borderWidth:1,borderColor:this.state.primaryFieldSelected?s.accentMainPrimary.toHex():s.bgSeparatorPrimary.toHex(),borderRadius:o.L.toNumber(),marginBottom:n.XL4.toNumber(),paddingLeft:c.L.getInput()?.paddingHorizontal?.toNumber()??n.XL.toNumber()}},this.getNameField(),this.getDivider(),this.getLastNameField())),this.getPhoneField(),this.getEmailField())}}i.exports={UserMiniProfileForm:R}}));
//# sourceMappingURL=extension.map.js