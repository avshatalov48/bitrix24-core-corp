jn.define("disk/file-grid/base",((e,t,s)=>{const{Alert:i}=e("alert");const{Haptics:r}=e("haptics");const{Loc:o}=e("loc");const{Color:n}=e("tokens");const{Type:a}=e("type");const{isEqual:l,isEmpty:d}=e("utils/object");const{openNativeViewer:h,getNativeViewerMediaType:c,getExtension:g,getMimeType:u}=e("utils/file");const{qrauth:m}=e("qrauth/utils");const{showToast:p}=e("toast");const{Icon:f}=e("assets/icons");const{Box:F}=e("ui-system/layout/box");const{StatusBlock:I}=e("ui-system/blocks/status-block");const{LoadingScreenComponent:S}=e("layout/ui/loading-screen");const{AhaMoment:y}=e("ui-system/popups/aha-moment");const{SearchLayout:C}=e("layout/ui/search-bar");const{TypeGenerator:R}=e("layout/ui/stateful-list/type-generator");const{StatefulList:b}=e("layout/ui/stateful-list");const{DiskPull:T,createCommandExistsMiddleware:L,createCommandAllowedMiddleware:A,createResolveObjectIdMiddleware:E,createResolveActionTypeMiddleware:B,createAddObjectsOnlyFromCurrentFolderMiddleware:P,createUpdateObjectsOnlyFromCurrentFolderMiddleware:w,createUpdateObjectsOnlyFromCurrentStatefulListMiddleware:k}=e("disk/pull");const{ListItemType:M,ListItemsFactory:v}=e("disk/simple-list/items");const{usersUpserted:D,usersAdded:O}=e("statemanager/redux/slices/users");const{batchActions:_}=e("statemanager/redux/batched-actions");const U=e("statemanager/redux/store");const{dispatch:x}=U;const{filesAddedFromServer:N,filesUpsertedFromServer:W}=e("disk/statemanager/redux/slices/files");const{storagesAdded:G,storagesUpserted:j}=e("disk/statemanager/redux/slices/storages");const{observeListChange:V}=e("disk/statemanager/redux/slices/files/observers/stateful-list");const{selectById:$,selectEntities:K,selectRightsById:H}=e("disk/statemanager/redux/slices/files/selector");const{FolderContextType:q,FileType:J}=e("disk/enum");const{FileGridMoreMenu:z,FileGridSorting:X,FileGridFilter:Y}=e("disk/file-grid/navigation");const{CreateFolderDialog:Q}=e("disk/dialogs/create-folder");const{DiskUploader:Z}=e("disk/uploader");class ee extends LayoutComponent{constructor(e){super(e);this.storage=null;this.parentWidget=this.props.parentWidget??PageManager;this.stateFulListRef=null;this.floatingButtonPointerRef=null;this.markAsRemovedFiles=new Set;this.tabReadyEventEmitted=false;this.forcedGlobalSearch=false;this.breadcrumbs=Array.isArray(this.props.breadcrumbs)?this.props.breadcrumbs:[];if(this.props.folderId){this.breadcrumbs.push(this.props.folderId)}this.state={loading:true,folderId:this.props.folderId??null,isASC:false,sortingType:X.types.UPDATE_TIME};this.searchFilter=new Y;this.search=new C({layout:this.parentWidget,id:"file-grid",cacheId:`disk:file-grid.${env.userId}`,disablePresets:true,presetId:this.searchFilter.getPresetId(),searchDataAction:"diskmobile.Filter.getSearchBarPresets",searchDataActionParams:{},onSearch:this.onSearch,onCancel:this.onSearchCancel,getDefaultPresetId:()=>this.searchFilter.getDefaultPreset()});this.sorting=new X({type:X.types.UPDATE_TIME,isASC:this.state.isASC});this.state.folderRights=this.getFolderId()?H(U.getState(),this.getFolderId()):{};this.moreMenu=new z(this.sorting.getType(),this.sorting.getIsASC(),{onSelectSorting:this.onSelectSorting,onToggleOrder:this.onToggleOrder,onCreateFolder:this.canUserUploadToFolder()?this.onFloatingButtonLongClick:undefined,onOpenTrashcan:this.onOpenTrashcan});if(this.state.folderRights){this.moreMenu.setCanCreateFolder(this.state.folderRights.canAdd)}}componentDidMount(){this.fetchStorage();this.unsubscribeFilesObserver=V(U,this.onVisibleFilesChange)}componentWillUnmount(){if(this.unsubscribeFilesObserver){this.unsubscribeFilesObserver()}if(this.moreMenu.unsubscribe){this.moreMenu.unsubscribe()}}getId(){return""}getTestId(e){const t=this.getId();return e?`${t}_${e}`:t}getCacheId(){return`disk:file-grid.${this.getId()}.${env.userId}.${this.getFolderId()}`}fetchStorage(){}onStorageLoaded(e,t){if(this.handleStorageLoadFailure(e,t)){return}this.storage=e.data.storage;x(j([this.storage]));const s=this.getFolderId()??e.data.storage.rootObjectId;const i=d(this.state.folderRights)?e.data.rootFolderRights:this.state.folderRights;if(i){this.moreMenu.setCanCreateFolder(i.canAdd)}this.setState({loading:false,folderId:s,folderRights:i},(()=>{if(!this.tabReadyEventEmitted){this.tabReadyEventEmitted=true;BX.postComponentEvent("disk.tabs:onTabReady",[this.getId()],"disk.tabs");this.onTabReady()}}))}handleStorageLoadFailure(e,t){if(e.errors.length>0){if(!t){i.alert(o.getMessage("M_DISK_STORAGE_LOAD_ERROR_TITLE"),o.getMessage("M_DISK_STORAGE_LOAD_ERROR_TEXT"),(()=>{this.props.onStorageLoadFailure?.(e,this)}),o.getMessage("M_DISK_COMMON_ERROR_OK"))}return true}return false}onTabReady(){}getFolderId(){return this.state.folderId}getStorageId(){return this.storage?.id||null}isLoading(){return this.state.loading}isReady(){return!this.isLoading()}isSearching(){return!this.searchFilter.isEmpty()}isRootFolder(){const e=this.getFolderId();const t=this.storage?.rootObjectId;if(e&&t){return e===t}return true}isCollabFolder(){const e=$(U.getState(),this.getFolderId());return e?.folderContextType===q.COLLAB}showFolders(){return true}isShowFloatingButton(){return true}isFloatingButtonAccent(){}displayFloatingButtonAhaMoment({description:e,onHide:t,delay:s=0}){setTimeout((()=>{if(this.floatingButtonPointerRef){y.show({description:e,testId:this.getTestId("floating-button-aha-moment"),targetRef:this.floatingButtonPointerRef,closeButton:false,fadeInDuration:300,onHide:t})}}),s)}showStorageName(){return false}setSorting(e){if(this.sorting.getType()!==e){this.sorting.setType(e);this.moreMenu.setSelectedSorting(e);this.setState({sortingType:e},this.reload)}}setOrder(e){this.sorting.setIsASC(e);this.setState({isASC:e},this.reload)}getListActions(){return{loadItems:"diskmobile.Folder.getChildren"}}getListActionParams(){return{loadItems:{id:this.getFolderId(),search:this.getSearchParams().searchString,searchContext:this.getSearchContext(),sortingType:this.state.sortingType,order:{[this.state.sortingType]:this.state.isASC?"ASC":"DESC"},context:this.props.context||{storageId:this.getStorageId()},showRights:true}}}getSearchContext(){return null}forceGlobalSearch(){this.forcedGlobalSearch=true;this.forceReload()}render(){return F({backgroundColor:n.bgPrimary,resizableByKeyboard:true},View({style:{flex:1}},this.isLoading()&&this.renderLoadingScreen(),this.isReady()&&this.renderList(),this.renderFloatingButtonPointer()))}renderLoadingScreen(){return new S({showAirStyle:true})}renderList(){return new b({testId:"disk-list",cacheName:this.getCacheId(),layout:this.parentWidget,typeGenerator:{generator:R.generators.bySelectedProperties,properties:["name"],callbacks:{}},showAirStyle:true,menuButtons:this.getLayoutMenuButtons(),onPanListHandler:this.onPanList,onListReloaded:this.onListReloaded,ref:this.onListRef,sortingConfig:this.sorting.getSortingConfig(),itemType:M.FILE,itemFactory:v,actions:this.getListActions(),actionParams:this.getListActionParams(),actionCallbacks:{loadItems:this.onItemsLoaded},pull:{moduleId:"disk",callback:this.onPullCallback,shouldReloadDynamically:true},onBeforeItemsRender:this.onBeforeItemsRender,onBeforeItemsSetState:this.onBeforeItemsSetState,isShowFloatingButton:this.isShowFloatingButton(),isFloatingButtonAccent:this.isFloatingButtonAccent(),onFloatingButtonClick:this.onFloatingButtonClick,onFloatingButtonLongClick:this.onFloatingButtonLongClick,itemDetailOpenHandler:this.onItemPress,needInitMenu:true,getEmptyListComponent:this.getEmptyListComponent})}renderFloatingButtonPointer(){return View({style:{height:1,width:1,opacity:0,position:"absolute",bottom:75,right:52},ref:e=>{this.floatingButtonPointerRef=e}})}onSelectSorting=e=>{this.setSorting(e)};onToggleOrder=e=>{this.setOrder(e)};onOpenTrashcan=()=>{m.open({redirectUrl:this.getTrashWebUrl(),showHint:true,title:o.getMessage("M_DISK_FILE_GRID_TRASHCAN_TITLE"),layout:this.parentWidget,analyticsSection:"files"}).catch((e=>console.error(e)))};getTrashWebUrl(){return`${env.siteDir}${env.extranet?"contacts":"company"}/personal/user/${env.userId}/disk/trashcan/`}onPanList=()=>{this.search.close()};onListRef=e=>{if(e){this.stateFulListRef=e}};onSearch=({text:e,presetId:t})=>{this.searchFilter.setPresetId(t);this.searchFilter.setSearchString(e);this.setState({},this.reload)};onSearchCancel=({text:e,presetId:t})=>{this.searchFilter.setPresetId(t);this.searchFilter.setSearchString(e);if(this.forcedGlobalSearch){this.forcedGlobalSearch=false;this.forceReload()}else{this.setState({},this.reload)}};getSearchParams(){return{presetId:this.searchFilter.getPresetId(),searchString:this.searchFilter.getSearchString()}}getLayoutMenuButtons(){return[this.search.getSearchButton(),this.moreMenu.getMenuButton()]}onItemsLoaded=(e,t)=>{const{items:s,users:i,storages:r,currentFolderRights:o}=e||{};const n=t==="cache";const a=[];if(s&&s.length>0){a.push(n?N(s):W(s))}if(i&&i.length>0){a.push(n?O(i):D(i))}if(r&&r.length>0){a.push(n?G(r):j(r))}if(a.length>0){x(_(a))}if(!this.state?.folderRights||!d(o)&&!l(this.state.folderRights,o)){this.setState({folderRights:o});this.moreMenu.setCanCreateFolder(this.state.folderRights?.canAdd)}};getItemIds(){return(this.stateFulListRef?.getItems()??[]).map((e=>e.id))}getAllowedPullCommands(){return[T.Command.OBJECT_ADDED,T.Command.OBJECT_RENAMED,T.Command.CONTENT_UPDATED,T.Command.OBJECT_MARK_DELETED]}getPullCommandProcessors(){return[]}onPullCallback=e=>{const t=this.getAllowedPullCommands();const s=[...this.getPullCommandProcessors(),L(),A(t),E(),B(),P(this.getFolderId())];if(this.getFolderId()){s.push(w(this.getFolderId()))}else{s.push(k(this.getItemIds()))}return s.reduce(((e,t)=>e.then((e=>t(e)))),Promise.resolve(e)).then((e=>{const{objectId:t,actionType:s}=e;return{params:{eventName:s,items:[{id:t}]}}}))};onBeforeItemsSetState=(e,t)=>{const s=K(U.getState());e.map((e=>{const t=e;if(typeof t.updateTime==="string"){t.updateTime=new Date(e.updateTime).getTime()/1e3}if(typeof t.createTime==="string"){t.createTime=new Date(e.createTime).getTime()/1e3}return t}));return e.filter((({id:e})=>{const{isRemoved:t}=s[e]||{};return a.isNil(t)||!t}))};onBeforeItemsRender=e=>e.map(((t,s)=>({...t,showBorder:s!==e.length-1,order:{[this.state.sortingType]:this.state.isASC?"ASC":"DESC"},context:{storageId:this.getStorageId()},parentWidget:this.parentWidget,showStorageName:this.showStorageName()})));onItemPress=e=>{const t=$(U.getState(),e);if(t.isFolder){this.openFolder(t);return}if(t.typeFile===J.IMAGE){h({fileType:"image",url:t.links.download,name:t.name,images:this.getImagesForNativeViewer(t.id)});return}h({fileType:c(u(g(t.name),t.name)),url:t.links.download,name:t.name})};getImagesForNativeViewer(e){const t=this.stateFulListRef?.getItems().filter((e=>e.typeFile===J.IMAGE));return t.map((t=>({url:t.links.download,default:t.id===e})))}onListReloaded=e=>{if(!e){this.markAsRemovedFiles?.clear()}};openFolder=e=>{const{parentWidget:t,groupId:s}=this.props;if(t){t.openWidget("layout",{title:e.name,onReady:t=>{t.showComponent(new this.constructor({storageId:this.getStorageId(),folderId:e.id,parentWidget:t,breadcrumbs:[...this.breadcrumbs],groupId:s}))},onError:e=>console.error(e)})}};getEmptyListComponent=()=>{const{imageUri:e,title:t,description:s,buttons:i}=this.getEmptyListComponentProps();const r={resizeMode:"contain",style:{width:339,height:162},svg:{uri:e}};return I({title:t,description:s,buttons:i,emptyScreen:true,image:Image(r),onRefresh:this.onEmptyScreenPullToRefresh,testId:this.getTestId("EmptyScreen")})};getEmptyListComponentProps=()=>{};onEmptyScreenPullToRefresh=()=>{this.reload()};onFloatingButtonClick=()=>{if(this.ensureUserCanUploadToFolder()){this.openUploaderDialog()}};onFloatingButtonLongClick=()=>{if(this.ensureUserCanUploadToFolder()){this.openCreateFolderDialog()}};canUserUploadToFolder(){const e=this.currentUserIsCollaber()&&!this.isCollabFolder();const t=this.state.folderRights?.canAdd===false;if(e||t){return false}return true}ensureUserCanUploadToFolder(){if(!this.canUserUploadToFolder()){r.notifyWarning();p({message:o.getMessage("M_DISK_UPLOAD_IS_POSSIBLE_ONLY_TO_COLLAB_DIR"),iconName:f.FOLDER_SUCCESS.getIconName()},this.parentWidget);return false}return true}currentUserIsCollaber(){return env.isCollaber}openCreateFolderDialog=()=>{void Q.open({parentFolderId:this.getFolderId(),onCreate:()=>{this.sendCreateFolderAnalytics();this.reload()}},this.parentWidget)};openUploaderDialog=()=>{Z.open({onCommit:e=>{this.sendUploadFileAnalytics(e);this.reload()},folderId:this.getFolderId(),storageId:this.getStorageId(),layoutWidget:this.parentWidget})};reload=()=>{this.stateFulListRef?.reload()};forceReload=()=>{const e={skipItems:true,force:true,actionParams:this.getListActionParams(),menuButtons:this.getLayoutMenuButtons()};const t={useCache:false};this.stateFulListRef?.reload(e,t)};onVisibleFilesChange=({moved:e,removed:t,added:s,created:i})=>{if(!this.stateFulListRef||this.stateFulListRef.isLoading()){setTimeout((()=>{this.onVisibleFilesChange({moved:e,removed:t,added:s,created:i})}),30);return}const r=e=>e.filter((({parentId:e})=>e===this.getFolderId()));const o=e=>e.filter((({typeFile:e})=>{if(!this.showFolders()){return Boolean(e)}return true}));if(t.length>0){void this.removeFiles(t)}if(s.length>0){void this.addOrRestoreFiles(r(o(s)))}if(e.length>0){void this.updateFiles(r(o(e)))}if(i.length>0){void this.replaceFiles(i)}};removeFiles(e){if(e.length>0){const t=e.map((({id:e})=>e));const s=e.filter((e=>e.isRemoved)).map((({id:e})=>e));if(s.length>0){s.forEach((e=>this.markAsRemovedFiles.add(e)))}return this.stateFulListRef.deleteItem(t)}return Promise.resolve()}async addOrRestoreFiles(e){const t=[];const s=[];e.forEach((e=>{if(this.markAsRemovedFiles.has(e.id)){t.push(e)}else if(!this.stateFulListRef.hasItem(e.id)){s.push(e)}}));if(t.length>0){await this.stateFulListRef.updateItemsData(t)}if(s.length>0){await this.stateFulListRef.updateItemsData(s)}e.forEach((({id:e})=>this.markAsRemovedFiles.delete(e)))}updateFiles(e){return setTimeout((()=>this.stateFulListRef.updateItemsData(e)),500)}replaceFiles(e){}sendCreateFolderAnalytics(){}sendUploadFileAnalytics(e){}}s.exports={BaseFileGrid:ee}}));
//# sourceMappingURL=extension.map.js