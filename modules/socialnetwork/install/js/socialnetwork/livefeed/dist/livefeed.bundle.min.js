this.BX=this.BX||{};(function(e,t,n,a){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;this.initPanel();this.initPosts();this.initEvents();n.EventEmitter.subscribe("onFrameDataProcessed",function(){t.initPanel();t.initPosts()})}},{key:"initPanel",value:function e(){var i=this.getPanelNode();if(!i){return}t.Event.bind(i,"click",function(e){var i=e.target.classList.contains("feed-inform-ilike")||e.target.closest(".feed-inform-ilike")!==null;var s=e.target.classList.contains("feed-inform-follow")||e.target.closest(".feed-inform-follow")!==null;var o=e.target.classList.contains("feed-post-more-link")||e.target.closest(".feed-post-more-link")!==null||e.target.classList.contains("feed-post-right-top-menu");var r=e.target.classList.contains("feed-inform-contentview")||e.target.closest(".feed-inform-contentview")!==null;var l=e.target.classList.contains("feed-post-pin")||e.target.closest(".feed-post-pin")!==null;var d=e.target.classList.contains("feed-post-pinned-link-collapse");var c=e.target.classList.contains("feed-inform-comments-pinned")||e.target.closest(".feed-inform-comments-pinned")!==null;var u=null;if(e.target.classList.contains("feed-post-block")){u=e.target}else{u=e.target.closest(".feed-post-block")}if(!u){return}if(u.classList.contains("feed-post-block-pinned")){if(!i&&!s&&!o&&!r&&!l){u.classList.remove("feed-post-block-pinned");var f=u.getAttribute("data-menu-id");if(f){a.MenuManager.destroy(f)}var v=new n.BaseEvent({compatData:[{rootNode:u}],data:{rootNode:u}});n.EventEmitter.emit("BX.Livefeed:recalculateComments",v)}if(c){var p=u.querySelector(".feed-comments-block a[name=comments]");if(p){var m=t.Dom.getPosition(p);window.scrollTo(0,m.top-200)}}e.stopPropagation();e.preventDefault()}else if(d){u.classList.add("feed-post-block-pinned");e.stopPropagation();e.preventDefault()}})}},{key:"initPosts",value:function e(){var n=this;var a=document.querySelectorAll("[data-livefeed-post-pinned]");a.forEach(function(e){t.Event.bind(e,"click",function(e){if(!e.target.classList.contains("feed-post-pin")){return}var t=e.target.closest("[data-livefeed-id]");if(!t){return}var a=t.getAttribute("data-livefeed-post-pinned")==="Y"?"N":"Y";var i=parseInt(t.getAttribute("data-livefeed-id"));if(i<=0){return}n.changePinned({logId:i,newState:a,event:e})})})}},{key:"initEvents",value:function e(){var a=this;n.EventEmitter.subscribe("OnUCCommentWasRead",function(e){var n=e.getData(),i=babelHelpers.slicedToArray(n,3),s=i[0],o=i[1],r=i[2];var l=a.getCommentsData(s),d=l.oldValue,c=l.newValue;if(!!r.new){a.setCommentsData(s,{newValue:t.Type.isInteger(c)?c-1:0,oldValue:t.Type.isInteger(d)?d+1:1})}});n.EventEmitter.subscribe("OnUCCommentWasPulled",function(e){var n=e.getData(),i=babelHelpers.slicedToArray(n,3),s=i[0],o=i[1],r=i[2];var l=babelHelpers.slicedToArray(s,2),d=l[0],c=l[1];var u=a.getCommentsData(d),f=u.newValue,v=u.oldValue,p=u.follow;if(parseInt(r.AUTHOR.ID)!==parseInt(BX.message("USER_ID"))&&p){a.setCommentsData(d,{newValue:t.Type.isInteger(f)?f+1:1})}else{a.setCommentsData(d,{oldValue:t.Type.isInteger(v)?v+1:1})}});n.EventEmitter.subscribe("OnUCommentWasDeleted",function(e){var n=e.getData(),i=babelHelpers.slicedToArray(n,3),s=i[0],o=i[1],r=i[2];var l=a.getCommentsData(s),d=l.oldValue;a.setCommentsData(s,{oldValue:t.Type.isInteger(d)?d-1:0})})}},{key:"changePinned",value:function e(n){var a=this;var i=n.logId?parseInt(n.logId):0;var s=n.node?n.node:null;var o=n.event?n.event:null;var r=n.newState?n.newState:null;if(!i||!r){return}this.setPostState({node:s?s:o.target,state:r});t.ajax.runAction("socialnetwork.api.livefeed.logentry."+(r==="Y"?"pin":"unpin"),{data:{params:{logId:i}},analyticsLabel:{b24statAction:r==="Y"?"pinLivefeedEntry":"unpinLivefeedEntry"}}).then(function(e){if(!e.data.success){a.setPostState({node:s?s:o.target,state:r==="Y"?"N":"Y"})}else{a.movePost({node:s?s:o.target,state:r})}},function(e){a.setPostState({node:s?s:o.target,state:r==="Y"?"N":"Y"})})}},{key:"setPostState",value:function e(t){var n=t.state?t.state:null;var a=t.node?t.node:null;if(!a||!["Y","N"].includes(n)){return}var i=a.closest("[data-livefeed-post-pinned]");if(!i){return}i.setAttribute("data-livefeed-post-pinned",n);i.classList.remove("feed-post-block-pin-active");i.classList.remove("feed-post-block-pin-inactive");if(n==="Y"){i.classList.add("feed-post-block-pin-active",n)}else{i.classList.add("feed-post-block-pin-inactive",n)}}},{key:"getPanelNode",value:function e(){return document.querySelector("[data-livefeed-pinned-panel]")}},{key:"getPinnedData",value:function e(n){var a=n.logId?parseInt(n.logId):0;if(a<=0){return Promise.reject()}return new Promise(function(e,n){t.ajax.runAction("socialnetwork.api.livefeed.logentry.getPinData",{data:{params:{logId:a}}}).then(function(t){e(t.data)},function(e){n()})})}},{key:"movePost",value:function e(n){var a=n.state?n.state:null;var i=n.node?n.node:null;if(!i||!["Y","N"].includes(a)){return}var s=i.closest("[data-livefeed-post-pinned]");if(!s){return}var o=parseInt(s.getAttribute("data-livefeed-id"));if(!o){return}var r=this.getPanelNode();if(!r){return}var l=s.parentNode.classList.contains("feed-item-wrap")?s.parentNode:s;if(a==="Y"){this.getPinnedData({logId:o}).then(function(e){var n=s.querySelector(".feed-post-pinned-title");var a=s.querySelector(".feed-post-pinned-desc");var i=s.querySelector(".feed-post-pin");if(n){n.innerHTML=e.TITLE}if(a){a.innerHTML=e.DESCRIPTION}if(i){i.title=t.Loc.getMessage("SONET_EXT_LIVEFEED_PIN_TITLE_Y")}s.classList.add("feed-post-block-pinned");r.insertBefore(l,r.firstChild)})}else{s.classList.remove("feed-post-block-pinned");r.parentNode.insertBefore(l,r.nextSibling)}}},{key:"getCommentsNodes",value:function e(n){var a={follow:true,newNode:null,oldNode:null};if(!t.Type.isStringFilled(n)){return a}var i=document.querySelector('.feed-comments-block[data-bx-comments-entity-xml-id="'.concat(n,'"]'));if(!i){return a}var s=i.closest(".feed-post-block-pin-active");if(!s){return a}var o=s.querySelector(".feed-inform-comments-pinned-new");var r=s.querySelector(".feed-inform-comments-pinned-old");if(!o||!r){return a}a.newNode=o;a.oldNode=r;a.follow=i.getAttribute("data-bx-follow")!=="N";return a}},{key:"getCommentsData",value:function e(n){var a={newValue:null,oldValue:null};if(!t.Type.isStringFilled(n)){return a}var i=this.getCommentsNodes(n),s=i.newNode,o=i.oldNode,r=i.follow;a.follow=r;if(!t.Type.isDomNode(s)||!t.Type.isDomNode(o)){return a}var l=0;var d=0;var c=s.innerHTML.match(/\+(\d+)/);if(c){l=parseInt(c[1])}c=o.innerHTML.match(/(\d+)/);if(c){d=parseInt(c[1])}a.oldValue=d;a.newValue=l;return a}},{key:"setCommentsData",value:function e(n,a){if(!t.Type.isStringFilled(n)){return}var i=this.getCommentsNodes(n),s=i.newNode,o=i.oldNode;if(!t.Type.isDomNode(s)||!t.Type.isDomNode(o)){return}if(t.Type.isInteger(a.newValue)){s.innerHTML="+".concat(a.newValue);if(a.newValue>0&&!s.classList.contains("feed-inform-comments-pinned-new-active")){s.classList.add("feed-inform-comments-pinned-new-active")}else if(a.newValue<=0&&s.classList.contains("feed-inform-comments-pinned-new-active")){s.classList.remove("feed-inform-comments-pinned-new-active")}}if(t.Type.isInteger(a.oldValue)){o.innerHTML=a.oldValue}}}]);return e}();var s=function(){function e(){babelHelpers.classCallCheck(this,e);this.init();this.entryData={}}babelHelpers.createClass(e,[{key:"init",value:function e(){}},{key:"changeFavorites",value:function e(n){var a=this;var i=n.logId?parseInt(n.logId):0;var s=n.event?n.event:null;var o=n.node?n.node:null;var r=n.newState?n.newState:null;if(t.Type.isStringFilled(o)){o=document.getElementById(o)}if(!i){return}var l=null;if(s){l=s.target;if(!l.classList.contains("menu-popup-item-text")){l=l.querySelector(".menu-popup-item-text")}}var d=null;if(t.Type.isDomNode(o)){d=o.classList.contains("feed-post-important-switch")?o:o.querySelector(".feed-post-important-switch")}if(typeof this.entryData[i]=="undefined"){this.entryData[i]={}}if(typeof this.entryData[i].favorites!="undefined"){r=this.entryData[i].favorites?"N":"Y";this.entryData[i].favorites=!this.entryData[i].favorites}else if(d){r=d.classList.contains("feed-post-important-switch-active")?"N":"Y";this.entryData[i].favorites=r=="Y"}if(!r){return}this.adjustFavoritesControlItem(d,r);this.adjustFavoritesMenuItem(l,r);t.ajax.runAction("socialnetwork.api.livefeed.changeFavorites",{data:{logId:i,value:r},analyticsLabel:{b24statAction:r=="Y"?"addFavorites":"removeFavorites"}}).then(function(e){if(t.Type.isStringFilled(e.data.newValue)&&["Y","N"].includes(e.data.newValue)){a.entryData[i].favorites=e.data.newValue=="Y"}a.adjustFavoritesControlItem(d,e.data.newValue);a.adjustFavoritesMenuItem(l,e.data.newValue)},function(e){a.entryData[i].favorites=!a.entryData[i].favorites})}},{key:"adjustFavoritesMenuItem",value:function e(n,a){if(!t.Type.isDomNode(n)||!["Y","N"].includes(a)){return}n.innerHTML=this.getMenuTitle(a==="Y")}},{key:"adjustFavoritesControlItem",value:function e(n,a){if(!t.Type.isDomNode(n)||!["Y","N"].includes(a)){return}n.title=this.getMenuTitle(a==="Y");if(a=="Y"){n.classList.add("feed-post-important-switch-active")}else{n.classList.remove("feed-post-important-switch-active")}}},{key:"getMenuTitle",value:function e(n){return t.Loc.getMessage("SONET_EXT_LIVEFEED_MENU_TITLE_FAVORITES_".concat(n?"Y":"N"))}}]);return e}();e.FeedInstance=null;e.PinnedPanelInstance=null;t.Event.ready(function(){e.FeedInstance=new s;e.PinnedPanelInstance=new i})})(this.BX.Livefeed=this.BX.Livefeed||{},BX,BX.Event,BX.Main);
//# sourceMappingURL=livefeed.bundle.map.js