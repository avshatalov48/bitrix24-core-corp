this.BX=this.BX||{};this.BX.Socialnetwork=this.BX.Socialnetwork||{};(function(e,t,r,i,s,n){"use strict";var a=function(){function e(t){babelHelpers.classCallCheck(this,e);this.filterId=t.filterId;this.filterManager=BX.Main.filterManager.getById(this.filterId);this.countersManager=t.countersManager;setTimeout(this.updateFields.bind(this),100)}babelHelpers.createClass(e,[{key:"updateFields",value:function e(){var t=this.getFilter();if(!t){return}this.presetId=t.getPreset().getCurrentPresetId();this.fields=t.getFilterFieldsValues();this.countersManager.activateCountersByFilter()}},{key:"isFilteredByPresetId",value:function e(t){return t===this.presetId}},{key:"isFilteredByFields",value:function e(t){var r=this;var i=false;var n=false;Object.entries(t).map((function(e){var t=babelHelpers.slicedToArray(e,2),a=t[0],l=t[1];if(!n&&!s.Type.isUndefined(r.fields[a])){i=r.fields[a]===l;if(!i){n=true}}}));return i}},{key:"getFilter",value:function e(){return this.filterManager}}]);return e}();var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.targetUserId=t.targetUserId;this.entityType=t.entityType||"";this.entityId=parseInt(t.entityId||0);this.role=t.role;this.entityTitle=t.entityTitle||"";this.counters=t.counters;this.renderTo=t.renderTo;this.signedParameters=t.signedParameters;this.initialCounter=t.initialCounter||"";this.panel=null;this.tasksCounter={};this.bindEvents();this.setData(this.counters);this.initPull();this.filter=new a({filterId:t.filterId,countersManager:this})}babelHelpers.createClass(e,[{key:"isWorkgroupList",value:function e(){return false}},{key:"initPull",value:function e(){var r=this;t.PULL.subscribe({moduleId:"main",callback:function e(t){return r.processPullEvent(t)}});t.PULL.subscribe({moduleId:"socialnetwork",callback:function e(t){return r.processPullEvent(t)}});t.PULL.subscribe({moduleId:"tasks",callback:function e(t){return r.processPullEvent(t)}})}},{key:"extendWatch",value:function e(){var t=this;if(this.isWorkgroupList()){var r="WORKGROUP_LIST";BX.PULL.extendWatch(r,true);setTimeout((function(){return t.extendWatch()}),29*60*1e3)}}},{key:"processPullEvent",value:function e(t){var r={user_counter:this.onUserCounter.bind(this)};var i=Object.prototype.hasOwnProperty;var s=t.command,n=t.params;if(i.call(r,s)){var a=r[s];if(a){a.apply(this,[n])}}}},{key:"bindEvents",value:function e(){n.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this))}},{key:"onFilterApply",value:function e(){this.filter.updateFields()}},{key:"activateCountersByFilter",value:function e(){var t=this;if(!this.panel){return}this.counterItems.forEach((function(e){if(s.Type.isObject(e.filterFields)){t.filter.isFilteredByFields(e.filterFields)?t.panel.getItemById(e.type).activate():t.panel.getItemById(e.type).deactivate()}else if(s.Type.isStringFilled(e.filterPresetId)){t.filter.isFilteredByPresetId(e.filterPresetId)?t.panel.getItemById(e.type).activate():t.panel.getItemById(e.type).deactivate()}}))}},{key:"onUserCounter",value:function e(t){var r=this;var i=Object.prototype.hasOwnProperty;if(this.entityType==="workgroup_detail"){if(!i.call(t,"workgroupId")||!i.call(t,"values")||this.entityId!==parseInt(t.workgroupId)||this.userId!==Number(t.userId)){return}Object.entries(t.values).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],s=t[1];r.counterItems.forEach((function(e){if(e.type===i){var t=r.panel.getItemById(e.type);t.updateValue(s.all);var n="GRAY";switch(i){case"workgroup_requests_in":n="WARNING";break;case"workgroup_requests_out":n="SUCCESS";break}t.updateColor(s.all>0?n:"GRAY")}}))}))}else if(this.entityType==="workgroup_list"){if(s.Type.isPlainObject(t[s.Loc.getMessage("SITE_ID")])&&!s.Type.isUndefined(t[s.Loc.getMessage("SITE_ID")]["**SG0"])){this.counterItems.forEach((function(e){if(e.type==="workgroup_list_livefeed"){var i=r.panel.getItemById(e.type);var n=Number(t[s.Loc.getMessage("SITE_ID")]["**SG0"]);i.updateValue(n);i.updateColor(n>0?"DANGER":"GRAY")}}))}else if(!s.Type.isUndefined(t.projects_major)||!s.Type.isUndefined(t.scrum_total_comments)){if(!s.Type.isUndefined(t.projects_major)){this.tasksCounter.projects_major=Number(t.projects_major)}if(!s.Type.isUndefined(t.scrum_total_comments)){this.tasksCounter.scrum_total_comments=Number(t.scrum_total_comments)}this.counterItems.forEach((function(e){if(e.type==="workgroup_list_tasks"){var t=0;Object.entries(r.tasksCounter).map((function(e){var i=babelHelpers.slicedToArray(e,1),s=i[0];t+=r.tasksCounter[s]}));var i=r.panel.getItemById(e.type);i.updateValue(t);i.updateColor(t>0?"DANGER":"GRAY")}}))}}}},{key:"getCounterItem",value:function e(t){var r={type:t.type,activeByDefault:t.type===this.initialCounter,filter:this.filter};if(s.Type.isObject(t.filterFields)){var i=Object.entries(t.filterFields).pop(),a=babelHelpers.slicedToArray(i,2),l=a[0],o=a[1];r.filterField=l;r.filterValue=o}else if(s.Type.isStringFilled(t.filterPresetId)){r.filterPresetId=t.filterPresetId}return{id:t.type,title:t.name,value:t.count,color:t.color,eventsForActive:{click:function e(){n.EventEmitter.emit("Socialnetwork.Toolbar:onItem",{counter:r})},mouseenter:function e(){},anyEvent:function e(){}},eventsForUnActive:{click:function e(){n.EventEmitter.emit("Socialnetwork.Toolbar:onItem",{counter:r})}}}}},{key:"setData",value:function e(t){var r=this;this.counterItems=[];Object.entries(t).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],s=t[1];r.counterItems.push({type:i,name:s.TITLE,count:r.getCounterSum(s.VALUE),color:s.STYLE,filterPresetId:s.FILTER_PRESET_ID,filterFields:s.FILTER_FIELDS})}))}},{key:"getCounterSum",value:function e(t){var r=0;Object.entries(t).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[1];r+=Number(i)}));return r}},{key:"render",value:function e(){var t=this;this.panel=new r.CounterPanel({target:this.renderTo,multiselect:true,items:this.counterItems.map((function(e){return t.getCounterItem(e)}))});this.panel.init()}}]);return e}();babelHelpers.defineProperty(l,"updateTimeout",false);babelHelpers.defineProperty(l,"needUpdate",false);babelHelpers.defineProperty(l,"timeoutTTL",5e3);e.Counters=l})(this.BX.Socialnetwork.Interface=this.BX.Socialnetwork.Interface||{},BX,BX.UI,BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js