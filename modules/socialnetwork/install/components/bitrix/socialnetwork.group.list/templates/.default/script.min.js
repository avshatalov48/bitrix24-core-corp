this.BX=this.BX||{};this.BX.Socialnetwork=this.BX.Socialnetwork||{};(function(exports,socialnetwork_ui_grid,tasks_tour,main_core_events,main_popup,ui_buttons,socialnetwork_common,pull_client,main_core){"use strict";var _templateObject;var ActionManager=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t.parent;this.componentName=main_core.Type.isStringFilled(this.parent.componentName)?this.parent.componentName:"";this.signedParameters=main_core.Type.isStringFilled(this.parent.signedParameters)?this.parent.signedParameters:"";this.gridId=main_core.Type.isStringFilled(this.parent.gridId)?this.parent.gridId:"";this.useSlider=main_core.Type.isBoolean(this.parent.useSlider)?this.parent.useSlider:false}babelHelpers.createClass(e,[{key:"act",value:function e(t,r){var n=this;if(r){r.stopPropagation();r.preventDefault()}return new Promise((function(e,r){if(["addToFavorites","removeFromFavorites"].includes(t.action)){return n.setFavorites({groupId:t.groupId,value:t.action==="addToFavorites"}).then((function(e){n.processActionSuccess(t)}),(function(e){n.processActionFailure(t,e.message)}))}else{return main_core.ajax.runComponentAction(n.componentName,"act",{mode:"class",signedParameters:n.signedParameters,data:{action:t.action,fields:{groupId:t.groupId}}}).then((function(r){if(r.data.success){n.processActionSuccess(t)}else{n.processActionFailure(t)}e(r)}),(function(e){if(e.errors){n.processActionFailure(t,e.errors[0].message)}r(e)}))}}))}},{key:"processActionSuccess",value:function e(t){var r=null;var n="";switch(t.action){case"addToFavorites":n=main_core.Loc.getMessage("SGL_GROUP_ACTION_SUCCESS_NOTIFICATION_ADD_TO_FAVORITES");break;case"removeFromFavorites":n=main_core.Loc.getMessage("SGL_GROUP_ACTION_SUCCESS_NOTIFICATION_REMOVE_FROM_FAVORITES");break;case"addToArchive":n=main_core.Loc.getMessage("SGL_GROUP_ACTION_SUCCESS_NOTIFICATION_ADD_TO_ARCHIVE");break;case"removeFromArchive":n=main_core.Loc.getMessage("SGL_GROUP_ACTION_SUCCESS_NOTIFICATION_REMOVE_FROM_ARCHIVE");break;case"join":r="afterJoinRequestSend";break;case"setOwner":r="afterOwnerSet";break;case"setScrumMaster":r="afterSetScrumMaster";break;case"deleteOutgoingRequest":r="afterRequestOutDelete";break;case"deleteIncomingRequest":r="afterRequestInDelete";break;default:}if(n!==""){BX.UI.Notification.Center.notify({content:n})}if(r&&top.BX.SidePanel&&window!==top.window){top.BX.SidePanel.Instance.postMessageAll(window,"sonetGroupEvent",{code:r})}if(!BX.PULL){this.parent.reload()}}},{key:"processActionFailure",value:function e(t,r){if(!main_core.Type.isStringFilled(r)){r=main_core.Loc.getMessage("SOCIALNETWORK_GROUP_LIST_ACTION_FAILURE")}BX.UI.Notification.Center.notify({content:r})}},{key:"setFavorites",value:function e(t){var r=this;var n=t.value;var i=!t.value;return new Promise((function(e,o){socialnetwork_common.Common.setFavoritesAjax({groupId:t.groupId,favoritesValue:i,callback:{success:function t(i){var o={code:"afterSetFavorites",data:{groupId:i.ID,value:i.RESULT==="Y"}};window.top.BX.SidePanel.Instance.postMessageAll(window,"sonetGroupEvent",o);if(main_core.Type.isStringFilled(i.NAME)&&main_core.Type.isStringFilled(i.URL)){main_core_events.EventEmitter.emit("BX.Socialnetwork.WorkgroupFavorites:onSet",new main_core_events.BaseEvent({compatData:[{id:r.groupId,name:i.NAME,url:i.URL,extranet:main_core.Type.isStringFilled(i.EXTRANET)?i.EXTRANET:"N"},n]}))}e()},failure:function e(t){o({message:t.ERROR})}}})}))}},{key:"groupAction",value:function e(t){var r=this;var n="";switch(t){case"addToArchive":n=main_core.Loc.getMessage("SOCIALNETWORK_GROUP_LIST_GROUP_ACTION_BUTTON_ADD");break;case"removeFromArchive":n=main_core.Loc.getMessage("SOCIALNETWORK_GROUP_LIST_GROUP_ACTION_BUTTON_RETURN");break;case"delete":n=main_core.Loc.getMessage("SOCIALNETWORK_GROUP_LIST_GROUP_ACTION_BUTTON_DELETE");break;default:t=""}if(t===""){return}var i=[new ui_buttons.SendButton({text:n,events:{click:function e(){main_popup.PopupManager.getCurrentPopup().destroy();var n=BX.Main.gridManager.getInstanceById(r.gridId);if(!n){return}var i={ID:n.getRows().getSelectedIds(),apply_filter:"Y"};i[n.getActionKey()]=t;i[n.getForAllKey()]="N";n.reloadTable("POST",i)}}}),new ui_buttons.CancelButton({events:{click:function e(){main_popup.PopupManager.getCurrentPopup().destroy()}}})];var o=main_popup.PopupManager.create({id:"bx-sgl-group-delete-confirm",autoHide:false,closeByEsc:true,buttons:i,events:{onPopupClose:function e(t){t.destroy()}},content:main_core.Tag.render(_templateObject||(_templateObject=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),main_core.Loc.getMessage("SOCIALNETWORK_GROUP_LIST_GROUP_ACTION_CONFIRM_TEXT")),padding:20});o.show()}}]);return e}();var UserCounterManager=function(){function UserCounterManager(e){babelHelpers.classCallCheck(this,UserCounterManager);this.gridController=e.gridController;this.url=e.url;this.columnId=e.columnId;this.sliderOptions=e.sliderOptions;this.useTasksCounters=e.useTasksCounters;this.timer=null;this.queueCounterData=new Map}babelHelpers.createClass(UserCounterManager,[{key:"processCounterItem",value:function e(t,r){var n=this;if(this.useTasksCounters){return}if(r===0&&Number(t.value)===0){this.gridController.getInstance().getRows().getRows().forEach((function(e){if(!main_core.Type.isUndefined(t.scrum)&&t.scrum!==e.getNode().getAttribute("data-scrum")){return}n.setRowCounter(e,t,r)}));return}if(!this.gridController.getInstance().isRowExist(r)){return}this.setRowCounter(this.gridController.getInstance().getRowById(r),t,r)}},{key:"setRowCounter",value:function setRowCounter(targetRow,counterData,groupId){var rowCounterData={};var url=this.url.replace("#id#",groupId).replace("#ID#",groupId).replace("#GROUP_ID#",groupId).replace("#group_id#",groupId);rowCounterData[this.columnId]={value:0,type:"right",events:groupId>0?{click:BX.SidePanel.Instance.open.bind(BX.SidePanel.Instance,url,this.sliderOptions)}:{},color:"ui-counter-danger",class:"sonet-ui-grid-counter"};var storedCounterData={};try{eval("storedCounterData = ".concat(targetRow.getNode().getAttribute("data-counters"),";"))}catch(e){}if(storedCounterData===null||counterData.type==="tasks_expired"&&targetRow.getNode().getAttribute("data-scrum")==="Y"){return}var sumValue=0;Object.entries(storedCounterData).forEach((function(e){var t=babelHelpers.slicedToArray(e,1),r=t[0];if(r===counterData.type){storedCounterData[r]=counterData.value.toString()}sumValue+=Number(storedCounterData[r])}));targetRow.getNode().setAttribute("data-counters","(".concat(JSON.stringify(storedCounterData),")"));rowCounterData[this.columnId].value=Number(sumValue);targetRow.setCounters(rowCounterData)}}]);return UserCounterManager}();var PullControllerSocialnetwork=function(){babelHelpers.createClass(e,null,[{key:"getInstance",value:function e(){}},{key:"events",get:function e(){return{add:"add",update:"update",delete:"delete",userAdd:"userAdd",userUpdate:"userUpdate",userDelete:"userDelete",favoritesChanged:"favoritesChanged",pinChanged:"pinChanged"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.gridController=t.gridController;this.pullController=t.pullController;this.gridPinController=this.gridController.getInstance().getPinController();this.grid=this.gridController.getGrid()}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"socialnetwork"}},{key:"getMap",value:function e(){var t;return t={},babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_ADD"),this.onWorkgroupAdd.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_UPDATE"),this.onWorkgroupUpdate.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_DELETE"),this.onWorkgroupDelete.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_USER_ADD"),this.onWorkgroupUserAdd.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_USER_UPDATE"),this.onWorkgroupUserUpdate.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_USER_DELETE"),this.onWorkgroupUserDelete.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_FAVORITES_CHANGED"),this.onWorkgroupFavoritesChanged.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_WORKGROUP_PIN_CHANGED"),this.onWorkgroupPinChanged.bind(this)),t}},{key:"onWorkgroupAdd",value:function t(r){var n=this;var i={event:e.events.add,moveParams:{rowBefore:this.gridPinController.getLastPinnedRowId(),rowAfter:this.gridController.getInstance().getFirstRowId()}};this.pullController.checkExistence(r.params.GROUP_ID).then((function(e){return n.pullController.onCheckExistenceSuccess(e,r.params.GROUP_ID,i)}),(function(e){return console.error(e)}))}},{key:"onWorkgroupUpdate",value:function t(r){var n=this;var i={event:e.events.update};this.pullController.checkExistence(r.params.GROUP_ID).then((function(e){return n.pullController.onCheckExistenceSuccess(e,r.params.GROUP_ID,i)}),(function(e){return console.error(e)}))}},{key:"onWorkgroupDelete",value:function e(t){this.pullController.removeRow(t.params.GROUP_ID)}},{key:"onWorkgroupUserAdd",value:function t(r){var n=this;var i={event:e.events.userAdd};this.pullController.checkExistence(r.params.GROUP_ID).then((function(e){return n.pullController.onCheckExistenceSuccess(e,r.params.GROUP_ID,i)}),(function(e){return console.error(e)}))}},{key:"onWorkgroupUserUpdate",value:function t(r){var n=this;var i={event:e.events.userUpdate};this.pullController.checkExistence(r.params.GROUP_ID).then((function(e){return n.pullController.onCheckExistenceSuccess(e,r.params.GROUP_ID,i)}),(function(e){return console.error(e)}))}},{key:"onWorkgroupUserDelete",value:function t(r){var n=this;var i={event:e.events.userDelete};this.pullController.checkExistence(r.params.GROUP_ID).then((function(e){return n.pullController.onCheckExistenceSuccess(e,r.params.GROUP_ID,i)}),(function(e){return console.error(e)}))}},{key:"onWorkgroupFavoritesChanged",value:function t(r){var n={event:e.events.favoritesChanged};this.pullController.moveToDirectPlace(r.GROUP_ID,null,n)}},{key:"onWorkgroupPinChanged",value:function t(r){if(!main_core.Type.isStringFilled(r.ACTION)||!["pin","unpin"].includes(r.ACTION)){return}var n={event:e.events.pinChanged};this.pullController.moveToDirectPlace(r.GROUP_ID,null,n)}}]);return e}();var PullControllerMainUserCounter=function(){function e(t){babelHelpers.classCallCheck(this,e);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.userCounterManager=t.userCounterManager;this.timer=null;this.queueCounterData=new Map}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"main"}},{key:"getMap",value:function e(){return babelHelpers.defineProperty({},main_core.Loc.getMessage("PUSH_EVENT_MAIN_USER_COUNTER"),this.onUserCounter.bind(this))}},{key:"onUserCounter",value:function e(t){var r=this;var n=main_core.Loc.getMessage("SITE_ID");var i=main_core.Type.isPlainObject(t[n])?t[n]:{};if(!this.timer){this.timer=setTimeout((function(){r.freeCounterQueue()}),1e3)}Object.entries(i).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],i=t[1];var o=n.match(/^\*\*SG(\d+)/i);if(o){var s=Number(o[1]);i=Number(i);if(s===0&&i!==0){return}var a={type:"livefeed",value:i};r.queueCounterData.set(s,a)}}))}},{key:"freeCounterQueue",value:function e(){this.queueCounterData.forEach((function(e,t){}));this.queueCounterData.clear();this.timer=null}}]);return e}();var PullControllerTasks=function(){babelHelpers.createClass(e,null,[{key:"events",get:function e(){return{pinChanged:"pinChanged"}}},{key:"counterEvents",get:function e(){return["onAfterTaskAdd","onAfterTaskDelete","onAfterTaskRestore","onAfterTaskView","onAfterTaskMute","onAfterCommentAdd","onAfterCommentDelete","onProjectPermUpdate"]}},{key:"movingProjectEvents",get:function e(){return["onAfterTaskAdd","onAfterCommentAdd"]}}]);function e(t){babelHelpers.classCallCheck(this,e);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.gridController=t.gridController;this.pullController=t.pullController;this.gridPinController=this.gridController.getInstance().getPinController();this.grid=this.gridController.getGrid();this.timer=null;this.counterData=new Map}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"tasks"}},{key:"getMap",value:function e(){var t;return t={},babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_PROJECT_COUNTER"),this.onTasksProjectCounter.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_PROJECT_READ_ALL"),this.onTasksProjectCommentsReadAll.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_SCRUM_READ_ALL"),this.onTasksProjectCommentsReadAll.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_COMMENT_READ_ALL"),this.onTasksProjectCommentsReadAll.bind(this)),t}},{key:"onTasksProjectCounter",value:function t(r){var n=this;var i=r.GROUP_ID;var o=r.EVENT;if(!e.counterEvents.includes(o)){return}if(!this.timer){this.timer=setTimeout((function(){n.freeCounterQueue()}),1e3)}if(e.movingProjectEvents.includes(o)||!this.counterData.has(i)){this.counterData.set(i,o)}}},{key:"freeCounterQueue",value:function t(){var r=this;this.counterData.forEach((function(t,n){var i={event:t,highlightParams:{skip:true},updateItemCondition:function t(r){return e.movingProjectEvents.includes(r)}};if(e.movingProjectEvents.includes(t)){i.moveParams={rowBefore:r.gridPinController.getIsPinned(n)?0:r.gridPinController.getLastPinnedRowId(),rowAfter:r.gridController.getInstance().getFirstRowId()};i.highlightParams={skip:false}}r.pullController.checkExistence(n).then((function(e){return r.pullController.onCheckExistenceSuccess(e,n,i)}),(function(e){return console.error(e)}))}));this.counterData.clear();this.timer=null}},{key:"onTasksProjectCommentsReadAll",value:function e(t){var r=t.GROUP_ID;if(r){if(this.gridController.getInstance().isRowExist(r)){this.updateCounter([r])}}else{this.updateCounter(this.gridController.getInstance().getItems())}}},{key:"updateCounter",value:function e(t){var r=this;this.pullController.checkExistence(t).then((function(e){var t=e.data;if(t){Object.keys(t).forEach((function(e){if(r.gridController.getInstance().isRowExist(e)){r.gridController.getInstance().getRowById(e).setCounters(t[e].counters)}}))}}),(function(e){return console.error(e)}))}}]);return e}();var PullControllerTasksUserCounter=function(){function e(t){babelHelpers.classCallCheck(this,e);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.gridController=t.gridController;this.pullController=t.pullController;this.gridPinController=this.gridController.getInstance().getPinController();this.grid=this.gridController.getGrid();this.userCounterManager=t.userCounterManager;this.timer=null;this.queueCounterData=new Map}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"tasks"}},{key:"getMap",value:function e(){var t;return t={},babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_USER_COUNTER"),this.onUserCounter.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_PROJECT_READ_ALL"),this.onProjectReadAllComments.bind(this)),babelHelpers.defineProperty(t,main_core.Loc.getMessage("PUSH_EVENT_TASKS_SCRUM_READ_ALL"),this.onScrumReadAllComments.bind(this)),t}},{key:"onUserCounter",value:function e(t){var r=this;if(!this.timer){this.timer=setTimeout((function(){r.freeCounterQueue()}),1e3)}Object.entries(t).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],i=t[1];if(n==Number(n)&&Number(n)>0&&main_core.Type.isPlainObject(i.view_all)){if(!main_core.Type.isUndefined(i.view_all.new_comments)){r.queueCounterData.set("".concat(n,"_new_comments"),{groupId:n,type:"tasks_new_comments",value:Number(i.view_all.new_comments)})}if(!main_core.Type.isUndefined(i.view_all.expired)){r.queueCounterData.set("".concat(n,"_expired"),{groupId:n,type:"tasks_expired",value:Number(i.view_all.expired)})}}}))}},{key:"onProjectReadAllComments",value:function e(t){var r=this;if(Number(t.GROUP_ID)!==0&&Number(t.USER_ID)!==Number(main_core.Loc.getMessage("USER_ID"))){return}if(!this.timer){this.timer=setTimeout((function(){r.freeCounterQueue()}),1e3)}this.queueCounterData.set("0_new_comments",{groupId:0,type:"tasks_new_comments",value:0,scrum:"N"})}},{key:"onScrumReadAllComments",value:function e(t){var r=this;if(Number(t.GROUP_ID)!==0&&Number(t.USER_ID)!==Number(main_core.Loc.getMessage("USER_ID"))){return}if(!this.timer){this.timer=setTimeout((function(){r.freeCounterQueue()}),1e3)}this.queueCounterData.set("0_new_comments",{groupId:0,type:"tasks_new_comments",value:0,scrum:"Y"})}},{key:"freeCounterQueue",value:function e(){this.queueCounterData.forEach((function(e){}));this.queueCounterData.clear();this.timer=null}}]);return e}();var PullManager=function(){function e(t){babelHelpers.classCallCheck(this,e);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.urls=t.urls;this.useTasksCounters=t.useTasksCounters;this.livefeedCounterColumnId=t.livefeedCounterColumnId;this.livefeedCounterSliderOptions=t.livefeedCounterSliderOptions;this.gridController=t.gridController;this.grid=this.gridController.getGrid();this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){this.userCounterManagerInstance=new UserCounterManager({gridController:this.gridController,url:this.urls.groupLivefeedUrl,columnId:this.livefeedCounterColumnId,sliderOptions:this.livefeedCounterSliderOptions,useTasksCounters:this.useTasksCounters});this.pullControllerSocialnetwork=new PullControllerSocialnetwork({componentName:this.componentName,signedParameters:this.signedParameters,gridController:this.gridController,userCounterManager:this.userCounterManagerInstance,pullController:this});pull_client.PULL.subscribe(this.pullControllerSocialnetwork);this.pullControllerMainUserCounter=new PullControllerMainUserCounter({componentName:this.componentName,signedParameters:this.signedParameters,userCounterManager:this.userCounterManagerInstance});pull_client.PULL.subscribe(this.pullControllerMainUserCounter);this.pullControllerTasksUserCounter=new PullControllerTasksUserCounter({componentName:this.componentName,signedParameters:this.signedParameters,gridController:this.gridController,userCounterManager:this.userCounterManagerInstance});pull_client.PULL.subscribe(this.pullControllerTasksUserCounter);if(this.useTasksCounters){this.pullControllerTasks=new PullControllerTasks({componentName:this.componentName,signedParameters:this.signedParameters,gridController:this.gridController,pullController:this});pull_client.PULL.subscribe(this.pullControllerTasks)}}},{key:"checkExistence",value:function e(t){var r=this;return new Promise((function(e,n){main_core.ajax.runComponentAction(r.componentName,"checkExistence",{mode:"class",data:{groupIdList:main_core.Type.isArray(t)?t:[t]},signedParameters:r.signedParameters}).then((function(t){return e(t)}),(function(e){return n(e)}))}))}},{key:"onCheckExistenceSuccess",value:function e(t,r,n){if(main_core.Type.isUndefined(t.data[r])){return}if(t.data[r]===false){this.grid.removeRow(r);return}this.moveToDirectPlace(r,t.data[r],n)}},{key:"isActivityRealtimeMode",value:function e(){var t=this.gridController.getInstance().getSort();return t.DATE_UPDATE&&t.DATE_UPDATE==="desc"}},{key:"updateItem",value:function e(t,r,n){if(!this.gridController.getInstance().hasItem(t)){this.gridController.getInstance().addItem(t);this.addRow(t,r,n)}else{this.updateRow(t,r,n)}}},{key:"addRow",value:function e(t,r,n){if(this.gridController.getInstance().isRowExist(t)||main_core.Type.isUndefined(r)||main_core.Type.isNull(r)){return}this.gridController.getInstance().addRow(t,r,n)}},{key:"updateRow",value:function e(t,r,n){if(!this.gridController.getInstance().isRowExist(t)||main_core.Type.isUndefined(r)){return}this.gridController.getInstance().updateRow(t,r,n)}},{key:"removeRow",value:function e(t){if(!this.gridController.getInstance().isRowExist(t)){return}this.gridController.getInstance().removeRow(t)}},{key:"moveToDirectPlace",value:function e(t,r,n){var i=this;n=n||{};main_core.ajax.runComponentAction(this.componentName,"findWorkgroupPlace",{mode:"class",data:{groupId:t,currentPage:this.gridController.getInstance().getCurrentPage()},signedParameters:this.signedParameters}).then((function(e){if(e.data===null){return}var o=e.data,s=o.workgroupBefore,a=o.workgroupAfter;if(s===false&&a===false){i.removeRow(t)}else{if(s&&i.gridController.getInstance().isRowExist(s)||a&&i.gridController.getInstance().isRowExist(a)){n.moveParams={rowBefore:s,rowAfter:a}}else{n.moveParams={skip:true}}i.updateItem(t,r,n)}}))}}]);return e}();var Manager=function(){babelHelpers.createClass(e,null,[{key:"getById",value:function t(r){return e.repo.get(r)}}]);function e(t){babelHelpers.classCallCheck(this,e);this.id=t.id;this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.useSlider=t.useSlider;this.gridId=t.gridId;this.filterId=main_core.Type.isStringFilled(t.filterId)?t.filterId:null;this.sort=t.sort;this.items=t.items;this.pageSize=main_core.Type.isNumber(t.pageSize)?parseInt(t.pageSize):10;this.gridStub=!main_core.Type.isUndefined(t.gridStub)?t.gridStub:null;this.defaultFilterPresetId=main_core.Type.isStringFilled(t.defaultFilterPresetId)&&!["requests_in","requests_out"].includes(t.defaultFilterPresetId)?t.defaultFilterPresetId:"tmp_filter";this.defaultCounter=main_core.Type.isStringFilled(t.defaultCounter)?t.defaultCounter:"";this.gridContainer=main_core.Type.isStringFilled(t.gridContainerId)?document.getElementById(t.gridContainerId):null;this.urls=t.urls;this.useTasksCounters=main_core.Type.isBoolean(t.useTasksCounters)?t.useTasksCounters:false;this.livefeedCounterColumnId=main_core.Type.isStringFilled(t.livefeedCounterColumnId)?t.livefeedCounterColumnId:"NAME";this.livefeedCounterSliderOptions=main_core.Type.isPlainObject(t.livefeedCounterSliderOptions)?t.livefeedCounterSliderOptions:{};this.init(t)}babelHelpers.createClass(e,[{key:"init",value:function t(r){this.initEvents();this.actionManagerInstance=new ActionManager({parent:this});this.gridController=new socialnetwork_ui_grid.Controller({id:this.id,sort:this.sort,items:this.items,pageSize:this.pageSize,gridStub:this.gridStub,componentName:this.componentName,signedParameters:this.signedParameters});e.repo.set(this.id,this);socialnetwork_ui_grid.ActionController.setOptions({gridInstance:this.gridController.getGrid(),componentName:this.componentName,signedParameters:this.signedParameters});var n=new socialnetwork_ui_grid.Filter({filterId:this.filterId,defaultFilterPresetId:this.defaultFilterPresetId,gridId:this.id,signedParameters:this.signedParameters});if(this.useTasksCounters){this.tasksTour=new tasks_tour.Tour({tours:r.tours});this.tasksTour.subscribe("FirstProject:afterProjectCreated",this.onAfterGroupCreated.bind(this));this.tasksTour.subscribe("FirstScrum:afterScrumCreated",this.onAfterGroupCreated.bind(this))}this.initPull();if(n){socialnetwork_ui_grid.TagController.setOptions({filter:n})}}},{key:"initPull",value:function e(){this.pullManager=new PullManager({componentName:this.componentName,signedParameters:this.signedParameters,urls:this.urls,livefeedCounterColumnId:this.livefeedCounterColumnId,livefeedCounterSliderOptions:this.livefeedCounterSliderOptions,gridController:this.gridController,useTasksCounters:this.useTasksCounters})}},{key:"setActionsPanel",value:function e(t){socialnetwork_ui_grid.ActionController.setActionsPanel(t)}},{key:"initEvents",value:function e(){var t=this;if(this.gridContainer){this.gridContainer.addEventListener("click",this.processClickEvent.bind(this))}main_core_events.EventEmitter.subscribe("SidePanel.Slider:onMessage",(function(e){var r=e.getCompatData(),n=babelHelpers.slicedToArray(r,1),i=n[0];if(!BX.PULL&&i.getEventId()==="sonetGroupEvent"&&!main_core.Type.isUndefined(i.data)&&main_core.Type.isStringFilled(i.data.code)&&["afterCreate","afterEdit","afterInvite","afterJoinRequestSend","afterLeave","afterDelete"].includes(i.data.code)){t.reload()}}));main_core_events.EventEmitter.subscribe("Tasks.Toolbar:onItem",(function(e){var r=e.getData();if(r.counter&&r.counter.filter){var n=r.counter.filter.getFilter();t.toggleByField(babelHelpers.defineProperty({},r.counter.filterField,r.counter.filterValue),n)}}));main_core_events.EventEmitter.subscribe("Socialnetwork.Toolbar:onItem",(function(e){var r=e.getData();if(r.counter&&r.counter.filter){var n=r.counter.filter.getFilter();t.toggleByField(babelHelpers.defineProperty({},r.counter.filterField,r.counter.filterValue),n)}}))}},{key:"toggleByField",value:function e(t,r){if(!r){return}var n=Object.keys(t)[0];var i=t[n];var o=r.getFilterFieldsValues();if(!this.isFilteredByFieldValue(n,i,o)){r.getApi().extendFilter(babelHelpers.defineProperty({},n,i));return}r.getFilterFields().forEach((function(e){if(e.getAttribute("data-name")===n){r.getFields().deleteField(e)}}));r.getSearch().apply()}},{key:"isFilteredByField",value:function e(t,r){if(!Object.keys(r).includes(t)){return false}if(main_core.Type.isArray(r[t])){return r[t].length>0}return r[t]!==""}},{key:"isFilteredByFieldValue",value:function e(t,r,n){return this.isFilteredByField(t,n)&&n[t]===r}},{key:"reload",value:function e(){var t=this;var r=BX.Main.gridManager.getInstanceById(this.gridId);if(!r){return}r.reloadTable("POST",{apply_filter:"Y"},(function(){t.gridController.getInstance().getPinController().colorPinnedRows()}))}},{key:"processClickEvent",value:function e(t){var r=t.target;if(!r.classList.contains("sonet-group-grid-action")){return}var n=r.getAttribute("data-bx-action");var i=r.getAttribute("data-bx-group-id");if(!main_core.Type.isStringFilled(n)||!main_core.Type.isStringFilled(i)){return}i=parseInt(i);if(i<=0){return}r.classList.add("--inactive");this.actionManagerInstance.act({action:n,groupId:i}).then((function(){r.classList.remove("--inactive")}),(function(){r.classList.remove("--inactive")}));t.preventDefault();t.stopPropagation()}},{key:"getActionManager",value:function e(){return this.actionManagerInstance}},{key:"onAfterGroupCreated",value:function e(t){var r=t.getData();var n=this.gridController.getInstance().isRowExist(r);if(n){var i=this.gridController.getInstance().getRowNodeById(r);var o=i.querySelector(".sonet-group-grid-name-text");this.tasksTour.showFinalStep(r,o)}else{main_core_events.EventEmitter.subscribeOnce("SocialNetwork.Projects.Grid:RowAdd",this.onGridRowAdded.bind(this,r))}}},{key:"onGridRowAdded",value:function e(t,r){var n=r.getData(),i=n.id;if(Number(i)===Number(t)){var o=this.gridController.getInstance().getRowNodeById(t);var s=o.querySelector(".sonet-group-grid-name-text");this.tasksTour.showFinalStep(s)}}}]);return e}();babelHelpers.defineProperty(Manager,"repo",new Map);exports.Manager=Manager})(this.BX.Socialnetwork.WorkgroupList=this.BX.Socialnetwork.WorkgroupList||{},BX.Socialnetwork.UI.Grid,BX.Tasks.Tour,BX.Event,BX.Main,BX.UI,BX.Socialnetwork.UI,BX,BX);
//# sourceMappingURL=script.map.js