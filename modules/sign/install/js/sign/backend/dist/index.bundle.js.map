{"version":3,"file":"index.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { ajax, Http, Loc, Type, Uri } from 'main.core';\nimport { Error } from 'sign.error';\n\ntype ControllerType = {\n\tcommand: string,\n\tmodule?: string,\n\ttimeout?: number,\n\tpostData?: any,\n\tgetData?: {\n\t\t[key: string]: string\n\t}\n};\n\nexport class Backend\n{\n\tstatic controllerUri = '/bitrix/services/main/ajax.php';\n\n\t/**\n\t * Check ajax response and generate error, if exists.\n\t * @param {Object} sourceResponse\n\t * @return {boolean}\n\t */\n\tstatic isErrorOccurred(sourceResponse): boolean\n\t{\n\t\tif (sourceResponse.status === 'error')\n\t\t{\n\t\t\tif (Type.isArray(sourceResponse.errors))\n\t\t\t{\n\t\t\t\tsourceResponse.errors.map(error => {\n\t\t\t\t\tif (error.code === 'invalid_csrf' && sourceResponse.data.sessid)\n\t\t\t\t\t{\n\t\t\t\t\t\tLoc.setMessage('bitrix_sessid', sourceResponse.data.sessid);\n\t\t\t\t\t}\n\n\t\t\t\t\tError.getInstance().addError(error);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Sends request to Controller API and returns Promise on result.\n\t * @param {ControllerType} options\n\t * @return {Promise}\n\t */\n\tstatic controller(options: ControllerType): Promise<any, any>\n\t{\n\t\toptions.getData = options.getData || {};\n\t\toptions.postData = options.postData || {};\n\t\tconst {command, postData, getData} = options;\n\n\t\treturn new Promise((resolve, reject) => {\n\n\t\t\tpostData.sessid = Loc.getMessage('bitrix_sessid');\n\t\t\tgetData.action = (options.module || 'sign') + '.api.' + command;\n\n\t\t\tconst fd = postData instanceof FormData ? postData : Http.Data.convertObjectToFormData(postData);\n\n\t\t\tconst xhr = ajax({\n\t\t\t\tmethod: 'POST',\n\t\t\t\tdataType: 'json',\n\t\t\t\ttimeout: options.timeout || 60,\n\t\t\t\turl: (new Uri(Backend.controllerUri)).setQueryParams(getData).toString(),\n\t\t\t\tdata: fd,\n\t\t\t\tstart: false,\n\t\t\t\tpreparePost: false,\n\t\t\t\tonsuccess: (sourceResponse) => {\n\n\t\t\t\t\tif (this.isErrorOccurred(sourceResponse))\n\t\t\t\t\t{\n\t\t\t\t\t\treject(sourceResponse);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve(sourceResponse.data);\n\t\t\t\t},\n\t\t\t\tonfailure: (sourceResponse) => {\n\t\t\t\t\treject(sourceResponse);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\txhr.send(fd);\n\t\t});\n\t}\n}\n"],"names":["Backend","sourceResponse","status","Type","isArray","errors","map","error","code","data","sessid","Loc","setMessage","Error","getInstance","addError","options","getData","postData","command","Promise","resolve","reject","getMessage","action","module","fd","FormData","Http","Data","convertObjectToFormData","xhr","ajax","method","dataType","timeout","url","Uri","controllerUri","setQueryParams","toString","start","preparePost","onsuccess","isErrorOccurred","onfailure","send"],"mappings":";;;;KAaaA,OAAO;GAAA;KAAA;;GAAA;KAAA;;CAKpB;CACA;CACA;CACA;KAJC,gCAKuBC,cAAc,EACrC;OACC,IAAIA,cAAc,CAACC,MAAM,KAAK,OAAO,EACrC;SACC,IAAIC,cAAI,CAACC,OAAO,CAACH,cAAc,CAACI,MAAM,CAAC,EACvC;WACCJ,cAAc,CAACI,MAAM,CAACC,GAAG,CAAC,UAAAC,KAAK,EAAI;aAClC,IAAIA,KAAK,CAACC,IAAI,KAAK,cAAc,IAAIP,cAAc,CAACQ,IAAI,CAACC,MAAM,EAC/D;eACCC,aAAG,CAACC,UAAU,CAAC,eAAe,EAAEX,cAAc,CAACQ,IAAI,CAACC,MAAM,CAAC;;aAG5DG,gBAAK,CAACC,WAAW,EAAE,CAACC,QAAQ,CAACR,KAAK,CAAC;YACnC,CAAC;;SAGH,OAAO,IAAI;;OAGZ,OAAO,KAAK;;;CAId;CACA;CACA;CACA;;KAJC;KAAA,2BAKkBS,OAAuB,EACzC;OAAA;OACCA,OAAO,CAACC,OAAO,GAAGD,OAAO,CAACC,OAAO,IAAI,EAAE;OACvCD,OAAO,CAACE,QAAQ,GAAGF,OAAO,CAACE,QAAQ,IAAI,EAAE;OACzC,IAAOC,OAAO,GAAuBH,OAAO,CAArCG,OAAO;SAAED,QAAQ,GAAaF,OAAO,CAA5BE,QAAQ;SAAED,OAAO,GAAID,OAAO,CAAlBC,OAAO;OAEjC,OAAO,IAAIG,OAAO,CAAC,UAACC,OAAO,EAAEC,MAAM,EAAK;SAEvCJ,QAAQ,CAACR,MAAM,GAAGC,aAAG,CAACY,UAAU,CAAC,eAAe,CAAC;SACjDN,OAAO,CAACO,MAAM,GAAG,CAACR,OAAO,CAACS,MAAM,IAAI,MAAM,IAAI,OAAO,GAAGN,OAAO;SAE/D,IAAMO,EAAE,GAAGR,QAAQ,YAAYS,QAAQ,GAAGT,QAAQ,GAAGU,cAAI,CAACC,IAAI,CAACC,uBAAuB,CAACZ,QAAQ,CAAC;SAEhG,IAAMa,GAAG,GAAGC,cAAI,CAAC;WAChBC,MAAM,EAAE,MAAM;WACdC,QAAQ,EAAE,MAAM;WAChBC,OAAO,EAAEnB,OAAO,CAACmB,OAAO,IAAI,EAAE;WAC9BC,GAAG,EAAG,IAAIC,aAAG,CAACrC,OAAO,CAACsC,aAAa,CAAC,CAAEC,cAAc,CAACtB,OAAO,CAAC,CAACuB,QAAQ,EAAE;WACxE/B,IAAI,EAAEiB,EAAE;WACRe,KAAK,EAAE,KAAK;WACZC,WAAW,EAAE,KAAK;WAClBC,SAAS,EAAE,mBAAC1C,cAAc,EAAK;aAE9B,IAAI,KAAI,CAAC2C,eAAe,CAAC3C,cAAc,CAAC,EACxC;eACCqB,MAAM,CAACrB,cAAc,CAAC;eACtB;;aAGDoB,OAAO,CAACpB,cAAc,CAACQ,IAAI,CAAC;YAC5B;WACDoC,SAAS,EAAE,mBAAC5C,cAAc,EAAK;aAC9BqB,MAAM,CAACrB,cAAc,CAAC;;UAEvB,CAAC;SAEF8B,GAAG,CAACe,IAAI,CAACpB,EAAE,CAAC;QACZ,CAAC;;;GACF;CAAA;CACD,4BA3EY1B,OAAO,mBAEI,gCAAgC;;;;;;;;"}