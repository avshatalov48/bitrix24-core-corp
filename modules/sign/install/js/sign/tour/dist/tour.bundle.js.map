{"version":3,"file":"tour.bundle.js","sources":["../src/backend.js","../src/guide.js"],"sourcesContent":["import { ajax as Ajax, Type } from \"main.core\";\n\nexport class Backend\n{\n\tsaveVisit(tourId: string): Promise<null>\n\t{\n\t\treturn Ajax.runAction('sign.api.tour.saveVisit', { data: { tourId } }).then(({ data }) => data);\n\t}\n\n\tgetLastVisitDate(tourId: string): Promise<{ lastVisitDate: ?Date }>\n\t{\n\t\treturn Ajax\n\t\t\t.runAction('sign.api.tour.getLastVisitDate', { data: { tourId } })\n\t\t\t.then(({ data }) => {\n\t\t\t\tif (!Type.isNil(data?.lastVisitDate))\n\t\t\t\t{\n\t\t\t\t\tdata.lastVisitDate = new Date(data.lastVisitDate);\n\t\t\t\t}\n\n\t\t\t\treturn data;\n\t\t\t});\n\t}\n\n\tisAllToursDisabled(): Promise<boolean>\n\t{\n\t\treturn Ajax\n\t\t\t.runAction('sign.api.tour.isAllToursDisabled', {})\n\t\t\t.then(({ data }) => data)\n\t}\n}","import { Text, Type, Dom } from 'main.core';\nimport { Guide as UiGuide } from 'ui.tour';\nimport { Backend } from './backend';\nimport { Popup, type PopupOptions } from 'main.popup';\n\ntype GuideOption = {\n\tid: ?string;\n\tsteps: Array<StepOption>,\n\tadjustPopupPosition?: (popup: Popup) => void,\n\tpopupOptions?: {\n\t\t...popupOptions,\n\t\tcenterAngle?: boolean,\n\t},\n\thideButton?: boolean,\n\tevents: null | {\n\t\tonFinish?: ?Function,\n\t},\n\t...\n};\n\nexport type StepOption = {\n\tid?: null | string,\n\tevents?: null | {\n\t\tonShow?: ?Function,\n\t\tonClose?: ?Function,\n\t},\n\ttarget?: string | HTMLElement,\n\ttitle: string,\n\ttext: string,\n\tarticle?: number,\n\t...\n};\n\nexport class Guide extends UiGuide\n{\n\tstatic #isAllTourDisabled: Promise<boolean>;\n\n\t#isIdAutoGenerated: boolean;\n\t#autogeneratedIdPrefix: string = 'sign-tour-guide-';\n\t#backend: Backend = new Backend();\n\t#popupOptions: ?PopupOptions;\n\t#hideButton: boolean = false;\n\t#adjustPopupPosition: (popup: Popup) => {};\n\n\tconstructor(options: GuideOption)\n\t{\n\t\tconst { popupOptions, ...guideOptions } = options;\n\t\tsuper(guideOptions);\n\t\tif (Type.isStringFilled(options.id))\n\t\t{\n\t\t\tthis.setId(options.id);\n\t\t\tthis.#isIdAutoGenerated = false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setId(this.#autogeneratedIdPrefix + Text.getRandom(14));\n\t\t\tthis.#isIdAutoGenerated = true;\n\t\t}\n\n\t\tif (Type.isBoolean(options.hideButton))\n\t\t{\n\t\t\tthis.#hideButton = options.hideButton;\n\t\t}\n\n\t\tif (Type.isFunction(options.adjustPopupPosition))\n\t\t{\n\t\t\tthis.#adjustPopupPosition = options.adjustPopupPosition;\n\t\t}\n\n\t\tif (Type.isUndefined(Guide.#isAllTourDisabled))\n\t\t{\n\t\t\tGuide.#isAllTourDisabled = this.#backend.isAllToursDisabled();\n\t\t}\n\n\t\tif (popupOptions)\n\t\t{\n\t\t\tthis.setPopupOptions(popupOptions);\n\t\t}\n\t}\n\n\tsetPopupOptions(popupOptions: PopupOptions): void\n\t{\n\t\tconst { autoHide, width, className } = popupOptions;\n\t\tconst popup = this.getPopup();\n\n\t\tif (width)\n\t\t{\n\t\t\tpopup.setWidth(width);\n\t\t}\n\n\t\tif (autoHide)\n\t\t{\n\t\t\tpopup.setAutoHide(autoHide);\n\t\t}\n\n\t\tif (className)\n\t\t{\n\t\t\tDom.addClass(popup.getPopupContainer(), className);\n\t\t}\n\n\t\tthis.#popupOptions = popupOptions;\n\t}\n\n\t#adjustPopupWithCenterAngle(): void\n\t{\n\t\tconst popup = this.getPopup();\n\t\tconst { angleArrowElement } = popup;\n\t\tconst { offsetWidth: popupWidth } = popup.getPopupContainer();\n\t\tconst shiftX = popupWidth / 2 - angleArrowElement.offsetWidth / 2 - angleArrowElement.offsetLeft;\n\t\tconst offsetLeft = Popup.getOption('angleLeftOffset') - shiftX;\n\t\tpopup.setOffset({ offsetLeft });\n\t\tpopup.adjustPosition();\n\t\tpopup.setAngle({ offset: shiftX });\n\t}\n\n\tsave(): void\n\t{\n\t\tthis.#backend.saveVisit(this.getId());\n\t}\n\n\tasync start(): Promise<void>\n\t{\n\t\tconst isDisabled = await Guide.#isAllTourDisabled;\n\t\tif (isDisabled)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.start();\n\t\tif (this.#hideButton)\n\t\t{\n\t\t\tDom.style(this.layout.nextBtn, { display: 'none' });\n\t\t}\n\n\t\tif (this.#adjustPopupPosition)\n\t\t{\n\t\t\tthis.#adjustPopupPosition(this.getPopup());\n\t\t}\n\t\telse if (this.#popupOptions?.centerAngle)\n\t\t{\n\t\t\tthis.#adjustPopupWithCenterAngle();\n\t\t}\n\t}\n\n\tasync startOnce(): Promise<void>\n\t{\n\t\tif (this.#isIdAutoGenerated)\n\t\t{\n\t\t\tthrow new Error('Cant start guide once if id autogenerated. Set id in constructor');\n\t\t}\n\n\t\tif (!this.getAutoSave())\n\t\t{\n\t\t\tthrow new Error('Cant start guide once if guide is not auto saved');\n\t\t}\n\n\t\tconst [{ lastVisitDate }, isTourDisabled] = await Promise.all([\n\t\t\tthis.#backend.getLastVisitDate(this.getId()),\n\t\t\tGuide.#isAllTourDisabled,\n\t\t]);\n\t\tif (!isTourDisabled && Type.isNull(lastVisitDate))\n\t\t{\n\t\t\tthis.start();\n\t\t}\n\t}\n}\n"],"names":["Backend","saveVisit","tourId","Ajax","runAction","data","then","getLastVisitDate","Type","isNil","lastVisitDate","Date","isAllToursDisabled","Guide","UiGuide","constructor","options","popupOptions","guideOptions","isStringFilled","id","setId","Text","getRandom","isBoolean","hideButton","isFunction","adjustPopupPosition","isUndefined","setPopupOptions","autoHide","width","className","popup","getPopup","setWidth","setAutoHide","Dom","addClass","getPopupContainer","save","getId","start","isDisabled","style","layout","nextBtn","display","centerAngle","startOnce","Error","getAutoSave","isTourDisabled","Promise","all","isNull","angleArrowElement","offsetWidth","popupWidth","shiftX","offsetLeft","Popup","getOption","setOffset","adjustPosition","setAngle","offset"],"mappings":"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"}