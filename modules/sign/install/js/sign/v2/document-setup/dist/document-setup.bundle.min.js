this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,s,a,t,l,i,o,r){"use strict";let n=e=>e,c,d;const b=Object.freeze({employee:"employee",company:"company"});var p=babelHelpers.classPrivateFieldLooseKey("notificationContainer");var v=babelHelpers.classPrivateFieldLooseKey("changeDomainWarningContainer");var h=babelHelpers.classPrivateFieldLooseKey("scenarioType");var u=babelHelpers.classPrivateFieldLooseKey("api");var P=babelHelpers.classPrivateFieldLooseKey("uids");var B=babelHelpers.classPrivateFieldLooseKey("documentMode");var L=babelHelpers.classPrivateFieldLooseKey("chatId");var F=babelHelpers.classPrivateFieldLooseKey("initNotifications");var g=babelHelpers.classPrivateFieldLooseKey("isChatCreated");var m=babelHelpers.classPrivateFieldLooseKey("appendChatWarningContainer");var y=babelHelpers.classPrivateFieldLooseKey("register");var H=babelHelpers.classPrivateFieldLooseKey("changeDocumentBlank");var f=babelHelpers.classPrivateFieldLooseKey("getPages");var S=babelHelpers.classPrivateFieldLooseKey("convertToBase64");var k=babelHelpers.classPrivateFieldLooseKey("setDocumentData");var D=babelHelpers.classPrivateFieldLooseKey("processPages");var w=babelHelpers.classPrivateFieldLooseKey("appendUnsecuredSchemeWarningContainer");var _=babelHelpers.classPrivateFieldLooseKey("appendChangeDomainWarningContainer");var I=babelHelpers.classPrivateFieldLooseKey("getWarning");var C=babelHelpers.classPrivateFieldLooseKey("removeChangeDomainWarningContainer");var E=babelHelpers.classPrivateFieldLooseKey("appendEdoWarningContainer");class O extends a.EventEmitter{constructor(e){super();Object.defineProperty(this,E,{value:z});Object.defineProperty(this,C,{value:V});Object.defineProperty(this,I,{value:x});Object.defineProperty(this,_,{value:W});Object.defineProperty(this,w,{value:G});Object.defineProperty(this,D,{value:R});Object.defineProperty(this,k,{value:X});Object.defineProperty(this,S,{value:K});Object.defineProperty(this,f,{value:M});Object.defineProperty(this,H,{value:j});Object.defineProperty(this,y,{value:A});Object.defineProperty(this,m,{value:U});Object.defineProperty(this,g,{value:N});Object.defineProperty(this,F,{value:T});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,L,{writable:true,value:void 0});this.setEventNamespace("BX.Sign.V2.DocumentSetup");this.blankSelector=new t.BlankSelector({...e,events:{toggleSelection:({data:e})=>{this.emit("toggleActivity",{...e,blankSelector:this.blankSelector})},addFile:({data:e})=>{this.emit("addFile",{ready:this.blankSelector.isFilesReadyForUpload()})},removeFile:()=>this.emit("removeFile",{ready:this.blankSelector.isFilesReadyForUpload()}),clearFiles:()=>this.emit("clearFiles")}});const{type:s,portalConfig:a,documentMode:i,chatId:o}=e;this.setupData=null;this.blankIsNotSelected=true;babelHelpers.classPrivateFieldLooseBase(this,h)[h]=s;babelHelpers.classPrivateFieldLooseBase(this,u)[u]=new l.Api;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=new Map;babelHelpers.classPrivateFieldLooseBase(this,B)[B]=i;babelHelpers.classPrivateFieldLooseBase(this,L)[L]=o;this.initLayout();babelHelpers.classPrivateFieldLooseBase(this,F)[F](a)}initLayout(){this.layout=s.Tag.render(c||(c=n`
			<div class="sign-document-setup">
				<p class="sign-document-setup__add-title">
					${0}
				</p>
				${0}
			</div>
		`),s.Loc.getMessage("SIGN_DOCUMENT_SETUP_ADD_TITLE"),this.blankSelector.getLayout())}isSameBlankSelected(){var e;const{selectedBlankId:s}=this.blankSelector;const{blankId:a}=(e=this.setupData)!=null?e:{};return s>0&&a===s}handleError(e){babelHelpers.classPrivateFieldLooseBase(this,k)[k](null);this.blankSelector.resetSelectedBlank();this.blankSelector.deleteBlank(e)}loadBlocks(e){return babelHelpers.classPrivateFieldLooseBase(this,u)[u].loadBlocksByDocument(e)}async setup(e,s=false){if(this.isSameBlankSelected()){this.setupData={...this.setupData,isTemplate:true};return}const{selectedBlankId:a}=this.blankSelector;let t=0;try{if(e){const[s,a]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,u)[u].loadDocument(e),this.loadBlocks(e)]);babelHelpers.classPrivateFieldLooseBase(this,k)[k]({...s,blocks:a,isTemplate:true});const{blankId:t}=s;if(!this.blankSelector.hasBlank(t)){await this.blankSelector.loadBlankById(t)}this.blankSelector.selectBlank(t)}else{var l;this.ready=false;const e=a||this.blankSelector.isFilesReadyForUpload();t=a||await this.blankSelector.createBlank();if(!t){this.blankIsNotSelected=true;return}let i=(l=this.setupData)==null?void 0:l.uid;let o=null;if(e&&s&&i){const{templateUid:e}=await babelHelpers.classPrivateFieldLooseBase(this,H)[H](i,t);o=e}else{const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].has(t);const{uid:a,templateUid:l}=e?await babelHelpers.classPrivateFieldLooseBase(this,H)[H](babelHelpers.classPrivateFieldLooseBase(this,P)[P].get(t),t):await babelHelpers.classPrivateFieldLooseBase(this,y)[y](t,s,babelHelpers.classPrivateFieldLooseBase(this,L)[L]);i=a;o=l}babelHelpers.classPrivateFieldLooseBase(this,P)[P].set(t,i);await babelHelpers.classPrivateFieldLooseBase(this,u)[u].upload(i);const[r,n]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,u)[u].loadDocument(i),babelHelpers.classPrivateFieldLooseBase(this,u)[u].loadBlocksByDocument(i)]);const c=Boolean(a);babelHelpers.classPrivateFieldLooseBase(this,k)[k]({...r,blocks:n,isTemplate:c,templateUid:o})}}catch{this.handleError(t)}this.ready=true}async waitForPagesList(e,s,a=false){let t=0;let l=false;const i=10*1e3;const{uid:o,blankId:r,isTemplate:n}=e;if(!n){this.blankSelector.selectBlank(r)}this.emit("toggleActivity",{selected:false});const c=[new Promise((e=>{var s;(s=BX.PULL)==null?void 0:s.subscribe({moduleId:"sign",command:"blankIsReady",callback:s=>{if(!l&&s!=null&&s.pages&&(s==null?void 0:s.uid)===o){e(s==null?void 0:s.pages)}}})})),new Promise((e=>{t=setInterval((async()=>{if(l){clearInterval(t);return}const s=await babelHelpers.classPrivateFieldLooseBase(this,f)[f](o);if(s.length>0){e(s)}}),i)}))];if(a){c.push(new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f](o).then((s=>{if(s.length>0){e(s)}}))})))}const d=await Promise.race(c);if(!n){const e=this.blankSelector.getBlank(r);e.setPreview(d[0].url)}clearInterval(t);l=true;await babelHelpers.classPrivateFieldLooseBase(this,D)[D](d,s)}set ready(e){if(e){s.Dom.removeClass(this.layout,"--pending")}else{s.Dom.addClass(this.layout,"--pending")}}isTemplateMode(){return i.isTemplateMode(babelHelpers.classPrivateFieldLooseBase(this,B)[B])}deleteDocumentFromList(e){babelHelpers.classPrivateFieldLooseBase(this,P)[P].delete(e)}}function T(e){babelHelpers.classPrivateFieldLooseBase(this,p)[p]=s.Tag.render(d||(d=n`<div></div>`));const a=this.layout.querySelector(".sign-blank-selector__tile-widget");s.Dom.insertBefore(babelHelpers.classPrivateFieldLooseBase(this,p)[p],a);const{isDomainChanged:t,isEdoRegion:l,isUnsecuredScheme:i}=e;if(babelHelpers.classPrivateFieldLooseBase(this,g)[g]()&&babelHelpers.classPrivateFieldLooseBase(this,h)[h]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,m)[m]()}if(t){babelHelpers.classPrivateFieldLooseBase(this,_)[_]()}if(i){babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}if(l&&babelHelpers.classPrivateFieldLooseBase(this,h)[h]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}}function N(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L]>0}function U(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_COLLAB_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,p)[p])}async function A(e,s=false,a=0){const t=await babelHelpers.classPrivateFieldLooseBase(this,u)[u].register(e,babelHelpers.classPrivateFieldLooseBase(this,h)[h],s,a);return t!=null?t:{}}async function j(e,s){const a=await babelHelpers.classPrivateFieldLooseBase(this,u)[u].changeDocument(e,s);return a!=null?a:{}}async function M(e){var s;const a=await babelHelpers.classPrivateFieldLooseBase(this,u)[u].getPages(e);return(s=a.pages)!=null?s:[]}async function K(e){const a=e.map((async e=>{const a=await fetch(e.url);const t=await a.blob();const l=new FileReader;await new Promise((e=>{s.Event.bindOnce(l,"loadend",e);l.readAsDataURL(t)}));return l.result}));return Promise.all(a)}function X(e){this.setupData=e;this.blankSelector.clearFiles({removeFromServer:false})}async function R(e,s){let a=0;const t=3;while(a<e.length){const l=e.slice(a,a+t);const i=await babelHelpers.classPrivateFieldLooseBase(this,S)[S](l);this.emit("toggleActivity",{selected:true});a+=t;s(i,e.length)}}function G(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_USE_UNSECURED_SCHEME_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,p)[p])}function W(){const e=new o.Button({text:s.Loc.getMessage("SIGN_DOCUMENT_SETUP_REFRESH_DOMAIN_BUTTON_TEXT"),color:o.Button.Color.LINK,onclick:()=>babelHelpers.classPrivateFieldLooseBase(this,u)[u].changeDomain().then((()=>babelHelpers.classPrivateFieldLooseBase(this,C)[C]())),className:"sign-document-setup__change-domain-button",size:o.Button.Size.EXTRA_SMALL});const a=`<p>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_CHANGE_DOMAIN_WARNING")}</p>`;const t=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();t.setText(a);babelHelpers.classPrivateFieldLooseBase(this,v)[v]=t.getContainer();s.Dom.append(e.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,v)[v]);s.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,v)[v],babelHelpers.classPrivateFieldLooseBase(this,p)[p])}function x(){return new r.Alert({size:r.Alert.Size.MD,color:r.Alert.Color.WARNING,icon:r.Alert.Icon.DANGER,customClass:"sign-document-setup__change-domain-wrapper"})}function V(){s.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,v)[v])}function z(){const e=s.Loc.getMessage("SIGN_DOCUMENT_SETUP_EDO_TEXT",{"[helpdesklink]":'<a class="sign-document-setup__helpdesk-article" href="javascript:top.BX.Helper.show(\'redirect=detail&code=18453372\');">',"[/helpdesklink]":"</a>"});const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setColor(r.Alert.Color.PRIMARY);a.setIcon(r.Alert.Icon.INFO);a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,p)[p])}e.DocumentInitiated=b;e.DocumentSetup=O})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2,BX.UI,BX.UI);
//# sourceMappingURL=document-setup.bundle.map.js