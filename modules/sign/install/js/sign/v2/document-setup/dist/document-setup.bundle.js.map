{"version":3,"file":"document-setup.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Tag, Dom, Event, Loc } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { BlankSelector, type BlankSelectorConfig } from 'sign.v2.blank-selector';\nimport { Api } from 'sign.v2.api';\nimport { isTemplateMode } from 'sign.v2.sign-settings';\nimport { Button } from 'ui.buttons';\nimport { Alert } from 'ui.alerts';\nimport type { DocumentDetails } from './type';\nimport type { DocumentInitiatedType, DocumentModeType } from 'sign.type';\nimport './style.css';\n\nexport type { DocumentDetails };\n\nexport class DocumentSetup extends EventEmitter\n{\n\tblankSelector: BlankSelector;\n\tsetupData: null | {\n\t\tuid: string,\n\t\tinitiatedByType: DocumentInitiatedType,\n\t\ttemplateUid: ?string,\n\t\ttemplateId: ?number,\n\t\t...\n\t};\n\tlayout: HTMLElement;\n\t#notificationContainer: HTMLElement;\n\t#changeDomainWarningContainer: ?HTMLElement;\n\t#scenarioType: BlankSelectorConfig['type'];\n\t#api: Api;\n\t#uids: Map<number, string>;\n\t#documentMode: DocumentModeType;\n\t#chatId: 0;\n\n\tconstructor(blankSelectorConfig: BlankSelectorConfig)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Sign.V2.DocumentSetup');\n\t\tthis.blankSelector = new BlankSelector({\n\t\t\t...blankSelectorConfig,\n\t\t\tevents: {\n\t\t\t\ttoggleSelection: ({ data }) => {\n\t\t\t\t\tthis.emit('toggleActivity', { ...data, blankSelector: this.blankSelector });\n\t\t\t\t},\n\t\t\t\taddFile: ({ data }) => {\n\t\t\t\t\tthis.emit('addFile', { ready: this.blankSelector.isFilesReadyForUpload() });\n\t\t\t\t},\n\t\t\t\tremoveFile: () => this.emit('removeFile', { ready: this.blankSelector.isFilesReadyForUpload() }),\n\t\t\t\tclearFiles: () => this.emit('clearFiles'),\n\t\t\t},\n\t\t});\n\t\tconst { type, portalConfig, documentMode, chatId } = blankSelectorConfig;\n\t\tthis.setupData = null;\n\t\tthis.blankIsNotSelected = true;\n\t\tthis.#scenarioType = type;\n\t\tthis.#api = new Api();\n\t\tthis.#uids = new Map();\n\t\tthis.#documentMode = documentMode;\n\t\tthis.#chatId = chatId;\n\t\tthis.initLayout();\n\t\tthis.#initNotifications(portalConfig);\n\t}\n\n\t#initNotifications(portalConfig: BlankSelectorConfig['portalConfig'])\n\t{\n\t\tthis.#notificationContainer = Tag.render`<div></div>`;\n\t\tconst buttonsContainer = this.layout.querySelector('.sign-blank-selector__tile-widget');\n\t\tDom.insertBefore(this.#notificationContainer, buttonsContainer);\n\t\tconst { isDomainChanged, isEdoRegion, isUnsecuredScheme } = portalConfig;\n\n\t\tif (this.#isChatCreated() && this.#scenarioType !== 'b2e')\n\t\t{\n\t\t\tthis.#appendChatWarningContainer();\n\t\t}\n\n\t\tif (isDomainChanged)\n\t\t{\n\t\t\tthis.#appendChangeDomainWarningContainer();\n\t\t}\n\n\t\tif (isUnsecuredScheme)\n\t\t{\n\t\t\tthis.#appendUnsecuredSchemeWarningContainer();\n\t\t}\n\n\t\tif (isEdoRegion && this.#scenarioType !== 'b2e')\n\t\t{\n\t\t\tthis.#appendEdoWarningContainer();\n\t\t}\n\t}\n\n\t#isChatCreated(): boolean\n\t{\n\t\treturn this.#chatId > 0;\n\t}\n\n\t#appendChatWarningContainer(): void\n\t{\n\t\tconst text = `<div>${Loc.getMessage('SIGN_DOCUMENT_SETUP_COLLAB_WARNING')}</div>`;\n\t\tconst warning = this.#getWarning();\n\t\twarning.setText(text);\n\t\tDom.append(warning.getContainer(), this.#notificationContainer);\n\t}\n\n\tasync #register(blankId: string, isTemplateMode: boolean = false, chatId: number = 0): Promise<{\n\t\tuid: string,\n\t\ttemplateUid: string | null,\n\t\ttemplateId: number | null,\n\t\tchatId: number,\n\t}>\n\t{\n\t\tconst data = await this.#api.register(\n\t\t\tblankId,\n\t\t\tthis.#scenarioType,\n\t\t\tisTemplateMode,\n\t\t\tchatId,\n\t\t);\n\n\t\treturn data ?? {};\n\t}\n\n\tasync #changeDocumentBlank(uid: string, blankId: number): Promise<{\n\t\tuid: string,\n\t\ttemplateUid: string | null,\n\t}>\n\t{\n\t\tconst data = await this.#api.changeDocument(uid, blankId);\n\n\t\treturn data ?? {};\n\t}\n\n\tasync #getPages(uid: string): Promise<{url: string;}[]>\n\t{\n\t\tconst data = await this.#api.getPages(uid);\n\n\t\treturn data.pages ?? [];\n\t}\n\n\tasync #convertToBase64(pages): Promise<string[]>\n\t{\n\t\tconst promises = pages.map(async (page) => {\n\t\t\tconst data = await fetch(page.url);\n\t\t\tconst blob = await data.blob();\n\t\t\tconst fileReader = new FileReader();\n\t\t\tawait new Promise((resolve) => {\n\t\t\t\tEvent.bindOnce(fileReader, 'loadend', resolve);\n\t\t\t\tfileReader.readAsDataURL(blob);\n\t\t\t});\n\n\t\t\treturn fileReader.result;\n\t\t});\n\n\t\treturn Promise.all(promises);\n\t}\n\n\t#setDocumentData(setupData)\n\t{\n\t\tthis.setupData = setupData;\n\t\tthis.blankSelector.clearFiles({ removeFromServer: false });\n\t}\n\n\tasync #processPages(urls: string[], cb: () => void)\n\t{\n\t\tlet startIndex = 0;\n\t\tconst pagesCount = 3;\n\t\twhile (startIndex < urls.length)\n\t\t{\n\t\t\tconst sliced = urls.slice(startIndex, startIndex + pagesCount);\n\t\t\tconst convertedPages = await this.#convertToBase64(sliced);\n\t\t\tthis.emit('toggleActivity', { selected: true });\n\t\t\tstartIndex += pagesCount;\n\t\t\tcb(convertedPages, urls.length);\n\t\t}\n\t}\n\n\t#appendUnsecuredSchemeWarningContainer()\n\t{\n\t\tconst text = `<div>${Loc.getMessage('SIGN_DOCUMENT_SETUP_USE_UNSECURED_SCHEME_WARNING')}</div>`;\n\t\tconst warning = this.#getWarning();\n\t\twarning.setText(text);\n\t\tDom.append(warning.getContainer(), this.#notificationContainer);\n\t}\n\n\t#appendChangeDomainWarningContainer()\n\t{\n\t\tconst domainChangeButton = new Button({\n\t\t\ttext: Loc.getMessage('SIGN_DOCUMENT_SETUP_REFRESH_DOMAIN_BUTTON_TEXT'),\n\t\t\tcolor: Button.Color.LINK,\n\t\t\tonclick: () => this.#api.changeDomain().then(() => this.#removeChangeDomainWarningContainer()),\n\t\t\tclassName: 'sign-document-setup__change-domain-button',\n\t\t\tsize: Button.Size.EXTRA_SMALL,\n\t\t});\n\t\tconst text = `<p>${Loc.getMessage('SIGN_DOCUMENT_SETUP_CHANGE_DOMAIN_WARNING')}</p>`;\n\t\tconst warning = this.#getWarning();\n\t\twarning.setText(text);\n\t\tthis.#changeDomainWarningContainer = warning.getContainer();\n\t\tDom.append(domainChangeButton.getContainer(), this.#changeDomainWarningContainer);\n\t\tDom.append(this.#changeDomainWarningContainer, this.#notificationContainer);\n\t}\n\n\t#getWarning(): Alert\n\t{\n\t\treturn new Alert({\n\t\t\tsize: Alert.Size.MD,\n\t\t\tcolor: Alert.Color.WARNING,\n\t\t\ticon: Alert.Icon.DANGER,\n\t\t\tcustomClass: 'sign-document-setup__change-domain-wrapper',\n\t\t});\n\t}\n\n\t#removeChangeDomainWarningContainer()\n\t{\n\t\tDom.remove(this.#changeDomainWarningContainer);\n\t}\n\n\t#appendEdoWarningContainer()\n\t{\n\t\tconst text = Loc.getMessage('SIGN_DOCUMENT_SETUP_EDO_TEXT', {\n\t\t\t'[helpdesklink]': '<a class=\"sign-document-setup__helpdesk-article\" href=\"javascript:top.BX.Helper.show(\\'redirect=detail&code=18453372\\');\">',\n\t\t\t'[/helpdesklink]': '</a>',\n\t\t});\n\t\tconst alert = this.#getWarning();\n\t\talert.setColor(Alert.Color.PRIMARY);\n\t\talert.setIcon(Alert.Icon.INFO);\n\t\talert.setText(text);\n\t\tDom.append(alert.getContainer(), this.#notificationContainer);\n\t}\n\n\tinitLayout()\n\t{\n\t\tthis.layout = Tag.render`\n\t\t\t<div class=\"sign-document-setup\">\n\t\t\t\t<p class=\"sign-document-setup__add-title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_SETUP_ADD_TITLE')}\n\t\t\t\t</p>\n\t\t\t\t${this.blankSelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tisSameBlankSelected(): boolean\n\t{\n\t\tconst { selectedBlankId } = this.blankSelector;\n\t\tconst { blankId: lastBlankId } = this.setupData ?? {};\n\n\t\treturn selectedBlankId > 0 && lastBlankId === selectedBlankId;\n\t}\n\n\thandleError(blankId: number)\n\t{\n\t\tthis.#setDocumentData(null);\n\t\tthis.blankSelector.resetSelectedBlank();\n\t\tthis.blankSelector.deleteBlank(blankId);\n\t}\n\n\tloadBlocks(uid: string): Promise<DocumentDetails['blocks']>\n\t{\n\t\treturn this.#api.loadBlocksByDocument(uid);\n\t}\n\n\tasync setup(uid: ?string, isTemplateMode: boolean = false): Promise<void>\n\t{\n\t\tif (this.isSameBlankSelected())\n\t\t{\n\t\t\tthis.setupData = {\n\t\t\t\t...this.setupData,\n\t\t\t\tisTemplate: true,\n\t\t\t};\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst { selectedBlankId } = this.blankSelector;\n\t\tlet blankId = 0;\n\t\ttry\n\t\t{\n\t\t\tif (uid)\n\t\t\t{\n\t\t\t\tconst [loadedData, blocks] = await Promise.all([\n\t\t\t\t\tthis.#api.loadDocument(uid),\n\t\t\t\t\tthis.loadBlocks(uid),\n\t\t\t\t]);\n\t\t\t\tthis.#setDocumentData({ ...loadedData, blocks, isTemplate: true });\n\t\t\t\tconst { blankId } = loadedData;\n\t\t\t\tif (!this.blankSelector.hasBlank(blankId))\n\t\t\t\t{\n\t\t\t\t\tawait this.blankSelector.loadBlankById(blankId);\n\t\t\t\t}\n\n\t\t\t\tthis.blankSelector.selectBlank(blankId);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.ready = false;\n\t\t\t\tconst isBlankChanged = selectedBlankId || this.blankSelector.isFilesReadyForUpload();\n\t\t\t\tblankId = selectedBlankId || await this.blankSelector.createBlank();\n\t\t\t\tif (!blankId)\n\t\t\t\t{\n\t\t\t\t\tthis.blankIsNotSelected = true;\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tlet documentUid = this.setupData?.uid;\n\n\t\t\t\tlet documentTemplateUid = null;\n\t\t\t\tif (\n\t\t\t\t\tisBlankChanged\n\t\t\t\t\t&& isTemplateMode\n\t\t\t\t\t&& documentUid\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tconst { templateUid } = await this.#changeDocumentBlank(documentUid, blankId);\n\t\t\t\t\tdocumentTemplateUid = templateUid;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tconst isRegistered = this.#uids.has(blankId);\n\n\t\t\t\t\tconst { uid, templateUid } = isRegistered\n\t\t\t\t\t\t? await this.#changeDocumentBlank(this.#uids.get(blankId), blankId)\n\t\t\t\t\t\t: await this.#register(blankId, isTemplateMode, this.#chatId);\n\n\t\t\t\t\tdocumentUid = uid;\n\t\t\t\t\tdocumentTemplateUid = templateUid;\n\t\t\t\t}\n\t\t\t\tthis.#uids.set(blankId, documentUid);\n\t\t\t\tawait this.#api.upload(documentUid);\n\t\t\t\tconst [loadedData, blocks] = await Promise.all([\n\t\t\t\t\tthis.#api.loadDocument(documentUid),\n\t\t\t\t\tthis.#api.loadBlocksByDocument(documentUid),\n\t\t\t\t]);\n\t\t\t\tconst isTemplate = Boolean(selectedBlankId);\n\t\t\t\tthis.#setDocumentData({ ...loadedData, blocks, isTemplate, templateUid: documentTemplateUid });\n\t\t\t}\n\t\t}\n\t\tcatch\n\t\t{\n\t\t\tthis.handleError(blankId);\n\t\t}\n\n\t\tthis.ready = true;\n\t}\n\n\tasync waitForPagesList(documentData, cb?: (urls: string[]) => void, preparedPages: boolean = false)\n\t{\n\t\tlet interval = 0;\n\t\tlet isPagesReady = false;\n\t\tconst requestTime = 10 * 1000;\n\t\tconst { uid, blankId, isTemplate } = documentData;\n\t\tif (!isTemplate)\n\t\t{\n\t\t\tthis.blankSelector.selectBlank(blankId);\n\t\t}\n\n\t\tthis.emit('toggleActivity', { selected: false });\n\n\t\tconst promises = [\n\t\t\tnew Promise((resolve) => {\n\t\t\t\tBX.PULL?.subscribe({\n\t\t\t\t\tmoduleId: 'sign',\n\t\t\t\t\tcommand: 'blankIsReady',\n\t\t\t\t\tcallback: (result) => {\n\t\t\t\t\t\tif (!isPagesReady && result?.pages && result?.uid === uid)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tresolve(result?.pages);\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}),\n\t\t\tnew Promise((resolve) => {\n\t\t\t\tinterval = setInterval(async () => {\n\t\t\t\t\tif (isPagesReady)\n\t\t\t\t\t{\n\t\t\t\t\t\tclearInterval(interval);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst urls = await this.#getPages(uid);\n\t\t\t\t\tif (urls.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(urls);\n\t\t\t\t\t}\n\t\t\t\t}, requestTime);\n\t\t\t}),\n\t\t];\n\n\t\tif (preparedPages)\n\t\t{\n\t\t\tpromises.push(new Promise((resolve) => {\n\t\t\t\tthis.#getPages(uid)\n\t\t\t\t\t.then((urls) => {\n\t\t\t\t\t\tif (urls.length > 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tresolve(urls);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t}));\n\t\t}\n\n\t\tconst urls = await Promise.race(promises);\n\t\tif (!isTemplate)\n\t\t{\n\t\t\tconst blank = this.blankSelector.getBlank(blankId);\n\t\t\tblank.setPreview(urls[0].url);\n\t\t}\n\n\t\tclearInterval(interval);\n\t\tisPagesReady = true;\n\t\tawait this.#processPages(urls, cb);\n\t}\n\n\tset ready(isReady: boolean)\n\t{\n\t\tif (isReady)\n\t\t{\n\t\t\tDom.removeClass(this.layout, '--pending');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.addClass(this.layout, '--pending');\n\t\t}\n\t}\n\n\tisTemplateMode(): boolean\n\t{\n\t\treturn isTemplateMode(this.#documentMode);\n\t}\n\n\tdeleteDocumentFromList(blankId: string): void\n\t{\n\t\tthis.#uids.delete(blankId);\n\t}\n}\n"],"names":["DocumentSetup","EventEmitter","constructor","blankSelectorConfig","setEventNamespace","blankSelector","BlankSelector","events","toggleSelection","data","emit","addFile","ready","isFilesReadyForUpload","removeFile","clearFiles","type","portalConfig","documentMode","chatId","setupData","blankIsNotSelected","Api","Map","initLayout","layout","Tag","render","Loc","getMessage","getLayout","isSameBlankSelected","selectedBlankId","blankId","lastBlankId","handleError","resetSelectedBlank","deleteBlank","loadBlocks","uid","loadBlocksByDocument","setup","isTemplateMode","isTemplate","loadedData","blocks","Promise","all","loadDocument","hasBlank","loadBlankById","selectBlank","isBlankChanged","createBlank","documentUid","documentTemplateUid","templateUid","isRegistered","has","get","set","upload","Boolean","waitForPagesList","documentData","cb","preparedPages","interval","isPagesReady","requestTime","selected","promises","resolve","BX","PULL","subscribe","moduleId","command","callback","result","pages","setInterval","clearInterval","urls","length","push","then","race","blank","getBlank","setPreview","url","isReady","Dom","removeClass","addClass","deleteDocumentFromList","delete","buttonsContainer","querySelector","insertBefore","isDomainChanged","isEdoRegion","isUnsecuredScheme","text","warning","setText","append","getContainer","register","changeDocument","getPages","map","page","fetch","blob","fileReader","FileReader","Event","bindOnce","readAsDataURL","removeFromServer","startIndex","pagesCount","sliced","slice","convertedPages","domainChangeButton","Button","color","Color","LINK","onclick","changeDomain","className","size","Size","EXTRA_SMALL","Alert","MD","WARNING","icon","Icon","DANGER","customClass","remove","alert","setColor","PRIMARY","setIcon","INFO"],"mappings":"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"}