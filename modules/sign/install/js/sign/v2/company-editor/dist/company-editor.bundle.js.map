{"version":3,"file":"company-editor.bundle.js","sources":["../src/types.js","../src/company-editor.js"],"sourcesContent":["export type CompanyEditorOptions = {\n\tdocumentEntityId: number;\n\tentityTypeId: number;\n\tguid: string;\n\tcompanyId?: string,\n\tmode?: string,\n\tshowOnlyCompany: boolean,\n\tevents?: {\n\t\tonCompanySavedHandler?: (companyId: number) => void,\n\t},\n\tlayoutTitle?: string,\n}\n\nexport const CompanyEditorMode: Record<string, string> = Object.freeze({\n\tEdit: 'edit',\n\tCreate: 'create',\n});\n\nexport const DocumentEntityTypeId: Record<string, number> = Object.freeze({\n\tB2b: 36,\n\tB2e: 39,\n});\n\nexport const EditorTypeGuid: Record<string, string> = Object.freeze({\n\tB2b: 'sign_b2b_entity_editor',\n\tB2e: 'sign_b2e_entity_editor',\n});\n","import { ajax, Dom, Runtime, Tag, Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Loader } from 'main.loader';\nimport { Layout } from 'ui.sidepanel.layout';\nimport type { CompanyEditorOptions } from './types';\nimport { CompanyEditorMode } from './types';\n\nconst crmEditorSettings = Object.freeze({\n\tparams: {\n\t\tENABLE_CONFIGURATION_UPDATE: 'N',\n\t\tENABLE_PAGE_TITLE_CONTROLS: false,\n\t\tENABLE_MODE_TOGGLE: false,\n\t\tIS_EMBEDDED: 'N',\n\t\tforceDefaultConfig: 'Y',\n\t\tenableSingleSectionCombining: 'N',\n\t},\n});\nconst entityEditorEvents = [\n\t'onCrmEntityUpdate',\n\t'BX.Crm.EntityEditor:onFailedValidation',\n\t'onCrmEntityUpdateError',\n\t'BX.Crm.EntityEditor:onEntitySaveFailure',\n];\n\nexport class CompanyEditor\n{\n\t#mode: string = CompanyEditorMode.Create;\n\n\t#documentEntityId: number;\n\t#guid: string;\n\t#entityTypeId: number;\n\t#companyId: ?number = null;\n\t#showOnlyCompany: boolean;\n\n\t#options: CompanyEditorOptions;\n\n\tconstructor(options: CompanyEditorOptions)\n\t{\n\t\tthis.#options = options;\n\t\tif (options?.mode === CompanyEditorMode.Edit && options?.companyId > 0)\n\t\t{\n\t\t\tthis.#mode = CompanyEditorMode.Edit;\n\t\t\tthis.#companyId = options.companyId;\n\t\t}\n\n\t\tthis.#documentEntityId = options.documentEntityId;\n\t\tthis.#entityTypeId = options.entityTypeId;\n\t\tthis.#guid = options.guid;\n\t\tthis.#showOnlyCompany = options.showOnlyCompany ?? false;\n\t}\n\n\tstatic openSlider(\n\t\toptions: CompanyEditorOptions,\n\t\tsliderOptions: { onCloseHandler: () => void },\n\t): void\n\t{\n\t\tBX.SidePanel.Instance.open('company-editor', {\n\t\t\twidth: 800,\n\t\t\tcacheable: false,\n\t\t\tcontentCallback: () => {\n\t\t\t\treturn top.BX.Runtime.loadExtension('sign.v2.company-editor')\n\t\t\t\t\t.then(({ CompanyEditor }) => new CompanyEditor(options).getLayout())\n\t\t\t\t;\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\tonClose: sliderOptions?.onCloseHandler ?? (() => {}),\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #loadEntityEditor(): Promise<string>\n\t{\n\t\tconst response = await ajax.runAction('crm.api.item.getEditor', {\n\t\t\tdata: {\n\t\t\t\t...crmEditorSettings,\n\t\t\t\tid: this.#documentEntityId,\n\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\tguid: this.#guid,\n\t\t\t},\n\t\t});\n\n\t\treturn response?.data?.html || '';\n\t}\n\n\tasync #showEntityEditor(container: HTMLElement): Promise<void>\n\t{\n\t\tconst loader = new Loader({\n\t\t\ttarget: container,\n\t\t\tsize: 80,\n\t\t});\n\n\t\ttry\n\t\t{\n\t\t\tloader.show();\n\t\t\tconst editorHtml = await this.#loadEntityEditor();\n\t\t\tawait Runtime.html(container, editorHtml);\n\t\t}\n\t\tfinally\n\t\t{\n\t\t\tloader.destroy();\n\t\t}\n\n\t\tif (this.#showOnlyCompany)\n\t\t{\n\t\t\tconst columnContent = container.querySelector('.ui-entity-editor-column-content');\n\t\t\tif (!Type.isDomNode(columnContent))\n\t\t\t{\n\t\t\t\tthis.#loadedHandler();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst companyNode = columnContent.querySelector('[data-cid=\"myCompany\"]');\n\t\t\tif (!Type.isDomNode(companyNode))\n\t\t\t{\n\t\t\t\tthis.#loadedHandler();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.clean(columnContent);\n\t\t\tDom.append(companyNode, columnContent);\n\n\t\t\tconst sectionHeader = columnContent.querySelector('.ui-entity-editor-section-header');\n\t\t\tif (Type.isDomNode(sectionHeader))\n\t\t\t{\n\t\t\t\tDom.remove(sectionHeader);\n\t\t\t}\n\t\t}\n\n\t\tthis.#loadedHandler();\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tconst container = Tag.render`<div style=\"position: relative; z-index: 1; height: 100%\"></div>`;\n\t\tthis.#showEntityEditor(container);\n\n\t\treturn container;\n\t}\n\n\tgetLayout(): Promise<HTMLElement>\n\t{\n\t\t// eslint-disable-next-line unicorn/no-this-assignment\n\t\tconst companyEditor = this;\n\n\t\treturn Layout.createContent({\n\t\t\ttitle: companyEditor.#options?.layoutTitle ?? '',\n\t\t\tcontent(): HTMLElement\n\t\t\t{\n\t\t\t\treturn companyEditor.render();\n\t\t\t},\n\t\t\tbuttons({ cancelButton, SaveButton })\n\t\t\t{\n\t\t\t\tconst saveButton = new SaveButton({\n\t\t\t\t\tonclick: async () => {\n\t\t\t\t\t\tsaveButton.setClocking(true);\n\t\t\t\t\t\tawait companyEditor.#save();\n\t\t\t\t\t\tsaveButton.setClocking(false);\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\treturn [\n\t\t\t\t\tsaveButton,\n\t\t\t\t\tcancelButton,\n\t\t\t\t];\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #save(): Promise<void>\n\t{\n\t\tconst promise = new Promise((resolve) => {\n\t\t\tconst [successFullEvent, ...errorEvents] = entityEditorEvents;\n\t\t\tEventEmitter.subscribeOnce(successFullEvent, (event) => {\n\t\t\t\tconst [{ entityData }] = event.data;\n\t\t\t\tresolve(entityData);\n\t\t\t});\n\t\t\terrorEvents.forEach((event) => {\n\t\t\t\tEventEmitter.subscribeOnce(event, () => resolve(null));\n\t\t\t});\n\t\t});\n\t\tBX.Crm.EntityEditor.getDefault().save();\n\t\tconst entityData = await promise;\n\t\tentityEditorEvents.forEach((event) => EventEmitter.unsubscribeAll(event));\n\t\tif (entityData)\n\t\t{\n\t\t\tconst {\n\t\t\t\tMYCOMPANY_ID_INFO: { COMPANY_DATA: [companyData] },\n\t\t\t} = entityData;\n\n\t\t\tif (Type.isFunction(this.#options?.events?.onCompanySavedHandler))\n\t\t\t{\n\t\t\t\tthis.#options.events.onCompanySavedHandler(companyData.id);\n\t\t\t}\n\n\t\t\tBX.SidePanel.Instance.close();\n\t\t}\n\t}\n\n\t#loadedHandler(): void\n\t{\n\t\tconst crmEditor = BX.Crm.EntityEditor.getDefault();\n\t\tif (Type.isNil(crmEditor))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tconst companyField = crmEditor.getControlById('MYCOMPANY_ID');\n\t\t// eslint-disable-next-line no-underscore-dangle\n\t\tconst [searchBox] = companyField._companySearchBoxes;\n\n\t\tif (this.#mode === CompanyEditorMode.Create)\n\t\t{\n\t\t\tcrmEditor.switchControlMode(companyField, BX.UI.EntityEditorMode.edit);\n\t\t\tsearchBox.setEntity(BX.CrmEntityInfo.create({\n\t\t\t\ttypeName: 'COMPANY',\n\t\t\t\ttitle: '',\n\t\t\t}), true);\n\t\t\t// eslint-disable-next-line no-underscore-dangle\n\t\t\tsearchBox._searchInput.value = '';\n\t\t\t// eslint-disable-next-line no-underscore-dangle\n\t\t\tDom.remove(searchBox._changeButton);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#mode === CompanyEditorMode.Edit)\n\t\t{\n\t\t\tconst deployEvent = 'BX.Crm.EntityEditor:onUserFieldsDeployed';\n\n\t\t\t// eslint-disable-next-line no-underscore-dangle\n\t\t\tsearchBox._searchInput.value = '';\n\t\t\tsearchBox.setEntityTypeName('COMPANY');\n\t\t\tsearchBox.setMode(BX.Crm.EntityEditorClientMode.loading);\n\t\t\tsearchBox.adjust();\n\t\t\tEventEmitter.unsubscribeAll(deployEvent);\n\t\t\tEventEmitter.subscribe(deployEvent, () => {\n\t\t\t\t// eslint-disable-next-line no-underscore-dangle\n\t\t\t\tDom.remove(searchBox._changeButton);\n\t\t\t});\n\t\t\tsearchBox.loadEntityInfo(String(this.#companyId));\n\t\t}\n\t}\n}\n"],"names":["CompanyEditorMode","Object","freeze","Edit","Create","DocumentEntityTypeId","B2b","B2e","EditorTypeGuid","crmEditorSettings","params","ENABLE_CONFIGURATION_UPDATE","ENABLE_PAGE_TITLE_CONTROLS","ENABLE_MODE_TOGGLE","IS_EMBEDDED","forceDefaultConfig","enableSingleSectionCombining","entityEditorEvents","async","response","ajax","runAction","data","id","this","entityTypeId","guid","_response$data","html","container","loader","Loader","target","size","show","editorHtml","Runtime","destroy","columnContent","querySelector","Type","isDomNode","babelHelpers","companyNode","Dom","clean","append","sectionHeader","remove","promise","Promise","resolve","successFullEvent","errorEvents","EventEmitter","subscribeOnce","event","entityData","forEach","BX","Crm","EntityEditor","getDefault","save","unsubscribeAll","MYCOMPANY_ID_INFO","COMPANY_DATA","companyData","isFunction","_babelHelpers$classPr3","events","_babelHelpers$classPr4","onCompanySavedHandler","SidePanel","Instance","close","crmEditor","isNil","companyField","getControlById","searchBox","_companySearchBoxes","switchControlMode","UI","EntityEditorMode","edit","setEntity","CrmEntityInfo","create","typeName","title","_searchInput","value","_changeButton","deployEvent","setEntityTypeName","setMode","EntityEditorClientMode","loading","adjust","subscribe","loadEntityInfo","String","constructor","options","writable","mode","companyId","documentEntityId","showOnlyCompany","[object Object]","sliderOptions","open","width","cacheable","contentCallback","top","loadExtension","then","CompanyEditor","getLayout","onClose","onCloseHandler","render","Tag","companyEditor","Layout","createContent","_babelHelpers$classPr2","layoutTitle","content","buttons","cancelButton","SaveButton","saveButton","onclick","setClocking"],"mappings":"yFAaaA,EAA4CC,OAAOC,OAAO,CACtEC,KAAM,OACNC,OAAQ,WAGIC,EAA+CJ,OAAOC,OAAO,CACzEI,IAAK,GACLC,IAAK,KAGOC,EAAyCP,OAAOC,OAAO,CACnEI,IAAK,yBACLC,IAAK,wCClBN,MAAME,EAAoBR,OAAOC,OAAO,CACvCQ,OAAQ,CACPC,4BAA6B,IAC7BC,4BAA4B,EAC5BC,oBAAoB,EACpBC,YAAa,IACbC,mBAAoB,IACpBC,6BAA8B,OAG1BC,EAAqB,CAC1B,oBACA,yCACA,yBACA,2CACC,umBA6NDC,mBA5KA,MACC,MAAMC,QAAiBC,OAAKC,UAAU,yBAA0B,CAC/DC,KAAM,IACFb,EACHc,2CAAIC,WACJC,qDAAcD,WACdE,6CAAMF,cAIR,aAAOL,YAAAA,EAAUG,aAAVK,EAAgBC,OAAQ,GAC/BV,iBAEuBW,GAEvB,MAAMC,EAAS,IAAIC,SAAO,CACzBC,OAAQH,EACRI,KAAM,KAGP,IAECH,EAAOI,OACP,MAAMC,gDAAmBX,mBACnBY,UAAQR,KAAKC,EAAWM,WAI9BL,EAAOO,UAGR,2CAAIb,WACJ,CACC,MAAMc,EAAgBT,EAAUU,cAAc,oCAC9C,IAAKC,OAAKC,UAAUH,GAInB,YAFAI,qDAKD,MAAMC,EAAcL,EAAcC,cAAc,0BAChD,IAAKC,OAAKC,UAAUE,GAInB,YAFAD,qDAKDE,MAAIC,MAAMP,GACVM,MAAIE,OAAOH,EAAaL,GAExB,MAAMS,EAAgBT,EAAcC,cAAc,oCAC9CC,OAAKC,UAAUM,IAElBH,MAAII,OAAOD,GAIbL,qDACAxB,mBAyCA,MAAM+B,EAAU,IAAIC,QAASC,IAC5B,MAAOC,KAAqBC,GAAepC,EAC3CqC,eAAaC,cAAcH,EAAmBI,IAC7C,OAAOC,WAAEA,IAAgBD,EAAMlC,KAC/B6B,EAAQM,KAETJ,EAAYK,QAASF,IACpBF,eAAaC,cAAcC,EAAO,IAAML,EAAQ,WAGlDQ,GAAGC,IAAIC,aAAaC,aAAaC,OACjC,MAAMN,QAAmBR,EAEzB,GADAhC,EAAmByC,QAASF,GAAUF,eAAaU,eAAeR,IAC9DC,EACJ,CAAA,QACC,MACCQ,mBAAqBC,cAAeC,KACjCV,EAEAjB,OAAK4B,4DAAW5C,sBAAA6C,EAAeC,eAAfC,EAAuBC,wBAE1C9B,mDAAc4B,OAAOE,sBAAsBL,EAAY5C,IAGxDoC,GAAGc,UAAUC,SAASC,SAEvB,aAIA,MAAMC,EAAYjB,GAAGC,IAAIC,aAAaC,aACtC,GAAItB,OAAKqC,MAAMD,GAEd,OAED,MAAME,EAAeF,EAAUG,eAAe,iBAEvCC,GAAaF,EAAaG,oBAEjC,GAAIvC,qDAAe1C,EAAkBI,OAYpC,OAVAwE,EAAUM,kBAAkBJ,EAAcnB,GAAGwB,GAAGC,iBAAiBC,MACjEL,EAAUM,UAAU3B,GAAG4B,cAAcC,OAAO,CAC3CC,SAAU,UACVC,MAAO,MACJ,GAEJV,EAAUW,aAAaC,MAAQ,QAE/BhD,MAAII,OAAOgC,EAAUa,eAKtB,GAAInD,qDAAe1C,EAAkBG,KACrC,CACC,MAAM2F,EAAc,2CAGpBd,EAAUW,aAAaC,MAAQ,GAC/BZ,EAAUe,kBAAkB,WAC5Bf,EAAUgB,QAAQrC,GAAGC,IAAIqC,uBAAuBC,SAChDlB,EAAUmB,SACV7C,eAAaU,eAAe8B,GAC5BxC,eAAa8C,UAAUN,EAAa,KAEnClD,MAAII,OAAOgC,EAAUa,iBAEtBb,EAAUqB,eAAeC,+CAAO9E,8BAxN5B,MAYN+E,YAAYC,GACZ,MAAAvG,8BAAA2F,UAAA3F,8BAAA2F,UAAA3F,8BAAA2F,UAAA3F,8BAAA2F,UAAA3F,8BAAAwG,YAAAb,MAXgB5F,EAAkBI,SAAMH,8BAAAwG,YAAAb,eAAA3F,8BAAAwG,YAAAb,eAAA3F,8BAAAwG,YAAAb,eAAA3F,8BAAAwG,YAAAb,MAKlB,OAAI3F,8BAAAwG,YAAAb,eAAA3F,8BAAAwG,YAAAb,eAOzBlD,mDAAgB8D,SACZA,SAAAA,EAASE,QAAS1G,EAAkBG,aAAQqG,SAAAA,EAASG,WAAY,IAEpEjE,mDAAa1C,EAAkBG,KAC/BuC,mDAAkB8D,EAAQG,WAG3BjE,mDAAyB8D,EAAQI,iBACjClE,mDAAqB8D,EAAQ/E,aAC7BiB,mDAAa8D,EAAQ9E,KACrBgB,4DAAwB8D,EAAQK,oBAGjCC,kBACCN,EACAO,GAED,MACCpD,GAAGc,UAAUC,SAASsC,KAAK,iBAAkB,CAC5CC,MAAO,IACPC,WAAW,EACXC,gBAAiB,IACTC,IAAIzD,GAAGvB,QAAQiF,cAAc,0BAClCC,KAAK,EAAGC,cAAAA,KAAoB,IAAIA,EAAcf,GAASgB,aAG1DlD,OAAQ,CACPmD,uBAASV,SAAAA,EAAeW,kBAAmB,UAoE9CC,SAEC,MAAM9F,EAAY+F,MAAID,cAAO,qEAG7B,OAFAjF,mDAAuBb,GAEhBA,EAGR2F,YACA,QAEC,MAAMK,EAAgBrG,KAEtB,OAAOsG,SAAOC,cAAc,CAC3BrC,gEAAOmC,gBAAAG,EAAwBC,eAAe,GAC9CC,QAAO,IAECL,EAAcF,SAEtBQ,SAAQC,aAAEA,EAAYC,WAAEA,IAEvB,MAAMC,EAAa,IAAID,EAAW,CACjCE,QAASrH,UACRoH,EAAWE,aAAY,iDACjBX,UACNS,EAAWE,aAAY,MAIzB,MAAO,CACNF,EACAF"}