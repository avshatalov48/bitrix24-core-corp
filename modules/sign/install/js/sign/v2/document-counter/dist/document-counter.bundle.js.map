{"version":3,"file":"document-counter.bundle.js","sources":["../src/filter.js","../src/index.js"],"sourcesContent":["import { Type } from 'main.core';\n\nexport class Filter\n{\n\t#filter: BX.Main.Filter;\n\n\tconstructor(options: Object)\n\t{\n\t\tthis.#filter = BX.Main.filterManager.getById(options.filterId);\n\t}\n\n\ttoggleField(name: string, value: string, resetAllFields: boolean): boolean\n\t{\n\t\tconst field = this.#filter.getFieldByName(name);\n\n\t\tif (!Type.isPlainObject(field) || field === null)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst items = value.split('_');\n\n\t\t// eslint-disable-next-line no-shadow\n\n\t\tconst filteredValues = field.ITEMS\n\t\t\t.filter((item) => items.includes(item.VALUE))\n\t\t\t.map((item) => item.VALUE)\n\t\t;\n\t\t// const fieldValue = field.ITEMS.find((item) => item.VALUE === value);\n\t\tif (filteredValues.length === 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.isFieldValueAlreadyApplied(name, filteredValues, resetAllFields))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (resetAllFields)\n\t\t{\n\t\t\tthis.#filter.getApi().setFields({});\n\t\t}\n\n\t\tthis.#filter.getApi().extendFilter({\n\t\t\t[name]: { ...filteredValues },\n\t\t});\n\n\t\treturn true;\n\t}\n\n\tgetFilterRows(): Array\n\t{\n\t\treturn this.#filter.getFilterFieldsValues();\n\t}\n\n\tdeactivate()\n\t{\n\t\tthis.#filter.getApi().setFields({});\n\t\tthis.#filter.getApi().apply();\n\t}\n\n\tisFieldValueAlreadyApplied(name: string, setValues: Array, withoutOtherFilters: boolean): boolean\n\t{\n\t\tconst filterRows = this.getFilterRows();\n\t\tconst currentValuesObject = filterRows[name];\n\t\tif (!Type.isObject(currentValuesObject))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (withoutOtherFilters && this.isSomeOtherFilterPresent(name))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst currentValuesArray = Object.values(currentValuesObject);\n\t\tfor (const setValue of setValues)\n\t\t{\n\t\t\tif (!currentValuesArray.includes(setValue))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (withoutOtherFilters)\n\t\t{\n\t\t\tfor (const currentValue of currentValuesArray)\n\t\t\t{\n\t\t\t\tif (!setValues.includes(currentValue))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tisSomeOtherFilterPresent(name: string): boolean\n\t{\n\t\tfor (const [key, value] of Object.entries(this.getFilterRows()))\n\t\t{\n\t\t\tconst isPresent = Type.isStringFilled(value) || Type.isArrayFilled(value);\n\t\t\tif (key !== name && isPresent)\n\t\t\t{\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n}\n","import { BaseEvent, EventEmitter } from 'main.core.events';\nimport { CounterPanel, CounterItem } from 'ui.counterpanel';\nimport { Type } from 'main.core';\nimport { Filter } from './filter';\n\nexport class DocumentCounter extends CounterPanel\n{\n\t#filter: Filter;\n\t#resetAllFields: boolean;\n\n\tconstructor(options: Object)\n\t{\n\t\tsuper({\n\t\t\ttarget: options.target,\n\t\t\titems: DocumentCounter.getCounterItems(options.items),\n\t\t\tmultiselect: false,\n\t\t\ttitle: options.title,\n\t\t});\n\n\t\tthis.#filter = new Filter({\n\t\t\tfilterId: options.filterId,\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:activate', this.#onActivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:deactivate', this.#onDeactivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t\tEventEmitter.subscribe('BX.Sign.DocumentCounter.Item:updateCounter', this.#onCounterUpdate.bind(this));\n\n\t\tthis.#resetAllFields = Boolean(options?.resetAllFields);\n\t}\n\n\tstatic getCounterItems(items: Array): Object[]\n\t{\n\t\treturn items.map((item) => {\n\t\t\treturn {\n\t\t\t\tid: item.id,\n\t\t\t\ttitle: item.title,\n\t\t\t\tvalue: Number.parseInt(item.value, 10),\n\t\t\t\tisRestricted: item.isRestricted,\n\t\t\t\tcolor: item.color === 'THEME' ? 'GRAY' : item.color,\n\t\t\t\thideValue: item.hideValue || false,\n\t\t\t\tisActive: item?.isActive === true,\n\t\t\t};\n\t\t});\n\t}\n\n\t#onActivateItem(event: BaseEvent): void\n\t{\n\t\tconst { name, value } = this.#getFieldData(event.getData());\n\n\t\tif (!this.#processItemSelection(name, value))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n\n\t#onDeactivateItem(event: BaseEvent): void\n\t{\n\t\tif (this.#isAllDeactivated())\n\t\t{\n\t\t\tthis.#filter.deactivate();\n\t\t}\n\t}\n\n\t#processItemSelection(name: string, value: string): boolean\n\t{\n\t\tthis.#filter.toggleField(name, value, this.#resetAllFields);\n\n\t\treturn true;\n\t}\n\n\t#getFieldData(item): Object\n\t{\n\t\tconst fieldData = item.id.split('__');\n\n\t\treturn {\n\t\t\tname: fieldData[0].toUpperCase(),\n\t\t\tvalue: fieldData[1].toUpperCase(),\n\t\t};\n\t}\n\n\t#isAllDeactivated(): Boolean\n\t{\n\t\treturn this.getItems().every((record: CounterItem) => {\n\t\t\treturn !record.isActive;\n\t\t});\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tlet compoundId = '';\n\t\tconst filterRows = this.#filter.getFilterRows();\n\t\tconst counterItemIds = new Set(this.items.map((item) => item.id.toLowerCase()));\n\n\t\tconst activeField = Object.entries(filterRows).find((row) => {\n\t\t\tif (!Type.isPlainObject(row[1]))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst values = Object.values(row[1]);\n\t\t\tconst result = [\n\t\t\t\trow[0],\n\t\t\t\tvalues.join('_'),\n\t\t\t];\n\n\t\t\tcompoundId = result.join('__').toLowerCase();\n\n\t\t\treturn counterItemIds.has(compoundId);\n\t\t});\n\n\t\tthis.getItems().forEach((item) => {\n\t\t\titem.deactivate(false);\n\t\t\tif (activeField && (item.id.toLowerCase() === compoundId))\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\titem.activate(false);\n\t\t\t}\n\t\t});\n\t}\n\n\t#onCounterUpdate(event: BaseEvent): void\n\t{\n\t\tconst { id, count } = event.getData();\n\t\tfor (const item: CounterItem of this.getItems())\n\t\t{\n\t\t\tif (item.id === id)\n\t\t\t{\n\t\t\t\titem.updateValue(count);\n\t\t\t\tconst color = count > 0 ? 'DANGER' : 'GRAY';\n\t\t\t\titem.updateColor(color);\n\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["Filter","constructor","options","BX","Main","filterManager","getById","filterId","toggleField","name","value","resetAllFields","field","getFieldByName","Type","isPlainObject","items","split","filteredValues","ITEMS","filter","item","includes","VALUE","map","length","isFieldValueAlreadyApplied","getApi","setFields","extendFilter","getFilterRows","getFilterFieldsValues","deactivate","apply","setValues","withoutOtherFilters","filterRows","currentValuesObject","isObject","isSomeOtherFilterPresent","currentValuesArray","Object","values","setValue","currentValue","key","entries","isPresent","isStringFilled","isArrayFilled","DocumentCounter","CounterPanel","target","getCounterItems","multiselect","title","EventEmitter","subscribe","bind","Boolean","id","Number","parseInt","isRestricted","color","hideValue","isActive","event","getData","preventDefault","fieldData","toUpperCase","getItems","every","record","compoundId","counterItemIds","Set","toLowerCase","activeField","find","row","result","join","has","forEach","activate","count","updateValue","updateColor"],"mappings":"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"}