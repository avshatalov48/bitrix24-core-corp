{"version":3,"file":"document-counter.bundle.js","sources":["../src/filter.js","../src/index.js"],"sourcesContent":["import { Type } from 'main.core';\n\nexport class Filter\n{\n\t#filter: BX.Main.Filter;\n\n\tconstructor(options: Object)\n\t{\n\t\tthis.#filter = BX.Main.filterManager.getById(options.filterId);\n\t}\n\n\ttoggleField(name: string, value: string): boolean\n\t{\n\t\tconst field = this.#filter.getFieldByName(name);\n\n\t\tif (!Type.isPlainObject(field) || field === null)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst items = value.split('_');\n\n\t\t// eslint-disable-next-line no-shadow\n\n\t\tconst filteredValues = field.ITEMS\n\t\t\t.filter((item) => items.includes(item.VALUE))\n\t\t\t.map((item) => item.VALUE)\n\t\t;\n\t\t// const fieldValue = field.ITEMS.find((item) => item.VALUE === value);\n\t\tif (filteredValues.length === 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.#filter.getApi().extendFilter({\n\t\t\t[name]: { ...filteredValues },\n\t\t});\n\n\t\treturn true;\n\t}\n\n\tgetFilterRows(): Array\n\t{\n\t\treturn this.#filter.getFilterFieldsValues();\n\t}\n\n\tdeactivate()\n\t{\n\t\tthis.#filter.getApi().setFields({});\n\t\tthis.#filter.getApi().apply();\n\t}\n}\n","import { BaseEvent, EventEmitter } from 'main.core.events';\nimport { CounterPanel, CounterItem } from 'ui.counterpanel';\nimport { Type } from 'main.core';\nimport { Filter } from './filter';\n\nexport class DocumentCounter extends CounterPanel\n{\n\t#filter: Filter;\n\n\tconstructor(options: Object)\n\t{\n\t\tsuper({\n\t\t\ttarget: options.target,\n\t\t\titems: DocumentCounter.getCounterItems(options.items),\n\t\t\tmultiselect: false,\n\t\t\ttitle: options.title,\n\t\t});\n\n\t\tthis.#filter = new Filter({\n\t\t\tfilterId: options.filterId,\n\t\t});\n\n\t\tthis.active = false;\n\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:activate', this.#onActivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:deactivate', this.#onDeactivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t}\n\n\tstatic getCounterItems(items: Array)\n\t{\n\t\treturn items.map((item) => {\n\t\t\treturn {\n\t\t\t\tid: item.id,\n\t\t\t\ttitle: item.title,\n\t\t\t\tvalue: Number.parseInt(item.value, 10),\n\t\t\t\tisRestricted: item.isRestricted,\n\t\t\t\tcolor: item.color === 'THEME' ? 'GRAY' : item.color,\n\t\t\t\thideValue: item.hideValue || false,\n\t\t\t};\n\t\t});\n\t}\n\n\t#onActivateItem(event: BaseEvent): void\n\t{\n\t\tconst { name, value } = this.#getFieldData(event.getData());\n\n\t\tif (!this.#processItemSelection(name, value))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n\n\t#onDeactivateItem(event: BaseEvent): void\n\t{\n\t\tif (this.#isAllDeactivated())\n\t\t{\n\t\t\tthis.#filter.deactivate();\n\t\t}\n\t}\n\n\t#processItemSelection(name: string, value: string): boolean\n\t{\n\t\tthis.#filter.toggleField(name, value);\n\n\t\treturn true;\n\t}\n\n\t#getFieldData(item): Object\n\t{\n\t\tconst fieldData = item.id.split('__');\n\n\t\treturn {\n\t\t\tname: fieldData[0].toUpperCase(),\n\t\t\tvalue: fieldData[1].toUpperCase(),\n\t\t};\n\t}\n\n\t#isAllDeactivated(): Boolean\n\t{\n\t\treturn this.getItems().every((record: CounterItem) => {\n\t\t\treturn !record.isActive;\n\t\t});\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tlet compoundId = '';\n\t\tconst filterRows = this.#filter.getFilterRows();\n\t\tconst counterItemIds = new Set(this.items.map((item) => item.id.toLowerCase()));\n\n\t\tconst activeField = Object.entries(filterRows).find((row) => {\n\t\t\tif (!Type.isPlainObject(row[1]))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst values = Object.values(row[1]);\n\t\t\tconst result = [\n\t\t\t\trow[0],\n\t\t\t\tvalues.join('_'),\n\t\t\t];\n\n\t\t\tcompoundId = result.join('__').toLowerCase();\n\n\t\t\treturn counterItemIds.has(compoundId);\n\t\t});\n\n\t\tthis.getItems().forEach((item) => {\n\t\t\titem.deactivate(false);\n\t\t\tif (activeField && (item.id.toLowerCase() === compoundId))\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\titem.activate(false);\n\t\t\t}\n\t\t});\n\t}\n}\n"],"names":["Filter","constructor","options","BX","Main","filterManager","getById","filterId","toggleField","name","value","field","getFieldByName","Type","isPlainObject","items","split","filteredValues","ITEMS","filter","item","includes","VALUE","map","length","getApi","extendFilter","getFilterRows","getFilterFieldsValues","deactivate","setFields","apply","DocumentCounter","CounterPanel","target","getCounterItems","multiselect","title","active","EventEmitter","subscribe","bind","id","Number","parseInt","isRestricted","color","hideValue","event","getData","preventDefault","fieldData","toUpperCase","getItems","every","record","isActive","compoundId","filterRows","counterItemIds","Set","toLowerCase","activeField","Object","entries","find","row","values","result","join","has","forEach","activate"],"mappings":"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"}