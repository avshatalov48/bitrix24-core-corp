this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,t,s,i,a,l){"use strict";let o=e=>e,r,n,d;const c={entityTypeId:36,guid:"sign_entity_editor",params:{ENABLE_CONFIGURATION_UPDATE:"N",ENABLE_PAGE_TITLE_CONTROLS:false,ENABLE_MODE_TOGGLE:true,IS_EMBEDDED:"N",forceDefaultConfig:"Y",enableSingleSectionCombining:"N"}};const b="company";const u="contact";const v=["onCrmEntityUpdate","BX.Crm.EntityEditor:onFailedValidation","onCrmEntityUpdateError","BX.Crm.EntityEditor:onEntitySaveFailure"];var p=babelHelpers.classPrivateFieldLooseKey("requisitesNode");var y=babelHelpers.classPrivateFieldLooseKey("initiatorNode");var h=babelHelpers.classPrivateFieldLooseKey("api");var P=babelHelpers.classPrivateFieldLooseKey("editors");var B=babelHelpers.classPrivateFieldLooseKey("members");var L=babelHelpers.classPrivateFieldLooseKey("loadEntityEditor");var m=babelHelpers.classPrivateFieldLooseKey("showEntityEditor");var E=babelHelpers.classPrivateFieldLooseKey("getMembersData");var F=babelHelpers.classPrivateFieldLooseKey("saveEditor");var I=babelHelpers.classPrivateFieldLooseKey("addMembers");var H=babelHelpers.classPrivateFieldLooseKey("removeMembers");var f=babelHelpers.classPrivateFieldLooseKey("loadMembers");var g=babelHelpers.classPrivateFieldLooseKey("getRequisiteData");var _=babelHelpers.classPrivateFieldLooseKey("toggleCompany");var C=babelHelpers.classPrivateFieldLooseKey("toggleContact");var w=babelHelpers.classPrivateFieldLooseKey("toggleEntity");class D extends s.EventEmitter{constructor(){super();Object.defineProperty(this,w,{value:U});Object.defineProperty(this,C,{value:R});Object.defineProperty(this,_,{value:K});Object.defineProperty(this,g,{value:j});Object.defineProperty(this,f,{value:X});Object.defineProperty(this,H,{value:A});Object.defineProperty(this,I,{value:S});Object.defineProperty(this,F,{value:M});Object.defineProperty(this,E,{value:N});Object.defineProperty(this,m,{value:T});Object.defineProperty(this,L,{value:O});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});this.setEventNamespace("BX.Sign.V2.Requisites");babelHelpers.classPrivateFieldLooseBase(this,p)[p]=t.Tag.render(r||(r=o`
			<div class="sign-wizard__requisites"></div>
		`));babelHelpers.classPrivateFieldLooseBase(this,y)[y]=t.Tag.render(n||(n=o`
			<input type="text" class="ui-ctl-element" />
		`));babelHelpers.classPrivateFieldLooseBase(this,h)[h]=new a.Api;this.documentData={};babelHelpers.classPrivateFieldLooseBase(this,B)[B]={};babelHelpers.classPrivateFieldLooseBase(this,P)[P]={}}getLayout(){babelHelpers.classPrivateFieldLooseBase(this,y)[y].value=t.Text.encode(this.documentData.initiator);t.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,y)[y],"change",(({target:e})=>{this.emit("changeInitiator",{initiator:e.value})}));const e=t.Tag.render(d||(d=o`
			<div class="sign-wizard__preparing">
				<div class="sign-wizard__first-party_responsible">
					<span class="sign-wizard__first-party_responsible-title">
						${0}
						<span data-hint="${0}"></span>
					</span>
					<div class="ui-ctl ui-ctl-textbox sign-wizard__first-party_responsible-name">
						${0}
					</div>
				</div>
				${0}
			</div>
		`),t.Loc.getMessage("SIGN_PARTY_RESPONSIBLE_TITLE"),t.Loc.getMessage("SIGN_PARTY_RESPONSIBLE_HINT"),babelHelpers.classPrivateFieldLooseBase(this,y)[y],babelHelpers.classPrivateFieldLooseBase(this,p)[p]);l.Hint.create(e);babelHelpers.classPrivateFieldLooseBase(this,m)[m]();return e}checkInitiator(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].parentNode;if(!e){t.Dom.addClass(s,"ui-ctl-warning");babelHelpers.classPrivateFieldLooseBase(this,y)[y].focus();return false}t.Dom.removeClass(s,"ui-ctl-warning");return true}async processMembers(){const e=await babelHelpers.classPrivateFieldLooseBase(this,F)[F]();if(!e){return null}try{const{uid:t=""}=this.documentData;if(!babelHelpers.classPrivateFieldLooseBase(this,B)[B][t]){await babelHelpers.classPrivateFieldLooseBase(this,f)[f](t)}const{MYCOMPANY_ID_INFO:{COMPANY_DATA:[s]},CLIENT_INFO:{CONTACT_DATA:[i]},REQUISITE_BINDING:{REQUISITE_ID:a}}=e;const l=s.id;const o=i.id;const r=babelHelpers.classPrivateFieldLooseBase(this,g)[g](s);const n=babelHelpers.classPrivateFieldLooseBase(this,g)[g](i,a);const d=babelHelpers.classPrivateFieldLooseBase(this,B)[B][t];const c=d==null?void 0:d.filter(((e,t)=>{const s=e.entityId;if(t===0){return s!==l}return s!==o}));const b=babelHelpers.classPrivateFieldLooseBase(this,E)[E](s,i);const u={company:{...b[0],...r,part:1},contact:{...b[1],...n,part:2}};if(d){if(c.length===0){const[e,t]=d;u.company.uid=e.uid;u.contact.uid=t.uid;return u}await babelHelpers.classPrivateFieldLooseBase(this,H)[H](c)}const[v,p]=await babelHelpers.classPrivateFieldLooseBase(this,I)[I](t,{companyPresetId:r.presetId,contactPresetId:n.presetId,companyEntityId:l,contactEntityId:o});u.company.uid=v;u.contact.uid=p;return u}catch{return null}}}async function O(){const e=new i.Loader({target:babelHelpers.classPrivateFieldLooseBase(this,p)[p],size:80});try{var s;e.show();const i=await t.ajax.runAction("crm.api.item.getEditor",{data:{...c,id:this.documentData.entityId}});e.destroy();return(i==null?void 0:(s=i.data)==null?void 0:s.html)||""}catch(t){console.error(t);e.destroy();return""}}async function T(){t.Dom.clean(babelHelpers.classPrivateFieldLooseBase(this,p)[p]);const e=this.documentData.entityId;if(babelHelpers.classPrivateFieldLooseBase(this,P)[P][e]){const t=babelHelpers.classPrivateFieldLooseBase(this,P)[P][e].getContainer();babelHelpers.classPrivateFieldLooseBase(this,p)[p].appendChild(t)}else{const s=await babelHelpers.classPrivateFieldLooseBase(this,L)[L]();await t.Runtime.html(babelHelpers.classPrivateFieldLooseBase(this,p)[p],s);const i=t.Reflection.getClass("BX.Crm.EntityEditor");babelHelpers.classPrivateFieldLooseBase(this,P)[P]={...babelHelpers.classPrivateFieldLooseBase(this,P)[P],[e]:i.defaultInstance}}babelHelpers.classPrivateFieldLooseBase(this,_)[_]();babelHelpers.classPrivateFieldLooseBase(this,C)[C]()}function N(e,t){return[e,t].map((e=>{var t;const{id:s,title:i,url:a,advancedInfo:l,type:o}=e;const r=(t=l==null?void 0:l.multiFields)!=null?t:[];return{id:s,title:i,url:a,type:o,multiFields:r}}))}async function M(){if(!babelHelpers.classPrivateFieldLooseBase(this,P)[P][this.documentData.entityId]){return null}const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P][this.documentData.entityId];const t=e.getControlById("CLIENT");if(t!=null&&t.isInViewMode()&&!t.hasContentToDisplay()){return null}const i=new Promise((e=>{const[t,...i]=v;s.EventEmitter.subscribeOnce(t,(t=>{const[{entityData:s}]=t.data;e(s)}));i.forEach((t=>{s.EventEmitter.subscribeOnce(t,(()=>e(null)))}))}));e.save();const a=await i;v.forEach((e=>s.EventEmitter.unsubscribeAll(e)));return a}async function S(e,t){var s,i,a;const{companyEntityId:l,contactEntityId:o,companyPresetId:r,contactPresetId:n}=t;const d=(s=babelHelpers.classPrivateFieldLooseBase(this,B)[B][e])!=null?s:[];const c=((i=d[0])==null?void 0:i.entityId)===l;const v=((a=d[1])==null?void 0:a.entityId)===o;const p=c?Promise.resolve({uid:d[0].uid}):babelHelpers.classPrivateFieldLooseBase(this,h)[h].addMember(e,b,l,1,r);const y=v?Promise.resolve({uid:d[1].uid}):babelHelpers.classPrivateFieldLooseBase(this,h)[h].addMember(e,u,o,2,n);const[P,L]=await Promise.all([p,y]);babelHelpers.classPrivateFieldLooseBase(this,B)[B]={...babelHelpers.classPrivateFieldLooseBase(this,B)[B],[e]:[{entityId:l,uid:P.uid},{entityId:o,uid:L.uid}]};return[P.uid,L.uid]}async function A(e=[]){await Promise.all([e.map((e=>babelHelpers.classPrivateFieldLooseBase(this,h)[h].removeMember(e.uid)))])}async function X(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadMembers(e);t.forEach((t=>{var s;babelHelpers.classPrivateFieldLooseBase(this,B)[B][e]=[...(s=babelHelpers.classPrivateFieldLooseBase(this,B)[B][e])!=null?s:[],{entityId:t.entityId,uid:t.uid}]}))}function j(e,t=null){var s;const{requisiteData:i}=e.advancedInfo;const a=(s=i.find((e=>{if(t!==null){return t===e.requisiteId}return e.selected===true})))!=null?s:{};const{entityTypeId:l=0,presetId:o=0}=a;return{entityTypeId:l,presetId:o}}function K(){const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P][this.documentData.entityId];const t=e.getControlById("MYCOMPANY_ID");const s=e.getControlById("myCompany");if(!t){return}babelHelpers.classPrivateFieldLooseBase(this,w)[w](t,s)}function R(){const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P][this.documentData.entityId];const t=e.getControlById("CLIENT");const s=e.getControlById("client");if(!t){return}babelHelpers.classPrivateFieldLooseBase(this,w)[w](t,s)}function U(e,s){const i=e.switchToSingleEditMode;const a=babelHelpers.classPrivateFieldLooseBase(this,P)[P][this.documentData.entityId];e.isRequired=()=>true;e.switchToSingleEditMode=(...t)=>{if((s==null?void 0:s.getMode())===BX.UI.EntityEditorMode.view){a.switchControlMode(s,BX.UI.EntityEditorMode.edit)}i.apply(e,t)};const l=e.layout;e.layout=(...s)=>{l.apply(e,s);t.Dom.remove(e._addContactButton)};const o=e.getId()==="CLIENT"?e.hasContacts():e.hasCompanies();if(o&&(s==null?void 0:s.getMode())===BX.UI.EntityEditorMode.edit){a.switchControlMode(s,BX.UI.EntityEditorMode.view);return}s==null?void 0:s.enableToggling(false);t.Dom.remove(e._addContactButton)}e.Requisites=D})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX,BX.Sign.V2,BX.Sign.V2);
//# sourceMappingURL=requisites.bundle.map.js