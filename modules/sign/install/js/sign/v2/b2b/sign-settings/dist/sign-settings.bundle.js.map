{"version":3,"file":"sign-settings.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Loc } from 'main.core';\nimport { DocumentSend } from 'sign.v2.b2b.document-send';\nimport { Requisites } from 'sign.v2.b2b.requisites';\nimport { DocumentSetup } from 'sign.v2.document-setup';\nimport { decorateResultBeforeCompletion, type SignOptions, SignSettings } from 'sign.v2.sign-settings';\nimport type { Metadata } from 'ui.wizard';\n\nexport class B2BSignSettings extends SignSettings\n{\n\t#requisites: Requisites;\n\n\tconstructor(containerId: string, signOptions: SignOptions)\n\t{\n\t\tsuper(containerId, signOptions);\n\t\tconst { config, chatId = 0 } = signOptions;\n\t\tconst { blankSelectorConfig, documentSendConfig } = config;\n\t\tblankSelectorConfig.chatId = chatId;\n\t\tthis.documentSetup = new DocumentSetup(blankSelectorConfig);\n\t\tthis.documentSend = new DocumentSend(documentSendConfig);\n\t\tthis.#requisites = new Requisites();\n\t\tthis.isB2bSignMaster = true;\n\t\tthis.subscribeOnEvents();\n\t}\n\n\tasync applyDocumentData(uid: string): Promise<boolean>\n\t{\n\t\tconst applied = Boolean(await this.setupDocument(uid));\n\t\tif (!applied)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst { setupData } = this.documentSetup;\n\t\tthis.#requisites.documentData = setupData;\n\t\tthis.editor.documentData = setupData;\n\t\tthis.#sendAnalyticsOnDocumentApply(setupData.id);\n\n\t\tthis.documentsGroup.set(setupData.uid, setupData);\n\n\t\treturn true;\n\t}\n\n\tgetStepsMetadata(signSettings: B2BSignSettings, documentUid: ?string): Metadata\n\t{\n\t\tthis.#sendAnalyticsOnStart(documentUid);\n\t\tconst steps = {\n\t\t\tsetup: {\n\t\t\t\tget content(): HTMLElement {\n\t\t\t\t\treturn signSettings.documentSetup.layout;\n\t\t\t\t},\n\t\t\t\ttitle: Loc.getMessage('SIGN_SETTINGS_B2B_LOAD_DOCUMENT'),\n\t\t\t\tbeforeCompletion: async () => {\n\t\t\t\t\tconst setupData = await this.setupDocument();\n\t\t\t\t\tif (!setupData)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\tthis.setSingleDocument(setupData);\n\n\t\t\t\t\tconst { uid, entityId, initiator } = setupData;\n\t\t\t\t\tthis.#requisites.documentData = { uid, entityId, initiator };\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t},\n\t\t\trequisites: {\n\t\t\t\tget content(): HTMLElement {\n\t\t\t\t\treturn signSettings.#requisites.getLayout();\n\t\t\t\t},\n\t\t\t\ttitle: Loc.getMessage('SIGN_SETTINGS_B2B_PREPARING_DOCUMENT'),\n\t\t\t\tbeforeCompletion: async () => {\n\t\t\t\t\tconst { uid, isTemplate, title, initiator, initiatedByType } = this.documentSetup.setupData;\n\t\t\t\t\tconst valid = this.#requisites.checkInitiator(initiator);\n\t\t\t\t\tif (!valid)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst entityData = await this.#requisites.processMembers();\n\t\t\t\t\tif (!entityData)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst blocks = await this.documentSetup.loadBlocks(uid);\n\t\t\t\t\tthis.editor.documentData = { isTemplate, uid, blocks };\n\t\t\t\t\tthis.editor.entityData = entityData;\n\t\t\t\t\tthis.editor.setSenderType(initiatedByType);\n\t\t\t\t\tthis.documentSend.documentData = { uid, title, blocks, initiator };\n\t\t\t\t\tthis.documentSend.entityData = entityData;\n\t\t\t\t\tawait this.editor.waitForPagesUrls();\n\t\t\t\t\tawait this.editor.renderDocument();\n\t\t\t\t\tthis.wizard.toggleBtnLoadingState('next', false);\n\t\t\t\t\tawait this.editor.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t},\n\t\t\tsend: {\n\t\t\t\tget content(): HTMLElement {\n\t\t\t\t\treturn signSettings.documentSend.getLayout();\n\t\t\t\t},\n\t\t\t\ttitle: Loc.getMessage('SIGN_SETTINGS_SEND_DOCUMENT'),\n\t\t\t\tbeforeCompletion: () => {\n\t\t\t\t\treturn this.documentSend.sendForSign();\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\tthis.#decorateStepsBeforeCompletionWithAnalytics(steps);\n\n\t\treturn steps;\n\t}\n\n\tsubscribeOnEvents()\n\t{\n\t\tsuper.subscribeOnEvents();\n\t\tthis.#requisites.subscribe('changeInitiator', ({ data }) => {\n\t\t\tthis.documentSetup.setupData = {\n\t\t\t\t...this.documentSetup.setupData,\n\t\t\t\tinitiator: data.initiator,\n\t\t\t};\n\t\t});\n\t}\n\n\t#decorateStepsBeforeCompletionWithAnalytics(steps: Metadata): Metadata\n\t{\n\t\tconst analytics = this.getAnalytics();\n\t\tsteps.send.beforeCompletion = decorateResultBeforeCompletion(\n\t\t\tsteps.send.beforeCompletion,\n\t\t\t() => {\n\t\t\t\tanalytics.sendWithDocId(\n\t\t\t\t\t{\n\t\t\t\t\t\tevent: 'sent_document_to_sign',\n\t\t\t\t\t\tstatus: 'success',\n\t\t\t\t\t},\n\t\t\t\t\tthis.documentSend.documentData.uid,\n\t\t\t\t);\n\t\t\t},\n\t\t\t() => {\n\t\t\t\tanalytics.send({\n\t\t\t\t\tevent: 'sent_document_to_sign',\n\t\t\t\t\tstatus: 'error',\n\t\t\t\t});\n\t\t\t},\n\t\t);\n\t}\n\n\t#sendAnalyticsOnStart(): void\n\t{\n\t\tconst analytics = this.getAnalytics();\n\n\t\tif (!this.isEditMode())\n\t\t{\n\t\t\tanalytics.send({\n\t\t\t\tevent: 'click_create_document',\n\t\t\t});\n\t\t}\n\t}\n\n\t#sendAnalyticsOnDocumentApply(documentId: number): void\n\t{\n\t\tthis.getAnalytics().sendWithDocId(\n\t\t\t{\n\t\t\t\tevent: 'click_create_document',\n\t\t\t},\n\t\t\tdocumentId,\n\t\t);\n\t}\n}\n"],"names":["B2BSignSettings","SignSettings","constructor","containerId","signOptions","config","chatId","blankSelectorConfig","documentSendConfig","documentSetup","DocumentSetup","documentSend","DocumentSend","Requisites","isB2bSignMaster","subscribeOnEvents","applyDocumentData","uid","applied","Boolean","setupDocument","setupData","documentData","editor","id","documentsGroup","set","getStepsMetadata","signSettings","documentUid","steps","setup","content","layout","title","Loc","getMessage","beforeCompletion","setSingleDocument","entityId","initiator","requisites","getLayout","isTemplate","initiatedByType","valid","checkInitiator","entityData","processMembers","blocks","loadBlocks","setSenderType","waitForPagesUrls","renderDocument","wizard","toggleBtnLoadingState","show","send","sendForSign","subscribe","data","analytics","getAnalytics","decorateResultBeforeCompletion","sendWithDocId","event","status","isEditMode","documentId"],"mappings":"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"}