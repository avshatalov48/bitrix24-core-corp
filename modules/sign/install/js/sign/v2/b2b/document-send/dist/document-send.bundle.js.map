{"version":3,"file":"document-send.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Dom, Loc, Reflection, Tag, Text, Type } from 'main.core';\nimport { EventEmitter, type BaseEvent } from 'main.core.events';\nimport { MenuManager } from 'main.popup';\nimport { Api } from 'sign.v2.api';\nimport { Hint } from 'sign.v2.helper';\nimport { LangSelector } from 'sign.v2.lang-selector';\nimport { DocumentSummary } from 'sign.v2.document-summary';\nimport './style.css';\nimport type { DocumentSendConfig, DocumentData } from './types/config';\n\nconst menuPrefix = 'sign-member-communication';\n\nexport type { DocumentSendConfig };\n\nexport class DocumentSend extends EventEmitter\n{\n\tentityData;\n\tcommunications;\n\t#api: Api;\n\t#menus: Array<Menu>;\n\t#sendContainer: HTMLElement;\n\t#documentData: DocumentData;\n\t#langContainer: HTMLElement;\n\t#config: DocumentSendConfig;\n\t#langSelector: LangSelector;\n\t#documentSummary: DocumentSummary;\n\n\tconstructor(config: DocumentSendConfig)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Sign.V2.DocumentSend');\n\t\tthis.entityData = {};\n\t\tthis.communications = {};\n\t\tthis.#config = config;\n\t\tthis.#api = new Api();\n\t\tthis.#langSelector = new LangSelector(\n\t\t\tthis.#config.region,\n\t\t\tthis.#config.languages,\n\t\t);\n\t\tthis.#documentSummary = new DocumentSummary({\n\t\t\tevents: {\n\t\t\t\tchangeTitle: (event: BaseEvent) => {\n\t\t\t\t\tconst data = event.getData();\n\t\t\t\t\tthis.#documentData.title = data.title;\n\t\t\t\t\tthis.emit('changeTitle', data);\n\t\t\t\t},\n\t\t\t\tshowEditor: (event: BaseEvent) => this.emit('showEditor'),\n\t\t\t},\n\t\t});\n\t\tthis.#langContainer = Tag.render`\n\t\t\t<div class=\"sign-document-send__lang-container\">\n\t\t\t\t${this.#langSelector.getLayout()}\n\t\t\t\t<span data-hint=\"${Loc.getMessage('SIGN_DOCUMENT_LANGUAGE_BUTTON_INFO')}\"></span>\n\t\t\t</div>\n\t\t`;\n\t\tHint.create(this.#langContainer);\n\t\tthis.#menus = [];\n\t\tthis.#documentData = {};\n\t}\n\n\tget documentData(): DocumentData\n\t{\n\t\treturn this.#documentData;\n\t}\n\n\tset documentData(documentData: DocumentData)\n\t{\n\t\tconst { uid, title } = documentData;\n\t\tthis.#documentSummary.addItem(uid, { uid, title });\n\n\t\tthis.#documentData = documentData;\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tthis.#langSelector.setDocumentUid(this.#documentData.uid);\n\t\tthis.#sendContainer = Tag.render`\n\t\t\t<div class=\"sign-document-send\">\n\t\t\t\t<div class=\"sign-document-send__summary-title-wrapper\">\n\t\t\t\t\t<p class=\"sign-document-send__title\">\n\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_SEND_TITLE')}\n\t\t\t\t\t</p>\n\t\t\t\t\t${this.#langContainer}\n\t\t\t\t</div>\n\t\t\t\t${this.#documentSummary.getLayout()}\n\t\t\t\t${this.#createParties()}\n\t\t\t</div>\n\t\t`;\n\n\t\treturn this.#sendContainer;\n\t}\n\n\t#attachMenu(idMeans: HTMLElement, entityData): Menu\n\t{\n\t\tlet menuItems = [];\n\t\tconst menuId = `${menuPrefix}-${entityData.entityTypeId}-${entityData.id}`;\n\t\tif (this.#menus[menuId])\n\t\t{\n\t\t\tlet items = this.#menus[menuId].getMenuItems();\n\t\t\tconst swap = (array, from, to) => {\n\t\t\t\tconst tmp = array[to];\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\tarray[to] = array[from];\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\tarray[from] = tmp;\n\t\t\t};\n\n\t\t\twhile (items.length > 1)\n\t\t\t{\n\t\t\t\tif (items[0].id === 'show-member')\n\t\t\t\t{\n\t\t\t\t\tswap(items, 0, 1);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis.#menus[menuId].removeMenuItem(items[0].id);\n\t\t\t\titems = this.#menus[menuId].getMenuItems();\n\t\t\t}\n\t\t}\n\n\t\tthis.#api.loadCommunications(entityData.uid).then(async (multiFields) => {\n\t\t\tlet selectedCommunication = {};\n\t\t\tconst restrictions = await this.#api.loadRestrictions();\n\t\t\tconst mapper = (communication) => {\n\t\t\t\tlet text = communication.VALUE;\n\t\t\t\tif (communication?.TYPE === 'PHONE' && BX.PhoneNumberParser)\n\t\t\t\t{\n\t\t\t\t\tBX.PhoneNumberParser.getInstance().parse(communication.VALUE).then((parsedNumber) => {\n\t\t\t\t\t\ttext = parsedNumber.format(BX.PhoneNumber.Format.INTERNATIONAL);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif ((communication?.TYPE === 'PHONE' && restrictions.smsAllowed && selectedCommunication?.TYPE !== 'PHONE')\n\t\t\t\t\t|| (communication?.TYPE === 'EMAIL' && Object.keys(selectedCommunication).length === 0))\n\t\t\t\t{\n\t\t\t\t\tselectedCommunication = communication;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\ttext,\n\t\t\t\t\tonclick: ({ target }) => {\n\t\t\t\t\t\tthis.#updateCommunications(entityData, communication);\n\t\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\t\tidMeans.firstElementChild.textContent = text;\n\t\t\t\t\t\tthis.#menus[menuId].close();\n\t\t\t\t\t\tthis.#updatePhoneAttr(idMeans, communication?.TYPE === 'PHONE' ? communication.VALUE : null);\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t};\n\n\t\t\tmenuItems = [\n\t\t\t\t// eslint-disable-next-line no-unsafe-optional-chaining\n\t\t\t\t...(multiFields?.EMAIL ? multiFields?.EMAIL.map((element) => mapper(element)) : []),\n\t\t\t\t// eslint-disable-next-line no-unsafe-optional-chaining\n\t\t\t\t...(multiFields?.PHONE ? await Promise.all(multiFields?.PHONE.map(async (element) => {\n\t\t\t\t\tconst item = mapper(element);\n\t\t\t\t\titem.text = await this.#formatPhoneNumberForUi(item.text);\n\n\t\t\t\t\treturn item;\n\t\t\t\t})) : []),\n\t\t\t];\n\n\t\t\tmenuItems.map((item) => this.#menus[menuId].addMenuItem(item, null));\n\t\t\tthis.#updateCommunications(entityData, selectedCommunication);\n\n\t\t\tidMeans.firstElementChild.textContent = selectedCommunication?.TYPE === 'PHONE'\n\t\t\t\t? await this.#formatPhoneNumberForUi(selectedCommunication?.VALUE)\n\t\t\t\t: selectedCommunication?.VALUE\n\t\t\t;\n\n\t\t\tthis.#updatePhoneAttr(idMeans, selectedCommunication?.TYPE === 'PHONE' ? selectedCommunication?.VALUE : null);\n\t\t}).catch(() => {});\n\n\t\tmenuItems.push({\n\t\t\tid: 'show-member',\n\t\t\ttext: Loc.getMessage('SIGN_DOCUMENT_SEND_OPEN_VIEW'),\n\t\t\tonclick: () => {\n\t\t\t\tthis.#showMemberInfo(idMeans, entityData);\n\t\t\t\tthis.#menus[menuId].close();\n\t\t\t},\n\t\t});\n\n\t\tif (!this.#menus[menuId])\n\t\t{\n\t\t\tthis.#menus[menuId] = MenuManager.create({\n\t\t\t\tid: menuId,\n\t\t\t\titems: menuItems,\n\t\t\t});\n\t\t\tconst popup = this.#menus[menuId].getPopupWindow();\n\t\t\tpopup.setBindElement(idMeans);\n\t\t}\n\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tidMeans.firstElementChild.textContent = menuItems[0].text;\n\n\t\treturn this.#menus[menuId];\n\t}\n\n\tasync #formatPhoneNumberForUi(phone: string): Promise<string>\n\t{\n\t\tlet phoneFormatted = phone;\n\t\tif (BX.PhoneNumberParser)\n\t\t{\n\t\t\tphoneFormatted = await BX.PhoneNumberParser.getInstance().parse(phone).then((parsedNumber) => {\n\t\t\t\treturn parsedNumber.format(BX.PhoneNumber.Format.INTERNATIONAL);\n\t\t\t});\n\t\t}\n\n\t\treturn phoneFormatted;\n\t}\n\n\t#highlightCommunicationWithError(phoneNumber: string): void\n\t{\n\t\tconst selectors = [\n\t\t\t`.sign-document-send__party_id-means[data-phone-source=\"${phoneNumber}\"]`,\n\t\t\t`.sign-document-send__party_id-means[data-phone-normalized=\"${phoneNumber}\"]`,\n\t\t];\n\t\tselectors.forEach((selector) => {\n\t\t\tconst aIdMeans = this.#sendContainer.querySelectorAll(selector);\n\t\t\taIdMeans.forEach((elem) => {\n\t\t\t\tconst wrapper = elem.closest('.sign-document-send__party');\n\t\t\t\tDom.addClass(wrapper, '--validation-error');\n\t\t\t});\n\t\t});\n\t}\n\n\tasync #updatePhoneAttr(elem: Element, phone: string = null): void\n\t{\n\t\tconst normalized = await BX.PhoneNumberParser.getInstance().parse(phone).then((parsedNumber) => {\n\t\t\treturn parsedNumber.format(BX.PhoneNumber.Format.E164);\n\t\t});\n\n\t\tif (Type.isStringFilled(phone))\n\t\t{\n\t\t\tDom.attr(elem, 'data-phone-source', phone);\n\t\t\tDom.attr(elem, 'data-phone-normalized', normalized);\n\t\t}\n\t\telse\n\t\t{\n\t\t\telem.removeAttribute('data-phone-source');\n\t\t\telem.removeAttribute('data-phone-normalized');\n\t\t}\n\t}\n\n\tresetCommunicationErrors(): void\n\t{\n\t\tconst elems = this.#sendContainer.querySelectorAll('.sign-document-send__party');\n\t\telems.forEach((elem) => {\n\t\t\tDom.removeClass(elem, '--validation-error');\n\t\t});\n\t}\n\n\t#showMemberInfo(idMeans: HTMLElement, entityData: Object)\n\t{\n\t\tconst { Instance: slider } = Reflection.getClass('BX.SidePanel');\n\t\tslider.open(entityData.url, {\n\t\t\tcacheable: false,\n\t\t\tallowChangeHistory: false,\n\t\t\tevents: {\n\t\t\t\tonClose: () => {\n\t\t\t\t\tthis.#attachMenu(idMeans, entityData);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\t#createParties(): Array<HTMLElement>\n\t{\n\t\tconst parties = [\n\t\t\t{\n\t\t\t\tpartyTitle: Loc.getMessage('SIGN_DOCUMENT_SEND_FIRST_PARTY'),\n\t\t\t\tentityData: this.entityData.company,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpartyTitle: Loc.getMessage('SIGN_DOCUMENT_SEND_PARTNER'),\n\t\t\t\tentityData: this.entityData.contact,\n\t\t\t},\n\t\t];\n\t\tObject.keys(MenuManager.Data).forEach((menuId) => {\n\t\t\tif (menuId.includes(menuPrefix))\n\t\t\t{\n\t\t\t\tMenuManager.destroy(menuId);\n\t\t\t}\n\t\t});\n\n\t\tthis.#menus = [];\n\n\t\treturn parties.map((party) => {\n\t\t\tconst { partyTitle, entityData } = party;\n\t\t\tconst { title } = entityData;\n\t\t\tconst idMeans = Tag.render`\n\t\t\t\t<span\n\t\t\t\t\tclass=\"sign-document-send__party_id-means\"\n\t\t\t\t\tonclick=\"${() => menu.show()}\"\n\t\t\t\t>\n\t\t\t\t\t<span></span>\n\t\t\t\t</span>\n\t\t\t`;\n\t\t\tconst menu = this.#attachMenu(idMeans, entityData);\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"sign-document-send__party\">\n\t\t\t\t\t<div class=\"sign-document-send__party_summary\">\n\t\t\t\t\t\t<p class=\"sign-document-send__party_title\">${partyTitle}</p>\n\t\t\t\t\t\t<span class=\"sign-document-send__party_member-name\">\n\t\t\t\t\t\t\t${Text.encode(title)}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class=\"sign-document-send__party_status\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_SEND_NOT_SIGNED')}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"sign-document-send__party_id\">\n\t\t\t\t\t\t<p class=\"sign-document-send__party_title\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_SEND_PARTY_ID')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t${idMeans}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#updateCommunications(entityData, communication)\n\t{\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-typeof\n\t\tif (typeof communication === 'undefined')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { TYPE: type, VALUE: value } = communication;\n\t\tthis.communications = {\n\t\t\t...this.communications,\n\t\t\t[entityData.type]: { type, value },\n\t\t};\n\n\t\tthis.resetCommunicationErrors();\n\t}\n\n\tasync sendForSign(): Promise<boolean>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst { communications, entityData } = this;\n\t\t\tconst entries = Object.entries(communications);\n\t\t\tlet allowToComplete = true;\n\t\t\tconst restrictions = await this.#api.loadRestrictions();\n\t\t\tfor (const [entityType, item] of entries)\n\t\t\t{\n\t\t\t\tconst { type, value } = item;\n\t\t\t\tconst { uid: memberUid } = entityData[entityType];\n\t\t\t\tif (!restrictions.smsAllowed && type === 'PHONE')\n\t\t\t\t{\n\t\t\t\t\ttop.BX.UI.InfoHelper.show('limit_crm_sign_messenger_identification');\n\t\t\t\t\tallowToComplete = false;\n\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.#api.modifyCommunicationChannel(memberUid, type, value);\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\tuid: documentUid,\n\t\t\t\tinitiator,\n\t\t\t} = this.#documentData;\n\t\t\tawait this.#api.modifyInitiator(documentUid, initiator);\n\t\t\tif (!allowToComplete)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tawait this.#api.configureDocument(documentUid);\n\t\t\tawait this.#checkFillAndStartProgress(documentUid);\n\n\t\t\treturn true;\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tif (Type.isArrayFilled(e?.errors))\n\t\t\t{\n\t\t\t\tconst firstError = e.errors[0];\n\t\t\t\te.errors.forEach((error) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\terror?.code === firstError.code\n\t\t\t\t\t\t&& (error?.code === 'MEMBER_INVALID_PHONE' || error?.code === 'MEMBER_PHONE_UNSUPPORTED_COUNTRY_CODE')\n\t\t\t\t\t\t&& Type.isStringFilled(error?.customData?.phone)\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#highlightCommunicationWithError(error.customData.phone);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tasync #checkFillAndStartProgress(uid: string): Promise<void>\n\t{\n\t\tlet completed = false;\n\t\twhile (!completed)\n\t\t{\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tconst result = await this.#api.getDocumentFillAndStartProgress(uid);\n\t\t\tcompleted = result.completed;\n\t\t\tif (!completed)\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\t\tawait this.#sleep(1000);\n\t\t\t}\n\t\t}\n\t}\n\n\t#sleep(ms: Number): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tsetTimeout(resolve, ms);\n\t\t});\n\t}\n\n\tsetDocumentsBlock(documents): void\n\t{\n\t\tconst documentsObject = Object.fromEntries(documents);\n\t\tthis.#documentSummary.setItems(documentsObject);\n\t}\n}\n"],"names":["menuPrefix","DocumentSend","EventEmitter","constructor","config","setEventNamespace","entityData","communications","Api","LangSelector","region","languages","DocumentSummary","events","changeTitle","event","data","getData","title","emit","showEditor","Tag","render","getLayout","Loc","getMessage","Hint","create","documentData","uid","addItem","setDocumentUid","resetCommunicationErrors","elems","querySelectorAll","forEach","elem","Dom","removeClass","sendForSign","entries","Object","allowToComplete","restrictions","loadRestrictions","entityType","item","type","value","memberUid","smsAllowed","top","BX","UI","InfoHelper","show","modifyCommunicationChannel","documentUid","initiator","modifyInitiator","configureDocument","e","Type","isArrayFilled","errors","firstError","error","code","isStringFilled","customData","phone","setDocumentsBlock","documents","documentsObject","fromEntries","setItems","idMeans","menuItems","menuId","entityTypeId","id","items","getMenuItems","swap","array","from","to","tmp","length","removeMenuItem","loadCommunications","then","multiFields","selectedCommunication","mapper","communication","text","VALUE","TYPE","PhoneNumberParser","getInstance","parse","parsedNumber","format","PhoneNumber","Format","INTERNATIONAL","keys","onclick","target","firstElementChild","textContent","close","EMAIL","map","element","PHONE","Promise","all","addMenuItem","catch","push","MenuManager","popup","getPopupWindow","setBindElement","phoneFormatted","phoneNumber","selectors","selector","aIdMeans","wrapper","closest","addClass","normalized","E164","attr","removeAttribute","Instance","slider","Reflection","getClass","open","url","cacheable","allowChangeHistory","onClose","parties","partyTitle","company","contact","Data","includes","destroy","party","menu","Text","encode","completed","result","getDocumentFillAndStartProgress","ms","resolve","setTimeout"],"mappings":"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"}