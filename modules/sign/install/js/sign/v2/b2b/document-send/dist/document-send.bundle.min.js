this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,s,t,a,i,l,o,r){"use strict";let n=e=>e,c,d,b,u;const p="sign-member-communication";var v=babelHelpers.classPrivateFieldLooseKey("api");var h=babelHelpers.classPrivateFieldLooseKey("menus");var P=babelHelpers.classPrivateFieldLooseKey("sendContainer");var m=babelHelpers.classPrivateFieldLooseKey("documentData");var L=babelHelpers.classPrivateFieldLooseKey("langContainer");var y=babelHelpers.classPrivateFieldLooseKey("config");var H=babelHelpers.classPrivateFieldLooseKey("langSelector");var B=babelHelpers.classPrivateFieldLooseKey("documentSummary");var F=babelHelpers.classPrivateFieldLooseKey("attachMenu");var g=babelHelpers.classPrivateFieldLooseKey("formatPhoneNumberForUi");var E=babelHelpers.classPrivateFieldLooseKey("highlightCommunicationWithError");var _=babelHelpers.classPrivateFieldLooseKey("updatePhoneAttr");var f=babelHelpers.classPrivateFieldLooseKey("showMemberInfo");var N=babelHelpers.classPrivateFieldLooseKey("createParties");var O=babelHelpers.classPrivateFieldLooseKey("updateCommunications");var T=babelHelpers.classPrivateFieldLooseKey("checkFillAndStartProgress");var D=babelHelpers.classPrivateFieldLooseKey("sleep");class S extends t.EventEmitter{constructor(e){super();Object.defineProperty(this,D,{value:K});Object.defineProperty(this,T,{value:j});Object.defineProperty(this,O,{value:U});Object.defineProperty(this,N,{value:X});Object.defineProperty(this,f,{value:C});Object.defineProperty(this,_,{value:A});Object.defineProperty(this,E,{value:M});Object.defineProperty(this,g,{value:I});Object.defineProperty(this,F,{value:w});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,m,{writable:true,value:void 0});Object.defineProperty(this,L,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});this.setEventNamespace("BX.Sign.V2.DocumentSend");this.entityData={};this.communications={};babelHelpers.classPrivateFieldLooseBase(this,y)[y]=e;babelHelpers.classPrivateFieldLooseBase(this,v)[v]=new i.Api;babelHelpers.classPrivateFieldLooseBase(this,H)[H]=new o.LangSelector(babelHelpers.classPrivateFieldLooseBase(this,y)[y].region,babelHelpers.classPrivateFieldLooseBase(this,y)[y].languages);babelHelpers.classPrivateFieldLooseBase(this,B)[B]=new r.DocumentSummary({events:{changeTitle:e=>{const s=e.getData();babelHelpers.classPrivateFieldLooseBase(this,m)[m].title=s.title;this.emit("changeTitle",s)},showEditor:e=>this.emit("showEditor")}});babelHelpers.classPrivateFieldLooseBase(this,L)[L]=s.Tag.render(c||(c=n`
			<div class="sign-document-send__lang-container">
				${0}
				<span data-hint="${0}"></span>
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,H)[H].getLayout(),s.Loc.getMessage("SIGN_DOCUMENT_LANGUAGE_BUTTON_INFO"));l.Hint.create(babelHelpers.classPrivateFieldLooseBase(this,L)[L]);babelHelpers.classPrivateFieldLooseBase(this,h)[h]=[];babelHelpers.classPrivateFieldLooseBase(this,m)[m]={}}get documentData(){return babelHelpers.classPrivateFieldLooseBase(this,m)[m]}set documentData(e){const{uid:s,title:t}=e;babelHelpers.classPrivateFieldLooseBase(this,B)[B].addItem(s,{uid:s,title:t});babelHelpers.classPrivateFieldLooseBase(this,m)[m]=e}getLayout(){babelHelpers.classPrivateFieldLooseBase(this,H)[H].setDocumentUid(babelHelpers.classPrivateFieldLooseBase(this,m)[m].uid);babelHelpers.classPrivateFieldLooseBase(this,P)[P]=s.Tag.render(d||(d=n`
			<div class="sign-document-send">
				<div class="sign-document-send__summary-title-wrapper">
					<p class="sign-document-send__title">
						${0}
					</p>
					${0}
				</div>
				${0}
				${0}
			</div>
		`),s.Loc.getMessage("SIGN_DOCUMENT_SEND_TITLE"),babelHelpers.classPrivateFieldLooseBase(this,L)[L],babelHelpers.classPrivateFieldLooseBase(this,B)[B].getLayout(),babelHelpers.classPrivateFieldLooseBase(this,N)[N]());return babelHelpers.classPrivateFieldLooseBase(this,P)[P]}resetCommunicationErrors(){const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].querySelectorAll(".sign-document-send__party");e.forEach((e=>{s.Dom.removeClass(e,"--validation-error")}))}async sendForSign(){try{const{communications:e,entityData:s}=this;const t=Object.entries(e);let a=true;const i=await babelHelpers.classPrivateFieldLooseBase(this,v)[v].loadRestrictions();for(const[e,l]of t){const{type:t,value:o}=l;const{uid:r}=s[e];if(!i.smsAllowed&&t==="PHONE"){top.BX.UI.InfoHelper.show("limit_crm_sign_messenger_identification");a=false;continue}babelHelpers.classPrivateFieldLooseBase(this,v)[v].modifyCommunicationChannel(r,t,o)}const{uid:l,initiator:o}=babelHelpers.classPrivateFieldLooseBase(this,m)[m];await babelHelpers.classPrivateFieldLooseBase(this,v)[v].modifyInitiator(l,o);if(!a){return false}await babelHelpers.classPrivateFieldLooseBase(this,v)[v].configureDocument(l);await babelHelpers.classPrivateFieldLooseBase(this,T)[T](l);return true}catch(e){if(s.Type.isArrayFilled(e==null?void 0:e.errors)){const t=e.errors[0];e.errors.forEach((e=>{var a;if((e==null?void 0:e.code)===t.code&&((e==null?void 0:e.code)==="MEMBER_INVALID_PHONE"||(e==null?void 0:e.code)==="MEMBER_PHONE_UNSUPPORTED_COUNTRY_CODE")&&s.Type.isStringFilled(e==null?void 0:(a=e.customData)==null?void 0:a.phone)){babelHelpers.classPrivateFieldLooseBase(this,E)[E](e.customData.phone)}}))}return false}}setDocumentsBlock(e){const s=Object.fromEntries(e);babelHelpers.classPrivateFieldLooseBase(this,B)[B].setItems(s)}}function w(e,t){let i=[];const l=`${p}-${t.entityTypeId}-${t.id}`;if(babelHelpers.classPrivateFieldLooseBase(this,h)[h][l]){let e=babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].getMenuItems();const s=(e,s,t)=>{const a=e[t];e[t]=e[s];e[s]=a};while(e.length>1){if(e[0].id==="show-member"){s(e,0,1);continue}babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].removeMenuItem(e[0].id);e=babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].getMenuItems()}}babelHelpers.classPrivateFieldLooseBase(this,v)[v].loadCommunications(t.uid).then((async s=>{var a,o,r,n,c;let d={};const b=await babelHelpers.classPrivateFieldLooseBase(this,v)[v].loadRestrictions();const u=s=>{var a;let i=s.VALUE;if((s==null?void 0:s.TYPE)==="PHONE"&&BX.PhoneNumberParser){BX.PhoneNumberParser.getInstance().parse(s.VALUE).then((e=>{i=e.format(BX.PhoneNumber.Format.INTERNATIONAL)}))}if((s==null?void 0:s.TYPE)==="PHONE"&&b.smsAllowed&&((a=d)==null?void 0:a.TYPE)!=="PHONE"||(s==null?void 0:s.TYPE)==="EMAIL"&&Object.keys(d).length===0){d=s}return{text:i,onclick:({target:a})=>{babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,s);e.firstElementChild.textContent=i;babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].close();babelHelpers.classPrivateFieldLooseBase(this,_)[_](e,(s==null?void 0:s.TYPE)==="PHONE"?s.VALUE:null)}}};i=[...s!=null&&s.EMAIL?s==null?void 0:s.EMAIL.map((e=>u(e))):[],...s!=null&&s.PHONE?await Promise.all(s==null?void 0:s.PHONE.map((async e=>{const s=u(e);s.text=await babelHelpers.classPrivateFieldLooseBase(this,g)[g](s.text);return s}))):[]];i.map((e=>babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].addMenuItem(e,null)));babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,d);e.firstElementChild.textContent=((a=d)==null?void 0:a.TYPE)==="PHONE"?await babelHelpers.classPrivateFieldLooseBase(this,g)[g]((o=d)==null?void 0:o.VALUE):(r=d)==null?void 0:r.VALUE;babelHelpers.classPrivateFieldLooseBase(this,_)[_](e,((n=d)==null?void 0:n.TYPE)==="PHONE"?(c=d)==null?void 0:c.VALUE:null)})).catch((()=>{}));i.push({id:"show-member",text:s.Loc.getMessage("SIGN_DOCUMENT_SEND_OPEN_VIEW"),onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f](e,t);babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].close()}});if(!babelHelpers.classPrivateFieldLooseBase(this,h)[h][l]){babelHelpers.classPrivateFieldLooseBase(this,h)[h][l]=a.MenuManager.create({id:l,items:i});const s=babelHelpers.classPrivateFieldLooseBase(this,h)[h][l].getPopupWindow();s.setBindElement(e)}e.firstElementChild.textContent=i[0].text;return babelHelpers.classPrivateFieldLooseBase(this,h)[h][l]}async function I(e){let s=e;if(BX.PhoneNumberParser){s=await BX.PhoneNumberParser.getInstance().parse(e).then((e=>e.format(BX.PhoneNumber.Format.INTERNATIONAL)))}return s}function M(e){const t=[`.sign-document-send__party_id-means[data-phone-source="${e}"]`,`.sign-document-send__party_id-means[data-phone-normalized="${e}"]`];t.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,P)[P].querySelectorAll(e);t.forEach((e=>{const t=e.closest(".sign-document-send__party");s.Dom.addClass(t,"--validation-error")}))}))}async function A(e,t=null){const a=await BX.PhoneNumberParser.getInstance().parse(t).then((e=>e.format(BX.PhoneNumber.Format.E164)));if(s.Type.isStringFilled(t)){s.Dom.attr(e,"data-phone-source",t);s.Dom.attr(e,"data-phone-normalized",a)}else{e.removeAttribute("data-phone-source");e.removeAttribute("data-phone-normalized")}}function C(e,t){const{Instance:a}=s.Reflection.getClass("BX.SidePanel");a.open(t.url,{cacheable:false,allowChangeHistory:false,events:{onClose:()=>{babelHelpers.classPrivateFieldLooseBase(this,F)[F](e,t)}}})}function X(){const e=[{partyTitle:s.Loc.getMessage("SIGN_DOCUMENT_SEND_FIRST_PARTY"),entityData:this.entityData.company},{partyTitle:s.Loc.getMessage("SIGN_DOCUMENT_SEND_PARTNER"),entityData:this.entityData.contact}];Object.keys(a.MenuManager.Data).forEach((e=>{if(e.includes(p)){a.MenuManager.destroy(e)}}));babelHelpers.classPrivateFieldLooseBase(this,h)[h]=[];return e.map((e=>{const{partyTitle:t,entityData:a}=e;const{title:i}=a;const l=s.Tag.render(b||(b=n`
				<span
					class="sign-document-send__party_id-means"
					onclick="${0}"
				>
					<span></span>
				</span>
			`),(()=>o.show()));const o=babelHelpers.classPrivateFieldLooseBase(this,F)[F](l,a);return s.Tag.render(u||(u=n`
				<div class="sign-document-send__party">
					<div class="sign-document-send__party_summary">
						<p class="sign-document-send__party_title">${0}</p>
						<span class="sign-document-send__party_member-name">
							${0}
						</span>
						<span class="sign-document-send__party_status">
							${0}
						</span>
					</div>
					<div class="sign-document-send__party_id">
						<p class="sign-document-send__party_title">
							${0}
						</p>
						${0}
					</div>
				</div>
			`),t,s.Text.encode(i),s.Loc.getMessage("SIGN_DOCUMENT_SEND_NOT_SIGNED"),s.Loc.getMessage("SIGN_DOCUMENT_SEND_PARTY_ID"),l)}))}function U(e,s){if(typeof s==="undefined"){return}const{TYPE:t,VALUE:a}=s;this.communications={...this.communications,[e.type]:{type:t,value:a}};this.resetCommunicationErrors()}async function j(e){let s=false;while(!s){const t=await babelHelpers.classPrivateFieldLooseBase(this,v)[v].getDocumentFillAndStartProgress(e);s=t.completed;if(!s){await babelHelpers.classPrivateFieldLooseBase(this,D)[D](1e3)}}}function K(e){return new Promise((s=>{setTimeout(s,e)}))}e.DocumentSend=S})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX.Main,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2);
//# sourceMappingURL=document-send.bundle.map.js