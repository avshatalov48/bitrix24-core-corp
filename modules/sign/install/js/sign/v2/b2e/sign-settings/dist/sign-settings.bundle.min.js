this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};this.BX.Sign.V2=this.BX.Sign.V2||{};(function(e,t,s,i,a,l,o,r,n,c,d,u,b){"use strict";let p=e=>e,v;var y=babelHelpers.classPrivateFieldLooseKey("companyParty");var h=babelHelpers.classPrivateFieldLooseKey("userParty");var m=babelHelpers.classPrivateFieldLooseKey("api");var P=babelHelpers.classPrivateFieldLooseKey("prepareConfig");var S=babelHelpers.classPrivateFieldLooseKey("setupParties");var g=babelHelpers.classPrivateFieldLooseKey("documentUid");var B=babelHelpers.classPrivateFieldLooseKey("isDocumentInitiatedByEmployee");var L=babelHelpers.classPrivateFieldLooseKey("getAssignee");var f=babelHelpers.classPrivateFieldLooseKey("getSigner");var F=babelHelpers.classPrivateFieldLooseKey("makeSetupMembers");var H=babelHelpers.classPrivateFieldLooseKey("parseMembers");var I=babelHelpers.classPrivateFieldLooseKey("getSetupStep");var T=babelHelpers.classPrivateFieldLooseKey("getCompanyStep");var M=babelHelpers.classPrivateFieldLooseKey("getEmployeeStep");var w=babelHelpers.classPrivateFieldLooseKey("executeDocumentSendActions");var E=babelHelpers.classPrivateFieldLooseKey("executeEditorActions");var D=babelHelpers.classPrivateFieldLooseKey("getSendStep");var O=babelHelpers.classPrivateFieldLooseKey("setSecondPartySectionVisibility");class C extends b.SignSettings{constructor(e,t){super(e,t,{next:{className:"ui-btn-success"},complete:{className:"ui-btn-success"},swapButtons:true});Object.defineProperty(this,O,{value:Y});Object.defineProperty(this,D,{value:$});Object.defineProperty(this,E,{value:z});Object.defineProperty(this,w,{value:R});Object.defineProperty(this,M,{value:x});Object.defineProperty(this,T,{value:U});Object.defineProperty(this,I,{value:G});Object.defineProperty(this,H,{value:A});Object.defineProperty(this,F,{value:k});Object.defineProperty(this,f,{value:N});Object.defineProperty(this,L,{value:K});Object.defineProperty(this,B,{get:_,set:void 0});Object.defineProperty(this,g,{get:V,set:void 0});Object.defineProperty(this,S,{value:j});Object.defineProperty(this,P,{value:X});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,m,{writable:true,value:void 0});const{blankSelectorConfig:s,documentSendConfig:a,userPartyConfig:c}=babelHelpers.classPrivateFieldLooseBase(this,P)[P](t);s.hideValidationParty=b.isTemplateMode(this.documentMode);this.documentSetup=new o.DocumentSetup(s);this.documentSend=new l.DocumentSend(a);babelHelpers.classPrivateFieldLooseBase(this,y)[y]=new r.Parties(s);babelHelpers.classPrivateFieldLooseBase(this,m)[m]=new i.Api;babelHelpers.classPrivateFieldLooseBase(this,h)[h]=new n.UserParty({mode:"edit",...c});this.subscribeOnEvents()}subscribeOnEvents(){super.subscribeOnEvents();this.documentSend.subscribe("changeTitle",(({data:e})=>{this.documentSetup.setDocumentTitle(e.title)}));this.documentSend.subscribe("disableBack",(()=>{this.wizard.toggleBtnActiveState("back",true)}));this.documentSend.subscribe("enableBack",(()=>{this.wizard.toggleBtnActiveState("back",false)}))}async applyDocumentData(e){const t=await this.setupDocument(e,true);if(!t){return false}const{entityId:s,representativeId:a,companyUid:l}=t;this.documentSend.documentData=t;this.editor.documentData=t;babelHelpers.classPrivateFieldLooseBase(this,y)[y].setEntityId(s);if(l){babelHelpers.classPrivateFieldLooseBase(this,y)[y].loadCompany(l)}if(a){babelHelpers.classPrivateFieldLooseBase(this,y)[y].loadRepresentative(a)}const o=await babelHelpers.classPrivateFieldLooseBase(this,m)[m].loadMembers(e);const r=babelHelpers.classPrivateFieldLooseBase(this,H)[H](o);const{signers:n=[],reviewers:c=[],editors:d=[]}=r;if(n.length>0){babelHelpers.classPrivateFieldLooseBase(this,h)[h].load(n)}if(c.length>0){babelHelpers.classPrivateFieldLooseBase(this,y)[y].loadValidator(c[0],i.MemberRole.reviewer)}if(d.length>0){babelHelpers.classPrivateFieldLooseBase(this,y)[y].loadValidator(d[0],i.MemberRole.editor)}return true}getStepsMetadata(e){const t={setup:babelHelpers.classPrivateFieldLooseBase(this,I)[I](e),company:babelHelpers.classPrivateFieldLooseBase(this,T)[T](e)};if(!this.isTemplateMode()){t.employees=babelHelpers.classPrivateFieldLooseBase(this,M)[M](e)}t.send=babelHelpers.classPrivateFieldLooseBase(this,D)[D](e);return t}onComplete(){if(this.isTemplateMode()){BX.SidePanel.Instance.close();BX.SidePanel.Instance.open("sign-settings-template-created",{contentCallback:()=>Promise.resolve(this.getTemplateStatusLayout())});return}super.onComplete()}getTemplateStatusLayout(){return t.Tag.render(v||(v=p`
			<div class="sign-b2e-template-status">
				<div class="sign-b2e-template-status-inner">
					<div class="sign-b2e-template-status-img"></div>
					<div class="sign-b2e-template-status-title">${0}</div>
					<button class="ui-btn ui-btn-light-border ui-btn-round" onclick="BX.SidePanel.Instance.close();">${0}</button>
				</div>
			 </div>
		`),t.Loc.getMessage("SIGN_SETTINGS_TEMPLATE_CREATED"),t.Loc.getMessage("SIGN_SETTINGS_TEMPLATES_LIST"))}}function X(e){const{config:t,documentMode:s}=e;const{blankSelectorConfig:i,documentSendConfig:a}=t;i.documentMode=s;a.documentMode=s;return t}async function j(){const e=babelHelpers.classPrivateFieldLooseBase(this,g)[g];const{representative:s}=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getParties();const i=babelHelpers.classPrivateFieldLooseBase(this,F)[F]();await babelHelpers.classPrivateFieldLooseBase(this,m)[m].setupB2eParties(e,s.entityId,i);const a=await babelHelpers.classPrivateFieldLooseBase(this,m)[m].loadMembers(e);if(!t.Type.isArrayFilled(a)){throw new Error("Members are empty")}return a.map((e=>{var t,s,i;return{presetId:e==null?void 0:e.presetId,part:e==null?void 0:e.party,uid:e==null?void 0:e.uid,entityTypeId:(t=e==null?void 0:e.entityTypeId)!=null?t:null,entityId:(s=e==null?void 0:e.entityId)!=null?s:null,role:(i=e==null?void 0:e.role)!=null?i:null}}))}function V(){return this.documentSetup.setupData.uid}function _(){return this.documentSetup.setupData.initiatedByType===c.DocumentInitiated.employee}function K(e,t){return{entityType:"company",entityId:t,party:e,role:i.MemberRole.assignee}}function N(e,t){return{entityType:"user",entityId:t,party:e,role:i.MemberRole.signer}}function k(){const{company:e,validation:t}=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getParties();const s=babelHelpers.classPrivateFieldLooseBase(this,h)[h].getUserIds();let i=[];let a=babelHelpers.classPrivateFieldLooseBase(this,B)[B]?2:1;i=t.map((e=>{const t={...e,party:a};a++;return t}));i.push(babelHelpers.classPrivateFieldLooseBase(this,L)[L](a,e.entityId));if(!this.isTemplateMode()){const e=babelHelpers.classPrivateFieldLooseBase(this,B)[B]?1:a+1;const t=s.map((t=>babelHelpers.classPrivateFieldLooseBase(this,f)[f](e,t)));i.push(...t)}return i}function A(e){return e.reduce(((e,t)=>{var s;const{entityType:i,entityId:a}=t;if(i!=="user"){return e}const l=`${t.role}s`;return{...e,[l]:[...(s=e[l])!=null?s:[],a]}}),{})}function G(e){return{get content(){const t=e.documentSetup.layout;u.SignSettingsItemCounter.numerate(t);return t},title:t.Loc.getMessage("SIGN_SETTINGS_B2B_LOAD_DOCUMENT"),beforeCompletion:async()=>{const e=this.documentSetup.validate();if(!e){return false}const t=this.setupDocument();if(!t){return false}const s=await t;if(!s){return false}babelHelpers.classPrivateFieldLooseBase(this,y)[y].setInitiatedByType(s.initiatedByType);babelHelpers.classPrivateFieldLooseBase(this,y)[y].setEntityId(s.entityId);return true}}}function U(e){return{get content(){const t=babelHelpers.classPrivateFieldLooseBase(e,y)[y].getLayout();u.SignSettingsItemCounter.numerate(t);return t},title:t.Loc.getMessage("SIGN_SETTINGS_B2E_COMPANY"),beforeCompletion:async()=>{const{uid:e}=this.documentSetup.setupData;try{await babelHelpers.classPrivateFieldLooseBase(this,y)[y].save(e);babelHelpers.classPrivateFieldLooseBase(this,O)[O]();if(this.isTemplateMode()){const t=await babelHelpers.classPrivateFieldLooseBase(this,S)[S]();this.editor.entityData=t;const{title:s,isTemplate:i,entityId:a,externalId:l,templateUid:o}=this.documentSetup.setupData;const r=await this.documentSetup.loadBlocks(e);const n={uid:e,title:s,blocks:r,externalId:l,templateUid:o};babelHelpers.classPrivateFieldLooseBase(this,w)[w](n,t);const c={isTemplate:i,uid:e,blocks:r,entityId:a};babelHelpers.classPrivateFieldLooseBase(this,E)[E](c)}}catch{return false}return true}}}function x(e){return{get content(){const t=babelHelpers.classPrivateFieldLooseBase(e,h)[h].getLayout();u.SignSettingsItemCounter.numerate(t);return t},title:t.Loc.getMessage("SIGN_SETTINGS_B2E_EMPLOYEES"),beforeCompletion:async()=>{try{const e=babelHelpers.classPrivateFieldLooseBase(this,h)[h].validate();if(!e){return e}const t=await babelHelpers.classPrivateFieldLooseBase(this,S)[S]();this.editor.entityData=t;const{uid:s,title:i,isTemplate:a,externalId:l,entityId:o}=this.documentSetup.setupData;const r=await this.documentSetup.loadBlocks(s);const n={uid:s,title:i,blocks:r,externalId:l};babelHelpers.classPrivateFieldLooseBase(this,w)[w](n,t);const c={isTemplate:a,uid:s,blocks:r,entityId:o};babelHelpers.classPrivateFieldLooseBase(this,E)[E](c);return true}catch(e){console.error(e);return false}}}}async function R(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getParties();Object.assign(s,{employees:babelHelpers.classPrivateFieldLooseBase(this,h)[h].getUserIds().map((e=>({entityType:"user",entityId:e})))});this.documentSend.documentData=e;this.documentSend.setPartiesData(s);this.documentSend.members=t}async function z(e){this.editor.documentData=e;await this.editor.waitForPagesUrls();await this.editor.renderDocument();this.wizard.toggleBtnLoadingState("next",false);await this.editor.show()}function $(e){return{get content(){const t=e.documentSend.getLayout();u.SignSettingsItemCounter.numerate(t);return t},title:t.Loc.getMessage("SIGN_SETTINGS_SEND_DOCUMENT"),beforeCompletion:()=>this.documentSend.sendForSign()}}function Y(){const e=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getSelectedProvider();const t=e.code!==a.ProviderCode.sesRu||b.isTemplateMode(this.documentMode);this.editor.setSectionVisibilityByType(d.SectionType.SecondParty,t)}e.B2ESignSettings=C})(this.BX.Sign.V2.B2e=this.BX.Sign.V2.B2e||{},BX,BX.Sign,BX.Sign.V2,BX.Sign.V2.B2e,BX.Sign.V2.B2e,BX.Sign.V2.B2e,BX.Sign.V2.B2e,BX.Sign.V2.B2e,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2);
//# sourceMappingURL=sign-settings.bundle.map.js