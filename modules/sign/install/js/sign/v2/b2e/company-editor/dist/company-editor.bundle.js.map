{"version":3,"file":"company-editor.bundle.js","sources":["../src/types.js","../src/company-editor.js"],"sourcesContent":["export type CompanyEditorOptions = {\n\tdocumentEntityId: number;\n\tcompanyId?: string,\n\tmode?: string,\n\tevents?: {\n\t\tonCompanySavedHandler?: (companyId: number) => void,\n\t},\n\tlayoutTitle?: string,\n}\n\nexport const CompanyEditorMode = Object.freeze({\n\tEdit: 'edit',\n\tCreate: 'create',\n});","import { ajax, Dom, Loc, Runtime, Tag, Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Layout } from 'ui.sidepanel.layout';\nimport { CompanyEditorMode } from './types';\nimport type { CompanyEditorOptions } from './types';\n\nconst crmEditorSettings = Object.freeze({\n\tentityTypeId: 39,\n\tguid: 'sign_b2e_entity_editor',\n\tparams: {\n\t\tENABLE_PAGE_TITLE_CONTROLS: false,\n\t\tENABLE_MODE_TOGGLE: false,\n\t\tIS_EMBEDDED: 'N',\n\t\tforceDefaultConfig: 'Y',\n\t\tenableSingleSectionCombining: 'N'\n\t}\n});\nconst entityEditorEvents = [\n\t'onCrmEntityUpdate',\n\t'BX.Crm.EntityEditor:onFailedValidation',\n\t'onCrmEntityUpdateError',\n\t'BX.Crm.EntityEditor:onEntitySaveFailure',\n];\n\nexport class CompanyEditor\n{\n\t#mode: string = CompanyEditorMode.Create;\n\n\t#documentEntityId: number;\n\t#companyId: ?number = null;\n\n\t#options: CompanyEditorOptions;\n\n\tconstructor(options: CompanyEditorOptions)\n\t{\n\t\tthis.#options = options;\n\t\tif (options?.mode === CompanyEditorMode.Edit && options?.companyId > 0)\n\t\t{\n\t\t\tthis.#mode = CompanyEditorMode.Edit;\n\t\t\tthis.#companyId = options.companyId;\n\t\t}\n\n\t\tthis.#documentEntityId = options.documentEntityId;\n\t}\n\n\tstatic openSlider(\n\t\toptions: CompanyEditorOptions,\n\t\tsliderOptions: { onCloseHandler: () => void }\n\t): void\n\t{\n\t\tBX.SidePanel.Instance.open('company-editor', {\n\t\t\twidth: 800,\n\t\t\tcacheable: false,\n\t\t\tcontentCallback: () => {\n\t\t\t\treturn top.BX.Runtime.loadExtension('sign.v2.b2e.company-editor').then(() => {\n\t\t\t\t\treturn (new top.BX.Sign.V2.B2e.CompanyEditor(options))\n\t\t\t\t\t\t.getLayout()\n\t\t\t\t\t;\n\t\t\t\t});\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\tonClose: sliderOptions?.onCloseHandler ?? (() => {}),\n\t\t\t}\n\t\t});\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tconst container = Tag.render`<div style=\"position: relative; z-index: 1;\"></div>`;\n\n\t\tajax.runAction('crm.api.item.getEditor', {\n\t\t\tdata: { ...crmEditorSettings, id: this.#documentEntityId }\n\t\t}).then(async (response) => {\n\t\t\tconst html = response?.data?.html || '';\n\t\t\tawait Runtime.html(container, html);\n\n\t\t\tthis.#loadedHandler();\n\t\t});\n\n\t\treturn container;\n\t}\n\n\tgetLayout(): Layout\n\t{\n\t\tconst companyEditor = this;\n\n\t\treturn Layout.createContent({\n\t\t\ttitle: companyEditor.#options?.layoutTitle ?? '',\n\t\t\tcontent(): HTMLElement\n\t\t\t{\n\t\t\t\treturn companyEditor.render();\n\t\t\t},\n\t\t\tbuttons({ cancelButton, SaveButton })\n\t\t\t{\n\t\t\t\tconst saveButton = new SaveButton({\n\t\t\t\t\tonclick: async () => {\n\t\t\t\t\t\tsaveButton.setClocking(true);\n\t\t\t\t\t\tawait companyEditor.#save();\n\t\t\t\t\t\tsaveButton.setClocking(false);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn [\n\t\t\t\t\tsaveButton,\n\t\t\t\t\tcancelButton\n\t\t\t\t];\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #save(): Promise<void>\n\t{\n\t\tconst promise = new Promise((resolve) => {\n\t\t\tconst [successFullEvent, ...errorEvents] = entityEditorEvents;\n\t\t\tEventEmitter.subscribeOnce(successFullEvent, (event) => {\n\t\t\t\tconst [{ entityData }] = event.data;\n\t\t\t\tresolve(entityData);\n\t\t\t});\n\t\t\terrorEvents.forEach((event) => {\n\t\t\t\tEventEmitter.subscribeOnce(event, () => resolve(null));\n\t\t\t});\n\t\t});\n\t\tBX.Crm.EntityEditor.defaultInstance.save();\n\t\tconst entityData = await promise;\n\t\tentityEditorEvents.forEach((event) => EventEmitter.unsubscribeAll(event));\n\t\tif (entityData)\n\t\t{\n\t\t\tconst {\n\t\t\t\tMYCOMPANY_ID_INFO: { COMPANY_DATA: [companyData] }\n\t\t\t} = entityData;\n\n\t\t\tif (Type.isFunction(this.#options?.events?.onCompanySavedHandler))\n\t\t\t{\n\t\t\t\tthis.#options.events.onCompanySavedHandler(companyData.id);\n\t\t\t}\n\n\t\t\tBX.SidePanel.Instance.close();\n\t\t}\n\t}\n\n\t#loadedHandler(): void\n\t{\n\t\tconst crmEditor = BX.Crm.EntityEditor.defaultInstance;\n\t\tconst companyField = crmEditor.getControlById('MYCOMPANY_ID');\n\t\tconst [searchBox] = companyField._companySearchBoxes;\n\n\t\tif (this.#mode === CompanyEditorMode.Create)\n\t\t{\n\t\t\tcrmEditor.switchControlMode(companyField, BX.UI.EntityEditorMode.edit);\n\t\t\tsearchBox.setEntity(BX.CrmEntityInfo.create({\n\t\t\t\ttypeName: 'COMPANY',\n\t\t\t\ttitle: ''\n\t\t\t}), true);\n\t\t\tsearchBox._searchInput.value = '';\n\t\t\tDom.remove(searchBox._changeButton);\n\n\t\t\treturn;\n\t\t}\n\n\n\t\tif (this.#mode === CompanyEditorMode.Edit)\n\t\t{\n\t\t\tconst deployEvent = 'BX.Crm.EntityEditor:onUserFieldsDeployed';\n\n\t\t\tsearchBox._searchInput.value = '';\n\t\t\tsearchBox.setEntityTypeName('COMPANY');\n\t\t\tsearchBox.setMode(BX.Crm.EntityEditorClientMode.loading);\n\t\t\tsearchBox.adjust();\n\t\t\tEventEmitter.unsubscribeAll(deployEvent);\n\t\t\tEventEmitter.subscribe(deployEvent, () => {\n\t\t\t\tDom.remove(searchBox._changeButton);\n\t\t\t});\n\t\t\tsearchBox.loadEntityInfo(`${this.#companyId}`);\n\t\t}\n\t}\n}"],"names":["CompanyEditorMode","Object","freeze","Edit","Create","crmEditorSettings","entityTypeId","guid","params","ENABLE_PAGE_TITLE_CONTROLS","ENABLE_MODE_TOGGLE","IS_EMBEDDED","forceDefaultConfig","enableSingleSectionCombining","entityEditorEvents","async","promise","Promise","resolve","successFullEvent","errorEvents","EventEmitter","subscribeOnce","event","entityData","data","forEach","BX","Crm","EntityEditor","defaultInstance","save","unsubscribeAll","MYCOMPANY_ID_INFO","COMPANY_DATA","companyData","Type","isFunction","this","_babelHelpers$classPr3","events","_babelHelpers$classPr4","onCompanySavedHandler","babelHelpers","id","SidePanel","Instance","close","crmEditor","companyField","getControlById","searchBox","_companySearchBoxes","switchControlMode","UI","EntityEditorMode","edit","setEntity","CrmEntityInfo","create","typeName","title","_searchInput","value","Dom","remove","_changeButton","deployEvent","setEntityTypeName","setMode","EntityEditorClientMode","loading","adjust","subscribe","loadEntityInfo","constructor","options","writable","mode","companyId","documentEntityId","[object Object]","sliderOptions","open","width","cacheable","contentCallback","top","Runtime","loadExtension","then","Sign","V2","B2e","CompanyEditor","getLayout","onClose","onCloseHandler","render","container","Tag","ajax","runAction","html","response","_response$data","companyEditor","Layout","createContent","_babelHelpers$classPr2","layoutTitle","content","buttons","cancelButton","SaveButton","saveButton","onclick","setClocking"],"mappings":"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"}