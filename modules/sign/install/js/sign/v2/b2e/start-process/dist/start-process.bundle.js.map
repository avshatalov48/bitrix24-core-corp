{"version":3,"file":"start-process.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Loc, Tag, Type } from 'main.core';\nimport { MemoryCache } from 'main.core.cache';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Loader } from 'main.loader';\nimport type { B2eCompanyList, Template, TemplateField } from 'sign.v2.api';\nimport { Api } from 'sign.v2.api';\nimport { CompanySelector } from 'sign.v2.b2e.company-selector';\nimport { type ItemOptions, SignDropdown } from 'sign.v2.b2e.sign-dropdown';\n\ntype TemplateCompany = Template['company'];\ntype LoadCompanyPromise = Promise<B2eCompanyList>;\n\nconst dropdownTemplateEntityId = 'sign-b2e-start-process-type';\nconst dropdownProcessTabId = 'sign-b2e-start-process-types';\n\nexport class StartProcess extends EventEmitter\n{\n\tevents = {\n\t\tonProcessTypeSelect: 'onProcessTypeSelect',\n\t};\n\n\t#resettableCache: MemoryCache<any> = new MemoryCache();\n\t#api: Api = new Api();\n\n\t#templatesList: Promise<Template[]> = this.#api.template.getList();\n\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.V2.B2e.StartProcess');\n\n\t\tvoid this.#getProcessTypeLayoutLoader().show();\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\treturn this.#resettableCache.remember('layout', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div>\n\t\t\t\t\t<h1 class=\"sign-b2e-settings__header\">${Loc.getMessage('SIGN_START_PROCESS_HEAD')}</h1>\n\t\t\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_START_PROCESS_COMPANY')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t${this.#getCompanySelector().getLayout()}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_START_PROCESS_TYPE')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t${this.#getProcessTypeDropdown().getLayout()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetSelectedTemplateUid(): string\n\t{\n\t\treturn this.#getProcessTypeDropdown().getSelectedId();\n\t}\n\n\tgetTemplates(): Promise<Template[]>\n\t{\n\t\treturn this.#templatesList;\n\t}\n\n\tgetFields(templateUid: string): Promise<{ fields: TemplateField[] }>\n\t{\n\t\treturn this.#api.template.getFields(templateUid);\n\t}\n\n\t#getProcessTypeLayoutLoader(): Loader\n\t{\n\t\treturn this.#resettableCache.remember(\n\t\t\t'processTypeLayoutLoader',\n\t\t\t() => new Loader({ target: this.#getProcessTypeDropdown().getLayout() }),\n\t\t);\n\t}\n\n\t#getProcessTypeDropdown(): SignDropdown\n\t{\n\t\treturn this.#resettableCache.remember(\n\t\t\t'processTypeDropdown',\n\t\t\t() => {\n\t\t\t\tconst signDropdown = new SignDropdown({\n\t\t\t\t\ttabs: [{ id: dropdownProcessTabId, title: ' ' }],\n\t\t\t\t\tentities: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: dropdownTemplateEntityId,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\titems: [],\n\t\t\t\t\tisEnableSearch: true,\n\t\t\t\t});\n\t\t\t\tsignDropdown.subscribe(\n\t\t\t\t\tsignDropdown.events.onSelect,\n\t\t\t\t\t(event) => this.emit(this.events.onProcessTypeSelect, event),\n\t\t\t\t);\n\n\t\t\t\treturn signDropdown;\n\t\t\t},\n\t\t);\n\t}\n\n\t#getCompanySelector(): CompanySelector\n\t{\n\t\treturn this.#resettableCache.remember(\n\t\t\t'companySelector',\n\t\t\t() => {\n\t\t\t\tconst companySelector = new CompanySelector({\n\t\t\t\t\tloadCompanyPromise: this.#getCompanySelectorLoadCompanyPromise(),\n\t\t\t\t\tcanCreateCompany: false,\n\t\t\t\t\tcanEditCompany: false,\n\t\t\t\t\tisCompaniesDeselectable: false,\n\t\t\t\t});\n\t\t\t\tcompanySelector.subscribe(\n\t\t\t\t\tcompanySelector.events.onCompaniesLoad,\n\t\t\t\t\t() => this.#onCompaniesSelectorCompaniesLoad(),\n\t\t\t\t);\n\t\t\t\tcompanySelector.subscribe(\n\t\t\t\t\tcompanySelector.events.onSelect,\n\t\t\t\t\t(event) => this.#onCompanySelectorSelect(event),\n\t\t\t\t);\n\n\t\t\t\treturn companySelector;\n\t\t\t},\n\t\t);\n\t}\n\n\t#createProcessTypeDropdownItemByTemplate(template: Template): ItemOptions\n\t{\n\t\treturn {\n\t\t\tid: template.uid,\n\t\t\ttitle: template.title,\n\t\t\tentityId: dropdownTemplateEntityId,\n\t\t\ttabs: dropdownProcessTabId,\n\t\t\tdeselectable: false,\n\t\t};\n\t}\n\n\tasync #getCompanySelectorLoadCompanyPromise(): LoadCompanyPromise\n\t{\n\t\tconst uniqueCompanies = await this.#getUniqueCompanies();\n\n\t\tconst companySelectorCompanies = uniqueCompanies.map(({ id, name, taxId }) => ({\n\t\t\tid,\n\t\t\ttitle: name,\n\t\t\trqInn: taxId,\n\t\t}));\n\n\t\t// todo: get actual showTaxId\n\t\treturn { companies: companySelectorCompanies, showTaxId: true };\n\t}\n\n\tasync #getUniqueCompanies(): Promise<Array<TemplateCompany>>\n\t{\n\t\tconst templates = await this.#templatesList;\n\t\tconst companies = templates.map((template) => template.company);\n\t\tconst uniqCompanyIds: Set<number> = new Set(companies.map(({ id }) => id));\n\n\t\treturn [...uniqCompanyIds].map(\n\t\t\t(id) => companies.find((company) => company.id === id),\n\t\t);\n\t}\n\n\tasync #onCompaniesSelectorCompaniesLoad(): Promise<void>\n\t{\n\t\tconst companySelector = this.#getCompanySelector();\n\t\tconst templates = await this.#templatesList;\n\t\tconst lastUsedTemplate = templates.find(({ isLastUsed }) => isLastUsed);\n\n\t\tlet selectedCompanyId = lastUsedTemplate?.company?.id;\n\t\tif (Type.isUndefined(selectedCompanyId))\n\t\t{\n\t\t\tconst companies = await this.#getUniqueCompanies();\n\t\t\tselectedCompanyId = companies.at(0)?.id;\n\t\t}\n\n\t\tif (Type.isUndefined(selectedCompanyId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tcompanySelector.selectCompany(selectedCompanyId);\n\t}\n\n\tasync #onCompanySelectorSelect(event: BaseEvent<{ companyId: number }>): void\n\t{\n\t\tvoid this.#getProcessTypeLayoutLoader().show();\n\n\t\tconst companyId = event.getData().companyId;\n\t\tconst templates = await this.#templatesList;\n\n\t\tconst processTypeItems = templates\n\t\t\t.filter(({ company }: Template) => company.id === companyId)\n\t\t\t.map((template) => this.#createProcessTypeDropdownItemByTemplate(template))\n\t\t;\n\t\tconst signDropdown = this.#getProcessTypeDropdown();\n\t\tsignDropdown.removeItems();\n\t\tsignDropdown.addItems(processTypeItems);\n\t\tsignDropdown.selectFirstItem();\n\n\t\tvoid this.#getProcessTypeLayoutLoader().hide();\n\t}\n\n\tresetCache(): void\n\t{\n\t\tthis.#resettableCache = new MemoryCache();\n\t}\n}\n"],"names":["dropdownTemplateEntityId","dropdownProcessTabId","StartProcess","EventEmitter","constructor","events","onProcessTypeSelect","MemoryCache","Api","template","getList","setEventNamespace","show","getLayout","remember","Tag","render","Loc","getMessage","getSelectedTemplateUid","getSelectedId","getTemplates","getFields","templateUid","resetCache","Loader","target","signDropdown","SignDropdown","tabs","id","title","entities","items","isEnableSearch","subscribe","onSelect","event","emit","companySelector","CompanySelector","loadCompanyPromise","canCreateCompany","canEditCompany","isCompaniesDeselectable","onCompaniesLoad","uid","entityId","deselectable","uniqueCompanies","companySelectorCompanies","map","name","taxId","rqInn","companies","showTaxId","templates","company","uniqCompanyIds","Set","find","lastUsedTemplate","isLastUsed","selectedCompanyId","Type","isUndefined","at","selectCompany","companyId","getData","processTypeItems","filter","removeItems","addItems","selectFirstItem","hide"],"mappings":";;;;;;;;;AAAA,CAYA,MAAMA,wBAAwB,GAAG,6BAA6B;CAC9D,MAAMC,oBAAoB,GAAG,8BAA8B;CAAC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAE5D,CAAO,MAAMC,YAAY,SAASC,6BAAY,CAC9C;GAUCC,WAAW,GACX;KACC,KAAK,EAAE;KAAC;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA,KAXTC,MAAM,GAAG;OACRC,mBAAmB,EAAE;MACrB;KAAA;OAAA;OAAA,OAEoC,IAAIC,2BAAW;;KAAE;OAAA;OAAA,OAC1C,IAAIC,eAAG;;KAAE;OAAA;OAAA,OAEiB,4CAAI,cAAMC,QAAQ,CAACC,OAAO;;KAK/D,IAAI,CAACC,iBAAiB,CAAC,wBAAwB,CAAC;KAEhD,KAAK,4CAAI,8DAA+BC,IAAI,EAAE;;GAG/CC,SAAS,GACT;KACC,OAAO,4CAAI,sCAAkBC,QAAQ,CAAC,QAAQ,EAAE,MAAM;OACrD,OAAOC,aAAG,CAACC,MAAM,cAAC;;6CAEsB,CAA4C;;;SAGhF,CAA+C;;QAEhD,CAAyC;;;;SAIxC,CAA4C;;QAE7C,CAA6C;;;IAGhD,GAd0CC,aAAG,CAACC,UAAU,CAAC,yBAAyB,CAAC,EAG7ED,aAAG,CAACC,UAAU,CAAC,4BAA4B,CAAC,EAE7C,4CAAI,8CAAuBL,SAAS,EAAE,EAIrCI,aAAG,CAACC,UAAU,CAAC,yBAAyB,CAAC,EAE1C,4CAAI,sDAA2BL,SAAS,EAAE;MAI/C,CAAC;;GAGHM,sBAAsB,GACtB;KACC,OAAO,4CAAI,sDAA2BC,aAAa,EAAE;;GAGtDC,YAAY,GACZ;KACC,+CAAO,IAAI;;GAGZC,SAAS,CAACC,WAAmB,EAC7B;KACC,OAAO,4CAAI,cAAMd,QAAQ,CAACa,SAAS,CAACC,WAAW,CAAC;;GAyIjDC,UAAU,GACV;KACC,4CAAI,wCAAoB,IAAIjB,2BAAW,EAAE;;CAE3C;CAAC,wCAzIA;GACC,OAAO,4CAAI,sCAAkBO,QAAQ,CACpC,yBAAyB,EACzB,MAAM,IAAIW,kBAAM,CAAC;KAAEC,MAAM,EAAE,4CAAI,sDAA2Bb,SAAS;IAAI,CAAC,CACxE;CACF;CAAC,oCAGD;GACC,OAAO,4CAAI,sCAAkBC,QAAQ,CACpC,qBAAqB,EACrB,MAAM;KACL,MAAMa,YAAY,GAAG,IAAIC,qCAAY,CAAC;OACrCC,IAAI,EAAE,CAAC;SAAEC,EAAE,EAAE7B,oBAAoB;SAAE8B,KAAK,EAAE;QAAK,CAAC;OAChDC,QAAQ,EAAE,CACT;SACCF,EAAE,EAAE9B;QACJ,CACD;OACDiC,KAAK,EAAE,EAAE;OACTC,cAAc,EAAE;MAChB,CAAC;KACFP,YAAY,CAACQ,SAAS,CACrBR,YAAY,CAACtB,MAAM,CAAC+B,QAAQ,EAC3BC,KAAK,IAAK,IAAI,CAACC,IAAI,CAAC,IAAI,CAACjC,MAAM,CAACC,mBAAmB,EAAE+B,KAAK,CAAC,CAC5D;KAED,OAAOV,YAAY;IACnB,CACD;CACF;CAAC,gCAGD;GACC,OAAO,4CAAI,sCAAkBb,QAAQ,CACpC,iBAAiB,EACjB,MAAM;KACL,MAAMyB,eAAe,GAAG,IAAIC,2CAAe,CAAC;OAC3CC,kBAAkB,0CAAE,IAAI,iFAAwC;OAChEC,gBAAgB,EAAE,KAAK;OACvBC,cAAc,EAAE,KAAK;OACrBC,uBAAuB,EAAE;MACzB,CAAC;KACFL,eAAe,CAACJ,SAAS,CACxBI,eAAe,CAAClC,MAAM,CAACwC,eAAe,EACtC,8CAAM,IAAI,yEAAoC,CAC9C;KACDN,eAAe,CAACJ,SAAS,CACxBI,eAAe,CAAClC,MAAM,CAAC+B,QAAQ,EAC9BC,KAAK,4CAAK,IAAI,sDAA0BA,KAAK,CAAC,CAC/C;KAED,OAAOE,eAAe;IACtB,CACD;CACF;CAAC,mDAEwC9B,QAAkB,EAC3D;GACC,OAAO;KACNqB,EAAE,EAAErB,QAAQ,CAACqC,GAAG;KAChBf,KAAK,EAAEtB,QAAQ,CAACsB,KAAK;KACrBgB,QAAQ,EAAE/C,wBAAwB;KAClC6B,IAAI,EAAE5B,oBAAoB;KAC1B+C,YAAY,EAAE;IACd;CACF;CAAC,wDAGD;GACC,MAAMC,eAAe,GAAG,8CAAM,IAAI,6CAAsB;GAExD,MAAMC,wBAAwB,GAAGD,eAAe,CAACE,GAAG,CAAC,CAAC;KAAErB,EAAE;KAAEsB,IAAI;KAAEC;IAAO,MAAM;KAC9EvB,EAAE;KACFC,KAAK,EAAEqB,IAAI;KACXE,KAAK,EAAED;IACP,CAAC,CAAC;;;GAGH,OAAO;KAAEE,SAAS,EAAEL,wBAAwB;KAAEM,SAAS,EAAE;IAAM;CAChE;CAAC,sCAGD;GACC,MAAMC,SAAS,GAAG,8CAAM,IAAI,iCAAe;GAC3C,MAAMF,SAAS,GAAGE,SAAS,CAACN,GAAG,CAAE1C,QAAQ,IAAKA,QAAQ,CAACiD,OAAO,CAAC;GAC/D,MAAMC,cAA2B,GAAG,IAAIC,GAAG,CAACL,SAAS,CAACJ,GAAG,CAAC,CAAC;KAAErB;IAAI,KAAKA,EAAE,CAAC,CAAC;GAE1E,OAAO,CAAC,GAAG6B,cAAc,CAAC,CAACR,GAAG,CAC5BrB,EAAE,IAAKyB,SAAS,CAACM,IAAI,CAAEH,OAAO,IAAKA,OAAO,CAAC5B,EAAE,KAAKA,EAAE,CAAC,CACtD;CACF;CAAC,oDAGD;GAAA;GACC,MAAMS,eAAe,2CAAG,IAAI,6CAAsB;GAClD,MAAMkB,SAAS,GAAG,8CAAM,IAAI,iCAAe;GAC3C,MAAMK,gBAAgB,GAAGL,SAAS,CAACI,IAAI,CAAC,CAAC;KAAEE;IAAY,KAAKA,UAAU,CAAC;GAEvE,IAAIC,iBAAiB,GAAGF,gBAAgB,6CAAhBA,gBAAgB,CAAEJ,OAAO,qBAAzB,sBAA2B5B,EAAE;GACrD,IAAImC,cAAI,CAACC,WAAW,CAACF,iBAAiB,CAAC,EACvC;KAAA;KACC,MAAMT,SAAS,GAAG,8CAAM,IAAI,6CAAsB;KAClDS,iBAAiB,oBAAGT,SAAS,CAACY,EAAE,CAAC,CAAC,CAAC,qBAAf,cAAiBrC,EAAE;;GAGxC,IAAImC,cAAI,CAACC,WAAW,CAACF,iBAAiB,CAAC,EACvC;KACC;;GAGDzB,eAAe,CAAC6B,aAAa,CAACJ,iBAAiB,CAAC;CACjD;CAAC,yCAE8B3B,KAAuC,EACtE;GACC,KAAK,4CAAI,8DAA+BzB,IAAI,EAAE;GAE9C,MAAMyD,SAAS,GAAGhC,KAAK,CAACiC,OAAO,EAAE,CAACD,SAAS;GAC3C,MAAMZ,SAAS,GAAG,8CAAM,IAAI,iCAAe;GAE3C,MAAMc,gBAAgB,GAAGd,SAAS,CAChCe,MAAM,CAAC,CAAC;KAAEd;IAAmB,KAAKA,OAAO,CAAC5B,EAAE,KAAKuC,SAAS,CAAC,CAC3DlB,GAAG,CAAE1C,QAAQ,4CAAK,IAAI,sFAA0CA,QAAQ,CAAC,CAAC;GAE5E,MAAMkB,YAAY,2CAAG,IAAI,qDAA0B;GACnDA,YAAY,CAAC8C,WAAW,EAAE;GAC1B9C,YAAY,CAAC+C,QAAQ,CAACH,gBAAgB,CAAC;GACvC5C,YAAY,CAACgD,eAAe,EAAE;GAE9B,KAAK,4CAAI,8DAA+BC,IAAI,EAAE;CAC/C;;;;;;;;"}