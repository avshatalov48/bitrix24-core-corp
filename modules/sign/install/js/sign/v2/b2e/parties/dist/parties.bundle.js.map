{"version":3,"file":"parties.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Dom, Loc, Tag, Type, Extension } from 'main.core';\nimport { CompanySelector } from 'sign.v2.b2e.company-selector';\nimport { DocumentValidation } from 'sign.v2.b2e.document-validation';\nimport { RepresentativeSelector } from 'sign.v2.b2e.representative-selector';\nimport type { BlankSelectorConfig } from 'sign.v2.blank-selector';\nimport type { Provider } from 'sign.v2.api';\nimport type { DocumentInitiatedType, MemberRoleType, DocumentModeType } from 'sign.type';\nimport { DocumentMode } from 'sign.type';\nimport { Hint } from 'sign.v2.helper';\nimport { isTemplateMode } from 'sign.v2.sign-settings';\n\nconst blockWarningClass = 'sign-document-b2e-parties__item_content--warning';\n\ntype PartiesData = { entityType: string, entityId: ?number, role?: MemberRoleType };\ntype Options = BlankSelectorConfig & { documentInitiatedType?: DocumentInitiatedType, documentMode?: DocumentModeType };\n\nconst currentUserId = Extension.getSettings('sign.v2.b2e.parties').get('currentUserId');\n\nexport class Parties\n{\n\t#companySelector: CompanySelector = null;\n\t#representativeSelector: RepresentativeSelector = null;\n\t#documentValidation: DocumentValidation = null;\n\t#ui = {\n\t\tcontainer: HTMLDivElement = null,\n\t\tblocks: {\n\t\t\tcompanyContent: HTMLDivElement = null,\n\t\t\trepresentativeContent: HTMLDivElement = null,\n\t\t\tvalidationEditorLayout: HTMLDivElement = null,\n\t\t},\n\t};\n\n\tconstructor(blankSelectorConfig: Options, hcmLinkAvailable: boolean)\n\t{\n\t\tconst { region, documentInitiatedType, documentMode } = blankSelectorConfig;\n\t\tthis.#representativeSelector = new RepresentativeSelector({ context: `sign_b2e_representative_selector_assignee_${currentUserId}` });\n\t\tconst isTemplate = isTemplateMode(documentMode || DocumentMode.document);\n\n\t\tthis.#companySelector = new CompanySelector({\n\t\t\tregion,\n\t\t\tdocumentInitiatedType,\n\t\t\tisHcmLinkAvailable: hcmLinkAvailable,\n\t\t\tneedOpenCrmSaveAndEditCompanySliders: isTemplate,\n\t\t});\n\t\tthis.#documentValidation = new DocumentValidation();\n\t}\n\n\tsetEntityId(entityId: number): void\n\t{\n\t\tthis.#companySelector.setOptions({ entityId });\n\t}\n\n\tsetInitiatedByType(initiatedByType: string): void\n\t{\n\t\tthis.#companySelector.setInitiatedByType(initiatedByType);\n\t}\n\n\tsetLastSavedIntegrationId(integrationId: number | null): void\n\t{\n\t\tthis.#companySelector.setLastSavedIntegrationId(integrationId);\n\t}\n\n\tsetIntegrationSelectorAvailability(isAvailable: boolean): void\n\t{\n\t\tthis.#companySelector.setIntegrationSelectorAvailability(isAvailable);\n\t}\n\n\tasync reloadCompanyProviders(): void\n\t{\n\t\tawait this.#companySelector.reloadCompanyProviders();\n\t}\n\n\tsetEditorAvailability(isAvailable: boolean): void\n\t{\n\t\tif (isAvailable)\n\t\t{\n\t\t\tthis.#addEditorLayout();\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#removeEditorLayout();\n\t\tthis.#documentValidation.editorRepresentativeSelector.onSelectorItemDeselectedHandler();\n\t}\n\n\tloadCompany(companyUid: string): void\n\t{\n\t\tthis.#companySelector.load(companyUid);\n\t}\n\n\tloadRepresentative(representativeId: number): void\n\t{\n\t\tthis.#representativeSelector.load(representativeId);\n\t}\n\n\tloadValidator(memberId: number, role: MemberRoleType): void\n\t{\n\t\tthis.#documentValidation.load(memberId, role);\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tthis.#ui.blocks.companyContent = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t<span>${Loc.getMessage('SIGN_PARTIES_ITEM_COMPANY')}</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tdata-hint=\"${Loc.getMessage('SIGN_PARTIES_ITEM_COMPANY_HINT')}\"\n\t\t\t\t\t></span>\n\t\t\t\t</p>\n\t\t\t\t${this.#companySelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tHint.create(this.#ui.blocks.companyContent);\n\t\tthis.#ui.blocks.representativeContent = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --representative\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_REPRESENTATIVE')}\n\t\t\t\t</p>\n\t\t\t\t${this.#representativeSelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tconst providerLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_PROVIDER')}\n\t\t\t\t</p>\n\t\t\t\t${this.#companySelector.getProviderLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tconst validationReviewerLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --reviewer\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_VALIDATION_REVIEWER')}\n\t\t\t\t</p>\n\t\t\t\t${this.#documentValidation.getReviewerLayout()}\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.#ui.blocks.validationEditorLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --editor\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_VALIDATION_EDITOR')}\n\t\t\t\t</p>\n\t\t\t\t${this.#documentValidation.getEditorLayout()}\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.#ui.container = Tag.render`\n\t\t\t<div>\n\t\t\t\t<h1 class=\"sign-b2e-settings__header\">${Loc.getMessage('SIGN_PARTIES_HEADER')}</h1>\n\t\t\t\t${this.#ui.blocks.companyContent}\n\t\t\t\t${providerLayout}\n\t\t\t\t${this.#ui.blocks.representativeContent}\n\t\t\t\t${validationReviewerLayout}\n\t\t\t\t${this.#ui.blocks.validationEditorLayout}\n\t\t\t</div>\n\t\t`;\n\n\t\treturn this.#ui.container;\n\t}\n\n\t#validate(): boolean\n\t{\n\t\tconst validationResults = [\n\t\t\tthis.#companySelector.validate(),\n\t\t\tthis.#representativeSelector.validate(),\n\t\t];\n\n\t\treturn validationResults.every((result: boolean) => result === true);\n\t}\n\n\tasync save(documentId: string)\n\t{\n\t\tthis.#removeWarningFromBlocks();\n\t\tif (!this.#validate())\n\t\t{\n\t\t\tthrow new Error();\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait this.#companySelector.save(documentId);\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tthis.#setWarning(this.#ui.blocks.companyContent);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tgetSelectedIntegrationId(): number | null\n\t{\n\t\treturn this.#companySelector.getIntegrationId();\n\t}\n\n\tgetSelectedProvider(): Provider | null\n\t{\n\t\treturn this.#companySelector.getSelectedCompanyProvider();\n\t}\n\n\tgetParties(): Record<string, PartiesData> & { validation: Array<PartiesData> }\n\t{\n\t\tconst validationData = this.#documentValidation.getValidationData();\n\n\t\treturn {\n\t\t\trepresentative: {\n\t\t\t\tentityType: 'user',\n\t\t\t\tentityId: this.#representativeSelector.getRepresentativeId(),\n\t\t\t},\n\t\t\tcompany: {\n\t\t\t\tentityType: 'company',\n\t\t\t\tentityId: this.#companySelector.getCompanyId(),\n\t\t\t},\n\t\t\tvalidation: Object.entries(validationData).map(([role, entityId]) => {\n\t\t\t\treturn { entityType: 'user', entityId, role };\n\t\t\t}),\n\t\t};\n\t}\n\n\t#setWarning(block: HTMLDivElement): void\n\t{\n\t\tif (Type.isNull(block) || Type.isUndefined(block))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.addClass(block, blockWarningClass);\n\t}\n\n\t#removeWarningFromBlocks(): void\n\t{\n\t\tfor (const [key, block] of Object.entries(this.#ui.blocks))\n\t\t{\n\t\t\tif (Type.isNull(block))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.removeClass(block, blockWarningClass);\n\t\t}\n\t}\n\n\t#addEditorLayout(): void\n\t{\n\t\tDom.append(this.#ui.blocks.validationEditorLayout, this.#ui.container);\n\t}\n\n\t#removeEditorLayout(): void\n\t{\n\t\tDom.remove(this.#ui.blocks.validationEditorLayout);\n\t}\n}\n"],"names":["currentUserId","Extension","getSettings","get","Parties","blankSelectorConfig","hcmLinkAvailable","babelHelpers","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","writable","value","container","HTMLDivElement","blocks","companyContent","representativeContent","validationEditorLayout","region","documentInitiatedType","documentMode","RepresentativeSelector","context","isTemplate","isTemplateMode","DocumentMode","document","CompanySelector","isHcmLinkAvailable","needOpenCrmSaveAndEditCompanySliders","DocumentValidation","key","entityId","setOptions","initiatedByType","setInitiatedByType","integrationId","setLastSavedIntegrationId","isAvailable","setIntegrationSelectorAvailability","_context","reloadCompanyProviders","_classPrivateMethodGet","this","editorRepresentativeSelector","onSelectorItemDeselectedHandler","companyUid","load","representativeId","memberId","role","Tag","render","Loc","getMessage","getLayout","Hint","create","providerLayout","getProviderLayout","validationReviewerLayout","getReviewerLayout","getEditorLayout","documentId","_context2","Error","save","getIntegrationId","getSelectedCompanyProvider","validationData","getValidationData","representative","entityType","getRepresentativeId","company","getCompanyId","validation","Object","entries","map","validate","every","result","block","Type","isNull","isUndefined","Dom","addClass","removeClass","append","remove"],"mappings":"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"}