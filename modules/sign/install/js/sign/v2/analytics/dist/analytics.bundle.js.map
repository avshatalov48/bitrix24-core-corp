{"version":3,"file":"analytics.bundle.js","sources":["../src/context.js","../src/analytics.js"],"sourcesContent":["import type { AnalyticsOptions } from 'ui.analytics';\n\nexport class Context\n{\n\t#options: Partial<AnalyticsOptions> = {};\n\n\tconstructor(options: Partial<AnalyticsOptions> = {})\n\t{\n\t\tthis.#options = options;\n\t}\n\n\tupdate(options: Partial<AnalyticsOptions>): void\n\t{\n\t\tthis.#options = { ...this.#options, ...options };\n\t}\n\n\tgetOptions(): Partial<AnalyticsOptions>\n\t{\n\t\treturn this.#options;\n\t}\n}\n","import { Type } from 'main.core';\nimport { ProviderCode, type ProviderCodeType } from 'sign.type';\nimport { Api } from 'sign.v2.api';\nimport { type AnalyticsOptions, sendData } from 'ui.analytics';\nimport { Context } from './context';\n\nexport { Context };\nexport type { AnalyticsOptions };\n\ntype AnalyticOptionsWithoutToolKey = Omit<AnalyticsOptions, 'tool'>;\n\nexport class Analytics\n{\n\t#documentUidToIdCache: Record<string, number> = {};\n\t#context: Context;\n\t#api: Api = new Api();\n\n\tconstructor(options: { contextOptions?: Partial<AnalyticsOptions> } = {})\n\t{\n\t\tthis.#context = new Context(options.contextOptions ?? {});\n\t}\n\n\tsend(options: AnalyticOptionsWithoutToolKey): void\n\t{\n\t\tsendData({ ...this.#context.getOptions(), ...options, tool: 'sign' });\n\t}\n\n\tsetContext(context: Context): void\n\t{\n\t\tthis.#context = context;\n\t}\n\n\tgetContext(): Context\n\t{\n\t\treturn this.#context;\n\t}\n\n\tsendWithProviderTypeAndDocId(\n\t\toptions: AnalyticOptionsWithoutToolKey,\n\t\tdocumentUidOrId: number | string,\n\t\tproviderCode?: ProviderCodeType,\n\t): void\n\t{\n\t\tvoid this.#sendWithProviderType(options, documentUidOrId, providerCode);\n\t}\n\n\tsendWithDocId(options: AnalyticOptionsWithoutToolKey, documentUidOrId: string | number): void\n\t{\n\t\tif (Type.isNumber(documentUidOrId))\n\t\t{\n\t\t\tthis.send({\n\t\t\t\t...options,\n\t\t\t\tp5: `docId_${documentUidOrId}`,\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\t(async () => {\n\t\t\tconst documentId = await this.#loadDocumentIdByUid(documentUidOrId);\n\t\t\tthis.send({\n\t\t\t\t...options,\n\t\t\t\tp5: `docId_${documentId}`,\n\t\t\t});\n\t\t})();\n\t}\n\n\tasync #loadDocumentIdByUid(documentUid: string): Promise<number | null>\n\t{\n\t\tif (Type.isNumber(this.#documentUidToIdCache[documentUid]))\n\t\t{\n\t\t\treturn this.#documentUidToIdCache[documentUid];\n\t\t}\n\n\t\tconst document = await this.#api.loadDocument(documentUid);\n\t\tif (document)\n\t\t{\n\t\t\tthis.#documentUidToIdCache[documentUid] = document.id;\n\n\t\t\treturn document.id;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tasync #sendWithProviderType(\n\t\toptions: AnalyticOptionsWithoutToolKey,\n\t\tdocumentUidOrId: number | string,\n\t\tproviderCode?: ProviderCodeType,\n\t): Promise<void>\n\t{\n\t\tlet documentId: number | null = Type.isNumber(documentUidOrId)\n\t\t\t? documentUidOrId\n\t\t\t: this.#documentUidToIdCache[documentUidOrId] ?? null\n\t\t;\n\t\tlet providerType = providerCode;\n\t\tif (Type.isNull(documentId) || Type.isUndefined(providerCode))\n\t\t{\n\t\t\tconst document = Type.isString(documentUidOrId)\n\t\t\t\t? await this.#api.loadDocument(documentUidOrId)\n\t\t\t\t: await this.#api.loadDocumentById(documentUidOrId)\n\t\t\t;\n\t\t\tif (!document)\n\t\t\t{\n\t\t\t\tconsole.warn('Document not found by identifier', documentUidOrId);\n\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdocumentId = document.id;\n\t\t\tproviderType = document.providerCode;\n\t\t}\n\n\t\tthis.send({\n\t\t\t...options,\n\t\t\tp1: this.#convertProviderCodeToP1IntegrationType(providerType),\n\t\t\tp5: `docId_${documentId}`,\n\t\t});\n\t}\n\n\t#convertProviderCodeToP1IntegrationType(providerType?: ProviderCodeType): string\n\t{\n\t\tswitch (providerType)\n\t\t{\n\t\t\tcase ProviderCode.sesRu:\n\t\t\tcase ProviderCode.sesCom:\n\t\t\t\treturn 'integration_bitrix24KEDO';\n\t\t\tcase ProviderCode.goskey:\n\t\t\t\treturn 'integration_Goskluch';\n\t\t\tcase ProviderCode.external:\n\t\t\t\treturn 'integration_external';\n\t\t\tdefault:\n\t\t\t\treturn 'integration_N';\n\t\t}\n\t}\n}\n"],"names":["Context","constructor","options","update","getOptions","Analytics","Api","contextOptions","send","sendData","tool","setContext","context","getContext","sendWithProviderTypeAndDocId","documentUidOrId","providerCode","sendWithDocId","Type","isNumber","p5","documentId","documentUid","document","loadDocument","id","providerType","isNull","isUndefined","isString","loadDocumentById","console","warn","p1","ProviderCode","sesRu","sesCom","goskey","external"],"mappings":"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"}