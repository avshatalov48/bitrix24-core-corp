(function(){const{CallsCardController:e}=jn.require("call/calls-card");const{CallController:t}=jn.require("call/calls/controller");const l={incoming:"incoming",startCall:"startcall"};const i={INCOMING:"INCOMING",FINISHED:"FINISHED",STARTED:"STARTED",OUTGOING:"OUTGOING",WAITING:"WAITING",CALLBACK:"CALLBACK"};const a={onHangup:"onHangupCallClicked",onSpeakerphoneChanged:"onSpeakerphoneCallClicked",onMuteChanged:"onMuteCallClicked",onPauseChanged:"onPauseCallClicked",onNumpadClicked:"onNumpadClicked",onFormFolded:"onFoldCallClicked",onFormExpanded:"onUnfoldIconClicked",onCloseClicked:"onCloseCallClicked",onSkipClicked:"onSkipCallClicked",onAnswerClicked:"onAnswerCallClicked",onNumpadClosed:"onNumpadClosed",onNumpadButtonClicked:"onNumpadButtonClicked",onPhoneNumberReceived:"onPhoneNumberReceived",onContactListChoose:"onContactListChoose",onContactListMenuChoose:"onContactListMenuChoose"};const s=30;const n="mobile/crm/#ENTITY#/?page=view&#ENTITY#_id=#ID#";const o=["lead","contact","company","deal"];const r=()=>{try{const{inAppUrl:e}=jn.require("in-app-url");return e}catch(e){console.log(e,"In-app-url not found");return null}};function h(e){const t=(new Date).getTime();return Math.round(Math.abs(t-e)/1e3)}function c(e){if(typeof e!=="object"||typeof e.params==="undefined"){return{ACTION:"NONE"}}let t={};try{t=JSON.parse(e.params)}catch(l){t={ACTION:e.params}}return t}function d(e,t){e=e.toLowerCase();if(o.indexOf(e)===-1){return""}return currentDomain+BX.componentParameters.get("siteDir","/")+n.replace(/#ENTITY#/g,e).replace(/#ID#/g,t)}function C(e){e=e.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replaceAll(/&#(\d+);/g,((e,t)=>String.fromCharCode(t)));return e}include("Calls");if(Application.getApiVersion()>=36&&typeof media=="undefined"){include("media")}const m=Application.getApiVersion()>48;class u{constructor(){this.ui=this.createUI();this.userId=parseInt(BX.componentParameters.get("userId",0));Object.defineProperties(this,{isAdmin:{get:()=>BX.componentParameters.get("isAdmin",false)},voximplantInstalled:{get:()=>BX.componentParameters.get("voximplantInstalled",false)},canPerformCalls:{get:()=>BX.componentParameters.get("canPerformCalls",false)},lines:{get:()=>BX.componentParameters.get("lines",{}),set:e=>BX.componentParameters.set("lines",e)},defaultLineId:{get:()=>BX.componentParameters.get("defaultLineId",""),set:e=>BX.componentParameters.set("defaultLineId",e)}});this._callId=null;Object.defineProperty(this,"callId",{get:()=>this._callId,set:e=>{if(this._callId!=e){this._callId=e;BX.postComponentEvent("CallEvents::hasActiveTelephonyCall",[!!this._callId],"communication")}}});this.call=null;this.phoneNumber=null;this.phoneFullNumber=null;this.lineNumber="";this.phoneRinging=0;this.callConfig={};this.callDevice="PHONE";this.crmData={};this.transferUser=0;this.callInit=false;this.callActive=false;this.answered=false;this.debug=true;this.connected=false;this.authorized=false;this.ignoreAnswerSelf=false;this.isIncoming=false;this.isTransfer=false;this.isRestCall=false;this.formShown=false;this.portalCall=false;this.showName=true;this.isOutgoingCallCanceled=false;Object.defineProperty(this,"nativeCall",{get:()=>{if("callservice"in window){const e=callservice.currentCall();return e&&e.params.type==="telephony"?e:null}else{return null}}});this._onNativeCallAnsweredHandler=this._onNativeCallAnswered.bind(this);this._onNativeCallEndedHandler=this._onNativeCallEnded.bind(this);this._onNativeCallMutedHandler=this._onNativeCallMuted.bind(this);this.init()}createUI(){if(m){return new e({onUiEvent:this.onUiEvent.bind(this)})}return new VoiceCallForm({eventListener:this.onUiEvent.bind(this)})}updateUI(e){if(!this.formShown){return}const{headerLabels:t,middleLabels:l,middleButtons:i,footerLabels:a,state:s,...n}=e;if(m){this.ui.update({...n})}else{if(t){this.ui.updateHeader({headerLabels:t})}if(n.avatarUrl){this.ui.updateHeader({avatarUrl:n.avatarUrl})}if(l&&i){this.ui.updateMiddle({middleLabels:l})}if(i){this.ui.updateMiddle({middleButtons:i})}if(a){this.ui.updateFooter({footerLabels:a})}if(s){this.ui.updateFooter({state:s})}}}init(){BX.addCustomEvent("onPhoneTo",this.onPhoneTo.bind(this));BX.addCustomEvent("onNumpadRequestShow",this.onNumpadRequestShow.bind(this));BX.addCustomEvent("onPullEvent-voximplant",this.onPullEvent.bind(this));BX.addCustomEvent("onAppActive",this.onAppActive.bind(this));VIClient.getInstance().on(VIClient.Events.IncomingCall,this._onIncomingCall.bind(this));this._onNativeIncomingCallHandler=this._onNativeIncomingCall.bind(this);if("callservice"in window){callservice.on("incoming",this._onNativeIncomingCallHandler);if(this.nativeCall){setTimeout((()=>this._onNativeIncomingCall(this.nativeCall)),0)}}this.onAppActive()}onAppActive(){let e=c(Application.getLastNotification());if(BX.type.isNotEmptyString(e["ACTION"])&&e["ACTION"].indexOf("VI_CALL_")===0){this.log("Starting application from push",e);let t=e.PARAMS||{};if(t.callId){t.autoAnswer=true;this._onCallInvite(t)}}}onPhoneTo(e){this.log("onPhoneTo",e);let t=e.number;let l=e.params;const i=e.isNumberHidden;l=l||{};if(typeof l!="object"){try{l=JSON.parse(l)}catch(e){l={}}}if(this.canUseTelephony()){this.phoneCall(t,l,i)}}onNumpadRequestShow(){this.log("onNumpadRequestShow");if(Application.getApiVersion()>=22){if(this.canUseTelephony()){this.ui.showNumpad()}}}canUseTelephony(){return this.voximplantInstalled&&this.canPerformCalls}onUiEvent(e){this.log("onUiEvent: ",e);let t=e.eventName;let l={[a.onHangup]:this._onUiHangup,[a.onSpeakerphoneChanged]:this._onUiSpeakerphoneChanged,[a.onMuteChanged]:this._onUiMuteChanged,[a.onPauseChanged]:this._onUiPauseChanged,[a.onCloseClicked]:this._onUiCloseClicked,[a.onSkipClicked]:this._onUiSkipClicked,[a.onAnswerClicked]:this._onUiAnswerClicked,[a.onNumpadButtonClicked]:this._onUiNumpadButtonClicked,[a.onPhoneNumberReceived]:this._onUiPhoneNumberReceived};if(BX.type.isFunction(l[t])){l[t].call(this,e)}else if(t.substring(0,4)=="crm_"){let e=t.split("_");this._onUiCrmLinkClick({entityType:e[1],entityId:e[2]})}else if(t.substring(0,12)==="create_deal_"){const e=t.split("_");this._onUiCrmCreateDealLinkClick(e[1],e[2])}else if(t.substring(0,16)==="create_by_phone_"){const e=t.split("_");this._onUiCrmCreateByPhoneLinkClick(e[3],e[4],e[5])}}_onUiCrmCreateDealLinkClick(e,t){const l=d(e,0);if(!l){return}const i=r();if(Application.getApiVersion()>=45&&i){i.open(`/crm/${e}/details/0/?contact_id=${t}`,{categoryId:0,canOpenInDefault:true,bx24ModernStyle:true,linkText:BX.message(`IM_M_CALL_NEW_${e.toUpperCase()}`)},(()=>{this._onOpenPage(l)}))}this.ui.rollUp()}_onUiCrmCreateByPhoneLinkClick(e,t,l){const i=d(e,0);if(!i){return}const a=r();if(Application.getApiVersion()>=45&&a){a.open(`/crm/${e}/details/0/?phone=${t}&page=edit&origin_id=${this.crmData.ORIGIN_ID}`,{categoryId:0,canOpenInDefault:true,bx24ModernStyle:true,linkText:BX.message(`IM_M_CALL_NEW_${e.toUpperCase()}`)},(()=>{this._onOpenPage(i)}))}this.ui.rollUp()}onPullEvent(e,t,l){this.log("onPullEvent-voximplant",e,t,l);let i={invite:this._onPullEventInvite.bind(this),answer_self:this._onPullEventAnswerSelf.bind(this),timeout:this._onPullEventTimeout.bind(this),outgoing:this._onPullEventOutgoing.bind(this),start:this._onPullEventStart.bind(this),hold:this._onPullEventHold.bind(this),unhold:this._onPullEventUnHold.bind(this),updatePortalUser:this._onPullEventUpdatePortalUser.bind(this),update_crm:this._onPullEventUpdateCrm.bind(this),completeTransfer:this._onPullEventCompleteTransfer,changeDefaultLineId:this._onPullEventChangeDefaultLineId.bind(this),replaceCallerId:this._onPullEventReplaceCallerId.bind(this)};if(BX.type.isFunction(i[e])){i[e](t,l)}}requestMicrophoneAccess(){return new Promise(((e,t)=>{MediaDevices.requestMicrophoneAccess().then((()=>e())).catch((({justDenied:e})=>t(new DeviceAccessError(e))))}))}answerCall(){if(this.answered){return}this.answered=true;this.updateUI({state:i.WAITING,footerLabels:{callStateLabel:{text:BX.message("IM_M_CALL_ST_CONNECT")}},type:i.WAITING,status:BX.message("IM_M_CALL_ST_CONNECT")});_.sendAnswer(this.callId).catch((e=>{let t=e.answer;let l=null;this.log("voximplant.call.answer error: ",t);if(!this.callInit&&!this.callActive){return}this.ui.stopSound();if(t.error==="ERROR_NOT_FOUND"){l=BX.message("IM_M_CALL_ALREADY_FINISHED")}else if(t.error==="ERROR_WRONG_STATE"){l=BX.message("IM_M_CALL_ALREADY_ANSWERED")}else{l=BX.message("IM_PHONE_ERROR")}this.updateUI({footerLabels:{callStateLabel:{text:l}},state:i.FINISHED,type:i.FINISHED,error:l})})).then((()=>VIClientWrapper.getClient())).then((()=>{CallUtil.log("voximplant.call.sendReady");BX.rest.callMethod("voximplant.call.sendReady",{CALL_ID:this.callId})}))}phoneCall(e,t,a=false){if(!this.canUseTelephony()){return false}if(!CallUtil.isDeviceSupported()){navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"));return}this.log("phoneCall",e,t);if(typeof fabric==="object"){fabric.Answers.sendCustomEvent("outgoingCallTelephony",{})}let s=this.phoneCorrect(e);if(!BX.type.isPlainObject(t)){t={}}if(s.length<=0){this.log("Wrong number");return false}if(this.callActive||this.callInit){return false}this.ui.playSound({soundId:l.startCall});if(this.isRestLine(this.defaultLineId)){this.startCallViaRest(e,this.defaultLineId,t);return}this.callInit=true;this.callActive=false;this.isOutgoingCallCanceled=false;this.phoneNumber=s;this.phoneFullNumber=s;this.isNumberHidden=a;if(t["NAME"]){this.crmData={CONTACT:{NAME:t["NAME"]}}}if(typeof t["SHOW_NAME"]==="boolean"){this.showName=t["SHOW_NAME"]}this.phoneParams=t;var n=/(\+?\d+)([;#]*)([\d,]*)/.exec(s);if(n){this.phoneNumber=n[1]}if(this.phoneFullNumber!=this.phoneNumber){this.phoneParams["FULL_NUMBER"]=this.phoneFullNumber}this.showCallForm({status:BX.message("IM_M_CALL_ST_CONNECT"),state:i.OUTGOING});this.requestMicrophoneAccess().then((()=>VIClientWrapper.getClient())).then((e=>{if(this.isOutgoingCallCanceled){this.isOutgoingCallCanceled=false;return}this.call=e.call(this.phoneNumber,this.phoneParams);this.call.on(JNVICall.Events.Connected,this._onCallConnected.bind(this));this.call.on(JNVICall.Events.Disconnected,this._onCallDisconnected.bind(this));this.call.on(JNVICall.Events.Failed,this._onCallFailed.bind(this));this.call.on(JNVICall.Events.Ringing,this._onCallProgressToneStart.bind(this));this.call.start()})).catch((e=>{console.error(e);let t=null;if(e instanceof DeviceAccessError){t=BX.message("IM_PHONE_ERR_NO_MIC");CallUtil.showDeviceAccessConfirm(false,(()=>Application.openSettings()))}else{t=BX.message("MOBILEAPP_SOME_ERROR")}this.updateUI({state:i.FINISHED,footerLabels:{callStateLabel:{text:t}},type:i.FINISHED,error:t});this.finishCall()}))}startCallViaRest(e,t,l){let a=this.getRestAppName(t);this.isRestCall=true;this.phoneNumber=e;this.showCallForm({status:BX.message("IM_PHONE_OUTGOING_REST").replace("#APP_NAME#",a),state:i.FINISHED});BX.rest.callMethod("voximplant.call.startViaRest",{NUMBER:e,LINE_ID:t,PARAMS:l}).then((e=>{this.log("voximplant.call.startViaRest: ",e);let t=e.data();if(t.DATA&&t.DATA.CRM){this.setCrmData(t.DATA.CRM)}}))}finishCall(){if(this.call){this.call.hangup();this.call=null;this.isOutgoingCallCanceled=false}if(this.nativeCall){this.nativeCall.finish()}this.callId=null;this.phoneNumber=null;this.lineNumber="";this.phoneRinging=0;this.callConfig={};this.callDevice="PHONE";this.crmData={};this.transferUser=0;this.callInit=false;this.callActive=false;this.answered=false;this.ignoreAnswerSelf=false;this.isIncoming=false;this.isTransfer=false;this.isRestCall=false;this.portalCall=false;this.showName=true;this.ui.pauseTimer();device.setProximitySensorEnabled(false)}sendSkip(){if(this.callInit&&this.isIncoming){BX.rest.callMethod("voximplant.call.skip",{CALL_ID:this.callId})}}setCallHold(e){if(!this.call){return false}this.call.sendMessage(JSON.stringify({COMMAND:e?"hold":"unhold"}))}getUiFields(){let e={};let t={};let l={};let i="";const a={};let s=null;let n=null;let o=null;let r=null;if(this.crmData.FOUND=="Y"){s=this.crmData.CONTACT&&this.crmData.CONTACT.NAME?this.crmData.CONTACT.NAME:"";let h=this.crmData.CONTACT&&this.crmData.CONTACT.PHOTO?this.crmData.CONTACT.PHOTO:"";let c=this.crmData.CONTACT&&this.crmData.CONTACT.POST?this.crmData.CONTACT.POST:"";n=this.crmData.COMPANY?this.crmData.COMPANY:"";r={text:this.crmData.STATUS_TEXT||null,color:this.crmData.STATUS_COLOR||null};if(!this.portalCall&&!this.isRestCall&&this.callConfig.hasOwnProperty("RECORDING")){if(this.callConfig.RECORDING=="Y"){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_ON"),textColor:"#ecd748"};o=BX.message("IM_PHONE_REC_ON")}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"};o=BX.message("IM_PHONE_REC_OFF")}}if(s){e.firstHeader={text:s}}if(c){e.firstSmallHeader={text:c}}if(n){e.secondSmallHeader={text:n}}i="";if(!CallUtil.isAvatarBlank(h)){if(h.startsWith("http")){i=encodeURI(h)}else{i=currentDomain+encodeURI(h)}}if(this.crmData.DEALS&&this.crmData.DEALS.length>0){a.deal=this.crmData.DEALS[0];t={infoTitle:{text:""},infoDesc:{text:this.crmData.DEALS[0].TITLE},infoHeader:{text:this.crmData.DEALS[0].STAGE,textColor:this.crmData.DEALS[0].STAGE_COLOR},infoSum:{text:C(this.crmData.DEALS[0].OPPORTUNITY)}};if(this.crmData.DEAL_URL){a.openDealEventName="crm_deal_"+this.crmData.DEALS[0].ID;l["button1"]={text:BX.message("IM_PHONE_ACTION_T_DEAL"),sort:100,eventName:"crm_deal_"+this.crmData.DEALS[0].ID}}}else if(this.crmData.LEAD&&this.crmData.LEAD.ID){a.lead=this.crmData.LEAD?this.crmData.LEAD:null;a.openLeadEventName="crm_lead_"+this.crmData.LEAD.ID}let d=[];if(this.crmData.COMPANY_DATA&&this.crmData.CONTACT_DATA){d=["CONTACT_DATA","COMPANY_DATA","LEAD_DATA"]}else if(this.crmData.CONTACT_DATA&&this.crmData.LEAD_DATA){d=["CONTACT_DATA","LEAD_DATA"]}else if(this.crmData.LEAD_DATA&&this.crmData.COMPANY_DATA){d=["LEAD_DATA","COMPANY_DATA"]}else{if(this.crmData.CONTACT_DATA){d=["CONTACT_DATA"]}else if(this.crmData.COMPANY_DATA){d=["COMPANY_DATA"]}else if(this.crmData.LEAD_DATA){d=["LEAD_DATA"]}}for(let e=0;e<d.length;e++){let t=d[e];if(this.crmData[t]){if(t=="CONTACT_DATA"){a.openContactEventName="crm_contact_"+this.crmData[t].ID;l["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_CONTACT"),sort:200+e,eventName:"crm_contact_"+this.crmData[t].ID}}else if(t=="COMPANY_DATA"){a.openCompanyEventName="crm_company_"+this.crmData[t].ID;l["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_COMPANY"),sort:200+e,eventName:"crm_company_"+this.crmData[t].ID}}else if(t=="LEAD_DATA"){a.openLeadEventName="crm_lead_"+this.crmData[t].ID;l["buttonData"+e]={text:BX.message("IM_PHONE_ACTION_T_LEAD"),sort:200+e,eventName:"crm_lead_"+this.crmData[t].ID}}}}if(this.portalCall){t.imageStub={backgroundColor:"#464f58",display:"visible"}}}else{let l;if(!this.phoneNumber||this.phoneNumber=="hidden"){l=BX.message("IM_PHONE_HIDDEN_NUMBER")}else{l=this.phoneNumber.toString();if(l.substr(0,1)!=="8"&&l.substr(0,1)!=="+"&&!isNaN(parseInt(l))&&l.length>=10){l="+"+l}}e.firstHeader={text:l};if(m){if(this.crmData.CONTACT&&this.crmData.CONTACT.NAME){s=this.crmData.CONTACT.NAME}if(this.crmData.COMPANY&&this.crmData.COMPANY.NAME){n=this.crmData.COMPANY.NAME}}else{s=l}e.firstSmallHeader={};if(this.isIncoming){e.firstSmallHeader.text=this.lineNumber?BX.message("IM_PHONE_CALL_TO_PHONE").replace("#PHONE#",this.lineNumber):BX.message("IM_VI_CALL")}else{e.firstSmallHeader.text=BX.message("IM_PHONE_OUTGOING")}e.firstSmallHeader.textColor="#959ca4";if(!this.portalCall&&!this.isRestCall&&this.callConfig.hasOwnProperty("RECORDING")){if(this.callConfig.RECORDING=="Y"){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_ON"),textColor:"#ecd748"};o=BX.message("IM_PHONE_REC_ON")}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"};o=BX.message("IM_PHONE_REC_OFF")}}t.imageStub={backgroundColor:"#464f58",display:"visible"}}if(this.crmData.LEAD_URL&&this.crmData.CAN_CREATE_LEAD){a.createLeadEventName="create_by_phone_lead_"+this.phoneNumber}if(this.crmData.CONTACT_URL){a.createContactEventName="create_by_phone_contact_"+this.phoneNumber}if(this.crmData.DEAL_URL&&this.crmData.CONTACT_DATA){a.createDealEventName="create_deal_"+this.crmData.CONTACT_DATA.ID}return{headerLabels:e,middleLabels:t,middleButtons:l,avatarUrl:i,phoneNumber:this.phoneNumber&&this.phoneNumber.toString(),crmData:a,crmContactName:s,crmCompanyName:n,recordText:o,crmStatus:r,showName:this.showName,isNumberHidden:this.isNumberHidden}}showCallForm(e){let t=this.getUiFields();if(e.status){t.status=e.status;t.footerLabels={callStateLabel:{text:e.status}}}if(e.state){t.state=e.state;t.type=e.state}this.log("callFormParams: ",t);this.ui.show(t);this.formShown=true;device.setProximitySensorEnabled(true);device.setIdleTimerDisabled(true)}closeCallForm(){this.ui.closeNumpad();this.ui.close();this.formShown=false;device.setProximitySensorEnabled(false);device.setIdleTimerDisabled(false)}setCrmData(e){if(!BX.type.isPlainObject(e)){e={FOUND:"N"}}this.crmData=e;if(this.crmData.FOUND==="Y"){this.updateUI(this.getUiFields())}}setProgress(e,t=""){if(e=="connect"){}else if(e=="wait"){this.updateUI({footerLabels:{callStateLabel:{text:t}},state:i.WAITING,type:i.WAITING,error:t})}else if(e=="online"){let e={thirdSmallHeader:{text:""}};if(!this.portalCall&&this.callConfig.hasOwnProperty("RECORDING")){if(this.callConfig.RECORDING=="Y"){if(!m){e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_NOW"),textColor:"#7fc62c"}}}else{e.thirdSmallHeader={text:BX.message("IM_PHONE_REC_OFF"),textColor:"#ee423f"}}}this.updateUI({headerLabels:e,footerLabels:{callStateLabel:{text:t}},status:t,state:i.STARTED,type:i.STARTED,recordText:e.thirdSmallHeader.text})}else if(e=="offline"||e=="error"){let l={};let a={callStateLabel:{text:t}};let s=null;if(e=="offline"){if(!this.portalCall){if(this.callConfig.RECORDING=="Y"&&this.phoneCallTime>0){l.thirdSmallHeader={text:BX.message("IM_PHONE_REC_DONE"),textColor:"#7fc62c"};s=BX.message("IM_PHONE_REC_DONE")}else{l.thirdSmallHeader={text:""}}let e={};if(this.crmData.LEAD_DATA&&!this.crmData.CONTACT_DATA&&!this.crmData.COMPANY_DATA&&this.callConfig.CRM_CREATE=="lead"){e.actionDoneHint={text:BX.message("IM_PHONE_LEAD_SAVED")}}else{e.actionDoneHint={text:""}}}}else{l.thirdSmallHeader={text:""};a.actionDoneHint={text:""}}this.updateUI({headerLabels:l,footerLabels:a,state:i.FINISHED,type:i.FINISHED,recordText:s,error:t});if(this.formShown){this.ui.expand()}}}toggleMute(e){if(!this.call){return}this.call.sendAudio=!e}isRestLine(e){return this.lines.hasOwnProperty(e)&&this.lines[e]["TYPE"]==="REST"}getRestAppName(e){if(!this.lines.hasOwnProperty(e)){return""}if(this.lines[e]["TYPE"]!=="REST"){return""}let t=this.lines[e]["FULL_NAME"];return t.substr(t.indexOf(":")+2)}_onNativeIncomingCall(e){if(e.params.type!=="telephony"){return}let t=e.params.ts;let l=(new Date).getTime()/1e3-t;if(l>15){CallUtil.error("Call originated too long time ago")}this._onCallInvite(e.params);this._bindNativeCallEvents(e);if(Application.isBackground()){CallUtil.log("Application in background, starting p&p");CallUtil.forceBackgroundConnectPull(15).then((()=>{CallUtil.log("p&p connected")})).catch((e=>{CallUtil.error(e)}))}else{CallUtil.log("Received native call in foreground",e.params)}}_bindNativeCallEvents(e){e.on("answered",this._onNativeCallAnsweredHandler).on("ended",this._onNativeCallEndedHandler).on("muted",this._onNativeCallMutedHandler)}_onIncomingCall(e){this.log("_onIncomingCall",e);if(this.call){this.log("call already exists");return}if(!("on"in e)){this.sendSkip();this.finishCall();navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"))}this.call=e;this.call.on(JNVICall.Events.Connected,this._onCallConnected.bind(this));this.call.on(JNVICall.Events.Disconnected,this._onCallDisconnected.bind(this));this.call.on(JNVICall.Events.Failed,this._onCallFailed.bind(this));this.requestMicrophoneAccess().then((()=>this.call.answer())).catch((e=>{console.error(e);let t=null;if(e instanceof DeviceAccessError){t=BX.message("IM_PHONE_ERR_NO_MIC");CallUtil.showDeviceAccessConfirm(false,(()=>Application.openSettings()))}else{t=BX.message("MOBILEAPP_SOME_ERROR")}this.updateUI({footerLabels:{callStateLabel:{text:t}},state:i.FINISHED,type:i.FINISHED,error:t});this.finishCall()}))}_onConnectionEstablished(e){this.log("_onConnectionEstablished",e);CallUtil.log("_onConnectionEstablished",e);this.connected=true}_onConnectionClosed(e){this.log("_onConnectionClosed",e);this.connected=false;this.authorized=false;if(this.callInit||this.callActive){this.setProgress("error",BX.message("IM_M_CALL_ERR"));this.finishCall()}}_onConnectionFailed(e){this.log("_onConnectionFailed",e);this.connected=false;this.authorized=false;if(this.callInit||this.callActive){this.setProgress("error",BX.message("IM_M_CALL_ERR"));this.finishCall()}}_onCallConnected(e){this.log("_onCallConnected",e);const t=m?"":BX.message("IM_M_CALL_ST_ONLINE");this.setProgress("online",t);this.callActive=true}_onCallDisconnected(e){this.log("_onCallDisconnected",e);this.finishCall();this.closeCallForm()}_onCallFailed(e){this.log("_onCallFailed",e);let t=null;if(m){t=BX.message("IM_PHONE_END")}let l=m?"":BX.message("IM_PHONE_END");if(this.phoneNumber==911||this.phoneNumber==112){l=BX.message("IM_PHONE_NO_EMERGENCY")}else if(e.code==603){l=BX.message("IM_PHONE_DECLINE")}else if(e.code==380){l=BX.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){l=BX.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){l=BX.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){l=BX.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){l=BX.message("IM_PHONE_401")}else if(e.code==480||e.code==503){l=BX.message("IM_PHONE_UNAVAILABLE")}else if(e.code==484||e.code==404){l=BX.message("IM_PHONE_INCOMPLETED")}else if(e.code==402){l=BX.message("IM_PHONE_NO_MONEY")+(this.isAdmin?" "+BX.message("IM_PHONE_PAY_URL_NEW"):"")}else if(e.code==486&&this.phoneRinging>1){l=BX.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){l=BX.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){l=BX.message("IM_PHONE_403")}this.finishCall();this.updateUI({state:i.FINISHED,footerLabels:{callStateLabel:{text:l}},errorText:l,type:i.FINISHED,status:t});setTimeout((()=>{this.closeCallForm()}),3e3)}_onCallProgressToneStart(e){this.log("_onCallProgressToneStart",e);this.phoneRinging++;this.updateUI({state:i.FINISHED,type:i.WAITING})}_onCallProgressToneStop(e){this.log("_onCallProgressToneStop",e)}_onUiHangup(e){this.ui.cancelDelayedClosing();this.finishCall();this.closeCallForm()}_onUiSpeakerphoneChanged(e){let t=e.params;let l=t.selected;if(!this.call){return false}if(m){this.selectAudioDevice(l)}}selectAudioDevice(e){if(e){JNVIAudioManager.selectAudioDevice("speaker")}else{JNVIAudioManager.selectAudioDevice("receiver")}}_onUiMuteChanged(e){CallUtil.log("_onUiMuteChanged",e);let t=e.params;let l=t.selected;this.toggleMute(l);if(this.nativeCall){this.nativeCall.mute(l)}}_onUiPauseChanged(e){let t=e.params;let l=t.selected;this.setCallHold(l)}_onUiCloseClicked(e){this.isOutgoingCallCanceled=true;this.finishCall();this.closeCallForm();this.formShown=false}_onUiSkipClicked(e){this.sendSkip();this.finishCall();this.closeCallForm()}_onUiAnswerClicked(){this.ignoreAnswerSelf=true;this.ui.stopSound();this.answerCall();if(this.nativeCall){this.nativeCall.answer()}}_onUiNumpadButtonClicked(e){let t=e.params;if(this.call){this.call.sendDTMF(t)}}_onUiPhoneNumberReceived(e){if(Application.getApiVersion()>=22){var t=e.params;this.phoneCall(t)}}_onUiCrmLinkClick(e){let t=e.entityType;let l=e.entityId;let i=d(t,l);if(!i){return}if(Application.getApiVersion()>=45){if(typeof BX.MobileTools!=="undefined"){const e=BX.MobileTools.resolveOpenFunction(i);if(e){e()}}else{const e=r();if(e){e.open(`/crm/${t}/details/${l}/`,{canOpenInDefault:true,bx24ModernStyle:true},(()=>{this._onOpenPage(i)}))}}}else{this._onOpenPage(i)}this.ui.rollUp()}_onOpenPage(e){PageManager.openPage({url:e,bx24ModernStyle:true})}_onNativeCallAnswered(e){CallUtil.log("onNativeCallAnswered");this.ignoreAnswerSelf=true;this.ui.stopSound();this.answerCall()}_onNativeCallEnded(e){CallUtil.log("onNativeCallEnded");if(e){setTimeout((()=>e.fullfill()),500)}if(!this.callId){return}if(this.callActive){this._onUiHangup()}else if(this.callInit){this._onUiSkipClicked()}}_onNativeCallMuted(e){CallUtil.log("onNativeCallMuted ",e);this.toggleMute(e);if(this.ui.setUiMicEnabled){this.ui.setUiMicEnabled(e)}}_onCallInvite(e){this.log("_onCallInvite",e);if(!CallUtil.isDeviceSupported()){navigator.notification.alert(BX.message("MOBILE_CALL_UNSUPPORTED_VERSION"));return}if(typeof fabric==="object"){fabric.Answers.sendCustomEvent("incomingCallTelephony",{})}if(this.callInit||this.callActive){return false}this.crmData=e.CRM&&e.CRM.FOUND?e.CRM:{};this.portalCall=e.portalCall===true;if(this.portalCall&&e.portalCallData){e.phoneNumber="";if(e.portalCallUserId){this.crmData.FOUND="Y";this.crmData.CONTACT={NAME:e.portalCallData.users[e.portalCallUserId].name,PHOTO:e.portalCallData.users[e.portalCallUserId].avatar}}else{}}this.callConfig=e.config?e.config:{};this.phoneCallTime=0;if(!this.nativeCall){this.ui.playSound({soundId:l.incoming})}e.isCallback=!!e.isCallback;e.isTransfer=!!e.isTransfer;this.phoneNumberUser=e.callerId;e.callerId=e.callerId.replace(/[^a-zA-Z0-9\.]/g,"");this.callInit=true;this.callActive=false;this.isIncoming=true;this.phoneCallTime=0;this.callId=e.callId;this.phoneNumber=e.callerId;this.phoneParams={};this.isTransfer=e.isTransfer;this.lineNumber=e.companyPhoneNumber;CallUtil.log("this.showCallForm");this.showCallForm({status:BX.message("IM_PHONE_INITIALIZATION"),state:i.INCOMING});BX.rest.callMethod("voximplant.call.sendWait",{CALL_ID:e.callId,DEBUG_INFO:this.getDebugInfo()}).then((t=>{let l=t.data();this.log("voximplant.call.sendWait data:",l);if(!this.callInit&&!this.callActive){return}if(l.SUCCESS){this.updateUI({state:i.INCOMING,footerLabels:{callStateLabel:{text:e.isCallback?BX.message("IM_PHONE_INVITE_CALLBACK"):BX.message("IM_PHONE_INVITE")}},type:i.INCOMING,status:e.isCallback?BX.message("IM_PHONE_INVITE_CALLBACK"):BX.message("IM_PHONE_INVITE")});if(e.autoAnswer){this._onUiAnswerClicked()}}else{this.updateUI({state:i.FINISHED,footerLabels:{callStateLabel:{text:BX.message("IM_PHONE_ERROR")}},type:i.FINISHED,error:BX.message("IM_PHONE_ERROR")});this.ui.stopSound()}})).catch((e=>{let t=e.answer;let l=null;this.log("voximplant.call.sendWait"+" error: ",t);if(!this.callInit&&!this.callActive){return}this.ui.stopSound();if(t.error==="ERROR_NOT_FOUND"){l=BX.message("IM_M_CALL_ALREADY_FINISHED")}else if(t.error==="ERROR_WRONG_STATE"){l=BX.message("IM_M_CALL_ALREADY_ANSWERED")}else{l=BX.message("IM_PHONE_ERROR")}this.updateUI({state:i.FINISHED,footerLabels:{callStateLabel:{text:l}},type:i.FINISHED,error:l})}))}_onPullEventInvite(e,t){if(t.server_time_ago>=s){this.log("Call was started too long time ago");return}if(this.callInit||this.callActive){return false}this._onCallInvite(e)}_onPullEventAnswerSelf(e){if(this.ignoreAnswerSelf||this.callId!=e.callId){return false}this.finishCall();this.ui.stopSound();this.closeCallForm();this.callInit=true;this.callId=e.callId}_onPullEventTimeout(e){if(this.callId!=e.callId){return false}this.ui.stopSound();this.closeCallForm();this.finishCall()}_onPullEventOutgoing(e,t){if(t.server_time_ago>=s){this.log("Call was started too long time ago");return}this.portalCall=e.portalCall===true;if(this.callInit&&this.phoneNumber==e.phoneNumber){if(!this.callId){this.setProgress("connect",BX.message("IM_PHONE_WAIT_ANSWER"));this.callConfig=e.config||{};this.callId=e.callId;this.phoneCallTime=0;this.setCrmData(e.CRM)}if(this.portalCall){if(e.portalCallUserId){this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallData.users[e.portalCallUserId].name,PHOTO:e.portalCallData.users[e.portalCallUserId].avatar}})}else{this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallQueueName}})}}}}_onPullEventStart(e){if(this.callId!=e.callId){return false}this.ui.startTimer();this.ui.stopSound();this.callActive=true;if(e.CRM){this.setCrmData(e.CRM)}}_onPullEventHold(e){if(this.callId==e.callId){this.phoneHolded=true}}_onPullEventUnHold(e){this.phoneHolded=false}_onPullEventUpdatePortalUser(e){if(this.callId==e.callId&&e.portalCallUserId){this.setCrmData({FOUND:"Y",CONTACT:{NAME:e.portalCallData.users[e.portalCallUserId].name,PHOTO:e.portalCallData.users[e.portalCallUserId].avatar}})}}_onPullEventUpdateCrm(e){if(this.callId==e.callId&&e.CRM){this.setCrmData(e.CRM)}}_onPullEventCompleteTransfer(e){if(this.callId!=e.callId){return false}this.callId=e.newCallId;this.isTransfer=false}_onPullEventPhoneDeviceActive(e){}_onPullEventChangeDefaultLineId(e){this.defaultLineId=e.defaultLineId;if(!this.lines.hasOwnProperty(this.defaultLineId)){this.lines[this.defaultLineId]=e.line}}_onPullEventReplaceCallerId(e){let t=BX.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",e.callerId);this.setCallOverlayTitle(t);if(e.CRM){this.setCrmData(e.CRM)}}getDebugInfo(){return{isMobile:"Y",callInit:this.callInit?"Y":"N",callActive:this.callActive?"Y":"N",appVersion:Application.getAppVersion(),apiVersion:Application.getApiVersion(),buildVersion:Application.getBuildVersion()}}phoneCorrect(e){return e.toString().replace(/[^0-9+#*;,]/g,"")}log(){if(this.debug){console.log.apply(null,arguments)}}logged(e){let t=this;return function(){let l=[e.name].concat(arguments);console.log.apply(null,l);e.apply(t,arguments)}}}class _{static sendAnswer(e){return new Promise(((t,l)=>{BX.rest.callMethod("voximplant.call.answer",{CALL_ID:e}).then(t).catch(l)}))}}if("callEngine"in window){}window.CallUtil=new CCallUtil;window.callEngine=new CallEngine;window.callController=new t;window.mtelephony=new u;window.TelephonyUiState=i;console.log("Telephony initialized")})();
//# sourceMappingURL=component.map.js