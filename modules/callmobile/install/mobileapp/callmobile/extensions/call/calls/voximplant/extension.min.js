"use strict";(function(){include("Calls");BX.DoNothing=function(){};var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var t={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};var i={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",floorRequest:"Call::floorRequest",emotion:"Call::emotion",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll"};const s={onCallConference:"VoximplantCall::onCallConference"};var n=5e3;var l=25e3;var a=15e3;class o{constructor(e){this.id=e.id;this.instanceId=e.instanceId;this.parentId=e.parentId||null;this.direction=e.direction;this.type=e.type||BX.Call.Type.Instant;this.ready=false;this.userId=env.userId;this.initiatorId=e.initiatorId||"";this.users=BX.type.isArray(e.users)?e.users.filter((e=>e!=this.userId)):[];this.associatedEntity=BX.type.isPlainObject(e.associatedEntity)?e.associatedEntity:{};this.startDate=new Date(BX.prop.getString(e,"startDate",""));this.videoEnabled=e.videoEnabled===true;this.videoHd=e.videoHd===true;this.cameraId=e.cameraId||"";this.microphoneId=e.microphoneId||"";this.muted=e.muted===true;this.logToken=e.logToken||"";if(callEngine.getLogService()&&this.logToken){this.logger=new CallLogger(callEngine.getLogService(),this.logToken)}this.voximplantCall=null;this.signaling=new d({call:this});this.peers={};this._joinStatus=BX.Call.JoinStatus.None;Object.defineProperty(this,"joinStatus",{get:this.getJoinStatus.bind(this),set:this.setJoinStatus.bind(this)});this._active=false;Object.defineProperty(this,"active",{get:this.getActive.bind(this),set:this.setActive.bind(this)});this.localVideoShown=false;this.clientEventsBound=false;this._screenShared=false;this.someoneWasConnected=false;this.eventEmitter=new JNEventEmitter;if(typeof e.events==="object"){for(let t in e.events){this.eventEmitter.on(t,e.events[t])}}this.__onLocalVideoStreamReceivedHandler=this.__onLocalVideoStreamReceived.bind(this);this.__onLocalVideoStreamRemovedHandler=this.__onLocalVideoStreamRemoved.bind(this);this.__onCallDisconnectedHandler=this.__onCallDisconnected.bind(this);this.__onCallMessageReceivedHandler=this.__onCallMessageReceived.bind(this);this.__onCallEndpointAddedHandler=this.__onCallEndpointAdded.bind(this);this.__onSDKLogMessageHandler=this.__onSDKLogMessage.bind(this);this.initPeers();this.pingUsersInterval=setInterval(this.pingUsers.bind(this),n);this.pingBackendInterval=setInterval(this.pingBackend.bind(this),l);this.lastPingReceivedTimeout=null;this.lastSelfPingReceivedTimeout=null;this.created=new Date}log(){let e=CallUtil.getLogMessage.apply(CallUtil,arguments);if(console&&callEngine.debugFlag){let e=["Call log ["+CallUtil.getTimeForLog()+"]: "];console.log.apply(this,e.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(e)}}on(e,t){this.eventEmitter.on(e,t);return this}off(e,t){if(this.eventEmitter){this.eventEmitter.off(e,t)}return this}initPeers(){this.users.forEach((e=>{e=parseInt(e,10);this.peers[e]=this.createPeer(e)}))}reinitPeers(){for(var e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy();this.peers[e]=null}}this.initPeers()}pingUsers(){if(this.ready){var e=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:e},true)}}pingBackend(){if(this.ready){this.signaling.sendPingToBackend()}}repeatAnswerEvents(){this.signaling.sendRepeatAnswer({userId:this.userId})}createPeer(e){var t;if(this.videoAllowedFrom===BX.Call.UserMnemonic.all){t=true}else if(this.videoAllowedFrom===BX.Call.UserMnemonic.none){t=false}else if(BX.type.isArray(this.videoAllowedFrom)){t=this.videoAllowedFrom.some((function(t){return t==e}))}else{t=true}return new h({call:this,userId:e,ready:e==this.initiatorId,isIncomingVideoAllowed:t,onStreamReceived:e=>this.eventEmitter.emit(BX.Call.Event.onStreamReceived,[e.userId,e.stream]),onStreamRemoved:e=>this.eventEmitter.emit(BX.Call.Event.onStreamRemoved,[e.userId]),onStateChanged:this.__onPeerStateChanged.bind(this),onInviteTimeout:this.__onPeerInviteTimeout.bind(this)})}getUsers(){let e={};for(let t in this.peers){e[t]=this.peers[t].calculatedState}return e}getJoinStatus(){return this._joinStatus}setJoinStatus(e){if(e==this._joinStatus){return}this._joinStatus=e;switch(this._joinStatus){case BX.Call.JoinStatus.Local:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callId:this.id,local:true}]);break;case BX.Call.JoinStatus.Remote:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callId:this.id,local:false}]);break;case BX.Call.JoinStatus.None:this.eventEmitter.emit(BX.Call.Event.onLeave,[{callId:this.id}]);break}}getActive(){return this._active}setActive(e){if(e===this._active){return}this._active=e;this.eventEmitter.emit(this.active?BX.Call.Event.onActive:BX.Call.Event.onInactive,[this.id])}bindClientEvents(){var e=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){e.on(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler);this.clientEventsBound=true}}removeClientEvents(){if(VIClient){VIClient.getInstance().off(VIClient.Events.LogMessage,this.__onSDKLogMessageHandler)}}isMuted(){return this.muted}setMuted(e){if(this.muted==e){return}this.muted=e;if(this.voximplantCall){this.voximplantCall.sendAudio=!this.muted;this.signaling.sendMicrophoneState(!this.muted)}}switchCamera(){if(!this.videoEnabled){return}JNVICameraManager.useBackCamera=!JNVICameraManager.useBackCamera}isFrontCameraUsed(){return!JNVICameraManager.useBackCamera}isVideoEnabled(){return this.videoEnabled}setVideoEnabled(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.voximplantCall){this.voximplantCall.setSendVideo(this.videoEnabled&&!this.videoPaused);this.signaling.sendCameraState(this.videoEnabled)}}setVideoPaused(e){if(this.videoPaused==e||!this.videoEnabled){return}this.videoPaused=e;if(this.voximplantCall){this.voximplantCall.setSendVideo(this.videoEnabled&&!this.videoPaused);this.signaling.sendVideoPaused(this.videoPaused)}}requestFloor(e){this.signaling.sendFloorRequest(e)}allowVideoFrom(e){if(this.videoAllowedFrom==e){return}this.videoAllowedFrom=e;if(e===BX.Call.UserMnemonic.all){this.signaling.sendShowAll();e=Object.keys(this.peers)}else if(e===BX.Call.UserMnemonic.none){this.signaling.sendHideAll();e=[]}else if(BX.type.isArray(e)){this.signaling.sendShowUsers(e)}else{throw new Error("userList is in wrong format")}let t={};e.forEach((e=>t[e]=true));for(let e in this.peers){if(!this.peers.hasOwnProperty(e)){continue}if(t[e]){this.peers[e].allowIncomingVideo(true)}else{this.peers[e].allowIncomingVideo(false)}}}inviteUsers(e={}){this.ready=true;let t=BX.type.isArray(e.users)?e.users:this.users;this.attachToConference().then((()=>{this.signaling.sendPingToUsers({userId:t});if(t.length>0){return this.signaling.inviteUsers({userIds:t,video:this.videoEnabled?"Y":"N"})}})).then((e=>{this.joinStatus=BX.Call.JoinStatus.Local;for(let e=0;e<t.length;e++){let i=parseInt(t[e],10);if(!this.users.includes(i)){this.users.push(i)}if(!this.peers[i]){this.peers[i]=this.createPeer(i);this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:i}])}this.peers[i].onInvited()}})).catch(this.onFatalError.bind(this))}answer(e){this.ready=true;if(!BX.type.isPlainObject(e)){e={}}this.videoEnabled=e.useVideo===true;this.sendAnswer();this.attachToConference().then((()=>{this.log("Attached to conference");this.joinStatus=BX.Call.JoinStatus.Local})).catch(this.onFatalError.bind(this))}sendAnswer(){this.signaling.sendAnswer()}decline(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}BX.rest.callMethod(e.decline,i)}hangup(e,t){if(!this.ready){var i=new Error("Hangup in wrong state");this.log(i);return}var s=new Error;s.name="Call stack:";this.log("Hangup received \n"+s.stack);var n={};this.ready=false;if(typeof e!="undefined"){n.code=e}if(typeof t!="undefined"){n.reason=t}this.joinStatus=BX.Call.JoinStatus.None;n.userId=this.users;this.signaling.sendHangup(n);this.muted=false;this.reinitPeers();if(this.voximplantCall){this.voximplantCall._replaceVideoSharing=false;try{this.voximplantCall.hangup()}catch(e){CallUtil.error(e)}}}attachToConference(){return new Promise(((e,t)=>{if(this.voximplantCall){return e()}r.getClient().then((i=>{i.on(VIClient.Events.LogMessage,this.__onSDKLogMessageHandler);try{if(typeof JNVICameraManager.setResolutionConstraints==="function"){JNVICameraManager.setResolutionConstraints(960,540)}this.voximplantCall=i.callConference("bx_conf_"+this.id,{sendVideo:this.videoEnabled,receiveVideo:true,enableSimulcast:true})}catch(e){CallUtil.error(e);return t(e)}if(!this.voximplantCall){this.log("Error: could not create voximplant call");return t({code:"VOX_NO_CALL"})}this.eventEmitter.emit(s.onCallConference,[{call:this}]);this.bindCallEvents();let n=()=>{this.log("Call connected");this.voximplantCall.off(JNVICall.Events.Connected,n);this.voximplantCall.off(JNVICall.Events.Failed,l);this.voximplantCall.on(JNVICall.Events.Failed,this.__onCallDisconnectedHandler);if(this.muted){this.voximplantCall.sendAudio=false}this.signaling.sendMicrophoneState(!this.muted);this.signaling.sendCameraState(this.videoEnabled);if(this.videoAllowedFrom==BX.Call.UserMnemonic.none){this.signaling.sendHideAll()}else if(BX.type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}e()};let l=(e,i)=>{this.log("Could not attach to conference",i);CallUtil.error("Could not attach to conference",i);this.voximplantCall.off(JNVICall.Events.Connected,n);this.voximplantCall.off(JNVICall.Events.Failed,l);t(i)};this.voximplantCall.on(JNVICall.Events.Connected,n);this.voximplantCall.on(JNVICall.Events.Failed,l);this.voximplantCall.start()})).catch(this.onFatalError.bind(this))}))}bindCallEvents(){this.voximplantCall.on(JNVICall.Events.Disconnected,this.__onCallDisconnectedHandler);this.voximplantCall.on(JNVICall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.voximplantCall.on(JNVICall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.voximplantCall.on(JNVICall.Events.LocalVideoStreamAdded,this.__onLocalVideoStreamReceivedHandler);this.voximplantCall.on(JNVICall.Events.LocalVideoStreamRemoved,this.__onLocalVideoStreamRemovedHandler)}removeCallEvents(){if(this.voximplantCall){this.voximplantCall.off(JNVICall.Events.Disconnected,this.__onCallDisconnectedHandler);this.voximplantCall.off(JNVICall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.voximplantCall.off(JNVICall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.voximplantCall.off(JNVICall.Events.LocalVideoStreamAdded,this.__onLocalVideoStreamReceivedHandler);this.voximplantCall.off(JNVICall.Events.LocalVideoStreamRemoved,this.__onLocalVideoStreamRemovedHandler)}}addJoinedUsers(e){for(var t=0;t<e.length;t++){var i=Number(e[t]);if(i==this.userId||this.peers[i]){continue}this.peers[i]=this.createPeer(i);if(!this.users.includes(i)){this.users.push(i)}this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:i}])}}addInvitedUsers(e){for(var t=0;t<e.length;t++){var i=parseInt(e[t]);if(i==this.userId){continue}if(this.peers[i]){if(this.peers[i].calculatedState===BX.Call.UserState.Failed||this.peers[i].calculatedState===BX.Call.UserState.Idle){this.peers[i].onInvited()}}else{this.peers[i]=this.createPeer(i);this.peers[i].onInvited()}if(!this.users.includes(i)){this.users.push(i)}this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:i}])}}isAnyoneParticipating(e){for(var t in this.peers){if(this.peers[t].isParticipating(e)){return true}}return false}getParticipatingUsers(){var e=[];for(var t in this.peers){if(this.peers[t].isParticipating()){e.push(t)}}return e}__onPeerStateChanged(e){this.eventEmitter.emit(BX.Call.Event.onUserStateChanged,[e.userId,e.state,e.previousState]);if(!this.ready){return}if(e.state==BX.Call.UserState.Failed||e.state==BX.Call.UserState.Unavailable||e.state==BX.Call.UserState.Declined||e.state==BX.Call.UserState.Idle){if(this.type==BX.Call.Type.Instant&&!this.isAnyoneParticipating(!this.someoneWasConnected)){this.hangup()}}if(e.state==BX.Call.UserState.Connected&&!this.someoneWasConnected){this.someoneWasConnected=true}}__onPeerInviteTimeout(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})}_onPullEvent(e,i,s){var n={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::usersJoined":this.__onPullEventUsersJoined.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::userInviteTimeout":this.__onPullEventUserInviteTimeout.bind(this),"Call::ping":this.__onPullEventPing.bind(this),"Call::finish":this.__onPullEventFinish.bind(this),[t.repeatAnswer]:this.__onPullEventRepeatAnswer.bind(this)};if(n[e]){this.log("Signaling: "+e+"; Parameters: "+JSON.stringify(i));n[e].call(this,i)}}__onPullEventAnswer(e){var t=Number(e.senderId);if(t==this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.peers[t]){this.peers[t]=this.createPeer(t);this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:t}])}if(!this.users.includes(t)){this.users.push(t)}this.peers[t].setReady(true)}__onPullEventAnswerSelf(e){if(e.callInstanceId===this.instanceId){return}this.joinStatus=BX.Call.JoinStatus.Remote}__onPullEventHangup(e){var t=e.senderId;if(this.userId==t&&this.instanceId!=e.callInstanceId){this.joinStatus=BX.Call.JoinStatus.None;this.eventEmitter.emit(BX.Call.Event.onHangup);return}if(!this.peers[t]){return}this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}else if(e.code==486){this.peers[t].setBusy(true);CallUtil.error("user "+t+" is busy")}if(this.ready&&this.type==BX.Call.Type.Instant&&!this.isAnyoneParticipating()){this.hangup()}}__onPullEventUsersJoined(e){this.log("__onPullEventUsersJoined",e);var t=e.users;this.addJoinedUsers(t)}__onPullEventUsersInvited(e){this.log("__onPullEventUsersInvited",e);var t=e.users;this.addInvitedUsers(t)}__onPullEventUserInviteTimeout(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}}__onPullEventPing(e){if(e.callInstanceId==this.instanceId){return}clearTimeout(this.lastPingReceivedTimeout);this.lastPingReceivedTimeout=setTimeout(this.__onNoPingsReceived.bind(this),n*2.1);this.active=true;var t=parseInt(e.senderId,10);if(t==this.userId&&this.joinStatus==BX.Call.JoinStatus.None){this.joinStatus=BX.Call.JoinStatus.Remote;clearTimeout(this.lastSelfPingReceivedTimeout);this.lastSelfPingReceivedTimeout=setTimeout(this.__onNoSelfPingsReceived.bind(this),n*2.1)}if(this.peers[t]){this.peers[t].setReady(true)}}__onNoPingsReceived(){if(!this.ready){this.active=false;if(this._joinStatus==BX.Call.JoinStatus.Remote){this._joinStatus=BX.Call.JoinStatus.None}}}__onNoSelfPingsReceived(){if(!this.ready&&!this.active){this.joinStatus=BX.Call.JoinStatus.None}}__onPullEventFinish(e){this.destroy()}__onPullEventRepeatAnswer(){if(this.ready){this.signaling.sendAnswer({userId:this.userId},true)}}__onLocalDevicesUpdated(e){this.log("__onLocalDevicesUpdated",e)}__onLocalVideoStreamReceived(e){this.log("__onLocalVideoStreamReceived");this.eventEmitter.emit(BX.Call.Event.onLocalMediaReceived,[e])}__onLocalVideoStreamRemoved(){this.eventEmitter.emit(BX.Call.Event.onLocalMediaStopped)}__onSDKLogMessage(e){if(this.logger){this.log(e)}}__onCallDisconnected(e){this.log("__onCallDisconnected",e);this.ready=false;this.muted=false;this.reinitPeers();this.removeCallEvents();this.voximplantCall=null;this.joinStatus=BX.Call.JoinStatus.None}onFatalError(e){if(e&&e.call){delete e.call}CallUtil.error("onFatalError",e);this.log("onFatalError",e);this.ready=false;this.muted=false;this.reinitPeers();if(this.voximplantCall){this.removeCallEvents();try{this.voximplantCall.hangup({"X-Reason":"Fatal error","X-Error":typeof e==="string"?e:e.code||e.name})}catch(e){}this.voximplantCall=null}if(typeof e==="string"){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e])}else if(e instanceof Error){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e.toString()])}else{this.eventEmitter.emit(BX.Call.Event.onCallFailure)}}__onCallEndpointAdded(e){let t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log("__onCallEndpointAdded ("+t+")");if(BX.type.isNotEmptyString(t)&&t.substr(0,4)=="user"){let i=parseInt(t.substr(4));if(this.peers[i]){this.peers[i].setEndpoint(e)}}else{e.on(JNVIEndpoint.Events.InfoUpdated,(()=>{let t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log("VoxImplant.EndpointEvents.InfoUpdated ("+t+")",e);if(t.substr(0,4)=="user"){var i=parseInt(t.substr(4));if(this.peers[i]){this.peers[i].setEndpoint(e)}}}));this.log("Unknown endpoint "+t)}}__onCallMessageReceived(e,t){let s;try{s=JSON.parse(t.message)}catch(e){this.log("Could not parse scenario message.",e);return}var n=s.eventName;if(n===i.voiceStarted){this.eventEmitter.emit(BX.Call.Event.onUserVoiceStarted,[s.senderId])}else if(n===i.voiceStopped){this.eventEmitter.emit(BX.Call.Event.onUserVoiceStopped,[s.senderId])}else if(n===i.microphoneState){this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[s.senderId,s.microphoneState==="Y"])}else if(n===i.screenState){this.eventEmitter.emit(BX.Call.Event.onUserScreenState,[s.senderId,s.screenState==="Y"])}else if(n===i.videoPaused){this.eventEmitter.emit(BX.Call.Event.onUserVideoPaused,[s.senderId,s.videoPaused==="Y"])}else if(n===i.floorRequest){this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[s.senderId,s.requestActive==="Y"])}else if(n===i.emotion){this.eventEmitter.emit(BX.Call.Event.onUserEmotion,[s.senderId,s.toUserId,s.emotion])}else if(n==="scenarioLogUrl"){CallUtil.warn("scenario log url: "+s.logUrl)}else{this.log("Unknown scenario event "+n)}}destroy(){this.ready=false;this._joinStatus=BX.Call.JoinStatus.None;if(this.voximplantCall){this.removeCallEvents();if(this.voximplantCall){this.voximplantCall.hangup()}this.voximplantCall=null}for(var e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy()}}if(this.logger){this.logger.destroy();this.logger=null}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearTimeout(this.pingUsersInterval);clearTimeout(this.pingBackendInterval);this.eventEmitter.emit(BX.Call.Event.onDestroy,[{call:this}]);this.eventEmitter=null;if(this.signaling){this.signaling.call=null;this.signaling=null}}}const r={accessToken:null,accessTokenTtl:null,get token(){if(this.accessToken&&this.accessTokenTtl&&Date.now()<this.accessTokenTtl){return this.accessToken}else{return null}},setAccessToken(e,t){this.accessToken=e;this.accessTokenTtl=Date.now()+t*1e3},get server(){return BX.componentParameters.get("voximplantServer","")},set server(e){BX.componentParameters.set("voximplantServer",e)},get login(){return BX.componentParameters.get("voximplantLogin","")},set login(e){BX.componentParameters.set("voximplantLogin",e)},getAuthorization(){return new Promise(((e,t)=>{if(this.server){return e({server:this.server,login:this.login})}else{CallUtil.log("Calling voximplant.authorization.get");BX.rest.callMethod("voximplant.authorization.get").then((t=>{let i=t.data();this.server=i.SERVER;this.login=i.LOGIN;return e({server:this.server,login:this.login})})).catch((e=>{console.error(e);t(e)}))}}))},tryLoginWithToken(e){return new Promise(((t,i)=>{if(!("loginWithAccessToken"in e)){return i()}if(this.token){CallUtil.log("Trying to login with saved access token");this.getAuthorization().then((s=>{let n=s.login;let l=s.server;e.loginWithAccessToken(`${n}@${l}`,this.token).then((e=>{CallUtil.log("success",e);console.log(e);if("params"in e&&"accessToken"in e.params){this.setAccessToken(e.params.accessToken,e.params.accessExpire)}t()})).catch((e=>{console.error(e);i(e)}))})).catch((e=>{console.error(e);i(e)}))}else{return i()}}))},tryLoginWithOneTimeKey(e){return new Promise(((t,i)=>{this.getAuthorization().then((s=>{let n=s.login;let l=s.server;e.requestOneTimeKey(`${n}@${l}`).then((s=>{CallUtil.warn("ontimekey received");BX.rest.callMethod("voximplant.authorization.signOneTimeKey",{KEY:s}).then((s=>{CallUtil.warn("ontimekey signed");let a=s.data();e.loginWithOneTimeKey(`${n}@${l}`,a.HASH).then((i=>{console.log("login success",i);if("params"in i&&"accessToken"in i.params){this.setAccessToken(i.params.accessToken,i.params.accessExpire)}t(e)})).catch((e=>{BX.rest.callMethod("voximplant.authorization.onError");i(e)}))})).catch((e=>{CallUtil.error(e)}))}))}))}))},getClient(){return new Promise(((e,t)=>{let i=VIClient.getInstance();if(i.getClientState()==="LOGGED_IN"){return e(i)}let s=i=>{CallUtil.warn("connected");i.off(VIClient.Events.Failed,n);i.off(VIClient.Events.Connected,s);this.tryLoginWithToken(i).then((()=>e(i))).catch((()=>{this.tryLoginWithOneTimeKey(i).then((()=>e(i))).catch((e=>t(e)))}))};let n=(e,i)=>{CallUtil.error(e,i);e.off(VIClient.Events.Failed,n);e.off(VIClient.Events.Connected,s);t(i)};if(i.getClientState()==="CONNECTED"){s(i)}else{i.on(VIClient.Events.Failed,n);i.on(VIClient.Events.Connected,s);this.getNode().then((e=>{try{i.connectWithNode(e)}catch(e){if(e.name=="TypeError"){i.connect()}else{t()}}}))}}))},getNode(){return new Promise(((e,t)=>{BX.rest.callMethod("voximplant.user.getNode").then((i=>{const s=i.data();if(s.error){const e={name:"OtherError",code:s.code,message:s.message};t(e)}else{e(s.node.toString())}})).catch((e=>{t(e)}))}))}};class d{constructor(e){this.call=e.call}isPublishingEnabled(){return false}inviteUsers(t){return this.__runRestAction(e.invite,t)}sendAnswer(i,s){if(s){this.__sendPullEventOrCallRest(t.answer,e.answer,i,30)}else{return this.__runRestAction(e.answer,i)}}sendCancel(t){return this.__runRestAction(e.cancel,t)}sendHangup(i){if(this.isPublishingEnabled()){this.__sendPullEvent(t.hangup,i);i.retransmit=false;this.__runRestAction(e.hangup,i)}else{i.retransmit=true;this.__runRestAction(e.hangup,i)}}sendVoiceStarted(e){return this.__sendMessage(i.voiceStarted,e)}sendVoiceStopped(e){return this.__sendMessage(i.voiceStopped,e)}sendMicrophoneState(e){return this.__sendMessage(i.microphoneState,{microphoneState:e?"Y":"N"})}sendCameraState(e){return this.__sendMessage(i.cameraState,{cameraState:e?"Y":"N"})}sendVideoPaused(e){return this.__sendMessage(i.videoPaused,{videoPaused:e?"Y":"N"})}sendScreenState(e){return this.__sendMessage(i.screenState,{screenState:e?"Y":"N"})}sendFloorRequest(e){return this.__sendMessage(i.floorRequest,{requestActive:e?"Y":"N"})}sendEmotion(e,t){return this.__sendMessage(i.emotion,{toUserId:e,emotion:t})}sendShowUsers(e){this.call.log("Show video from users "+(BX.type.isArray(e)?e.join("; "):e));return this.__sendMessage(i.showUsers,{users:e})}sendShowAll(){return this.__sendMessage(i.showAll,{})}sendHideAll(){return this.__sendMessage(i.hideAll,{})}sendPingToUsers(e){if(this.isPublishingEnabled()){this.__sendPullEvent(t.ping,e,0)}}sendPingToBackend(){this.__runRestAction(e.ping,{retransmit:false})}sendRepeatAnswer(e){this.__sendPullEvent(t.repeatAnswer,e)}sendUserInviteTimeout(e){if(this.isPublishingEnabled()){this.__sendPullEvent(t.userInviteTimeout,e,0)}}getPublishingState(){return BX.PULL.getPublishingState()}__sendPullEvent(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!BX.type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=callEngine.getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));BX.PULL.sendMessage(t.userId,"im",e,t,i)}__sendMessage(e,t){if(!this.call.voximplantCall){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=callEngine.getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))}__runRestAction(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=callEngine.getUuidv4();return callEngine.getRestClient().callMethod(e,t)}__sendPullEventOrCallRest(e,t,i,s){this.getPublishingState().then((n=>{if(n){this.__sendPullEvent(e,i,s)}else if(t!=""){this.__runRestAction(t,i)}})).catch((e=>{CallUtil.error(e);this.call.log(e)}))}}class h{constructor(e){this.userId=e.userId;this.call=e.call;this.ready=!!e.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.stream=null;this.isIncomingVideoAllowed=e.isIncomingVideoAllowed!==false;this.tracks={audio:null,video:null,sharing:null};this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onInviteTimeout:BX.type.isFunction(e.onInviteTimeout)?e.onInviteTimeout:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing};this.__onEndpointRemoteMediaAddedHandler=this.__onEndpointRemoteMediaAdded.bind(this);this.__onEndpointRemoteMediaRemovedHandler=this.__onEndpointRemoteMediaRemoved.bind(this);this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.calculatedState=this.calculateState()}setReady(e){e=!!e;if(this.ready==e){return}this.ready=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()}setDeclined(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}setBusy(e){this.busy=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}setEndpoint(e){this.log("Adding endpoint with "+e.remoteVideoStreams.length+" remote video streams");this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);clearTimeout(this.callingTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=e;if(this.endpoint.remoteVideoStreams.length>0){this.callbacks.onStreamReceived({userId:this.userId,stream:this.endpoint.remoteVideoStreams[0]})}this.updateCalculatedState();this.bindEndpointEventHandlers()}allowIncomingVideo(e){if(this.isIncomingVideoAllowed==e){return}this.isIncomingVideoAllowed=!!e}bindEndpointEventHandlers(){this.endpoint.on(JNVIEndpoint.Events.VideoStreamAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.on(JNVIEndpoint.Events.VideoStreamRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.on(JNVIEndpoint.Events.Removed,this.__onEndpointRemovedHandler)}removeEndpointEventHandlers(){this.endpoint.off(JNVIEndpoint.Events.VideoStreamAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.off(JNVIEndpoint.Events.VideoStreamRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.off(JNVIEndpoint.Events.Removed,this.__onEndpointRemovedHandler)}calculateState(){if(this.endpoint){return BX.Call.UserState.Connected}if(this.calling){return BX.Call.UserState.Calling}if(this.inviteTimeout){return BX.Call.UserState.Unavailable}if(this.declined){return BX.Call.UserState.Declined}if(this.busy){return BX.Call.UserState.Busy}if(this.ready){return BX.Call.UserState.Ready}return BX.Call.UserState.Idle}updateCalculatedState(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState});this.calculatedState=e}}isParticipating(e){if(!(typeof e==="boolean")){e=true}if(e){return(this.calling||this.ready||this.endpoint)&&!this.declined}else{return(this.ready||this.endpoint)&&!this.declined}}waitForConnectionRestore(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),a)}onInvited(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((()=>this.onInviteTimeout(true)),3e4);this.updateCalculatedState()}onInviteTimeout(e){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(e){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}onConnectionRestoreTimeout(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)}__onEndpointRemoteMediaAdded(e){this.log("RemoteMediaAdded",e);this.callbacks.onStreamReceived({userId:this.userId,stream:this.endpoint.remoteVideoStreams[0]});this.updateCalculatedState()}__onEndpointRemoteMediaRemoved(e){this.log("Remote media removed");this.callbacks.onStreamRemoved({userId:this.userId});this.updateCalculatedState()}__onEndpointRemoved(e){this.log("Endpoint removed");if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}if(this.ready){this.waitForConnectionRestore()}this.updateCalculatedState()}log(){this.call&&this.call.log.apply(this.call,arguments)}destroy(){if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.callbacks["onStateChanged"]=BX.DoNothing;this.callbacks["onStreamReceived"]=BX.DoNothing;this.callbacks["onStreamRemoved"]=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null;this.call=null}}window.VIClientWrapper=r;window.VoximplantCall=o})();
//# sourceMappingURL=extension.map.js