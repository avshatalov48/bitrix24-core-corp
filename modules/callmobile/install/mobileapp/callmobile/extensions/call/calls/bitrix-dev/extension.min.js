"use strict";(function(){include("Calls");BX.DoNothing=function(){};const e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};const t={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};const i={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",floorRequest:"Call::floorRequest",emotion:"Call::emotion",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll"};const s={onCallConference:"BitrixCallDev::onCallConference"};const n=5e3;const a=25e3;const l=15e3;class o{constructor(e){this.id=e.id;this.roomId=e.roomId;this.instanceId=e.instanceId;this.parentId=e.parentId||null;this.direction=e.direction;this.type=e.type||BX.Call.Type.Instant;this.ready=false;this.userId=env.userId;this.userData=e.userData;this.initiatorId=e.initiatorId||"";this.users=BX.type.isArray(e.users)?e.users.filter((e=>e!=this.userId)):[];this.associatedEntity=BX.type.isPlainObject(e.associatedEntity)?e.associatedEntity:{};this.startDate=new Date(BX.prop.getString(e,"startDate",""));this.videoEnabled=e.videoEnabled===true;this.videoHd=e.videoHd===true;this.cameraId=e.cameraId||"";this.microphoneId=e.microphoneId||"";this.muted=e.muted===true;this.logToken=e.logToken||"";if(callEngine.getLogService()&&this.logToken){this.logger=new CallLogger(callEngine.getLogService(),this.logToken)}this.connectionData=e.connectionData||{};this.bitrixCallDev=null;this.signaling=new d({call:this});this.peers={};this._joinStatus=BX.Call.JoinStatus.None;Object.defineProperty(this,"joinStatus",{get:this.getJoinStatus.bind(this),set:this.setJoinStatus.bind(this)});this._active=false;Object.defineProperty(this,"active",{get:this.getActive.bind(this),set:this.setActive.bind(this)});this.localVideoShown=false;this.clientEventsBound=false;this._screenShared=false;this.someoneWasConnected=false;this.eventEmitter=new JNEventEmitter;if(typeof e.events==="object"){for(const t in e.events){this.eventEmitter.on(t,e.events[t])}}this.__onLocalVideoStreamReceivedHandler=this.__onLocalVideoStreamReceived.bind(this);this.__onLocalVideoStreamRemovedHandler=this.__onLocalVideoStreamRemoved.bind(this);this.__onCallDisconnectedHandler=this.__onCallDisconnected.bind(this);this.__onCallMessageReceivedHandler=this.__onCallMessageReceived.bind(this);this.__onCallEndpointAddedHandler=this.__onCallEndpointAdded.bind(this);this.__onCallReconnectedHandler=this.__onCallReconnected.bind(this);this.__onSDKLogMessageHandler=this.__onSDKLogMessage.bind(this);this.initPeers();this.pingUsersInterval=setInterval(this.pingUsers.bind(this),n);this.pingBackendInterval=setInterval(this.pingBackend.bind(this),a);this.lastPingReceivedTimeout=null;this.lastSelfPingReceivedTimeout=null;this.created=new Date}log(){const e=CallUtil.getLogMessage.apply(CallUtil,arguments);if(console&&callEngine.debugFlag){const e=[`Call log [${CallUtil.getTimeForLog()}]: `];console.log.apply(this,e.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(e)}}on(e,t){this.eventEmitter.on(e,t);return this}off(e,t){if(this.eventEmitter){this.eventEmitter.off(e,t)}return this}initPeers(){this.users.forEach((e=>{e=parseInt(e,10);this.peers[e]=this.createPeer(e)}))}reinitPeers(){for(const e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy();this.peers[e]=null}}this.initPeers()}pingUsers(){if(this.ready){const e=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:e},true)}}pingBackend(){if(this.ready){this.signaling.sendPingToBackend()}}repeatAnswerEvents(){this.signaling.sendRepeatAnswer({userId:this.userId})}createPeer(e){let t;if(this.videoAllowedFrom===BX.Call.UserMnemonic.all){t=true}else if(this.videoAllowedFrom===BX.Call.UserMnemonic.none){t=false}else if(BX.type.isArray(this.videoAllowedFrom)){t=this.videoAllowedFrom.some((t=>t==e))}else{t=true}return new h({call:this,userId:e,ready:e==this.initiatorId,isIncomingVideoAllowed:t,onStreamReceived:e=>this.eventEmitter.emit(BX.Call.Event.onStreamReceived,[e.userId,e.stream]),onStateChanged:this.__onPeerStateChanged.bind(this),onInviteTimeout:this.__onPeerInviteTimeout.bind(this),onInitialState:e=>{this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[e.userId,e.floorRequest]);this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[e.userId,e.microphoneState])},onHandRaised:e=>this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[e.userId,e.isHandRaised])})}getUsers(){const e={};for(const t in this.peers){e[t]=this.peers[t].calculatedState}return e}getJoinStatus(){return this._joinStatus}setJoinStatus(e){if(e==this._joinStatus){return}this._joinStatus=e;switch(this._joinStatus){case BX.Call.JoinStatus.Local:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callId:this.id,local:true}]);break;case BX.Call.JoinStatus.Remote:this.eventEmitter.emit(BX.Call.Event.onJoin,[{callId:this.id,local:false}]);break;case BX.Call.JoinStatus.None:this.eventEmitter.emit(BX.Call.Event.onLeave,[{callId:this.id}]);break}}getActive(){return this._active}setActive(e){if(e===this._active){return}this._active=e;this.eventEmitter.emit(this.active?BX.Call.Event.onActive:BX.Call.Event.onInactive,[this.id])}bindClientEvents(){const e=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){e.on(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler);this.clientEventsBound=true}}removeClientEvents(){if(BXClient){BXClient.getInstance().off(BXClient.Events.LogMessage,this.__onSDKLogMessageHandler)}}isMuted(){return this.muted}setMuted(e){this.muted=e;if(this.bitrixCallDev){this.bitrixCallDev.sendAudio=!this.muted;this.signaling.sendMicrophoneState(!this.muted)}}toggleSubscriptionRemoteVideo(e){if(this.bitrixCallDev&&this.bitrixCallDev.toggleSubscriptionRemoteVideo){this.bitrixCallDev.toggleSubscriptionRemoteVideo(e)}}onCentralUserSwitch(e){if(this.bitrixCallDev&&this.bitrixCallDev.onCentralUserSwitch){this.bitrixCallDev.onCentralUserSwitch(e)}}switchCamera(){if(!this.videoEnabled){return}JNBXCameraManager.useBackCamera=!JNBXCameraManager.useBackCamera}isFrontCameraUsed(){return!JNBXCameraManager.useBackCamera}isVideoEnabled(){return this.videoEnabled}setVideoEnabled(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.bitrixCallDev){this.bitrixCallDev.setSendVideo(this.videoEnabled&&!this.videoPaused);this.signaling.sendCameraState(this.videoEnabled)}}setVideoPaused(e){if(this.videoPaused==e||!this.videoEnabled){return}this.videoPaused=e;if(this.bitrixCallDev){this.bitrixCallDev.setSendVideo(this.videoEnabled&&!this.videoPaused);this.signaling.sendVideoPaused(this.videoPaused)}}requestFloor(e){this.bitrixCallDev.raiseHand(e)}allowVideoFrom(e){if(this.videoAllowedFrom==e){return}this.videoAllowedFrom=e;if(e===BX.Call.UserMnemonic.all){this.signaling.sendShowAll();e=Object.keys(this.peers)}else if(e===BX.Call.UserMnemonic.none){this.signaling.sendHideAll();e=[]}else if(BX.type.isArray(e)){this.signaling.sendShowUsers(e)}else{throw new TypeError("userList is in wrong format")}const t={};e.forEach((e=>t[e]=true));for(const e in this.peers){if(!this.peers.hasOwnProperty(e)){continue}if(t[e]){this.peers[e].allowIncomingVideo(true)}else{this.peers[e].allowIncomingVideo(false)}}}inviteUsers(e={}){this.ready=true;const t=BX.type.isArray(e.users)?e.users:this.users;this.attachToConference().then((()=>{this.signaling.sendPingToUsers({userId:t});if(t.length>0){return this.signaling.inviteUsers({userIds:t,video:this.videoEnabled?"Y":"N"})}})).then((e=>{this.joinStatus=BX.Call.JoinStatus.Local;for(const e of t){const t=parseInt(e,10);if(!this.users.includes(t)){this.users.push(t)}if(!this.peers[t]){this.peers[t]=this.createPeer(t);this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:t}])}this.peers[t].onInvited()}})).catch(this.onFatalError.bind(this))}answer(e){this.ready=true;if(!BX.type.isPlainObject(e)){e={}}this.videoEnabled=e.useVideo===true;this.sendAnswer();this.attachToConference().then((()=>{this.log("Attached to conference");this.joinStatus=BX.Call.JoinStatus.Local})).catch(this.onFatalError.bind(this))}sendAnswer(){this.signaling.sendAnswer()}decline(t){this.ready=false;const i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}BX.rest.callMethod(e.decline,i)}hangup(e,t){if(!this.ready){const e=new Error("Hangup in wrong state");this.log(e);return}const i=new Error;i.name="Call stack:";this.log(`Hangup received \n${i.stack}`);const s={};this.ready=false;if(typeof e!=="undefined"){s.code=e}if(typeof t!=="undefined"){s.reason=t}if(t!=="SIGNALING_DUPLICATE_PARTICIPANT"){this.signaling.sendHangup(s);this.reinitPeers()}this.joinStatus=BX.Call.JoinStatus.None;s.userId=this.users;this.muted=false;if(this.bitrixCallDev){this.bitrixCallDev._replaceVideoSharing=false;try{this.bitrixCallDev.hangup()}catch(e){CallUtil.error(e)}this.bitrixCallDev=null}}cancel(){this.ready=true;this.hangup()}attachToConference(){return new Promise(((e,t)=>{if(this.bitrixCallDev){return e()}const i={roomId:this.roomId,endpoint:this.connectionData.endpoint,token:this.connectionData.jwt};r.getClient(i).then((i=>{if(!this.ready){return}i.on(BXClient.Events.LogMessage,this.__onSDKLogMessageHandler);try{if(typeof JNBXCameraManager.setResolutionConstraints==="function"){JNBXCameraManager.setResolutionConstraints(960,540)}const e={callId:`${this.id}`,sendVideo:this.videoEnabled,receiveVideo:true,enableSimulcast:true,userName:this.userData,callBetaIosEnabled:callEngine.isCallBetaIosEnabled()};this.bitrixCallDev=i.callConference(`bx_conf_${this.id}`,e)}catch(e){CallUtil.error(e);return t(e)}if(!this.bitrixCallDev){this.log("Error: could not create bitrix dev call");return t({code:"BITRIX_DEV_NO_CALL"})}this.eventEmitter.emit(s.onCallConference,[{call:this}]);this.bindCallEvents();const n=()=>{this.log("Call connected");this.bitrixCallDev.off(JNBXCall.Events.Connected,n);this.bitrixCallDev.off(JNBXCall.Events.Failed,a);this.bitrixCallDev.on(JNBXCall.Events.Failed,this.__onCallDisconnectedHandler);this.bitrixCallDev.sendAudio=!this.muted;this.signaling.sendMicrophoneState(!this.muted);this.signaling.sendCameraState(this.videoEnabled);if(this.videoAllowedFrom==BX.Call.UserMnemonic.none){this.signaling.sendHideAll()}else if(BX.type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}e()};let a=(e,i)=>{this.log("Could not attach to conference",i);CallUtil.error("Could not attach to conference",i);if(this.bitrixCallDev){this.bitrixCallDev.off(JNBXCall.Events.Connected,n);this.bitrixCallDev.off(JNBXCall.Events.Failed,a)}t(i)};this.bitrixCallDev.on(JNBXCall.Events.Connected,n);this.bitrixCallDev.on(JNBXCall.Events.Failed,a);this.bitrixCallDev.start()})).catch(this.onFatalError.bind(this))}))}bindCallEvents(){this.bitrixCallDev.on(JNBXCall.Events.Disconnected,this.__onCallDisconnectedHandler);this.bitrixCallDev.on(JNBXCall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.bitrixCallDev.on(JNBXCall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.bitrixCallDev.on(JNBXCall.Events.LocalVideoStreamAdded,this.__onLocalVideoStreamReceivedHandler);this.bitrixCallDev.on(JNBXCall.Events.LocalVideoStreamRemoved,this.__onLocalVideoStreamRemovedHandler);this.bitrixCallDev.on(JNBXCall.Events.Reconnected,this.__onCallReconnectedHandler)}removeCallEvents(){if(this.bitrixCallDev){this.bitrixCallDev.off(JNBXCall.Events.Disconnected,this.__onCallDisconnectedHandler);this.bitrixCallDev.off(JNBXCall.Events.ReceiveMessage,this.__onCallMessageReceivedHandler);this.bitrixCallDev.off(JNBXCall.Events.EndpointAdded,this.__onCallEndpointAddedHandler);this.bitrixCallDev.off(JNBXCall.Events.LocalVideoStreamAdded,this.__onLocalVideoStreamReceivedHandler);this.bitrixCallDev.off(JNBXCall.Events.LocalVideoStreamRemoved,this.__onLocalVideoStreamRemovedHandler);this.bitrixCallDev.off(JNBXCall.Events.Reconnected,this.__onCallReconnectedHandler)}}addJoinedUsers(e){for(const t of e){const e=Number(t);if(e==this.userId||this.peers[e]){continue}this.peers[e]=this.createPeer(e);if(!this.users.includes(e)){this.users.push(e)}this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:e}])}}addInvitedUsers(e){for(const t of e){const e=parseInt(t);if(e==this.userId){continue}if(this.peers[e]){if(this.peers[e].calculatedState===BX.Call.UserState.Failed||this.peers[e].calculatedState===BX.Call.UserState.Idle){this.peers[e].onInvited()}}else{this.peers[e]=this.createPeer(e);this.peers[e].onInvited()}if(!this.users.includes(e)){this.users.push(e)}this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:e}])}}isAnyoneParticipating(e){for(const t in this.peers){if(this.peers[t].isParticipating(e)){return true}}return false}getParticipatingUsers(){const e=[];for(const t in this.peers){if(this.peers[t].isParticipating()){e.push(t)}}return e}__onPeerStateChanged(e){this.eventEmitter.emit(BX.Call.Event.onUserStateChanged,[e.userId,e.state,e.previousState]);if(!this.ready){return}if((e.state==BX.Call.UserState.Failed||e.state==BX.Call.UserState.Unavailable||e.state==BX.Call.UserState.Declined||e.state==BX.Call.UserState.Idle)&&this.type==BX.Call.Type.Instant&&!this.isAnyoneParticipating(!this.someoneWasConnected)){this.hangup()}if(e.state==BX.Call.UserState.Connected&&!this.someoneWasConnected){this.someoneWasConnected=true}}__onPeerInviteTimeout(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})}_onPullEvent(e,i,s){const n={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::usersJoined":this.__onPullEventUsersJoined.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::userInviteTimeout":this.__onPullEventUserInviteTimeout.bind(this),"Call::ping":this.__onPullEventPing.bind(this),"Call::finish":this.__onPullEventFinish.bind(this),[t.repeatAnswer]:this.__onPullEventRepeatAnswer.bind(this)};if(n[e]){this.log(`Signaling: ${e}; Parameters: ${JSON.stringify(i)}`);n[e].call(this,i,s)}}__onPullEventAnswer(e,t){const i=Number(e.senderId);if(i==this.userId){return this.__onPullEventAnswerSelf(e,t)}if(!this.peers[i]){this.peers[i]=this.createPeer(i);this.eventEmitter.emit(BX.Call.Event.onUserInvited,[{userId:i}])}if(!this.users.includes(i)){this.users.push(i)}this.peers[i].setReady(true)}__onPullEventAnswerSelf(e,t){if(e.callInstanceId===this.instanceId||t.server_time_ago>30){return}this.joinStatus=BX.Call.JoinStatus.Remote}__onPullEventHangup(e){const t=e.senderId;if(this.userId==t&&this.instanceId!=e.callInstanceId){this.joinStatus=BX.Call.JoinStatus.None;this.eventEmitter.emit(BX.Call.Event.onHangup);return}if(!this.peers[t]){return}this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}else if(e.code==486){this.peers[t].setBusy(true);CallUtil.error(`user ${t} is busy`)}if(this.ready&&this.type==BX.Call.Type.Instant&&!this.isAnyoneParticipating()){this.hangup()}}__onPullEventUsersJoined(e){this.log("__onPullEventUsersJoined",e);const t=e.users;this.addJoinedUsers(t)}__onPullEventUsersInvited(e){this.log("__onPullEventUsersInvited",e);const t=e.users;this.addInvitedUsers(t)}__onPullEventUserInviteTimeout(e){this.log("__onPullEventUserInviteTimeout",e);const t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}else if(t==this.userId){this.eventEmitter.emit(BX.Call.Event.onPullEventUserInviteTimeout)}}__onPullEventPing(e,t){if(e.callInstanceId==this.instanceId){return}clearTimeout(this.lastPingReceivedTimeout);this.lastPingReceivedTimeout=setTimeout(this.__onNoPingsReceived.bind(this),n*2.1);this.active=true;const i=parseInt(e.senderId,10);if(i==this.userId&&this.joinStatus==BX.Call.JoinStatus.None){this.joinStatus=BX.Call.JoinStatus.Remote;clearTimeout(this.lastSelfPingReceivedTimeout);this.lastSelfPingReceivedTimeout=setTimeout(this.__onNoSelfPingsReceived.bind(this),n*2.1)}if(this.peers[i]){this.peers[i].setReady(true)}}__onNoPingsReceived(){if(!this.ready){this.active=false;if(this._joinStatus==BX.Call.JoinStatus.Remote){this._joinStatus=BX.Call.JoinStatus.None}}}__onNoSelfPingsReceived(){if(!this.ready&&!this.active){this.joinStatus=BX.Call.JoinStatus.None}}__onPullEventFinish(e){this.destroy()}__onPullEventRepeatAnswer(){if(this.ready){this.signaling.sendAnswer({userId:this.userId},true)}}__onLocalDevicesUpdated(e){this.log("__onLocalDevicesUpdated",e)}__onLocalVideoStreamReceived(e){this.log("__onLocalVideoStreamReceived");this.eventEmitter.emit(BX.Call.Event.onLocalMediaReceived,[e])}__onLocalVideoStreamRemoved(){this.eventEmitter.emit(BX.Call.Event.onLocalMediaStopped)}__onSDKLogMessage(e){if(this.logger){this.log(e)}}__onCallDisconnected(e){let t={};const i=e&&typeof e==="object"?e:{};const{headers:s,leaveInformation:n}=i;if(s){t={...t,headers:s}}if(n){t={...t,leaveInformation:n}}this.log("__onCallDisconnected",Object.keys(t).length?t:null);if(this.ready&&n){this.hangup(n.code,n.reason)}this.ready=false;this.muted=false;this.reinitPeers();this.removeCallEvents();this.bitrixCallDev=null;this.joinStatus=BX.Call.JoinStatus.None}__onCallReconnected(){this.eventEmitter.emit(BX.Call.Event.onReconnected)}onFatalError(e){if(e&&e.call){delete e.call}CallUtil.error("onFatalError",e);this.log("onFatalError",e);this.ready=false;this.muted=false;this.reinitPeers();if(this.bitrixCallDev){this.removeCallEvents();try{this.bitrixCallDev.hangup({"X-Reason":"Fatal error","X-Error":typeof e==="string"?e:e.code||e.name})}catch{}this.bitrixCallDev=null}if(typeof e==="string"){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e])}else if(e instanceof Error){this.eventEmitter.emit(BX.Call.Event.onCallFailure,[e.toString()])}else{this.eventEmitter.emit(BX.Call.Event.onCallFailure)}}__onCallEndpointAdded(e){const t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log(`__onCallEndpointAdded (${t})`);if(BX.type.isNotEmptyString(t)&&t.slice(0,4)=="user"){const i=parseInt(t.slice(4));if(this.peers[i]){this.peers[i].setEndpoint(e)}}else{e.on(JNBXEndpoint.Events.InfoUpdated,(()=>{const t=typeof e.userDisplayName==="string"?e.userDisplayName:"";this.log(`BitrixDev.EndpointEvents.InfoUpdated (${t})`,e);if(t.slice(0,4)=="user"){const i=parseInt(t.slice(4));if(this.peers[i]){this.peers[i].setEndpoint(e)}}}));this.log(`Unknown endpoint ${t}`)}}__onCallMessageReceived(e,t){let s;try{s=JSON.parse(t.message)}catch(e){this.log("Could not parse scenario message.",e);return}const n=s.eventName;switch(n){case i.voiceStarted:{this.eventEmitter.emit(BX.Call.Event.onUserVoiceStarted,[s.senderId]);break}case i.voiceStopped:{this.eventEmitter.emit(BX.Call.Event.onUserVoiceStopped,[s.senderId]);break}case i.microphoneState:{this.eventEmitter.emit(BX.Call.Event.onUserMicrophoneState,[s.senderId,s.microphoneState==="Y"]);break}case i.screenState:{this.eventEmitter.emit(BX.Call.Event.onUserScreenState,[s.senderId,s.screenState==="Y"]);break}case i.videoPaused:{this.eventEmitter.emit(BX.Call.Event.onUserVideoPaused,[s.senderId,s.videoPaused==="Y"]);break}case i.floorRequest:{this.eventEmitter.emit(BX.Call.Event.onUserFloorRequest,[s.senderId,s.requestActive==="Y"]);break}case i.emotion:{this.eventEmitter.emit(BX.Call.Event.onUserEmotion,[s.senderId,s.toUserId,s.emotion]);break}case"scenarioLogUrl":{CallUtil.warn(`scenario log url: ${s.logUrl}`);break}default:{this.log(`Unknown scenario event ${n}`)}}}destroy(){this.ready=false;this._joinStatus=BX.Call.JoinStatus.None;if(this.bitrixCallDev){this.removeCallEvents();if(this.bitrixCallDev){this.bitrixCallDev.hangup()}this.bitrixCallDev=null}for(const e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy()}}if(this.logger){this.logger.destroy();this.logger=null}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearTimeout(this.pingUsersInterval);clearTimeout(this.pingBackendInterval);this.eventEmitter.emit(BX.Call.Event.onDestroy,[{call:this}]);this.eventEmitter=null;if(this.signaling){this.signaling.call=null;this.signaling=null}}}const r={accessToken:null,accessTokenTtl:null,get token(){if(this.accessToken&&this.accessTokenTtl&&Date.now()<this.accessTokenTtl){return this.accessToken}return null},setAccessToken(e,t){this.accessToken=e;this.accessTokenTtl=Date.now()+t*1e3},get server(){return BX.componentParameters.get("voximplantServer","")},set server(e){BX.componentParameters.set("voximplantServer",e)},get login(){return BX.componentParameters.get("voximplantLogin","")},set login(e){BX.componentParameters.set("voximplantLogin",e)},getAuthorization(){return new Promise(((e,t)=>{if(this.server){return e({server:this.server,login:this.login})}CallUtil.log("Calling voximplant.authorization.get");BX.rest.callMethod("voximplant.authorization.get").then((t=>{const i=t.data();this.server=i.SERVER;this.login=i.LOGIN;return e({server:this.server,login:this.login})})).catch((e=>{console.error(e);t(e)}))}))},tryLoginWithToken(e){return new Promise(((t,i)=>{if(!("loginWithAccessToken"in e)){return i()}if(this.token){CallUtil.log("Trying to login with saved access token");this.getAuthorization().then((s=>{const n=s.login;const a=s.server;e.loginWithAccessToken(`${n}@${a}`,this.token).then((e=>{CallUtil.log("success",e);console.log(e);if("params"in e&&"accessToken"in e.params){this.setAccessToken(e.params.accessToken,e.params.accessExpire)}t()})).catch((e=>{console.error(e);i(e)}))})).catch((e=>{console.error(e);i(e)}))}else{return i()}}))},tryLoginWithOneTimeKey(e,t){return new Promise(((i,s)=>{e.requestOneTimeKey(t.roomId,t.endpoint,t.token).then((t=>{CallUtil.warn("ontimekey received");CallUtil.warn("ontimekey signed");i(e)})).catch((e=>{s(e)}))}))},getClient(e){return new Promise(((t,i)=>{const s=BXClient.getInstance();if(s.getClientState()==="LOGGED_IN"){return t(s)}const n=e=>{CallUtil.warn("connected");e.off(BXClient.Events.Failed,a);e.off(BXClient.Events.Connected,n);this.tryLoginWithToken(e).then((()=>t(e))).catch((()=>{this.tryLoginWithOneTimeKey(e).then((()=>t(e))).catch((e=>i(e)))}))};let a=(e,t)=>{CallUtil.error(e,t);e.off(BXClient.Events.Failed,a);e.off(BXClient.Events.Connected,n);i(t)};this.tryLoginWithOneTimeKey(s,e).then((()=>t(s))).catch((e=>i(e)))}))}};class d{constructor(e){this.call=e.call}isPublishingEnabled(){return false}inviteUsers(t){return this.__runRestAction(e.invite,t)}sendAnswer(i,s){if(s){this.__sendPullEventOrCallRest(t.answer,e.answer,i,30)}else{return this.__runRestAction(e.answer,i)}}sendCancel(t){return this.__runRestAction(e.cancel,t)}sendHangup(i){if(this.isPublishingEnabled()){this.__sendPullEvent(t.hangup,i);i.retransmit=false;this.__runRestAction(e.hangup,i)}else{i.retransmit=true;this.__runRestAction(e.hangup,i)}}sendVoiceStarted(e){return this.__sendMessage(i.voiceStarted,e)}sendVoiceStopped(e){return this.__sendMessage(i.voiceStopped,e)}sendMicrophoneState(e){return this.__sendMessage(i.microphoneState,{microphoneState:e?"Y":"N"})}sendCameraState(e){return this.__sendMessage(i.cameraState,{cameraState:e?"Y":"N"})}sendVideoPaused(e){return this.__sendMessage(i.videoPaused,{videoPaused:e?"Y":"N"})}sendScreenState(e){return this.__sendMessage(i.screenState,{screenState:e?"Y":"N"})}sendFloorRequest(e){return this.__sendMessage(i.floorRequest,{requestActive:e?"Y":"N"})}sendEmotion(e,t){return this.__sendMessage(i.emotion,{toUserId:e,emotion:t})}sendShowUsers(e){this.call.log(`Show video from users ${BX.type.isArray(e)?e.join("; "):e}`);return this.__sendMessage(i.showUsers,{users:e})}sendShowAll(){return this.__sendMessage(i.showAll,{})}sendHideAll(){return this.__sendMessage(i.hideAll,{})}sendPingToUsers(e){if(this.isPublishingEnabled()){this.__sendPullEvent(t.ping,e,0)}}sendPingToBackend(){this.__runRestAction(e.ping,{retransmit:false})}sendRepeatAnswer(e){this.__sendPullEvent(t.repeatAnswer,e)}sendUserInviteTimeout(e){if(this.isPublishingEnabled()){this.__sendPullEvent(t.userInviteTimeout,e,0)}}getPublishingState(){return BX.PULL.getPublishingState()}__sendPullEvent(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!BX.type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=callEngine.getUuidv4();this.call.log(`Sending p2p signaling event ${e}; ${JSON.stringify(t)}`);BX.PULL.sendMessage(t.userId,"im",e,t,i)}__sendMessage(e,t){if(!this.call.bitrixCallDev){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=callEngine.getUuidv4();this.call.bitrixCallDev.sendMessage(JSON.stringify(t))}__runRestAction(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=callEngine.getUuidv4();return callEngine.getRestClient().callMethod(e,t)}__sendPullEventOrCallRest(e,t,i,s){this.getPublishingState().then((n=>{if(n){this.__sendPullEvent(e,i,s)}else if(t!=""){this.__runRestAction(t,i)}})).catch((e=>{CallUtil.error(e);this.call.log(e)}))}}class h{constructor(e){this.userId=e.userId;this.call=e.call;this.ready=!!e.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.isIncomingVideoAllowed=e.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onInviteTimeout:BX.type.isFunction(e.onInviteTimeout)?e.onInviteTimeout:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onInitialState:BX.type.isFunction(e.onInitialState)?e.onInitialState:BX.DoNothing,onHandRaised:BX.type.isFunction(e.onHandRaised)?e.onHandRaised:BX.DoNothing};this.__onEndpointRemoteMediaAddedHandler=this.__onEndpointRemoteMediaAdded.bind(this);this.__onEndpointRemoteMediaRemovedHandler=this.__onEndpointRemoteMediaRemoved.bind(this);this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.__onEndpointHandRaisedHandler=this.__onEndpointHandRaised.bind(this);this.calculatedState=this.calculateState()}setReady(e){e=!!e;if(this.ready==e){return}this.ready=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()}setDeclined(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}setBusy(e){this.busy=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}setEndpoint(e){this.log(`Adding endpoint with ${e.remoteVideoStreams.length} remote video streams`);this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);clearTimeout(this.callingTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=e;if(this.endpoint.remoteVideoStreams.length>0){this.callbacks.onStreamReceived({userId:this.userId,stream:this.getPriorityStream()})}this.updateCalculatedState();this.bindEndpointEventHandlers();if(e.initialState){this.callbacks.onInitialState({userId:this.userId,microphoneState:e.initialState.microphoneState,floorRequest:e.initialState.floorRequest})}}allowIncomingVideo(e){if(this.isIncomingVideoAllowed==e){return}this.isIncomingVideoAllowed=!!e}bindEndpointEventHandlers(){this.endpoint.on(JNBXEndpoint.Events.VideoStreamAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.on(JNBXEndpoint.Events.VideoStreamRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.on(JNBXEndpoint.Events.Removed,this.__onEndpointRemovedHandler);this.endpoint.on(JNBXEndpoint.Events.HandRaised,this.__onEndpointHandRaisedHandler)}removeEndpointEventHandlers(){this.endpoint.off(JNBXEndpoint.Events.VideoStreamAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.off(JNBXEndpoint.Events.VideoStreamRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.off(JNBXEndpoint.Events.Removed,this.__onEndpointRemovedHandler);this.endpoint.off(JNBXEndpoint.Events.HandRaised,this.__onEndpointHandRaisedHandler)}calculateState(){if(this.endpoint){return BX.Call.UserState.Connected}if(this.calling){return BX.Call.UserState.Calling}if(this.inviteTimeout){return BX.Call.UserState.Unavailable}if(this.declined){return BX.Call.UserState.Declined}if(this.busy){return BX.Call.UserState.Busy}if(this.ready){return BX.Call.UserState.Ready}return BX.Call.UserState.Idle}updateCalculatedState(){const e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState});this.calculatedState=e}}isParticipating(e){if(!(typeof e==="boolean")){e=true}if(e){return(this.calling||this.ready||this.endpoint)&&!this.declined}return(this.ready||this.endpoint)&&!this.declined}waitForConnectionRestore(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),l)}onInvited(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((()=>this.onInviteTimeout(true)),3e4);this.updateCalculatedState()}onInviteTimeout(e){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(e){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}onConnectionRestoreTimeout(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)}__onEndpointRemoteMediaAdded(e){this.log("RemoteMediaAdded",e);this.callbacks.onStreamReceived({userId:this.userId,stream:this.getPriorityStream()});this.updateCalculatedState()}__onEndpointRemoteMediaRemoved(e){console.log(e);this.log("Remote media removed");this.callbacks.onStreamReceived({userId:this.userId,stream:this.getPriorityStream()});this.updateCalculatedState()}__onEndpointRemoved(e){this.log("Endpoint removed");if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}if(this.ready){this.waitForConnectionRestore()}this.updateCalculatedState()}__onEndpointHandRaised(e){this.log("Endpoint hand raised");this.callbacks.onHandRaised({userId:this.userId,isHandRaised:e.isHandRaised})}getPriorityStream(){let e=this.endpoint.remoteVideoStreams;if(e.length==0){return null}let t=e.findLast((e=>e.kind==="sharing"));if(t===undefined){return e[e.length-1]}else{return t}}log(){this.call&&this.call.log.apply(this.call,arguments)}destroy(){if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onStreamReceived=BX.DoNothing;this.callbacks.onInitialState=BX.DoNothing;this.callbacks.onHandRaised=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null;this.call=null}}window.BXClientWrapper=r;window.BitrixCallDev=o})();
//# sourceMappingURL=extension.map.js