(function(e){if(BX&&BX["Mobile"]&&BX["Mobile"]["Vote"]&&BX["Mobile"]["Vote"]["init"])return;BX.namespace("BX.Mobile.Vote");var t={};e.voteGetID=function(){return"vote"+(new Date).getTime()};var s=function(){return app.hidePopupLoader()},i=function(){return app.showPopupLoader()},o=function(){var t=function(e){if(!e["url"])throw"Vote error: url is empty.";else if(!e["CID"])throw"Vote error: id is empty.";else if(!BX(e["controller"]))throw"Vote error: controller is absent.";this.CID=e["CID"];this.voteId=e["voteId"];this.url=e["url"];this.controller=e["controller"];this.form=e["form"];this.bind();this.period=[1,5,10,30];e["startCheck"]=parseInt(e["startCheck"]);this.lastVote=e["startCheck"]>0?e["startCheck"]/60:0;if(this.lastVote<=0)this.check()};t.prototype={status:"ready",check:function(e){var t=e===true?0:false,s;if(e!==true){for(s=0;s<this.period.length;s++){if(this.lastVote<=this.period[s]){t=this.period[s];break}}}if(t!==false)setTimeout(BX.proxy(function(){this.send()},this),t*60*1e3)},send:function(){BX.ajax({url:this.url.replace(/.AJAX_RESULT=Y/g,"").replace(/.AJAX_POST=Y/g,"").replace(/.sessid=[^&]*/g,"").replace(/.VOTE_ID=([\d]+)/,"").replace(/.view_form=Y/g,"").replace(/.view_result=Y/g,""),method:"POST",dataType:"json",data:{VOTE_ID:this.voteId,AJAX_RESULT:"Y",view_result:"Y",dataType:"json",sessid:BX.bitrix_sessid()},onsuccess:BX.proxy(function(e){this.start(e)},this),onfailure:function(e){}})},start:function(e){this.lastVote=parseInt(e["LAST_VOTE"]/60);this.changeData(e);this.check()},changeData:function(e){e=e["QUESTIONS"];var t,s;BX.onCustomEvent(this.controller,"OnBeforeChangeData");for(var i in e){if(e.hasOwnProperty(i)){t=BX.findChild(this.controller,{attr:{id:"question"+i}},true);if(t){for(var o in e[i]){if(e[i].hasOwnProperty(o)){s=BX.findChild(t,{attr:{id:"answer"+o}},true);if(s){BX.adjust(s,{attrs:{"bx-voters-count":e[i][o]["COUNTER"]}});BX.unbindAll(s,"click");if(!this.form)BX.bind(s,"click",n);BX.adjust(BX.findChild(s,{tagName:"DIV",className:"bx-vote-data-percent"},true),{html:"<span>"+parseInt(e[i][o]["PERCENT"])+'</span><span class="post-vote-color">%</span>'});BX.adjust(BX.findChild(s,{tagName:"DIV",className:"bx-vote-answer-bar"},true),{style:{width:parseInt(e[i][o]["PERCENT"])+"%"}})}}}}}}BX.adjust(BX.findChild(this.controller,{tagName:"TD",className:"bx-vote-events-count"},true),{html:"<span>"+parseInt(e["COUNTER"])+'</span><span class="post-vote-color">%</span>'});BX.onCustomEvent(this.controller,"OnAfterChangeData")},replace:function(e,t){e=e.replace(/.AJAX_RESULT=Y/g,"").replace(/.AJAX_POST=Y/g,"").replace(/.sessid=[^&]*/g,"").replace(/.VOTE_ID=([\d]+)/,"").replace(/.view_form=Y/g,"").replace(/.view_result=Y/g,"");this.post(e,t)},getXHR:function(){this.BMAjaxWrapper=this.BMAjaxWrapper||new MobileAjaxWrapper;return this.BMAjaxWrapper},post:function(e,t){if(this.status=="busy")return;var o=true,r;if(t){for(r in t){if(t.hasOwnProperty(r)){o=false;break}}}if(o)return;t["VOTE_ID"]=this.voteId;t["AJAX_POST"]="Y";t["sessid"]=BX.bitrix_sessid();i();this.status="busy";this.postRelease=BX.proxy(function(){s();this.status="ready"},this);this.getXHR().Wrap({type:"html",method:"POST",url:e,data:t,processData:false,callback:BX.proxy(function(s){this.postRelease();if(t&&(t=='{"status":"failed"}'||t.status=="failed")){app.BasicAuth({success:BX.proxy(function(){this.post(e,t)},this),failure:function(){}})}else{var i=BX.processHTML(s,false),o=this.node.block;o.innerHTML="";o.innerHTML=i.HTML;BX.removeClass(o,"bx-vote-block-result");BX.removeClass(o,"bx-vote-block-result-view");if(i.HTML.indexOf("<form")<0){BX.addClass(o,"bx-vote-block-result")}BX.defer(function(){BX.ajax.processScripts(i.SCRIPT)})()}},this),callback_failure:this.postRelease})},node:{revote:null,vote:null,results:null,block:null},bind:function(){this.node.revote=BX("vote-revote-"+this.CID);if(this.node.revote){BX.unbindAll(this.node.revote);BX.bind(this.node.revote,"click",BX.delegate(function(e){BX.eventCancelBubble(e);this.replace(e.target.getAttribute("href"),{view_form:"Y"});return BX.PreventDefault(e)},this))}this.node.vote=BX("vote-do-"+this.CID);if(this.node.vote&&this.form){BX.unbindAll(this.node.vote);BX.bind(this.node.vote,"click",BX.proxy(function(e){BX.eventCancelBubble(e);this.replace(this.form.action,BX.ajax.prepareForm(this.form).data);return BX.PreventDefault(e)},this))}this.node.results=BX("vote-view-"+this.CID);this.node.block=BX.findParent(this.controller,{tagName:"DIV",className:"bx-vote-block"});if(this.node.results){BX.unbindAll(this.node.results);BX.bind(this.node.results,"click",BX.proxy(function(e){BX.eventCancelBubble(e);i();this.node.resultsf=BX.proxy(function(){BX.addClass(this.node.block,"bx-vote-block-result");BX.addClass(this.node.block,"bx-vote-block-result-view");s();BX.removeCustomEvent(this.controller,"OnBeforeChangeData",this.node.resultsf)},this);BX.addCustomEvent(this.controller,"OnBeforeChangeData",this.node.resultsf);this.node.resultsf1=BX.proxy(function(){BX.hide(BX("vote-view-"+this.CID));BX.removeCustomEvent(this.controller,"OnAfterChangeData",this.node.resultsf1)},this);BX.addCustomEvent(this.controller,"OnAfterChangeData",this.node.resultsf1);this.lastVote=0;this.check(true);return BX.PreventDefault(e)},this))}this.onPullEvent=BX.delegate(function(e){var t=e.params;if(e.command=="voting"&&t["VOTE_ID"]==this.voteId){var s=BX.findParent(this.controller,{className:"bx-vote-block"});if(s&&BX.hasClass(s,"bx-vote-block-result")){this.changeData(t)}}},this);BX.addCustomEvent(e,"onPull-vote",this.onPullEvent);BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"VOTE_"+this.voteId},true)},unbind:function(){delete this.form;BX.unbindAll(this.node.revote);delete this.node.revote;BX.unbindAll(this.node.vote);delete this.node.vote;BX.unbindAll(this.node.results);delete this.node.results;delete this.node.block;BX.removeCustomEvent(e,"onPull-vote",this.onPullEvent)}};return t}(),r=function(e,t){if(!t||!t.hasAttribute("bx-voters-count")||parseInt(t.getAttribute("bx-voters-count"))<=0)return false;BX.PreventDefault(e);var s=t.getAttribute("id").replace("answer",""),i="/bitrix/templates/mobile_app/components/bitrix/voting.current/.userfield/users.php?answer_id="+s+"&sessid="+BX.bitrix_sessid();app.openBXTable({url:i,TABLE_SETTINGS:{markmode:false,cache:false}})},n=function(e){r(e,this)};BX.Mobile.Vote.init=function(e){e["CID"]=e["id"];e["controller"]=BX("vote-"+e["id"]);e["form"]=BX("vote-form-"+e["id"]);if(t[e["id"]])t[e["id"]].unbind();t[e["id"]]=new o(e);var s=BX.findChildren(e.controller,{tagName:"TR",className:"bx-vote-answer-item"},true);if(!e["form"]&&s&&s.length>0){for(var i=0;i<s.length;i++){BX.unbindAll(s[i]);BX.bind(s[i],"click",n)}}}})(window);
//# sourceMappingURL=script.map.js