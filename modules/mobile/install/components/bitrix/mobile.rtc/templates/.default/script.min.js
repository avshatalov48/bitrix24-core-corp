if(typeof getToken=="undefined"){var createLink=function(e){var n=BX.message("MobileSiteDir")?BX.message("MobileSiteDir"):"/";var t=false;var o=false;var i={};var a=[];if(e.substr(0,10)=="BLOG|POST|"||e.substr(0,13)=="BLOG|COMMENT|"||e.substr(0,18)=="BLOG|POST_MENTION|"||e.substr(0,21)=="BLOG|COMMENT_MENTION|"||e.substr(0,11)=="BLOG|SHARE|"||e.substr(0,17)=="BLOG|SHARE2USERS|"){a=e.split("|");t=n+"mobile/log/?ACTION=CONVERT&ENTITY_TYPE_ID=BLOG_POST&ENTITY_ID="+a[2]}if(e.substr(0,11)=="TASKS|TASK|"||e.substr(0,14)=="TASKS|COMMENT|"){a=e.split("|");t=n+"mobile/tasks/snmrouter/?routePage=view&TASK_ID="+a[2]}if(t){t={LINK:t,UNIQUE:o,DATA:i}}return t};var imPullMessageTimeOut=0;var imData=[];BXMobileApp.addCustomEvent("onPullExtendWatch",function(e){BX.PULL.extendWatch(e.id,e.force)});BX.addCustomEvent("onPullClearWatch",function(e){BX.PULL.extendWatch(e.id)});BX.addCustomEvent("thisPageWillDie",function(e){BX.PULL.clearWatch(e.page_id)});BX.addCustomEvent("onPullEvent",function(e,n,t,o){if(e=="im"){imData.push({command:n,params:t,extra:o});clearTimeout(imPullMessageTimeOut);imPullMessageTimeOut=setTimeout(function(){BXMobileApp.onCustomEvent("onPull-"+e,{data:imData},true);imData=[]},100)}else{BXMobileApp.onCustomEvent("onPull-"+e,{command:n,params:t,extra:o},true);BXMobileApp.onCustomEvent("onPull",{module_id:e,command:n,params:t,extra:o},true)}});BX.addCustomEvent("onPullOnlineEvent",function(e,n,t){BXMobileApp.onCustomEvent("onPullOnline",{command:e,params:n,extra:t},true)});BX.PULL.authTimeout=null;BX.addCustomEvent("onPullError",function(e){if(e=="AUTHORIZE_ERROR"){clearTimeout(BX.PULL.authTimeout);BX.PULL.authTimeout=setTimeout(function(){app.BasicAuth({success:function(){BX.PULL.setPrivateVar("_pullTryConnect",true);BX.PULL.updateState("13",true)}})},500)}});BXMobileApp.addCustomEvent("onCallInvite",function(e){if(e.userId){var n=e.video!=false&&e.video!="NO";mwebrtc.callInvite(e.userId,n)}});BX.addCustomEvent("onOpenPush",function(e){var n=BXMobileApp.PushManager.prepareParams(e);if(BX.util.in_array(n.ACTION,["post","tasks","comment","mention","share","share2users"])){var t=createLink(n.TAG);if(typeof t.LINK!="undefined"&&t.LINK.length>0){BXMobileApp.PageManager.loadPageUnique({url:t.LINK,unique:t.UNIQUE,data:t.DATA,bx24ModernStyle:true})}}});BX.ready(function(){BXIM=new BX.ImMobile({mobileAction:"INIT",userId:BX.message("USER_ID"),user_tz_offset:0})});var getToken=function(e){var n=window.platform=="ios"?"APPLE":"GOOGLE"+(app.enableInVersion(14)?"/REV2":"");var t={iOSUseVoipService:true,callback:function(t){var o=null;if(typeof t=="object"){if(t.voipToken){o=t.voipToken;n="APPLE/VOIP"}else if(t.token){o=t.token}}else{o=t}var i={url:app.dataBrigePath,method:"POST",tokenSaveRequest:true,data:{mobile_action:"save_device_token",device_name:typeof device.name=="undefined"?device.model:device.name,uuid:device.uuid,device_token:o,device_type:n,sessid:BX.bitrix_sessid()}};if(e){i.repeatble=true;var a=function(e,n,t){BX.removeCustomEvent("onAjaxFailure",a);if(t.tokenSaveRequest&&n==401&&t.repeatble){app.BasicAuth({success:function(){getToken(false)}})}};BX.addCustomEvent("onAjaxFailure",a)}BX.ajax(i)}};app.exec("getToken",t)};BX.ready(function(){setTimeout(function(){getToken(true)},2e3)});if(BX.PULL.supportWebSocket()){if(app.enableInVersion(16)){BX.addCustomEvent("onAppPaused",function(){BX.PULL.tryConnectSet(0,false);BX.PULL.returnPrivateVar("_WS").close(1e3,"The app went to background")});BX.addCustomEvent("UIApplicationDidBecomeActiveNotification",function(){if(!BX.PULL.isWebSoketConnected()){BX.PULL.setPrivateVar("_pullTryConnect",false);BX.PULL.tryConnect()}})}}var connectionManager={init:function(){BX.addCustomEvent("onPullStatus",function(e){connectionManager.lastStatus=e;clearTimeout(connectionManager.showConnectingTimeout);if(e=="connect"){connectionManager.isConnecting=true;connectionManager.showConnectingTimeout=setTimeout(function(){connectionManager.connect.show()},2e3)}else{if(connectionManager.connect.isShown){setTimeout(function(){connectionManager.connect.hide()},1e3)}else if(connectionManager.offline.isShown&&e=="online"){connectionManager.offline.hide();setTimeout(function(){connectionManager.online.show()},400)}}});BX.addCustomEvent("onPullError",function(e){connectionManager.lastStatus=e;clearTimeout(connectionManager.showConnectingTimeout);connectionManager.showConnectingTimeout=setTimeout(function(){connectionManager.offline.show()},2e3)})},connect:new BXMobileApp.UI.NotificationBar({message:"��������� ����������...",color:"#afF0B31C",textColor:"#ffffff",groupId:"websoket",maxLines:2,align:"center",indicatorHeight:30,isGlobal:true,useCloseButton:true,autoHideTimeout:2e4,useLoader:true,onHideAfter:function(){if(connectionManager.isConnecting){if(connectionManager.lastStatus=="online"||connectionManager.lastStatus=="offline"){setTimeout(function(){connectionManager[connectionManager.lastStatus].show(connectionManager.lastStatus);connectionManager.lastStatus=null},500)}connectionManager.isConnecting=false}},hideOnTap:true},"process"),offline:new BXMobileApp.UI.NotificationBar({message:"���������� ��������",color:"#affb0000",textColor:"#ffffff",groupId:"websoket",maxLines:2,align:"center",indicatorHeight:30,isGlobal:true,useCloseButton:true,autoHideTimeout:3e4,hideOnTap:true},"fail"),online:new BXMobileApp.UI.NotificationBar({message:"���������� �����������!",color:"#af09A11F",textColor:"#ffffff",groupId:"websoket",maxLines:2,align:"center",indicatorHeight:30,isGlobal:true,useCloseButton:true,autoHideTimeout:2e3,hideOnTap:true},"success"),show:function(e){if(this[e]){this[e].show()}},lastStatus:null,isConnecting:false,showConnectingTimeout:0}}