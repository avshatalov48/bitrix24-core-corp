BX.namespace("BX.Mobile.Crm.Company.Edit");BX.Mobile.Crm.Company.Edit={ajaxPath:"",formActionUrl:"",formId:"",companyViewPath:"",mode:"",contactContainerNode:"",contactInfo:"",isRestrictedMode:false,logoFile:"",logoDel:"",init:function(o){if(o&&typeof o==="object"){this.ajaxPath=o.ajaxPath||"";this.formActionUrl=o.formActionUrl||"";this.formId=o.formId||"";this.companyViewPath=o.companyViewPath||"";this.mode=o.mode||"";this.isRestrictedMode=o.isRestrictedMode||false;this.leadId=o.leadId||"";this.contactInfo=o.contactInfo||"";this.contactContainerNode=document.querySelector("[data-role='mobile-crm-company-edit-contact']")||""}if(this.mode=="EDIT"){BXMobileApp.addCustomEvent("onCrmCompanyEditUpdate",BX.proxy(function(o){if(o.formId==this.formId){BXMobileApp.UI.Page.reload()}},this))}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onCrmCompanyViewUpdate",BX.proxy(function(o){if(o.formId==this.formId){BXMobileApp.UI.Page.reload()}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(o){if(o.formId==this.formId)BXMobileApp.onCustomEvent("onCrmCompanyEditUpdate",{formId:this.formId},true)},this))}if(this.mode=="CREATE"){BX.addCustomEvent("onCrmCompanyCreate",BX.proxy(function(){BX.Mobile.Crm.loadPageBlank(this.companyViewPath)},this))}if(this.mode=="CONVERT"||this.mode=="CREATE"){var t=function(){BX.removeCustomEvent("onOpenPageAfter",t);app.closeModalDialog()};BX.addCustomEvent("onCrmCompanyClose",function(){if(!(window.isCurrentPage&&window.isCurrentPage=="Y")){BX.addCustomEvent("onOpenPageAfter",t)}else{window.isCurrentPage=""}})}var e={entityContainerNode:this.contactContainerNode,entityInfo:this.contactInfo,isRestrictedMode:this.isRestrictedMode,isMultiEntity:true};this.contactEditor=new BX.Mobile.Crm.EntityEditor(e);BXMobileApp.addCustomEvent("onCrmContactSelectForCompany",BX.proxy(function(o){this.contactEditor.changeEntity(o)},this));BX.addCustomEvent("onCrmCompanyDetailDelete",function(){BXMobileApp.onCustomEvent("onCrmCompanyListUpdate",{},true);BXMobileApp.UI.Page.close({drop:true})});if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onSubmitForm",BX.proxy(function(o,t,e){if(o.formId==this.formId){if(e.checked==false||!e.hasAttribute("checked")){var i=BX.create("INPUT",{attrs:{type:"hidden",name:e.name,value:""}});e.parentNode.insertBefore(i,e)}}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(o){if(o.hasOwnProperty("formId")&&o.formId==this.formId){BXMobileApp.onCustomEvent("onCrmCompanyListUpdate",{},true)}},this))}if(this.mode=="EDIT"||this.mode=="CREATE"){var i=BX.delegate(function(o,t,e){if(o==this.formId&&e){BX.addCustomEvent(e,"onChange",BX.proxy(this.onChangeLogo,this))}},this);BX.addCustomEvent("onInitialized",i);var a=BX.Mobile.Grid.Form.getByFormId(this.formId);i(this.formId,"",a)}},onChangeLogo:function(o,t,e,i){if(!(typeof i==="object"&&i))return;if(i.action=="add"){this.logoFile=i.file}else if(i.action=="delete"){this.logoDel="Y";this.logoFile=""}},submit:function(){BXMobileApp.UI.Page.LoadingScreen.show();var o=BX(this.formId);if(o){var t={sessid:BX.bitrix_sessid()};if(this.leadId){t["lead_id"]=this.leadId;t["continue"]="Y"}else{t["save"]="Y"}if(this.contactEditor.curEntityId){t["CONTACT_ID"]=this.contactEditor.curEntityId}BX.Mobile.Crm.Detail.collectInterfaceFormData(o,t);var e=new FormData;for(var i in t){if(t.hasOwnProperty(i)){e.append(i,t[i])}}if(this.logoFile){e.append("LOGO",this.logoFile,this.logoFile.name)}else if(this.logoDel=="Y"){e.append("LOGO_del","Y");e.append("LOGO",BX.UploaderUtils.dataURLToBlob("data:image/jpg;base64"),"")}BX.ajax({method:"POST",dataType:"json",url:this.formActionUrl,data:e,preparePost:false,onsuccess:BX.proxy(function(o){BXMobileApp.UI.Page.LoadingScreen.hide();if(o.error){BX.Mobile.Crm.showErrorAlert(o.error)}else{if(this.mode=="EDIT"){BXMobileApp.onCustomEvent("onCrmCompanyListUpdate",{},true);BXMobileApp.onCustomEvent("onCrmCompanyViewUpdate",{formId:this.formId},true);app.closeModalDialog({cache:false})}if(this.mode=="CREATE"){var t=this.companyViewPath.replace("#company_id#",o.itemId);BXMobileApp.onCustomEvent("onCrmCompanyLoadPageBlank",{path:t},true);app.closeModalDialog({cache:false})}if(this.mode=="CONVERT"&&o.url){if(o.url.indexOf("page=edit")>0){BXMobileApp.PageManager.loadPageModal({url:o.url})}else{BXMobileApp.onCustomEvent("onCrmCompanyLoadPageBlank",{path:o.url,type:"convert"},true)}app.closeModalDialog({cache:false})}}},this)})}}};
//# sourceMappingURL=script.map.js