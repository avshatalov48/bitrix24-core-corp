(function(){if(BX.Menu)return;BX.Menu=function(){BXMobileApp.addCustomEvent("mobile_calendar_first_page_trigger",BX.proxy(function(){window.bCalendarShowMobileHelp=false;this.calendarList(this.MenuSettings.userId)},this));BX.addCustomEvent("onMobileMenuSettingsSet",BX.proxy(function(){var e={enable:true,pulltext:BX.message("PULL_TEXT"),downtext:BX.message("DOWN_TEXT"),loadtext:BX.message("LOAD_TEXT")};if(app.enableInVersion(2))e.action="RELOAD";else e.callback=function(){document.location.reload()};app.pullDown(e)},this));BX.addCustomEvent("onPullOnline",BX.delegate(function(e){var t=e.params;e=e.command;if(e=="user_status"&&this.MenuSettings.userId==t.USER_ID&&t.COLOR!=""){BX.style(BX("menu-user"),"background-color",t.COLOR)}},this));BXMobileApp.addCustomEvent("onClearLFCounter",function(e){var t={};t[e]=0;BX.Menu.updateCounters(t)});BX.addCustomEvent("onPullEvent-main",function(e,t){if(e=="user_counter"&&t[BX.message("SITE_ID")]){var n=t[BX.message("SITE_ID")];BX.Menu.updateCounters(n)}});BX.addCustomEvent("onImUpdateCounter",function(e){if(e){if(typeof e["obZeroDate"]!="undefined"){var t=e["obZeroDate"];delete e["obZeroDate"]}BX.Menu.updateCounters(e,typeof t!="undefined"?t:null)}});BX.addCustomEvent("onUpdateUserCounters",function(e){if(e){if(typeof e["obZeroDate"]!="undefined"){var t=e["obZeroDate"];delete e["obZeroDate"]}BX.Menu.updateCounters(e,typeof t!="undefined"?t:null)}});this.MenuSettings={lang:{},userId:false,siteDir:"/",canInvite:false,calendarFirstVisit:false,profileUrl:null,helpUrl:null,timemanUrl:null,marketPlaceApps:[],set:function(e){if(e){if(e.userId)this.userId=e.userId;if(e.siteDir)this.siteDir=e.siteDir;if(e.marketPlaceApps)this.marketPlaceApps=e.marketPlaceApps;if(e.canInvite)this.canInvite=e.canInvite;if(e.calendarFirstVisit)this.calendarFirstVisit=e.calendarFirstVisit;if(BX.type.isNotEmptyString(e.profileUrl)){this.profileUrl=e.profileUrl}if(BX.type.isNotEmptyString(e.helpUrl)){this.helpUrl=e.helpUrl}if(BX.type.isNotEmptyString(e.timemanUrl)){this.timemanUrl=e.timemanUrl}}BX.onCustomEvent("onMobileMenuSettingsSet",[e])}};this.getMarketPlaceAppName=function(e){var t=this.MenuSettings.marketPlaceApps;var n=t.length;for(var i=0;i<n;i++){if(t[i]["id"]==e){return t[i]["name"]}}return null};this.currentItem=null;this.init=function(e){this.currentItem=e;var t=document.getElementById("menu-items");var n=this;new FastButton(t,function(e){n.onItemClick(e)});var i={"menu-user-accounts":function(e){app.exec("showAuthForm");BX.eventCancelBubble(e)},"menu-user-help":function(e){BXMobileApp.PageManager.loadPageStart({url:n.MenuSettings.helpUrl});BX.eventCancelBubble(e)},"menu-user-timeman":function(e){BXMobileApp.PageManager.loadPageStart({url:n.MenuSettings.timemanUrl,bx24ModernStyle:true});BX.eventCancelBubble(e)},"menu-user-logout":function(e){app.logOut();BX.eventCancelBubble(e)}};for(var a in i){var s=BX(a);if(!s){continue}BX.bind(s,"touchstart",function(){BX.addClass(this,"menu-user-action-selected")});BX.bind(s,"touchend",function(){BX.removeClass(this,"menu-user-action-selected")});new FastButton(s,i[a])}new FastButton(BX("menu-user"),function(){BXMobileApp.PageManager.loadPageStart({url:n.MenuSettings.profileUrl,bx24ModernStyle:true,page_id:"user_profile"})})};this.onItemClick=function(e){var t=e.target;var n=BX.hasClass(t.parentNode,"menu-item");if(t&&t.nodeType&&t.nodeType==1&&(BX.hasClass(t,"menu-item")||n)){if(n)t=t.parentNode;if(this.currentItem!=null)this.unselectItem(this.currentItem);this.selectItem(t);if(t.getAttribute("data-highlight")=="N"){setTimeout(BX.delegate(function(){this.unselectItem(t)},this),500)}var i=t.getAttribute("data-url");var a=t.getAttribute("data-name");var s=t.getAttribute("data-mp-app");var o=t.getAttribute("data-mp-app-id");var r=t.getAttribute("data-mp-app-name");var u=t.getAttribute("data-page-id");var l=t.getAttribute("data-modern-style");if(BX.type.isNotEmptyString(i)){var p={url:i};if(s==="Y"){if(r!==null){p["title"]=r}p.url=location.protocol+"//"+location.host+p.url;app.exec("openMarketplaceApp",p)}else{if(a){p["title"]=a}if(BX.type.isNotEmptyString(u))p.page_id=u;if(BX.type.isNotEmptyString(l)&&l=="Y")p.bx24ModernStyle=true;BXMobileApp.PageManager.loadPageStart(p)}}else{t.onclick()}this.currentItem=t}};this.selectItem=function(e){if(!BX.hasClass(e,"menu-item-selected"))BX.addClass(e,"menu-item-selected")};this.unselectItem=function(e){BX.removeClass(e,"menu-item-selected")}};BX.Menu.counters={};BXMobileApp.addCustomEvent("onGetLFCounter",function(e){if(typeof e.counterType!="undefined"&&typeof BX.Menu.counters[e.counterType]!="undefined"){BXMobileApp.onCustomEvent("onSetLFCounter",{value:BX.Menu.counters[e.counterType]["value"],zeroCounterTS:BX.Menu.counters[e.counterType]["zeroCounter"]},true)}});BX.Menu.updateCounters=function(e,t){var n=0;for(var i in e){var a=BX(i=="**"?"menu-counter-live-feed":"menu-counter-"+i.toLowerCase(),true);if(!a)continue;if(e[i]>0){var s=e[i]>50;var o=BX.findChild(a,{className:"menu-item-counter-value"});if(o){o.innerHTML=s?"50":e[i];BX.addClass(a,"menu-item-counter-show-value"+(s?" menu-item-counter-show-plus":""))}}else{BX.removeClass(a,"menu-item-counter-show-value menu-item-counter-show-plus")}window.test=a;BX.Menu.counters[i]={value:e[i],zeroCounter:typeof t=="object"&&t!=null&&typeof t[i]!="undefined"?t[i]:null}}for(var r in BX.Menu.counters){n=n+parseInt(BX.Menu.counters[r]["value"])}};BX.Menu.prototype.userList=function(e){var t={url:this.MenuSettings.siteDir+"mobile/?mobile_action=get_user_list&tags=Y&detail_url="+this.MenuSettings.siteDir+"mobile/users/?user_id=",isroot:true,table_settings:{type:"users",name:e?BX.message("MB_CONTACTS"):BX.message("MB_COMPANY"),alphabet_index:true,outsection:false}};if(this.MenuSettings.canInvite){t["table_settings"]["button"]={type:"plus",callback:BX.delegate(function(){app.openNewPage(this.MenuSettings.siteDir+"mobile/users/invite.php")},this)}}app.openBXTable(t);app.closeMenu();if(platform=="android"){app.exec("offerAndroidAccountContactsSync")}else{if(BX.localStorage.get("carddav_ask")!="Y"){BX.localStorage.set("carddav_ask","Y",3600*24*30);app.confirm({text:BX.message("MB_ASK_SYNC_CARDDAV"),buttons:[BX.message("MB_ASK_SYNC_YES"),BX.message("MB_ASK_SYNC_NO")],callback:function(e){if(e==1){BX.ajax.get("/bitrix/tools/dav_profile.php?action=token&params[resources]=carddav",{},function(e){console.log(e);var t=JSON.parse(e);if(t.token){var n="/bitrix/tools/dav_profile.php?action=payload&params[resources]=carddav&params[access_token]=";app.openUrl(window.document.location.protocol+"//"+document.location.host+n+t.token)}})}}})}}};BX.Menu.prototype.bpList=function(e){app.openBXTable({url:this.MenuSettings.siteDir+"mobile/webdav/"+e,isroot:true,table_settings:{type:"files",useTagsInSearch:false}});app.closeMenu()};BX.Menu.prototype.webdavList=function(e){app.openBXTable({url:this.MenuSettings.siteDir+"mobile/webdav/"+e,isroot:true,table_settings:{type:"files",name:BX.message("MB_CURRENT_USER_FILES_MAIN_MENU_ITEM"),useTagsInSearch:false}});app.closeMenu()};BX.Menu.prototype.diskList=function(e,t){t=t||"/";e=e||{};t=encodeURIComponent(t);var n=encodeURIComponent(e.type);var i=encodeURIComponent(e.entityId);BX.MobileUI.List.show({url:this.MenuSettings.siteDir+"mobile/?mobile_action=disk_folder_list&type="+n+"&path="+t+"&entityId="+i,isroot:true,table_settings:{type:"files",showTitle:true,name:e.entityId==="shared_files_s1"?BX.message("MB_SHARED_FILES_MAIN_MENU_ITEM_NEW"):BX.message("MB_CURRENT_USER_FILES_MAIN_MENU_ITEM_NEW"),useTagsInSearch:false,overflowmenu:true}},"disk");app.closeMenu()};BX.Menu.prototype.calendarList=function(e){BX.addCustomEvent("mobile_calendar_first_page",function(){window.bCalendarShowMobileHelp=false});if(window.bCalendarShowMobileHelp==undefined){window.bCalendarShowMobileHelp=this.MenuSettings.calendarFirstVisit}if(window.bCalendarShowMobileHelp===false||window.platform=="android"){app.openBXTable({url:this.MenuSettings.siteDir+"mobile/?mobile_action=calendar&user_id="+e,isroot:true,table_id:"calendar_list",table_settings:{cache:true,name:BX.message("MB_CALENDAR_LIST"),useTagsInSearch:false,use_sections:true,button:{type:"plus",callback:BX.delegate(function(){app.openNewPage(this.MenuSettings.siteDir+"mobile/calendar/edit_event.php")},this)}}})}else{app.loadPage(this.MenuSettings.siteDir+"mobile/calendar/first_page.php")}app.closeMenu()};window.MobileMenu=new BX.Menu;BX.MobileUI.List.addListener(function(e,t,n){if(e==BX.MobileUI.List.Events.ON_ITEM_MORE_CHOOSED){n.showMenu([{title:BX.message("MB_COPY_PUBLIC_LINK"),sort:2,params:t,eventName:"createLink"}],t.NAME)}else if(e=="createLink"){if(t.ID){BX.ajax.post("/bitrix/components/bitrix/disk.folder.list/ajax.php?action=generateExternalLink",{objectId:t.ID,sessid:BX.bitrix_sessid()},function(e){var t=JSON.parse(e);if(t.link){app.exec("copyToClipboard",{text:t.link});app.alert(BX.message("MB_COPY_LINK_COPIED_MESSAGE"))}})}}},"disk")})();