BX.namespace("BX.Mobile.Crm.Deal.Edit");BX.Mobile.Crm.Deal.Edit={ajaxPath:"",formActionUrl:"",formId:"",dealViewPath:"",mode:"",products:[],productDataFieldName:"",productsContainerNode:"",contactContainerNode:"",companyContainerNode:"",contactInfo:"",companyInfo:"",isRestrictedMode:false,leadId:"",quoteId:"",onSelectCompanyEventName:"",onDeleteCompanyEventName:"",onSelectContactEventName:"",pageIdProductSelectorBack:"crmDealEditPage",init:function(e){if(e&&typeof e==="object"){this.ajaxPath=e.ajaxPath||"";this.formActionUrl=e.formActionUrl||"";this.formId=e.formId||"";this.dealViewPath=e.dealViewPath||"";this.mode=e.mode||"";this.isRestrictedMode=e.isRestrictedMode||false;this.leadId=e.leadId||"";this.quoteId=e.quoteId||"";this.products=e.products||[];this.productDataFieldName=e.productDataFieldName||"";this.contactInfo=e.contactInfo||"";this.companyInfo=e.companyInfo||"";this.productsContainerNode=document.querySelector("[data-role='mobile-crm-deal-edit-products']")||"";this.contactContainerNode=document.querySelector("[data-role='mobile-crm-deal-edit-contact']")||"";this.companyContainerNode=document.querySelector("[data-role='mobile-crm-deal-edit-company']")||"";this.onSelectContactEventName=e.onSelectContactEventName||"";this.onSelectCompanyEventName=e.onSelectCompanyEventName||"";this.onDeleteCompanyEventName=e.onDeleteCompanyEventName||"";this.pageIdProductSelectorBack=e.pageIdProductSelectorBack||"crmDealEditPage"}if(this.mode=="EDIT"||this.mode=="CREATE"){app.setPageID(this.pageIdProductSelectorBack)}if(this.mode=="EDIT"){BXMobileApp.addCustomEvent("onCrmDealEditUpdate",BX.proxy(function(e){if(e.formId==this.formId){BXMobileApp.UI.Page.reload()}},this))}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onCrmDealViewUpdate",BX.proxy(function(e){if(e.formId==this.formId){BXMobileApp.UI.Page.reload()}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(e){if(e.formId==this.formId)BXMobileApp.onCustomEvent("onCrmDealEditUpdate",{formId:this.formId},true)},this))}if(this.mode=="CREATE"){BX.addCustomEvent("onCrmDealCreate",BX.proxy(function(){BX.Mobile.Crm.loadPageBlank(this.dealViewPath)},this))}BX.addCustomEvent("onCrmDealDetailDelete",function(){BXMobileApp.onCustomEvent("onCrmDealListUpdate",{},true);BXMobileApp.UI.Page.close({drop:true})});var t={entityContainerNode:this.contactContainerNode,entityInfo:this.contactInfo,isRestrictedMode:this.isRestrictedMode,onSelectEventName:this.onSelectContactEventName};this.contactEditor=new BX.Mobile.Crm.EntityEditor(t);var o={entityContainerNode:this.companyContainerNode,entityInfo:this.companyInfo,isRestrictedMode:this.isRestrictedMode,onSelectEventName:this.onSelectCompanyEventName,onDeleteEventName:this.onDeleteCompanyEventName};this.companyEditor=new BX.Mobile.Crm.EntityEditor(o);if(this.mode!=="VIEW"){BX.addCustomEvent(this.onDeleteCompanyEventName,BX.proxy(function(){BX.onCustomEvent("CrmEntitySelectorChangeValue",["COMPANY",0])},this));BX.addCustomEvent(this.onSelectCompanyEventName,BX.proxy(function(){BX.onCustomEvent("CrmEntitySelectorChangeValue",["COMPANY",data.id])},this))}if(this.mode=="CONVERT"||this.mode=="CREATE"){var i=function(){BX.removeCustomEvent("onOpenPageAfter",i);app.closeModalDialog()};BX.addCustomEvent("onCrmDealClosePage",function(){if(!(window.isCurrentPage&&window.isCurrentPage=="Y")){BX.addCustomEvent("onOpenPageAfter",i)}else{window.isCurrentPage=""}})}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onSubmitForm",BX.proxy(function(e,t,o){if(e.formId==this.formId){if(o.checked==false||!o.hasAttribute("checked")){var i=BX.create("INPUT",{attrs:{type:"hidden",name:o.name,value:""}});o.parentNode.insertBefore(i,o)}}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(e){if(e.hasOwnProperty("formId")&&e.formId==this.formId){BXMobileApp.onCustomEvent("onCrmDealListUpdate",{},true)}},this))}if(this.mode=="VIEW"||this.mode=="EDIT"){var a=BX.delegate(function(e,t,o){if(e==this.formId&&o){BX.addCustomEvent(o,"onChange",BX.proxy(this.onChange,this))}},this);BX.addCustomEvent("onInitialized",a);var n=BX.Mobile.Grid.Form.getByFormId(this.formId);a(this.formId,"",n)}},onChange:function(e,t,o){if(t&&t.name&&t.name=="CURRENCY_ID"){if(typeof BX.Mobile.Crm.ProductEditor=="object"&&BX.Mobile.Crm.ProductEditor){var i=BX.Mobile.Crm.ProductEditor;var a=t.value;i.setCurrencyId(a)}}},submit:function(){BXMobileApp.UI.Page.LoadingScreen.show();var e=BX(this.formId);if(e){var t={sessid:BX.bitrix_sessid()};if(this.leadId||this.quoteId){if(this.leadId)t["lead_id"]=this.leadId;else if(this.quoteId)t["conv_quote_id"]=this.quoteId;t["continue"]="Y"}else{t["save"]="Y"}if(BX.Mobile.Crm.ProductEditor&&BX.Mobile.Crm.ProductEditor.products){t[this.productDataFieldName]=BX.Mobile.Crm.ProductEditor.products}if(this.contactEditor){t["CONTACT_ID"]=this.contactEditor.curEntityId}if(this.companyEditor){t["COMPANY_ID"]=this.companyEditor.curEntityId}BX.Mobile.Crm.Detail.collectInterfaceFormData(e,t);BX.ajax({method:"POST",dataType:"json",url:this.formActionUrl,data:t,onsuccess:BX.proxy(function(e){BXMobileApp.UI.Page.LoadingScreen.hide();if(e.error){BX.Mobile.Crm.showErrorAlert(e.error)}else{if(this.mode=="EDIT"){BXMobileApp.onCustomEvent("onCrmDealListUpdate",{},true);BXMobileApp.onCustomEvent("onCrmDealViewUpdate",{formId:this.formId},true);app.closeModalDialog({cache:false})}if(this.mode=="CREATE"){var t=this.dealViewPath.replace("#deal_id#",e.itemId);BXMobileApp.onCustomEvent("onCrmDealLoadPageBlank",{path:t},true);app.closeModalDialog({cache:false})}if(this.mode=="CONVERT"&&e.url){if(e.url.indexOf("page=edit")>0){BXMobileApp.PageManager.loadPageModal({url:e.url})}else{BXMobileApp.onCustomEvent("onCrmDealLoadPageBlank",{path:e.url,type:"convert"},true)}app.closeModalDialog({cache:false})}}},this)})}}};
//# sourceMappingURL=script.map.js