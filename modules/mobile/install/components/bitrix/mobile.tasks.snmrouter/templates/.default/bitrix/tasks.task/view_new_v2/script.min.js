(function(){var e=window.BX;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["detail"])return;e.namespace("BX.Mobile.Tasks.detail");e.Mobile.Tasks.detail=function(t,s){this.parentConstruct(e.Mobile.Tasks.detail,t);e.merge(this,{sys:{classCode:"detail"},vars:{objectId:e.util.getRandomString()},task:t.taskData,taskEditObj:new e.Mobile.Tasks.edit({taskData:t.taskData,formId:t.formId,setTitle:false}),currentTs:t.currentTs,guid:t.guid});this.handleInitStack(s,e.Mobile.Tasks.detail,t);app.getPageParams({callback:function(t){if(t&&t["bSetFocusOnCommentsList"]=="YES"){e.ready(function(){var t;if((t=e("task-comments-block"))&&t){var s=e.pos(t);window.scrollTo(0,s["top"])}})}}})};e.extend(e.Mobile.Tasks.detail,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.detail.prototype,{init:function(){window.app.hidePopupLoader();this.act=e.delegate(this.act,this);this.actExecute=e.delegate(this.actExecute,this);this.actSuccess=e.delegate(this.actSuccess,this);this.actFailure=e.delegate(this.actFailure,this);this.canReadAllComments=false;this.commentsToRead=[];this.stub=null;this.platformDelta=window.platform==="ios"?60:0;this.formInterface=e.Mobile.Grid.Form.getByFormId(this.option("formId"));e.hide(e("commentsStub"));e.onCustomEvent("onTaskWasLoaded",[this.task]);if(typeof this.task["LOG_ID"]!="undefined"){var t={log_id:this.task["LOG_ID"],ts:this.currentTs,bPull:false};BXMobileApp.onCustomEvent("onLogEntryRead",t,true)}this.bindControls();this.bindEvents()},bindControls:function(){e.bind(e("options_button"),"click",e.proxy(function(){var e=[{guid:this.guid,taskId:this.task.ID}];BXMobileApp.onCustomEvent("onTaskDetailOptionsButtonClick",e,true)},this));e.bind(e("down_button"),"click",e.delegate(function(){this.scrollToBottom()},this));e.bind(e("up_button"),"click",e.delegate(function(){this.scrollToTop()},this));if(e("favorites"+this.task["ID"])){e.bind(e("favorites"+this.task["ID"]),"click",e.proxy(function(){if(this.task["ACTION"]["ADD_FAVORITE"]){this.act("favorite.add");e.addClass(e("favorites"+this.task["ID"]),"active")}else if(this.task["ACTION"]["DELETE_FAVORITE"]){this.act("favorite.delete");e.removeClass(e("favorites"+this.task["ID"]),"active")}},this))}},bindEvents:function(){e.addCustomEvent(window,"onUCFormSubmit",e.delegate(function(){console.log("tasks: onUCFormSubmit");this.hideCommentsStub()},this));e.addCustomEvent(window,"OnUCAfterRecordAdd",e.delegate(function(e,t,s,i,a){console.log("tasks: OnUCAfterRecordAdd");this.hideCommentsStub();this.canReadAllComments=true;this.commentsToRead.push(i.messageId)},this));e.addCustomEvent(window,"OnUCCommentWasPulled",e.delegate(function(e){console.log("tasks: OnUCCommentWasPulled");this.hideCommentsStub();this.canReadAllComments=true;this.commentsToRead.push(e)},this));e.addCustomEvent(window,"OnUCommentWasDeleted",e.delegate(function(e){console.log("tasks: OnUCommentWasDeleted")},this));window.addEventListener("scroll",e.delegate(function(){var t=this.getScrollTop();var s=document.body.scrollHeight-2*this.webViewHeight+75+this.platformDelta;var i=this.webViewHeight-75;var a=t>=document.body.scrollHeight-document.body.clientHeight+this.platformDelta;if(t>i){if(!e.hasClass(e("up_button"),"task-show-button")){e.addClass(e("up_button"),"task-show-button")}}else{e.removeClass(e("up_button"),"task-show-button")}e("down_button").style.display=t<s?"block":"none";if(a&&this.canReadAllComments){console.log("OnUCCommentWasRead");e.ajax.runAction("tasks.task.view.update",{data:{taskId:this.task.ID}});e.onCustomEvent("OnUCCommentWasRead",this.commentsToRead);BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID},"tasks.view");BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID},"tasks.list");this.canReadAllComments=false;this.commentsToRead=[]}},this));e.addCustomEvent("onTextPanelShown",e.delegate(function(t){if(!this.webViewHeight){this.webViewHeight=t.webViewHeight||document.body.clientHeight-75}var s=e("post-comments-wrap");if(s){var i=e.findChild(s,{className:"post-comment-block-new"},true);if(i){var a=i.offsetTop-75}else{var o=e.findChild(s,{className:"post-comment-block"},true);if(o){a=o.offsetTop-75}else{this.showCommentsStub(s);a=this.stub.offsetTop}}window.scrollTo(0,a)}BXMobileApp.UI.Page.LoadingScreen.hide()},this));BXMobileApp.addCustomEvent("tasks.view.native::onTaskUpdate",e.delegate(function(e){console.log("tasks.view.native::onTaskUpdate");if(e.taskId!==this.task.ID){return}if(e.hasOwnProperty("favorite")){document.querySelector("#favorites"+this.task.ID).classList.toggle("active")}if(e.hasOwnProperty("responsible")){window.app.reload()}},this));BXMobileApp.addCustomEvent("tasks.view.native::onItemAction",e.delegate(function(e){if(e.taskId!==this.task.ID){return}switch(e.name){default:break;case"deadline":var t=this.getParsedDate(new Date(e.values.deadline));this.getFormElement(e.name).callback(t);break;case"responsible":var s=e.values.user;s={ID:s.id,NAME:s.name,IMAGE:s.icon||false};this.getFormElement(e.name).callback({a_users:[s]});break}},this));BXMobileApp.addCustomEvent("onItemSelected",e.delegate(function(){this.scrollToTop()},this));BXMobileApp.addCustomEvent("onTaskWasUpdated",e.delegate(function(e,t,s,i,a){if(!s){t=e[1];e=e[0]}if(this.task["ID"]==e&&t!==this.taskEditObj.vars["id"]){if(!a){if(Application.getApiVersion()<31){window.app.showPopupLoader()}window.app.reload()}}},this));BXMobileApp.addCustomEvent("onTaskWasRemoved",e.delegate(function(e,t,s){if(!s){e=e[0]}if(this.task["ID"]==e){window.app.closeController({drop:true})}},this));BXMobileApp.addCustomEvent("onTaskWasPerformed",e.delegate(function(e,t,s){if(!s){s=e[2];t=e[1];e=e[0]}if(this.task["ID"]==e&&t!==this.variable("objectId")){if(s["OPERATION"]=="task.dayplan.timer.start"||s["OPERATION"]=="task.dayplan.timer.stop"||s["OPERATION"]=="task.complete")this.actSuccess(s,true);else this.actSuccess(s,false)}},this));e.MobileUI.addLivefeedLongTapHandler(e("post_inform_wrap_two"),{likeNodeClass:"post-item-informer-like"});e.MobileUI.addLivefeedLongTapHandler(e("task-comments-block"),{likeNodeClass:"post-comment-control-item-like"})},getScrollTop:function(){return window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},scrollToTop:function(){console.log("scrollToTop");app.exec("setScroll",{x:0,y:0,animated:true},false)},scrollToBottom:function(){console.log("scrollToBottom");var e=document.body.scrollHeight-document.body.clientHeight+this.platformDelta;app.exec("setScroll",{x:0,y:e,animated:true},false)},getParsedDate:function(e){var t=("0"+e.getDate()).slice(-2);var s=("0"+(e.getMonth()+1)).slice(-2);var i=e.getFullYear();var a=("0"+e.getHours()).slice(-2);var o=("0"+e.getMinutes()).slice(-2);return t+"."+s+"."+i+" "+a+":"+o},getFormElement:function(e){var t=0;switch(e){default:break;case"deadline":for(t=0;t<this.formInterface.elements.length;t++){if(this.formInterface.elements[t].node&&this.formInterface.elements[t].node.name==="data[DEADLINE]"){return this.formInterface.elements[t]}}break;case"responsible":for(t=0;t<this.formInterface.elements.length;t++){if(this.formInterface.elements[t].select&&this.formInterface.elements[t].select.name==="data[SE_RESPONSIBLE][0][ID]"){return this.formInterface.elements[t]}}break}return null},hideCommentsStub:function(){if(this.stub&&e.isShown(this.stub)){e.hide(this.stub)}},showCommentsStub:function(t){if(!this.stub){this.stub=e("commentsStub");this.stub.style.height=this.webViewHeight-75+"px";e.append(this.stub,t);e.show(this.stub)}else{e.show(this.stub)}},getDefaultMenu:function(){var t=[{name:e.message("MB_TASKS_TASK_DETAIL_TASK_ADD"),arrowFlag:false,icon:"add",action:e.Mobile.Tasks.createWindow},{name:e.message("MB_TASKS_TASK_DETAIL_TASK_ADD_SUBTASK"),arrowFlag:false,icon:"add",action:e.proxy(function(){e.Mobile.Tasks.createWindow(null,this.task["ID"])},this)}];var s,i=this.task["ACTION"],a=this.task["ID"];for(var o in this.task["ACTION"]){if(this.task["ACTION"].hasOwnProperty(o)){if(!i[o])continue;s=(o+"").toUpperCase();if(s=="EDIT"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_EDIT"),icon:"edit",arrowFlag:false,action:function(){var t=e.message("TASK_PATH_TO_EDIT").replace(/#TASK_ID#/gi,a).replace(/#USER_ID#/gi,e.message("USER_ID")).replace(/#SALT#/gi,(new Date).getTime());window.BXMobileApp.PageManager.loadPageModal({url:t,bx24ModernStyle:true,cache:false})}})}else if(s=="REMOVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_REMOVE"),icon:"delete",action:e.proxy(function(){window.app.confirm({title:e.message("MB_TASKS_TASK_REMOVE_CONFIRM_TITLE"),text:e.message("MB_TASKS_TASK_DETAIL_CONFIRM_REMOVE"),buttons:["OK",e.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")],callback:e.proxy(function(e){if(e==1){this.act("delete")}},this)})},this)})}else if(s=="ACCEPT"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_ACCEPT_TASK"),icon:"check",action:e.proxy(function(){this.act("accept")},this)})}else if(s=="START"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_START_TASK"),icon:"play",action:e.proxy(function(){this.act("start")},this)})}else if(s=="DECLINE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_DECLINE_TASK"),icon:"cancel",action:e.proxy(function(){this.act("decline")},this)})}else if(s=="RENEW"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_RENEW_TASK"),icon:"reload",action:e.proxy(function(){this.act("renew")},this)})}else if(s=="COMPLETE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_CLOSE_TASK"),icon:"finish",action:e.proxy(function(){this.act("complete")},this)})}else if(s=="DEFER"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_PAUSE_TASK"),icon:"pause",action:e.proxy(function(){this.act("defer")},this)})}else if(s=="APPROVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_APPROVE_TASK"),icon:"check",action:e.proxy(function(){this.act("approve")},this)})}else if(s=="DISAPPROVE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_REDO_TASK"),icon:"reload",action:e.proxy(function(){this.act("disapprove")},this)})}else if(s=="DELEGATE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_DELEGATE_TASK"),icon:"finish",action:e.proxy(function(){new window.BXMobileApp.UI.Table({url:e.message("SITE_DIR")+"mobile/index.php?mobile_action=get_user_list",table_settings:{callback:e.proxy(function(e){if(!(e&&e.a_users&&e.a_users[0]))return;this.act("delegate",{userid:e.a_users[0]["ID"].toString()})},this),markmode:true,multiple:false,return_full_mode:true,skipSpecialChars:true,modal:true,alphabet_index:true,outsection:false,cancelname:e.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")}},"users").show()},this)})}else if(s=="ADD_FAVORITE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_ADD_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:e.proxy(function(){this.act("favorite.add")},this)})}else if(s=="DELETE_FAVORITE"){t.push({name:e.message("MB_TASKS_TASK_DETAIL_BTN_DELETE_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:e.proxy(function(){this.act("favorite.delete")},this)})}}}return t},act:function(t,s){if(this.task.isBusy)return;if(this.appCtrls&&this.appCtrls.menu)this.appCtrls.menu.hide();window.app.showPopupLoader();var i=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:t,id:this.task["ID"]});new e.Tasks.Util.Query({url:i}).add("task."+t,{id:this.task["ID"],taskid:this.task["ID"],userid:s?s["userid"]:false,objectId:this.variable("objectId"),parameters:{RETURN_ENTITY:true}},{},{onExecuted:e.proxy(function(a){if(a&&a.response&&a.response.status=="failed"){window.app.BasicAuth({success:e.proxy(function(){new e.Tasks.Util.Query({url:i}).add("task."+t,{id:this.task["ID"],taskid:this.task["ID"],userid:s?s["userid"]:false,objectId:this.variable("objectId"),parameters:{RETURN_ENTITY:true}},{},{onExecuted:this.actExecute}).execute()},this),failure:this.actFailure})}else this.actExecute.apply(this,arguments)},this)}).execute()},actExecute:function(t,s){window.app.hidePopupLoader();if(t&&t.length>0){for(var i=0;i<t.length;i++)t[i]=t[i]["MESSAGE"]||t[i]["CODE"];window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else if(s["OPERATION"]=="task.delete"){window.BXMobileApp.onCustomEvent("onTaskWasRemoved",[this.task["ID"],this.variable("objectId"),s],true,true)}else{window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[this.task["ID"],this.variable("objectId"),s],true,true);this.actSuccess(s,true)}},actSuccess:function(t,s){var i,a=false;if(t["OPERATION"]=="task.favorite.delete"){a=true;this.task["ACTION"]["DELETE_FAVORITE"]=false;this.task["ACTION"]["ADD_FAVORITE"]=true;if(e("favorites"+this.task["ID"]))e.removeClass(e("favorites"+this.task["ID"]),"active")}else if(t["OPERATION"]=="task.favorite.add"){a=true;this.task["ACTION"]["DELETE_FAVORITE"]=true;this.task["ACTION"]["ADD_FAVORITE"]=false;if(e("favorites"+this.task["ID"]))e.addClass(e("favorites"+this.task["ID"]),"active")}else if(t["OPERATION"]=="task.delegate"){e.reload()}else if(t["OPERATION"]=="task.get"){this.task["ACTION"]={};for(i in t["RESULT"]["CAN"]["ACTION"]){if(t["RESULT"]["CAN"]["ACTION"].hasOwnProperty(i)){this.task["ACTION"][i.toUpperCase()]=t["RESULT"]["CAN"]["ACTION"][i]=="YES"||t["RESULT"]["CAN"]["ACTION"][i]=="true"||t["RESULT"]["CAN"]["ACTION"][i]===true}}a=true;var o=t["RESULT"]["DATA"]["REAL_STATUS"];if(e("bx-task-status-"+this.task["ID"])&&o!=this.task["REAL_STATUS"]){this.task["REAL_STATUS"]=t["RESULT"]["DATA"]["REAL_STATUS"];this.task["STATUS"]=t["RESULT"]["DATA"]["STATUS"];var n=e.Mobile.Tasks.statusMap[o]||"STATE_UNKNOWN";e("bx-task-status-"+this.task["ID"]).innerHTML=e.message("TASKS_STATUS_"+n)}}else if(s===true){var l=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"get",id:this.task["ID"]});new e.Tasks.Util.Query({url:l}).add("task.get",{id:this.task["ID"],jsAction:"perform"},{},{onExecuted:this.actExecute}).execute()}if(Application.getApiVersion()<31&&a){this.resetMenu(this.getDefaultMenu())}},actFailure:function(){window.app.alert({text:e.message("TASKS_LIST_GROUP_ACTION_ERROR1"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}});if(e.MobileUI.TextField.defaultParams){window.BX.MobileUI.TextField.show()}else{e.addCustomEvent(e.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,function(){window.BX.MobileUI.TextField.show()})}})();
//# sourceMappingURL=script.map.js