(function(){var e=window.BX,t;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["list"])return;e.namespace("BX.Mobile.Tasks.list");window.BXMobileApp.addCustomEvent("onTasksListSort",function(t){if(t&&t["action"]=="sort"){var a=e.util.add_url_param(top.location.href,{SORTF:t["sortBy"],SORTD:t["sortOrder"].toUpperCase()});window.app.showPopupLoader();window.app.reload({url:a})}});window.BXMobileApp.addCustomEvent("onTasksListFields",function(){e.reload()});var a=new(function(){var t=function(){this.tasks={};this.timer=null;this.check=e.delegate(this.check,this)};t.prototype={activate:function(t){var a=e("bx-task-timetracking-"+t);if(a)a.disabled=false},register:function(t,a){var i=e("bx-task-timetracking-"+t);if(!i)return;i.checked=true;i.disabled=false;this.tasks[t]={trueTime:parseInt(i.value),currentTime:0};if(a&&a["TIME_ELAPSED"])this.tasks[t].trueTime=parseInt(a["TIME_ELAPSED"]);if(this.timer===null)this.timer=setInterval(this.check,1e3)},deregister:function(t,a){if(e("bx-task-timetracking-"+t)){e("bx-task-timetracking-"+t).checked=false;if(a===true)e("bx-task-timetracking-"+t).disabled=true;if(this.tasks[t])e("bx-task-timetracking-"+t).value=this.tasks[t].trueTime+this.tasks[t].currentTime}delete this.tasks[t];var i=0;for(var s in this.tasks){if(this.tasks.hasOwnProperty(s)){i++;break}}if(i===0){clearInterval(this.timer);this.timer=null}},check:function(){for(var e in this.tasks){if(this.tasks.hasOwnProperty(e)){this.refresh(e,++this.tasks[e].currentTime+this.tasks[e].trueTime)}}},refresh:function(t,a){var i=e("bx-task-timetracking-"+t+"-value"),s=[Math.floor(a/3600),Math.floor(a/60)%60,a%60],r;for(r=0;r<s.length;r++){s[r]+="";s[r]="00".substring(0,2-s[r].length)+s[r]}i.innerHTML=s.join(":")}};return t}());e.Mobile.Tasks.list=function(t,a){this.parentConstruct(e.Mobile.Tasks.list,t);e.merge(this,{sys:{classCode:"list"},vars:{objectId:e.util.getRandomString(),task:{}}});for(var i in t.tasksData){if(t.tasksData.hasOwnProperty(i)){this.bindTask(t.tasksData[i]["ID"],t.tasksData[i])}}this.handleInitStack(a,e.Mobile.Tasks.list,t)};e.extend(e.Mobile.Tasks.list,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.list.prototype,{bindTask:function(t,i){this.variable("task"+t,i);if(e("bx-task-priority-"+i["ID"])&&!e("bx-task-priority-"+i["ID"]).hasAttribute("bx-bound")){e("bx-task-priority-"+i["ID"]).setAttribute("bx-bound","Y");e.bind(e("bx-task-priority-"+i["ID"]),"click",e.delegate(function(){this.act("changePriority",t)},this))}if(e("bx-task-favorites-"+i["ID"])&&!e("bx-task-favorites-"+i["ID"]).hasAttribute("bx-bound")){e("bx-task-favorites-"+i["ID"]).setAttribute("bx-bound","Y");e.bind(e("bx-task-favorites-"+i["ID"]),"click",e.delegate(function(){this.act("favorite.addDelete",t)},this))}if(e("bx-task-timetracking-"+i["ID"])&&!e("bx-task-timetracking-"+i["ID"]).hasAttribute("bx-bound")){e("bx-task-timetracking-"+i["ID"]).setAttribute("bx-bound","Y");if(e("bx-task-timetracking-"+i["ID"]).checked)a.register(i["ID"],i);var s=e.proxy(function(t){e.eventCancelBubble(t);this.act("dayplan.timer."+(e("bx-task-timetracking-"+i["ID"]).checked?"start":"stop"),i["ID"]);return e.PreventDefault(t)},this);e.bind(e("bx-task-timetracking-"+i["ID"]),"click",s)}},init:function(){t=this;window.app.hidePopupLoader();e.Mobile.Tasks.list.actShow=e.delegate(this.actShow,this);e.Mobile.Tasks.list.act=e.delegate(this.act,this);this.actExecute=e.delegate(this.actExecute,this);this.actSuccess=e.delegate(this.actSuccess,this);this.actFailure=e.delegate(this.actFailure,this);BXMobileApp.addCustomEvent("onTaskWasUpdated",e.delegate(function(t,a,i){if(!i){i=t[2];t=t[0]}var s=this.variable("task"+t),r=false;if(s){if(i["TITLE"]&&i["TITLE"]!=s["TITLE"]&&e("bx-task-title-"+s["ID"])){e("bx-task-title-"+s["ID"]).innerHTML=i["TITLE"]}if(i["DESCRIPTION"]&&i["DESCRIPTION"]!=s["DESCRIPTION"]){if(e("bx-task-description-"+s["ID"]))e("bx-task-description-"+s["ID"]).innerHTML=i["DESCRIPTION"];else r=true}if(i["RESPONSIBLE"]&&i["RESPONSIBLE_ID"]&&i["RESPONSIBLE_ID"]+""!=s["RESPONSIBLE_ID"]+""){if(e("bx-task-responsible_id-"+s["ID"])){e("bx-task-responsible_id-"+s["ID"]).innerHTML=i["RESPONSIBLE"]["NAME"];e("bx-task-responsible_id-"+s["ID"]).setAttribute("bx-user_id",i["RESPONSIBLE_ID"])}else r=true}if(i["PRIORITY"]&&i["PRIORITY"]+""!=s["PRIORITY"]+""&&e("bx-task-priority-"+s["ID"])){e("bx-task-priority-"+s["ID"]).checked=i["PRIORITY"]==2}if(i["REAL_STATUS"]&&i["STATUS"]+""!=s["STATUS"]+""&&e("bx-task-status-"+s["ID"])){var T=e.Mobile.Tasks.statusMap;e("bx-task-status-"+s["ID"]).innerHTML=e.message("TASKS_STATUS_"+T[s["STATUS"]])||e.message("TASKS_STATUS_STATE_UNKNOWN")}if(i["DEADLINE"]&&i["DEADLINE"]+""!=s["DEADLINE"]+""){if(e("bx-task-deadline-"+s["ID"]))e("bx-task-deadline-"+s["ID"]).innerHTML=i["DEADLINE"];else r=true}if(r){e.reload()}}},this));BXMobileApp.addCustomEvent("onTaskWasCreated",function(){e.reload()});BXMobileApp.addCustomEvent("onTaskWasPerformed",e.proxy(function(e,t,a){if(!a){a=e[2];t=e[1];e=e[0]}if(this.variable("task"+e)&&t!=this.variable("objectId"))this.actSuccess(a)},this));BXMobileApp.addCustomEvent("onTaskWasRemoved",e.delegate(function(t,a,i){if(!i){t=t[0]}if(this.variable("task"+t)){var s=e.findChild(e("bx-mobile-grid"),{attribute:{"data-id":"mobile-grid-item-"+t}},true,false);if(s){e.fx.hide(s,{type:"fold",time:.2})}}},this))},getDefaultMenu:function(){return[{name:e.message("MB_TASKS_ROLES_TASK_ADD"),arrowFlag:false,icon:"add",action:e.Mobile.Tasks.createWindow},{name:e.message("TASKS_LIST_SORT"),image:"/bitrix/js/mobile/images/sort.png",arrowFlag:false,icon:"",action:function(){window.BXMobileApp.PageManager.loadPageModal({url:top.location.href.replace(/routePage=list/gi,"routePage=listsorter").replace(/SORTF=[a-z]+/gi,"").replace(/SORTD=[a-z]+/gi,"").replace(/&&/gi,"&"),bx24ModernStyle:true})}},{name:e.message("TASKS_LIST_FIELDS"),image:"/bitrix/js/mobile/images/fields.png",arrowFlag:false,icon:"",action:function(){window.BXMobileApp.PageManager.loadPageModal({url:top.location.href.replace(/routePage=list/gi,"routePage=listfields"),bx24ModernStyle:true})}}]},actShow:function(t){var a=this.variable("task"+t);if(a){var i=[];i.push({title:e.message("TASKS_LIST_GROUP_ACTION_VIEW"),callback:function(){window.BXMobileApp.PageManager.loadPageUnique({url:e.message("TASK_PATH_TO_READ").replace(/#TASK_ID#/gi,t).replace(/#USER_ID#/gi,e.message("USER_ID")),bx24ModernStyle:true})}});if(a["ALLOWED_ACTIONS"]["ACTION_EDIT"])i.push({title:e.message("TASKS_LIST_GROUP_ACTION_EDIT"),callback:function(){var a=e.message("TASK_PATH_TO_EDIT").replace(/#TASK_ID#/gi,t).replace(/#USER_ID#/gi,e.message("USER_ID")).replace(/#SALT#/gi,(new Date).getTime());window.BXMobileApp.PageManager.loadPageModal({url:a,bx24ModernStyle:true,cache:false})}});if(a["ALLOWED_ACTIONS"]["ACTION_COMPLETE"])i.push({title:e.message("TASKS_LIST_GROUP_ACTION_COMPLETE"),callback:function(){e.Mobile.Tasks.list.act("complete",t)}});if(a["ALLOWED_ACTIONS"]["ACTION_DEFER"])i.push({title:e.message("TASKS_LIST_GROUP_ACTION_DEFER"),callback:function(){e.Mobile.Tasks.list.act("defer",t)}});if(i.length>0)new window.BXMobileApp.UI.ActionSheet({buttons:i},"actionSheet").show()}},act:function(t,a,i){if(this.appCtrls&&this.appCtrls.menu)this.appCtrls.menu.hide();var s=e.type.isPlainObject(a)?a["id"]:0,r=e.type.isPlainObject(a)?a["id"]:a;a=a+0>0?a:a["id"];var T=this.variable("task"+r),o=t,n={act:o,id:r,userid:e.message("USER_ID"),taskid:r};if(t=="favorite.addDelete"){o=T["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]?"favorite.add":"favorite.delete"}else if(t=="changePriority"){o="update";n["task.action"]="changePriority";n.data={PRIORITY:T["PRIORITY"]+""=="2"?"0":"2"}}if(e.type.isPlainObject(i)){for(var l in i){if(i.hasOwnProperty(l)){n[l]=i[l]}}}var A=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:o,id:r});n["parameters"]=n["parameters"]||{};n["parameters"]["RETURN_ENTITY"]=true;window.app.showPopupLoader();new e.Tasks.Util.Query({url:A}).add("task."+o,n,{},{onExecuted:e.proxy(function(t){if(t&&t.response&&t.response.status=="failed"){window.app.BasicAuth({success:e.proxy(function(){new e.Tasks.Util.Query({url:A}).add("task."+o,n,{},{onExecuted:this.actExecute}).execute()},this),failure:this.actFailure})}else this.actExecute.apply(this,arguments)},this)}).execute()},actExecute:function(t,a){window.app.hidePopupLoader();if(t&&t.length>0){var i=[],s;for(var r=0;r<t.length;r++){if(t[r]["CODE"]=="ACTION_FAILED.OTHER_TASK_ON_TIMER"){window.app.confirm({title:e.message("TASKS_TT_ERROR1_TITLE"),text:e.message("TASKS_TT_ERROR1_DESC").replace("#TITLE#",t[r]["DATA"]["TASK"]["TITLE"]),callback:e.proxy(function(t){return e.proxy(function(e){if(e<=1){this.act("dayplan.timer.start",a["ARGUMENTS"]["taskid"],{stopPrevious:t})}},this)},this)(t[r]["DATA"]["TASK"]["ID"]),buttons:[e.message("TASKS_TT_CONTINUE"),e.message("TASKS_TT_CANCEL")]});return}else{i.push(t[r]["MESSAGE"]||t[r]["CODE"])}}window.app.alert({text:i.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else if(a["OPERATION"]=="task.delete"){window.BXMobileApp.onCustomEvent("onTaskWasRemoved",[a["ARGUMENTS"]["taskid"],this.variable("objectId"),a],true,true)}else{window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[a["ARGUMENTS"]["taskid"],this.variable("objectId"),a],true,true);this.actSuccess(a)}},actSuccess:function(t){var i=t["ARGUMENTS"]?t["ARGUMENTS"]["id"]||t["ARGUMENTS"]["taskid"]:0,s=this.variable("task"+i),r=e("bx-task-status-"+s["ID"]),T=e("bx-task-icon-"+s["ID"]),o=e.Mobile.Tasks.statusMap;if(!s)return;if(t["OPERATION"]=="task.renew"){a.activate(s["ID"])}else if(t["OPERATION"]=="task.start"||t["OPERATION"]=="task.dayplan.timer.start"){s["ALLOWED_ACTIONS"]["ACTION_START"]=false;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=true;e.hide(e("bx-task-start-"+s["ID"]));e.show(e("bx-task-complete-"+s["ID"]));r.innerHTML=e.message("TASKS_STATUS_STATE_IN_PROGRESS");T.className="mobile-grid-fields-task-icon state_in_progress";a.activate(s["ID"]);if(t["OPERATION"]=="task.dayplan.timer.start"){e("bx-task-timetracking-"+s["ID"]).checked=true;a.register(s["ID"],t["RESULT"]["TASK"]);a.deregister(t["ARGUMENTS"]["stopPrevious"]);a.deregister(t["ARGUMENTS"]["stopprevious"])}}else if(t["OPERATION"]=="task.complete"){s["ALLOWED_ACTIONS"]["ACTION_START"]=false;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=false;e.hide(e("bx-task-start-"+s["ID"]));e.hide(e("bx-task-complete-"+s["ID"]));r.innerHTML=e.message("TASKS_STATUS_STATE_COMPLETED");T.className="mobile-grid-fields-task-icon state_completed";a.deregister(s["ID"],true)}else if(t["OPERATION"]=="task.defer"){s["ALLOWED_ACTIONS"]["ACTION_START"]=true;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=true;e.show(e("bx-task-start-"+s["ID"]));e.show(e("bx-task-complete-"+s["ID"]));r.innerHTML=e.message("TASKS_STATUS_STATE_DEFERRED");T.className="mobile-grid-fields-task-icon state_deferred";a.deregister(s["ID"])}else if(t["OPERATION"]=="task.favorite.add"){s["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]=false;s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"]=true;if(e("bx-task-favorites-"+i))e("bx-task-favorites-"+i).checked=true}else if(t["OPERATION"]=="task.dayplan.timer.stop"){a.deregister(s["ID"])}else if(t["OPERATION"]=="task.favorite.delete"){s["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]=true;s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"]=false;if(e("bx-task-favorites-"+i))e("bx-task-favorites-"+i).checked=false}else if(t["OPERATION"]=="task.update"&&t["ARGUMENTS"]&&t["ARGUMENTS"]["task.action"]=="changePriority"){s["PRIORITY"]=t["ARGUMENTS"]["data"]["PRIORITY"]+"";if(e("bx-task-priority-"+i))e("bx-task-priority-"+s["ID"]).checked=s["PRIORITY"]=="2"}else if(t["OPERATION"]=="task.get"){for(var n in t["RESULT"]["CAN"]["ACTION"]){if(t["RESULT"]["CAN"]["ACTION"].hasOwnProperty(n)){s["ALLOWED_ACTIONS"]["ACTION_"+n]=t["RESULT"]["CAN"]["ACTION"][n]=="YES"||t["RESULT"]["CAN"]["ACTION"][n]=="true"||t["RESULT"]["CAN"]["ACTION"][n]===true}}e[s["ALLOWED_ACTIONS"]["ACTION_START"]?"show":"hide"](e("bx-task-start-"+s["ID"]));e[s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]?"show":"hide"](e("bx-task-complete-"+s["ID"]));if(t["RESULT"]["DATA"]["REAL_STATUS"]&&t["RESULT"]["DATA"]["REAL_STATUS"]+""!=s["REAL_STATUS"]+""&&e("bx-task-status-"+s["ID"])){for(n in t["RESULT"]["DATA"]){if(t["RESULT"]["DATA"].hasOwnProperty(n)){if(s.hasOwnProperty(n))s[n]=t["RESULT"]["DATA"][n]}}var l=o[s["REAL_STATUS"]]||"STATE_UNKNOWN";r.innerHTML=e.message("TASKS_STATUS_"+l);T.className="mobile-grid-fields-task-icon "+l.toLowerCase()}if(e("bx-task-favorites-"+i))e("bx-task-favorites-"+i).checked=s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"]}else if(t["OPERATION"]=="task.delegate"){e.reload()}},actFailure:function(){window.app.alert({text:e.message("TASKS_LIST_GROUP_ACTION_ERROR1"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}});e.Mobile.Tasks.go=function(t){window.BXMobileApp.PageManager.loadPageUnique({url:e.message("TASK_PATH_TO_USER_PROFILE").replace("#USER_ID#",t.getAttribute("bx-user_id")),bx24ModernStyle:true})};e.Mobile.Tasks.list.addCurrent=function(e,a){if(t){t.bindTask(e,a)}}})();
//# sourceMappingURL=script.map.js