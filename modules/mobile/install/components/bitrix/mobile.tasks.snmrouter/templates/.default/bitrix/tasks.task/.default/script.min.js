(function(){var e=window.BX;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["edit"])return;e.namespace("BX.Mobile.Tasks.edit");var t=0,i=function(){return"TaskEdit"+ ++t+e.util.getRandomString()},s=function(){var t=function(t,i){this.canAdd=false;this.counter=0;this.sort=0;this.clickAdd=e.delegate(this.clickAdd,this);this.clickSeparator=e.delegate(this.clickSeparator,this);this.clickMenu=e.delegate(this.clickMenu,this);this.callback=e.delegate(this.callback,this);var s;this.taskId=t;this.ids={};i=i||[];for(s=0;s<i.length;s++){this.ids[i[s]]=i[s];this.bindItem(i[s])}this.container=e("checkList"+t+"Container");if(this.container&&e("checkList"+t+"Add")){this.canAdd=true;e.bind(e("checkList"+t+"Add"),"click",this.clickAdd);if(e("checkList"+t+"Separator")){e.bind(e("checkList"+t+"Separator"),"click",this.clickSeparator)}}};t.prototype={bindItem:function(t){if(e("checkListItem"+t+"Menu"))e.bind(e("checkListItem"+t+"Menu"),"click",e.proxy(function(e){this.clickMenu(e,t)},this));var i=e("checkListItem"+t),s=e("checkListItem"+t+"Label");if(e.hasClass(s,"task-view-checklist-toggle")){s.setAttribute("bx-toggle","Y");i.setAttribute("bx-toggle","Y")}if(e.hasClass(s,"task-view-checklist-modify")){s.setAttribute("bx-modify","Y");i.setAttribute("bx-modify","Y")}if(e.hasClass(s,"task-view-checklist-remove")){s.setAttribute("bx-remove","Y");i.setAttribute("bx-remove","Y")}if(e.findParent(i,{tagName:"span",className:"mobile-grid-field-divider"},s)){s.setAttribute("bx-separator","Y");i.setAttribute("bx-separator","Y")}if(s.hasAttribute("bx-toggle"))e.bind(i,"click",e.proxy(function(){this.fireEvent(t,"toggle",{})},this));else e.bind(i,"click",e.proxy(function(t){return e.eventCancelBubble(t)},this));this.sort=i.form.elements["data[SE_CHECKLIST]["+t+"][SORT_INDEX]"].value},clickMenu:function(t,i){var s=e("checkListItem"+i),a=e("checkListItem"+i+"Label"),n=[];if(!a.hasAttribute("bx-separator")){if(a.hasAttribute("bx-toggle"))n.push({title:s.checked?e.message("MB_TASKS_TASK_UNCHECK"):e.message("MB_TASKS_TASK_CHECK"),callback:e.delegate(function(){s.checked=!s.checked;this.fireEvent(i,"toggle",{})},this)});if(a.hasAttribute("bx-modify"))n.push({title:e.message("MB_TASKS_TASK_EDIT"),callback:e.delegate(function(){var t=e.findChild(a,{tagName:"INPUT",attribute:{type:"hidden",name:"data[SE_CHECKLIST]["+i+"][TITLE]"}},true);if(t)this.show(t.value,i)},this)})}if(a.hasAttribute("bx-remove"))n.push({title:e.message("MB_TASKS_TASK_DELETE"),callback:e.delegate(function(){this.fireEvent(i,"remove",{});e.remove(a)},this)});if(n.length>0)new window.BXMobileApp.UI.ActionSheet({buttons:n},"textPanelSheet").show();return e.PreventDefault(t)},clickSeparator:function(t){if(this.canAdd)this.callback({text:"===",extraData:{id:"n"+this.counter++}},{separator:true});return t?e.PreventDefault(t):false},clickAdd:function(t){if(this.canAdd)this.showAdd("n"+this.counter++);return t?e.PreventDefault(t):false},showAdd:function(t){var i=e.create("LABEL",{attrs:{id:"checkListItem"+t+"Label",className:"edit"},html:['<span class="mobile-grid-field-tasks-checklist-item">','<span class="mobile-grid-field-tasks-checklist-item-text">&nbsp;</span>','<input type="text" id="checkListItem',t,'Text" value="" placeholder="',e.message("MB_TASKS_TASK_CHECKLIST_PLACEHOLDER"),'"/>',"</span>"].join("")});this.container.appendChild(i);var s=0,a=e.proxy(function(t){if(s>100)return;s++;if(e("checkListItem"+t+"Text")){e.bind(e("checkListItem"+t+"Text"),"blur",e.proxy(function(){if(e("checkListItem"+t+"Text")){var i=e("checkListItem"+t+"Text").value,s=e("checkListItem"+t+"Label");if(e.type.isNotEmptyString(i.trim()))this.callback({text:i,extraData:{id:t}},{replaceNode:e("checkListItem"+t+"Label")});else if(s&&s.parentNode)s.parentNode.removeChild(s)}},this));e.bind(e("checkListItem"+t+"Text"),"keyup",e.proxy(function(i){if(i.keyCode==13){var s=e("checkListItem"+t+"Text").value,a=e("checkListItem"+t+"Label");if(e.type.isNotEmptyString(s))setTimeout(e.proxy(this.clickAdd,this),100);else if(a&&a.parentNode)a.parentNode.removeChild(a)}},this));setTimeout(function(){e.focus(e("checkListItem"+t+"Text"))},100)}else{setTimeout(function(){a(t)},100)}},this);a(t)},show:function(t,i){window.app.exec("showPostForm",{attachButton:null,attachedFiles:null,extraData:{id:i},mentionButton:null,smileButton:null,message:{text:e.util.htmlspecialcharsback(t)},okButton:{callback:this.callback,name:e.message("interface_form_save")},cancelButton:{callback:function(){},name:e.message("interface_form_cancel")}})},callback:function(t,i){t.text=e.util.htmlspecialchars(t.text)||"";i=i||{};var s=t.extraData.id,a,n=false,o=i.replaceNode,r=i.separator;if(e("checkListItem"+s)){a=e("checkListItem"+s+"Label");e.removeClass(a,"edit");n=e("checkListItem"+s).checked}else{a=e.create("LABEL",{attrs:{for:"checkListItem"+s,id:"checkListItem"+s+"Label",className:"task-view-checklist task-view-checklist-toggle task-view-checklist-modify task-view-checklist-remove"}});if(e(o)){o.parentNode.replaceChild(a,o)}else{this.container.appendChild(a)}}a.innerHTML=['<span class="',r?"mobile-grid-field-divider":"mobile-grid-field-tasks-checklist-item",'">','<input type="hidden" name="data[SE_CHECKLIST][',s,'][ID]" value="',s,'" />','<input type="checkbox" name="data[SE_CHECKLIST][',s,'][IS_COMPLETE]" id="checkListItem',s,'"',n?" checked ":"",' value="Y" />',r?"":'<span class="mobile-grid-field-tasks-checklist-item-text">'+t.text+"</span>",'<i class="mobile-grid-menu" id="checkListItem',s,'Menu"></i>','<input type="hidden" name="data[SE_CHECKLIST][',s,'][TITLE]" value="',t.text,'" />','<input type="hidden" name="data[SE_CHECKLIST][',s,'][SORT_INDEX]" value="',t.sort||++this.sort,'" />',"</span>"].join("");var c=0,l=e.proxy(function(t){if(c>100)return;c++;if(e("checkListItem"+t+"Menu")){this.bindItem(t);this.fireEvent(t,"modify",i)}else{setTimeout(function(){l(t)},100)}},this);l(s)},fireEvent:function(t,i,s){e.onCustomEvent(this,"onChange",[this,e("checkListItem"+t),i,s])},getId:function(e){return this.ids[e]||e}};return t}(),a=function(){var t=function(t,i,s){a.superclass.constructor.apply(this,arguments);this.actCallback=e.delegate(this.actCallback,this);this.queue=[]};e.extend(t,s);t.prototype.fireEvent=function(t,i,s){this.queue.push([e.proxy(function(){var a=e("checkListItem"+t);if(a&&a.form){if(i=="remove")this.remove(t,{checked:a.checked,isSeparator:a.getAttribute("bx-separator")});else if(i=="toggle")this.toggle(t,a);else{var n={TITLE:a.form.elements["data[SE_CHECKLIST]["+t+"][TITLE]"].value,IS_COMPLETE:a.form.elements["data[SE_CHECKLIST]["+t+"][IS_COMPLETE]"].checked?"Y":"N",SORT_INDEX:a.form.elements["data[SE_CHECKLIST]["+t+"][SORT_INDEX]"].value};if(i=="modify"&&(this.getId(t)+"").indexOf("n")===0)this.create(t,n,s);else this.modify(t,n)}}},this),arguments]);this.startQueue()};t.prototype.getQuery=function(){if(!this.query){this.query=new e.Tasks.Util.Query({url:e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"checklist",id:this.taskId})})}return this.query};t.prototype.statusQueue="ready";t.prototype.startQueue=function(){if(this.statusQueue==="ready"){this.statusQueue="busy";this.checkQueue()}};t.prototype.checkQueue=function(){var t=this.queue.shift();if(t&&e.type.isFunction(t[0])){t[0].apply(this,t[1])}else{this.statusQueue="ready"}};t.prototype.actCallback=function(t){if(t&&t.length>0){for(var i=0;i<t.length;i++)t[i]=t[i]["MESSAGE"]||t[i]["CODE"];window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}this.checkQueue()};t.prototype.create=function(t,i){e.onCustomEvent("onMobileTaskViewCheckListAdd",{id:t,data:i});this.getQuery().add("task.checklist.add",{data:{TASK_ID:this.taskId,TITLE:i.TITLE,IS_COMPLETE:i.IS_COMPLETE,SORT_INDEX:i.SORT_INDEX}},{},e.proxy(function(i,s){if(i&&i.length>0){for(var a=0;a<i.length;a++)i[a]=i[a]["MESSAGE"]||i[a]["CODE"];window.app.alert({text:i.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")});e.remove(e("checkListItem"+t+"Label"))}else{BXMobileApp.Events.postToComponent("onMobileTaskViewCheckListAdd",{checklistItem:s["RESULT"]["DATA"]});this.ids[t]=s["RESULT"]["DATA"]["ID"]}this.checkQueue()},this)).execute()};t.prototype.modify=function(e,t){var i=this.getId(e);this.getQuery().add("task.checklist.update",{id:i,data:{TITLE:t.TITLE}},{},this.actCallback).execute()};t.prototype.remove=function(t,i){var s=this.getId(t);var a=i.isSeparator||"N";var n=i.checked||false;delete this.ids[t];BXMobileApp.Events.postToComponent("onMobileTaskViewCheckListRemove",{id:t,checked:n,isSeparator:a});e.onCustomEvent("onMobileTaskViewCheckListRemove",[{length:Object.keys(this.ids).length}]);this.getQuery().add("task.checklist.delete",{id:s},{},this.actCallback()).execute()};t.prototype.toggle=function(t,i){var s=this.getId(t);var a="tasks.task.checklist."+(i.checked?"complete":"renew");var n={taskId:this.taskId,checkListItemId:s};e.ajax.runAction(a,{data:n}).then(function(){this.statusQueue="ready"}.bind(this))};return t}(),n=function(){var t=function(t){this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);this.node=e("title"+t);this.container=e("title"+t+"Container");if(this.node&&this.container){e.bind(this.container.parentNode,"click",this.click)}};t.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(t){this.show();return e.PreventDefault(t)},show:function(){window.app.exec("showPostForm",{attachButton:null,attachedFiles:null,extraData:{},mentionButton:null,smileButton:null,message:{text:e.util.htmlspecialcharsback(this.node.value)},okButton:{callback:this.callback,name:e.message("interface_form_save")},cancelButton:{callback:function(){},name:e.message("interface_form_cancel")}})},callback:function(t){t.text=t.text||"";if(t.text.length>0){this.container.innerHTML=e.util.htmlspecialchars(t.text);this.node.value=t.text}e.onCustomEvent(this,"onChange",[this,this.node])}};return t}(),o=function(){var t=function(t){this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);this.drop=e.delegate(this.drop,this);this.id=t;this.node=e("parentId"+t);this.container=e("parentId"+t+"Container");if(this.node&&this.container){e.bind(e("parentId"+t+"Select"),"click",this.click);var i=e.findChild(this.container.parentNode,{tagName:"DEL"},true);if(i)e.bind(i,"click",this.drop)}};t.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(t){this.show();return e.PreventDefault(t)},show:function(){BXMobileApp.addCustomEvent(window,"onTaskWasChosenInTasksSelector",this.callback);window.BXMobileApp.PageManager.loadPageModal({url:e.message("TASK_PATH_TO_SELECTOR")+"&multiple=false&id="+this.id,bx24ModernStyle:true})},drop:function(){this.node.value=0;e.onCustomEvent(this,"onChange",[this,this.node])},callback:function(t,i){if(!i&&e.type.isArray(t)){i=t[1];t=t[0]}if(t==this.id&&i){e.removeCustomEvent(window,"onTaskWasChosenInTasksSelector",this.callback);BXMobileApp.Events.unsubscribe("onTaskWasChosenInTasksSelector");this.node.value=i["ID"];this.container.innerHTML=e.util.htmlspecialchars(i["TITLE"]);e.onCustomEvent(this,"onChange",[this,this.node])}window.app.closeModalDialog({})}};return t}(),r=function(){var t=function(t){this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);this.durationType=e("durationType"+t);this.durationTypeLabel=e("durationType"+t+"Label");e.bind(this.durationTypeLabel,"click",this.click)};t.prototype={click:function(t){this.show();return e.PreventDefault(t)},show:function(){BXMobileApp.UI.SelectPicker.show({callback:this.callback,values:[e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS"),e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")],multiselect:false,default_value:this.durationType.value=="hours"?e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS"):e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")})},callback:function(t){if(t&&t.values&&t.values.length>0){var i=t.values.pop();if(i==e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")){this.durationType.value="days";this.durationTypeLabel.innerHTML=e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")}else{this.durationType.value="hours";this.durationTypeLabel.innerHTML=e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS")}}}};return t}(),c=function(){var t=function(t,i){this.objectId=e.util.getRandomString();this.id=t;this.data=i;this.node=e("bx-task-timetracking-"+t);this.tasks={};this.timer=null;this.check=e.delegate(this.check,this);this.click=e.delegate(this.click,this);this.time={trueTime:i&&i["TIME_ELAPSED"]?parseInt(i["TIME_ELAPSED"]):0,currentTime:0};if(this.node){if(this.node.checked)this.start();e.bind(this.node,"click",this.click);if(this.time.trueTime<=0)this.time.trueTime=parseInt(this.node.value);BXMobileApp.addCustomEvent("onTaskWasPerformed",e.proxy(function(e,t,i){if(!i){i=e[2];t=e[1];e=e[0]}if(this.id==e&&this.objectId!=t){if(i["OPERATION"]=="task.dayplan.timer.start"){this.start()}else if(i["OPERATION"]=="task.dayplan.timer.stop"||i["OPERATION"]=="task.defer"){this.stop()}else if(i["OPERATION"]=="task.complete"){this.stop();this.node.disabled=true}else if(i["OPERATION"]=="task.renew"||i["OPERATION"]=="task.start"){this.node.disabled=false}}},this))}};t.prototype={click:function(t){e.eventCancelBubble(t);if(this.node.checked)this.startTimer();else this.stopTimer();return e.PreventDefault(t)},startTimer:function(t){window.app.showPopupLoader();this.getQuery().add("task.dayplan.timer.start",{taskId:this.id,stopPrevious:t||false},{},e.delegate(function(t,i){window.app.hidePopupLoader();var s=t.getByCode("OTHER_TASK_ON_TIMER");if(s){var a=s.data();window.app.confirm({title:e.message("TASKS_TT_ERROR1_TITLE"),text:e.message("TASKS_TT_ERROR1_DESC").replace("#TITLE#",a["TASK"]["TITLE"]),callback:e.proxy(function(t){return e.proxy(function(e){if(e<=1)this.startTimer(t)},this)},this)(a["TASK"]["ID"]),buttons:[e.message("TASKS_TT_CONTINUE"),e.message("TASKS_TT_CANCEL")]})}else{this.start();window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[this.id,this.objectId,i],true,true)}},this))},stopTimer:function(){window.app.showPopupLoader();this.getQuery().add("task.dayplan.timer.stop",{taskId:this.id},{},e.delegate(function(t,i){window.app.hidePopupLoader();if(t&&t.length>0){for(var s=0;s<t.length;s++)t[s]=t[s]["MESSAGE"]||t[s]["CODE"];window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else{this.stop();window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[this.id,this.objectId,i],true,true)}},this))},start:function(){this.node.checked=true;if(this.timer===null)this.timer=setInterval(this.check,1e3)},stop:function(){this.node.checked=false;this.node.value=this.time.trueTime+this.time.currentTime;clearInterval(this.timer);this.timer=null},check:function(){this.refresh(++this.time.currentTime+this.time.trueTime)},refresh:function(t){var i=e("bx-task-timetracking-"+this.id+"-value"),s=[Math.floor(t/3600),Math.floor(t/60)%60,t%60],a;for(a=0;a<s.length;a++){s[a]+="";s[a]="00".substring(0,2-s[a].length)+s[a]}i.innerHTML=s.join(":")},getQuery:function(){if(!this.query){this.query=new e.Tasks.Util.Query({url:e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"dayplan",id:this.id}),autoExec:true})}return this.query}};return t}(),l=function(){var t=function(t){this.start=e.delegate(this.start,this);this.end=e.delegate(this.end,this);this.keypress=e.delegate(this.keypress,this);this.timer=null;this.node=e("timeEstimate"+t+"Seconds");this.minsNode=e("timeEstimate"+t+"Minutes");this.hoursNode=e("timeEstimate"+t+"Hours");if(this.node&&this.minsNode&&this.hoursNode)this.init();e.bind(this.hoursNode,"focus",this.start);e.bind(this.hoursNode,"blur",this.end);e.bind(this.minsNode,"focus",this.start);e.bind(this.minsNode,"blur",this.end);e.bind(this.hoursNode,"keypress",this.keypress);e.bind(this.minsNode,"keypress",this.keypress)};t.prototype={init:function(){var e=parseInt(this.node.value);e=e>0?e:0;this.hoursNode.value=Math.floor(e/3600);this.hoursNode.className="time-estimate-length-"+this.hoursNode.value.length;this.minsNode.value=Math.floor(e/60)%60;this.minsNode.className="time-estimate-length-"+this.minsNode.value.length},start:function(t){if(this.timer!==null)clearInterval(this.timer);this.timer=setInterval(e.proxy(function(){this.onchange(t.target)},this),500)},end:function(){clearInterval(this.timer);this.timer=null},onchange:function(t){t.value=(t.value+"").replace(/\D+/gi,"");if(e(t)){t.className="time-estimate-length-"+t.value.length}var i=parseInt(this.hoursNode.value),s=parseInt(this.minsNode.value);this.node.value=(i>0?i*3600:0)+(s>0?s*60:0)},keypress:function(t){var i=false;if(!t){}else if(t.key){i=/\d/.test(t.key)}else{var s=t.keyCode||t.keyIdentifier||t.which;i=47<s&&s<58}if(i)return true;return e.PreventDefault(t)}};return t}();e.Mobile.Tasks.edit=function(t,s){this.parentConstruct(e.Mobile.Tasks.edit,t);this.guid=t.guid;e.merge(this,{sys:{classCode:"edit"},vars:{id:i()},task:t.taskData});e.merge(t,{usePull:false,setTitle:true,setPullDown:false});this.handleInitStack(s,e.Mobile.Tasks.edit,t)};e.extend(e.Mobile.Tasks.edit,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.edit.prototype,{init:function(){var t=e.delegate(function(e,t,i){if(e==this.option("formId")&&i){if(i["restrictedMode"]===true||i["restrictedMode"]=="Y"){this.initRestricted(i)}else{this.initFull(i)}this.bindEvents(i)}},this);this.formInterface=e.Mobile.Grid.Form.getByFormId(this.option("formId"));e.addCustomEvent("onInitialized",t);t(this.option("formId"),"doesNotMatter",this.formInterface)},initRestricted:function(t){this.restricted=true;new a(this.task["ID"],this.task["CHECKLIST"]);new c(this.task["ID"],this.task);var i=t.elements.length;t.elements.push(new n(this.task["ID"]));t.elements.push(new r(this.task["ID"]));var s=function(){t.apply.apply(arguments)};for(var o=i;o<t.elements.length;o++){e.addCustomEvent(t.elements[o],"onChange",s)}},initFull:function(e){e.elements.push(new s(this.task["ID"],this.task["CHECKLIST"]));e.elements.push(new o(this.task["ID"]));e.elements.push(new r(this.task["ID"]));e.elements.push(new l(this.task["ID"]))},bindEvents:function(t){e.addCustomEvent(t,"onChange",e.proxy(this.onChange,this));e.addCustomEvent(t,"onCancel",function(){window.app.closeModalDialog({})});BXMobileApp.addCustomEvent(t,"onSubmitForm",e.proxy(this.onSubmitForm,this));BXMobileApp.addCustomEvent("tasks.view.native::onItemAction",e.delegate(function(e){if(Number(e.taskId)!==Number(this.task["ID"])||e.taskGuid!==this.guid){return}var t={};switch(e.name){default:break;case"auditor":case"accomplice":t=e.values.user;t={ID:t.id,NAME:t.name||t.title,IMAGE:t.icon||t.imageUrl||false};this.getFormElement(e.name).callback({a_users:[t]});break}},this))},onChange:function(t,i){if(i.name){if(!this.changes){this.changes={}}var s=/^data\[([a-z|_]*)\]/i;var a=i.name;var n=s.exec(a);if(n&&n.length==2){this.changes[n[1]]=true}else{var s=/.*\[\]/i;var n=s.exec(i.name);if(n&&n.length==1){this.changes[i.value]=true}}}var o=e(this.option("formId")),r=o.elements["data[MARK]"];if(e(i)&&i==r){var c=e.findParent(i,{className:"bx-tasks-task-mark"},o);if(i.value=="P"){e.removeClass(c,"bx-tasks-task-mark-N");if(!e.hasClass(c,"bx-tasks-task-mark-P"))e.addClass(c,"bx-tasks-task-mark-P")}else if(i.value=="N"){e.removeClass(c,"bx-tasks-task-mark-P");if(!e.hasClass(c,"bx-tasks-task-mark-N"))e.addClass(c,"bx-tasks-task-mark-N")}else{e.removeClass(c,"bx-tasks-task-mark-P");e.removeClass(c,"bx-tasks-task-mark-N")}}if(i.name=="data[PRIORITY]"){i.nextSibling.innerHTML=e.message("TASKS_PRIORITY_"+(i.checked?"2":"0"));this.savePriority(this.task["ID"],i.checked?"2":"0")}else if(i.name=="data[ADD_TO_FAVORITE]"){i.nextSibling.innerHTML=i.checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0")}},onSubmitForm:function(t,i,s,a){a.submit=false;if(!this.restricted){BXMobileApp.UI.Page.LoadingScreen.show()}e.Mobile.Tasks.CheckListInstance.getTreeStructure().appendRequestLayout();var n=e.ajax.prepareForm(i).data,o=n.data,r=this.task["ID"],c=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"update",id:r}),l,h,u;if(o["SE_AUDITOR"]){u=o["SE_AUDITOR"];o["SE_AUDITOR"]=[];while((l=u.pop())&&l)o["SE_AUDITOR"].push({ID:l})}if(o["SE_ACCOMPLICE"]){u=o["SE_ACCOMPLICE"];o["SE_ACCOMPLICE"]=[];while((l=u.pop())&&l)o["SE_ACCOMPLICE"].push({ID:l})}if(o["DEADLINE"]==="0"){o["DEADLINE"]=""}if(i.elements["ADDITIONAL[]"]){for(l=0;l<i.elements["ADDITIONAL[]"].length;l++){h=i.elements["ADDITIONAL[]"][l];o[h.value]=h.checked?"Y":"N"}}if(this.restricted){delete o["SE_CHECKLIST"]}var d={id:r,userid:e.message("USER_ID"),taskid:r,data:o,parameters:{RETURN_ENTITY:true}};new e.Tasks.Util.Query({url:c}).add(r>0?"task.update":"task.add",d,{},{onExecuted:e.proxy(function(t){if(t&&t.response&&t.response.status=="failed"){window.app.BasicAuth({success:e.proxy(function(){new e.Tasks.Util.Query({url:c}).add("task.update",d,{},{onExecuted:this.actExecute}).execute()},this),failure:function(){window.app.alert({text:e.message("MB_TASKS_TASK_ERROR3"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}})}else{try{if(!t instanceof e.Tasks.Util.Query.ErrorCollection||t.length==0){var i=this.option("formId");if(this.task["ID"]=="0"){i="MOBILE_TASK_CREATE"}fabric.Answers.sendCustomEvent("TASK/"+i,{});if(this.changes){Object.keys(this.changes).forEach(function(e){fabric.Answers.sendCustomEvent("TASK/"+this.option("formId")+"/"+e,{})}.bind(this))}}}catch(e){}var s=arguments;setTimeout(function(){this.actExecute.apply(this,s)}.bind(this),500)}},this)}).execute()},getFormElement:function(e){switch(e){default:break;case"auditor":case"accomplice":var t={auditor:"data[SE_AUDITOR][]",accomplice:"data[SE_ACCOMPLICE][]"};for(var i=0;i<this.formInterface.elements.length;i++){if(this.formInterface.elements[i].select&&this.formInterface.elements[i].select.name===t[e]){return this.formInterface.elements[i]}}break}return null},savePriority:function(t,i){console.log("savePriority",t,i);e.ajax.runAction("tasks.task.update",{data:{taskId:t,fields:{PRIORITY:i}}}).then(function(e){console.log(e)},function(e){console.log(e)})},actExecute:function(t,i){BXMobileApp.UI.Page.LoadingScreen.hide();if(t.checkHasErrors()){var s=[];for(var a=0;a<t.length;a++){s.push(t[a]["MESSAGE"])}window.app.alert({text:s.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else{window.BXMobileApp.onCustomEvent(this.task["ID"]>0?"onTaskWasUpdated":"onTaskWasCreated",[this.task["ID"],this.variable("id"),i["RESULT"]["DATA"],i,this.restricted],true,true);if(!this.restricted){window.app.closeModalDialog({})}}},elements:[],getMenu:function(){return[]}})})();
//# sourceMappingURL=script.map.js