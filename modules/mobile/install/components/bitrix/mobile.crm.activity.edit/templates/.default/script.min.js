if(typeof BX.CrmCallEditor==="undefined"){BX.CrmCallEditor=function(){this._id="";this._settings={};this._prefix="";this._dispatcher=null;this._enityId=0;this._contextId="";this._ownerId="";this._ownerType="";this._ownerIdElem=this._ownerTypeElem=this._ownerTitleElem=this._responsibleIdElem=this._responsibleNameElem=this._startTime=this._startTimeText=this._communicationWrapper=this._addCommunicationButton=this._enableNotificationElem=this._notifyValueElem=null;this._isInCommunicationChangeMode=this._isInDealChangeMode=this._isInResponsibleChangeMode=this._canChangeOwner=false;this._communicationChangeCompleteHandler=BX.delegate(this._onExternalCommunicationChange,this);this._dealChangeCompleteHandler=BX.delegate(this._onExternalDealChange,this);this._communication=null;this._syncData={};this._deletionHandler=BX.delegate(this._onDeleteButtonClick,this);this._onDealSelectEventName=""};BX.CrmCallEditor.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._enityId=parseInt(this.getSetting("entityId",0));this._contextId=this.getSetting("contextId");this._ownerId=this.getSetting("ownerId");this._ownerType=this.getSetting("ownerType");this._canChangeOwner=this.getSetting("canChangeOwner",false);this._onDealSelectEventName=this.getSetting("onDealSelectEventName");this._startTime=this.resolveElement("start_time");if(this._startTime){BX.bind(BX.findParent(this._startTime,{className:"crm_block_container"}),"click",BX.delegate(this._onStartTimeClick,this))}this._startTimeText=this.resolveElement("start_time_text");this._communicationWrapper=this.resolveElement("communication");this._addCommunicationButton=this.resolveElement("add_communication");if(this._addCommunicationButton){BX.bind(this._addCommunicationButton,"click",BX.delegate(this._onAddCommunicationButtonClick,this))}var i=this._dispatcher.getModelById(this._enityId);if(i){var n=i.getDataParam("COMMUNICATIONS",[]);if(n.length>0){this._setupCommunicationData(n[0],{container:BX.findChild(this._communicationWrapper,{className:"task-form-participant-block"},true,false)})}}this._ownerTypeElem=this.resolveElement("owner_type");this._ownerIdElem=this.resolveElement("owner_id");if(this._ownerIdElem&&this._canChangeOwner){BX.bind(BX.findParent(this._ownerIdElem,{className:"crm_block_container"}),"click",BX.delegate(this._onOwnerClick,this))}this._ownerTitleElem=this.resolveElement("owner_title");this._responsibleIdElem=this.resolveElement("responsible_id");if(this._responsibleIdElem){BX.bind(BX.findParent(this._responsibleIdElem,{className:"crm_block_container"}),"click",BX.delegate(this._onResponsibleClick,this))}this._responsibleNameElem=this.resolveElement("responsible_name");this._enableNotificationElem=this.resolveElement("enable_notification");this._notifyValueElem=this.resolveElement("notify_value");BX.addCustomEvent(window,"onOpenPageAfter",BX.delegate(this._onAfterPageOpen,this))},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},prepareElementId:function(e){e=e.toLowerCase();return this._prefix!==""?this._prefix+"_"+e:e},resolveElement:function(e){return BX(this.prepareElementId(e))},getFieldValue:function(e){var t=this.resolveElement(e);return t?t.value:""},getEntityId:function(){return this._enityId},getContextId:function(){return this._contextId},getCommunicationType:function(){return"PHONE"},getOwnerId:function(){return this._ownerId},getOwnerType:function(){return this._ownerType},canChangeOwner:function(){return this._canChangeOwner},getMessage:function(e){var t=BX.CrmCallEditor.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},processCommunicationDeletion:function(e){if(this._communication!=e){return}e.cleanLayout();this._communication=null},createSaveHandler:function(){return BX.delegate(this._onSave,this)},_onSave:function(){if(!this._dispatcher){return}var e=this.getEntityId();var t=parseInt(this._ownerId);var i=this._ownerType;if(this.canChangeOwner()){t=parseInt(this.getFieldValue("OWNER_ID"));i=this.getFieldValue("OWNER_TYPE")}var n={ID:e,TYPE_ID:2,OWNER_ID:t,OWNER_TYPE:i,RESPONSIBLE_ID:this.getFieldValue("RESPONSIBLE_ID"),START:this.getFieldValue("START_TIME"),SUBJECT:this.getFieldValue("SUBJECT"),DESCRIPTION:this.getFieldValue("DESCRIPTION")};if(this._enableNotificationElem&&this._enableNotificationElem.checked){n["NOTIFY"]={TYPE:this.getFieldValue("NOTIFY_TYPE"),VALUE:this.getFieldValue("NOTIFY_VALUE")}}n["COMMUNICATIONS"]=[];if(this._communication){var a=this._communication.getData();n["COMMUNICATIONS"].push(a);if(n["OWNER_ID"]<=0||n["OWNER_TYPE"]===""){n["OWNER_ID"]=parseInt(a["ENTITY_ID"]);n["OWNER_TYPE"]=a["ENTITY_TYPE"]}}if(e<=0){this._dispatcher.createEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}},_setupCommunicationData:function(e,t){if(this._communication){this._communication.cleanLayout();this._communication=null}var i={editor:this,parentContainer:this._communicationWrapper,data:e};if(!t){t={}}if(typeof t["container"]!=="undefined"){i["container"]=t["container"]}this._communication=BX.CrmActivityCommunication.create(i);if(!this._communication.hasLayout()){var n=this._addCommunicationButton.parentNode;this._communicationWrapper.removeChild(n);this._communication.layout();this._communicationWrapper.appendChild(n)}},_synchronize:function(){if(!this._syncData){return}var e;if(typeof this._syncData["COMMUNICATION"]!=="undefined"){e=this._syncData["COMMUNICATION"];this._setupCommunicationData({TYPE:e["type"],VALUE:e["value"],TITLE:e["title"],ENTITY_ID:e["ownerId"],ENTITY_TYPE:e["ownerType"]},{});delete this._syncData["COMMUNICATION"]}else if(typeof this._syncData["DEAL"]!=="undefined"){if(this._ownerTypeElem){this._ownerTypeElem.value=BX.CrmDealModel.typeName}e=this._syncData["DEAL"];if(this._ownerIdElem){this._ownerIdElem.value=e["id"]}if(this._ownerTitleElem){this._ownerTitleElem.innerHTML=BX.util.htmlspecialchars(e["title"])}delete this._syncData["DEAL"]}},_onStartTimeClick:function(e){if(!this._startTime){return}BX.CrmMobileContext.getCurrent().showDatePicker(BX.date.getBrowserTimestamp(this._startTime.value),"datetime",BX.delegate(this._onStartTimeChahge,this))},_onStartTimeChahge:function(e){var t=Date.parse(e);if(this._startTime){this._startTime.value=BX.date.getServerTimestamp(t)}if(this._startTimeText){var i=BX.message("FORMAT_DATETIME");i=BX.date.convertBitrixFormat(BX.type.isNotEmptyString(i)?i:"DD.MM.YYYY HH:MI:SS");this._startTimeText.innerHTML=BX.CrmActivityEditorHelper.trimDateTimeString(BX.date.format(i,new Date(t)))}},_onAddCommunicationButtonClick:function(e){var t=this.getSetting("communicationSelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t,cache:false,data:{contextId:this.getContextId(),communicationType:this.getCommunicationType(),ownerId:this.getOwnerId(),ownerType:this.getOwnerType()}});this._enableCommunicationChangeMode(true)}return BX.PreventDefault(e)},_enableCommunicationChangeMode:function(e){e=!!e;if(this._isInCommunicationChangeMode===e){return}this._isInCommunicationChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}},_onExternalCommunicationChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this._contextId){return}this._syncData["COMMUNICATION"]={ownerId:typeof e["ownerId"]?e["ownerId"]:0,ownerType:typeof e["ownerType"]?e["ownerType"]:"",type:typeof e["type"]?e["type"]:"",value:typeof e["value"]?e["value"]:"",title:typeof e["title"]?e["title"]:""};this._enableCommunicationChangeMode(false)},_onOwnerClick:function(e){var t=this.getSetting("dealSelectorUrl","");if(t!==""){BX.Mobile.Crm.loadPageModal(t);this._enableDealChangeMode(true)}return BX.PreventDefault(e)},_enableDealChangeMode:function(e){e=!!e;if(this._isInDealChangeMode===e){return}this._isInDealChangeMode=e;if(e){BXMobileApp.addCustomEvent(this._onDealSelectEventName,this._dealChangeCompleteHandler)}else{BX.removeCustomEvent(window,this._onDealSelectEventName,this._dealChangeCompleteHandler)}},_onExternalDealChange:function(e){this._syncData["DEAL"]={id:typeof e["id"]?e["id"]:0,title:typeof e["name"]?e["name"]:""};this._enableDealChangeMode(false)},_onResponsibleClick:function(){this._isInResponsibleChangeMode=true;BX.CrmMobileContext.getCurrent().openUserSelector({callback:BX.delegate(this._onExternalUserChange,this),multiple:false,okButtonTitle:this.getMessage("userSelectorOkButton"),cancelButtonTitle:this.getMessage("userSelectorCancelButton")})},_onExternalUserChange:function(e){this._isInResponsibleChangeMode=false;var t=0;var i="";if(e&&e["a_users"]){var n=e["a_users"];for(var a in n){if(!n.hasOwnProperty(a)){continue}var s=n[a];t=parseInt(s["ID"]);i=s["NAME"];break}}if(this._responsibleIdElem){this._responsibleIdElem.value=t}if(this._responsibleNameElem){this._responsibleNameElem.innerHTML=BX.util.htmlspecialchars(i)}},_onAfterPageOpen:function(){this._synchronize()}};if(typeof BX.CrmCallEditor.messages==="undefined"){BX.CrmCallEditor.messages={}}BX.CrmCallEditor.create=function(e,t){var i=new BX.CrmCallEditor;i.initialize(e,t);return i}}if(typeof BX.CrmMeetingEditor==="undefined"){BX.CrmMeetingEditor=function(){this._id="";this._settings={};this._prefix="";this._dispatcher=null;this._enityId=0;this._contextId="";this._ownerId="";this._ownerType="";this._ownerIdElem=this._ownerTypeElem=this._ownerTitleElem=this._responsibleIdElem=this._responsibleNameElem=this._startTime=this._startTimeText=this._communicationWrapper=this._addCommunicationButton=null;this._isInCommunicationChangeMode=this._isInDealChangeMode=this._isInResponsibleChangeMode=this._canChangeOwner=false;this._communicationChangeCompleteHandler=BX.delegate(this._onExternalCommunicationChange,this);this._dealChangeCompleteHandler=BX.delegate(this._onExternalDealChange,this);this._communication=null;this._syncData={};this._deletionHandler=BX.delegate(this._onDeleteButtonClick,this);this._onDealSelectEventName=""};BX.CrmMeetingEditor.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._enityId=parseInt(this.getSetting("entityId",0));this._contextId=this.getSetting("contextId");this._ownerId=this.getSetting("ownerId");this._ownerType=this.getSetting("ownerType");this._canChangeOwner=this.getSetting("canChangeOwner",false);this._onDealSelectEventName=this.getSetting("onDealSelectEventName");this._startTime=this.resolveElement("start_time");if(this._startTime){BX.bind(BX.findParent(this._startTime,{className:"crm_block_container"}),"click",BX.delegate(this._onStartTimeClick,this))}this._startTimeText=this.resolveElement("start_time_text");this._communicationWrapper=this.resolveElement("communication");this._addCommunicationButton=this.resolveElement("add_communication");if(this._addCommunicationButton){BX.bind(this._addCommunicationButton,"click",BX.delegate(this._onAddCommunicationButtonClick,this))}var i=this._dispatcher.getModelById(this._enityId);if(i){var n=i.getDataParam("COMMUNICATIONS",[]);if(n.length>0){this._setupCommunicationData(n[0],{container:BX.findChild(this._communicationWrapper,{className:"task-form-participant-block"},true,false)})}}this._ownerTypeElem=this.resolveElement("owner_type");this._ownerIdElem=this.resolveElement("owner_id");if(this._ownerIdElem&&this._canChangeOwner){BX.bind(BX.findParent(this._ownerIdElem,{className:"crm_block_container"}),"click",BX.delegate(this._onOwnerClick,this))}this._ownerTitleElem=this.resolveElement("owner_title");this._responsibleIdElem=this.resolveElement("responsible_id");if(this._responsibleIdElem){BX.bind(BX.findParent(this._responsibleIdElem,{className:"crm_block_container"}),"click",BX.delegate(this._onResponsibleClick,this))}this._responsibleNameElem=this.resolveElement("responsible_name");BX.addCustomEvent(window,"onOpenPageAfter",BX.delegate(this._onAfterPageOpen,this))},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},prepareElementId:function(e){e=e.toLowerCase();return this._prefix!==""?this._prefix+"_"+e:e},resolveElement:function(e){return BX(this.prepareElementId(e))},getFieldValue:function(e){var t=this.resolveElement(e);return t?t.value:""},getCheckboxFieldValue:function(e){var t=this.resolveElement(e);return t?t.checked:false},getEntityId:function(){return this._enityId},getContextId:function(){return this._contextId},getCommunicationType:function(){return"PERSON"},getOwnerId:function(){return this._ownerId},getOwnerType:function(){return this._ownerType},canChangeOwner:function(){return this._canChangeOwner},getMessage:function(e){var t=BX.CrmMeetingEditor.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},processCommunicationDeletion:function(e){if(this._communication!=e){return}e.cleanLayout();this._communication=null},createSaveHandler:function(){return BX.delegate(this._onSave,this)},_onSave:function(){if(!this._dispatcher){return}var e=this.getEntityId();var t=this._ownerId;var i=this._ownerType;if(this.canChangeOwner()){t=this.getFieldValue("OWNER_ID");i=this.getFieldValue("OWNER_TYPE")}var n={ID:e,TYPE_ID:1,OWNER_ID:t,OWNER_TYPE:i,RESPONSIBLE_ID:this.getFieldValue("RESPONSIBLE_ID"),START:this.getFieldValue("START_TIME"),SUBJECT:this.getFieldValue("SUBJECT"),DESCRIPTION:this.getFieldValue("DESCRIPTION"),LOCATION:this.getFieldValue("LOCATION")};if(this.getCheckboxFieldValue("enable_notification")){n["NOTIFY"]={TYPE:this.getFieldValue("NOTIFY_TYPE"),VALUE:this.getFieldValue("NOTIFY_VALUE")}}n["COMMUNICATIONS"]=[];if(this._communication){var a=this._communication.getData();n["COMMUNICATIONS"].push(a);if(n["OWNER_ID"]<=0||n["OWNER_TYPE"]===""){n["OWNER_ID"]=parseInt(a["ENTITY_ID"]);n["OWNER_TYPE"]=a["ENTITY_TYPE"]}}if(e<=0){this._dispatcher.createEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}},_setupCommunicationData:function(e,t){if(this._communication){this._communication.cleanLayout();this._communication=null}var i={editor:this,parentContainer:this._communicationWrapper,data:e};if(!t){t={}}if(typeof t["container"]!=="undefined"){i["container"]=t["container"]}this._communication=BX.CrmActivityCommunication.create(i);if(!this._communication.hasLayout()){var n=this._addCommunicationButton.parentNode;this._communicationWrapper.removeChild(n);this._communication.layout();this._communicationWrapper.appendChild(n)}},_synchronize:function(){if(!this._syncData){return}var e;if(typeof this._syncData["COMMUNICATION"]!=="undefined"){e=this._syncData["COMMUNICATION"];this._setupCommunicationData({TYPE:e["type"],VALUE:e["value"],TITLE:e["title"],ENTITY_ID:e["ownerId"],ENTITY_TYPE:e["ownerType"]},{});delete this._syncData["COMMUNICATION"]}else if(typeof this._syncData["DEAL"]!=="undefined"){if(this._ownerTypeElem){this._ownerTypeElem.value=BX.CrmDealModel.typeName}e=this._syncData["DEAL"];if(this._ownerIdElem){this._ownerIdElem.value=e["id"]}if(this._ownerTitleElem){this._ownerTitleElem.innerHTML=BX.util.htmlspecialchars(e["title"])}delete this._syncData["DEAL"]}},_onStartTimeClick:function(e){if(!this._startTime){return}BX.CrmMobileContext.getCurrent().showDatePicker(BX.date.getBrowserTimestamp(this._startTime.value),"datetime",BX.delegate(this._onStartTimeChahge,this))},_onStartTimeChahge:function(e){var t=Date.parse(e);if(this._startTime){this._startTime.value=BX.date.getServerTimestamp(t)}if(this._startTimeText){var i=BX.message("FORMAT_DATETIME");i=BX.date.convertBitrixFormat(BX.type.isNotEmptyString(i)?i:"DD.MM.YYYY HH:MI:SS");this._startTimeText.innerHTML=BX.CrmActivityEditorHelper.trimDateTimeString(BX.date.format(i,new Date(t)))}},_onAddCommunicationButtonClick:function(e){var t=this.getSetting("communicationSelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t,cache:false,data:{contextId:this.getContextId(),communicationType:this.getCommunicationType(),ownerId:this.getOwnerId(),ownerType:this.getOwnerType()}});this._enableCommunicationChangeMode(true)}return BX.PreventDefault(e)},_enableCommunicationChangeMode:function(e){e=!!e;if(this._isInCommunicationChangeMode===e){return}this._isInCommunicationChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}},_onExternalCommunicationChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this._contextId){return}this._syncData["COMMUNICATION"]={ownerId:typeof e["ownerId"]?e["ownerId"]:0,ownerType:typeof e["ownerType"]?e["ownerType"]:"",type:typeof e["type"]?e["type"]:"",value:typeof e["value"]?e["value"]:"",title:typeof e["title"]?e["title"]:""};this._enableCommunicationChangeMode(false)},_onOwnerClick:function(e){var t=this.getSetting("dealSelectorUrl","");if(t!==""){BX.Mobile.Crm.loadPageModal(t);this._enableDealChangeMode(true)}return BX.PreventDefault(e)},_enableDealChangeMode:function(e){e=!!e;if(this._isInDealChangeMode===e){return}this._isInDealChangeMode=e;if(e){BXMobileApp.addCustomEvent(this._onDealSelectEventName,this._dealChangeCompleteHandler)}else{BX.removeCustomEvent(window,this._onDealSelectEventName,this._dealChangeCompleteHandler)}},_onExternalDealChange:function(e){this._syncData["DEAL"]={id:typeof e["id"]?e["id"]:0,title:typeof e["name"]?e["name"]:""};this._enableDealChangeMode(false)},_onResponsibleClick:function(){this._isInResponsibleChangeMode=true;BX.CrmMobileContext.getCurrent().openUserSelector({callback:BX.delegate(this._onExternalUserChange,this),multiple:false,okButtonTitle:this.getMessage("userSelectorOkButton"),cancelButtonTitle:this.getMessage("userSelectorCancelButton")})},_onExternalUserChange:function(e){this._isInResponsibleChangeMode=false;var t=0;var i="";if(e&&e["a_users"]){var n=e["a_users"];for(var a in n){if(!n.hasOwnProperty(a)){continue}var s=n[a];t=parseInt(s["ID"]);i=s["NAME"];break}}if(this._responsibleIdElem){this._responsibleIdElem.value=t}if(this._responsibleNameElem){this._responsibleNameElem.innerHTML=BX.util.htmlspecialchars(i)}},_onAfterPageOpen:function(){this._synchronize()}};if(typeof BX.CrmMeetingEditor.messages==="undefined"){BX.CrmMeetingEditor.messages={}}BX.CrmMeetingEditor.create=function(e,t){var i=new BX.CrmMeetingEditor;i.initialize(e,t);return i}}if(typeof BX.CrmEmailEditor==="undefined"){BX.CrmEmailEditor=function(){this._id="";this._settings={};this._prefix="";this._dispatcher=null;this._enityId=0;this._contextId="";this._ownerId="";this._ownerType="";this._addresserElem=this._addresserNameElem=this._addresserEmailElem=this._ownerIdElem=this._ownerTypeElem=this._ownerTitleElem=this._addCommunicationButton=null;this._communicationWrapper=this._fileWrapper=null;this._isInCommunicationChangeMode=this._isInDealChangeMode=this._canChangeOwner=this._isInAddresserChangeMode=false;this._communicationChangeCompleteHandler=BX.delegate(this._onExternalCommunicationChange,this);this._addresserChangeCompleteHandler=BX.delegate(this._onExternalUserEmailConfigChange,this);this._dealChangeCompleteHandler=BX.delegate(this._onExternalDealChange,this);this._communications=[];this._storageElements=[];this._syncData={};this._deletionHandler=BX.delegate(this._onDeleteButtonClick,this);this._initTimestamp=0;this._onDealSelectEventName=""};BX.CrmEmailEditor.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._enityId=parseInt(this.getSetting("entityId",0));this._contextId=this.getSetting("contextId");this._ownerId=this.getSetting("ownerId");this._ownerType=this.getSetting("ownerType");this._canChangeOwner=this.getSetting("canChangeOwner",false);this._onDealSelectEventName=this.getSetting("onDealSelectEventName",false);this._communicationWrapper=this.resolveElement("communication");this._addCommunicationButton=this.resolveElement("add_communication");if(this._addCommunicationButton){BX.bind(this._addCommunicationButton,"click",BX.delegate(this._onAddCommunicationButtonClick,this))}var i=this._dispatcher.getModelById(this._enityId);if(i){var n=i.getDataParam("COMMUNICATIONS",[]);var a=BX.findChild(this._communicationWrapper,{className:"task-form-participant-block"},true,false);for(var s=0;s<n.length;s++){this._addCommunication(n[s],{container:a})}}this._ownerTypeElem=this.resolveElement("owner_type");this._ownerIdElem=this.resolveElement("owner_id");if(this._ownerIdElem&&this._canChangeOwner){BX.bind(BX.findParent(this._ownerIdElem,{className:"crm_block_container"}),"click",BX.delegate(this._onOwnerClick,this))}this._ownerTitleElem=this.resolveElement("owner_title");this._addresserElem=this.resolveElement("addresser");if(this._addresserElem){BX.bind(BX.findParent(this._addresserElem,{className:"crm_block_container"}),"click",BX.delegate(this._onAddresserClick,this))}this._addresserNameElem=this.resolveElement("addresser_name");this._addresserEmailElem=this.resolveElement("addresser_email");this._fileWrapper=this.resolveElement("files");BX.addCustomEvent(window,"onOpenPageAfter",BX.delegate(this._onAfterPageOpen,this))},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},prepareElementId:function(e){e=e.toLowerCase();return this._prefix!==""?this._prefix+"_"+e:e},resolveElement:function(e){return BX(this.prepareElementId(e))},getFieldValue:function(e){var t=this.resolveElement(e);return t?t.value:""},getEntityId:function(){return this._enityId},getContextId:function(){return this._contextId},getCommunicationType:function(){return"EMAIL"},getOwnerId:function(){return this._ownerId},getOwnerType:function(){return this._ownerType},canChangeOwner:function(){return this._canChangeOwner},getMessage:function(e){var t=BX.CrmEmailEditor.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},processCommunicationDeletion:function(e){for(var t=0;t<this._communications.length;t++){if(this._communications[t]!==e){continue}e.cleanLayout();this._communications.splice(t,1)}},createSaveHandler:function(){return BX.delegate(this._onSave,this)},initializeFromExternalData:function(){var e=this;BX.CrmMobileContext.getCurrent().getPageParams({callback:function(t){if(t){var i=BX.type.isNumber(t["timestamp"])?t["timestamp"]:0;if(e._initTimestamp===i){return}e._initTimestamp=i;e._contextId=BX.type.isNotEmptyString(t["contextId"])?t["contextId"]:"";var n=BX.type.isNotEmptyString(t["ownerType"])?t["ownerType"]:"";var a=BX.type.isNumber(t["ownerId"])?t["ownerId"]:0;if(n!==""&&a>0){e._ownerType=n;e._ownerId=a;e._canChangeOwner=false}if(BX.type.isNotEmptyString(t["subject"])){var s=e.resolveElement("subject");if(s){s.value=t["subject"]}}if(BX.type.isNotEmptyString(t["description"])){var o=e.resolveElement("description");if(o){o.value=t["description"]}}var r=typeof t["communication"]!=="undefined"?t["communication"]:null;if(r){e._addCommunication(r,{})}var l=BX.type.isNumber(t["storageTypeId"])?t["storageTypeId"]:BX.CrmActivityStorageType.undefined;if(l!==BX.CrmActivityStorageType.undefined){var h=e.resolveElement("storage_type");if(h){h.value=l}if(BX.type.isArray(t["storageElements"])){var m=t["storageElements"];for(var d=0;d<m.length;d++){e._addStorageElement(m[d])}}}}}})},_onSave:function(){if(!this._dispatcher){return}var e=this.getEntityId();var t=this._ownerId;var i=this._ownerType;if(this.canChangeOwner()){t=this.getFieldValue("OWNER_ID");i=this.getFieldValue("OWNER_TYPE")}var n={ID:e,TYPE_ID:4,OWNER_ID:t,OWNER_TYPE:i,FROM:this.getFieldValue("ADDRESSER"),SUBJECT:this.getFieldValue("SUBJECT"),DESCRIPTION:this.getFieldValue("DESCRIPTION")};n["COMMUNICATIONS"]=[];for(var a=0;a<this._communications.length;a++){n["COMMUNICATIONS"].push(this._communications[a].getData())}if(n["COMMUNICATIONS"].length>0&&(n["OWNER_ID"]<=0||n["OWNER_TYPE"]==="")){var s=n["COMMUNICATIONS"][0];n["OWNER_ID"]=parseInt(s["ENTITY_ID"]);n["OWNER_TYPE"]=s["ENTITY_TYPE"]}n["STORAGE_TYPE_ID"]=this.getFieldValue("STORAGE_TYPE");n["STORAGE_ELEMENT_IDS"]=[];for(var o=0;o<this._storageElements.length;o++){var r=this._storageElements[o];var l=typeof r["id"]!=="undefined"?parseInt(r["id"]):0;if(l>0){n["STORAGE_ELEMENT_IDS"].push(l)}}if(e<=0){this._dispatcher.createEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(n,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}},_addCommunication:function(e,t){var i=BX.type.isNotEmptyString(e["VALUE"])?e["VALUE"]:"";if(i===""){return}for(var n=0;n<this._communications.length;n++){if(this._communications[n].getValue()===i){return}}var a={editor:this,parentContainer:this._communicationWrapper,data:e};if(!t){t={}}if(typeof t["container"]!=="undefined"){a["container"]=t["container"]}var s=BX.CrmActivityCommunication.create(a);this._communications.push(s);if(!s.hasLayout()){var o=this._addCommunicationButton.parentNode;this._communicationWrapper.removeChild(o);s.layout();this._communicationWrapper.appendChild(o)}},_addStorageElement:function(e){this._storageElements.push(e);this._fileWrapper.appendChild(BX.create("LI",{children:[BX.create("A",{props:{href:e["url"]},text:e["name"]})]}));var t=BX.findParent(this._fileWrapper,{tagName:"DIV",className:"crm_block_container"});if(t.style.display==="none"){t.style.display=""}},_synchronize:function(){if(!this._syncData){return}var e;if(typeof this._syncData["COMMUNICATION"]!=="undefined"){e=this._syncData["COMMUNICATION"];this._addCommunication({TYPE:e["type"],VALUE:e["value"],TITLE:e["title"],ENTITY_ID:e["ownerId"],ENTITY_TYPE:e["ownerType"]},{});delete this._syncData["COMMUNICATION"]}else if(typeof this._syncData["DEAL"]!=="undefined"){if(this._ownerTypeElem){this._ownerTypeElem.value=BX.CrmDealModel.typeName}e=this._syncData["DEAL"];if(this._ownerIdElem){this._ownerIdElem.value=e["id"]}if(this._ownerTitleElem){this._ownerTitleElem.innerHTML=BX.util.htmlspecialchars(e["title"])}delete this._syncData["DEAL"]}else if(typeof this._syncData["ADDRESSER"]!=="undefined"){e=this._syncData["ADDRESSER"];if(this._addresserElem){this._addresserElem.value=e["addresser"]}if(this._addresserNameElem){this._addresserNameElem.innerHTML=BX.util.htmlspecialchars(e["addresserName"])}if(this._addresserEmailElem){this._addresserEmailElem.innerHTML=BX.util.htmlspecialchars(e["addresserEmail"])}delete this._syncData["ADDRESSER"]}},_onAddCommunicationButtonClick:function(e){var t=this.getSetting("communicationSelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t,cache:false,data:{contextId:this.getContextId(),communicationType:this.getCommunicationType(),ownerId:this.getOwnerId(),ownerType:this.getOwnerType()}});this._enableCommunicationChangeMode(true)}return BX.PreventDefault(e)},_enableCommunicationChangeMode:function(e){e=!!e;if(this._isInCommunicationChangeMode===e){return}this._isInCommunicationChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmCommunicationSelect",this._communicationChangeCompleteHandler)}},_onExternalCommunicationChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this._contextId){return}this._syncData["COMMUNICATION"]={ownerId:typeof e["ownerId"]?e["ownerId"]:0,ownerType:typeof e["ownerType"]?e["ownerType"]:"",type:typeof e["type"]?e["type"]:"",value:typeof e["value"]?e["value"]:"",title:typeof e["title"]?e["title"]:""};this._enableCommunicationChangeMode(false)},_onOwnerClick:function(e){var t=this.getSetting("dealSelectorUrl","");if(t!==""){BX.Mobile.Crm.loadPageModal(t);this._enableDealChangeMode(true)}return BX.PreventDefault(e)},_enableDealChangeMode:function(e){e=!!e;if(this._isInDealChangeMode===e){return}this._isInDealChangeMode=e;if(e){BXMobileApp.addCustomEvent(this._onDealSelectEventName,this._dealChangeCompleteHandler)}else{BX.removeCustomEvent(window,this._onDealSelectEventName,this._dealChangeCompleteHandler)}},_onExternalDealChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";this._syncData["DEAL"]={id:typeof e["id"]?e["id"]:0,title:typeof e["name"]?e["name"]:""};this._enableDealChangeMode(false)},_onAddresserClick:function(e){var t=this.getSetting("userEmailConfiguratorUrl","");if(t!==""){this._enableAddresserChangeMode(true);BX.CrmMobileContext.getCurrent().open({url:t})}return BX.PreventDefault(e)},_enableAddresserChangeMode:function(e){e=!!e;if(this._isInAddresserChangeMode===e){return}this._isInAddresserChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmUserEmailConfigChange",this._addresserChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmUserEmailConfigChange",this._addresserChangeCompleteHandler)}},_onExternalUserEmailConfigChange:function(e){this._syncData["ADDRESSER"]={addresser:typeof e["addresser"]!=="undefined"?e["addresser"]:"",addresserName:typeof e["addresserName"]!=="undefined"?e["addresserName"]:"",addresserEmail:typeof e["addresserEmail"]!=="undefined"?e["addresserEmail"]:""};this._enableAddresserChangeMode(false)},_onAfterPageOpen:function(){this._synchronize();this.initializeFromExternalData()}};if(typeof BX.CrmEmailEditor.messages==="undefined"){BX.CrmEmailEditor.messages={}}BX.CrmEmailEditor.create=function(e,t){var i=new BX.CrmEmailEditor;i.initialize(e,t);return i}}if(typeof BX.CrmActivityEditorHelper==="undefined"){BX.CrmActivityEditorHelper=function(){};BX.CrmActivityEditorHelper.trimDateTimeString=function(e){var t=/(\d{2}):(\d{2}):(\d{2})/;var i=t.exec(e);if(!i||i.length<4){return e}var n=e.substring(0,i.index)+i[1]+":"+i[2];var a=i.index+8;if(a<e.length){n+=e.substring(a)}return n}}if(typeof BX.CrmActivityCommunication==="undefined"){BX.CrmActivityCommunication=function(){this._settings={};this._editor=this._parentContainer=this._container=this._deleteButton=null;this._deletionHandler=BX.delegate(this._onDeleteButtonClick,this);this._data={};this._hasLayout=false};BX.CrmActivityCommunication.prototype={initialize:function(e){this._settings=e?e:{};this._editor=this.getSetting("editor");if(!this._editor){throw"CrmActivityCommunication: could not find editor!"}this._parentContainer=this.getSetting("parentContainer");if(!this._parentContainer){throw"CrmActivityCommunication: could not find parent container!"}this._container=this.getSetting("container",null);if(this._container){this._deleteButton=BX.findChild(this._container,{className:"task-form-participant-btn"},true,false);if(this._deleteButton){BX.bind(this._deleteButton,"click",this._deletionHandler)}this._hasLayout=true}this._data=this.getSetting("data",{})},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getData:function(){return this._data},getValue:function(){return this._data&&typeof this._data["VALUE"]?this._data["VALUE"]:""},hasLayout:function(){return this._hasLayout},layout:function(){if(this._hasLayout){return}this._deleteButton=BX.create("DIV",{attrs:{className:"task-form-participant-btn"},children:[BX.create("I")]});BX.bind(this._deleteButton,"click",this._deletionHandler);this._container=BX.create("DIV",{attrs:{className:"task-form-participant-block"},children:[BX.create("DIV",{attrs:{className:"task-form-participant-row"},children:[BX.create("DIV",{attrs:{className:"task-form-participant-row-name"
},children:[BX.create("A",{attrs:{href:"#",className:"task-form-participant-row-link"},text:typeof this._data["TITLE"]?this._data["TITLE"]:"",events:{click:BX.eventReturnFalse}})]}),BX.create("DIV",{attrs:{className:"task-form-participant-row-post"},text:typeof this._data["VALUE"]?this._data["VALUE"]:""}),this._deleteButton]})]});this._parentContainer.appendChild(this._container);this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}BX.unbind(this._deleteButton,"click",this._deletionHandler);BX.cleanNode(this._container,true);this._hasLayout=false},_onDeleteButtonClick:function(e){this._editor.processCommunicationDeletion(this)}};BX.CrmActivityCommunication.create=function(e){var t=new BX.CrmActivityCommunication;t.initialize(e);return t}}
//# sourceMappingURL=script.map.js