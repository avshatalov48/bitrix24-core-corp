this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,a,o,s,r,l,n,c,d,u,p,g,h,f){"use strict";var m=function(){babelHelpers.createClass(e,null,[{key:"create",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new this(t)}}]);function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.controller=t.controller;this.store=t.store;this.dialog=t.dialog}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"im"}},{key:"handleUserInvite",value:function e(t,i,a){var o=this;if(!t.invited){setTimeout(function(){o.dialog.redrawHeader()},100)}}},{key:"handleMessage",value:function e(t,i,a){var o=BXMobileApp.UI.Page.TopBar.title.params.text;var s=t.message.senderId;if(t.users[s].name!==o){this.dialog.redrawHeader()}}}]);return e}();var I=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));if(babelHelpers.typeof(e.context)==="object"&&e.context){i.context=e.context}return i}babelHelpers.createClass(t,[{key:"handleImCallGetCallLimitsSuccess",value:function e(t){this.store.commit("application/set",{call:{serverEnabled:t.callServerEnabled,maxParticipants:t.maxParticipants}})}},{key:"handleImChatGetSuccess",value:function e(t){this.store.commit("application/set",{dialog:{chatId:t.id,dialogId:t.dialog_id,diskFolderId:t.disk_folder_id}});if(t.restrictions){this.store.dispatch("dialogues/update",{dialogId:t.dialog_id,fields:t.restrictions})}}},{key:"handleImChatGetError",value:function e(t){if(t.ex.error==="ACCESS_ERROR"){app.closeController()}}},{key:"handleMobileBrowserConstGetSuccess",value:function e(t){this.store.commit("application/set",{disk:{enabled:true,maxFileSize:t.phpUploadMaxFilesize}});this.context.addLocalize(t);BX.message(t);r.LocalStorage.set(this.controller.getSiteId(),0,"serverVariables",t||{})}},{key:"handleImDialogMessagesGetInitSuccess",value:function e(){this.controller.application.emit(d.EventType.dialog.sendReadMessages)}},{key:"handleImMessageAddSuccess",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter(function(e){return e.id!==i.id})}},{key:"handleImMessageAddError",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter(function(e){return e.id!==i.id})}},{key:"handleImDiskFileCommitSuccess",value:function e(t,i){this.context.messagesQueue=this.context.messagesQueue.filter(function(e){return e.id!==i.id})}}]);return t}(s.BaseRestHandler);f.Vue.component("bx-mobile-im-component-dialog",{data:function e(){return{dialogState:"loading"}},computed:babelHelpers.objectSpread({EventType:function e(){return d.EventType},localize:function e(){return Object.assign({},f.Vue.getFilteredPhrases("MOBILE_CHAT_",this.$root.$bitrixMessages),f.Vue.getFilteredPhrases("IM_UTILS_",this.$root.$bitrixMessages))},widgetClassName:function e(t){var i=["bx-mobilechat-wrapper"];if(this.showMessageDialog){i.push("bx-mobilechat-chat-start")}return i.join(" ")},quotePanelData:function e(){var t={id:0,title:"",description:"",color:""};if(!this.showMessageDialog||!this.dialog.quoteId){return t}var i=this.$store.getters["messages/getMessage"](this.dialog.chatId,this.dialog.quoteId);if(!i){return t}var a=this.$store.getters["users/get"](i.authorId);var o=this.$store.getters["files/getList"](this.dialog.chatId);var s=this.$store.getters["dialogues/getEditId"](this.dialog.dialogId);return{id:this.dialog.quoteId,title:s?this.localize.MOBILE_CHAT_EDIT_TITLE:i.params.NAME?i.params.NAME:a?a.name:"",color:a?a.color:"",description:u.Utils.text.purify(i.text,i.params,o,this.localize)}},isDialog:function e(){return u.Utils.dialog.isChatId(this.dialog.dialogId)},isGestureQuoteSupported:function e(){if(this.dialog&&this.dialog.type==="announcement"&&!this.dialog.managerList.includes(this.application.common.userId)){return false}return ChatPerformance.isGestureQuoteSupported()},isDarkBackground:function e(){return this.application.options.darkBackground},showMessageDialog:function e(){var t=this;var i=this.messageCollection&&this.messageCollection.length>0;var a=ChatPerformance.getDialogShowTimeout();if(i){if(a>0){clearTimeout(this.dialogStateTimeout);this.dialogStateTimeout=setTimeout(function(){t.dialogState="show"},a)}else{this.dialogState="show"}}else if(this.dialog&&this.dialog.init){if(a>0){clearTimeout(this.dialogStateTimeout);this.dialogStateTimeout=setTimeout(function(){t.dialogState="empty"},a)}else{this.dialogState="empty"}}else{this.dialogState="loading"}return i}},h.Vuex.mapState({application:function e(t){return t.application},dialog:function e(t){return t.dialogues.collection[t.application.dialog.dialogId]},messageCollection:function e(t){return t.messages.collection[t.application.dialog.chatId]}})),methods:{logEvent:function e(t){for(var i=arguments.length,a=new Array(i>1?i-1:0),o=1;o<i;o++){a[o-1]=arguments[o]}c.Logger.info.apply(c.Logger,[t].concat(a))},onDialogRequestHistory:function e(t){this.$root.$bitrixApplication.getDialogHistory(t.lastId)},onDialogRequestUnread:function e(t){this.$root.$bitrixApplication.getDialogUnread(t.lastId)},onDialogMessageClickByUserName:function e(t){this.$root.$bitrixApplication.replyToUser(t.user.id,t.user)},onDialogMessageClickByUploadCancel:function e(t){this.$root.$bitrixApplication.cancelUploadFile(t.file.id)},onDialogMessageClickByCommand:function e(t){if(t.type==="put"){this.$root.$bitrixApplication.insertText({text:t.value+" "})}else if(t.type==="send"){this.$root.$bitrixApplication.addMessage(t.value)}else{c.Logger.warn("Unprocessed command",t)}},onDialogMessageClickByMention:function e(t){if(t.type==="USER"){this.$root.$bitrixApplication.openProfile(t.value)}else if(t.type==="CHAT"){this.$root.$bitrixApplication.openDialog(t.value)}else if(t.type==="CALL"){this.$root.$bitrixApplication.openPhoneMenu(t.value)}},onDialogMessageMenuClick:function e(t){c.Logger.warn("Message menu:",t);this.$root.$bitrixApplication.openMessageMenu(t.message)},onDialogMessageRetryClick:function e(t){c.Logger.warn("Message retry:",t);this.$root.$bitrixApplication.retrySendMessage(t.message)},onDialogReadMessage:function e(t){this.$root.$bitrixApplication.readMessage(t.id)},onDialogReadedListClick:function e(t){this.$root.$bitrixApplication.openReadedList(t.list)},onDialogQuoteMessage:function e(t){this.$root.$bitrixApplication.quoteMessage(t.message.id)},onDialogMessageReactionSet:function e(t){this.$root.$bitrixApplication.reactMessage(t.message.id,t.reaction)},onDialogMessageReactionListOpen:function e(t){this.$root.$bitrixApplication.openMessageReactionList(t.message.id,t.values)},onDialogMessageClickByKeyboardButton:function e(t){var i=this;if(t.action==="ACTION"){var a=t.params,o=a.dialogId,s=a.messageId,r=a.botId,l=a.action,n=a.value;if(l==="SEND"){this.$root.$bitrixApplication.addMessage(n);setTimeout(function(){return i.$root.$bitrixController.application.emit(d.EventType.dialog.scrollToBottom,{duration:300,cancelIfScrollChange:false})},300)}else if(l==="PUT"){this.$root.$bitrixApplication.insertText({text:n+" "})}else if(l==="CALL"){this.$root.$bitrixApplication.openPhoneMenu(n)}else if(l==="COPY"){app.exec("copyToClipboard",{text:n});new BXMobileApp.UI.NotificationBar({message:BX.message("MOBILE_MESSAGE_MENU_COPY_SUCCESS"),color:"#af000000",textColor:"#ffffff",groupId:"clipboard",maxLines:1,align:"center",isGlobal:true,useCloseButton:true,autoHideTimeout:1500,hideOnTap:true},"copy").show()}else if(l==="DIALOG"){this.$root.$bitrixApplication.openDialog(n)}return true}if(t.action==="COMMAND"){var c=t.params,u=c.dialogId,p=c.messageId,g=c.botId,h=c.command,f=c.params;this.$root.$bitrixController.restClient.callMethod(d.RestMethod.imMessageCommand,{MESSAGE_ID:p,DIALOG_ID:u,BOT_ID:g,COMMAND:h,COMMAND_PARAMS:f});return true}return false},onDialogMessageClickByChatTeaser:function e(t){var i=this;this.$root.$bitrixController.application.joinParentChat(t.message.id,"chat"+t.message.params.CHAT_ID).then(function(e){i.$root.$bitrixApplication.openDialog(e)}).catch(function(){})},onDialogClick:function e(t){},onQuotePanelClose:function e(){this.$root.$bitrixApplication.quoteMessageClear()},onSmilesSelectSmile:function e(t){console.warn("Smile selected:",t);this.$root.$bitrixApplication.insertText({text:t.text})},onSmilesSelectSet:function e(){console.warn("Set selected");this.$root.$bitrixApplication.setTextFocus()},onHideSmiles:function e(){this.$root.$bitrixApplication.setTextFocus()}},template:'\n\t\t<div :class="widgetClassName">\n\t\t\t<div :class="[\'bx-mobilechat-box\', {\'bx-mobilechat-box-dark-background\': isDarkBackground}]">\n\t\t\t\t<template v-if="application.error.active">\n\t\t\t\t\t<bx-im-view-body-error/>\n\t\t\t\t</template>\t\t\t\n\t\t\t\t<template v-else>\n\t\t\t\t\t<div :class="[\'bx-mobilechat-body\', {\'bx-mobilechat-body-with-message\': dialogState == \'show\'}]" key="with-message">\n\t\t\t\t\t\t<template v-if="dialogState == \'loading\'">\n\t\t\t\t\t\t\t<bx-im-view-body-loading/>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<template v-else-if="dialogState == \'empty\'">\n\t\t\t\t\t\t\t<bx-im-view-body-empty/>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t<div class="bx-mobilechat-dialog">\n\t\t\t\t\t\t\t\t<bx-im-view-dialog\n\t\t\t\t\t\t\t\t\t:userId="application.common.userId" \n\t\t\t\t\t\t\t\t\t:dialogId="application.dialog.dialogId"\n\t\t\t\t\t\t\t\t\t:chatId="application.dialog.chatId"\n\t\t\t\t\t\t\t\t\t:messageLimit="application.dialog.messageLimit"\n\t\t\t\t\t\t\t\t\t:messageExtraCount="application.dialog.messageExtraCount"\n\t\t\t\t\t\t\t\t\t:enableReadMessages="application.dialog.enableReadMessages"\n\t\t\t\t\t\t\t\t\t:enableReactions="true"\n\t\t\t\t\t\t\t\t\t:enableDateActions="false"\n\t\t\t\t\t\t\t\t\t:enableCreateContent="false"\n\t\t\t\t\t\t\t\t\t:enableGestureQuote="application.options.quoteEnable"\n\t\t\t\t\t\t\t\t\t:enableGestureQuoteFromRight="application.options.quoteFromRight"\n\t\t\t\t\t\t\t\t\t:enableGestureMenu="true"\n\t\t\t\t\t\t\t\t\t:showMessageUserName="isDialog"\n\t\t\t\t\t\t\t\t\t:showMessageAvatar="isDialog"\n\t\t\t\t\t\t\t\t\t:showMessageMenu="false"\n\t\t\t\t\t\t\t\t\t:listenEventScrollToBottom="EventType.dialog.scrollToBottom"\n\t\t\t\t\t\t\t\t\t:listenEventRequestHistory="EventType.dialog.requestHistoryResult"\n\t\t\t\t\t\t\t\t\t:listenEventRequestUnread="EventType.dialog.requestUnreadResult"\n\t\t\t\t\t\t\t\t\t:listenEventSendReadMessages="EventType.dialog.sendReadMessages"\n\t\t\t\t\t\t\t\t\t@readMessage="onDialogReadMessage"\n\t\t\t\t\t\t\t\t\t@quoteMessage="onDialogQuoteMessage"\n\t\t\t\t\t\t\t\t\t@requestHistory="onDialogRequestHistory"\n\t\t\t\t\t\t\t\t\t@requestUnread="onDialogRequestUnread"\n\t\t\t\t\t\t\t\t\t@clickByCommand="onDialogMessageClickByCommand"\n\t\t\t\t\t\t\t\t\t@clickByMention="onDialogMessageClickByMention"\n\t\t\t\t\t\t\t\t\t@clickByUserName="onDialogMessageClickByUserName"\n\t\t\t\t\t\t\t\t\t@clickByMessageMenu="onDialogMessageMenuClick"\n\t\t\t\t\t\t\t\t\t@clickByMessageRetry="onDialogMessageRetryClick"\n\t\t\t\t\t\t\t\t\t@clickByUploadCancel="onDialogMessageClickByUploadCancel"\n\t\t\t\t\t\t\t\t\t@clickByReadedList="onDialogReadedListClick"\n\t\t\t\t\t\t\t\t\t@setMessageReaction="onDialogMessageReactionSet"\n\t\t\t\t\t\t\t\t\t@openMessageReactionList="onDialogMessageReactionListOpen"\n\t\t\t\t\t\t\t\t\t@clickByKeyboardButton="onDialogMessageClickByKeyboardButton"\n\t\t\t\t\t\t\t\t\t@clickByChatTeaser="onDialogMessageClickByChatTeaser"\n\t\t\t\t\t\t\t\t\t@click="onDialogClick"\n\t\t\t\t\t\t\t\t />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<template v-if="application.options.showSmiles">\n\x3c!--\t\t\t\t\t\t\t\t<bx-livechat-smiles @selectSmile="onSmilesSelectSmile" @selectSet="onSmilesSelectSet"/>\t--\x3e\n\t\t\t\t\t\t\t\t<bx-messenger-smiles @selectSmile="onSmilesSelectSmile" @selectSet="onSmilesSelectSet" @hideSmiles="onHideSmiles" />\t\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<bx-im-view-quote-panel :id="quotePanelData.id" :title="quotePanelData.title" :description="quotePanelData.description" :color="quotePanelData.color" @close="onQuotePanelClose"/>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t'});f.Vue.component("bx-im-view-body-error",{computed:babelHelpers.objectSpread({localize:function e(){return Object.freeze({MOBILE_CHAT_ERROR_TITLE:this.$root.$bitrixMessages.MOBILE_CHAT_ERROR_TITLE,MOBILE_CHAT_ERROR_DESC:this.$root.$bitrixMessages.MOBILE_CHAT_ERROR_DESC})}},h.Vuex.mapState({application:function e(t){return t.application}})),template:'\n\t\t<div class="bx-mobilechat-body" key="error-body">\n\t\t\t<div class="bx-mobilechat-warning-window">\n\t\t\t\t<div class="bx-mobilechat-warning-icon"></div>\n\t\t\t\t<template v-if="application.error.description"> \n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-sm bx-mobilechat-warning-msg" v-html="application.error.description"></div>\n\t\t\t\t</template> \n\t\t\t\t<template v-else>\n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-warning-msg">{{localize.MOBILE_CHAT_ERROR_TITLE}}</div>\n\t\t\t\t\t<div class="bx-mobilechat-help-title bx-mobilechat-help-title-sm bx-mobilechat-warning-msg">{{localize.MOBILE_CHAT_ERROR_DESC}}</div>\n\t\t\t\t</template> \n\t\t\t</div>\n\t\t</div>\n\t'});f.Vue.component("bx-im-view-body-loading",{computed:{localize:function e(){return Object.freeze({MOBILE_CHAT_LOADING:this.$root.$bitrixMessages.MOBILE_CHAT_LOADING})}},template:'\n\t\t<div class="bx-mobilechat-loading-window">\n\t\t\t<svg class="bx-mobilechat-loading-circular" viewBox="25 25 50 50">\n\t\t\t\t<circle class="bx-mobilechat-loading-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t<circle class="bx-mobilechat-loading-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t</svg>\n\t\t\t<h3 class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-loading-msg">{{localize.MOBILE_CHAT_LOADING}}</h3>\n\t\t</div>\n\t'});f.Vue.component("bx-im-view-body-empty",{computed:{localize:function e(){return Object.freeze({MOBILE_CHAT_EMPTY:this.$root.$bitrixMessages.MOBILE_CHAT_EMPTY})}},template:'\n\t\t<div class="bx-mobilechat-loading-window">\n\t\t\t<h3 class="bx-mobilechat-help-title bx-mobilechat-help-title-md bx-mobilechat-loading-msg">{{localize.MOBILE_CHAT_EMPTY}}</h3>\n\t\t</div>\n\t'});var M=function(){function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.inited=false;this.initPromise=new BX.Promise;this.params=i;this.template=null;this.rootNode=this.params.node||document.createElement("div");this.eventBus=new f.VueVendorV2;this.timer=new l.Timer;this.messagesQueue=[];this.windowFocused=true;this.initCore().then(function(){return t.initComponentParams()}).then(function(e){return t.initMobileSettings(e)}).then(function(){return t.initComponent()}).then(function(){return t.initEnvironment()}).then(function(){return t.initMobileEnvironment()}).then(function(){return t.initPullClient()}).then(function(){return t.initComplete()})}babelHelpers.createClass(e,[{key:"initCore",value:function e(){var i=this;return new Promise(function(e,a){t.Core.ready().then(function(t){i.controller=t;e()})})}},{key:"initComponentParams",value:function e(){return BX.componentParameters.init()}},{key:"initMobileSettings",value:function e(t){var i=this;console.log("1. initMobileSettings");var a=r.LocalStorage.get(this.controller.getSiteId(),0,"serverVariables",false);if(a){this.addLocalize(a)}this.storedEvents=t.STORED_EVENTS||[];return new Promise(function(e,a){ApplicationStorage.getObject("settings.chat",{quoteEnable:ChatPerformance.isGestureQuoteSupported(),quoteFromRight:false,autoplayVideo:ChatPerformance.isAutoPlayVideoSupported(),backgroundType:"LIGHT_GRAY"}).then(function(a){i.controller.getStore().commit("application/set",{dialog:{dialogId:t.DIALOG_ID},options:{quoteEnable:a.quoteEnable,quoteFromRight:a.quoteFromRight,autoplayVideo:a.autoplayVideo,darkBackground:ChatDialogBackground&&ChatDialogBackground[a.backgroundType]&&ChatDialogBackground[a.backgroundType].dark}});e()})})}},{key:"initComponent",value:function e(){var t=this;console.log("2. initComponent");this.controller.getStore().subscribe(function(e){return t.eventStoreInteraction(e)});this.controller.application.setPrepareFilesBeforeSaveFunction(this.prepareFileData.bind(this));this.controller.addRestAnswerHandler(I.create({store:this.controller.getStore(),controller:this.controller,context:this}));var i=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(i){this.controller.getStore().commit("application/set",{dialog:{chatId:i.chatId,diskFolderId:i.diskFolderId||0}})}return this.controller.createVue(this,{el:this.rootNode,template:"<bx-mobile-im-component-dialog/>"}).then(function(e){t.template=e;return new Promise(function(e,t){return e()})})}},{key:"initEnvironment",value:function e(){console.log("5. initEnvironment");this.setTextareaMessage=u.Utils.debounce(this.controller.application.setTextareaMessage,300,this.controller.application);return new Promise(function(e,t){return e()})}},{key:"initMobileEnvironment",value:function e(){var t=this;console.log("6. initMobileEnvironment");BXMobileApp.UI.Page.Scroll.setEnabled(false);BXMobileApp.UI.Page.captureKeyboardEvents(true);BX.addCustomEvent("onKeyboardWillShow",function(){t.controller.getStore().dispatch("application/set",{mobile:{keyboardShow:true}})});BX.addCustomEvent("onKeyboardDidShow",function(){console.log("did show");t.controller.application.emit("EventType.dialog.scrollToBottom",{duration:300,cancelIfScrollChange:true})});BX.addCustomEvent("onKeyboardWillHide",function(){clearInterval(t.keyboardOpeningInterval);t.controller.getStore().dispatch("application/set",{mobile:{keyboardShow:false}})});var i=function e(){BXMobileApp.UI.Page.isVisible({callback:function e(i){t.windowFocused=i.status==="visible";if(t.windowFocused){f.Vue.event.$emit("bitrixmobile:controller:focus")}else{f.Vue.event.$emit("bitrixmobile:controller:blur")}}})};BX.addCustomEvent("onAppActive",function(){i();BXMobileApp.UI.Page.isVisible({callback:function e(i){if(i.status!=="visible"){return false}t.getDialogUnread().then(function(){t.processSendMessages();t.controller.application.emit(d.EventType.dialog.sendReadMessages)}).catch(function(){t.processSendMessages()})}})});BX.addCustomEvent("onAppPaused",function(){t.windowFocused=false;f.Vue.event.$emit("bitrixmobile:controller:blur")});BX.addCustomEvent("onOpenPageAfter",i);BX.addCustomEvent("onHidePageBefore",function(){t.windowFocused=false;f.Vue.event.$emit("bitrixmobile:controller:blur")});BXMobileApp.addCustomEvent("chatbackground::task::status::success",function(e){var i=e.taskId.toString().split("|")[0];t.executeBackgroundTaskSuccess(i,e)});BXMobileApp.addCustomEvent("chatbackground::task::status::failure",function(e){var i=e.taskId.toString().split("|")[0];t.executeBackgroundTaskFailure(i,e)});BXMobileApp.addCustomEvent("chatrecent::push::get",function(e){a.PULL.emit({type:a.PullClient.SubscriptionType.Server,moduleId:t.pullMobileHandler.getModuleId(),data:{command:"messageAdd",params:babelHelpers.objectSpread({},e,{optionImportant:true})}})});BXMobileApp.UI.Page.TextPanel.setParams(this.getKeyboardParams());this.changeChatKeyboardStatus();BX.MobileUploadProvider.setListener(this.executeUploaderEvent.bind(this));this.fileUpdateProgress=u.Utils.throttle(function(e,i,a,o){t.controller.getStore().dispatch("files/update",{chatId:e,id:i,fields:{size:o,progress:a}})},500);if(!u.Utils.dialog.isChatId(this.controller.application.getDialogId())){this.userShowWorkPosition=true;setTimeout(function(){t.userShowWorkPosition=false;t.redrawHeader()},1500);setInterval(function(){t.redrawHeader()},6e4)}else{this.chatShowUserCounter=false;setTimeout(function(){t.chatShowUserCounter=true;t.redrawHeader()},1500)}this.redrawHeader();this.widgetCache=new ChatWidgetCache(this.controller.getUserId(),this.controller.getLanguageId());return new Promise(function(e,t){return e()})}},{key:"initPullClient",value:function e(){var t=this;console.log("7. initPullClient");if(this.storedEvents&&this.storedEvents.length>0){setTimeout(function(){t.storedEvents=t.storedEvents.filter(function(e){BX.onCustomEvent("chatrecent::push::get",[e]);return false})},50)}a.PULL.subscribe(this.pullMobileHandler=new m({store:this.controller.getStore(),controller:this.controller,dialog:this}));a.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"im",command:"chatUserLeave",callback:function e(i){if(i.userId===t.controller.application.getUserId()&&i.dialogId===t.controller.application.getDialogId()){app.closeController()}}});a.PULL.subscribe({type:a.PullClient.SubscriptionType.Status,callback:this.eventStatusInteraction.bind(this)});if(!u.Utils.dialog.isChatId(this.controller.application.getDialogId())){a.PULL.subscribe({type:a.PullClient.SubscriptionType.Online,callback:this.eventOnlineInteraction.bind(this)})}return new Promise(function(e,t){return e()})}},{key:"initComplete",value:function e(){this.inited=true;this.initPromise.resolve(this);BXMobileApp.Events.postToComponent("chatdialog::init::complete",[{dialogId:this.controller.application.getDialogId()},true],"im.recent");return this.requestData()}},{key:"ready",value:function e(){if(this.inited){var t=new BX.Promise;t.resolve(this);return t}return this.initPromise}},{key:"requestData",value:function e(){var t=this;console.log("4. requestData");if(this.requestDataSend){return this.requestDataSend}this.timer.start("data","load",.5,function(){console.warn("ChatDialog.requestData: slow connection show progress icon");app.titleAction("setParams",{useProgress:true,useLetterImage:false})});this.requestDataSend=new Promise(function(e,i){var a;var o=(a={},babelHelpers.defineProperty(a,d.RestMethodHandler.mobileBrowserConstGet,[d.RestMethod.mobileBrowserConstGet,{}]),babelHelpers.defineProperty(a,d.RestMethodHandler.imChatGet,[d.RestMethod.imChatGet,{dialog_id:t.controller.application.getDialogId()}]),babelHelpers.defineProperty(a,d.RestMethodHandler.imDialogMessagesGetInit,[d.RestMethod.imDialogMessagesGet,{dialog_id:t.controller.application.getDialogId(),limit:t.controller.application.getRequestMessageLimit(),convert_text:"Y"}]),babelHelpers.defineProperty(a,d.RestMethodHandler.imRecentUnread,[d.RestMethod.imRecentUnread,{dialog_id:t.controller.application.getDialogId(),action:"N"}]),babelHelpers.defineProperty(a,d.RestMethodHandler.imCallGetCallLimits,[d.RestMethod.imCallGetCallLimits,{}]),a);if(u.Utils.dialog.isChatId(t.controller.application.getDialogId())){o[d.RestMethodHandler.imUserGet]=[d.RestMethod.imUserGet,{}]}else{o[d.RestMethodHandler.imUserListGet]=[d.RestMethod.imUserListGet,{id:[t.controller.application.getUserId(),t.controller.application.getDialogId()]}]}t.controller.restClient.callBatch(o,function(i){if(!i){t.requestDataSend=null;t.setError("EMPTY_RESPONSE","Server returned an empty response.");e();return false}var a=i[d.RestMethodHandler.mobileBrowserConstGet];if(a.error());else{t.controller.executeRestAnswer(d.RestMethodHandler.mobileBrowserConstGet,a)}var o=i[d.RestMethodHandler.imCallGetCallLimits];if(o&&!o.error()){t.controller.executeRestAnswer(d.RestMethodHandler.imCallGetCallLimits,o)}var s=i[d.RestMethodHandler.imUserGet];if(s&&!s.error()){t.controller.executeRestAnswer(d.RestMethodHandler.imUserGet,s)}var r=i[d.RestMethodHandler.imUserListGet];if(r&&!r.error()){t.controller.executeRestAnswer(d.RestMethodHandler.imUserListGet,r)}var l=i[d.RestMethodHandler.imChatGet];t.controller.executeRestAnswer(d.RestMethodHandler.imChatGet,l);t.redrawHeader();var n=i[d.RestMethodHandler.imDialogMessagesGetInit];if(n.error());else{app.titleAction("setParams",{useProgress:false,useLetterImage:true});t.timer.stop("data","load",true);t.controller.getStore().dispatch("dialogues/saveDialog",{dialogId:t.controller.application.getDialogId(),chatId:t.controller.application.getChatId()});if(t.controller.pullBaseHandler){t.controller.pullBaseHandler.option.skip=false}t.controller.getStore().dispatch("application/set",{dialog:{enableReadMessages:true}}).then(function(){t.controller.executeRestAnswer(d.RestMethodHandler.imDialogMessagesGetInit,n)});t.processSendMessages()}t.requestDataSend=null;e()},false,false,u.Utils.getLogTrackingParams({name:"mobile.im.dialog",dialog:t.controller.application.getDialogData()}))});return this.requestDataSend}},{key:"executeUploaderEvent",value:function e(t,i,a){if(t!==BX.MobileUploaderConst.FILE_UPLOAD_PROGRESS){console.log("ChatDialog.disk.eventRouter: ",t,a,i)}if(t===BX.MobileUploaderConst.FILE_UPLOAD_PROGRESS){if(i.percent>95){i.percent=95}this.fileUpdateProgress(i.file.params.chatId,i.file.params.file.id,i.percent,i.byteTotal)}else if(t===BX.MobileUploaderConst.FILE_CREATED){if(i.result.status==="error"){this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id);console.error("File upload error",i.result.errors[0].message)}else{this.controller.getStore().dispatch("files/update",{chatId:i.file.params.chatId,id:i.file.params.file.id,fields:{status:d.FileStatus.wait,progress:95}})}}else if(t==="onimdiskmessageaddsuccess"){console.info("ChatDialog.disk.eventRouter: DISK_MESSAGE_ADD_SUCCESS: ",i,a);var o=i.result.FILES["upload"+i.result.DISK_ID[0]];this.controller.getStore().dispatch("files/update",{chatId:i.file.params.chatId,id:i.file.params.file.id,fields:{status:d.FileStatus.upload,progress:100,id:o.id,size:o.size,urlDownload:o.urlDownload,urlPreview:o.urlPreview,urlShow:o.urlShow}})}else if(t==="onimdiskmessageaddfail"){console.error("ChatDialog.disk.eventRouter: DISK_MESSAGE_ADD_FAIL: ",i,a);this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id)}else if(t===BX.MobileUploaderConst.TASK_CANCELLED||t===BX.MobileUploaderConst.TASK_NOT_FOUND){this.cancelUploadFile(i.file.params.file.id)}else if(t===BX.MobileUploaderConst.FILE_CREATED_FAILED||t===BX.MobileUploaderConst.FILE_UPLOAD_FAILED||t===BX.MobileUploaderConst.FILE_READ_ERROR||t===BX.MobileUploaderConst.TASK_STARTED_FAILED){console.error("ChatDialog.disk.eventRouter: ",t,i,a);this.fileError(i.file.params.chatId,i.file.params.file.id,i.file.params.id)}return true}},{key:"prepareFileData",value:function e(t){var i=function e(t){if(t.urlPreview&&t.urlPreview.startsWith("file://")){t.urlPreview="bx"+t.urlPreview}if(t.urlShow&&t.urlShow.startsWith("file://")){t.urlShow="bx"+t.urlShow}if(t.type!==d.FileType.image){return t}if(t.urlPreview){if(t.urlPreview.startsWith("/")){t.urlPreview=currentDomain+t.urlPreview}t.urlPreview=t.urlPreview.replace("http://","bxhttp://").replace("https://","bxhttps://")}if(t.urlShow){if(t.urlShow.startsWith("/")){t.urlShow=currentDomain+t.urlShow}t.urlShow=t.urlShow.replace("http://","bxhttp://").replace("https://","bxhttps://")}return t};if(t instanceof Array){return t.map(function(e){return i(e)})}else{return i(t)}}},{key:"redrawHeader",value:function e(){var t=this;var i;if(u.Utils.dialog.isChatId(this.controller.application.getDialogId())){i=this.getChatHeaderParams();this.changeChatKeyboardStatus()}else{i=this.getUserHeaderParams()}if(!i){return false}this.setHeaderButtons();if(!this.headerMenuInited){BXMobileApp.UI.Page.TopBar.title.params.useLetterImage=true;BXMobileApp.UI.Page.TopBar.title.setCallback(function(){return t.openHeaderMenu()});this.headerMenuInited=true}if(i.name){BXMobileApp.UI.Page.TopBar.title.setText(i.name)}if(i.desc){BXMobileApp.UI.Page.TopBar.title.setDetailText(i.desc)}if(i.avatar){BXMobileApp.UI.Page.TopBar.title.setImage(i.avatar)}else if(i.color){BXMobileApp.UI.Page.TopBar.title.params.imageColor=i.color}return true}},{key:"getUserHeaderParams",value:function e(){var t=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId());if(!t||!t.init){return false}var i={name:null,desc:null,avatar:null,color:null};if(t.avatar){i.avatar=t.avatar}else{i.color=t.color}i.name=t.name;var a=false;if(!this.userShowWorkPosition&&t.lastActivityDate){a=u.Utils.user.getLastDateText(t,this.getLocalize())}if(a){i.desc=a}else{if(t.workPosition){i.desc=t.workPosition}else{i.desc=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_USER")}}return i}},{key:"getChatHeaderParams",value:function e(){var t=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(!t||!t.init){return false}var i={name:null,desc:null,avatar:null,color:null};if(t.avatar){i.avatar=t.avatar}else{i.color=t.color}if(t.entityType==="GENERAL"){i.avatar=encodeURI(this.controller.getHost()+"/bitrix/mobileapp/mobile/components/bitrix/im.recent/images/avatar_general_x3.png")}i.name=t.name;var a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_CHAT_NEW");if(this.chatShowUserCounter&&this.getLocalize()["MOBILE_HEADER_MENU_CHAT_USER_COUNT"]){a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_USER_COUNT").replace("#COUNT#",t.userCounter)}else if(this.getLocalize()["MOBILE_HEADER_MENU_CHAT_TYPE_"+t.type.toUpperCase()+"_NEW"]){a=this.getLocalize("MOBILE_HEADER_MENU_CHAT_TYPE_"+t.type.toUpperCase()+"_NEW")}i.desc=a;return i}},{key:"changeChatKeyboardStatus",value:function e(){var t=this.controller.getStore().getters["dialogues/get"](this.controller.application.getDialogId());if(!t||!t.init){BXMobileApp.UI.Page.TextPanel.show();return true}var i=true;if(t.type==="announcement"&&!t.managerList.includes(this.controller.application.getUserId())){i=false}if(typeof this.keyboardShowFlag!=="undefined"&&(this.keyboardShowFlag&&i||!this.keyboardShowFlag&&!i)){return this.keyboardShowFlag}if(i){BXMobileApp.UI.Page.TextPanel.show();this.keyboardShowFlag=true}else{BXMobileApp.UI.Page.TextPanel.hide();this.keyboardShowFlag=false}return this.keyboardShowFlag}},{key:"setHeaderButtons",value:function e(){var t=this;if(this.callMenuSetted){return true}if(u.Utils.dialog.isChatId(this.controller.application.getDialogId())){var i=this.controller.application.getDialogData();if(!i.init){return false}var a=Application.getApiVersion()>=36;var o=this.controller.application.getData().call.maxParticipants;if(i.userCounter>o||!a){if(i.type!==d.DialogType.call&&i.restrictions.extend){app.exec("setRightButtons",{items:[{type:"user_plus",callback:function e(){fabric.Answers.sendCustomEvent("vueChatAddUserButton",{});t.openAddUserDialog()}}]})}else{app.exec("setRightButtons",{items:[]})}this.callMenuSetted=true;return true}}else{var s=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId(),true);if(!s.init){return false}if(s.bot||s.network||this.controller.application.getUserId()===parseInt(this.controller.application.getDialogId())){app.exec("setRightButtons",{items:[]});this.callMenuSetted=true;return true}}app.exec("setRightButtons",{items:[{type:"call_audio",callback:function e(){if(u.Utils.dialog.isChatId(t.controller.application.getDialogId())){BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:false,chatData:t.controller.application.getDialogData()},"calls")}else{t.openCallMenu()}}},{type:"call_video",badgeCode:"call_video",callback:function e(){fabric.Answers.sendCustomEvent("vueChatCallVideoButton",{});if(u.Utils.dialog.isChatId(t.controller.application.getDialogId())){console.warn({dialogId:t.controller.application.getDialogId(),video:true,chatData:t.controller.application.getDialogData()});BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:true,chatData:t.controller.application.getDialogData()},"calls")}else{BXMobileApp.Events.postToComponent("onCallInvite",{dialogId:t.controller.application.getDialogId(),video:true,userData:babelHelpers.defineProperty({},t.controller.application.getDialogId(),t.controller.getStore().getters["users/get"](t.controller.application.getDialogId(),true))},"calls")}}}]});this.callMenuSetted=true;return true}},{key:"openUserList",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.users,a=i===void 0?false:i,o=t.title,s=o===void 0?"":o,r=t.listType,l=r===void 0?"LIST":r,n=t.backdrop,c=n===void 0?true:n;var d={title:s,objectName:"ChatUserListInterface"};if(c){d.backdrop={}}app.exec("openComponent",{name:"JSStackComponent",componentCode:"im.dialog.list",scriptPath:"/mobileapp/jn/im.chat.user.list/?version="+BX.componentParameters.get("WIDGET_CHAT_USERS_VERSION","1.0.0"),params:{DIALOG_ID:this.controller.application.getDialogId(),DIALOG_OWNER_ID:this.controller.application.getDialogData().ownerId,USER_ID:this.controller.application.getUserId(),LIST_TYPE:l,USERS:a,IS_BACKDROP:true},rootWidget:{name:"list",settings:d}},false)}},{key:"openCallMenu",value:function e(){var t=this;fabric.Answers.sendCustomEvent("vueChatCallAudioButton",{});var i=this.controller.getStore().getters["users/get"](this.controller.application.getDialogId(),true);if(i.phones.personalMobile||i.phones.workPhone||i.phones.personalPhone||i.phones.innerPhone){BackdropMenu.create("im.dialog.menu.call|"+this.controller.application.getDialogId()).setItems([BackdropMenuItem.create("audio").setTitle(this.getLocalize("MOBILE_HEADER_MENU_AUDIO_CALL")),BackdropMenuItem.create("personalMobile").setTitle(i.phones.personalMobile).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_MOBILE")).skip(!i.phones.personalMobile),BackdropMenuItem.create("workPhone").setTitle(i.phones.workPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_WORK")).skip(!i.phones.workPhone),BackdropMenuItem.create("personalPhone").setTitle(i.phones.personalPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_PHONE")).skip(!i.phones.personalPhone),BackdropMenuItem.create("innerPhone").setTitle(i.phones.innerPhone).setSubTitle(this.getLocalize("MOBILE_MENU_CALL_PHONE")).skip(!i.phones.innerPhone)]).setVersion(BX.componentParameters.get("WIDGET_BACKDROP_MENU_VERSION","1.0.0")).setEventListener(function(e,i,a,o){if(e!=="selected"){return false}if(i.id==="audio"){BXMobileApp.Events.postToComponent("onCallInvite",{userId:t.controller.application.getDialogId(),video:false,userData:babelHelpers.defineProperty({},a.id,a)},"calls")}else if(i.id==="innerPhone"){BX.MobileTools.phoneTo(a.phones[i.id],{callMethod:"telephony"})}else{BX.MobileTools.phoneTo(a.phones[i.id],{callMethod:"device"})}}).setCustomParams(i).show()}else{BXMobileApp.Events.postToComponent("onCallInvite",{userId:this.controller.application.getDialogId(),video:false,userData:babelHelpers.defineProperty({},this.controller.application.getDialogId(),i)},"calls")}}},{key:"leaveChat",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!i){app.confirm({title:this.getLocalize("MOBILE_HEADER_MENU_LEAVE_CONFIRM"),text:"",buttons:[this.getLocalize("MOBILE_HEADER_MENU_LEAVE_YES"),this.getLocalize("MOBILE_HEADER_MENU_LEAVE_NO")],callback:function e(i){if(i===1){t.leaveChat(true)}}});return true}var a=this.controller.application.getDialogId();this.controller.restClient.callMethod(d.RestMethod.imChatLeave,{DIALOG_ID:a},null,null,u.Utils.getLogTrackingParams({name:d.RestMethod.imChatLeave,dialog:this.controller.application.getDialogData(a)})).then(function(e){app.closeController()})}},{key:"openAddUserDialog",value:function e(){var t=this.getItemsForAddUserDialog();app.exec("openComponent",{name:"JSStackComponent",componentCode:"im.chat.user.selector",scriptPath:"/mobileapp/jn/im.chat.user.selector/?version="+BX.componentParameters.get("WIDGET_CHAT_RECIPIENTS_VERSION","1.0.0"),params:{DIALOG_ID:this.controller.application.getDialogId(),USER_ID:this.controller.application.getUserId(),LIST_USERS:t,LIST_DEPARTMENTS:[],SKIP_LIST:[],SEARCH_MIN_SIZE:BX.componentParameters.get("SEARCH_MIN_TOKEN_SIZE",3)},rootWidget:{name:"chat.recipients",settings:{objectName:"ChatUserSelectorInterface",title:BX.message("MOBILE_HEADER_MENU_USER_ADD"),limit:100,items:t.map(function(e){return ChatDataConverter.getListElementByUser(e)}),scopes:[{title:BX.message("MOBILE_SCOPE_USERS"),id:"user"},{title:BX.message("MOBILE_SCOPE_DEPARTMENTS"),id:"department"}],backdrop:{showOnTop:true}}}},false)}},{key:"getItemsForAddUserDialog",value:function e(){var t=[];var i={};if(this.widgetCache.recentList.length>0){this.widgetCache.recentList.map(function(e){if(!e||i[e.id]){return false}if(e.type==="user"){t.push(e.user);i[e.id]=true}return true})}this.widgetCache.colleaguesList.map(function(e){if(!e||i[e.id]){return false}t.push(e);i[e.id]=true});this.widgetCache.lastSearchList.map(function(e){if(!e||i[e.id]){return false}if(!e){return false}if(e.type==="user"){t.push(e.user);i[e.id]=true}return true});return t}},{key:"eventStoreInteraction",value:function e(t){if(t.type==="dialogues/update"&&t.payload&&t.payload.fields){if(typeof t.payload.fields.name!=="undefined"||typeof t.payload.fields.userCounter!=="undefined"){if(typeof t.payload.fields.userCounter!=="undefined"){this.callMenuSetted=false}this.redrawHeader()}if(typeof t.payload.fields.counter!=="undefined"&&typeof t.payload.dialogId!=="undefined"){BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:t.payload.dialogId,counter:t.payload.fields.counter},true],"im.recent")}}else if(t.type==="dialogues/set"){t.payload.forEach(function(e){BXMobileApp.Events.postToComponent("chatdialog::counter::change",[{dialogId:e.dialogId,counter:e.counter},true],"im.recent")})}}},{key:"eventStatusInteraction",value:function e(t){var i=this;if(t.status===a.PullClient.PullStatus.Online){if(this.pullRequestMessage){this.controller.pullBaseHandler.option.skip=true;this.getDialogUnread().then(function(){i.controller.pullBaseHandler.option.skip=false;i.processSendMessages();i.controller.application.emit(d.EventType.dialog.sendReadMessages)}).catch(function(){i.controller.pullBaseHandler.option.skip=false;i.processSendMessages()});this.pullRequestMessage=false}else{this.readMessage();this.processSendMessages()}}else if(t.status===a.PullClient.PullStatus.Offline){this.pullRequestMessage=true}}},{key:"eventOnlineInteraction",value:function e(t){if(t.command==="list"||t.command==="userStatus"){for(var i in t.params.users){if(!t.params.users.hasOwnProperty(i)){continue}this.controller.getStore().dispatch("users/update",{id:t.params.users[i].id,fields:t.params.users[i]});if(i.toString()===this.controller.application.getDialogId()){this.redrawHeader()}}}}},{key:"getKeyboardParams",value:function e(){var t=this;var i=this.controller.application.getDialogData();var a=this.getLocalize("SITE_DIR");return{text:i?i.textareaMessage:"",placeholder:this.getLocalize("MOBILE_CHAT_PANEL_PLACEHOLDER"),smileButton:{},useImageButton:true,useAudioMessages:true,mentionDataSource:{outsection:"NO",url:a+"mobile/index.php?mobile_action=get_user_list&use_name_format=Y&with_bots"},attachFileSettings:{previewMaxWidth:640,previewMaxHeight:640,resize:{targetWidth:-1,targetHeight:-1,sourceType:1,encodingType:0,mediaType:2,allowsEdit:false,saveToPhotoAlbum:true,popoverOptions:false,cameraDirection:0},sendFileSeparately:true,showAttachedFiles:true,editingMediaFiles:false,maxAttachedFilesCount:100},attachButton:{items:[{id:"disk",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_DISK"),dataSource:{multiple:false,url:a+"mobile/?mobile_action=disk_folder_list&type=user&path=%2F&entityId="+this.controller.application.getUserId(),TABLE_SETTINGS:{searchField:true,showtitle:true,modal:true,name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_DISK_FILES")}}},{id:"mediateka",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_GALLERY")},{id:"camera",name:this.getLocalize("MOBILE_CHAT_PANEL_UPLOAD_CAMERA")}]},action:function e(i){if(typeof i==="string"){i={text:i,attachedFiles:[]}}var a=i.text.toString().trim();var s=i.attachedFiles instanceof Array?i.attachedFiles:[];if(s.length<=0){t.clearText();t.hideSmiles();var r=t.controller.getStore().getters["dialogues/getEditId"](t.controller.application.getDialogId());if(r){t.updateMessage(r,a)}else{t.addMessage(a)}}else{s.forEach(function(e){if(typeof e.dataAttributes!=="undefined"){fabric.Answers.sendCustomEvent("vueChatFileDisk",{});return t.uploadFile({source:"disk",name:e.name,type:e.type.toString().toLowerCase(),preview:!e.dataAttributes.URL||!e.dataAttributes.URL.PREVIEW?null:{url:e.dataAttributes.URL.PREVIEW,width:e.dataAttributes.URL.PREVIEW.match(/(width=(\d+))/i)[2],height:e.dataAttributes.URL.PREVIEW.match(/(height=(\d+))/i)[2]},uploadLink:parseInt(e.dataAttributes.ID)})}if(e.type==="audio/mp4"){fabric.Answers.sendCustomEvent("vueChatFileAudio",{});return t.uploadFile({source:"audio",name:"mobile_audio_"+(new Date).toJSON().slice(0,19).replace("T","_").split(":").join("-")+".mp3",type:"mp3",preview:null,uploadLink:e.url})}var i=e.name;var a=o.FilesModel.getType(e.name);if(a===d.FileType.video){fabric.Answers.sendCustomEvent("vueChatFileVideo",{})}else if(a===d.FileType.image){fabric.Answers.sendCustomEvent("vueChatFileImage",{})}else{fabric.Answers.sendCustomEvent("vueChatFileOther",{})}if(a===d.FileType.image||a===d.FileType.video){var s=e.name.split(".").slice(-1)[0].toLowerCase();if(e.type==="image/heic"){s="jpg"}i="mobile_file_"+(new Date).toJSON().slice(0,19).replace("T","_").split(":").join("-")+"."+s}return t.uploadFile({source:"gallery",name:i,type:e.type.toString().toLowerCase(),preview:!e.previewUrl?null:{url:e.previewUrl,width:e.previewWidth,height:e.previewHeight},uploadLink:e.url})})}},callback:function e(i){console.log("Textpanel callback",i);if(!i.event){return false}if(i.event==="onKeyPress"){var a=i.text.toString();if(a.trim().length>2){t.controller.application.startWriting()}if(a.length===0){t.setTextareaMessage({message:""});t.controller.application.stopWriting()}else{t.setTextareaMessage({message:a})}}else if(i.event==="onSmileSelect"){t.controller.showSmiles()}else if(Application.getPlatform()!=="android"){if(i.event==="getFocus"){if(u.Utils.platform.isIos()&&u.Utils.platform.getIosVersion()>12){t.controller.application.emit(d.EventType.dialog.scrollToBottom,{duration:300,cancelIfScrollChange:true})}}else if(i.event==="removeFocus");}}}}},{key:"addMessage",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!t&&!a){return false}var o=this.controller.getStore().getters["dialogues/getQuoteId"](this.controller.application.getDialogId());if(o){var s=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),o);if(s){var r=null;if(s.authorId){r=this.controller.getStore().getters["users/get"](s.authorId)}var l=this.controller.getStore().getters["files/getList"](this.controller.application.getChatId());var n=[];n.push("-".repeat(54));n.push((r&&r.name?r.name:this.getLocalize("MOBILE_CHAT_SYSTEM_MESSAGE"))+" ["+u.Utils.date.format(s.date,null,this.getLocalize())+"]");n.push(u.Utils.text.quote(s.text,s.params,l,this.getLocalize()));n.push("-".repeat(54));n.push(t);t=n.join("\n");this.quoteMessageClear()}}console.warn("addMessage",t,a);if(!this.controller.application.isUnreadMessagesLoaded()){this.sendMessage({id:0,chatId:this.controller.application.getChatId(),dialogId:this.controller.application.getDialogId(),text:t,file:a});this.processSendMessages();return true}this.controller.getStore().commit("application/increaseDialogExtraCount");var c={};if(a){c.FILE_ID=[a.id]}this.controller.getStore().dispatch("messages/add",{chatId:this.controller.application.getChatId(),authorId:this.controller.application.getUserId(),text:t,params:c,sending:!a}).then(function(e){i.messagesQueue.push({id:e,chatId:i.controller.application.getChatId(),dialogId:i.controller.application.getDialogId(),text:t,file:a,sending:false});if(i.controller.application.getChatId()){i.processSendMessages()}else{i.requestData()}});return true}},{key:"uploadFile",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(!t){return false}console.warn("addFile",t,a);if(!this.controller.application.isUnreadMessagesLoaded()){this.addMessage(a,{id:0,source:t});return true}this.controller.getStore().dispatch("files/add",this.controller.application.prepareFilesBeforeSave({chatId:this.controller.application.getChatId(),authorId:this.controller.application.getUserId(),name:t.name,type:o.FilesModel.getType(t.name),extension:t.name.split(".").splice(-1)[0],size:0,image:!t.preview?false:{width:t.preview.width,height:t.preview.height},status:t.source==="disk"?d.FileStatus.wait:d.FileStatus.upload,progress:0,authorName:this.controller.application.getCurrentUser().name,urlPreview:!t.preview?"":t.preview.url})).then(function(e){return i.addMessage(a,babelHelpers.objectSpread({id:e},t))});return true}},{key:"cancelUploadFile",value:function e(t){var i=this;var a=this.messagesQueue.find(function(e){return e.file&&e.file.id===t});if(a){BX.MobileUploadProvider.cancelTasks(["imDialog"+t]);this.controller.getStore().dispatch("messages/delete",{chatId:a.chatId,id:a.id}).then(function(){i.controller.getStore().dispatch("files/delete",{chatId:a.chatId,id:a.file.id});i.messagesQueue=i.messagesQueue.filter(function(e){return e.id!==a.id})})}}},{key:"retryUploadFile",value:function e(t){var i=this;var a=this.messagesQueue.find(function(e){return e.file&&e.file.id===t});if(!a){return false}this.controller.getStore().dispatch("messages/actionStart",{chatId:a.chatId,id:a.id}).then(function(){i.controller.getStore().dispatch("files/update",{chatId:a.chatId,id:a.file.id,fields:{status:d.FileStatus.upload,progress:0}})});a.sending=false;this.processSendMessages();return true}},{key:"processSendMessages",value:function e(){var t=this;this.messagesQueue.filter(function(e){return!e.sending}).forEach(function(e){e.sending=true;if(e.file){if(e.file.source==="disk"){t.fileCommit({chatId:e.chatId,dialogId:e.dialogId,diskId:e.file.uploadLink,messageText:e.text,messageId:e.id,fileId:e.file.id,fileType:o.FilesModel.getType(e.file.name)},e)}else{if(t.controller.application.getDiskFolderId()){t.sendMessageWithFile(e)}else{e.sending=false;t.requestDiskFolderId()}}}else{e.sending=true;t.sendMessage(e)}});return true}},{key:"processMarkReadMessages",value:function e(){this.controller.application.readMessageExecute(this.controller.application.getChatId(),true);return true}},{key:"sendMessage",value:function e(t){t.text=t.text.replace(/^([-]{21}\n)/gm,"-".repeat(54)+"\n");this.controller.application.stopWriting(t.dialogId);BXMobileApp.Events.postToComponent("chatbackground::task::add",["sendMessage|"+t.id,[d.RestMethod.imMessageAdd,{TEMPLATE_ID:t.id,DIALOG_ID:t.dialogId,MESSAGE:t.text}],t],"background")}},{key:"sendMessageWithFile",value:function e(t){var i=o.FilesModel.getType(t.file.name);var a=t.file.name.toString().toLowerCase().split(".").splice(-1)[0];var s=i!==d.FileType.image&&t.file.preview;var r=i===d.FileType.image&&t.file.type!=="image/gif"||i===d.FileType.video;BX.MobileUploadProvider.addTasks([{url:t.file.uploadLink,params:t,name:t.file.name,type:a,mimeType:i===d.FileType.audio?"audio/mp4":null,resize:!r?null:{quality:80,width:1920,height:1080},previewUrl:s?t.file.preview.url:"",folderId:this.controller.application.getDiskFolderId(),taskId:"imDialog"+t.file.id,onDestroyEventName:"onimdiskmessageaddsuccess"}])}},{key:"fileError",value:function e(t,i){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.controller.getStore().dispatch("files/update",{chatId:t,id:i,fields:{status:d.FileStatus.error,progress:0}});if(a){this.controller.getStore().dispatch("messages/actionError",{chatId:t,id:a,retry:true})}}},{key:"fileCommit",value:function e(t,i){var a=this;var o={chat_id:t.chatId,message:t.messageText,template_id:t.messageId?t.messageId:0,file_template_id:t.fileId?t.fileId:0};if(t.uploadId){o.upload_id=t.uploadId}else if(t.diskId){o.disk_id=t.diskId}this.controller.restClient.callMethod(d.RestMethod.imDiskFileCommit,o,null,null,u.Utils.getLogTrackingParams({name:d.RestMethod.imDiskFileCommit,data:{timMessageType:t.fileType},dialog:this.controller.application.getDialogData(t.dialogId)})).then(function(e){a.controller.executeRestAnswer(d.RestMethodHandler.imDiskFileCommit,e,i)}).catch(function(e){a.controller.executeRestAnswer(d.RestMethodHandler.imDiskFileCommit,e,i)});return true}},{key:"requestDiskFolderId",value:function e(){var t=this;if(this.flagRequestDiskFolderIdSended||this.controller.application.getDiskFolderId()){return true}this.flagRequestDiskFolderIdSended=true;this.controller.restClient.callMethod(d.RestMethod.imDiskFolderGet,{chat_id:this.controller.application.getChatId()}).then(function(e){t.controller.executeRestAnswer(d.RestMethodHandler.imDiskFolderGet,e);t.flagRequestDiskFolderIdSended=false;t.processSendMessages()}).catch(function(e){t.flagRequestDiskFolderIdSended=false;t.controller.executeRestAnswer(d.RestMethodHandler.imDiskFolderGet,e)});return true}},{key:"getDialogHistory",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();this.controller.restClient.callMethod(d.RestMethod.imDialogMessagesGet,{CHAT_ID:this.controller.application.getChatId(),LAST_ID:t,LIMIT:a,CONVERT_TEXT:"Y"}).then(function(e){i.controller.executeRestAnswer(d.RestMethodHandler.imDialogMessagesGet,e);i.controller.application.emit(d.EventType.dialog.requestHistoryResult,{count:e.data().messages.length})}).catch(function(e){i.controller.emit(d.EventType.dialog.requestHistoryResult,{error:e.error().ex})})}},{key:"getDialogUnread",value:function e(t){var i=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();if(this.promiseGetDialogUnreadWait){return this.promiseGetDialogUnread}this.promiseGetDialogUnread=new BX.Promise;this.promiseGetDialogUnreadWait=true;if(!t){t=this.controller.getStore().getters["messages/getLastId"](this.controller.application.getChatId())}if(!t){this.controller.application.emit(d.EventType.dialog.requestUnreadResult,{error:{error:"LAST_ID_EMPTY",error_description:"LastId is empty."}});this.promiseGetDialogUnread.reject();this.promiseGetDialogUnreadWait=false;return this.promiseGetDialogUnread}this.controller.application.readMessage(t,true,true).then(function(){var e;i.timer.start("data","load",.5,function(){console.warn("ChatDialog.requestData: slow connection show progress icon");app.titleAction("setParams",{useProgress:true,useLetterImage:false})});var o=(e={},babelHelpers.defineProperty(e,d.RestMethodHandler.imDialogRead,[d.RestMethod.imDialogRead,{dialog_id:i.controller.application.getDialogId(),message_id:t}]),babelHelpers.defineProperty(e,d.RestMethodHandler.imChatGet,[d.RestMethod.imChatGet,{dialog_id:i.controller.application.getDialogId()}]),babelHelpers.defineProperty(e,d.RestMethodHandler.imDialogMessagesGetUnread,[d.RestMethod.imDialogMessagesGet,{chat_id:i.controller.application.getChatId(),first_id:t,limit:a,convert_text:"Y"}]),e);i.controller.restClient.callBatch(o,function(e){if(!e){i.controller.application.emit(d.EventType.dialog.requestUnreadResult,{error:{error:"EMPTY_RESPONSE",error_description:"Server returned an empty response."}});i.promiseGetDialogUnread.reject();i.promiseGetDialogUnreadWait=false;return false}var t=e[d.RestMethodHandler.imChatGet];if(!t.error()){i.controller.executeRestAnswer(d.RestMethodHandler.imChatGet,t)}var a=e[d.RestMethodHandler.imDialogMessagesGetUnread];if(a.error()){i.controller.application.emit(d.EventType.dialog.requestUnreadResult,{error:a.error().ex})}else{i.controller.executeRestAnswer(d.RestMethodHandler.imDialogMessagesGetUnread,a);i.controller.application.emit(d.EventType.dialog.requestUnreadResult,{firstMessageId:a.data().messages.length>0?a.data().messages[0].id:0,count:a.data().messages.length});app.titleAction("setParams",{useProgress:false,useLetterImage:true});i.timer.stop("data","load",true)}i.promiseGetDialogUnread.fulfill(e);i.promiseGetDialogUnreadWait=false},false,false,u.Utils.getLogTrackingParams({name:d.RestMethodHandler.imDialogMessagesGetUnread,dialog:i.controller.application.getDialogData()}))});return this.promiseGetDialogUnread}},{key:"retrySendMessage",value:function e(t){var i=this.messagesQueue.find(function(e){return e.id===t.id});if(i){if(i.file&&i.file.id){this.retryUploadFile(i.file.id)}return false}this.messagesQueue.push({id:t.id,chatId:this.controller.application.getChatId(),dialogId:this.controller.application.getDialogId(),text:t.text,sending:false});this.controller.application.setSendingMessageFlag(t.id);this.processSendMessages()}},{key:"openProfile",value:function e(t){BXMobileApp.Events.postToComponent("onUserProfileOpen",[t,{backdrop:true}],"communication")}},{key:"openDialog",value:function e(t){BXMobileApp.Events.postToComponent("onOpenDialog",[{dialogId:t},true],"im.recent")}},{key:"openPhoneMenu",value:function e(t){BX.MobileTools.phoneTo(t)}},{key:"openMessageMenu",value:function e(t){var i=this;if(this.messagesQueue.find(function(e){return e.id===t.id})){return false}this.controller.getStore().dispatch("messages/update",{id:t.id,chatId:t.chatId,fields:{blink:true}});var a=this.controller.application.getCurrentUser();var o=this.controller.application.getDialogData();var s=t.authorId>0?this.controller.getStore().getters["users/get"](t.authorId,true):null;this.messageMenuInstance=BackdropMenu.create("im.dialog.menu.mess|"+this.controller.application.getDialogId()).setItems([BackdropMenuItem.create("reply").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_REPLY")).setIcon(BackdropMenuIcon.reply).skip(function(e){var t=i.controller.application.getDialogData();if(t.type==="announcement"&&!t.managerList.includes(i.controller.application.getUserId())){return true}return!e.authorId||e.authorId===i.controller.application.getUserId()}),BackdropMenuItem.create("copy").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_COPY")).setIcon(BackdropMenuIcon.copy).skip(function(e){return e.params.IS_DELETED==="Y"}),BackdropMenuItem.create("quote").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_QUOTE")).setIcon(BackdropMenuIcon.quote).skip(function(e){var t=i.controller.application.getDialogData();if(t.type==="announcement"&&!t.managerList.includes(i.controller.application.getUserId())){return true}return e.params.IS_DELETED==="Y"}),BackdropMenuItem.create("unread").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_UNREAD")).setIcon(BackdropMenuIcon.unread).skip(function(e){return e.authorId===i.controller.application.getUserId()||e.unread}),BackdropMenuItem.create("read").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_READ")).setIcon(BackdropMenuIcon.checked).skip(function(e){return!e.unread}),BackdropMenuItem.create("edit").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_EDIT")).setIcon(BackdropMenuIcon.edit).skip(function(e){return e.authorId!==i.controller.application.getUserId()||e.params.IS_DELETED==="Y"}),BackdropMenuItem.create("share").setType(BackdropMenuItemType.menu).setIcon(BackdropMenuIcon.circle_plus).setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_SHARE_MENU")).disableClose().skip(a.extranet||o.type==="announcement"),BackdropMenuItem.create("profile").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_PROFILE")).setIcon(BackdropMenuIcon.user).skip(function(e){if(e.authorId<=0||!s)return true;if(!u.Utils.dialog.isChatId(i.controller.application.getDialogId()))return true;if(e.authorId===i.controller.application.getUserId())return true;if(s.externalAuthId==="imconnector"||s.externalAuthId==="call"){return true}return false}),BackdropMenuItem.create("delete").setTitle(this.getLocalize("MOBILE_MESSAGE_MENU_DELETE")).setStyles(BackdropMenuStyle.create().setFont(WidgetListItemFont.create().setColor("#c50000"))).setIcon(BackdropMenuIcon.trash).skip(function(e){return e.authorId!==i.controller.application.getUserId()||e.params.IS_DELETED==="Y"})]).setVersion(BX.componentParameters.get("WIDGET_BACKDROP_MENU_VERSION","1.0.0")).setEventListener(function(e,t,a,o){if(e==="destroyed"){f.Vue.event.$emit("bitrixmobile:controller:focus")}if(e!=="selected"){return false}if(t.id==="reply"){i.replyToUser(a.authorId)}else if(t.id==="copy"){i.copyMessage(a.id)}else if(t.id==="quote"){i.quoteMessageClear();i.quoteMessage(a.id)}else if(t.id==="edit"){i.quoteMessageClear();i.editMessage(a.id)}else if(t.id==="delete"){i.deleteMessage(a.id)}else if(t.id==="unread"){i.unreadMessage(a.id)}else if(t.id==="read"){i.readMessage(a.id)}else if(t.id==="share"){var s=i.controller.application.getDialogData();var r=BackdropMenu.create("im.dialog.menu.mess.submenu|"+i.controller.application.getDialogId()).setItems([BackdropMenuItem.create("share_task").setIcon(BackdropMenuIcon.task).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_TASK")),BackdropMenuItem.create("share_post").setIcon(BackdropMenuIcon.lifefeed).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_POST_NEWS")),BackdropMenuItem.create("share_chat").setIcon(BackdropMenuIcon.chat).setTitle(i.getLocalize("MOBILE_MESSAGE_MENU_SHARE_CHAT"))]).setEventListener(function(e,t,o,s){if(e!=="selected"){return false}if(t.id==="share_task"){i.shareMessage(a.id,"TASK")}else if(t.id==="share_post"){i.shareMessage(a.id,"POST")}else if(t.id==="share_chat"){i.shareMessage(a.id,"CHAT")}});o.showSubMenu(r)}else if(t.id==="profile"){i.openProfile(a.authorId)}else{console.warn("BackdropMenuItem is not implemented",t)}});this.messageMenuInstance.setCustomParams(t).show();fabric.Answers.sendCustomEvent("vueChatOpenDropdown",{})}},{key:"openHeaderMenu",value:function e(){var t=this;fabric.Answers.sendCustomEvent("vueChatOpenHeaderMenu",{});if(!this.headerMenu){this.headerMenu=HeaderMenu.create().setUseNavigationBarColor().setEventListener(function(e,i,a){if(e!=="selected"){return false}if(i.id==="profile"){t.openProfile(t.controller.application.getDialogId())}else if(i.id==="user_list"){t.openUserList({listType:"USERS",title:t.getLocalize("MOBILE_HEADER_MENU_USER_LIST"),backdrop:true})}else if(i.id==="user_add"){t.openAddUserDialog()}else if(i.id==="leave"){t.leaveChat()}else if(i.id==="notify"){t.controller.application.muteDialog()}else if(i.id==="call_chat_call"){BX.MobileTools.phoneTo(t.controller.application.getDialogData().entityId)}else if(i.id==="goto_crm"){var o=t.controller.application.getDialogCrmData();var s=BX.MobileTools.resolveOpenFunction("/crm/"+o.entityType+"/show/"+o.entityId+"/");if(s){s()}}else if(i.id==="reload"){new BXMobileApp.UI.NotificationBar({message:t.getLocalize("MOBILE_HEADER_MENU_RELOAD_WAIT"),color:"#d920b0ff",textColor:"#ffffff",groupId:"refresh",useLoader:true,maxLines:1,align:"center",hideOnTap:true},"copy").show();t.controller.getStoreBuilder().clearDatabase();reload()}})}if(u.Utils.dialog.isChatId(this.controller.application.getDialogId())){var i=this.controller.application.getDialogData();var a=!this.controller.application.isDialogMuted()?this.getLocalize("MOBILE_HEADER_MENU_NOTIFY_DISABLE"):this.getLocalize("MOBILE_HEADER_MENU_NOTIFY_ENABLE");var o=!this.controller.application.isDialogMuted()?HeaderMenuIcon.notify:HeaderMenuIcon.notify_off;var s="";if(i.type===d.DialogType.call||i.type===d.DialogType.crm){var r=this.controller.application.getDialogCrmData();if(r.enabled){if(r.entityType===d.DialogCrmType.lead){s=this.getLocalize("MOBILE_GOTO_CRM_LEAD")}else if(r.entityType===d.DialogCrmType.company){s=this.getLocalize("MOBILE_GOTO_CRM_COMPANY")}else if(r.entityType===d.DialogCrmType.contact){s=this.getLocalize("MOBILE_GOTO_CRM_CONTACT")}else if(r.entityType===d.DialogCrmType.deal){s=this.getLocalize("MOBILE_GOTO_CRM_DEAL")}else{s=this.getLocalize("MOBILE_GOTO_CRM")}}}if(i.type===d.DialogType.call){this.headerMenu.setItems([HeaderMenuItem.create("call_chat_call").setTitle(this.getLocalize("MOBILE_HEADER_MENU_AUDIO_CALL")).setIcon(HeaderMenuIcon.phone).skip(i.entityId==="UNIFY_CALL_CHAT"),HeaderMenuItem.create("goto_crm").setTitle(s).setIcon(HeaderMenuIcon.lifefeed).skip(i.entityId==="UNIFY_CALL_CHAT"||!s),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)])}else{var l=[HeaderMenuItem.create("notify").setTitle(a).setIcon(o),HeaderMenuItem.create("user_list").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_LIST")).setIcon(HeaderMenuIcon.user),HeaderMenuItem.create("user_add").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_ADD")).setIcon(HeaderMenuIcon.user_plus).skip(!i.restrictions.extend),HeaderMenuItem.create("leave").setTitle(this.getLocalize("MOBILE_HEADER_MENU_LEAVE")).setIcon(HeaderMenuIcon.cross).skip(!i.restrictions.leave),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)];l.push(HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload));if(i.type===d.DialogType.crm&&s){l.unshift(HeaderMenuItem.create("goto_crm").setTitle(s).setIcon(HeaderMenuIcon.lifefeed))}this.headerMenu.setItems(l)}}else{this.headerMenu.setItems([HeaderMenuItem.create("profile").setTitle(this.getLocalize("MOBILE_HEADER_MENU_PROFILE")).setIcon("user").skip(u.Utils.dialog.isChatId(this.controller.application.getDialogId())),HeaderMenuItem.create("user_add").setTitle(this.getLocalize("MOBILE_HEADER_MENU_USER_ADD")).setIcon(HeaderMenuIcon.user_plus),HeaderMenuItem.create("reload").setTitle(this.getLocalize("MOBILE_HEADER_MENU_RELOAD")).setIcon(HeaderMenuIcon.reload)])}this.headerMenu.show(true)}},{key:"shareMessage",value:function e(t,i){if(!this.controller.isOnline()){return false}return this.controller.application.shareMessage(t,i)}},{key:"readMessage",value:function e(t){this.controller.application.readMessage(t,true,true).then(function(e){if(e.lastId<=0){return true}BXMobileApp.Events.postToComponent("chatbackground::task::action",["readMessage","readMessage|"+e.dialogId,e,false,200],"background")});return true}},{key:"unreadMessage",value:function e(t){if(!this.controller.isOnline()){return false}return this.controller.application.unreadMessage(t)}},{key:"openReadedList",value:function e(t){if(!u.Utils.dialog.isChatId(this.controller.application.getDialogId())){return false}if(!t||t.length<=1){return false}this.openUserList({users:t.map(function(e){return e.userId}),title:this.getLocalize("MOBILE_MESSAGE_LIST_VIEW")})}},{key:"replyToUser",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this.controller.isOnline()){return false}if(!i){i=this.controller.getStore().getters["users/get"](t)}return this.insertText({text:"[USER=".concat(t,"]").concat(i.firstName,"[/USER] ")})}},{key:"copyMessage",value:function e(t){var i=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);var a="";if(i.params.FILE_ID&&i.params.FILE_ID.length){a=i.params.FILE_ID.map(function(e){return"[DISK="+e+"]"}).join(" ")}if(i.text){if(a){a+="\n"}a+=i.text.replace(/^([-]{54}\n)/gm,"-".repeat(21)+"\n")}app.exec("copyToClipboard",{text:a});new BXMobileApp.UI.NotificationBar({message:BX.message("MOBILE_MESSAGE_MENU_COPY_SUCCESS"),color:"#af000000",textColor:"#ffffff",groupId:"clipboard",maxLines:1,align:"center",isGlobal:true,useCloseButton:true,autoHideTimeout:1500,hideOnTap:true},"copy").show()}},{key:"quoteMessage",value:function e(t){var i=this;this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:t}}).then(function(){if(i.controller.getStore().state.application.mobile.keyboardShow){setTimeout(function(){return i.controller.application.emit(d.EventType.dialog.scrollToBottom,{duration:300,cancelIfScrollChange:true,force:true})},300)}else{i.setTextFocus()}})}},{key:"reactMessage",value:function e(t,i){BXMobileApp.Events.postToComponent("chatbackground::task::action",["reactMessage","reactMessage|"+t,{messageId:t,action:i.action==="auto"?"auto":i.action==="set"?"plus":"minus"},false,1e3],"background");if(i.action==="set"){setTimeout(function(){return app.exec("callVibration")},200)}}},{key:"openMessageReactionList",value:function e(t,i){if(!u.Utils.dialog.isChatId(this.controller.application.getDialogId())){return false}var a=[];for(var o in i){if(!i.hasOwnProperty(o)){continue}a=a.concat(i[o])}this.openUserList({users:a,title:this.getLocalize("MOBILE_MESSAGE_LIST_LIKE")})}},{key:"quoteMessageClear",value:function e(){this.setText("");this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:0,editId:0}})}},{key:"editMessage",value:function e(t){var i=this;var a=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:t,editId:t}}).then(function(){setTimeout(function(){return i.controller.application.emit(d.EventType.dialog.scrollToBottom,{duration:300,cancelIfScrollChange:false,force:true})},300);i.setTextFocus()});this.setText(a.text)}},{key:"updateMessage",value:function e(t,i){this.quoteMessageClear();this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{editId:0}});this.editMessageSend(t,i)}},{key:"editMessageSend",value:function e(t,i){this.controller.restClient.callMethod(d.RestMethod.imMessageUpdate,{MESSAGE_ID:t,MESSAGE:i},null,null,u.Utils.getLogTrackingParams({name:d.RestMethod.imMessageUpdate,data:{timMessageType:"text"},dialog:this.controller.application.getDialogData()}))}},{key:"deleteMessage",value:function e(t){var i=this;var a=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),t);var o=this.controller.getStore().getters["files/getList"](this.controller.application.getChatId());var s=u.Utils.text.purify(a.text,a.params,o,this.getLocalize());s=s.length>50?s.substr(0,47)+"...":s;app.confirm({title:this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_CONFIRM"),text:s?'"'+s+'"':"",buttons:[this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_YES"),this.getLocalize("MOBILE_MESSAGE_MENU_DELETE_NO")],callback:function e(a){if(a===1){i.quoteMessageClear();i.deleteMessageSend(t)}}})}},{key:"deleteMessageSend",value:function e(t){this.controller.restClient.callMethod(d.RestMethod.imMessageDelete,{MESSAGE_ID:t},null,null,u.Utils.getLogTrackingParams({name:d.RestMethod.imMessageDelete,data:{},dialog:this.controller.application.getDialogData(this.controller.application.getDialogId())}))}},{key:"insertText",value:function e(t){var i=this;BXMobileApp.UI.Page.TextPanel.getText(function(e){e=e.toString().trim();e=e?e+" "+t.text:t.text;i.setText(e);i.setTextFocus()})}},{key:"setText",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";t=t.toString();if(t){BXMobileApp.UI.Page.TextPanel.setText(t)}else{BXMobileApp.UI.Page.TextPanel.clear()}this.setTextareaMessage({message:t});console.log("Set new text in textarea",t?t:"-- empty --")}},{key:"clearText",value:function e(){this.setText()}},{key:"setTextFocus",value:function e(){if(!this.controller.getStore().state.application.mobile.keyboardShow){BXMobileApp.UI.Page.TextPanel.focus()}}},{key:"isBackground",value:function e(){if((typeof BXMobileAppContext==="undefined"?"undefined":babelHelpers.typeof(BXMobileAppContext))!=="object"){return false}if(typeof BXMobileAppContext.isAppActive==="function"&&!BXMobileAppContext.isAppActive()){return true}if(typeof BXMobileAppContext.isBackground==="function"){return BXMobileAppContext.isBackground()}return false}},{key:"hideSmiles",value:function e(){}},{key:"executeBackgroundTaskSuccess",value:function e(t,i){var a={error:function e(){return false},data:function e(){return i.result}};console.log("Dialog.executeBackgroundTaskSuccess",t,i);if(t==="sendMessage"){this.controller.executeRestAnswer(d.RestMethodHandler.imMessageAdd,a,i.extra)}else if(t==="readMessage"){this.processMarkReadMessages()}}},{key:"executeBackgroundTaskFailure",value:function e(t,i){var a={error:function e(){return{error:i.code,error_description:i.text,ex:{status:i.status}}},data:function e(){return false}};console.log("Dialog.executeBackgroundTaskFailure",t,i);if(t==="sendMessage"){this.controller.executeRestAnswer(d.RestMethodHandler.imMessageAdd,a,i.extra)}}},{key:"setError",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";console.error("MobileChat.error: ".concat(t," (").concat(i,")"));var a="";if(t.endsWith("LOCALIZED")){a=i}this.controller.getStore().commit("application/set",{error:{active:true,code:t,description:a}})}},{key:"clearError",value:function e(){this.controller.getStore().commit("application/set",{error:{active:false,code:"",description:""}})}},{key:"addLocalize",value:function e(t){return this.controller.addLocalize(t)}},{key:"getLocalize",value:function e(t){return this.controller.getLocalize(t)}}]);return e}();e.MobileDialogApplication=M})(this.BX.Messenger.Application=this.BX.Messenger.Application||{},BX.Messenger.Application,BX,BX,BX.Messenger.Model,BX.Messenger.Provider.Rest,BX.Messenger.Lib,BX.Messenger.Lib,window,BX.Messenger.Lib,BX.Messenger.Const,BX.Messenger.Lib,window,window,BX,BX);
//# sourceMappingURL=dialog.bundle.map.js