{"version":3,"file":"dialog.bundle.js","sources":["../src/dialog.js"],"sourcesContent":["import \"./dialog.css\";\n\n/* region 00. Startup operations */\nconst GetObjectValues = function(source)\n{\n\tconst destination = [];\n\tfor (let value in source)\n\t{\n\t\tif (source.hasOwnProperty(value))\n\t\t{\n\t\t\tdestination.push(source[value]);\n\t\t}\n\t}\n\treturn destination;\n};\n/* endregion 00. Startup operations */\n\n/* region 01. Constants */\n\nimport {DeviceType, DeviceOrientation} from \"im.const\";\nimport {ApplicationModel, MessagesModel, DialoguesModel, UsersModel, FilesModel} from 'im.model';\nimport {ApplicationController} from 'im.controller';\n\nconst RestMethod = Object.freeze({\n\tpullServerTime: 'server.time', // TODO: method is not implemented\n\tpullConfigGet: 'pull.config.get', // TODO: method is not implemented\n\n\timMessageAdd: 'im.message.add',\n\timMessageUpdate: 'im.message.update', // TODO: method is not implemented\n\timMessageDelete: 'im.message.delete', // TODO: method is  not implemented\n\timMessageLike: 'im.message.like', // TODO: method is  not implemented\n\timChatGet: 'im.chat.get',  // TODO: method is not implemented\n\timChatSendTyping: 'im.chat.sendTyping',  // TODO: method is not implemented\n\timDialogMessagesGet: 'im.dialog.messages.get',  // TODO: method is not implemented\n\timDialogMessagesUnread: 'im.dialog.messages.unread',  // TODO: method is not implemented\n\timDialogRead: 'im.dialog.read',  // TODO: method is not implemented\n\n\tdiskFolderGet: 'im.disk.folder.get',  // TODO: method is not implemented\n\tdiskFileUpload: 'disk.folder.uploadfile',  // TODO: method is not implemented\n\tdiskFileCommit: 'im.disk.file.commit',  // TODO: method is not implemented\n});\nconst RestMethodCheck = GetObjectValues(RestMethod);\n\n/* endregion 01. Constants */\n\n/* region 03. Dialog interface */\nclass MessengerDialog\n{\n\tconstructor(params = {})\n\t{\n\t\tthis.restClient = null;\n\t\tthis.pullClient = null;\n\n\t\tthis.offline = false;\n\n\t\tthis.dateFormat = null;\n\n\t\tthis.messagesQueue = [];\n\n\t\tthis.filesQueue = [];\n\t\tthis.filesQueueIndex = 0;\n\n\t\tthis.messageLastReadId = null;\n\t\tthis.messageReadQueue = [];\n\n\t\tthis.defaultMessageLimit = 20;\n\t\tthis.requestMessageLimit = this.defaultMessageLimit;\n\n\t\tthis.rootNode = document.body;\n\n\t\tthis.template = null;\n\n\t\t/* TODO rewrite to IndexedDB */\n\t\tlet serverVariables = BX.Messenger.LocalStorage.get(this.getSiteId(), 0, 'serverVariables', false);\n\t\tif (serverVariables)\n\t\t{\n\t\t\tthis.addLocalize(serverVariables);\n\t\t}\n\n\t\tthis.timer = new BX.Messenger.Timer();\n\n\t\tthis.controller = new ApplicationController();\n\n\t\tlet applicationVariables = {\n\t\t\tcommon: {\n\t\t\t\tsiteId: this.getSiteId(),\n\t\t\t\tlanguageId: this.getLanguageId(),\n\t\t\t},\n\t\t\tdevice: {\n\t\t\t\ttype: BX.Messenger.Utils.device.isMobile()? DeviceType.mobile: DeviceType.desktop,\n\t\t\t\torientation: BX.Messenger.Utils.device.getOrientation(),\n\t\t\t},\n\t\t\tdialog: {\n\t\t\t\tmessageLimit: this.defaultMessageLimit\n\t\t\t}\n\t\t};\n\n\t\tnew BX.VuexBuilder()\n\t\t\t.addModel(ApplicationModel.create().setVariables(applicationVariables))\n\t\t\t.addModel(MessagesModel.create())\n\t\t\t.addModel(DialoguesModel.create().setVariables({host: this.getHost()}).useDatabase(false))\n\t\t\t.addModel(UsersModel.create().setVariables({host: this.getHost(), defaultName: BX.message('IM_MESSENGER_MESSAGE_USER_ANONYM')}).useDatabase(false))\n\t\t\t.addModel(FilesModel.create().setVariables({host: this.getHost()}).useDatabase(false))\n\t\t\t.setDatabaseConfig({\n\t\t\t\ttype: BX.VuexBuilder.DatabaseType.indexedDb,\n\t\t\t\tsiteId: this.getSiteId(),\n\t\t\t})\n\t\t.build(result => {\n\n\t\t\tthis.store = result.store;\n\t\t\tthis.storeCollector = result.builder;\n\n\t\t\tthis.restClient = BX.rest;\n\t\t\tthis.pullClient = BX.PULL;\n\n\n\t\t\tthis.controller.setPrepareFilesBeforeSaveFunction(this.prepareFileData);\n\n\t\t\tthis.requestData(this.getDialogId());\n\t\t\tthis.attachTemplate();\n\t\t});\n\t}\n\n\taddLocalize(phrases)\n\t{\n\t\tif (typeof phrases !== \"object\")\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (let name in phrases)\n\t\t{\n\t\t\tif (phrases.hasOwnProperty(name))\n\t\t\t{\n\t\t\t\tBX.message[name] = phrases[name];\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tgetHost()\n\t{\n\t\treturn location.protocol+'//'+location.host; // TODO read variables\n\t}\n\n\tgetSiteId()\n\t{\n\t\treturn 'default'; // TODO read variables\n\t}\n\n\tgetDialogId()\n\t{\n\t\treturn 'chat56'; // TODO read variables\n\t}\n\n\tgetLanguageId()\n\t{\n\t\treturn 'ru'; // TODO read variables\n\t}\n\n\trequestData()\n\t{\n\n\t}\n\n\texecuteRestAnswer(type, result)\n\t{\n\n\t}\n\n\tprepareFileData(files)\n\t{\n\t\tif (true) // TODO change to right version if mobile implement protocol bxfiles://\n\t\t{\n\t\t\treturn files;\n\t\t}\n\n\t\treturn files.map(file =>\n\t\t{\n\t\t\tif (file.urlPreview)\n\t\t\t{\n\t\t\t\tfile.urlPreview = file.urlPreview.replace('http://', 'bx://').replace('https://', 'bx://');\n\t\t\t}\n\t\t\tif (file.urlShow)\n\t\t\t{\n\t\t\t\tfile.urlShow = file.urlShow.replace('http://', 'bx://').replace('https://', 'bx://');\n\t\t\t}\n\t\t\tif (file.urlDownload)\n\t\t\t{\n\t\t\t\tfile.urlDownload = file.urlDownload.replace('http://', 'bx://').replace('https://', 'bx://');\n\t\t\t}\n\n\t\t\treturn file;\n\t\t});\n\t}\n\n\tattachTemplate()\n\t{\n\t\tthis.rootNode.innerHTML = '';\n\n\t\tconst widgetContext = this;\n\t\tconst restClient = this.restClient;\n\t\tconst pullClient = this.pullClient;\n\n\t\tthis.template = BX.Vue.create({\n\t\t\tel: this.rootNode.firstChild,\n\t\t\tstore: this.store,\n\t\t\ttemplate: '<bx-mobile-dialog/>',\n\t\t\tbeforeCreate()\n\t\t\t{\n\t\t\t\tthis.$bitrixWidget= widgetContext;\n\t\t\t\tthis.$bitrixRestClient = restClient;\n\t\t\t\tthis.$bitrixMessages = widgetContext.localize;\n\t\t\t}\n\t\t});\n\n\t\treturn true;\n\t}\n\n}\n\nwindow.MessengerDialog = new MessengerDialog;"],"names":["GetObjectValues","source","destination","value","hasOwnProperty","push","RestMethod","Object","freeze","pullServerTime","pullConfigGet","imMessageAdd","imMessageUpdate","imMessageDelete","imMessageLike","imChatGet","imChatSendTyping","imDialogMessagesGet","imDialogMessagesUnread","imDialogRead","diskFolderGet","diskFileUpload","diskFileCommit","RestMethodCheck","MessengerDialog","restClient","pullClient","offline","dateFormat","messagesQueue","filesQueue","filesQueueIndex","messageLastReadId","messageReadQueue","defaultMessageLimit","requestMessageLimit","rootNode","document","body","template","serverVariables","BX","Messenger","LocalStorage","get","getSiteId","addLocalize","timer","Timer","controller","ApplicationController","applicationVariables","common","siteId","languageId","getLanguageId","device","type","Utils","isMobile","DeviceType","mobile","desktop","orientation","getOrientation","dialog","messageLimit","VuexBuilder","addModel","ApplicationModel","create","setVariables","MessagesModel","DialoguesModel","host","getHost","useDatabase","UsersModel","defaultName","message","FilesModel","setDatabaseConfig","DatabaseType","indexedDb","build","result","store","storeCollector","builder","rest","PULL","setPrepareFilesBeforeSaveFunction","prepareFileData","requestData","getDialogId","attachTemplate","phrases","name","location","protocol","files","map","file","urlPreview","replace","urlShow","urlDownload","innerHTML","widgetContext","Vue","el","firstChild","beforeCreate","$bitrixWidget","$bitrixRestClient","$bitrixMessages","localize","window"],"mappings":"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"}