this.BX=this.BX||{};(function(e,t,s,i,n,o){"use strict";var a=function(){function e(){babelHelpers.classCallCheck(this,e);this.classes={show:"lenta-notifier-shown"};this.nodeIdList={notifier:"lenta_notifier",notifierCounter:"lenta_notifier_cnt",notifierCounterTitle:"lenta_notifier_cnt_title",refreshNeeded:"lenta_notifier_2"}}babelHelpers.createClass(e,[{key:"getNotifierNode",value:function e(){return document.getElementById(this.nodeIdList.notifier)}},{key:"getNotifierCounterNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounter)}},{key:"getNotifierCounterTitleNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounterTitle)}},{key:"getRefreshNeededNode",value:function e(){return document.getElementById(this.nodeIdList.refreshNeeded)}},{key:"showRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.add(this.classes.show)}}},{key:"hideRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.remove(this.classes.show)}}},{key:"showNotifier",value:function e(s){var i=parseInt(s.counterValue);var n=i%100,o=i%10;var a="";if(n>=10&&n<15){a=3}else if(o==0){a=3}else if(o==1){a=1}else if(o==2||o==3||o==4){a=2}else{a=3}if(E.getRefreshNeeded()){this.getNotifierCounterNode().innerHTML=i?i+"+":"";this.hideRefreshNeededNotifier()}else{this.getNotifierCounterNode().innerHTML=i||""}this.getNotifierCounterTitleNode().innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_COUNTER_TITLE_"+a);this.getNotifierNode().classList.add(this.classes.show)}},{key:"hideNotifier",value:function e(){var t=this.getNotifierNode();if(t){t.classList.remove(this.classes.show)}}}]);return e}();var r=function(){function e(){babelHelpers.classCallCheck(this,e);this.repo=[];this.color={background:{error:"#affb0000",info:"#3a3735"},text:{error:"#ffffff",info:"#ffffff"}}}babelHelpers.createClass(e,[{key:"hideAll",value:function e(){this.repo=this.repo.filter(function(e){return e});this.repo.forEach(function(e){e.hide()})}},{key:"showError",value:function e(t){var s=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.error,textColor:this.color.text.error,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",align:t.textAlign?t.textAlign:"center",autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:3e4,hideOnTap:t.hideOnTap?!!t.hideOnTap:true,onTap:t.onTap?t.onTap:function(){}},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(s);s.show()}},{key:"showInfo",value:function e(t){var s=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.info,textColor:this.color.text.info,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",maxLines:t.maxLines?t.maxLines:false,align:t.textAlign?t.textAlign:"center",isGlobal:t.isGlobal?!!t.isGlobal:true,useCloseButton:t.useCloseButton?!!t.useCloseButton:true,autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:1e3,hideOnTap:t.hideOnTap?!!t.hideOnTap:true},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(s);s.show()}}]);return e}();var l=function(){function e(s){babelHelpers.classCallCheck(this,e);this.tableName=null;this.keyName=null;this.setTableName(t.Type.isPlainObject(s)&&t.Type.isStringFilled(s.tableName)?s.tableName:"livefeed");this.setKeyName(t.Type.isPlainObject(s)&&t.Type.isStringFilled(s.keyName)?s.keyName:"postUnsent");this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){BXMobileApp.addCustomEvent("Livefeed.Database::clear",this.onClear.bind(this))}},{key:"setTableName",value:function e(t){this.tableName=t}},{key:"getTableName",value:function e(){return this.tableName}},{key:"setKeyName",value:function e(t){this.keyName=t}},{key:"getKeyName",value:function e(){return this.keyName}},{key:"onClear",value:function e(t){this.delete(t.groupId)}},{key:"delete",value:function e(t){if(parseInt(t)<=0){t=false}app.exec("setStorageValue",{storageId:this.getTableName(),key:this.getKeyName()+(t?"_"+t:""),value:{},callback:function e(t){}})}},{key:"save",value:function e(t,s){if(parseInt(s)<=0){s=false}for(var i in t){if(!t.hasOwnProperty(i)){continue}if(i==="sessid"){delete t[i];break}}app.exec("setStorageValue",{storageId:this.getTableName(),key:this.getKeyName()+(s?"_"+s:""),value:t,callback:function e(t){}})}},{key:"load",value:function e(s,i){if(parseInt(i)<=0){i=false}app.exec("getStorageValue",{storageId:this.getTableName(),key:this.getKeyName()+(i?"_"+i:""),callback:function e(i){i=t.Type.isPlainObject(i)?i:t.Type.isStringFilled(i)?JSON.parse(i):{};if(t.Type.isPlainObject(i)&&Object.keys(i).length>0){s.onLoad(i)}else{s.onEmpty()}}})}}]);return e}();function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="post-balloon-hidden post-balloon post-balloon-active"><span class="post-balloon-icon"></span><span class="post-balloon-text">',"</span></div>\n\t\t\t"]);d=function t(){return e};return e}var c=function(e){babelHelpers.inherits(s,e);function s(){var e;babelHelpers.classCallCheck(this,s);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this));e.repo={};e.nodeId={container:"post-balloon-container"};e.class={balloonHidden:"post-balloon-hidden",balloonFixed:"post-balloon-box-fixed",balloonPublished:"post-balloon-done",balloonShow:"post-balloon-show",balloonHide:"post-balloon-hide"};e.timeout={show:750};e.init();return e}babelHelpers.createClass(s,[{key:"init",value:function e(){BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterSetItem",this.afterSetItem.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));this.setEventNamespace("BX.Mobile.Livefeed");this.subscribe("onFeedReady",this.onFeedLoaded.bind(this));this.subscribe("onPostInserted",this.onPostInserted.bind(this));t.Event.bind(document,"scroll",this.onScroll.bind(this))}},{key:"onScroll",value:function e(){var s=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(s)){return}if(window.pageYOffset>0){s.classList.add(this.class.balloonFixed)}else{s.classList.remove(this.class.balloonFixed)}}},{key:"onFeedLoaded",value:function e(){var s=this;app.exec("getStorageValue",{storageId:"livefeed",key:"publicationQueue",callback:function e(i){i=t.Type.isPlainObject(i)?i:t.Type.isStringFilled(i)?JSON.parse(i):{};if(!t.Type.isPlainObject(i)){return}for(var n in i){if(!i.hasOwnProperty(n)){continue}s.addToTray(n,{})}s.drawList()}})}},{key:"onPostInserted",value:function e(t){this.removeFromTray(t.data.key)}},{key:"addToTray",value:function e(t,s){this.repo[t]=s;this.repo[t].node=this.drawItem();this.repo[t].node.classList.add(this.class.balloonShow)}},{key:"removeFromTray",value:function e(t,s){var i=this;this.hideItem(t);setTimeout(function(){if(i.repo[t]){delete i.repo[t]}},3e3)}},{key:"addSuccess",value:function e(s){var i=this;if(this.repo[s]&&this.repo[s].node){this.repo[s].node.classList.remove(this.class.balloonHidden);this.repo[s].node.classList.remove(this.class.balloonShow);this.repo[s].node.classList.add(this.class.balloonPublished);this.repo[s].node.lastElementChild.innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_SUCCESS_TITLE")}setTimeout(function(){i.removeFromTray(s)},5e3)}},{key:"drawItem",value:function e(){var s=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_ITEM_TITLE");return t.Tag.render(d(),s)}},{key:"hideItem",value:function e(t,s){if(this.repo[t]){this.repo[t].node.classList.add(this.class.balloonHide)}}},{key:"drawList",value:function e(){var s=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(s)){return}t.Dom.clean(s);for(var i in this.repo){if(!this.repo.hasOwnProperty(i)||!t.Type.isDomNode(this.repo[i].node)){continue}t.Dom.append(this.repo[i].node,s)}}},{key:"afterSetItem",value:function e(s){var i=this;var n=s.key?s.key:"",o=s.pageId?s.pageId:"",a=s.contentType?s.contentType:"";if(o!=E.getPageId()||!n||!t.Type.isStringFilled(a)){return}if(a=="post"){this.addToTray(n,{key:n});setTimeout(function(){i.drawList()},this.timeout.show)}}},{key:"afterPostAdd",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=s.key?s.key:"";this.addSuccess(i);this.drawList()}},{key:"afterPostUpdate",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=s.key?s.key:"";this.addSuccess(i);this.drawList()}},{key:"afterPostAddError",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=s.key?s.key:"";this.removeFromTray(i,{key:i});this.drawList()}},{key:"afterPostUpdateError",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=s.key?s.key:"";this.removeFromTray(i,{key:i});this.drawList()}}]);return s}(s.EventEmitter);var p=function(){function e(t){babelHelpers.classCallCheck(this,e);this.logId=0;this.entryType="";this.useFollow=false;this.useTasks=false;this.perm="";this.destinations={};this.postId=0;this.url="";this.entityXmlId="";this.readOnly=false;this.contentTypeId="";this.contentId=0;this.showFull=false;this.taskId=0;this.taskData=null;this.calendarEventId=0;this.init(t)}babelHelpers.createClass(e,[{key:"init",value:function e(s){var i=s.logId,n=s.entryType,o=s.useFollow,a=s.useTasks,r=s.perm,l=s.destinations,d=s.postId,c=s.url,p=s.entityXmlId,u=s.readOnly,f=s.contentTypeId,h=s.contentId,m=s.showFull,I=s.taskId,g=s.taskData,v=s.calendarEventId;i=parseInt(i);if(i<=0){return}this.logId=i;this.postId=parseInt(d);this.contentId=parseInt(h);this.taskId=parseInt(I);this.calendarEventId=parseInt(v);this.useFollow=!!o;this.useTasks=!!a;this.readOnly=!!u;this.showFull=!!m;if(t.Type.isStringFilled(n)){this.entryType=n}if(t.Type.isStringFilled(r)){this.perm=r}if(t.Type.isStringFilled(c)){this.url=c}if(t.Type.isStringFilled(p)){this.entityXmlId=p}if(t.Type.isStringFilled(f)){this.contentTypeId=f}if(t.Type.isStringFilled(g)){try{this.taskData=JSON.parse(g)}catch(e){this.taskData=null}}if(t.Type.isPlainObject(l)){this.destinations=l}}},{key:"setFavorites",value:function e(s){var i=this;if(this.logId<=0){return}var n=s.node,a=s.event;if(!t.Type.isDomNode(n)){n=document.getElementById("log_entry_favorites_"+this.logId)}if(t.Type.isDomNode(n)){var r=n.getAttribute("data-favorites")==="Y"?"Y":"N";var l=r==="Y"?"N":"Y";if(n.classList.contains("lenta-item-fav")){if(r==="Y"){n.classList.remove("lenta-item-fav-active")}else{n.classList.add("lenta-item-fav-active")}}n.setAttribute("data-favorites",l);o.Ajax.runAction("socialnetwork.api.livefeed.changeFavorites",{data:{logId:this.logId,value:l},analyticsLabel:{b24statAction:l==="Y"?"addFavorites":"removeFavorites",b24statContext:"mobile"}}).then(function(e){if(e.data.success){if(l==="Y"){oMSL.setFollow({logId:i.logId,bOnlyOn:true,bRunEvent:true,bAjax:false})}BXMobileApp.onCustomEvent("onLogEntryFavorites",{log_id:i.logId,page_id:t.Loc.getMessage("MSLPageId")},true)}else{n.setAttribute("data-favorites",r)}},function(){n.setAttribute("data-favorites",r)})}if(a instanceof Event){a.preventDefault();a.stopPropagation()}}},{key:"setPinned",value:function e(s){var i=this;if(this.logId<=0){return}var n=s.menuNode,a=s.context;if(t.Type.isDomNode(n)){var r=n.getAttribute("data-pinned")==="Y"?"Y":"N";var l=r==="Y"?"N":"Y";n.setAttribute("data-pinned",l);BXMobileApp.onCustomEvent("Livefeed::showLoader",{},true,true);o.Ajax.runAction("socialnetwork.api.livefeed.logentry."+(l==="Y"?"pin":"unpin"),{data:{params:{logId:this.logId}},analyticsLabel:{b24statAction:l==="Y"?"pinLivefeedEntry":"unpinLivefeedEntry",b24statContext:"mobile"}}).then(function(e){BXMobileApp.onCustomEvent("Livefeed::hideLoader",{},true,true);if(e.data.success){BXMobileApp.onCustomEvent("Livefeed.PinnedPanel::change",{logId:i.logId,value:l,postNode:n.closest(".lenta-item"),pinActionContext:a},true,true);BXMobileApp.onCustomEvent("Livefeed.PostDetail::pinChanged",{logId:i.logId,value:l},true,true)}else{n.setAttribute("data-pinned",r)}},function(){BXMobileApp.onCustomEvent("Livefeed::hideLoader",{},true,true);n.setAttribute("data-pinned",r)})}}},{key:"openDetail",value:function e(s){var i=s.pathToEmptyPage,n=s.pathToCalendarEvent,o=s.pathToTasksRouter,a=s.event,r=s.focusComments,l=s.showFull;if(!t.Type.isStringFilled(i)){return}if(this.taskId>0&&BXMobileAppContext.getApiVersion()>=31&&this.taskData){BXMobileApp.Events.postToComponent("taskbackground::task::action",[{id:this.taskId,title:"TASK",taskInfo:{title:this.taskData.title,creatorIcon:this.taskData.creatorIcon,responsibleIcon:this.taskData.responsibleIcon}},this.taskId,{taskId:this.taskId,getTaskInfo:true}])}else{var d=i;if(this.calendarEventId>0&&!r&&n.length>0){d=n.replace("#EVENT_ID#",this.calendarEventId)}else if(this.taskId>0&&this.taskData&&o.length>0){d=o.replace("__ROUTE_PAGE__","view").replace("#USER_ID#",t.Loc.getMessage("MOBILE_EXT_LIVEFEED_CURRENT_USER_ID"))+"&TASK_ID="+this.taskId}__MSLOpenLogEntryNew({path:d,log_id:this.logId,entry_type:this.entryType,use_follow:this.useFollow?"Y":"N",use_tasks:this.useTasks?"Y":"N",post_perm:this.perm,destinations:this.destinations,post_id:this.postId,post_url:this.url,entity_xml_id:this.entityXmlId,focus_comments:r,focus_form:false,show_full:this.showFull||l,read_only:this.readOnly?"Y":"N",post_content_type_id:this.contentTypeId,post_content_id:this.contentId},a)}}},{key:"initDetailPin",value:function e(){var t=document.getElementById("log-entry-menu-"+this.logId);if(!t){return}var s=t.closest(".post-wrap");if(!s){return}var i=t.getAttribute("data-pinned");if(i==="Y"){s.classList.add("lenta-item-pin-active")}else{s.classList.remove("lenta-item-pin-active")}}},{key:"expandText",value:function e(){oMSL.expandText(this.logId)}}]);return e}();var u=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(s){this.iconUrlFolderPath="/bitrix/templates/mobile_app/images/lenta/menu/";this.sectionCode="defaultSection";this.logId=parseInt(s.logId);this.postId=parseInt(s.postId);this.postPerms=t.Type.isStringFilled(s.postPerms)?s.postPerms:"R";this.pageId=s.pageId;this.contentTypeId=t.Type.isStringFilled(s.contentTypeId)?s.contentTypeId:null;this.contentId=t.Type.isInteger(s.contentId)?s.contentId:0;this.useShare=!!s.useShare&&this.postId>0;this.useFavorites=!!s.useFavorites&&this.logId>0;this.useFollow=!!s.useFollow&&this.logId>0;this.usePinned=!!s.usePinned&&this.logId>0;this.useTasks=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_USE_TASKS")==="Y";this.useRefreshComments=!!s.useRefreshComments;this.favoritesValue=!!s.favoritesValue;this.followValue=!!s.followValue;this.pinnedValue=!!s.pinnedValue;this.target=t.Type.isDomNode(s.target)?s.target:null;this.context=t.Type.isStringFilled(s.context)?s.context:"list"}},{key:"getMenuItems",value:function e(){var s=this;var i=[];if(this.usePinned){i.push({id:"pinned",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_PINNED_"+(!!this.pinnedValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+(!!this.pinnedValue?"unpin.png":"pin.png"),sectionCode:this.sectionCode,action:function e(){var t=new p({logId:s.logId});return t.setPinned({menuNode:s.target,context:s.context})}})}if(this.useShare){var n={a_users:[],b_groups:[]};if(n.a_users.length>0||n.b_groups.length>0){i.push({id:"sharePost",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_SHARE"),iconName:"add",iconUrl:this.iconUrlFolderPath+"n_plus.png",sectionCode:this.sectionCode,action:function e(){app.openTable({callback:function e(){oMSL.shareBlogPost()},url:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SITE_DIR")+"mobile/index.php?mobile_action="+(t.Loc.getMessage("MOBILE_EXT_LIVEFEED_CURRENT_EXTRANET_SITE")==="Y"?"get_group_list":"get_usergroup_list")+"&feature=blog",markmode:true,multiple:true,return_full_mode:true,user_all:true,showtitle:true,modal:true,selected:n,alphabet_index:true,okname:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SHARE_TABLE_BUTTON_OK"),cancelname:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SHARE_TABLE_BUTTON_CANCEL"),outsection:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_DEST_TO_ALL_DENIED")!=="Y"})},arrowFlag:false})}}if(this.postId>0&&this.postPerms==="W"){i.push({id:"edit",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_EDIT"),iconUrl:this.iconUrlFolderPath+"pencil.png",sectionCode:this.sectionCode,action:function e(){oMSL.editBlogPost({feed_id:window.LiveFeedID,post_id:s.postId,pinnedContext:!!s.pinnedValue})},arrowFlag:false,feature:"edit"});i.push({id:"delete",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_DELETE"),iconName:"delete",sectionCode:this.sectionCode,action:function e(){oMSL.deleteBlogPost({post_id:s.postId})},arrowFlag:false})}if(this.useFavorites){i.push({id:"favorites",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_FAVORITES_"+(!!this.favoritesValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+"favorite.png",sectionCode:this.sectionCode,action:function e(){var t=new p({logId:s.logId});return t.setFavorites({node:s.target})},arrowFlag:false,feature:"favorites"})}if(this.useFollow){i.push({id:"follow",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_FOLLOW_"+(!!this.followValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+"eye.png",sectionCode:this.sectionCode,action:function e(){oMSL.setFollow({logId:s.logId,menuNode:s.target,pageId:s.pageId,bOnlyOn:false,bAjax:true,bRunEvent:true})},arrowFlag:false})}if(this.useRefreshComments){i.push({id:"refreshPostComments",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_REFRESH_COMMENTS"),iconUrl:this.iconUrlFolderPath+"n_refresh.png",action:function e(){if(oMSL.bDetailEmptyPage){oMSL.getComments({ts:oMSL.iDetailTs,bPullDown:true,obFocus:{form:false}})}else{document.location.reload(true)}},arrowFlag:false})}if(t.Type.isStringFilled(this.contentTypeId)&&this.contentId>0){i.push({id:"getPostLink",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_GET_LINK"),iconUrl:this.iconUrlFolderPath+"link.png",sectionCode:this.sectionCode,action:function e(){oMSL.copyPostLink({contentTypeId:s.contentTypeId,contentId:s.contentId})},arrowFlag:false});if(this.useTasks&&this.logId>0){i.push({id:"createTask",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_CREATE_TASK"),iconUrl:this.iconUrlFolderPath+"n_check.png",sectionCode:this.sectionCode,action:function e(){oMSL.createTask({entityType:s.contentTypeId,entityId:s.contentId,logId:s.logId});return false},arrowFlag:false})}}return i}}]);return e}();var f=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"show",value:function e(s){var i=this;var n={type:s.type?s.type:"post",groupId:s.groupId?parseInt(s.groupId):0,postId:s.postId?parseInt(s.postId):0,pageId:t.Type.isStringFilled(s.pageId)?s.pageId:""};this.getDatabaseData(n).then(function(e){return i.getWorkgroupData(e)}).then(function(e){return i.getPostData(e)}).then(function(e){return i.processPostData(e)}).then(function(e){app.exec("openComponent",{name:"JSStackComponent",componentCode:"livefeed.postform",scriptPath:BX.message("MOBILE_EXT_LIVEFEED_COMPONENT_URL"),params:{SERVER_NAME:BX.message("MOBILE_EXT_LIVEFEED_SERVER_NAME"),DESTINATION_LIST:E.getOption("destinationList",{}),DESTINATION_TO_ALL_DENY:E.getOption("destinationToAllDeny",false),DESTINATION_TO_ALL_DEFAULT:E.getOption("destinationToAllDefault",true),MODULE_DISK_INSTALLED:BX.message("MOBILE_EXT_LIVEFEED_DISK_INSTALLED")=="Y"?"Y":"N",MODULE_WEBDAV_INSTALLED:BX.message("MOBILE_EXT_LIVEFEED_WEBDAV_INSTALLED")=="Y"?"Y":"N",MODULE_VOTE_INSTALLED:BX.message("MOBILE_EXT_LIVEFEED_VOTE_INSTALLED")=="Y"?"Y":"N",FILE_ATTACH_PATH:BX.message("MOBILE_EXT_LIVEFEED_FILE_ATTACH_PATH"),BACKGROUND_IMAGES_DATA:E.getOption("backgroundImagesData",{}),BACKGROUND_COMMON:E.getOption("backgroundCommon",{}),MEDALS_LIST:E.getOption("medalsList",{}),IMPORTANT_DATA:E.getOption("importantData",{}),USER_FOLDER_FOR_SAVED_FILES:BX.message("MOBILE_EXT_UTILS_USER_FOLDER_FOR_SAVED_FILES"),MAX_UPLOAD_CHUNK_SIZE:BX.message("MOBILE_EXT_UTILS_MAX_UPLOAD_CHUNK_SIZE"),POST_FILE_UF_CODE:BX.message("MOBILE_EXT_LIVEFEED_POST_FILE_UF_CODE"),POST_FORM_DATA:E.getOption("postFormData",{}),POST_DATA:e,DEVICE_WIDTH:BX.message("MOBILE_EXT_LIVEFEED_DEVICE_WIDTH"),DEVICE_HEIGHT:BX.message("MOBILE_EXT_LIVEFEED_DEVICE_HEIGHT"),DEVICE_RATIO:BX.message("MOBILE_EXT_LIVEFEED_DEVICE_RATIO")},rootWidget:{name:"layout",settings:{objectName:"postFormLayoutWidget",modal:true}}},false)})}},{key:"getDatabaseData",value:function e(s){var i=new Promise(function(e,i){var n=parseInt(s.postId);if(n>0){e(s);return}P.load({onLoad:function i(n){if(n.contentType!==s.type){e(s);return}s.groupId=0;if(!t.Type.isPlainObject(s.post)){s.post={}}if(t.Type.isStringFilled(n.POST_TITLE)){s.post.PostTitle=n.POST_TITLE}if(t.Type.isStringFilled(n.POST_MESSAGE)){s.post.PostDetailText=n.POST_MESSAGE}if(t.Type.isArrayFilled(n.DEST)&&t.Type.isPlainObject(n.DEST_DATA)){s.post.PostDestination=[];var o=[{pattern:/^SG(\d+)$/i,style:"sonetgroups"},{pattern:/^U(\d+|A)$/i,style:"users"},{pattern:/^DR(\d+)$/i,style:"department"}];n.DEST.forEach(function(e){var i=null;var a=null;for(var r=0;r<o.length;r++){var l=e.match(o[r].pattern);if(l){i=l[1];a=e==="UA"?"all-users":o[r].style;break}}if(!t.Type.isNull(i)){s.post.PostDestination.push({STYLE:a,ID:i,TITLE:t.Type.isPlainObject(n.DEST_DATA[e])&&t.Type.isStringFilled(n.DEST_DATA[e].title)?n.DEST_DATA[e].title:""})}})}if(t.Type.isStringFilled(n.BACKGROUND_CODE)){s.post.PostBackgroundCode=n.BACKGROUND_CODE}if(n.IMPORTANT==="Y"){s.post.PostImportantData={value:"Y"};if(t.Type.isStringFilled(n.IMPORTANT_DATE_END)){s.post.PostImportantData.endDate=Date.parse(n.IMPORTANT_DATE_END)/1e3}}if(t.Type.isStringFilled(n.GRATITUDE_MEDAL)){s.post.PostGratitudeData={gratitude:n.GRATITUDE_MEDAL,employees:[]};if(Array.isArray(n.GRATITUDE_EMPLOYEES)&&t.Type.isPlainObject(n.GRATITUDE_EMPLOYEES_DATA)){n.GRATITUDE_EMPLOYEES.forEach(function(e){var i=n.GRATITUDE_EMPLOYEES_DATA[e];if(!t.Type.isPlainObject(i)){return}s.post.PostGratitudeData.employees.push({id:i.id,imageUrl:t.Type.isStringFilled(i.imageUrl)?i.imageUrl:"",title:t.Type.isStringFilled(i.title)?i.title:"",subtitle:t.Type.isStringFilled(i.subtitle)?i.subtitle:""})})}}var a="n0";var r="UF_BLOG_POST_VOTE_"+a+"_DATA";if(n.UF_BLOG_POST_VOTE===a&&t.Type.isPlainObject(n[r])&&Array.isArray(n[r].QUESTIONS)){s.post.PostVoteData={questions:n[r].QUESTIONS.map(function(e){var t={value:e.QUESTION,allowMultiSelect:e.FIELD_TYPE==1?"Y":"N",answers:[]};if(Array.isArray(e.ANSWERS)){t.answers=e.ANSWERS.map(function(e){return{value:e.MESSAGE}})}return t})}}e(s)},onEmpty:function t(){e(s)}},s.groupId)});i.catch(function(e){console.error(e)});return i}},{key:"getWorkgroupData",value:function e(t){var s=parseInt(t.groupId);var i=new Promise(function(e,i){if(s<=0){e(t);return}var n={resolve:e,reject:i};var o=new Date;var a="Livefeed::returnWorkgroupData_"+o.getTime();BXMobileApp.addCustomEvent(a,function(e){if(e.success){this.resolve(Object.assign(t,{group:{ID:parseInt(e.groupData.ID),NAME:e.groupData.NAME}}))}else{this.reject()}}.bind(n));BXMobileApp.onCustomEvent("Livefeed::getWorkgroupData",{groupId:s,returnEventName:a},true)});i.catch(function(e){console.error(e)});return i}},{key:"getPostData",value:function e(t){var s=parseInt(t.postId);var i=new Promise(function(e,i){if(s<=0){e(t);return}var n={resolve:e,reject:i};var o=new Date;var a="Livefeed::returnPostFullData_"+o.getTime();BXMobileApp.addCustomEvent(a,function(e){if(e.success){this.resolve(Object.assign(t,{post:e.postData}))}else{this.reject()}}.bind(n));BXMobileApp.onCustomEvent("Livefeed::getPostFullData",{postId:s,returnEventName:a},true)});i.catch(function(e){console.error(e)});return i}},{key:"processPostData",value:function e(s){var i=parseInt(s.postId);var n=new Promise(function(e,i){if(t.Type.isPlainObject(s.post)){if(t.Type.isArray(s.post.PostDestination)){s.recipients={};s.post.PostDestination.forEach(function(e){var i=null;var n=null;switch(e.STYLE){case"users":i="users";n=e.ID;break;case"all-users":i="users";n="A";break;case"sonetgroups":i="groups";n=e.ID;break;case"department":i="departments";n=e.ID;break;default:}if(i){if(!t.Type.isArray(s.recipients[i])){s.recipients[i]=[]}s.recipients[i].push({id:n,title:e.TITLE,avatar:t.Type.isStringFilled(e.AVATAR)?e.AVATAR:""})}})}if(t.Type.isArray(s.post.PostDestinationHidden)){s.hiddenRecipients=[];s.post.PostDestinationHidden.forEach(function(e){s.hiddenRecipients.push(e.TYPE+e.ID)})}}else if(t.Type.isPlainObject(s.group)){s.recipients={groups:[{id:s.group.ID,title:s.group.NAME}]}}e(s)});n.catch(function(e){console.error(e)});return n}}]);return e}();function h(){var e=babelHelpers.taggedTemplateLiteral(['<div class="','" data-livefeed-id="','">\n\t\t\t<div class="post-pinned-cancel-panel-content">\n\t\t\t\t<div class="post-pinned-cancel-panel-label">','</div>\n\t\t\t\t\t<div class="post-pinned-cancel-panel-text">','</div>\n\t\t\t\t</div>\n\t\t\t<div class="ui-btn ui-btn-light-border ui-btn-round ui-btn-sm ','">',"</div>\n\t\t</div>"]);h=function t(){return e};return e}var m=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);this.panelInitialized=false;this.class={panel:"lenta-pinned-panel",panelCollapsed:"lenta-pinned-panel-collapsed",panelActive:"lenta-pinned-panel-active",collapsedPanel:"lenta-pinned-collapsed-posts",collapsedPanelPostsValue:"lenta-pinned-collapsed-count-posts",collapsedPanelComments:"lenta-pinned-collapsed-posts-comments",collapsedPanelCommentsShown:"lenta-pinned-collapsed-posts-comments-active",collapsedPanelCommentsValue:"lenta-pinned-collapsed-count-comments",collapsedPanelCommentsValueNew:"post-item-inform-right-new-value",collapsedPanelExpandButton:"lenta-pinned-collapsed-posts-btn",post:"lenta-item",postItemPinned:"lenta-item-pinned",postItemPinActive:"lenta-item-pin-active",postItemPinnedBlock:"post-item-pinned-block",postItemPinnedTitle:"post-item-pinned-title",postItemPinnedTextBox:"post-item-pinned-text-box",postItemPinnedDesc:"post-item-pinned-desc",cancelPanel:"post-pinned-cancel-panel",cancelPanelButton:"post-pinned-cancel-panel-btn"};this.init();s.EventEmitter.subscribe("onFrameDataProcessed",function(){t.init()})}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;var s=document.querySelector(".".concat(this.class.panel));if(!s||this.panelInitialized){return}this.panelInitialized=true;this.adjustCollapsedPostsPanel();var i=document.querySelector(".".concat(this.class.collapsedPanel));if(i){i.addEventListener("touchend",function(e){t.expandCollapsedPostsPanel();e.stopPropagation();return e.preventDefault()})}}},{key:"resetFlags",value:function e(){this.panelInitialized=false}},{key:"getPinnedPanelNode",value:function e(){return document.querySelector("[data-livefeed-pinned-panel]")}},{key:"recalcPanel",value:function e(t){var s=t.type;if(this.getPostsCount()>0){this.getPinnedPanelNode().classList.add("".concat(this.class.panelActive))}else{this.getPinnedPanelNode().classList.remove("".concat(this.class.panelActive))}this.recalcCollapsedPostsPanel({type:s})}},{key:"recalcCollapsedPostsPanel",value:function e(s){var i=s.type;if(this.getPostsCount()>=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_COLLAPSED_PINNED_PANEL_ITEMS_LIMIT")){if(i==="insert"||this.getPinnedPanelNode().classList.contains("".concat(this.class.panelCollapsed))){this.getPinnedPanelNode().classList.add("".concat(this.class.panelCollapsed))}}else{this.getPinnedPanelNode().classList.remove("".concat(this.class.panelCollapsed))}this.adjustCollapsedPostsPanel()}},{key:"expandCollapsedPostsPanel",value:function e(){this.getPinnedPanelNode().classList.remove("".concat(this.class.panelCollapsed))}},{key:"getPostsCount",value:function e(){return Array.from(this.getPinnedPanelNode().getElementsByClassName("".concat(this.class.post))).length}},{key:"adjustCollapsedPostsPanel",value:function e(){var t=this.getPostsCount();var s=this.getPinnedPanelNode().querySelector(".".concat(this.class.collapsedPanelPostsValue));if(s){s.innerHTML=parseInt(t)}var i=this.getPinnedPanelNode().querySelector(".".concat(this.class.collapsedPanelComments));var n=this.getPinnedPanelNode().querySelector(".".concat(this.class.collapsedPanelCommentsValue));if(i&&n){var o=Array.from(this.getPinnedPanelNode().querySelectorAll(".".concat(this.class.collapsedPanelCommentsValueNew))).reduce(function(e,t){return e+parseInt(t.innerHTML)},0);n.innerHTML="+"+o;if(o>0){i.classList.add("".concat(this.class.collapsedPanelCommentsShown))}else{i.classList.remove("".concat(this.class.collapsedPanelCommentsShown))}}}},{key:"getPinnedData",value:function e(t){var s=t.logId?parseInt(t.logId):0;if(s<=0){return Promise.reject()}return new Promise(function(e,t){o.Ajax.runAction("socialnetwork.api.livefeed.logentry.getPinData",{data:{params:{logId:s}}}).then(function(s){if(s.status==="success"){e(s.data)}else{t(s.errors)}},function(e){t()})})}},{key:"insertEntry",value:function e(s){var i=this;var n=s.logId,o=s.postNode,a=s.pinnedContent;var r=this.getPinnedPanelNode();if(!t.Type.isDomNode(o)||!t.Type.isDomNode(r)){return}var l=o.querySelector(".".concat(this.class.postItemPinnedBlock));if(!t.Type.isDomNode(l)){return}o.classList.add(this.class.postItemPinned);o.classList.add(this.class.postItemPinActive);l.innerHTML="".concat(t.Type.isStringFilled(a.TITLE)?'<div class="'.concat(this.class.postItemPinnedTitle,'">').concat(a.TITLE,"</div>"):"",'<div class="').concat(this.class.postItemPinnedTextBox,'"><div class="').concat(this.class.postItemPinnedDesc,'">').concat(a.DESCRIPTION,"</div></div>");var d=t.Tag.render(h(),this.class.cancelPanel,n,t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_PINNED_CANCEL_TITLE"),t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_PINNED_CANCEL_DESCRIPTION"),this.class.cancelPanelButton,t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_PINNED_CANCEL_BUTTON"));var c=d.querySelector(".".concat(this.class.cancelPanelButton));c.addEventListener("touchend",function(e){var t=e.currentTarget.closest(".".concat(i.class.cancelPanel));if(!t){return}var s=parseInt(t.getAttribute("data-livefeed-id"));if(s<=0){return}var n=document.querySelector(".".concat(i.class.post,'[data-livefeed-id="').concat(s,'"]'));if(!n){return}var o=n.querySelector('[data-menu-type="post"]');if(!o){return}var a=new p({logId:s});return a.setPinned({menuNode:o,context:"list"})});o.parentNode.insertBefore(d,o);t.Dom.prepend(o,r);this.recalcPanel({type:"insert"});__MSLOnFeedScroll()}},{key:"extractEntry",value:function e(s){var i=s.logId,n=s.postNode,o=s.containerNode;var a=this.getPinnedPanelNode();if(!t.Type.isDomNode(n)||!t.Type.isDomNode(o)||!t.Type.isDomNode(a)||n.parentNode!==a||parseInt(i)<=0){return}n.classList.remove(this.class.postItemPinned);n.classList.remove(this.class.postItemPinActive);var r=document.querySelector(".".concat(this.class.cancelPanel,'[data-livefeed-id="').concat(parseInt(i),'"]'));if(r){r.parentNode.insertBefore(n,r);t.Dom.remove(r)}else{t.Dom.prepend(n,o)}this.recalcPanel({type:"extract"})}}]);return e}();var I=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.init();return e}babelHelpers.createClass(t,[{key:"init",value:function e(){this.setEventNamespace("BX.Mobile.Livefeed");this.subscribe("onFeedInit",this.onFeedInit.bind(this))}},{key:"onFeedInit",value:function e(){if(!window.BXRL){return}Object.keys(window.BXRL).forEach(function(e){if(e!=="manager"&&e!=="render"){delete window.BXRL[e]}})}}]);return t}(s.EventEmitter);function g(){var e=babelHelpers.taggedTemplateLiteral(['<div class="'," ",'" ontransitionend="','"></div>']);g=function t(){return e};return e}var v=function(){function e(){babelHelpers.classCallCheck(this,e);this.pageId=null;this.refreshNeeded=false;this.refreshStarted=false;this.options={};this.nodeId={feedContainer:"lenta_wrapper"};this.class={listWrapper:"lenta-list-wrap",postWrapper:"post-wrap",pinnedPanel:"lenta-pinned-panel",pin:"lenta-item-pin",postNewContainerTransformNew:"lenta-item-new-cont",postNewContainerTransform:"lenta-item-transform-cont",postLazyLoadCheck:"lenta-item-lazyload-check",listPost:"lenta-item",detailPost:"post-wrap",postItemTopWrap:"post-item-top-wrap",postItemTop:"post-item-top",postItemPostBlock:"post-item-post-block",postItemPostContentView:"post-item-contentview",postItemDescriptionBlock:"post-item-description",postItemAttachedFileWrap:"post-item-attached-disk-file-wrap",postItemInformWrap:"post-item-inform-wrap",postItemInformWrapTree:"post-item-inform-wrap-tree",postItemInformComments:"post-item-inform-comments",postItemInformMore:"post-item-more",postItemMore:"post-more-block",postItemPinnedBlock:"post-item-pinned-block",postItemPinActive:"lenta-item-pin-active",postItemGratitudeUsersSmallContainer:"lenta-block-grat-users-small-cont",postItemGratitudeUsersSmallHidden:"lenta-block-grat-users-small-hidden",postItemImportantUserList:"post-item-important-list",addPostButton:"feed-add-post-button"};this.newPostContainer=null;this.maxScroll=0;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));BXMobileApp.addCustomEvent("Livefeed::showLoader",this.showLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::hideLoader",this.hideLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::scrollTop",this.scrollTop.bind(this));BXMobileApp.addCustomEvent("Livefeed::onLogEntryDetailNotFound",this.removePost.bind(this));BXMobileApp.addCustomEvent("Livefeed.PinnedPanel::change",this.onPinnedPanelChange.bind(this));BXMobileApp.addCustomEvent("Livefeed.PostDetail::pinChanged",this.onPostPinChanged.bind(this));s.EventEmitter.subscribe("BX.LazyLoad:ImageLoaded",this.onLazyLoadImageLoaded.bind(this));s.EventEmitter.subscribe("MobilePlayer:onError",this.onMobilePlayerError);document.addEventListener("DOMContentLoaded",function(){document.addEventListener("click",t.handleClick.bind(t))})}},{key:"setPageId",value:function e(t){this.pageId=t}},{key:"getPageId",value:function e(){return this.pageId}},{key:"setOptions",value:function e(t){for(var s in t){if(!t.hasOwnProperty(s)){continue}this.options[s]=t[s]}}},{key:"getOption",value:function e(s,i){if(t.Type.isUndefined(i)){i=null}if(!t.Type.isStringFilled(s)){return null}return!t.Type.isUndefined(this.options[s])?this.options[s]:i}},{key:"setRefreshNeeded",value:function e(t){this.refreshNeeded=t}},{key:"getRefreshNeeded",value:function e(){return this.refreshNeeded}},{key:"setRefreshStarted",value:function e(t){this.refreshStarted=t}},{key:"getRefreshStarted",value:function e(){return this.refreshStarted}},{key:"setNewPostContainer",value:function e(t){this.newPostContainer=t}},{key:"getNewPostContainer",value:function e(){return this.newPostContainer}},{key:"setMaxScroll",value:function e(t){this.maxScroll=t}},{key:"getMaxScroll",value:function e(){return this.maxScroll}},{key:"afterPostAdd",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=typeof s.postId!="undefined"?parseInt(s.postId):0;var n=typeof s.context!="undefined"?s.context:"";var o=typeof s.pageId!="undefined"?s.pageId:"";var a=typeof s.groupId!="undefined"?s.groupId:null;if(o!==this.pageId){return}P.delete(a);if(i<=0){return}this.getEntryContent({entityType:"BLOG_POST",entityId:i,queueKey:s.key,action:"add"})}},{key:"afterPostUpdate",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=typeof s.context!="undefined"?s.context:"";var n=typeof s.pageId!="undefined"?s.pageId:"";var o=typeof s.postId!="undefined"?parseInt(s.postId):0;var a=typeof s.pinned!="undefined"&&!!s.pinned;this.getEntryContent({entityType:"BLOG_POST",entityId:o,queueKey:s.key,action:"update",pinned:a})}},{key:"afterPostAddError",value:function e(s){var i=this;if(!t.Type.isPlainObject(s)){s={}}var n=t.Type.isStringFilled(s.context)?s.context:"";var o=s.groupId?s.groupId:"";var a={a_users:[],b_groups:[]};oMSL.buildSelectedDestinations(s.postData,a);oMSL.setPostFormParams({selectedRecipients:a});oMSL.setPostFormParams({messageText:s.postData.POST_MESSAGE});P.save(s.postData,o);s.callback=function(){if(BXMobileAppContext.getApiVersion()>=i.getApiVersion("layoutPostForm")){b.show({pageId:i.getPageId(),postId:0})}else{app.exec("showPostForm",oMSL.showNewPostForm())}};this.showPostError(s)}},{key:"afterPostUpdateError",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}var i=t.Type.isStringFilled(s.context)?s.context:"";s.callback=function(){oMSL.editBlogPost({post_id:parseInt(s.postId)})};this.showPostError(s)}},{key:"showPostError",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}s.callback=t.Type.isFunction(s.callback)?s.callback:function(){};var i=t.Type.isStringFilled(s.errorText)?s.errorText:false;T.showError({text:i?i:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_ERROR"),onTap:function e(t){s.callback(t)}})}},{key:"showLoader",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}if(s.pageId&&this.pageId!==null&&s.pageId!=this.pageId){return}app.showPopupLoader({text:t.Type.isStringFilled(s.text)?s.text:""})}},{key:"hideLoader",value:function e(){app.hidePopupLoader()}},{key:"scrollTop",value:function e(s){if(!t.Type.isPlainObject(s)){s={}}if(s.pageId&&this.pageId!==null&&s.pageId!=this.pageId){return}window.scrollTo(0,0)}},{key:"getEntryContent",value:function e(s){var i=this;if(!t.Type.isPlainObject(s)){s={}}var n=s.logId?parseInt(s.logId):0;if(n<=0&&!(t.Type.isStringFilled(s.entityType)&&parseInt(s.entityId)>0)){return}o.Ajax.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryContent",{mode:"class",signedParameters:this.getOption("signedParameters",{}),data:{params:{logId:parseInt(s.logId)>0?parseInt(s.logId):0,pinned:!!s.pinned?"Y":"N",entityType:t.Type.isStringFilled(s.entityType)?s.entityType:"",entityId:parseInt(s.entityId)>0?parseInt(s.entityId):0,siteTemplateId:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SITE_TEMPLATE_ID")}}}).then(function(e){if(n<=0){o.Ajax.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryLogId",{mode:"class",data:{params:{entityType:t.Type.isStringFilled(s.entityType)?s.entityType:"",entityId:parseInt(s.entityId)>0?parseInt(s.entityId):0}}}).then(function(t){if(t.data.logId){i.insertPost({logId:t.data.logId,content:e.data.html,postId:s.postId,queueKey:s.queueKey,action:s.action,serverTimestamp:parseInt(e.data.componentResult.serverTimestamp)})}})}else{i.insertPost({logId:n,content:e.data.html,postId:s.postId,queueKey:s.queueKey,action:s.action,serverTimestamp:parseInt(e.data.componentResult.serverTimestamp)})}})}},{key:"processDetailBlock",value:function e(s,i,n){if(!s||!i){return Promise.reject()}var o=i.querySelector(n);var a=s.querySelector(n);if(a&&o){return t.Runtime.html(a,o.innerHTML)}return Promise.reject()}},{key:"insertPost",value:function e(i){var o=this;var a=document.getElementById(this.nodeId.feedContainer);var r=i.content;var l=i.logId;var d=i.queueKey;var c=i.action;if(!t.Type.isDomNode(a)||!t.Type.isStringFilled(r)){return}if(c==="update"){var p=document.getElementById("lenta_item_"+l);if(!p){p=document.getElementById("lenta_item")}if(!p){return}var u=this.pageId.match(/^detail_(\d+)/i);if(u&&l!=u[1]){return}var f=p.appendChild(document.createElement("div"));f.style.display="none";t.Runtime.html(f,r);if(p.id==="lenta_item"){this.processDetailBlock(p,f,".".concat(this.class.postItemTop));this.processDetailBlock(p,f,".".concat(this.class.postItemPostBlock)).then(function(){var e=p.querySelector(".".concat(o.class.postItemPostBlock));var t=f.querySelector(".".concat(o.class.postItemPostBlock));if(e||t){var s=o.filterPostBlockClassList(e.classList);var i=o.filterPostBlockClassList(t.classList);s.forEach(function(t){e.classList.remove(t)});i.forEach(function(t){e.classList.add(t)})}BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(p,f,".".concat(this.class.postItemAttachedFileWrap)).then(function(){BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(p,f,".".concat(this.class.postItemInformWrap));this.processDetailBlock(p,f,".".concat(this.class.postItemInformWrapTree))}else{p=p.querySelector("div.".concat(this.class.postItemTopWrap));var h=f.querySelector("div.".concat(this.class.postItemTopWrap));t.Runtime.html(p,h.innerHTML).then(function(){oMSL.checkNodesHeight();BitrixMobile.LazyLoad.showImages()})}f.remove()}else if(c==="add"){this.setNewPostContainer(t.Tag.render(g(),this.class.postNewContainerTransformNew,this.class.postLazyLoadCheck,this.handleInsertPostTransitionEnd.bind(this)));t.Dom.prepend(this.getNewPostContainer(),a);n.Utils.htmlWithInlineJS(this.getNewPostContainer(),r).then(function(){var e=o.getNewPostContainer().querySelector("div.".concat(o.class.listPost));t.Dom.style(o.getNewPostContainer(),"height","".concat(e.scrollHeight+12,"px"));var s=typeof i.serverTimestamp!="undefined"&&parseInt(i.serverTimestamp)>0?parseInt(i.serverTimestamp):0;if(s>0){o.setOptions({frameCacheTs:s})}oMSL.registerBlocksToCheck();setTimeout(function(){oMSL.checkNodesHeight()},100);setTimeout(function(){o.updateFrameCache({timestamp:s})},750)})}L.emit("onPostInserted",new s.BaseEvent({data:{key:d}}))}},{key:"removePost",value:function e(t){var s=parseInt(t.logId);if(s<=0){return}var i=document.getElementById("lenta_item_"+s);if(!i){return}i.remove()}},{key:"filterPostBlockClassList",value:function e(t){var s=[];Array.from(t).forEach(function(e){if(e==="info-block-background"||e==="info-block-background-with-title"||e==="info-block-gratitude"||e==="info-block-important"||e==="ui-livefeed-background"||e.match(/info-block-gratitude-(.+)/i)||e.match(/ui-livefeed-background-(.+)/i)){s.push(e)}});return s}},{key:"handleInsertPostTransitionEnd",value:function e(s){if(s.propertyName==="height"){this.getNewPostContainer().classList.remove(this.class.postNewContainerTransformNew);this.getNewPostContainer().classList.remove(this.class.postNewContainerTransform);t.Dom.style(this.getNewPostContainer(),"height",null);this.recalcMaxScroll();BitrixMobile.LazyLoad.showImages()}}},{key:"onLazyLoadImageLoaded",value:function e(s){var i=this;this.recalcMaxScroll();var n=s.getData(),o=babelHelpers.slicedToArray(n,1),a=o[0];if(a){var r=a.closest(".".concat(this.class.postLazyLoadCheck));if(r){var l=r.querySelector("div.".concat(this.class.listPost));if(l){r.classList.add(this.class.postNewContainerTransform);t.Dom.style(r,"height","".concat(l.scrollHeight,"px"));setTimeout(function(){r.classList.remove(i.class.postNewContainerTransform);t.Dom.style(r,"height",null)},500)}}}}},{key:"recalcMaxScroll",value:function e(){this.setMaxScroll(document.documentElement.scrollHeight-window.innerHeight-190)}},{key:"setPreventNextPage",value:function e(t){this.setOptions({preventNextPage:!!t});var s=document.getElementById("next_page_refresh_needed");var i=document.getElementById("next_post_more");if(s&&i){s.style.display=!!t?"block":"none";i.style.display=!!t?"none":"block"}}},{key:"onPinnedPanelChange",value:function e(s){var i=s.logId?parseInt(s.logId):0;var n=["Y","N"].indexOf(s.value)!==-1?s.value:null;var o=t.Type.isStringFilled(s.pinActionContext)?s.pinActionContext:"list";if(!i||!n||!k.getPinnedPanelNode()){return}var a=t.Type.isDomNode(s.postNode)?s.postNode:null;if(!t.Type.isDomNode(s.postNode)){a=document.getElementById("lenta_item_".concat(i))}if(!t.Type.isDomNode(a)){return}if(n==="N"){k.extractEntry({logId:i,postNode:a,containerNode:document.getElementById(this.nodeId.feedContainer)})}else if(n==="Y"){if(t.Type.isDomNode(s.postNode)){app.showPopupLoader({text:""});k.getPinnedData({logId:i}).then(function(e){app.hidePopupLoader();k.insertEntry({logId:i,postNode:s.postNode,pinnedContent:e})},function(e){app.hidePopupLoader()})}}}},{key:"onPostPinChanged",value:function e(t){var s=t.logId?parseInt(t.logId):0;var i=["Y","N"].indexOf(t.value)!==-1?t.value:null;if(!s||!i){return}var n=document.getElementById("log-entry-menu-"+s);if(!n){return}var o=n.closest(".".concat(this.class.detailPost));if(!o){o=n.closest(".".concat(this.class.listPost))}if(!o){return}if(i==="Y"){o.classList.add(this.class.postItemPinActive)}else{o.classList.remove(this.class.postItemPinActive)}}},{key:"handleClick",value:function e(s){if(s.target.classList.contains(this.class.pin)){var i=null;var n=null;var o="list";var a=s.target.closest(".".concat(this.class.listPost));if(a){n=a.querySelector('[data-menu-type="post"]');i=this.getPostFromNode(a)}else{o="detail";a=s.target.closest(".".concat(this.class.detailPost));if(a){n=a.querySelector('[data-menu-type="post"]');if(n){i=this.getPostFromLogId(n.getAttribute("data-log-id"))}}}if(i&&n){return i.setPinned({menuNode:n,context:o})}s.stopPropagation();return s.preventDefault()}else if(s.target.classList.contains(this.class.addPostButton)){if(BXMobileAppContext.getApiVersion()>=this.getApiVersion("layoutPostForm")){var r=new f;r.show({pageId:this.getPageId(),groupId:this.getOption("groupId",0)})}else{app.exec("showPostForm",oMSL.showNewPostForm())}}else if((s.target.closest(".".concat(this.class.listWrapper))||s.target.closest(".".concat(this.class.pinnedPanel)))&&!(s.target.tagName.toLowerCase()==="a"&&t.Type.isStringFilled(s.target.getAttribute("target"))&&s.target.getAttribute("target").toLowerCase()==="_blank")){var l=!!(s.target.classList.contains(this.class.postItemPinnedBlock)||s.target.closest(".".concat(this.class.postItemPinnedBlock)));var d=!!(!l&&(s.target.classList.contains(this.class.postItemPostContentView)||s.target.closest(".".concat(this.class.postItemPostContentView))||s.target.classList.contains(this.class.postItemDescriptionBlock)||s.target.closest(".".concat(this.class.postItemDescriptionBlock))));var c=!!(!l&&!d&&(s.target.classList.contains(this.class.postItemInformComments)||s.target.closest(".".concat(this.class.postItemInformComments))));var u=!!(!l&&!d&&!c&&(s.target.classList.contains(this.class.postItemInformMore)||s.target.closest(".".concat(this.class.postItemInformMore))));if(l||d||c||u){var h=s.target.closest(".".concat(this.class.listPost));if(h){var m=this.getPostFromNode(h);if(m){m.openDetail({pathToEmptyPage:this.getOption("pathToEmptyPage",""),pathToCalendarEvent:this.getOption("pathToCalendarEvent",""),pathToTasksRouter:this.getOption("pathToTasksRouter",""),event:s,focusComments:c,showFull:u})}}s.stopPropagation();return s.preventDefault()}}else if(s.target.closest(".".concat(this.class.postWrapper))){var I=!!(s.target.classList.contains(this.class.postItemInformMore)||s.target.closest(".".concat(this.class.postItemInformMore))||s.target.classList.contains(this.class.postItemMore)||s.target.closest(".".concat(this.class.postItemMore)));var g=null;if(s.target.classList.contains(this.class.postItemGratitudeUsersSmallContainer)){g=s.target}else{g=s.target.closest(".".concat(this.class.postItemGratitudeUsersSmallContainer))}if(I||t.Type.isDomNode(g)){if(t.Type.isDomNode(g)){g.style.display="none";var v=g.parentNode.querySelector(".".concat(this.class.postItemGratitudeUsersSmallHidden));if(v){v.style.display="block"}}var E=this.getOption("logId",0);var y=new p({logId:E});y.expandText();s.stopPropagation();return s.preventDefault()}var T=null;if(s.target.classList.contains(this.class.postItemImportantUserList)){T=s.target}else{T=s.target.closest(".".concat(this.class.postItemImportantUserList))}if(T){var P=T.parentNode.querySelector("input");var L=0;if(t.Type.isDomNode(P)){L=parseInt(P.getAttribute("bx-data-post-id"))}if(L>0){app.exec("openComponent",{name:"JSStackComponent",componentCode:"livefeed.important.list",scriptPath:"/mobileapp/jn/livefeed.important.list/?version=1.0.0",params:{POST_ID:L,SETTINGS:this.getOption("importantData",{})},rootWidget:{name:"list",settings:{objectName:"livefeedImportantListWidget",title:BX.message("MOBILE_EXT_LIVEFEED_USERS_LIST_TITLE"),modal:false,backdrop:{mediumPositionPercent:75}}}},false)}}}}},{key:"getPostFromNode",value:function e(s){if(!t.Type.isDomNode(s)){return}var i=parseInt(s.getAttribute("data-livefeed-id"));if(i<=0){return}return new p({logId:i,entryType:s.getAttribute("data-livefeed-post-entry-type"),useFollow:s.getAttribute("data-livefeed-post-use-follow")==="Y",useTasks:s.getAttribute("data-livefeed-post-use-tasks")==="Y",perm:s.getAttribute("data-livefeed-post-perm"),destinations:s.getAttribute("data-livefeed-post-destinations"),postId:parseInt(s.getAttribute("data-livefeed-post-id")),url:s.getAttribute("data-livefeed-post-url"),entityXmlId:s.getAttribute("data-livefeed-post-entity-xml-id"),readOnly:s.getAttribute("data-livefeed-post-read-only")==="Y",contentTypeId:s.getAttribute("data-livefeed-post-content-type-id"),contentId:s.getAttribute("data-livefeed-post-content-id"),showFull:s.getAttribute("data-livefeed-post-show-full")==="Y",taskId:parseInt(s.getAttribute("data-livefeed-task-id")),taskData:s.getAttribute("data-livefeed-task-data"),calendarEventId:parseInt(s.getAttribute("data-livefeed-calendar-event-id"))})}},{key:"getPostFromLogId",value:function e(t){var s=null;t=parseInt(t);if(t<=0){return s}s=new p({logId:t});return s}},{key:"updateFrameCache",value:function e(s){var i=document.getElementById("framecache-block-feed");if(!t.Type.isDomNode(i)){i=document.getElementById("bxdynamic_feed_refresh")}if(!t.Type.isDomNode(i)){return}var n={USE_BROWSER_STORAGE:true,AUTO_UPDATE:true,USE_ANIMATION:false};var o=typeof s.timestamp!="undefined"?parseInt(s.timestamp):0;if(o>0){n.TS=o}BX.frameCache.writeCacheWithID("framecache-block-feed",i.innerHTML,parseInt(Math.random()*1e5),JSON.stringify(n))}},{key:"onMobilePlayerError",value:function e(s){var i=s.getData(),n=babelHelpers.slicedToArray(i,2),o=n[0],a=n[1];if(!t.Type.isDomNode(o)){return}if(!t.Type.isStringFilled(a)){return}var r=o.parentNode;if(r){if(r.querySelector(".disk-mobile-player-error-container")){return}}else{if(o.querySelector(".disk-mobile-player-error-container")){return}}var l=o.getElementsByTagName("source");var d=l.length;Array.from(l).forEach(function(e){if(t.Type.isStringFilled(e.src)&&e.src===a){t.Dom.remove(e);d--}});if(d>0){return}var c=t.Dom.create("div",{props:{className:"disk-mobile-player-error-container"},children:[t.Dom.create("div",{props:{className:"disk-mobile-player-error-icon"},html:""}),t.Dom.create("div",{props:{className:"disk-mobile-player-error-message"},html:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PLAYER_ERROR_MESSAGE")})]});var p=c.querySelector(".disk-mobile-player-download");if(p){t.Dom.adjust(p,{events:{click:function e(){app.openDocument({url:a})}}})}if(r){o.style.display="none";r.appendChild(c)}else{t.Dom.adjust(o,{children:[c]})}}},{key:"getApiVersion",value:function e(t){var s=0;switch(t){case"layoutPostForm":s=37;break;default:}return s}}]);return e}();var E=new v;var y=new a;var T=new r;var P=new l;var L=new c;var _=new u;var b=new f;var k=new m;var N=new I;e.Instance=E;e.BalloonNotifierInstance=y;e.NotificationBarInstance=T;e.DatabaseUnsentPostInstance=P;e.PublicationQueueInstance=L;e.PostMenuInstance=_;e.PostFormManagerInstance=b;e.PinnedPanelInstance=k;e.RatingInstance=N})(this.BX.MobileLivefeed=this.BX.MobileLivefeed||{},BX,BX.Event,BX,BX,BX.Mobile);
//# sourceMappingURL=livefeed.bundle.map.js