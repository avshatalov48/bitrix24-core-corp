this.BX=this.BX||{};(function(e,t,i,o,s){"use strict";var n=function(){function e(){babelHelpers.classCallCheck(this,e);this.classes={show:"lenta-notifier-shown"};this.nodeIdList={notifier:"lenta_notifier",notifierCounter:"lenta_notifier_cnt",notifierCounterTitle:"lenta_notifier_cnt_title",refreshNeeded:"lenta_notifier_2"}}babelHelpers.createClass(e,[{key:"getNotifierNode",value:function e(){return document.getElementById(this.nodeIdList.notifier)}},{key:"getNotifierCounterNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounter)}},{key:"getNotifierCounterTitleNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounterTitle)}},{key:"getRefreshNeededNode",value:function e(){return document.getElementById(this.nodeIdList.refreshNeeded)}},{key:"showRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.add(this.classes.show)}}},{key:"hideRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.remove(this.classes.show)}}},{key:"showNotifier",value:function e(i){var o=parseInt(i.counterValue);var s=o%100,n=o%10;var a="";if(s>=10&&s<15){a=3}else if(n==0){a=3}else if(n==1){a=1}else if(n==2||n==3||n==4){a=2}else{a=3}if(p.getRefreshNeeded()){this.getNotifierCounterNode().innerHTML=o?o+"+":"";this.hideRefreshNeededNotifier()}else{this.getNotifierCounterNode().innerHTML=o||""}this.getNotifierCounterTitleNode().innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_COUNTER_TITLE_"+a);this.getNotifierNode().classList.add(this.classes.show)}},{key:"hideNotifier",value:function e(){var t=this.getNotifierNode();if(t){t.classList.remove(this.classes.show)}}}]);return e}();var a=function(){function e(){babelHelpers.classCallCheck(this,e);this.repo=[];this.color={background:{error:"#affb0000",info:"#3a3735"},text:{error:"#ffffff",info:"#ffffff"}}}babelHelpers.createClass(e,[{key:"hideAll",value:function e(){this.repo=this.repo.filter(function(e){return e});this.repo.forEach(function(e){e.hide()})}},{key:"showError",value:function e(t){var i=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.error,textColor:this.color.text.error,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",align:t.textAlign?t.textAlign:"center",autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:3e4,hideOnTap:t.hideOnTap?!!t.hideOnTap:true,onTap:t.onTap?t.onTap:function(){}},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(i);i.show()}},{key:"showInfo",value:function e(t){var i=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.info,textColor:this.color.text.info,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",maxLines:t.maxLines?t.maxLines:false,align:t.textAlign?t.textAlign:"center",isGlobal:t.isGlobal?!!t.isGlobal:true,useCloseButton:t.useCloseButton?!!t.useCloseButton:true,autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:1e3,hideOnTap:t.hideOnTap?!!t.hideOnTap:true},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(i);i.show()}}]);return e}();var r=function(){function e(i){babelHelpers.classCallCheck(this,e);this.tableName=null;this.keyName=null;this.setTableName(t.Type.isPlainObject(i)&&t.Type.isStringFilled(i.tableName)?i.tableName:"b_default");this.setKeyName(t.Type.isPlainObject(i)&&t.Type.isStringFilled(i.keyName)?i.keyName:"post_unsent")}babelHelpers.createClass(e,[{key:"setTableName",value:function e(t){this.tableName=t}},{key:"getTableName",value:function e(){return this.tableName}},{key:"setKeyName",value:function e(t){this.keyName=t}},{key:"getKeyName",value:function e(){return this.keyName}},{key:"check",value:function e(i){if(!t.Type.isObject(app.db)){return false}app.db.createTable({tableName:this.getTableName(),fields:[{name:"KEY",unique:true},"VALUE"],success:function e(t){i.success()},fail:function e(t){i.fail()}})}},{key:"delete",value:function e(i){var o=this;if(parseInt(i)<=0){i=false}if(!t.Type.isObject(app.db)){return false}this.check({success:function e(){app.db.deleteRows({tableName:o.getTableName(),filter:{KEY:o.getKeyName()+(i?"_"+i:"")},success:function e(t){},fail:function e(t){}})},fail:function e(){}})}},{key:"save",value:function e(i,o){var s=this;if(parseInt(o)<=0){o=false}for(var n in i){if(!i.hasOwnProperty(n)){continue}if(n==="sessid"){delete i[n];break}}if(!t.Type.isObject(app.db)){return false}this.check({success:function e(){app.db.getRows({tableName:s.getTableName(),filter:{KEY:s.getKeyName()+(o?"_"+o:"")},success:function e(t){var n=JSON.stringify(i);if(t.items.length>0){app.db.updateRows({tableName:s.getTableName(),updateFields:{VALUE:n},filter:{KEY:s.getKeyName()+(o?"_"+o:"")},success:function e(t){},fail:function e(t){}})}else{app.db.addRow({tableName:s.getTableName(),insertFields:{KEY:s.getKeyName()+(o?"_"+o:""),VALUE:n},success:function e(t){},fail:function e(t){}})}},fail:function e(t){}})},fail:function e(){}})}},{key:"load",value:function e(i,o){var s=this;if(parseInt(o)<=0){o=false}if(!t.Type.isObject(app.db)){i.onEmpty();return null}this.check({success:function e(){app.db.getRows({tableName:s.getTableName(),filter:{KEY:s.getKeyName()+(o?"_"+o:"")},success:function e(o){if(o.items.length>0&&o.items[0].VALUE.length>0){var s=JSON.parse(o.items[0].VALUE);if(t.Type.isPlainObject(s)){i.onLoad(s)}else{i.onEmpty()}}else{i.onEmpty()}},fail:function e(t){i.onEmpty()}})},fail:function e(){i.onEmpty()}})}}]);return e}();function l(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="post-balloon-hidden post-balloon post-balloon-active"><span class="post-balloon-icon"></span><span class="post-balloon-text">',"</span></div>\n\t\t\t"]);l=function t(){return e};return e}var d=function(e){babelHelpers.inherits(o,e);function o(){var e;babelHelpers.classCallCheck(this,o);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(o).call(this));e.repo={};e.nodeId={container:"post-balloon-container"};e.class={balloonHidden:"post-balloon-hidden",balloonFixed:"post-balloon-box-fixed",balloonPublished:"post-balloon-done",balloonShow:"post-balloon-show",balloonHide:"post-balloon-hide"};e.timeout={show:750};e.init();return e}babelHelpers.createClass(o,[{key:"init",value:function e(){BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterSetItem",this.afterSetItem.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));this.setEventNamespace("BX.Mobile.Livefeed");this.subscribe("onFeedReady",this.onFeedLoaded.bind(this));this.subscribe("onPostInserted",this.onPostInserted.bind(this));i.Event.bind(document,"scroll",this.onScroll.bind(this))}},{key:"onScroll",value:function e(){var i=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(i)){return}if(window.pageYOffset>0){i.classList.add(this.class.balloonFixed)}else{i.classList.remove(this.class.balloonFixed)}}},{key:"onFeedLoaded",value:function e(){var i=this;app.exec("getStorageValue",{storageId:"livefeed",key:"publicationQueue",callback:function e(o){o=t.Type.isPlainObject(o)?o:JSON.parse(o);if(!t.Type.isPlainObject(o)){return}for(var s in o){if(!o.hasOwnProperty(s)){continue}i.addToTray(s,{})}i.drawList()}})}},{key:"onPostInserted",value:function e(t){this.removeFromTray(t.data.key)}},{key:"addToTray",value:function e(t,i){this.repo[t]=i;this.repo[t].node=this.drawItem();this.repo[t].node.classList.add(this.class.balloonShow)}},{key:"removeFromTray",value:function e(t,i){var o=this;this.hideItem(t);setTimeout(function(){if(o.repo[t]){delete o.repo[t]}},3e3)}},{key:"addSuccess",value:function e(i){var o=this;if(this.repo[i]&&this.repo[i].node){this.repo[i].node.classList.remove(this.class.balloonHidden);this.repo[i].node.classList.remove(this.class.balloonShow);this.repo[i].node.classList.add(this.class.balloonPublished);this.repo[i].node.lastElementChild.innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_SUCCESS_TITLE")}setTimeout(function(){o.removeFromTray(i)},5e3)}},{key:"drawItem",value:function e(){var i=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_ITEM_TITLE");return t.Tag.render(l(),i)}},{key:"hideItem",value:function e(t,i){if(this.repo[t]){this.repo[t].node.classList.add(this.class.balloonHide)}}},{key:"drawList",value:function e(){var i=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(i)){return}t.Dom.clean(i);for(var o in this.repo){if(!this.repo.hasOwnProperty(o)||!t.Type.isDomNode(this.repo[o].node)){continue}t.Dom.append(this.repo[o].node,i)}}},{key:"afterSetItem",value:function e(i){var o=this;var s=i.key?i.key:"",n=i.pageId?i.pageId:"",a=i.contentType?i.contentType:"";if(n!=p.getPageId()||!s||!t.Type.isStringFilled(a)){return}if(a=="post"){this.addToTray(s,{key:s});setTimeout(function(){o.drawList()},this.timeout.show)}}},{key:"afterPostAdd",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=i.key?i.key:"";this.addSuccess(o);this.drawList()}},{key:"afterPostUpdate",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=i.key?i.key:"";this.addSuccess(o);this.drawList()}},{key:"afterPostAddError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=i.key?i.key:"";this.removeFromTray(o,{key:o});this.drawList()}},{key:"afterPostUpdateError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=i.key?i.key:"";this.removeFromTray(o,{key:o});this.drawList()}}]);return o}(i.Event.EventEmitter);function c(){var e=babelHelpers.taggedTemplateLiteral(['<div class="'," ",'" ontransitionend="','"></div>']);c=function t(){return e};return e}var u=function(){function e(){babelHelpers.classCallCheck(this,e);this.pageId=null;this.refreshNeeded=false;this.refreshStarted=false;this.options={};this.nodeId={feedContainer:"lenta_wrapper"};this.class={postNewContainerTransformNew:"lenta-item-new-cont",postNewContainerTransform:"lenta-item-transform-cont",postLazyLoadCheck:"lenta-item-lazyload-check",post:"lenta-item",postItemTopWrap:"post-item-top-wrap",postItemTop:"post-item-top",postItemPostBlock:"post-item-post-block",postItemAttachedFileWrap:"post-item-attached-disk-file-wrap",postItemInformWrap:"post-item-inform-wrap",postItemInformWrapTree:"post-item-inform-wrap-tree"};this.newPostContainer=null;this.maxScroll=0;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));BXMobileApp.addCustomEvent("Livefeed::showLoader",this.showLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::hideLoader",this.hideLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::scrollTop",this.scrollTop.bind(this));i.Event.EventEmitter.subscribe("BX.LazyLoad:ImageLoaded",this.onLazyLoadImageLoaded.bind(this))}},{key:"setPageId",value:function e(t){this.pageId=t}},{key:"getPageId",value:function e(){return this.pageId}},{key:"setOptions",value:function e(t){for(var i in t){if(!t.hasOwnProperty(i)){continue}this.options[i]=t[i]}}},{key:"getOption",value:function e(i,o){if(t.Type.isUndefined(o)){o=null}if(!t.Type.isStringFilled(i)){return null}return!t.Type.isUndefined(this.options[i])?this.options[i]:o}},{key:"setRefreshNeeded",value:function e(t){this.refreshNeeded=t}},{key:"getRefreshNeeded",value:function e(){return this.refreshNeeded}},{key:"setRefreshStarted",value:function e(t){this.refreshStarted=t}},{key:"getRefreshStarted",value:function e(){return this.refreshStarted}},{key:"setNewPostContainer",value:function e(t){this.newPostContainer=t}},{key:"getNewPostContainer",value:function e(){return this.newPostContainer}},{key:"setMaxScroll",value:function e(t){this.maxScroll=t}},{key:"getMaxScroll",value:function e(){return this.maxScroll}},{key:"afterPostAdd",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=typeof i.postId!="undefined"?parseInt(i.postId):0,s=typeof i.context!="undefined"?i.context:"",n=typeof i.pageId!="undefined"?i.pageId:"",a=typeof i.groupId!="undefined"?i.groupId:null;if(n!==this.pageId){return}y.delete(a);if(o<=0){return}this.getEntryContent({entityType:"BLOG_POST",entityId:o,queueKey:i.key,action:"add"})}},{key:"afterPostUpdate",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=typeof i.context!="undefined"?i.context:"",s=typeof i.pageId!="undefined"?i.pageId:"",n=typeof i.postId!="undefined"?parseInt(i.postId):0;this.getEntryContent({entityType:"BLOG_POST",entityId:n,queueKey:i.key,action:"update"})}},{key:"afterPostAddError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=t.Type.isStringFilled(i.context)?i.context:"",s=i.groupId?i.groupId:"";var n={a_users:[],b_groups:[]};oMSL.buildSelectedDestinations(i.postData,n);oMSL.setPostFormParams({selectedRecipients:n});oMSL.setPostFormParams({messageText:i.postData.POST_MESSAGE});y.save(i.postData,s);i.callback=function(){app.exec("showPostForm",oMSL.showNewPostForm())};this.showPostError(i)}},{key:"afterPostUpdateError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var o=t.Type.isStringFilled(i.context)?i.context:"";i.callback=function(){oMSL.editBlogPost({post_id:parseInt(i.postId)})};this.showPostError(i)}},{key:"showPostError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}i.callback=t.Type.isFunction(i.callback)?i.callback:function(){};var o=t.Type.isStringFilled(i.errorText)?i.errorText:false;h.showError({text:o?o:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_ERROR"),onTap:function e(t){i.callback(t)}})}},{key:"showLoader",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}if(i.pageId&&this.pageId!==null&&i.pageId!=this.pageId){return}app.showPopupLoader({text:t.Type.isStringFilled(i.text)?i.text:""})}},{key:"hideLoader",value:function e(){app.hidePopupLoader()}},{key:"scrollTop",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}if(i.pageId&&this.pageId!==null&&i.pageId!=this.pageId){return}window.scrollTo(0,0)}},{key:"getEntryContent",value:function e(i){var o=this;if(!t.Type.isPlainObject(i)){i={}}var s=i.logId?parseInt(i.logId):0,n=new MobileAjaxWrapper;if(s<=0&&!(t.Type.isStringFilled(i.entityType)&&parseInt(i.entityId)>0)){return}n.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryContent",{mode:"class",signedParameters:this.getOption("signedParameters",{}),data:{params:{logId:parseInt(i.logId)>0?parseInt(i.logId):0,entityType:t.Type.isStringFilled(i.entityType)?i.entityType:"",entityId:parseInt(i.entityId)>0?parseInt(i.entityId):0,siteTemplateId:BX.message("MOBILE_EXT_LIVEFEED_SITE_TEMPLATE_ID")}}}).then(function(e){if(s<=0){n.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryLogId",{mode:"class",data:{params:{entityType:t.Type.isStringFilled(i.entityType)?i.entityType:"",entityId:parseInt(i.entityId)>0?parseInt(i.entityId):0}}}).then(function(t){if(t.data.logId){o.insertPost({logId:t.data.logId,content:e.data.html,postId:i.postId,queueKey:i.queueKey,action:i.action})}})}else{o.insertPost({logId:s,content:e.data.html,postId:i.postId,queueKey:i.queueKey,action:i.action})}})}},{key:"processDetailBlock",value:function e(i,o,s){if(!i||!o){return Promise.reject()}var n=o.querySelector(s),a=i.querySelector(s);if(a&&n){return t.Runtime.html(a,n.innerHTML)}return Promise.reject()}},{key:"insertPost",value:function e(o){var n=this;var a=document.getElementById(this.nodeId.feedContainer),r=o.content,l=o.logId,d=o.queueKey,u=o.action;if(!t.Type.isDomNode(a)||!t.Type.isStringFilled(r)){return}if(u==="update"){var p=document.getElementById("lenta_item_"+l);if(!p){p=document.getElementById("lenta_item")}if(!p){return}var f=this.pageId.match(/^detail_(\d+)/i);if(f&&l!=f[1]){return}var h=p.appendChild(document.createElement("div"));h.style.display="none";t.Runtime.html(h,r);if(p.id==="lenta_item"){this.processDetailBlock(p,h,".".concat(this.class.postItemTop));this.processDetailBlock(p,h,".".concat(this.class.postItemPostBlock)).then(function(){BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(p,h,".".concat(this.class.postItemAttachedFileWrap)).then(function(){BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(p,h,".".concat(this.class.postItemInformWrap));this.processDetailBlock(p,h,".".concat(this.class.postItemInformWrapTree))}else{p=p.querySelector("div.".concat(this.class.postItemTopWrap));var y=h.querySelector("div.".concat(this.class.postItemTopWrap));t.Runtime.html(p,y.innerHTML).then(function(){BitrixMobile.LazyLoad.showImages()})}h.remove()}else if(u==="add"){this.setNewPostContainer(t.Tag.render(c(),this.class.postNewContainerTransformNew,this.class.postLazyLoadCheck,this.handleInsertPostTransitionEnd.bind(this)));t.Dom.prepend(this.getNewPostContainer(),a);s.Utils.htmlWithInlineJS(this.getNewPostContainer(),r).then(function(){var e=n.getNewPostContainer().querySelector("div.".concat(n.class.post));t.Dom.style(n.getNewPostContainer(),"height","".concat(e.scrollHeight+15,"px"))})}m.emit("onPostInserted",new i.Event.BaseEvent({data:{key:d}}))}},{key:"handleInsertPostTransitionEnd",value:function e(i){if(i.propertyName==="height"){this.getNewPostContainer().classList.remove(this.class.postNewContainerTransformNew);this.getNewPostContainer().classList.remove(this.class.postNewContainerTransform);t.Dom.style(this.getNewPostContainer(),"height",null);this.recalcMaxScroll();BitrixMobile.LazyLoad.showImages()}}},{key:"onLazyLoadImageLoaded",value:function e(i){var o=this;this.recalcMaxScroll();var s=i.getData(),n=babelHelpers.slicedToArray(s,1),a=n[0];if(a){var r=a.closest("."+this.class.postLazyLoadCheck);if(r){var l=r.querySelector("div.".concat(this.class.post));if(l){r.classList.add(this.class.postNewContainerTransform);t.Dom.style(r,"height","".concat(l.scrollHeight,"px"));setTimeout(function(){r.classList.remove(o.class.postNewContainerTransform);t.Dom.style(r,"height",null)},500)}}}}},{key:"recalcMaxScroll",value:function e(){this.setMaxScroll(document.documentElement.scrollHeight-window.innerHeight-190)}}]);return e}();var p=new u,f=new n,h=new a,y=new r,m=new d;e.Instance=p;e.BalloonNotifierInstance=f;e.NotificationBarInstance=h;e.DatabaseUnsentPostInstance=y;e.PublicationQueueInstance=m})(this.BX.MobileLivefeed=this.BX.MobileLivefeed||{},BX,BX,BX,BX);
//# sourceMappingURL=livefeed.bundle.map.js