this.BX=this.BX||{};(function(e,t,i,s){"use strict";var o=function(){function e(){babelHelpers.classCallCheck(this,e);this.classes={show:"lenta-notifier-shown"};this.nodeIdList={notifier:"lenta_notifier",notifierCounter:"lenta_notifier_cnt",notifierCounterTitle:"lenta_notifier_cnt_title",refreshNeeded:"lenta_notifier_2"}}babelHelpers.createClass(e,[{key:"getNotifierNode",value:function e(){return document.getElementById(this.nodeIdList.notifier)}},{key:"getNotifierCounterNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounter)}},{key:"getNotifierCounterTitleNode",value:function e(){return document.getElementById(this.nodeIdList.notifierCounterTitle)}},{key:"getRefreshNeededNode",value:function e(){return document.getElementById(this.nodeIdList.refreshNeeded)}},{key:"showRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.add(this.classes.show)}}},{key:"hideRefreshNeededNotifier",value:function e(){var t=this.getRefreshNeededNode();if(t){t.classList.remove(this.classes.show)}}},{key:"showNotifier",value:function e(i){var s=parseInt(i.counterValue);var o=s%100,n=s%10;var a="";if(o>=10&&o<15){a=3}else if(n==0){a=3}else if(n==1){a=1}else if(n==2||n==3||n==4){a=2}else{a=3}if(f.getRefreshNeeded()){this.getNotifierCounterNode().innerHTML=s?s+"+":"";this.hideRefreshNeededNotifier()}else{this.getNotifierCounterNode().innerHTML=s||""}this.getNotifierCounterTitleNode().innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_COUNTER_TITLE_"+a);this.getNotifierNode().classList.add(this.classes.show)}},{key:"hideNotifier",value:function e(){var t=this.getNotifierNode();if(t){t.classList.remove(this.classes.show)}}}]);return e}();var n=function(){function e(){babelHelpers.classCallCheck(this,e);this.repo=[];this.color={background:{error:"#affb0000",info:"#3a3735"},text:{error:"#ffffff",info:"#ffffff"}}}babelHelpers.createClass(e,[{key:"hideAll",value:function e(){this.repo=this.repo.filter(function(e){return e});this.repo.forEach(function(e){e.hide()})}},{key:"showError",value:function e(t){var i=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.error,textColor:this.color.text.error,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",align:t.textAlign?t.textAlign:"center",autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:3e4,hideOnTap:t.hideOnTap?!!t.hideOnTap:true,onTap:t.onTap?t.onTap:function(){}},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(i);i.show()}},{key:"showInfo",value:function e(t){var i=new BXMobileApp.UI.NotificationBar({message:t.text?t.text:"",color:this.color.background.info,textColor:this.color.text.info,useLoader:t.useLoader?!!t.useLoader:false,groupId:t.groupId?t.groupId:"",maxLines:t.maxLines?t.maxLines:false,align:t.textAlign?t.textAlign:"center",isGlobal:t.isGlobal?!!t.isGlobal:true,useCloseButton:t.useCloseButton?!!t.useCloseButton:true,autoHideTimeout:t.autoHideTimeout?t.autoHideTimeout:1e3,hideOnTap:t.hideOnTap?!!t.hideOnTap:true},t.id?t.id:parseInt(Math.random()*1e5));this.repo.push(i);i.show()}}]);return e}();var a=function(){function e(i){babelHelpers.classCallCheck(this,e);this.tableName=null;this.keyName=null;this.setTableName(t.Type.isPlainObject(i)&&t.Type.isStringFilled(i.tableName)?i.tableName:"b_default");this.setKeyName(t.Type.isPlainObject(i)&&t.Type.isStringFilled(i.keyName)?i.keyName:"post_unsent")}babelHelpers.createClass(e,[{key:"setTableName",value:function e(t){this.tableName=t}},{key:"getTableName",value:function e(){return this.tableName}},{key:"setKeyName",value:function e(t){this.keyName=t}},{key:"getKeyName",value:function e(){return this.keyName}},{key:"check",value:function e(i){if(!t.Type.isObject(app.db)){return false}app.db.createTable({tableName:this.getTableName(),fields:[{name:"KEY",unique:true},"VALUE"],success:function e(t){i.success()},fail:function e(t){i.fail()}})}},{key:"delete",value:function e(i){var s=this;if(parseInt(i)<=0){i=false}if(!t.Type.isObject(app.db)){return false}this.check({success:function e(){app.db.deleteRows({tableName:s.getTableName(),filter:{KEY:s.getKeyName()+(i?"_"+i:"")},success:function e(t){},fail:function e(t){}})},fail:function e(){}})}},{key:"save",value:function e(i,s){var o=this;if(parseInt(s)<=0){s=false}for(var n in i){if(!i.hasOwnProperty(n)){continue}if(n==="sessid"){delete i[n];break}}if(!t.Type.isObject(app.db)){return false}this.check({success:function e(){app.db.getRows({tableName:o.getTableName(),filter:{KEY:o.getKeyName()+(s?"_"+s:"")},success:function e(t){var n=JSON.stringify(i);if(t.items.length>0){app.db.updateRows({tableName:o.getTableName(),updateFields:{VALUE:n},filter:{KEY:o.getKeyName()+(s?"_"+s:"")},success:function e(t){},fail:function e(t){}})}else{app.db.addRow({tableName:o.getTableName(),insertFields:{KEY:o.getKeyName()+(s?"_"+s:""),VALUE:n},success:function e(t){},fail:function e(t){}})}},fail:function e(t){}})},fail:function e(){}})}},{key:"load",value:function e(i,s){var o=this;if(parseInt(s)<=0){s=false}if(!t.Type.isObject(app.db)){i.onEmpty();return null}this.check({success:function e(){app.db.getRows({tableName:o.getTableName(),filter:{KEY:o.getKeyName()+(s?"_"+s:"")},success:function e(s){if(s.items.length>0&&s.items[0].VALUE.length>0){var o=JSON.parse(s.items[0].VALUE);if(t.Type.isPlainObject(o)){i.onLoad(o)}else{i.onEmpty()}}else{i.onEmpty()}},fail:function e(t){i.onEmpty()}})},fail:function e(){i.onEmpty()}})}}]);return e}();function r(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="post-balloon-hidden post-balloon post-balloon-active"><span class="post-balloon-icon"></span><span class="post-balloon-text">',"</span></div>\n\t\t\t"]);r=function t(){return e};return e}var l=function(e){babelHelpers.inherits(i,e);function i(){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));e.repo={};e.nodeId={container:"post-balloon-container"};e.class={balloonHidden:"post-balloon-hidden",balloonFixed:"post-balloon-box-fixed",balloonPublished:"post-balloon-done",balloonShow:"post-balloon-show",balloonHide:"post-balloon-hide"};e.timeout={show:750};e.init();return e}babelHelpers.createClass(i,[{key:"init",value:function e(){BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterSetItem",this.afterSetItem.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));this.setEventNamespace("BX.Mobile.Livefeed");this.subscribe("onFeedReady",this.onFeedLoaded.bind(this));this.subscribe("onPostInserted",this.onPostInserted.bind(this));t.Event.bind(document,"scroll",this.onScroll.bind(this))}},{key:"onScroll",value:function e(){var i=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(i)){return}if(window.pageYOffset>0){i.classList.add(this.class.balloonFixed)}else{i.classList.remove(this.class.balloonFixed)}}},{key:"onFeedLoaded",value:function e(){var i=this;app.exec("getStorageValue",{storageId:"livefeed",key:"publicationQueue",callback:function e(s){s=t.Type.isPlainObject(s)?s:t.Type.isStringFilled(s)?JSON.parse(s):{};if(!t.Type.isPlainObject(s)){return}for(var o in s){if(!s.hasOwnProperty(o)){continue}i.addToTray(o,{})}i.drawList()}})}},{key:"onPostInserted",value:function e(t){this.removeFromTray(t.data.key)}},{key:"addToTray",value:function e(t,i){this.repo[t]=i;this.repo[t].node=this.drawItem();this.repo[t].node.classList.add(this.class.balloonShow)}},{key:"removeFromTray",value:function e(t,i){var s=this;this.hideItem(t);setTimeout(function(){if(s.repo[t]){delete s.repo[t]}},3e3)}},{key:"addSuccess",value:function e(i){var s=this;if(this.repo[i]&&this.repo[i].node){this.repo[i].node.classList.remove(this.class.balloonHidden);this.repo[i].node.classList.remove(this.class.balloonShow);this.repo[i].node.classList.add(this.class.balloonPublished);this.repo[i].node.lastElementChild.innerHTML=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_SUCCESS_TITLE")}setTimeout(function(){s.removeFromTray(i)},5e3)}},{key:"drawItem",value:function e(){var i=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_QUEUE_ITEM_TITLE");return t.Tag.render(r(),i)}},{key:"hideItem",value:function e(t,i){if(this.repo[t]){this.repo[t].node.classList.add(this.class.balloonHide)}}},{key:"drawList",value:function e(){var i=document.getElementById(this.nodeId.container);if(!t.Type.isDomNode(i)){return}t.Dom.clean(i);for(var s in this.repo){if(!this.repo.hasOwnProperty(s)||!t.Type.isDomNode(this.repo[s].node)){continue}t.Dom.append(this.repo[s].node,i)}}},{key:"afterSetItem",value:function e(i){var s=this;var o=i.key?i.key:"",n=i.pageId?i.pageId:"",a=i.contentType?i.contentType:"";if(n!=f.getPageId()||!o||!t.Type.isStringFilled(a)){return}if(a=="post"){this.addToTray(o,{key:o});setTimeout(function(){s.drawList()},this.timeout.show)}}},{key:"afterPostAdd",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=i.key?i.key:"";this.addSuccess(s);this.drawList()}},{key:"afterPostUpdate",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=i.key?i.key:"";this.addSuccess(s);this.drawList()}},{key:"afterPostAddError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=i.key?i.key:"";this.removeFromTray(s,{key:s});this.drawList()}},{key:"afterPostUpdateError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=i.key?i.key:"";this.removeFromTray(s,{key:s});this.drawList()}}]);return i}(t.Event.EventEmitter);var d=function(){function e(t){babelHelpers.classCallCheck(this,e);this.logId=0;this.entryType="";this.useFollow=false;this.useTasks=false;this.perm="";this.destinations={};this.postId=0;this.url="";this.entityXmlId="";this.readOnly=false;this.contentTypeId="";this.contentId=0;this.showFull=false;this.taskId=0;this.taskData=null;this.calendarEventId=0;this.init(t)}babelHelpers.createClass(e,[{key:"init",value:function e(i){var s=i.logId,o=i.entryType,n=i.useFollow,a=i.useTasks,r=i.perm,l=i.destinations,d=i.postId,c=i.url,p=i.entityXmlId,u=i.readOnly,h=i.contentTypeId,f=i.contentId,m=i.showFull,g=i.taskId,I=i.taskData,v=i.calendarEventId;s=parseInt(s);if(s<=0){return}this.logId=s;this.postId=parseInt(d);this.contentId=parseInt(f);this.taskId=parseInt(g);this.calendarEventId=parseInt(v);this.useFollow=!!n;this.useTasks=!!a;this.readOnly=!!u;this.showFull=!!m;if(t.Type.isStringFilled(o)){this.entryType=o}if(t.Type.isStringFilled(r)){this.perm=r}if(t.Type.isStringFilled(c)){this.url=c}if(t.Type.isStringFilled(p)){this.entityXmlId=p}if(t.Type.isStringFilled(h)){this.contentTypeId=h}if(t.Type.isStringFilled(I)){try{this.taskData=JSON.parse(I)}catch(e){this.taskData=null}}if(t.Type.isPlainObject(l)){this.destinations=l}}},{key:"setFavorites",value:function e(i){var s=this;if(this.logId<=0){return}var o=i.node,n=i.event;if(!t.Type.isDomNode(o)){o=document.getElementById("log_entry_favorites_"+this.logId)}if(t.Type.isDomNode(o)){var a=o.getAttribute("data-favorites")==="Y"?"Y":"N";var r=a==="Y"?"N":"Y";if(o.classList.contains("lenta-item-fav")){if(a==="Y"){o.classList.remove("lenta-item-fav-active")}else{o.classList.add("lenta-item-fav-active")}}o.setAttribute("data-favorites",r);var l=new MobileAjaxWrapper;l.runAction("socialnetwork.api.livefeed.changeFavorites",{data:{logId:this.logId,value:r},analyticsLabel:{b24statAction:r==="Y"?"addFavorites":"removeFavorites",b24statContext:"mobile"}}).then(function(e){if(e.data.success){if(r==="Y"){oMSL.setFollow({logId:s.logId,bOnlyOn:true,bRunEvent:true,bAjax:false})}BXMobileApp.onCustomEvent("onLogEntryFavorites",{log_id:s.logId,page_id:t.Loc.getMessage("MSLPageId")},true)}else{o.setAttribute("data-favorites",a)}},function(){o.setAttribute("data-favorites",a)})}if(n instanceof Event){n.preventDefault();n.stopPropagation()}}},{key:"setPinned",value:function e(i){var s=this;if(this.logId<=0){return}var o=i.menuNode,n=i.context;if(t.Type.isDomNode(o)){var a=o.getAttribute("data-pinned")==="Y"?"Y":"N";var r=a==="Y"?"N":"Y";o.setAttribute("data-pinned",r);if(n==="detail"){BXMobileApp.onCustomEvent("Livefeed::showLoader",{},true,true)}var l=new MobileAjaxWrapper;l.runAction("socialnetwork.api.livefeed.logentry."+(r==="Y"?"pin":"unpin"),{data:{params:{logId:this.logId}},analyticsLabel:{b24statAction:r==="Y"?"pinLivefeedEntry":"unpinLivefeedEntry",b24statContext:"mobile"}}).then(function(e){BXMobileApp.onCustomEvent("Livefeed::hideLoader",{},true,true);if(e.data.success){BXMobileApp.onCustomEvent("Livefeed.PinnedPanel::change",{logId:s.logId,value:r,postNode:o.closest(".lenta-item"),pinActionContext:n},true,true);BXMobileApp.onCustomEvent("Livefeed.PostDetail::pinChanged",{logId:s.logId,value:r},true,true)}else{o.setAttribute("data-pinned",a)}},function(){BXMobileApp.onCustomEvent("Livefeed::hideLoader",{},true,true);o.setAttribute("data-pinned",a)})}}},{key:"openDetail",value:function e(i){var s=i.pathToEmptyPage,o=i.pathToCalendarEvent,n=i.pathToTasksRouter,a=i.event,r=i.focusComments,l=i.showFull;if(!t.Type.isStringFilled(s)){return}if(this.taskId>0&&BXMobileAppContext.getApiVersion()>=31&&this.taskData){BXMobileApp.Events.postToComponent("taskbackground::task::action",[{id:this.taskId,title:"TASK",taskInfo:{title:this.taskData.title,creatorIcon:this.taskData.creatorIcon,responsibleIcon:this.taskData.responsibleIcon}},this.taskId,{taskId:this.taskId,getTaskInfo:true}])}else{var d=s;if(this.calendarEventId>0&&!r&&o.length>0){d=o.replace("#EVENT_ID#",this.calendarEventId)}else if(this.taskId>0&&this.taskData&&n.length>0){d=n.replace("__ROUTE_PAGE__","view").replace("#USER_ID#",t.Loc.getMessage("MOBILE_EXT_LIVEFEED_CURRENT_USER_ID"))+"&TASK_ID="+this.taskId}__MSLOpenLogEntryNew({path:d,log_id:this.logId,entry_type:this.entryType,use_follow:this.useFollow?"Y":"N",use_tasks:this.useTasks?"Y":"N",post_perm:this.perm,destinations:this.destinations,post_id:this.postId,post_url:this.url,entity_xml_id:this.entityXmlId,focus_comments:r,focus_form:false,show_full:this.showFull||l,read_only:this.readOnly?"Y":"N",post_content_type_id:this.contentTypeId,post_content_id:this.contentId},a)}}},{key:"initDetailPin",value:function e(){var t=document.getElementById("log-entry-menu-"+this.logId);if(!t){return}var i=BX.findParent(t,{className:"post-wrap"});if(!i){return}var s=t.getAttribute("data-pinned");if(s==="Y"){i.classList.add("lenta-item-pin-active")}else{i.classList.remove("lenta-item-pin-active")}}},{key:"expandText",value:function e(){oMSL.expandText(this.logId)}}]);return e}();var c=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"init",value:function e(i){this.iconUrlFolderPath="/bitrix/templates/mobile_app/images/lenta/menu/";this.sectionCode="defaultSection";this.logId=parseInt(i.logId);this.postId=parseInt(i.postId);this.postPerms=t.Type.isStringFilled(i.postPerms)?i.postPerms:"R";this.pageId=i.pageId;this.contentTypeId=t.Type.isStringFilled(i.contentTypeId)?i.contentTypeId:null;this.contentId=t.Type.isInteger(i.contentId)?i.contentId:0;this.useShare=!!i.useShare&&this.postId>0;this.useFavorites=!!i.useFavorites&&this.logId>0;this.useFollow=!!i.useFollow&&this.logId>0;this.usePinned=!!i.usePinned&&this.logId>0;this.useTasks=t.Loc.getMessage("MOBILE_EXT_LIVEFEED_USE_TASKS")==="Y";this.useRefreshComments=!!i.useRefreshComments;this.favoritesValue=!!i.favoritesValue;this.followValue=!!i.followValue;this.pinnedValue=!!i.pinnedValue;this.target=t.Type.isDomNode(i.target)?i.target:null;this.context=t.Type.isStringFilled(i.context)?i.context:"list"}},{key:"getMenuItems",value:function e(){var i=this;var s=[];if(this.usePinned){s.push({id:"pinned",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_PINNED_"+(!!this.pinnedValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+(!!this.pinnedValue?"unpin.png":"pin.png"),sectionCode:this.sectionCode,action:function e(){var t=new d({logId:i.logId});return t.setPinned({menuNode:i.target,context:i.context})}})}if(this.useShare){var o={a_users:[],b_groups:[]};if(o.a_users.length>0||o.b_groups.length>0){s.push({id:"sharePost",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_SHARE"),iconName:"add",iconUrl:this.iconUrlFolderPath+"n_plus.png",sectionCode:this.sectionCode,action:function e(){app.openTable({callback:function e(){oMSL.shareBlogPost()},url:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SITE_DIR")+"mobile/index.php?mobile_action="+(t.Loc.getMessage("MOBILE_EXT_LIVEFEED_CURRENT_EXTRANET_SITE")==="Y"?"get_group_list":"get_usergroup_list")+"&feature=blog",markmode:true,multiple:true,return_full_mode:true,user_all:true,showtitle:true,modal:true,selected:o,alphabet_index:true,okname:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SHARE_TABLE_BUTTON_OK"),cancelname:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_SHARE_TABLE_BUTTON_CANCEL"),outsection:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_DEST_TO_ALL_DENIED")!=="Y"})},arrowFlag:false})}}if(this.postId>0&&this.postPerms==="W"){s.push({id:"edit",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_EDIT"),iconUrl:this.iconUrlFolderPath+"pencil.png",sectionCode:this.sectionCode,action:function e(){oMSL.editBlogPost({feed_id:window.LiveFeedID,post_id:i.postId,pinnedContext:!!i.pinnedValue})},arrowFlag:false,feature:"edit"});s.push({id:"delete",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_DELETE"),iconName:"delete",sectionCode:this.sectionCode,action:function e(){oMSL.deleteBlogPost({post_id:i.postId})},arrowFlag:false})}if(this.useFavorites){s.push({id:"favorites",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_FAVORITES_"+(!!this.favoritesValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+"favorite.png",sectionCode:this.sectionCode,action:function e(){var t=new d({logId:i.logId});return t.setFavorites({node:i.target})},arrowFlag:false,feature:"favorites"})}if(this.useFollow){s.push({id:"follow",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_FOLLOW_"+(!!this.followValue?"Y":"N")),iconUrl:this.iconUrlFolderPath+"eye.png",sectionCode:this.sectionCode,action:function e(){oMSL.setFollow({logId:i.logId,menuNode:i.target,pageId:i.pageId,bOnlyOn:false,bAjax:true,bRunEvent:true})},arrowFlag:false})}if(this.useRefreshComments){s.push({id:"refreshPostComments",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_REFRESH_COMMENTS"),iconUrl:this.iconUrlFolderPath+"n_refresh.png",action:function e(){if(oMSL.bDetailEmptyPage){oMSL.getComments({ts:oMSL.iDetailTs,bPullDown:true,obFocus:{form:false}})}else{document.location.reload(true)}},arrowFlag:false})}if(t.Type.isStringFilled(this.contentTypeId)&&this.contentId>0){s.push({id:"getPostLink",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_GET_LINK"),iconUrl:this.iconUrlFolderPath+"link.png",sectionCode:this.sectionCode,action:function e(){oMSL.copyPostLink({contentTypeId:i.contentTypeId,contentId:i.contentId})},arrowFlag:false});if(this.useTasks&&this.logId>0){s.push({id:"createTask",title:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_POST_MENU_CREATE_TASK"),iconUrl:this.iconUrlFolderPath+"n_check.png",sectionCode:this.sectionCode,action:function e(){oMSL.createTask({entityType:i.contentTypeId,entityId:i.contentId,logId:i.logId});return false},arrowFlag:false})}}return s}}]);return e}();var p=function(){function e(t){babelHelpers.classCallCheck(this,e);this.class={postItemPinned:"lenta-item-pinned",postItemPinActive:"lenta-item-pin-active",postItemPinnedBlock:"post-item-pinned-block",postItemPinnedTitle:"post-item-pinned-title",postItemPinnedTextBox:"post-item-pinned-text-box",postItemPinnedDesc:"post-item-pinned-desc"}}babelHelpers.createClass(e,[{key:"getPinnedData",value:function e(t){var i=t.logId?parseInt(t.logId):0;var s=new MobileAjaxWrapper;if(i<=0){return Promise.reject()}return new Promise(function(e,t){s.runAction("socialnetwork.api.livefeed.logentry.getPinData",{data:{params:{logId:i}}}).then(function(i){if(i.status==="success"){e(i.data)}else{t(i.errors)}},function(e){t()})})}},{key:"insertEntry",value:function e(i){var s=i.logId,o=i.postNode,n=i.pinnedPanelNode,a=i.pinnedContent;if(!t.Type.isDomNode(o)||!t.Type.isDomNode(n)){return}var r=o.querySelector(".".concat(this.class.postItemPinnedBlock));if(!t.Type.isDomNode(r)){return}o.classList.add(this.class.postItemPinned);o.classList.add(this.class.postItemPinActive);r.innerHTML="".concat(t.Type.isStringFilled(a.TITLE)?'<div class="'.concat(this.class.postItemPinnedTitle,'">').concat(a.TITLE,"</div>"):"",'<div class="').concat(this.class.postItemPinnedTextBox,'"><div class="').concat(this.class.postItemPinnedDesc,'">').concat(a.DESCRIPTION,"</div></div>");t.Dom.prepend(o,n)}},{key:"extractEntry",value:function e(i){var s=i.postNode,o=i.containerNode;if(!t.Type.isDomNode(s)||!t.Type.isDomNode(o)){return}s.classList.remove(this.class.postItemPinned);s.classList.remove(this.class.postItemPinActive);t.Dom.prepend(s,o)}}]);return e}();function u(){var e=babelHelpers.taggedTemplateLiteral(['<div class="'," ",'" ontransitionend="','"></div>']);u=function t(){return e};return e}var h=function(){function e(){babelHelpers.classCallCheck(this,e);this.pageId=null;this.refreshNeeded=false;this.refreshStarted=false;this.options={};this.nodeId={feedContainer:"lenta_wrapper"};this.class={listWrapper:"lenta-list-wrap",postWrapper:"post-wrap",pinnedPanel:"lenta-pinned-panel",pin:"lenta-item-pin",postNewContainerTransformNew:"lenta-item-new-cont",postNewContainerTransform:"lenta-item-transform-cont",postLazyLoadCheck:"lenta-item-lazyload-check",listPost:"lenta-item",detailPost:"post-wrap",postItemTopWrap:"post-item-top-wrap",postItemTop:"post-item-top",postItemPostBlock:"post-item-contentview",postItemDescriptionBlock:"post-item-description",postItemAttachedFileWrap:"post-item-attached-disk-file-wrap",postItemInformWrap:"post-item-inform-wrap",postItemInformWrapTree:"post-item-inform-wrap-tree",postItemInformComments:"post-item-inform-comments",postItemInformMore:"post-item-more",postItemMore:"post-more-block",postItemPinnedBlock:"post-item-pinned-block",postItemPinActive:"lenta-item-pin-active"};this.newPostContainer=null;this.maxScroll=0;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var i=this;BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAdd",this.afterPostAdd.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostAddError",this.afterPostAddError.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdate",this.afterPostUpdate.bind(this));BXMobileApp.addCustomEvent("Livefeed.PublicationQueue::afterPostUpdateError",this.afterPostUpdateError.bind(this));BXMobileApp.addCustomEvent("Livefeed::showLoader",this.showLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::hideLoader",this.hideLoader.bind(this));BXMobileApp.addCustomEvent("Livefeed::scrollTop",this.scrollTop.bind(this));BXMobileApp.addCustomEvent("Livefeed::onLogEntryDetailNotFound",this.removePost.bind(this));BXMobileApp.addCustomEvent("Livefeed.PinnedPanel::change",this.onPinnedPanelChange.bind(this));BXMobileApp.addCustomEvent("Livefeed.PostDetail::pinChanged",this.onPostPinChanged.bind(this));t.Event.EventEmitter.subscribe("BX.LazyLoad:ImageLoaded",this.onLazyLoadImageLoaded.bind(this));document.addEventListener("DOMContentLoaded",function(){document.addEventListener("click",i.handleClick.bind(i))})}},{key:"setPageId",value:function e(t){this.pageId=t}},{key:"getPageId",value:function e(){return this.pageId}},{key:"setOptions",value:function e(t){for(var i in t){if(!t.hasOwnProperty(i)){continue}this.options[i]=t[i]}}},{key:"getOption",value:function e(i,s){if(t.Type.isUndefined(s)){s=null}if(!t.Type.isStringFilled(i)){return null}return!t.Type.isUndefined(this.options[i])?this.options[i]:s}},{key:"setRefreshNeeded",value:function e(t){this.refreshNeeded=t}},{key:"getRefreshNeeded",value:function e(){return this.refreshNeeded}},{key:"setRefreshStarted",value:function e(t){this.refreshStarted=t}},{key:"getRefreshStarted",value:function e(){return this.refreshStarted}},{key:"setNewPostContainer",value:function e(t){this.newPostContainer=t}},{key:"getNewPostContainer",value:function e(){return this.newPostContainer}},{key:"setMaxScroll",value:function e(t){this.maxScroll=t}},{key:"getMaxScroll",value:function e(){return this.maxScroll}},{key:"afterPostAdd",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=typeof i.postId!="undefined"?parseInt(i.postId):0;var o=typeof i.context!="undefined"?i.context:"";var n=typeof i.pageId!="undefined"?i.pageId:"";var a=typeof i.groupId!="undefined"?i.groupId:null;if(n!==this.pageId){return}I.delete(a);if(s<=0){return}this.getEntryContent({entityType:"BLOG_POST",entityId:s,queueKey:i.key,action:"add"})}},{key:"afterPostUpdate",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=typeof i.context!="undefined"?i.context:"";var o=typeof i.pageId!="undefined"?i.pageId:"";var n=typeof i.postId!="undefined"?parseInt(i.postId):0;var a=typeof i.pinned!="undefined"&&!!i.pinned;this.getEntryContent({entityType:"BLOG_POST",entityId:n,queueKey:i.key,action:"update",pinned:a})}},{key:"afterPostAddError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=t.Type.isStringFilled(i.context)?i.context:"";var o=i.groupId?i.groupId:"";var n={a_users:[],b_groups:[]};oMSL.buildSelectedDestinations(i.postData,n);oMSL.setPostFormParams({selectedRecipients:n});oMSL.setPostFormParams({messageText:i.postData.POST_MESSAGE});I.save(i.postData,o);i.callback=function(){app.exec("showPostForm",oMSL.showNewPostForm())};this.showPostError(i)}},{key:"afterPostUpdateError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}var s=t.Type.isStringFilled(i.context)?i.context:"";i.callback=function(){oMSL.editBlogPost({post_id:parseInt(i.postId)})};this.showPostError(i)}},{key:"showPostError",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}i.callback=t.Type.isFunction(i.callback)?i.callback:function(){};var s=t.Type.isStringFilled(i.errorText)?i.errorText:false;g.showError({text:s?s:t.Loc.getMessage("MOBILE_EXT_LIVEFEED_PUBLICATION_ERROR"),onTap:function e(t){i.callback(t)}})}},{key:"showLoader",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}if(i.pageId&&this.pageId!==null&&i.pageId!=this.pageId){return}app.showPopupLoader({text:t.Type.isStringFilled(i.text)?i.text:""})}},{key:"hideLoader",value:function e(){app.hidePopupLoader()}},{key:"scrollTop",value:function e(i){if(!t.Type.isPlainObject(i)){i={}}if(i.pageId&&this.pageId!==null&&i.pageId!=this.pageId){return}window.scrollTo(0,0)}},{key:"getEntryContent",value:function e(i){var s=this;if(!t.Type.isPlainObject(i)){i={}}var o=i.logId?parseInt(i.logId):0;var n=new MobileAjaxWrapper;if(o<=0&&!(t.Type.isStringFilled(i.entityType)&&parseInt(i.entityId)>0)){return}n.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryContent",{mode:"class",signedParameters:this.getOption("signedParameters",{}),data:{params:{logId:parseInt(i.logId)>0?parseInt(i.logId):0,pinned:!!i.pinned?"Y":"N",entityType:t.Type.isStringFilled(i.entityType)?i.entityType:"",entityId:parseInt(i.entityId)>0?parseInt(i.entityId):0,siteTemplateId:BX.message("MOBILE_EXT_LIVEFEED_SITE_TEMPLATE_ID")}}}).then(function(e){if(o<=0){n.runComponentAction("bitrix:mobile.socialnetwork.log.ex","getEntryLogId",{mode:"class",data:{params:{entityType:t.Type.isStringFilled(i.entityType)?i.entityType:"",entityId:parseInt(i.entityId)>0?parseInt(i.entityId):0}}}).then(function(t){if(t.data.logId){s.insertPost({logId:t.data.logId,content:e.data.html,postId:i.postId,queueKey:i.queueKey,action:i.action})}})}else{s.insertPost({logId:o,content:e.data.html,postId:i.postId,queueKey:i.queueKey,action:i.action})}})}},{key:"processDetailBlock",value:function e(i,s,o){if(!i||!s){return Promise.reject()}var n=s.querySelector(o);var a=i.querySelector(o);if(a&&n){return t.Runtime.html(a,n.innerHTML)}return Promise.reject()}},{key:"insertPost",value:function e(i){var o=this;var n=document.getElementById(this.nodeId.feedContainer);var a=i.content;var r=i.logId;var l=i.queueKey;var d=i.action;if(!t.Type.isDomNode(n)||!t.Type.isStringFilled(a)){return}if(d==="update"){var c=document.getElementById("lenta_item_"+r);if(!c){c=document.getElementById("lenta_item")}if(!c){return}var p=this.pageId.match(/^detail_(\d+)/i);if(p&&r!=p[1]){return}var h=c.appendChild(document.createElement("div"));h.style.display="none";t.Runtime.html(h,a);if(c.id==="lenta_item"){this.processDetailBlock(c,h,".".concat(this.class.postItemTop));this.processDetailBlock(c,h,".".concat(this.class.postItemPostBlock)).then(function(){BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(c,h,".".concat(this.class.postItemAttachedFileWrap)).then(function(){BitrixMobile.LazyLoad.showImages()});this.processDetailBlock(c,h,".".concat(this.class.postItemInformWrap));this.processDetailBlock(c,h,".".concat(this.class.postItemInformWrapTree))}else{c=c.querySelector("div.".concat(this.class.postItemTopWrap));var f=h.querySelector("div.".concat(this.class.postItemTopWrap));t.Runtime.html(c,f.innerHTML).then(function(){BitrixMobile.LazyLoad.showImages()})}h.remove()}else if(d==="add"){this.setNewPostContainer(t.Tag.render(u(),this.class.postNewContainerTransformNew,this.class.postLazyLoadCheck,this.handleInsertPostTransitionEnd.bind(this)));t.Dom.prepend(this.getNewPostContainer(),n);s.Utils.htmlWithInlineJS(this.getNewPostContainer(),a).then(function(){var e=o.getNewPostContainer().querySelector("div.".concat(o.class.listPost));t.Dom.style(o.getNewPostContainer(),"height","".concat(e.scrollHeight+15,"px"))})}v.emit("onPostInserted",new t.Event.BaseEvent({data:{key:l}}))}},{key:"removePost",value:function e(t){var i=parseInt(t.logId);if(i<=0){return}var s=document.getElementById("lenta_item_"+i);if(!s){return}s.remove()}},{key:"handleInsertPostTransitionEnd",value:function e(i){if(i.propertyName==="height"){this.getNewPostContainer().classList.remove(this.class.postNewContainerTransformNew);this.getNewPostContainer().classList.remove(this.class.postNewContainerTransform);t.Dom.style(this.getNewPostContainer(),"height",null);this.recalcMaxScroll();BitrixMobile.LazyLoad.showImages()}}},{key:"onLazyLoadImageLoaded",value:function e(i){var s=this;this.recalcMaxScroll();var o=i.getData(),n=babelHelpers.slicedToArray(o,1),a=n[0];if(a){var r=a.closest(".".concat(this.class.postLazyLoadCheck));if(r){var l=r.querySelector("div.".concat(this.class.listPost));if(l){r.classList.add(this.class.postNewContainerTransform);t.Dom.style(r,"height","".concat(l.scrollHeight,"px"));setTimeout(function(){r.classList.remove(s.class.postNewContainerTransform);t.Dom.style(r,"height",null)},500)}}}}},{key:"recalcMaxScroll",value:function e(){this.setMaxScroll(document.documentElement.scrollHeight-window.innerHeight-190)}},{key:"setPreventNextPage",value:function e(t){this.setOptions({preventNextPage:!!t});var i=document.getElementById("next_page_refresh_needed");var s=document.getElementById("next_post_more");if(i&&s){i.style.display=!!t?"block":"none";s.style.display=!!t?"none":"block"}}},{key:"getPinnedPanelNode",value:function e(){return document.querySelector("[data-livefeed-pinned-panel]")}},{key:"onPinnedPanelChange",value:function e(i){var s=this;var o=i.logId?parseInt(i.logId):0;var n=["Y","N"].indexOf(i.value)!==-1?i.value:null;var a=t.Type.isStringFilled(i.pinActionContext)?i.pinActionContext:"list";if(!o||!n||!this.getPinnedPanelNode()){return}var r=new p({});var l=t.Type.isDomNode(i.postNode)?i.postNode:null;if(!t.Type.isDomNode(i.postNode)){l=document.getElementById("lenta_item_".concat(o))}if(!t.Type.isDomNode(l)){return}if(n==="N"){r.extractEntry({postNode:l,containerNode:document.getElementById(this.nodeId.feedContainer)})}else if(n==="Y"){if(a==="list"){app.showPopupLoader({text:""})}r.getPinnedData({logId:o}).then(function(e){app.hidePopupLoader();r.insertEntry({logId:o,postNode:l,pinnedPanelNode:s.getPinnedPanelNode(),pinnedContent:e})},function(e){app.hidePopupLoader()})}}},{key:"onPostPinChanged",value:function e(t){var i=t.logId?parseInt(t.logId):0;var s=["Y","N"].indexOf(t.value)!==-1?t.value:null;if(!i||!s){return}var o=document.getElementById("log-entry-menu-"+i);if(!o){return}var n=o.closest(".".concat(this.class.detailPost));if(!n){n=o.closest(".".concat(this.class.listPost))}if(!n){return}if(s==="Y"){n.classList.add(this.class.postItemPinActive)}else{n.classList.remove(this.class.postItemPinActive)}}},{key:"handleClick",value:function e(i){if(i.target.classList.contains(this.class.pin)){var s=null;var o=null;var n="list";var a=i.target.closest(".".concat(this.class.listPost));if(a){o=a.querySelector('[data-menu-type="post"]');s=this.getPostFromNode(a)}else{n="detail";a=i.target.closest(".".concat(this.class.detailPost));if(a){o=a.querySelector('[data-menu-type="post"]');if(o){s=this.getPostFromLogId(o.getAttribute("data-log-id"))}}}if(s&&o){return s.setPinned({menuNode:o,context:n})}i.stopPropagation();return i.preventDefault()}else if((i.target.closest(".".concat(this.class.listWrapper))||i.target.closest(".".concat(this.class.pinnedPanel)))&&!(i.target.tagName.toLowerCase()==="a"&&t.Type.isStringFilled(i.target.getAttribute("target"))&&i.target.getAttribute("target").toLowerCase()==="_blank")){var r=!!(i.target.classList.contains(this.class.postItemPinnedBlock)||i.target.closest(".".concat(this.class.postItemPinnedBlock)));var l=!!(!r&&(i.target.classList.contains(this.class.postItemPostBlock)||i.target.closest(".".concat(this.class.postItemPostBlock))||i.target.classList.contains(this.class.postItemDescriptionBlock)||i.target.closest(".".concat(this.class.postItemDescriptionBlock))));var c=!!(!r&&!l&&(i.target.classList.contains(this.class.postItemInformComments)||i.target.closest(".".concat(this.class.postItemInformComments))));var p=!!(!r&&!l&&!c&&(i.target.classList.contains(this.class.postItemInformMore)||i.target.closest(".".concat(this.class.postItemInformMore))));if(r||l||c||p){var u=i.target.closest(".".concat(this.class.listPost));if(u){var h=this.getPostFromNode(u);if(h){h.openDetail({pathToEmptyPage:this.getOption("pathToEmptyPage",""),pathToCalendarEvent:this.getOption("pathToCalendarEvent",""),pathToTasksRouter:this.getOption("pathToTasksRouter",""),event:i,focusComments:c,showFull:p})}}i.stopPropagation();return i.preventDefault()}}else if(i.target.closest(".".concat(this.class.postWrapper))){var f=!!(i.target.classList.contains(this.class.postItemInformMore)||i.target.closest(".".concat(this.class.postItemInformMore))||i.target.classList.contains(this.class.postItemMore)||i.target.closest(".".concat(this.class.postItemMore)));if(f){var m=this.getOption("logId",0);var g=new d({logId:m});g.expandText();i.stopPropagation();return i.preventDefault()}}}},{key:"getPostFromNode",value:function e(i){if(!t.Type.isDomNode(i)){return}var s=parseInt(i.getAttribute("data-livefeed-id"));if(s<=0){return}return new d({logId:s,entryType:i.getAttribute("data-livefeed-post-entry-type"),useFollow:i.getAttribute("data-livefeed-post-use-follow")==="Y",useTasks:i.getAttribute("data-livefeed-post-use-tasks")==="Y",perm:i.getAttribute("data-livefeed-post-perm"),destinations:i.getAttribute("data-livefeed-post-destinations"),postId:parseInt(i.getAttribute("data-livefeed-post-id")),url:i.getAttribute("data-livefeed-post-url"),entityXmlId:i.getAttribute("data-livefeed-post-entity-xml-id"),readOnly:i.getAttribute("data-livefeed-post-read-only")==="Y",contentTypeId:i.getAttribute("data-livefeed-post-content-type-id"),contentId:i.getAttribute("data-livefeed-post-content-id"),showFull:i.getAttribute("data-livefeed-post-show-full")==="Y",taskId:parseInt(i.getAttribute("data-livefeed-task-id")),taskData:i.getAttribute("data-livefeed-task-data"),calendarEventId:parseInt(i.getAttribute("data-livefeed-calendar-event-id"))})}},{key:"getPostFromLogId",value:function e(t){var i=null;t=parseInt(t);if(t<=0){return i}i=new d({logId:t});return i}}]);return e}();var f=new h;var m=new o;var g=new n;var I=new a;var v=new l;var y=new c;e.Instance=f;e.BalloonNotifierInstance=m;e.NotificationBarInstance=g;e.DatabaseUnsentPostInstance=I;e.PublicationQueueInstance=v;e.PostMenuInstance=y})(this.BX.MobileLivefeed=this.BX.MobileLivefeed||{},BX,BX,BX);
//# sourceMappingURL=livefeed.bundle.map.js