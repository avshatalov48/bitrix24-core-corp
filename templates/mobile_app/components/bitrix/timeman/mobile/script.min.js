(function(){if(BX["MTimeMan"])return;var t=BX.message("SITE_DIR")+"mobile/ajax.php?mobile_action=timeman",e={OPENED:6e4,CLOSED:3e4,EXPIRED:3e4,START:3e4},i=BX.message("SITE_ID"),s=function(t,e,i){e=e+"";i=i+"";return"<span>"+t+"</span>:<span>"+("00".substring(0,2-e.length)+e)+"</span>:<span>"+("00".substring(0,2-i.length)+i)+"</span>"},n=function(t){var e=BX.message("PAGE_TITLE");if(BX.type.isNotEmptyString(e)){if(BX.type.isArray(t)&&t.length>0){var i=new window.BXMobileApp.UI.Menu({items:t});window.BXMobileApp.UI.Page.TopBar.title.setCallback(BX.delegate(i.show,i))}window.BXMobileApp.UI.Page.TopBar.title.setText(e);window.BXMobileApp.UI.Page.TopBar.title.show()}},a=function(){var t=function(t,e,i){this.node=t;this.container=e;this.click=BX.delegate(this.click,this);this.callback=BX.delegate(this.callback,this);BX.bind(this.container,"click",this.click);BX.addCustomEvent(this.node,"onFormat",BX.proxy(function(){var t=parseInt(this.node.value);t=t>0?t:0;this.container.innerHTML=BX.date.format(BX.clone(this.format.visible),t+this.offset)},this));this.init(i)};t.prototype={type:"time",format:{inner:"H:mm",visible:null},node:null,click:function(t){BX.eventCancelBubble(t);this.show();return BX.PreventDefault(t)},show:function(){var t={type:this.type,start_date:this.getStrDate(parseInt(this.node.value)),format:this.format.inner,callback:this.callback};if(t["start_date"]=="")delete t["start_date"];BXMobileApp.UI.DatePicker.setParams(t);BXMobileApp.UI.DatePicker.show()},callback:function(t){this.node.value=this.makeTimestamp(t);BX.onCustomEvent(this.node,"onFormat",[]);BX.onCustomEvent(this.node,"onChange",[this.node])},makeTimestamp:function(t){var e=0;if(BX.type.isNotEmptyString(t)){var i=new RegExp("(\\d{1,2}):(\\d{1,2})"),s;if(i.test(t)&&(s=i.exec(t))&&s){e=parseInt(s[1])*3600+parseInt(s[2])*60}}return e},getStrDate:function(t){var e=new Date((parseInt(t)+this.offset)*1e3);return BX.util.str_pad_left(e.getHours().toString(),2,"0")+":"+e.getMinutes().toString()},init:function(t){var e=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),i=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),s;if(e.substr(0,i.length)==i)s=BX.util.trim(e.substr(i.length));else s=BX.date.convertBitrixFormat(e.indexOf("T")>=0?"H:MI:SS T":"HH:MI:SS");this.format.bitrix=s;t=t||{};this.format.visible=t["time"]||s.replace(":s","");this.date=new Date;this.offset=this.date.getTime()-this.date.getTime()%86400+this.date.getTimezoneOffset()*60;BX.onCustomEvent(this.node,"onFormat",[])}};return t}(),o=function(){var t=function(t,e,i){this.node=t;this.container=e;this.click=BX.delegate(this.click,this);this.callback=BX.delegate(this.callback,this);if(i)BX.bind(this.container,"click",this.click);BX.addCustomEvent(this.node,"onFormat",BX.proxy(function(){var t=BX.type.isNotEmptyString(this.node.value)?parseInt(this.node.value):0,e=parseInt(t/3600)+"",i=parseInt(t%3600/60)+"";this.container.innerHTML="<span>"+e+"</span>:<span>"+("00".substring(0,2-i.length)+i)+"</span>"},this));this.init()};t.prototype={type:"time",format:{inner:"H:mm",visible:null},node:null,click:function(t){BX.eventCancelBubble(t);this.show();return BX.PreventDefault(t)},show:function(){var t={type:this.type,start_date:this.getStrDate(parseInt(this.node.value)),format:this.format.inner,callback:this.callback};if(t["start_date"]=="")delete t["start_date"];BXMobileApp.UI.DatePicker.setParams(t);BXMobileApp.UI.DatePicker.show()},callback:function(t){this.node.value=this.makeTimestamp(t);BX.onCustomEvent(this.node,"onFormat",[]);BX.onCustomEvent(this.node,"onChange",[this.node])},makeTimestamp:function(t){var e=0;if(BX.type.isNotEmptyString(t)){var i=new RegExp("(\\d{1,2}):(\\d{1,2})"),s;if(i.test(t)&&(s=i.exec(t))&&s){e=parseInt(s[1])*3600+parseInt(s[2])*60}}return e},getStrDate:function(t){t=parseInt(t);var e=parseInt(t/3600),i=parseInt(t%3600/60),s="00";return e+":"+(s.substring(0,2-i.length)+i)},init:function(){BX.onCustomEvent(this.node,"onFormat",[])}};return t}(),r=null;BX.ready(function(){window.app.pullDown({enable:true,pulltext:BX.message("PULLDOWN_PULL"),downtext:BX.message("PULLDOWN_DOWN"),loadtext:BX.message("PULLDOWN_LOADING"),action:"RELOAD",callback:function(){window.app.reload()}});app.getCurrentLocation({onsuccess:function(t){r=t}});BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"TIMEMANWORKINGDAY_"+BX.message("USER_ID")})});BX.timer.registerFormat("worktime_timeman",s);var h=function(i,s,n,a){s["site_id"]=BX.message("SITE_ID");s["sessid"]=BX.bitrix_sessid();if(s.hasOwnProperty("collectGeoData")&&s.collectGeoData&&r){s["lat"]=r.coords.latitude;s["lon"]=r.coords.longitude}s=BX.ajax.prepareData(s);var o={method:"POST",dataType:"json",url:t+"&action="+i,data:s,onsuccess:function(t){window.app.hidePopupLoader();if(o&&o.xhr&&o.xhr.getResponseHeader("BX-Mobile-Action")==="timeman")n(t,i)},onfailure:function(t,e){window.app.hidePopupLoader();if(e&&e.type==="json_failure"){throw BX.util.strip_tags(e.data)}}};if(i==="update"){o.lsId="tm-update";o.lsTimeout=e.START/1e3-1;o.lsForce=!!a}else if(i==="report"){o.lsId="tm-report";o.lsTimeout=29;o.lsForce=!!a}window.app.showPopupLoader();return BX.ajax(o)},d=function(){var t=function(t,e,i){this.date=new Date;this.id=this.date.valueOf()+Math.round(Math.random()*1e6);this.node=t;this.DATA=[];this.ERROR=false;this.FREE_MODE=false;this.formats=i;BX.onCustomEvent("onMobileTimeManInit",[this.id]);BX.ready(BX.proxy(function(){this.init(e)},this));this.onUpdate=BX.delegate(this.onUpdate,this);BX.addCustomEvent("onMobileTimeManDayHasBeenChanged",this.onUpdate);this.onPull=BX.delegate(this.onPull,this);BX.addCustomEvent("onPull-timeman",this.onPull);this.onMobileTimeManDailyReportHasBeenChanged=BX.delegate(function(t){this.DATA.REPORT=t.REPORT;this.DATA.REPORT_TS=t.REPORT_TS},this);BXMobileApp.addCustomEvent("onMobileTimeManDailyReportHasBeenChanged",this.onMobileTimeManDailyReportHasBeenChanged);this.destroy=BX.delegate(this.destroy,this);BX.addCustomEvent("onMobileTimeManInit",this.destroy)};t.prototype={status:"ready",inited:false,buttons:{},nodes:{main:null},init:function(t){this.node=BX(this.node);if(!this.node)throw"Timeman: node is not DOM node.";if(!this.setData(t))throw"Timeman: initial data is not valid.";this.nodes.main=this.node;this.collectNodes();this.bind();this.check(true);this.inited=true;this.collectGeoData=false;if(BX.type.isPlainObject(t)){this.collectGeoData=t.hasOwnProperty("COLLECT_GEO_DATA")?t["COLLECT_GEO_DATA"]==="Y":false}},collectNodes:function(){},destroy:function(t){if(t==this.id)return;BX.removeCustomEvent("onPull-timeman",this.onPull);BX.removeCustomEvent("onMobileTimeManDayHasBeenChanged",this.onUpdate);BX.removeCustomEvent("onMobileTimeManDailyReportHasBeenChanged",this.onMobileTimeManDailyReportHasBeenChanged);BX.removeCustomEvent("onMobileTimeManInit",this.destroy);this.unbind();var e,i;for(e in this.buttons){if(this.buttons.hasOwnProperty(e)){if(this.buttons[e]){for(i=0;i<this.buttons[e]["nodes"].length;i++)delete this.buttons[e]["nodes"][i];delete this.buttons[e]["f"]}}}for(e in this.nodes){if(this.nodes.hasOwnProperty(e)){if(this.nodes){for(i=0;i<this.nodes[e].length;i++)delete this.nodes[e][i];this.nodes[e]=null}}}delete this.node},setData:function(t){if(BX.type.isPlainObject(t)){this.node=BX(this.node);this.DATA=t;return true}return false},bind:function(){var t,e;for(t in this.buttons){if(this.buttons.hasOwnProperty(t)){this.buttons[t]={nodes:BX.findChild(this.node,{attribute:{"data-bx-timeman":t+"-button"}},true,true),f:BX.delegate(this[t],this)};for(e=0;e<this.buttons[t]["nodes"].length;e++){BX.bind(this.buttons[t]["nodes"][e],"click",this.buttons[t]["f"])}}}},unbind:function(){var t,e;for(t in this.buttons){if(this.buttons.hasOwnProperty(t)){if(this.buttons[t]&&this.buttons[t]["nodes"]){for(e=0;e<this.buttons[t]["nodes"].length;e++){BX.unbind(this.buttons[t]["nodes"][e],"click",this.buttons[t]["f"])}}}}},check:function(t){var e="ready",i=this.DATA["INFO"]?this.DATA.INFO.TIME_LEAKS:0,s=0;if(this.DATA["LAST_PAUSE"]&&!this.DATA["LAST_PAUSE"]["DATE_FINISH"]){i+=this.date.valueOf()-new Date(this.DATA["LAST_PAUSE"]["DATE_START"]*1e3).valueOf()}if(this.DATA["STATE"]=="OPENED"){e="opened";s=this.date.valueOf()-new Date(this.DATA["INFO"]["DATE_START"]*1e3).valueOf()-new Date(this.DATA["INFO"]["TIME_LEAKS"]*1e3).valueOf()}else{if(this.DATA["INFO"]&&this.DATA["INFO"]["DATE_START"]&&this.DATA["INFO"]["DATE_FINISH"]){s=this.DATA["INFO"]["DATE_FINISH"]-this.DATA["INFO"]["DATE_START"]-this.DATA["INFO"]["TIME_LEAKS"]}if(this.DATA["STATE"]=="CLOSED"){if(this.DATA["CAN_OPEN"]=="REOPEN"||!this.DATA["CAN_OPEN"]){e="completed"}else{e="start";i=0;s=0}}else if(this.DATA["STATE"]=="PAUSED"){e="paused"}else if(this.DATA["STATE"]=="EXPIRED"){e="expired"}}this.checkActions(e,t);n(this.getMenu(e,t));window["app"].onCustomEvent("onMobileTimeManStatusHasBeenChanged",[e]);this.nodes.main.setAttribute("data-bx-timeman-status",e);this.nodes.main.setAttribute("data-bx-timeman-pause",i+"");this.nodes.main.setAttribute("data-bx-timeman-state",s+"")},checkActions:function(t){},getMenu:function(){return[]},checkQuery:function(t,e){if(t["error"]||t["error_id"]){window["app"].alert({title:BX.message("ERROR_TITLE"),text:t["error"]||t["error_id"]});return false}window["app"].onCustomEvent("onMobileTimeManDayHasBeenChanged",[this.id,e,t]);return this.checkData(t,e)},checkData:function(t,e){if(e=="close"&&t["REPORT_REQ"]=="Y"&&t["REPORT"]==""&&t["fromPull"]!=="Y"){return this.report()}this.DATA=t;this.check(true);return true},onUpdate:function(t,e,i){if(BX.type.isArray(t)){i=t[2];t=t[0]}if(this.id!=t){if(i&&!(i["error"]||i["error_id"])){this.checkData(i,e);return true}window.app.reload()}return false},onPull:function(t){var e=t["command"];t=t["params"];if(t["request_id"]+""!=this.id+""){t["fromPull"]="Y";this.checkData(t,e)}}};return t}(),u=function(){var t=function(e,i,s){t.superclass.constructor.apply(this,arguments)};BX.extend(t,d);t.prototype.buttons={start:null,resume:null,pause:null,stop:null,edit:null};t.prototype.nodes={main:null,workingTimeTimer:null,stateTimer:null,pauseTimer:null,stopTimestamp:null,stopReason:null};t.prototype.collectNodes=function(){this.nodes["main"]=BX(this.node);this.nodes["workingTimeTimer"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"working-time-timer"}},true,true);this.nodes["stateTimer"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"state-timer"}},true,true);this.nodes["pauseTimer"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"pause-timer"}},true,true);this.nodes["startTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"start-timestamp"}},true);new a(this.nodes["startTimestamp"],this.nodes["startTimestamp"].previousSibling,this.formats.time);this.nodes["startReason"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"start-reason"}},true);this.nodes["stopTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"stop-timestamp"}},true);new a(this.nodes["stopTimestamp"],this.nodes["stopTimestamp"].previousSibling,this.formats.time);this.nodes["stopReason"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"stop-reason"}},true)};t.prototype.checkActions=function(t,e){if(t=="opened")this.startStateTimers(e);else this.stopStateTimers(e);if(t=="paused")this.startPauseTimers(e);else this.stopPauseTimers(e);this.showStopForm("normal");this.showStartForm("normal")};t.prototype.getMenu=function(t){var e=[];if(this.DATA["ID"]>0)e.push({name:BX.message("TM_MENU_REPORT"),icon:"edit",action:BX.proxy(this.report,this)});if(t=="start"){if(this.nodes.main.getAttribute("data-bx-timeman-start-state")=="extended"){e.push({name:BX.message("TM_MENU_START"),icon:"play",action:BX.proxy(function(){this.showStartForm("normal");n(this.getMenu(t,false))},this)})}else{e.push({name:BX.message("TM_MENU_START1"),icon:"play",action:BX.proxy(function(){this.showStartForm("extended");n(this.getMenu(t,false))},this)})}}else if(t=="expired"){}else{e.push({name:BX.message("TM_MENU_EDIT"),icon:"edit",action:BX.proxy(this.edit,this)});if(t!="completed"){if(this.nodes.main.getAttribute("data-bx-timeman-stop-state")=="extended"){e.push({name:BX.message("TM_MENU_STOP"),icon:"finish",action:BX.proxy(function(){this.showStopForm("normal");n(this.getMenu(t,false))},this)})}else{e.push({name:BX.message("TM_MENU_STOP1"),icon:"finish",action:BX.proxy(function(){this.showStopForm("extended");n(this.getMenu(t,false))},this)})}}}return e};t.prototype.startStateTimers=function(){var t;if(this.nodes["stateTimer"]){for(t=0;t<this.nodes["stateTimer"].length;t++){if(BX(this.nodes["stateTimer"][t])){if(!this.nodes["stateTimer"][t]["timer"]){this.nodes["stateTimer"][t]["timer"]=BX.timer(this.nodes["stateTimer"][t],{from:new Date(this.DATA.INFO.DATE_START*1e3),dt:-this.DATA.INFO.TIME_LEAKS*1e3,display:"worktime_timeman"})}else{this.nodes["stateTimer"][t]["timer"].setFrom(new Date(this.DATA.INFO.DATE_START*1e3));this.nodes["stateTimer"][t]["timer"].dt=-this.DATA.INFO.TIME_LEAKS*1e3}}}}};t.prototype.stopStateTimers=function(t){var e;var i=0;if(this.DATA["STATE"]=="OPENED"){i=this.date.valueOf()-new Date(this.DATA["INFO"]["DATE_START"]*1e3).valueOf()-new Date(this.DATA["INFO"]["TIME_LEAKS"]*1e3).valueOf()}else if(this.DATA["STATE"]=="CLOSED"&&!(this.DATA["CAN_OPEN"]=="REOPEN"||!this.DATA["CAN_OPEN"])){i=0}else if(this.DATA["INFO"]&&this.DATA["INFO"]["DATE_START"]&&this.DATA["INFO"]["DATE_FINISH"]){i=this.DATA["INFO"]["DATE_FINISH"]-this.DATA["INFO"]["DATE_START"]-this.DATA["INFO"]["TIME_LEAKS"]}if(this.nodes["stateTimer"]){for(e=0;e<this.nodes["stateTimer"].length;e++){if(BX(this.nodes["stateTimer"][e])){if(this.nodes["stateTimer"][e]["timer"]){BX.timer.stop(this.nodes["stateTimer"][e]["timer"]);this.nodes["stateTimer"][e]["timer"]=null}if(t){this.nodes["stateTimer"][e].innerHTML=s(parseInt(i/3600),parseInt(i%3600/60),i%3600%60)}}}}};t.prototype.startPauseTimers=function(){var t;if(this.nodes["pauseTimer"]){for(t=0;t<this.nodes["pauseTimer"].length;t++){if(BX(this.nodes["pauseTimer"][t])){if(!this.nodes["pauseTimer"][t]["timer"]){this.nodes["pauseTimer"][t]["timer"]=BX.timer(this.nodes["pauseTimer"][t],{from:new Date(this.DATA.INFO.DATE_FINISH*1e3),accuracy:1,dt:this.DATA.INFO.TIME_LEAKS*1e3,display:"worktime_timeman"})}else{this.nodes["pauseTimer"][t]["timer"].setFrom(new Date(this.DATA.INFO.DATE_FINISH*1e3));this.nodes["pauseTimer"][t]["timer"].dt=this.DATA.INFO.TIME_LEAKS*1e3}}}}};t.prototype.stopPauseTimers=function(t){var e,i=this.DATA["INFO"]?this.DATA.INFO.TIME_LEAKS:0;if(this.DATA["LAST_PAUSE"]&&!this.DATA["LAST_PAUSE"]["DATE_FINISH"]){i+=this.date.valueOf()-new Date(this.DATA["LAST_PAUSE"]["DATE_START"]*1e3).valueOf()}if(this.DATA["STATE"]=="CLOSED"&&!(this.DATA["CAN_OPEN"]=="REOPEN"||!this.DATA["CAN_OPEN"])){i=0}if(this.nodes["pauseTimer"]){for(e=0;e<this.nodes["pauseTimer"].length;e++){if(BX(this.nodes["pauseTimer"][e])){if(this.nodes["pauseTimer"][e]["timer"]){BX.timer.stop(this.nodes["pauseTimer"][e]["timer"]);this.nodes["pauseTimer"][e]["timer"]=null}if(t){this.nodes["pauseTimer"][e].innerHTML=s(parseInt(i/3600),parseInt(i%3600/60),i%3600%60)}}}}};t.prototype.start=function(t){var e=0,i="";if(this.nodes.main.getAttribute("data-bx-timeman-start-state")=="extended"){e=this.nodes["startTimestamp"].value;if(BX.type.isNotEmptyString(this.nodes["startReason"].value)){i=this.nodes["startReason"].value}else{BX.focus(this.nodes["startReason"]);return BX.PreventDefault(t)}}h("open",{timestamp:e,report:i,request_id:this.id,collectGeoData:this.collectGeoData},BX.proxy(this.checkQuery,this));return BX.PreventDefault(t)};t.prototype.pause=function(t){h("pause",{request_id:this.id,collectGeoData:this.collectGeoData},BX.proxy(this.checkQuery,this));return BX.PreventDefault(t)};t.prototype.resume=function(t){h("reopen",{request_id:this.id,collectGeoData:this.collectGeoData},BX.proxy(this.checkQuery,this));return BX.PreventDefault(t)};t.prototype.stop=function(t){if(this.DATA["REPORT_REQ"]=="Y"&&this.DATA["REPORT"]=="")return this.report();var e=0,i="";if(this.nodes.main.getAttribute("data-bx-timeman-stop-state")=="extended"||this.nodes.main.getAttribute("data-bx-timeman-status")=="expired"){e=this.nodes["stopTimestamp"].value;if(BX.type.isNotEmptyString(this.nodes["stopReason"].value)){i=this.nodes["stopReason"].value}else{BX.focus(this.nodes["stopReason"]);return BX.PreventDefault(t)}}var s={timestamp:e,report:i,request_id:this.id,collectGeoData:this.collectGeoData};if(this.DATA["REPORT_REQ"]!="A"){s["REPORT"]=this.DATA["REPORT"];s["ready"]="Y"}h("close",s,BX.proxy(this.checkQuery,this));return BX.PreventDefault(t)};t.prototype.edit=function(){window.BXMobileApp.PageManager.loadPageModal({url:BX.message("SITE_DIR")+"mobile/timeman/index.php?edit=Y",bx24ModernStyle:true,cache:false})};t.prototype.report=function(){window.BXMobileApp.PageManager.loadPageModal({url:BX.message("SITE_DIR")+"mobile/timeman/index.php?report=Y",bx24ModernStyle:true,cache:false})};t.prototype.showStartForm=function(t){this.nodes.main.setAttribute("data-bx-timeman-start-state",t)};t.prototype.showStopForm=function(t){this.nodes.main.setAttribute("data-bx-timeman-stop-state",t)};return t}(),l=function(){var t=function(e,i,s){this.onChange=BX.delegate(this.onChange,this);t.superclass.constructor.apply(this,arguments)};BX.extend(t,d);t.prototype.buttons={save:null};t.prototype.nodes={main:null,startTimestamp:null,finishTimestamp:null,pauseTimestamp:null,durationTimestamp:null,editReason:null};t.prototype.init=function(){t.superclass.init.apply(this,arguments)};t.prototype.collectNodes=function(){this.nodes["startTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"start-timestamp"}},true);if(this.nodes["startTimestamp"]){new a(this.nodes["startTimestamp"],this.nodes["startTimestamp"].previousSibling,this.formats.time);BX.addCustomEvent(this.nodes["startTimestamp"],"onChange",this.onChange)}this.nodes["finishTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"finish-timestamp"}},true);if(this.nodes["finishTimestamp"]){new a(this.nodes["finishTimestamp"],this.nodes["finishTimestamp"].previousSibling,this.formats.time);BX.addCustomEvent(this.nodes["finishTimestamp"],"onChange",this.onChange)}this.nodes["pauseTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"pause-timestamp"}},true);if(this.nodes["pauseTimestamp"]){new o(this.nodes["pauseTimestamp"],this.nodes["pauseTimestamp"].previousSibling,true);BX.addCustomEvent(this.nodes["pauseTimestamp"],"onChange",this.onChange)}this.nodes["durationTimestamp"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"duration-timestamp"}},true);if(this.nodes["durationTimestamp"]){new o(this.nodes["durationTimestamp"],this.nodes["durationTimestamp"].previousSibling,false)}this.nodes["editReason"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"edit-reason"}},true)};t.prototype.bind=function(){t.superclass.bind.apply(this,arguments);this.onFocus=BX.delegate(this.onFocus,this);this.onBlur=BX.delegate(this.onBlur,this);BX.bind(this.nodes["editReason"],"focus",this.onFocus);BX.bind(this.nodes["editReason"],"blur",this.onBlur)};t.prototype.unbind=function(){t.superclass.unbind.apply(this,arguments);BX.unbindAll(this.nodes["editReason"])};t.prototype.onFocus=function(){this.onBlur();if(!BX.type.isFunction(this.checkF)){this.checkF=BX.delegate(function(){if(BX.type.isNotEmptyString(this.nodes["editReason"].value))BX.removeClass(this.nodes["editReason"],"error");else BX.addClass(this.nodes["editReason"],"error")},this)}this.checkF();this.onFocusInterval=setInterval(this.checkF,500)};t.prototype.onBlur=function(){if(this.onFocusInterval>0){clearInterval(this.onFocusInterval);this.onFocusInterval=0}};t.prototype.checkActions=function(t,e){var i=this.DATA["INFO"]?this.DATA.INFO.TIME_LEAKS*1e3:0;if(this.DATA["LAST_PAUSE"]&&!this.DATA["LAST_PAUSE"]["DATE_FINISH"]){i+=this.date.valueOf()-new Date(this.DATA["LAST_PAUSE"]["DATE_START"]*1e3).valueOf()}if(this.DATA["STATE"]=="CLOSED"&&(this.DATA["CAN_OPEN"]&&this.DATA["CAN_OPEN"]!=="REOPEN")){i=0}var s=this.date,n,a=this.DATA["INFO"]["TIME_FINISH"]||this.DATA["EXPIRED_DATE"]||(s.getHours()*60+s.getMinutes()+s.getTimezoneOffset())*60+s.getSeconds()+parseInt(BX.message("SERVER_TZ_OFFSET"))+parseInt(BX.message("USER_TZ_OFFSET")),o={startTimestamp:this.DATA["INFO"]["TIME_START"],finishTimestamp:a,pauseTimestamp:i/1e3,durationTimestamp:a-this.DATA["INFO"]["TIME_START"]-this.DATA["INFO"]["TIME_LEAKS"]};for(n in o){if(o.hasOwnProperty(n)){if(this.nodes[n]){o[n]=isNaN(o[n])?0:o[n];this.nodes[n].value=o[n]+"";if(!this.nodes[n]["originalValue"]||e===true)this.nodes[n].originalValue=this.nodes[n].value;BX.onCustomEvent(this.nodes[n],"onFormat",[])}}}};t.prototype.onChange=function(t){if(t==this.nodes["startTimestamp"]){this.DATA["INFO"]["TIME_START"]=parseInt(this.nodes["startTimestamp"].value)}else if(t==this.nodes["finishTimestamp"]){this.DATA["INFO"]["TIME_FINISH"]=parseInt(this.nodes["finishTimestamp"].value)}else if(t==this.nodes["pauseTimestamp"]){this.DATA.INFO.TIME_LEAKS=parseInt(this.nodes["pauseTimestamp"].value)}this.check(false)};t.prototype.checkQuery=function(){if(t.superclass.checkQuery.apply(this,arguments))window.app.closeModalDialog({})};t.prototype.save=function(){if(!this._callback)this._callback=BX.proxy(this.checkQuery,this);if(!BX(this.nodes["editReason"])||BX.type.isNotEmptyString(this.nodes["editReason"].value)){var t={},e=["startTimestamp","finishTimestamp","pauseTimestamp"],i,s,n={request_id:this.id,collectGeoData:this.collectGeoData};for(s=0;s<e.length;s++){if((i=e[s])&&this.nodes[i]&&this.nodes[i]["originalValue"]&&this.nodes[i].originalValue+""!=this.nodes[i].value+""){t[i]=this.nodes[i].value}}if(t["startTimestamp"])n["timeman_edit_from"]=t["startTimestamp"];if(t["finishTimestamp"])n["timeman_edit_to"]=t["finishTimestamp"];if(t["pauseTimestamp"])n["TIME_LEAKS"]=t["pauseTimestamp"];if(this.DATA["REPORT_REQ"]!="A"){n["REPORT"]=this.DATA["REPORT"];n["ready"]="Y"}n.report=this.nodes["editReason"]?this.nodes["editReason"].value:"";h("save",n,this._callback)}else{BX.focus(this.nodes["editReason"])}};return t}(),p=function(){var t=function(e,i,s){t.superclass.constructor.apply(this,arguments);this.onChange=BX.delegate(this.onChange,this);window.BXMobileApp.UI.Page.TopBar.updateButtons({cancel:{type:"back_text",callback:BX.delegate(this.cancel,this),name:BX.message("TM_MENU_CANCEL"),bar_type:"navbar",position:"left"},ok:{type:"back_text",callback:BX.delegate(this.apply,this),name:BX.message("TM_MENU_SAVE"),bar_type:"navbar",position:"right"}})};BX.extend(t,d);t.prototype.buttons={save:null};t.prototype.nodes={main:null,report:null};t.prototype.init=function(){t.superclass.init.apply(this,arguments);this.nodes["report"].value=this.DATA.REPORT;BX.focus(this.nodes["report"])};t.prototype.collectNodes=function(){this.nodes["report"]=BX.findChild(this.node,{attribute:{"data-bx-timeman":"report"}},true)};t.prototype.checkActions=function(t,e){};t.prototype.checkQuery=function(t){BXMobileApp.onCustomEvent("onMobileTimeManDailyReportHasBeenChanged",t);this.checkData(t)};t.prototype.checkData=function(t){this.DATA.REPORT_TS=t["REPORT_TS"];this.DATA.REPORT=t["REPORT"];this.nodes["report"].value=t["REPORT"]};t.prototype.save=function(){if(this.DATA.REPORT!=this.nodes["report"].value){if(!this._callback)this._callback=BX.proxy(this.checkQuery,this);var t={entry_id:this.DATA.ID,report:this.nodes["report"].value,report_ts:new Date(this.DATA.REPORT_TS*1e3).valueOf(),collectGeoData:this.collectGeoData};h("report",t,this._callback)}else{BX.focus(this.nodes["report"])}};t.prototype.cancel=function(){window.app.closeModalDialog({})};t.prototype.apply=function(){this.save();this.cancel()};return t}();BX.MTimeMan=function(t,e,i){new u(t,e,i)};BX.MTimeManEdit=function(t,e,i){new l(t,e,i)};BX.MTimeManReport=function(t,e){new p(t,e,{})}})();
//# sourceMappingURL=script.map.js