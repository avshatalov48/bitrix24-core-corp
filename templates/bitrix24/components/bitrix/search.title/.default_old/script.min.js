BX.namespace("BX.B24SearchTitle");BX.B24SearchTitle=function(e){var t=this;this.arParams={AJAX_PAGE:e.AJAX_PAGE,CONTAINER_ID:e.CONTAINER_ID,INPUT_ID:e.INPUT_ID,MIN_QUERY_LEN:parseInt(e.MIN_QUERY_LEN),FORMAT:typeof e.FORMAT!="undefined"&&e.FORMAT=="json"?"json":"html",CATEGORIES_ALL:typeof e.CATEGORIES_ALL!="undefined"?e.CATEGORIES_ALL:[],USER_URL:typeof e.USER_URL!="undefined"?e.USER_URL:"",GROUP_URL:typeof e.GROUP_URL!="undefined"?e.GROUP_URL:"",WAITER_TEXT:typeof e.WAITER_TEXT!="undefined"?e.WAITER_TEXT:"",CURRENT_TS:parseInt(e.CURRENT_TS),SEARCH_PAGE:typeof e.SEARCH_PAGE!="undefined"?e.SEARCH_PAGE:""};if(e.MIN_QUERY_LEN<=0)e.MIN_QUERY_LEN=1;this.cache=[];this.cache_key=null;this.startText="";this.currentRow=-1;this.RESULT=null;this.CONTAINER=null;this.INPUT=null;this.xhr=null;this.searchStarted=false;this.ITEMS={obClientDb:null,obClientDbData:{},obClientDbDataSearchIndex:{},bMenuInitialized:false,initialized:{sonetgroups:false,menuitems:false},oDbUserSearchResult:{}};this.searchByAjax=false;this.currentItemId=null;this.CreateResultWrap=function(){if(t.RESULT==null){this.RESULT=document.body.appendChild(document.createElement("DIV"));this.RESULT.className="title-search-result title-search-result-header"}};this.MakeResultFromClientDB=function(e,r){var s=null;var a,i,n,l,o=null;for(a=0;a<e.length;a++){searchString=e[a].toLowerCase();if(typeof t.ITEMS.oDbUserSearchResult[searchString]!="undefined"&&t.ITEMS.oDbUserSearchResult[searchString].length>0){for(i=0;i<t.ITEMS.oDbUserSearchResult[searchString].length;i++){l=t.ITEMS.oDbUserSearchResult[searchString][i];o=l.substr(0,1);for(n=0;n<t.arParams.CATEGORIES_ALL.length;n++){if(typeof t.arParams.CATEGORIES_ALL[n].CLIENTDB_PREFIX!="undefined"&&t.arParams.CATEGORIES_ALL[n].CLIENTDB_PREFIX==o){if(s==null){s={}}if(typeof s.CATEGORIES=="undefined"){s.CATEGORIES={}}if(typeof s.CATEGORIES[n]=="undefined"){s.CATEGORIES[n]={ITEMS:[],TITLE:t.arParams.CATEGORIES_ALL[n].TITLE}}if(o=="U"){s.CATEGORIES[n].ITEMS.push({ICON:typeof t.ITEMS.obClientDbData.users[l].avatar!="undefined"?t.ITEMS.obClientDbData.users[l].avatar:"",ITEM_ID:l,MODULE_ID:"",NAME:t.ITEMS.obClientDbData.users[l].name,PARAM1:"",URL:t.arParams.USER_URL.replace("#user_id#",t.ITEMS.obClientDbData.users[l].entityId),TYPE:"users"})}else if(o=="G"){if(typeof t.ITEMS.obClientDbData.sonetgroups[l].site!="undefined"&&t.ITEMS.obClientDbData.sonetgroups[l].site==BX.message("SITE_ID")){s.CATEGORIES[n].ITEMS.push({ICON:typeof t.ITEMS.obClientDbData.sonetgroups[l].avatar!="undefined"?t.ITEMS.obClientDbData.sonetgroups[l].avatar:"",ITEM_ID:l,MODULE_ID:"",NAME:t.ITEMS.obClientDbData.sonetgroups[l].name,PARAM1:"",URL:t.arParams.GROUP_URL.replace("#group_id#",t.ITEMS.obClientDbData.sonetgroups[l].entityId),TYPE:"sonetgroups",IS_MEMBER:typeof t.ITEMS.obClientDbData.sonetgroups[l].isMember!="undefined"&&t.ITEMS.obClientDbData.sonetgroups[l].isMember=="Y"?1:0})}}else if(o=="M"){s.CATEGORIES[n].ITEMS.push({ICON:"",ITEM_ID:l,MODULE_ID:"",NAME:t.ITEMS.obClientDbData.menuitems[l].name,PARAM1:"",URL:t.ITEMS.obClientDbData.menuitems[l].entityId})}break}}}}}if(s!==null){for(var u in s.CATEGORIES){if(s.CATEGORIES.hasOwnProperty(u)){s.CATEGORIES[u].ITEMS.sort(t.resultCmp)}}s.CATEGORIES["all"]={ITEMS:[{NAME:BX.message("BITRIX24_SEARCHTITLE_ALL"),URL:BX.util.add_url_param(t.arParams.SEARCH_PAGE,{q:r})}]}}return s};this.resultCmp=function(e,t){if(typeof e.TYPE!="undefined"&&typeof t.TYPE!="undefined"&&e.TYPE=="sonetgroups"&&t.TYPE=="sonetgroups"&&typeof e.IS_MEMBER!="undefined"&&typeof t.IS_MEMBER!="undefined"){if(e.IS_MEMBER==t.IS_MEMBER){if(e.NAME==t.NAME){return 0}return e.NAME<t.NAME?-1:1}return e.IS_MEMBER>t.IS_MEMBER?-1:1}else{if(e.NAME==t.NAME){return 0}return e.NAME<t.NAME?-1:1}};this.BuildResult=function(e,r){var s=null;var a=[];var i=currentItem=tdClassName=itemBlock=null;var n=0;var l=true;if(typeof e.CATEGORIES!="undefined"){for(var o in e.CATEGORIES){if(e.CATEGORIES.hasOwnProperty(o)){if(l){l=false}i=e.CATEGORIES[o];a.push(BX.create("tr",{children:[BX.create("th",{props:{className:"title-search-separator"}}),BX.create("td",{props:{className:"title-search-separator"}})]}));if(typeof i.ITEMS!="undefined"){n=0;for(var u in i.ITEMS){if(i.ITEMS.hasOwnProperty(u)){if(n>=7){break}n++;currentItem=i.ITEMS[u];if(o==="all"){tdClassName="title-search-all"}else if(typeof currentItem.ICON!="undefined"){tdClassName="title-search-item"}else{tdClassName="title-search-more"}if(typeof currentItem.TYPE!="undefined"&&currentItem.TYPE.length>0){itemBlock=BX.create("a",{attrs:{href:currentItem.URL},children:[BX.create("span",{attrs:{style:typeof currentItem.ICON!="undefined"&&currentItem.ICON.length>0?"background-image: url('"+currentItem.ICON+"')":""},props:{className:"title-search-item-img title-search-item-img-"+currentItem.TYPE}}),BX.create("span",{props:{className:"title-search-item-text"},html:currentItem.NAME})]})}else{itemBlock=BX.create("a",{attrs:{href:currentItem.URL},html:currentItem.NAME})}a.push(BX.create("tr",{attrs:{"bx-search-item-id":currentItem.ITEM_ID},children:[BX.create("th",{html:u==0?i.TITLE:""}),BX.create("td",{props:{className:tdClassName},children:[itemBlock]})]}))}}}}}if(!!r){a.push(BX.create("tr",{children:[BX.create("th",{}),BX.create("td",{props:{className:"title-search-waiter"},children:[BX.create("span",{props:{className:"title-search-waiter-img"}}),BX.create("span",{props:{className:"title-search-waiter-text"},html:t.arParams.WAITER_TEXT})]})]}))}if(!l){a.push(BX.create("tr",{children:[BX.create("th",{props:{className:"title-search-separator"}}),BX.create("td",{props:{className:"title-search-separator"}})]}))}s=BX.create("table",{props:{className:"title-search-result"},children:[BX.create("colgroup",{children:[BX.create("col",{attrs:{width:"150px"}}),BX.create("col",{attrs:{width:"*"}})]}),BX.create("tbody",{children:a})]})}return s};this.ShowResult=function(e,r){t.CreateResultWrap();var s=0;var a=0;var i=0;if(BX.browser.IsIE()){s=0;a=1;i=-1;if(/MSIE 7/i.test(navigator.userAgent)){s=-1;a=-1;i=-2}}var n=BX.pos(t.CONTAINER);n.width=n.right-n.left;t.RESULT.style.position="absolute";t.RESULT.style.top=n.bottom+s-1+"px";t.RESULT.style.left=n.left+a+"px";t.RESULT.style.width=n.width+i+"px";if(e!=null){if(typeof t.arParams.FORMAT!="undefined"&&t.arParams.FORMAT=="json"){e=t.BuildResult(e,!!r);BX.cleanNode(t.RESULT);t.RESULT.appendChild(e)}else{t.RESULT.innerHTML=e}}else{t.RESULT.innerHTML=""}t.RESULT.style.display=t.RESULT.innerHTML.length>0?"block":"none"};this.SyncResult=function(e){var r=null;for(i=0;i<t.arParams.CATEGORIES_ALL.length;i++){if(typeof t.arParams.CATEGORIES_ALL[i].CODE!="undefined"&&typeof e.CATEGORIES[i]!="undefined"){if(t.arParams.CATEGORIES_ALL[i].CODE=="custom_menuitems"){r={};for(j=0;j<e.CATEGORIES[i].ITEMS.length;j++){r[e.CATEGORIES[i].ITEMS[j].ITEM_ID]=t.ConvertAjaxToClientDB(e.CATEGORIES[i].ITEMS[j],"menuitems")}BX.onCustomEvent(t,"onFinderAjaxSuccess",[r,t.ITEMS,"menuitems"])}else if(t.arParams.CATEGORIES_ALL[i].CODE=="custom_sonetgroups"){r={};for(j=0;j<e.CATEGORIES[i].ITEMS.length;j++){r[e.CATEGORIES[i].ITEMS[j].ITEM_ID]=t.ConvertAjaxToClientDB(e.CATEGORIES[i].ITEMS[j],"sonetgroups")}BX.onCustomEvent(t,"onFinderAjaxSuccess",[r,t.ITEMS,"sonetgroups"])}else if(t.arParams.CATEGORIES_ALL[i].CODE=="custom_users"){r={};for(j=0;j<e.CATEGORIES[i].ITEMS.length;j++){r[e.CATEGORIES[i].ITEMS[j].ITEM_ID]=t.ConvertAjaxToClientDB(e.CATEGORIES[i].ITEMS[j],"users")}BX.onCustomEvent(t,"onFinderAjaxSuccess",[r,t.ITEMS,"users"])}}}};this.ConvertAjaxToClientDB=function(e,t){var r=null;if(t=="sonetgroups"){r={id:"G"+e.ID,entityId:e.ID,name:e.NAME,avatar:e.ICON,desc:"",isExtranet:e.IS_EXTRANET?"Y":"N",site:e.SITE,checksum:e.CHECKSUM,isMember:typeof e.IS_MEMBER!="undefined"&&e.IS_MEMBER?"Y":"N"}}else if(t=="menuitems"){r={id:"M"+e.URL,entityId:e.URL,name:e.NAME,checksum:e.CHECKSUM}}else if(t=="users"){r={id:"U"+e.ID,entityId:e.ID,name:e.NAME,login:e.LOGIN,active:e.ACTIVE,avatar:e.ICON,desc:e.DESCRIPTION,isExtranet:"N",isEmail:"N",checksum:e.CHECKSUM}}return r};this.onKeyPress=function(e){t.CreateResultWrap();var r=BX.findChild(t.RESULT,{tag:"table",class:"title-search-result"},true);if(!r)return false;var s=r.rows.length,a=0;switch(e){case 27:t.RESULT.style.display="none";t.currentRow=-1;t.UnSelectAll();return true;case 40:if(t.RESULT.style.display=="none")t.RESULT.style.display="block";var i=-1;for(a=0;a<s;a++){if(!BX.findChild(r.rows[a],{class:"title-search-separator"},true)&&!BX.findChild(r.rows[a],{class:"title-search-waiter"},true)){if(i==-1)i=a;if(t.currentRow<a){t.currentRow=a;break}else{t.UnSelectItem(r,a)}}}if(a==s&&t.currentRow!=a){t.currentRow=i}if(!t.searchByAjax){t.SaveCurrentItemId(r,t.currentRow)}t.SelectItem(r,t.currentRow);return true;case 38:if(t.RESULT.style.display=="none")t.RESULT.style.display="block";var n=-1;for(a=s-1;a>=0;a--){if(!BX.findChild(r.rows[a],{class:"title-search-separator"},true)&&!BX.findChild(r.rows[a],{class:"title-search-waiter"},true)){if(n==-1)n=a;if(t.currentRow>a){t.currentRow=a;break}else{t.UnSelectItem(r,a)}}}if(a<0&&t.currentRow!=a){t.currentRow=n}if(!t.searchByAjax){t.SaveCurrentItemId(r,t.currentRow)}t.SelectItem(r,t.currentRow);return true;case 13:if(t.RESULT.style.display=="block"){for(a=0;a<s;a++){if(t.currentRow==a){if(!BX.findChild(r.rows[a],{class:"title-search-separator"},true)){var l=BX.findChild(r.rows[a],{tag:"a"},true);if(l){window.location=l.href;return true}}}}}return false}return false};this.UnSelectAll=function(){var e=BX.findChild(t.RESULT,{tag:"table",class:"title-search-result"},true);if(e){var r=e.rows.length;for(var s=0;s<r;s++)e.rows[s].className=""}};this.SelectItem=function(e,t){e.rows[t].className="title-search-selected"};this.UnSelectItem=function(e,t){if(e.rows[t].className=="title-search-selected"){e.rows[t].className=""}};this.SaveCurrentItemId=function(e,t){this.currentItemId=e.rows[t].getAttribute("bx-search-item-id")};this.EnableMouseEvents=function(){var e=BX.findChild(t.RESULT,{tag:"table",class:"title-search-result"},true);if(e){var r=e.rows.length;if(r>0){t.currentRow=1;t.SelectItem(e,t.currentRow)}var s=null;for(var a=0;a<r;a++){if(!BX.findChild(e.rows[a],{class:"title-search-separator"},true)){e.rows[a].id="row_"+a;s=e.rows[a].getAttribute("bx-search-item-id");if(this.searchByAjax&&BX.type.isNotEmptyString(s)&&s==this.currentItemId){t.UnSelectAll();t.currentRow=e.rows[a].id.substr(4);t.SelectItem(e,t.currentRow)}e.rows[a].onmouseover=function(r){if(t.currentRow!=this.id.substr(4)){t.UnSelectAll();t.currentRow=this.id.substr(4);t.SelectItem(e,t.currentRow)}};e.rows[a].onmouseout=function(e){this.className="";t.currentRow=-1}}}}};this.onFocusLost=function(e){if(t.RESULT!=null){setTimeout(function(){t.RESULT.style.display="none"},250)}};this.onFocusGain=function(){t.CreateResultWrap();if(t.RESULT&&t.RESULT.innerHTML.length){t.ShowResult()}BX.bind(t.INPUT,"keyup",t.onKeyUp);BX.bind(t.INPUT,"paste",t.onPaste)};this.onKeyUp=function(e){if(!t.searchStarted){return false}var r=BX.util.trim(t.INPUT.value);if(r==t.oldValue||r==t.oldClientValue||r==t.startText){return}if(t.xhr){t.xhr.abort()}if(r.length>=1){t.cache_key=t.arParams.INPUT_ID+"|"+r;if(t.cache[t.cache_key]==null){var s=[r];t.oldClientValue=r;var a={searchString:r};BX.onCustomEvent("findEntityByName",[t.ITEMS,a,{},t.ITEMS.oDbUserSearchResult]);if(a.searchString!=r){s.push(a.searchString)}var i=t.MakeResultFromClientDB(s,r);t.searchByAjax=false;t.ShowResult(i,r.length>=t.arParams.MIN_QUERY_LEN);t.EnableMouseEvents();if(r.length>=t.arParams.MIN_QUERY_LEN){t.oldValue=r;t.SendAjax(r)}}else{t.ShowResult(t.cache[t.cache_key]);t.currentRow=-1;t.EnableMouseEvents()}}else{t.currentRow=-1;t.UnSelectAll()}};this.SendAjax=BX.debounce(function(e){t.xhr=BX.ajax({method:"POST",dataType:t.arParams.FORMAT,url:t.arParams.AJAX_PAGE,data:{ajax_call:"y",INPUT_ID:t.arParams.INPUT_ID,FORMAT:t.arParams.FORMAT,q:e},preparePost:true,onsuccess:function(e){if(typeof e!="undefined"){for(var r in e.CATEGORIES){if(e.CATEGORIES.hasOwnProperty(r)){e.CATEGORIES[r].ITEMS.sort(t.resultCmp)}}t.cache[t.cache_key]=e;t.searchByAjax=true;t.ShowResult(e);t.SyncResult(e);t.currentRow=-1;t.EnableMouseEvents()}}})},1e3);this.onPaste=function(e){};this.onWindowResize=function(){if(t.RESULT!=null){t.ShowResult()}};this.onKeyDown=function(e){e=e||window.event;t.searchStarted=!(e.keyCode==27||e.keyCode==40||e.keyCode==38||e.keyCode==13);if(t.RESULT&&t.RESULT.style.display=="block"){if(t.onKeyPress(e.keyCode))return BX.PreventDefault(e)}};this.Init=function(){this.CONTAINER=BX(this.arParams.CONTAINER_ID);this.INPUT=BX(this.arParams.INPUT_ID);this.startText=this.oldValue=this.INPUT.value;BX.bind(this.INPUT,"focus",BX.proxy(this.onFocusGain,this));BX.bind(window,"resize",BX.proxy(this.onWindowResize,this));BX.bind(this.INPUT,"blur",BX.proxy(this.onFocusLost));this.INPUT.onkeydown=this.onKeyDown;BX.Finder(false,"searchTitle",[],{},t);BX.onCustomEvent(t,"initFinderDb",[this.ITEMS,"searchTitle",null,["users","sonetgroups","menuitems"],t]);setTimeout(function(){t.CheckOldStorage(t.ITEMS.obClientDbData)},5e3);if(!this.ITEMS.bLoadAllInitialized){BX.addCustomEvent("loadAllFinderDb",BX.delegate(function(e){this.ItemsLoadAll(e)},this));this.ITEMS.bLoadAllInitialized=true}};this.CheckOldStorage=function(e){if(!t.ITEMS.obClientDb){return}var r=null;var s=60*60*24*30;var a=null;for(var i in e){if(e.hasOwnProperty(i)){if(i=="sonetgroups"||i=="menuitems"){a=false;for(var n in e[i]){if(e[i].hasOwnProperty(n)){r=e[i][n];if(typeof r.timestamp!="undefined"&&parseInt(r.timestamp)>0&&t.arParams.CURRENT_TS>parseInt(r.timestamp)+s){a=true}break}}if(a){BX.Finder.clearEntityDb(t.ITEMS.obClientDb,i)}}}}};this.ItemsLoadAll=function(e){if(typeof e.entity!="undefined"&&typeof this.ITEMS.initialized[e.entity]!="undefined"&&!this.ITEMS.initialized[e.entity]&&typeof e.callback=="function"){if(e.entity=="sonetgroups"||e.entity=="menuitems"){BX.ajax({url:this.arParams.AJAX_PAGE,method:"POST",dataType:"json",data:{ajax_call:"y",sessid:BX.bitrix_sessid(),FORMAT:"json",q:"empty",get_all:e.entity},onsuccess:BX.delegate(function(t){if(typeof t.ALLENTITIES!="undefined"){BX.onCustomEvent("onFinderAjaxLoadAll",[t.ALLENTITIES,this.ITEMS,e.entity])}e.callback()},this),onfailure:function(e){}})}this.ITEMS.initialized[e.entity]=true}};BX.ready(function(){t.Init(e)})};